<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Marnthara Input</title>
<style>
:root{
  --bg:#111215;--fg:#e7e7ea;--line:#2f2f33;--muted:#b8b8bf;
  --danger:#ff5a5f;--primary:#3a82f7;--secondary:#2ebd85;
  --room1:#1a1b20;--room2:#20222a;--room3:#252830
}
*{box-sizing:border-box}
body{margin:0;padding:16px;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Arial}
h1{font-size:18px;margin:0 0 12px}
.card{border:1px solid var(--line);border-radius:14px;padding:12px;margin:12px 0;background:#1a1b20}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
label{font-size:12px;color:var(--muted);display:block;margin:6px 0 4px}
.field{width:100%;padding:.55rem .7rem;border:1px solid var(--line);border-radius:.6rem;background:#000;color:inherit}
.small{font-size:12px;color:var(--muted)}
.price{font-weight:600;color:var(--secondary)}
.room-head{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.room-head .sp{flex:1}
.btn{display:inline-flex;align-items:center;gap:.35rem;border:1px solid var(--line);background:transparent;color:var(--primary);border-radius:.5rem;font-weight:500;transition:opacity .15s ease;cursor:pointer}
.btn:hover{opacity:.85}
.btn-xs{padding:.2rem .45rem;font-size:.85rem;line-height:1.1}
.btn-icon{width:1.8rem;height:1.8rem;padding:0;display:inline-grid;place-items:center}
.btn-danger{border-color:var(--danger);color:var(--danger);margin-left:12px}
.actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
.total{border-top:1px solid var(--line);padding-top:10px;margin-top:12px;display:flex;justify-content:space-between;align-items:center}
.hidden{display:none}
details.room>summary{list-style:none}
details.room>summary::-webkit-details-marker{display:none}
summary{user-select:none; pointer-events:none}
summary *{pointer-events:auto}
.chev{display:inline-block;transition:transform .2s}
details[open] .chev{transform:rotate(180deg)}
details[open] [data-room-brief]{display:none}
[data-room-brief]{display:inline-block;margin-left:6px;padding:.2rem .5rem;border:1px solid var(--line);border-radius:.5rem;background:#0d0e12;color:var(--muted)}
[data-room-brief] .num{color:var(--primary);font-weight:600}
.room-head input[name="room_name"]{flex:0 0 50%}
.badge{border:1px solid var(--line);border-radius:.4rem;padding:.05rem .35rem}
.actions-split{justify-content:space-between}
.actions-note{align-items:center}
.actions-note .note{color:var(--muted)}
.actions .sp{flex:1}
</style>
</head>
<body>
<h1>สั่งงานม่าน</h1>

<form id="orderForm" method="post" target="hiddenFrame">
  <input type="hidden" name="payload" id="payload">
  <div id="rooms"></div>

  <div class="actions">
    <button type="button" class="btn btn-xs" id="addRoomBtn">+ เพิ่มห้อง</button>
  </div>

  <div class="total">
    <div class="small">ราคารวม</div>
    <div id="grandTotal" class="price">0 บาท</div>
  </div>

  <div class="total">
    <div class="small">จำนวนชุดทั้งหมด</div>
    <div id="setCount" class="price">0 ชุด</div>
  </div>

  <div class="actions actions-split">
    <button type="button" class="btn btn-xs" id="copyJsonBtn">คัดลอก JSON</button>
    <button type="submit" class="btn btn-xs">ส่งไปคำนวณ</button>
  </div>
</form>

<iframe name="hiddenFrame" class="hidden"></iframe>

<template id="roomTpl">
  <details class="card room" data-room open>
    <summary class="room-head">
      <button type="button" class="btn btn-icon" data-act="toggle-room" title="พับ/กาง"><span class="chev">▾</span></button>
      <span class="badge small">ห้อง</span>
      <input class="field" type="text" name="room_name" placeholder="ห้อง 01" required>
      <span class="small" data-room-brief>จุด 0 • ชุด 0 • ราคา 0 บาท</span>
      <button type="button" class="btn btn-icon" data-act="dup-room" title="ก็อปห้อง">⧉</button>
      <span class="sp"></span>
      <button type="button" class="btn btn-icon btn-danger" data-act="del-room" title="ลบห้อง">✕</button>
    </summary>

    <div class="row">
      <div>
        <label>ราคาผ้า (ต่อเมตร)</label>
        <select class="field" name="price_per_m" required>
          <option value="" hidden>เลือก</option>
          <option value="1000">1,000</option>
          <option value="1200">1,200</option>
          <option value="1300">1,300</option>
          <option value="1400">1,400</option>
          <option value="1500">1,500</option>
          <option value="1600">1,600</option>
          <option value="1700">1,700</option>
          <option value="1800">1,800</option>
          <option value="1900">1,900</option>
          <option value="2000">2,000</option>
          <option value="2100">2,100</option>
          <option value="2200">2,200</option>
          <option value="2300">2,300</option>
          <option value="2400">2,400</option>
          <option value="2500">2,500</option>
        </select>
      </div>
      <div>
        <label>สไตล์</label>
        <select class="field" name="style" required>
          <option value="" hidden>เลือก</option>
          <option>ลอน</option><option>ตาไก่</option><option>จีบ</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>ผ้า (ค่าเริ่มต้นสำหรับจุดใหม่)</label>
        <select class="field" name="fabric" required>
          <option value="" hidden>เลือก</option>
          <option>ทึบ</option><option>โปร่ง</option><option>ทึบ&โปร่ง</option>
        </select>
      </div>
      <div>
        <label>รูปแบบเปิดผ้า</label>
        <select class="field" name="open_type" required>
          <option value="" hidden>เลือก</option>
          <option>แยกกลาง</option><option>สไลด์เดี่ยว</option>
        </select>
      </div>
    </div>

    <div data-sets></div>

    <div class="actions actions-note">
      <div class="small note">หมายเหตุ: ลอน +300/ม. • สูง>2.5ม. +200/ม. • ผ้าเลือกต่อจุด</div>
      <span class="sp"></span>
      <button type="button" class="btn btn-xs" data-act="add-set">+ เพิ่มชุด</button>
    </div>

    <div class="total">
      <div class="small">ราคารวมของห้องนี้</div>
      <div class="price" data-room-total>0 บาท</div>
    </div>
  </details>
</template>

<template id="setTpl">
  <div class="card set" data-set>
    <div class="room-head" style="margin-bottom:4px">
      <strong data-set-title>จุดที่ 01</strong>
      <span class="small" data-set-units>จำนวน 0 ชุด</span>
      <button type="button" class="btn btn-icon" data-act="dup-set" title="ก็อปจุด">⧉</button>
      <span class="sp"></span>
      <button type="button" class="btn btn-xs" data-act="clear-set">clear</button>
      <button type="button" class="btn btn-icon btn-danger" data-act="del-set" title="ลบชุด">−</button>
    </div>
    <div class="row">
      <div>
        <label>กว้าง (ม.)</label>
        <input class="field" name="width_m" type="number" step="0.01" min="0" inputmode="decimal" placeholder="เช่น 3.50" required autocomplete="off">
      </div>
      <div>
        <label>สูง (ม.)</label>
        <input class="field" name="height_m" type="number" step="0.01" min="0" inputmode="decimal" placeholder="เช่น 2.80" required autocomplete="off">
      </div>
    </div>
    <div class="row">
      <div>
        <label>ชนิดผ้าของจุดนี้</label>
        <select class="field" name="fabric_variant">
          <option>ทึบ</option>
          <option>โปร่ง</option>
          <option>ทึบ&โปร่ง</option>
        </select>
      </div>
      <div data-sheer-wrap class="hidden">
        <label>ราคาผ้าโปร่ง (ต่อเมตร)</label>
        <select class="field" name="sheer_price_per_m">
          <option value="" hidden>เลือก</option>
          <option value="1000">1,000</option>
          <option value="1100">1,100</option>
          <option value="1200">1,200</option>
        </select>
      </div>
    </div>
    <div class="small" style="margin-top:8px">
      ทึบ: <span class="price" data-price-opaque>0</span> บาท • โปร่ง: <span class="price" data-price-sheer>0</span> บาท • รวม: <span class="price" data-set-price>0</span> บาท
    </div>
  </div>
</template>

<script>
const APP_VERSION = "input-ui/2025-08-19-r10";
const WEBHOOK_URL = "https://hook.eu2.make.com/xul3fhuh96ybgfm2omdt2e74ejybxjoj";
const STORAGE_KEY = "marnthara.input.v1";

const PRICING = {
  style_surcharge: { 'ลอน': 300, 'ตาไก่': 0, 'จีบ': 0 },
  height: { threshold: 2.5, add_per_m: 200 }
};
const stylePlus  = s => PRICING.style_surcharge[s] ?? 0;
const heightPlus = h => h > PRICING.height.threshold ? PRICING.height.add_per_m : 0;

const roomsEl = document.getElementById('rooms');
const orderForm = document.getElementById('orderForm');
orderForm.action = WEBHOOK_URL;

const copyBtn = document.getElementById('copyJsonBtn');

let roomCount = 0;

function toNum(v){ const n = parseFloat(v); return Number.isFinite(n) ? n : 0; }
function clamp01(n){ return Math.max(0, toNum(n)); }
function fmt(n){ return n.toLocaleString('th-TH'); }
function debounce(fn, ms=120){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

function addRoom(prefill){
  roomCount++;
  const frag = document.getElementById('roomTpl').content.cloneNode(true);
  const room = frag.querySelector('[data-room]');
  room.dataset.index = roomCount;
  const bg = ["var(--room1)","var(--room2)","var(--room3)"][(roomCount-1)%3];
  room.style.background = bg;
  roomsEl.appendChild(frag);
  const created = roomsEl.querySelector('[data-room]:last-of-type');

  if(prefill){
    created.querySelector('input[name="room_name"]').value = prefill.room_name || "";
    created.querySelector('select[name="price_per_m"]').value = prefill.price_per_m_raw || "";
    created.querySelector('select[name="style"]').value = prefill.style || "";
    created.querySelector('select[name="fabric"]').value = prefill.fabric || "";
    created.querySelector('select[name="open_type"]').value = prefill.open_type || "";
  }

  if(prefill && prefill.sets && prefill.sets.length){
    prefill.sets.forEach((s)=> addSet(created, s));
  }else{
    addSet(created);
  }

  renumber();
  recalcAll();
}

function addSet(roomEl, prefill){
  const setsWrap = roomEl.querySelector('[data-sets]');
  const frag = document.getElementById('setTpl').content.cloneNode(true);
  setsWrap.appendChild(frag);
  const created = setsWrap.querySelector('[data-set]:last-of-type');

  const defFab = roomEl.querySelector('select[name="fabric"]').value;
  const mapDefault = (v)=> v||'ทึบ';

  const fvSel = created.querySelector('select[name="fabric_variant"]');
  fvSel.value = prefill?.fabric_variant || mapDefault(defFab);

  if(prefill){
    created.querySelector('input[name="width_m"]').value = prefill.width_m ?? "";
    created.querySelector('input[name="height_m"]').value = prefill.height_m ?? "";
    created.querySelector('select[name="sheer_price_per_m"]').value = prefill.sheer_price_per_m || "";
  }

  toggleSetFabricUI(created);
  renumber();
  recalcAll();
}

function toggleSetFabricUI(set){
  const variant = set.querySelector('select[name="fabric_variant"]').value;
  const showSheer = (variant === 'โปร่ง' || variant === 'ทึบ&โปร่ง');
  set.querySelector('[data-sheer-wrap]').classList.toggle('hidden', !showSheer);
}

function delRoom(btn){
  btn.closest('[data-room]').remove();
  renumber(); recalcAll(); saveSoon();
}

function delSet(btn){
  const room = btn.closest('[data-room]');
  btn.closest('[data-set]').remove();
  if(room.querySelectorAll('[data-set]').length === 0) addSet(room);
  renumber(); recalcAll(); saveSoon();
}

function dupRoom(btn){
  const src = btn.closest('[data-room]');
  const data = serializeRoom(src);
  if(data.room_name) data.room_name = data.room_name + " (copy)";
  addRoom(data);
}

function dupSet(btn){
  const set = btn.closest('[data-set]');
  const room = btn.closest('[data-room]');
  const data = serializeSet(set, room.querySelectorAll('[data-set]').length);
  addSet(room, data);
}

function clearSet(btn){
  const set = btn.closest('[data-set]');
  const room = btn.closest('[data-room]');
  const defFab = room.querySelector('select[name="fabric"]').value || 'ทึบ';
  set.querySelector('input[name="width_m"]').value = '';
  set.querySelector('input[name="height_m"]').value = '';
  const fvSel = set.querySelector('select[name="fabric_variant"]');
  if(fvSel) fvSel.value = defFab || 'ทึบ';
  const sheerSel = set.querySelector('select[name="sheer_price_per_m"]');
  if(sheerSel) sheerSel.value = '';
  toggleSetFabricUI(set);
  recalcAll();
  saveSoon();
}

function clearRoom(btn){
  const room = btn.closest('[data-room]');
  room.querySelectorAll('select').forEach(sel=> sel.value='');
  const wrap = room.querySelector('[data-sets]');
  wrap.innerHTML='';
  addSet(room);
  recalcAll();
  saveSoon();
}

function renumber(){
  [...document.querySelectorAll('[data-room]')].forEach((room, rIdx) => {
    const input = room.querySelector('input[name=\"room_name\"]');
    if(input && !input.value) input.placeholder = `ห้อง ${String(rIdx+1).padStart(2,'0')}`;
    let setCount = 0;
    [...room.querySelectorAll('[data-set]')].forEach((set) => {
      setCount++;
      const lbl = set.querySelector('[data-set-title]');
      if(lbl) lbl.textContent = `จุดที่ ${String(setCount).padStart(2,'0')}`;
    });
  });
}

function basePricePerMRaw(room){
  return toNum(room.querySelector('select[name=\"price_per_m\"]').value);
}

function recalcAll(){
  let grand = 0;
  let allSets = 0;

  [...document.querySelectorAll('[data-room]')].forEach(room=>{
    const baseRaw = basePricePerMRaw(room);
    const style = room.querySelector('select[name=\"style\"]').value;
    const sPlus = stylePlus(style);

    let roomSum = 0;
    let roomUnits = 0;
    const points = room.querySelectorAll('[data-set]').length;

    room.querySelectorAll('[data-set]').forEach(set=>{
      const w = clamp01(set.querySelector('input[name=\"width_m\"]').value);
      const h = clamp01(set.querySelector('input[name=\"height_m\"]').value);
      const hPlus = heightPlus(h);

      const variant = set.querySelector('select[name=\"fabric_variant\"]').value;
      const hasOpaque = variant !== 'โปร่ง';
      const hasSheer  = variant !== 'ทึบ';

      const sheerBase = hasSheer ? clamp01(set.querySelector('[name=\"sheer_price_per_m\"]').value) : 0;

      const opaquePerM = hasOpaque ? (baseRaw + sPlus + hPlus) : 0;
      const sheerPerM  = hasSheer  ? (sheerBase + sPlus + hPlus) : 0;

      const opaque = Math.round(opaquePerM * w);
      const sheer  = Math.round(sheerPerM * w);
      const total  = opaque + sheer;
      const units  = (opaque > 0 ? 1 : 0) + (sheer > 0 ? 1 : 0);

      set.querySelector('[data-price-opaque]').textContent = fmt(opaque);
      set.querySelector('[data-price-sheer]').textContent  = fmt(sheer);
      set.querySelector('[data-set-price]').textContent    = fmt(total);
      set.querySelector('[data-set-units]').textContent    = `จำนวน ${fmt(units)} ชุด`;

      roomSum += total;
      roomUnits += units;
      allSets  += units;
    });

    const rt = room.querySelector('[data-room-total]');
    if(rt) rt.textContent = fmt(roomSum)+' บาท';

    const brief = room.querySelector('[data-room-brief]');
    if(brief){
      brief.innerHTML = `จุด <span class=\"num\">${fmt(points)}</span> • ชุด <span class=\"num\">${fmt(roomUnits)}</span> • ราคา <span class=\"price\">${fmt(roomSum)}</span> บาท`;
    }

    grand += roomSum;
  });

  document.getElementById('grandTotal').textContent = fmt(grand)+' บาท';
  document.getElementById('setCount').textContent = fmt(allSets)+' ชุด';
}

function serializeSet(set, idx=0){
  const width  = clamp01(set.querySelector('input[name=\"width_m\"]').value);
  const height = clamp01(set.querySelector('input[name=\"height_m\"]').value);
  const fabric_variant = set.querySelector('select[name=\"fabric_variant\"]').value;
  const hasSheer = fabric_variant !== 'ทึบ';
  const sheer_price_per_m = hasSheer ? clamp01(set.querySelector('[name=\"sheer_price_per_m\"]').value) : 0;
  return { point_idx: idx+1, width_m: width, height_m: height, fabric_variant, sheer_price_per_m };
}

function serializeRoom(room){
  const ppmRaw = basePricePerMRaw(room);
  const style = room.querySelector('select[name=\"style\"]').value;
  const sPlus2 = stylePlus(style);
  const fabric = room.querySelector('select[name=\"fabric\"]').value;
  return {
    room_id: Number(room.dataset.index) || null,
    room_name: room.querySelector('input[name=\"room_name\"]').value || '',
    price_per_m_raw: ppmRaw,
    price_per_m: ppmRaw + sPlus2,
    style,
    fabric_default: fabric || '',
    open_type: room.querySelector('select[name=\"open_type\"]').value || '',
    sets: [...room.querySelectorAll('[data-set]')].map((set,i)=> serializeSet(set,i))
  };
}

function buildPayload(){
  const roomsData = [];
  let totalTHB = 0;
  let allSets = 0;

  document.querySelectorAll('[data-room]').forEach(room=>{
    const baseRaw = basePricePerMRaw(room);
    const style = room.querySelector('select[name=\"style\"]').value;
    const sPlus = stylePlus(style);

    const roomObj = serializeRoom(room);
    roomObj.sets = [];

    room.querySelectorAll('[data-set]').forEach((set,i)=>{
      const w = clamp01(set.querySelector('input[name=\"width_m\"]').value);
      const h = clamp01(set.querySelector('input[name=\"height_m\"]').value);
      const hPlus = heightPlus(h);

      const variant = set.querySelector('select[name=\"fabric_variant\"]').value;
      const hasOpaque = variant !== 'โปร่ง';
      const hasSheer  = variant !== 'ทึบ';
      const sheerBase = hasSheer ? clamp01(set.querySelector('[name=\"sheer_price_per_m\"]').value) : 0;

      const opaquePerM = hasOpaque ? (baseRaw + sPlus + hPlus) : 0;
      const sheerPerM  = hasSheer  ? (sheerBase + sPlus + hPlus) : 0;

      const price_opaque = Math.round(opaquePerM * w);
      const price_sheer  = Math.round(sheerPerM * w);
      const price        = price_opaque + price_sheer;
      const units        = (price_opaque > 0 ? 1 : 0) + (price_sheer > 0 ? 1 : 0);

      roomObj.sets.push({
        point_idx:i+1, width_m:w, height_m:h, fabric_variant:variant,
        price_per_m_opaque:opaquePerM, price_per_m_sheer:sheerPerM,
        price_opaque, price_sheer, price, units
      });

      totalTHB += price;
      allSets  += units;
    });

    roomsData.push(roomObj);
  });

  return {
    app_version: APP_VERSION,
    generated_at: new Date().toISOString(),
    total_thb: totalTHB,
    total_sets: allSets,
    rooms: roomsData
  };
}

function saveState(){
  const state = { rooms: [...document.querySelectorAll('[data-room]')].map(serializeRoom) };
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){}
}
const saveSoon = debounce(saveState, 200);
const recalcSoon = debounce(recalcAll, 50);

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return false;
    const state = JSON.parse(raw);
    if(!state || !Array.isArray(state.rooms) || state.rooms.length===0) return false;
    roomsEl.innerHTML = '';
    roomCount = 0;
    state.rooms.forEach(r=> addRoom(r));
    recalcAll();
    return true;
  }catch(e){ return false; }
}

document.getElementById('addRoomBtn').addEventListener('click', ()=>{ addRoom(); saveSoon(); });

document.addEventListener('click', e=>{
  const b = e.target.closest('[data-act]');
  if(!b) return;
  e.preventDefault();
  e.stopPropagation();
  const act = b.dataset.act;
  if(act==='add-set'){ addSet(b.closest('[data-room]')); saveSoon(); }
  if(act==='del-room'){ let ok=true; try{ ok = (typeof window!=="undefined" && typeof window.confirm==='function') ? confirm('ลบห้องนี้ทั้งหมด?') : true; }catch(e){ ok=true; } if(!ok) return; delRoom(b); }
  if(act==='del-set'){ let ok=true; try{ ok = (typeof window!=="undefined" && typeof window.confirm==='function') ? confirm('ลบจุดนี้?') : true; }catch(e){ ok=true; } if(!ok) return; delSet(b); }
  if(act==='dup-room'){ dupRoom(b); saveSoon(); }
  if(act==='dup-set'){ dupSet(b); saveSoon(); }
  if(act==='clear-set'){ let ok=true; try{ ok = (typeof window!=="undefined" && typeof window.confirm==='function') ? confirm('ล้างข้อมูลจุดนี้?') : true; }catch(e){ ok=true; } if(!ok) return; clearSet(b); }
  if(act==='clear-room'){ let ok=true; try{ ok = (typeof window!=="undefined" && typeof window.confirm==='function') ? confirm('ล้างข้อมูลห้องนี้?') : true; }catch(e){ ok=true; } if(!ok) return; clearRoom(b); }
  if(act==='toggle-room'){
    const d = b.closest('details');
    if(d) d.open = !d.open;
    recalcAll();
  }
});

document.addEventListener('input', e=>{
  if(e.target.matches('input[name="width_m"], input[name="height_m"], select[name="price_per_m"], select[name="style"], select[name="sheer_price_per_m"], input[name="room_name"], select[name="fabric_variant"]')){
    if(e.target.name === 'fabric_variant') toggleSetFabricUI(e.target.closest('[data-set]'));
    recalcSoon(); saveSoon();
  }
});

document.addEventListener('change', e=>{
  if(e.target.matches('select[name="fabric"], select[name="open_type"]')){
    recalcAll(); saveSoon();
  }
});

copyBtn.addEventListener('click', ()=>{
  const payload = buildPayload();
  const str = JSON.stringify(payload, null, 2);
  navigator.clipboard?.writeText(str).then(()=> alert('คัดลอก JSON แล้ว'));
});

const AUTO_RESTORE = false;
const restored = AUTO_RESTORE && loadState();
recalcAll();

orderForm.addEventListener('submit', (e)=>{
  const payload = buildPayload();
  document.getElementById('payload').value = JSON.stringify(payload);

  if (WEBHOOK_URL.includes('PUT-YOUR-HOOK-HERE')) {
    e.preventDefault();
    alert('ยังไม่ได้ตั้ง Webhook URL ของ Make');
    return;
  }
  saveSoon();
});
</script>
</body>
</html>

