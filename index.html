<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Marnthara Input (Refactored)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- Variable & Base Style --- */
        :root {
            --bg: #0d0e12;
            --card-bg: #1a1b20;
            --fg: #e7e7ea;
            --line: #2f2f33;
            --muted: #b8b8bf;
            --danger: #ff5a5f;
            --primary: #5a7dff;
            --secondary: #4caf50;
            --room1-bg: #1a1b20;
            --room2-bg: #20222a;
            --room3-bg: #252830;
            --accent-dark: #2f2f33;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            padding: 16px 16px 80px 16px;
            background: var(--bg);
            color: var(--fg);
            font-family: system-ui, Segoe UI, Roboto, Arial;
            line-height: 1.5;
        }
        h1 { font-size: 1.2rem; margin: 0; padding: 0; }
        /* --- Card & Layouts --- */
        .card {
            border: 1px solid var(--line);
            border-radius: 14px;
            padding: 12px;
            margin: 12px 0;
            background: var(--card-bg);
        }
        .room {
            border: 1px solid var(--primary);
            margin-bottom: 24px;
            transition: background-color 0.3s ease;
        }
        .room:nth-of-type(3n + 1) { background-color: var(--room1-bg); }
        .room:nth-of-type(3n + 2) { background-color: var(--room2-bg); }
        .room:nth-of-type(3n + 3) { background-color: var(--room3-bg); }
        .room > summary {
            padding: 12px;
            background: var(--accent-dark);
            border-radius: 12px 12px 0 0;
            margin: -12px;
            margin-bottom: 0;
        }
        .room > div, .room > .total { padding-top: 12px; }
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .row.three-col { grid-template-columns: repeat(3, 1fr); }
        /* --- Form Elements --- */
        label { font-size: 0.8rem; color: var(--muted); display: block; margin-bottom: 4px; }
        label.required::after { content: " *"; color: var(--danger); font-weight: bold; }
        .field {
            width: 100%;
            padding: 0.65rem 0.8rem;
            border: 1px solid var(--line);
            border-radius: 0.6rem;
            background: #000;
            color: inherit;
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            font-size: 1rem;
        }
        .field::placeholder { color: var(--muted); }
        .field:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(90, 125, 255, 0.2); }
        /* --- Text & Price --- */
        .small { font-size: 0.8rem; color: var(--muted); }
        .price { font-weight: 600; color: var(--secondary); }
        /* --- Buttons --- */
        .btn {
            display: inline-flex; align-items: center; gap: 0.35rem;
            border: 1px solid var(--line); background: transparent; color: var(--primary);
            border-radius: 0.5rem; font-weight: 500;
            transition: opacity 0.15s ease, transform 0.1s ease, background-color 0.2s;
            cursor: pointer; font-size: 0.9rem;
        }
        .btn:hover { opacity: 0.85; }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-xs { padding: 0.35rem 0.75rem; font-size: 0.8rem; line-height: 1; }
        .btn-icon { width: 2rem; height: 2rem; padding: 0; display: inline-grid; place-items: center; }
        .btn-danger { border-color: var(--danger); color: var(--danger); }
        .btn-primary { background: var(--primary); border-color: var(--primary); color: white; }
        .btn-primary.outline { background: transparent; color: var(--primary); }
        /* --- Layouts & Containers --- */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px; }
        .total { border-top: 1px solid var(--line); padding-top: 16px; margin-top: 16px; display: flex; justify-content: space-between; align-items: center; font-size: 1.2rem; font-weight: 600; }
        .hidden { display: none !important; }
        .room-head { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
        .room-head .sp { flex: 1; }
        /* --- Custom Components --- */
        .badge { border: 1px solid var(--line); border-radius: 0.4rem; padding: 0.1rem 0.5rem; font-size: 0.8rem; font-weight: 500; }
        .set { background: #0d0e12; border: 1px solid #2f2f33; margin-bottom: 12px; border-left: 3px solid var(--primary); border-radius: 12px; padding: 12px; }
        .set-head { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--line); }
        .set-badge {
            font-size: 1rem; font-weight: bold; background: var(--primary); color: #fff;
            border: none; border-radius: 99px; width: 30px; height: 30px;
            display: inline-flex; align-items: center; justify-content: center;
            line-height: 1; flex-shrink: 0;
        }
        .sticky-footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--accent-dark); border-top: 1px solid var(--line);
            padding: 12px 16px; display: grid; grid-template-columns: repeat(5, 1fr);
            gap: 10px; z-index: 1000;
        }
        .sticky-footer .summary-item { text-align: center; }
        .sticky-footer .summary-label { font-size: 0.7rem; color: var(--muted); margin-bottom: 4px; }
        .sticky-footer .summary-value { font-weight: 600; font-size: 1rem; color: var(--primary); }
        .sticky-footer .summary-value.price { color: var(--secondary); }
        .room-actions { display: flex; gap: 8px; }
        /* --- Details & Summary --- */
        details.room > summary { list-style: none; }
        details.room > summary::-webkit-details-marker { display: none; }
        summary { user-select: none; pointer-events: none; }
        summary * { pointer-events: auto; }
        details[open] .chev { transform: rotate(180deg); }
        details[open] [data-room-brief] { display: none; }
        [data-room-brief] {
            display: inline-block; margin-left: 6px; padding: 0.2rem 0.5rem;
            border: 1px solid var(--line); border-radius: 0.5rem;
            background: #0d0e12; color: var(--muted);
        }
        [data-room-brief] .num { color: var(--primary); font-weight: 600; }
        [data-room-brief] .num.price { color: var(--secondary); }
        /* --- Toggle Button --- */
        .toggle-btn {
            display: flex; align-items: center; gap: 0.35rem; padding: 0.35rem 0.75rem;
            border-radius: 0.5rem; font-weight: 500; cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .toggle-btn-closed { background-color: #2f2f33; color: #b8b8bf; }
        .toggle-btn-open { background-color: var(--primary); color: white; }
        .toggle-icon { font-size: 0.8rem; transition: transform 0.2s ease; }
        .toggle-btn-open .toggle-icon { transform: rotate(180deg); }
        
        /* --- Confirmation Modal --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex; align-items: center; justify-content: center;
            z-index: 2000;
            opacity: 0; transition: opacity 0.2s ease-in-out;
        }
        .modal-overlay.visible { opacity: 1; }
        .modal {
            background: var(--card-bg);
            border-radius: 14px;
            padding: 24px;
            border: 1px solid var(--line);
            width: 90%;
            max-width: 400px;
            transform: scale(0.95);
            transition: transform 0.2s ease-in-out;
        }
        .modal-overlay.visible .modal { transform: scale(1); }
        .modal-title { font-size: 1.1rem; font-weight: 600; margin: 0 0 12px 0; }
        .modal-body { margin: 0 0 24px 0; color: var(--muted); }
        .modal-actions { display: flex; justify-content: flex-end; gap: 12px; }

    </style>
</head>
<body>
    <div class="header">
        <h1>Marnthara</h1>
        <button type="button" class="btn btn-xs btn-primary outline" id="addRoomHeaderBtn">
            + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á
        </button>
        <div class="sp"></div>
        <button type="button" class="btn btn-xs btn-primary" id="lockBtn">
            <span class="lock-text">‡∏•‡πá‡∏≠‡∏Ñ</span> <span class="lock-icon">üîí</span>
        </button>
        <div class="sp"></div>
        <button type="button" class="btn btn-xs btn-danger" id="clearAllBtn">
            ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î üóëÔ∏è
        </button>
    </div>

    <form id="orderForm" method="post" target="hiddenFrame">
        <div class="card" id="customerInfo">
            <div class="row three-col">
                <div>
                    <label>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
                    <input class="field" type="text" name="customer_name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ä‡∏≤‡∏¢" />
                </div>
                <div>
                    <label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
                    <input class="field" type="text" name="customer_address" placeholder="‡πÄ‡∏ä‡πà‡∏ô 123/45 ‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô..." />
                </div>
                <div>
                    <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
                    <input class="field" type="tel" name="customer_phone" placeholder="08xxxxxxxx" />
                </div>
            </div>
        </div>

        <input type="hidden" name="payload" id="payload" />
        <div id="rooms"></div>
        <div class="actions actions-split">
            <button type="button" class="btn btn-xs" id="copyJsonBtn">
                ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å JSON
            </button>
            <button type="submit" class="btn btn-xs btn-primary" id="submitBtn">‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
        </div>
    </form>

    <div class="sticky-footer">
        <div class="summary-item">
            <div class="summary-label">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°</div>
            <div class="summary-value price" id="grandTotal">0</div>
        </div>
        <div class="summary-item">
            <div class="summary-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏∏‡∏î</div>
            <div class="summary-value" id="setCount">0</div>
        </div>
        <div class="summary-item">
            <div class="summary-label">‡∏ú‡πâ‡∏≤‡∏ó‡∏∂‡∏ö‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</div>
            <div class="summary-value" id="grandFabric">0</div>
        </div>
        <div class="summary-item">
            <div class="summary-label">‡∏ú‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡πà‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</div>
            <div class="summary-value" id="grandSheerFabric">0</div>
        </div>
        <div class="summary-item">
            <div class="summary-label">‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ (‡∏°.)</div>
            <div class="summary-value" id="grandTrack">0</div>
        </div>
    </div>

    <iframe name="hiddenFrame" class="hidden"></iframe>

    <div id="confirmationModal" class="modal-overlay hidden">
        <div class="modal">
            <h3 class="modal-title" id="modalTitle">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥</h3>
            <p class="modal-body" id="modalBody">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠?</p>
            <div class="modal-actions">
                <button type="button" class="btn btn-xs" id="modalCancel">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="button" class="btn btn-xs btn-danger" id="modalConfirm">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>
        </div>
    </div>


    <template id="roomTpl">
        <details class="card room" data-room open>
            <summary class="room-head">
                <button type="button" class="toggle-btn toggle-btn-open" data-act="toggle-room" data-label-closed="‡∏Ç‡∏¢‡∏≤‡∏¢‡∏´‡πâ‡∏≠‡∏á" data-label-open="‡∏¢‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á" title="‡∏¢‡πà‡∏≠/‡∏Ç‡∏¢‡∏≤‡∏¢‡∏´‡πâ‡∏≠‡∏á">
                    <span class="toggle-label">‡∏¢‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á</span> <span class="toggle-icon">‚ñ≤</span>
                </button>
                <input class="field" type="text" name="room_name" placeholder="‡∏´‡πâ‡∏≠‡∏á 01" required />
                <span class="small" data-room-brief>‡∏à‡∏∏‡∏î 0 ‚Ä¢ ‡∏ä‡∏∏‡∏î 0 ‚Ä¢ ‡∏£‡∏≤‡∏Ñ‡∏≤ 0 ‡∏ö‡∏≤‡∏ó</span>
                <span class="sp"></span>
                <button type="button" class="btn btn-icon btn-danger" data-act="del-room" title="‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á">‚úï</button>
            </summary>

            <div>
                <div class="row">
                     <div>
                        <label class="required">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ú‡πâ‡∏≤ (‡∏ó‡∏∂‡∏ö) (‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏ï‡∏£)</label>
                        <select class="field" name="room_price_per_m" required>
                            <option value="" hidden>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>
                            <option value=""></option>
                        </select>
                    </div>
                    <div>
                        <label class="required">‡∏™‡πÑ‡∏ï‡∏•‡πå</label>
                        <select class="field" name="room_style" required>
                            <option value="" hidden>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>
                            <option value=""></option>
                            <option>‡∏•‡∏≠‡∏ô</option>
                            <option>‡∏ï‡∏≤‡πÑ‡∏Å‡πà</option>
                            <option>‡∏à‡∏µ‡∏ö</option>
                        </select>
                    </div>
                </div>
            </div>

            <div data-sets></div>

            <div class="total">
                <div class="room-actions">
                    <button type="button" class="btn btn-xs btn-primary outline" data-act="add-set">
                        + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î
                    </button>
                </div>
            </div>
        </details>
    </template>

    <template id="setTpl">
        <div class="card set" data-set>
            <div class="set-head">
                <div class="set-badge" data-set-title></div>
                <span class="small" data-set-units>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô 0 ‡∏ä‡∏∏‡∏î</span>
                <span class="sp"></span>
                <button type="button" class="btn btn-xs" data-act="clear-set">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                <button type="button" class="btn btn-icon btn-danger" data-act="del-set" title="‡∏•‡∏ö‡∏ä‡∏∏‡∏î">‚àí</button>
            </div>
            <div class="row">
                <div>
                    <label class="required">‡∏Å‡∏ß‡πâ‡∏≤‡∏á (‡∏°.)</label>
                    <input class="field" name="width_m" type="number" step="0.01" min="0" inputmode="decimal" placeholder="‡πÄ‡∏ä‡πà‡∏ô 3.50" required autocomplete="off" />
                </div>
                <div>
                    <label class="required">‡∏™‡∏π‡∏á (‡∏°.)</label>
                    <input class="field" name="height_m" type="number" step="0.01" min="0" inputmode="decimal" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2.80" required autocomplete="off" />
                </div>
            </div>
            <div class="row" data-set-options-row>
                <div>
                    <label>‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πâ‡∏≤</label>
                    <select class="field" name="open_type">
                        <option value="" hidden>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>
                        <option value=""></option>
                        <option>‡πÅ‡∏¢‡∏Å‡∏Å‡∏•‡∏≤‡∏á</option>
                        <option>‡∏™‡πÑ‡∏•‡∏î‡πå‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß</option>
                    </select>
                </div>
                <div>
                    <label>‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ</label>
                    <select class="field" name="fabric_variant">
                        <option>‡∏ó‡∏∂‡∏ö</option>
                        <option>‡πÇ‡∏õ‡∏£‡πà‡∏á</option>
                        <option>‡∏ó‡∏∂‡∏ö&‡πÇ‡∏õ‡∏£‡πà‡∏á</option>
                    </select>
                </div>
                <div data-sheer-wrap class="hidden">
                    <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ú‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡πà‡∏á (‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏ï‡∏£)</label>
                    <select class="field" name="sheer_price_per_m">
                        <option value="" hidden>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>
                        <option value=""></option>
                    </select>
                </div>
            </div>
            <div class="small" style="margin-top: 8px">
                <span data-opaque-price-label>‡∏ó‡∏∂‡∏ö: <span class="price" data-set-price-opaque>0</span> ‡∏ö‡∏≤‡∏ó</span>
                <span data-sheer-price-label class="hidden"> ‚Ä¢ ‡πÇ‡∏õ‡∏£‡πà‡∏á: <span class="price" data-set-price-sheer>0</span> ‡∏ö‡∏≤‡∏ó</span>
                <span data-opaque-yardage-label> ‚Ä¢ ‡∏ó‡∏∂‡∏ö: <span class="price" data-set-yardage-opaque>0</span> ‡∏´‡∏•‡∏≤</span>
                <span data-sheer-yardage-label class="hidden"> ‚Ä¢ ‡πÇ‡∏õ‡∏£‡πà‡∏á: <span class="price" data-set-yardage-sheer>0</span> ‡∏´‡∏•‡∏≤</span>
                <span data-track-label> ‚Ä¢ ‡∏£‡∏≤‡∏á: <span class="price" data-set-track>0</span> ‡∏°.</span>
            </div>
        </div>
    </template>

    <script>
    // --- IIFE Wrapper to prevent global scope pollution ---
    (function() {
        'use strict';

        // --- App Configuration ---
        const APP_VERSION = "input-ui/2.0.0";
        const WEBHOOK_URL = "https://your-make-webhook-url.com/your-unique-path";
        const STORAGE_KEY = "marnthara.input.v2"; // Changed version to avoid conflicts with old data structure

        const PRICING = {
            fabric: [1000, 1200, 1300, 1400, 1500, 1600, 1700, 1800, 1900, 2000, 2100, 2200, 2300, 2400, 2500],
            sheer: [1000, 1100, 1200, 1300, 1400, 1500],
            style_surcharge: { "‡∏•‡∏≠‡∏ô": 200, "‡∏ï‡∏≤‡πÑ‡∏Å‡πà": 0, "‡∏à‡∏µ‡∏ö": 0 },
            height: [
                { threshold: 3.2, add_per_m: 300 },
                { threshold: 2.8, add_per_m: 200 },
                { threshold: 2.5, add_per_m: 150 },
            ],
        };

        const CALC = {
            fabricYardage: (style, width) => {
                let yards = 0;
                if (width > 0) {
                    if (style === "‡∏ï‡∏≤‡πÑ‡∏Å‡πà" || style === "‡∏à‡∏µ‡∏ö") {
                        yards = (width * 2.0 + 0.6) / 0.9;
                    } else if (style === "‡∏•‡∏≠‡∏ô") {
                        yards = (width * 2.6 + 0.6) / 0.9;
                    }
                }
                return yards > 0 ? yards : 0;
            },
        };

        // --- Centralized Selectors for easy maintenance ---
        const SELECTORS = {
            orderForm: '#orderForm',
            roomsContainer: '#rooms',
            roomTpl: '#roomTpl',
            setTpl: '#setTpl',
            payloadInput: '#payload',
            copyJsonBtn: '#copyJsonBtn',
            clearAllBtn: '#clearAllBtn',
            lockBtn: '#lockBtn',
            addRoomHeaderBtn: '#addRoomHeaderBtn',
            submitBtn: '#submitBtn',
            // Grand Totals
            grandTotal: '#grandTotal',
            setCount: '#setCount',
            grandFabric: '#grandFabric',
            grandSheerFabric: '#grandSheerFabric',
            grandTrack: '#grandTrack',
            // Modal
            modal: '#confirmationModal',
            modalTitle: '#modalTitle',
            modalBody: '#modalBody',
            modalConfirm: '#modalConfirm',
            modalCancel: '#modalCancel',
            // Data Attributes
            room: '[data-room]',
            set: '[data-set]',
            setsContainer: '[data-sets]',
            sheerWrap: '[data-sheer-wrap]',
            toggleRoomBtn: '[data-act="toggle-room"]',
            // Names
            roomNameInput: 'input[name="room_name"]',
            roomPricePerM: 'select[name="room_price_per_m"]',
            roomStyle: 'select[name="room_style"]',
            widthInput: 'input[name="width_m"]',
            heightInput: 'input[name="height_m"]',
            fabricVariant: 'select[name="fabric_variant"]',
            sheerPricePerM: 'select[name="sheer_price_per_m"]',
            setOptionsRow: '[data-set-options-row]',
        };

        // --- DOM Elements ---
        const roomsEl = document.querySelector(SELECTORS.roomsContainer);
        const orderForm = document.querySelector(SELECTORS.orderForm);
        orderForm.action = WEBHOOK_URL;
        
        const modalEl = document.querySelector(SELECTORS.modal);

        let roomCount = 0;
        let isLocked = false;
        
        // --- Utility Functions ---
        const toNum = v => Number.isFinite(parseFloat(v)) ? parseFloat(v) : 0;
        const clamp01 = v => Math.max(0, toNum(v));
        const fmt = (n, fixed = 2, asCurrency = false) => {
            if (!Number.isFinite(n)) return "0";
            const options = asCurrency 
                ? { minimumFractionDigits: 0, maximumFractionDigits: 0 } 
                : { minimumFractionDigits: fixed, maximumFractionDigits: fixed };
            return n.toLocaleString("th-TH", options);
        };
        const debounce = (fn, ms = 120) => {
            let t;
            return (...a) => {
                clearTimeout(t);
                t = setTimeout(() => fn(...a), ms);
            };
        };

        // --- Pricing Calculation Helpers ---
        const stylePlus = s => PRICING.style_surcharge[s] ?? 0;
        const heightPlus = h => {
            const sorted = [...PRICING.height].sort((a, b) => b.threshold - a.threshold);
            for (const entry of sorted) {
                if (h > entry.threshold) return entry.add_per_m;
            }
            return 0;
        };
        
        // --- Modal Logic ---
        const showConfirmation = (title, body) => {
            return new Promise((resolve) => {
                modalEl.querySelector(SELECTORS.modalTitle).textContent = title;
                modalEl.querySelector(SELECTORS.modalBody).textContent = body;
                modalEl.classList.remove('hidden');
                setTimeout(() => modalEl.classList.add('visible'), 10);

                const confirmHandler = () => {
                    resolve(true);
                    cleanup();
                };
                const cancelHandler = () => {
                    resolve(false);
                    cleanup();
                };
                const cleanup = () => {
                    modalEl.classList.remove('visible');
                    setTimeout(() => modalEl.classList.add('hidden'), 200);
                    modalEl.querySelector(SELECTORS.modalConfirm).removeEventListener('click', confirmHandler);
                    modalEl.querySelector(SELECTORS.modalCancel).removeEventListener('click', cancelHandler);
                };
                
                modalEl.querySelector(SELECTORS.modalConfirm).addEventListener('click', confirmHandler, { once: true });
                modalEl.querySelector(SELECTORS.modalCancel).addEventListener('click', cancelHandler, { once: true });
            });
        };

        // --- Core Application Logic ---
        function addRoom(prefill) {
            if (isLocked) return;
            roomCount++;
            const frag = document.querySelector(SELECTORS.roomTpl).content.cloneNode(true);
            const room = frag.querySelector(SELECTORS.room);
            room.dataset.index = roomCount;
            
            // Populate room-level price options
            const ppmSel = room.querySelector(SELECTORS.roomPricePerM);
            populatePriceOptions(ppmSel, PRICING.fabric);
            
            roomsEl.appendChild(frag);
            const created = roomsEl.querySelector(`${SELECTORS.room}:last-of-type`);

            updateToggleBtnText(created.querySelector(SELECTORS.toggleRoomBtn));

            if (prefill) {
                created.querySelector(SELECTORS.roomNameInput).value = prefill.room_name || "";
                created.querySelector(SELECTORS.roomPricePerM).value = prefill.price_per_m_raw || "";
                created.querySelector(SELECTORS.roomStyle).value = prefill.style || "";
            }

            if (prefill && prefill.sets && prefill.sets.length) {
                prefill.sets.forEach(s => addSet(created, s));
            } else {
                addSet(created);
            }

            renumber();
            recalcAll();
            saveData();
            updateLockState();
            created.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }

        function populatePriceOptions(selectEl, prices) {
            selectEl.innerHTML = `<option value="" hidden>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option><option value=""></option>`;
            prices.forEach(price => {
                const option = document.createElement('option');
                option.value = price;
                option.textContent = price.toLocaleString("th-TH");
                selectEl.appendChild(option);
            });
        }

        function addSet(roomEl, prefill) {
            if (isLocked) return;
            const setsWrap = roomEl.querySelector(SELECTORS.setsContainer);
            const frag = document.querySelector(SELECTORS.setTpl).content.cloneNode(true);
            setsWrap.appendChild(frag);
            const created = setsWrap.querySelector(`${SELECTORS.set}:last-of-type`);
            
            const sheerSel = created.querySelector(SELECTORS.sheerPricePerM);
            populatePriceOptions(sheerSel, PRICING.sheer);

            if (prefill) {
                created.querySelector(SELECTORS.widthInput).value = prefill.width_m ?? "";
                created.querySelector(SELECTORS.heightInput).value = prefill.height_m ?? "";
                created.querySelector(SELECTORS.fabricVariant).value = prefill.fabric_variant || "‡∏ó‡∏∂‡∏ö";
                created.querySelector('select[name="open_type"]').value = prefill.open_type || "";
                created.querySelector(SELECTORS.sheerPricePerM).value = prefill.sheer_price_per_m || "";
            }
            
            toggleSetFabricUI(created);
            renumber();
            recalcAll();
            saveData();
            updateLockState();
            created.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }

        function toggleSetFabricUI(setEl) {
            const variant = setEl.querySelector(SELECTORS.fabricVariant).value;
            const hasSheer = variant === "‡πÇ‡∏õ‡∏£‡πà‡∏á" || variant === "‡∏ó‡∏∂‡∏ö&‡πÇ‡∏õ‡∏£‡πà‡∏á";
            const hasOpaque = variant !== "‡πÇ‡∏õ‡∏£‡πà‡∏á";
            
            setEl.querySelector(SELECTORS.sheerWrap).classList.toggle("hidden", !hasSheer);
            
            // Adjust grid for 3 columns when sheer is visible
            const optionsRow = setEl.querySelector(SELECTORS.setOptionsRow);
            optionsRow.classList.toggle("three-col", hasSheer);

            // Toggle visibility of summary labels
            setEl.querySelector("[data-sheer-price-label]").classList.toggle("hidden", !hasSheer);
            setEl.querySelector("[data-sheer-yardage-label]").classList.toggle("hidden", !hasSheer);
            setEl.querySelector("[data-opaque-price-label]").classList.toggle("hidden", !hasOpaque);
            setEl.querySelector("[data-opaque-yardage-label]").classList.toggle("hidden", !hasOpaque);
        }

        function updateToggleBtnText(btn) {
            const details = btn.closest("details");
            if (!details) return;
            const label = details.open ? btn.dataset.labelOpen : btn.dataset.labelClosed;
            const icon = details.open ? '‚ñ≤' : '‚ñº';
            btn.querySelector('.toggle-label').textContent = label;
            btn.querySelector('.toggle-icon').textContent = icon;
            btn.classList.toggle('toggle-btn-open', details.open);
            btn.classList.toggle('toggle-btn-closed', !details.open);
        }

        async function delRoom(btn) {
            if (isLocked) return;
            const confirmed = await showConfirmation('‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á', '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?');
            if (!confirmed) return;
            btn.closest(SELECTORS.room).remove();
            renumber();
            recalcAll();
            saveData();
            updateLockState();
        }

        async function delSet(btn) {
            if (isLocked) return;
            const confirmed = await showConfirmation('‡∏•‡∏ö‡∏à‡∏∏‡∏î', '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏à‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?');
            if (!confirmed) return;
            const room = btn.closest(SELECTORS.room);
            btn.closest(SELECTORS.set).remove();
            if (room.querySelectorAll(SELECTORS.set).length === 0) addSet(room);
            renumber();
            recalcAll();
            saveData();
            updateLockState();
        }

        async function clearSet(btn) {
            if (isLocked) return;
            const confirmed = await showConfirmation('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏à‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?');
            if (!confirmed) return;
            const set = btn.closest(SELECTORS.set);
            set.querySelectorAll('input, select').forEach(el => {
                if (el.name === 'fabric_variant') el.value = '‡∏ó‡∏∂‡∏ö';
                else el.value = '';
            });
            toggleSetFabricUI(set);
            recalcAll();
            saveData();
            updateLockState();
        }

        async function clearAllData() {
            if (isLocked) return;
            const confirmed = await showConfirmation('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', '‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô! ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ');
            if (!confirmed) return;

            roomsEl.innerHTML = "";
            roomCount = 0;
            document.querySelectorAll('#customerInfo input').forEach(input => input.value = "");
            addRoom();
            saveData();
            updateLockState();
        }

        // --- Data Handling ---
        function saveData() {
            const payload = buildPayload(false); // Build a simple payload for storage
            localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
        }

        function loadData() {
            const storedData = localStorage.getItem(STORAGE_KEY);
            if (storedData) {
                const payload = JSON.parse(storedData);
                document.querySelector('input[name="customer_name"]').value = payload.customer_name;
                document.querySelector('input[name="customer_address"]').value = payload.customer_address;
                document.querySelector('input[name="customer_phone"]').value = payload.customer_phone;

                roomsEl.innerHTML = "";
                roomCount = 0;
                if (payload.rooms && payload.rooms.length > 0) {
                    payload.rooms.forEach(roomData => addRoom(roomData));
                } else {
                    addRoom();
                }
            } else {
                addRoom();
            }
        }
        
        function toggleLock() {
            isLocked = !isLocked;
            updateLockState();
        }

        function updateLockState() {
            document.querySelectorAll(`${SELECTORS.orderForm} input, ${SELECTORS.orderForm} select`).forEach(f => f.disabled = isLocked);
            document.querySelectorAll(`${SELECTORS.orderForm} button`).forEach(b => {
                // Allow lock, clear, and toggle buttons to always be interactive
                if (!b.matches(`${SELECTORS.lockBtn}, ${SELECTORS.clearAllBtn}, ${SELECTORS.toggleRoomBtn}, #modalConfirm, #modalCancel`)) {
                    b.disabled = isLocked;
                }
            });
            const lockBtn = document.querySelector(SELECTORS.lockBtn);
            lockBtn.classList.toggle('btn-danger', isLocked);
            lockBtn.classList.toggle('btn-primary', !isLocked);
            lockBtn.querySelector('.lock-text').textContent = isLocked ? '‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ' : '‡∏•‡πá‡∏≠‡∏Ñ';
            lockBtn.querySelector('.lock-icon').textContent = isLocked ? 'üîì' : 'üîí';
        }

        function renumber() {
            [...document.querySelectorAll(SELECTORS.room)].forEach((room, rIdx) => {
                const input = room.querySelector(SELECTORS.roomNameInput);
                if (input && !input.value) input.placeholder = `‡∏´‡πâ‡∏≠‡∏á ${String(rIdx + 1).padStart(2, "0")}`;
                const sets = [...room.querySelectorAll(SELECTORS.set)];
                sets.forEach((set, sIdx) => {
                    const lbl = set.querySelector("[data-set-title]");
                    if (lbl) lbl.textContent = `${sIdx + 1}/${sets.length}`;
                });
            });
        }

        function recalcAll() {
            let grand = 0, allSets = 0, grandOpaqueYards = 0, grandSheerYards = 0, grandTrack = 0;

            document.querySelectorAll(SELECTORS.room).forEach((room) => {
                let roomSum = 0, roomUnits = 0, roomOpaqueYards = 0, roomSheerYards = 0, roomTrack = 0;
                
                const baseRaw = toNum(room.querySelector(SELECTORS.roomPricePerM).value);
                const style = room.querySelector(SELECTORS.roomStyle).value;
                const sPlus = stylePlus(style);
                
                room.querySelectorAll(SELECTORS.set).forEach((set) => {
                    const w = clamp01(set.querySelector(SELECTORS.widthInput).value);
                    const h = clamp01(set.querySelector(SELECTORS.heightInput).value);
                    const hPlus = heightPlus(h);
                    const variant = set.querySelector(SELECTORS.fabricVariant).value;
                    
                    const hasOpaque = variant !== "‡πÇ‡∏õ‡∏£‡πà‡∏á";
                    const hasSheer = variant === "‡πÇ‡∏õ‡∏£‡πà‡∏á" || variant === "‡∏ó‡∏∂‡∏ö&‡πÇ‡∏õ‡∏£‡πà‡∏á";
                    const sheerBase = hasSheer ? clamp01(set.querySelector(SELECTORS.sheerPricePerM).value) : 0;
                    
                    const opaquePerM = hasOpaque ? baseRaw + sPlus + hPlus : 0;
                    const sheerPerM = hasSheer ? sheerBase + sPlus + hPlus : 0;
                    const opaquePrice = Math.round(opaquePerM * w);
                    const sheerPrice = Math.round(sheerPerM * w);
                    
                    const total = opaquePrice + sheerPrice;
                    const units = (opaquePrice > 0 ? 1 : 0) + (sheerPrice > 0 ? 1 : 0);
                    const yards = CALC.fabricYardage(style, w);
                    const track = variant === "‡∏ó‡∏∂‡∏ö&‡πÇ‡∏õ‡∏£‡πà‡∏á" ? w * 2 : w;

                    set.querySelector('[data-set-price-opaque]').textContent = fmt(opaquePrice, 0, true);
                    set.querySelector('[data-set-price-sheer]').textContent = fmt(sheerPrice, 0, true);
                    set.querySelector('[data-set-yardage-opaque]').textContent = fmt(yards, 2);
                    set.querySelector('[data-set-yardage-sheer]').textContent = fmt(yards, 2);
                    set.querySelector('[data-set-track]').textContent = fmt(track, 2);

                    roomSum += total;
                    roomUnits += units;
                    if(hasOpaque) roomOpaqueYards += yards;
                    if(hasSheer) roomSheerYards += yards;
                    if (w > 0 && (hasOpaque || hasSheer)) roomTrack += track;
                    allSets += units;
                });
                
                const brief = room.querySelector("[data-room-brief]");
                if (brief) {
                    brief.innerHTML = `‡∏à‡∏∏‡∏î <span class="num">${fmt(room.querySelectorAll(SELECTORS.set).length, 0, true)}</span> ‚Ä¢ ‡∏ä‡∏∏‡∏î <span class="num">${fmt(roomUnits, 0, true)}</span> ‚Ä¢ ‡∏£‡∏≤‡∏Ñ‡∏≤ <span class="num price">${fmt(roomSum, 0, true)}</span> ‡∏ö‡∏≤‡∏ó`;
                }
                
                grand += roomSum;
                grandOpaqueYards += roomOpaqueYards;
                grandSheerYards += roomSheerYards;
                grandTrack += roomTrack;
            });
            
            document.querySelector(SELECTORS.grandTotal).textContent = fmt(grand, 0, true);
            document.querySelector(SELECTORS.setCount).textContent = fmt(allSets, 0, true);
            document.querySelector(SELECTORS.grandFabric).textContent = fmt(grandOpaqueYards, 2);
            document.querySelector(SELECTORS.grandSheerFabric).textContent = fmt(grandSheerYards, 2);
            document.querySelector(SELECTORS.grandTrack).textContent = fmt(grandTrack, 2);
        }

        function buildPayload(withCalculations = true) {
            let totalTHB = 0, allSets = 0, totalOpaqueYards = 0, totalSheerYards = 0, totalTrack = 0;

            const roomsData = [...document.querySelectorAll(SELECTORS.room)].map(room => {
                const room_name = room.querySelector(SELECTORS.roomNameInput).value || "";
                const price_per_m_raw = toNum(room.querySelector(SELECTORS.roomPricePerM).value);
                const style = room.querySelector(SELECTORS.roomStyle).value;

                const sets = [...room.querySelectorAll(SELECTORS.set)].map((set, i) => {
                    const w = clamp01(set.querySelector(SELECTORS.widthInput).value);
                    const h = clamp01(set.querySelector(SELECTORS.heightInput).value);
                    const fabric_variant = set.querySelector(SELECTORS.fabricVariant).value;
                    const open_type = set.querySelector('select[name="open_type"]').value || "";
                    const sheer_price_per_m = clamp01(set.querySelector(SELECTORS.sheerPricePerM).value);
                    
                    if (!withCalculations) {
                        return { width_m: w, height_m: h, fabric_variant, open_type, sheer_price_per_m };
                    }
                    
                    // --- Full calculation for final payload ---
                    const hPlus = heightPlus(h);
                    const sPlus = stylePlus(style);
                    const hasOpaque = fabric_variant !== "‡πÇ‡∏õ‡∏£‡πà‡∏á";
                    const hasSheer = fabric_variant === "‡πÇ‡∏õ‡∏£‡πà‡∏á" || fabric_variant === "‡∏ó‡∏∂‡∏ö&‡πÇ‡∏õ‡∏£‡πà‡∏á";
                    
                    const opaquePerM = hasOpaque ? price_per_m_raw + sPlus + hPlus : 0;
                    const sheerPerM = hasSheer ? sheer_price_per_m + sPlus + hPlus : 0;
                    const price_opaque = Math.round(opaquePerM * w);
                    const price_sheer = Math.round(sheerPerM * w);
                    const price = price_opaque + price_sheer;
                    const units = (price_opaque > 0 ? 1 : 0) + (price_sheer > 0 ? 1 : 0);
                    const yards = CALC.fabricYardage(style, w);
                    const track = fabric_variant === "‡∏ó‡∏∂‡∏ö&‡πÇ‡∏õ‡∏£‡πà‡∏á" ? w * 2 : 0;
                    
                    totalTHB += price;
                    allSets += units;
                    if(hasOpaque) totalOpaqueYards += yards;
                    if(hasSheer) totalSheerYards += yards;
                    if (w > 0 && (hasOpaque || hasSheer)) totalTrack += track;

                    return {
                        point_idx: i + 1,
                        width_m: w, height_m: h, fabric_variant, open_type,
                        sheer_price_per_m,
                        price_per_m_opaque: opaquePerM,
                        price_per_m_sheer: sheerPerM,
                        price_opaque, price_sheer, price, units,
                        fabric_yards_opaque: hasOpaque ? yards : 0,
                        fabric_yards_sheer: hasSheer ? yards : 0,
                        track_m: track
                    };
                });
                
                return { room_name, price_per_m_raw, style, sets };
            });

            const payload = {
                customer_name: document.querySelector('input[name="customer_name"]').value || "",
                customer_address: document.querySelector('input[name="customer_address"]').value || "",
                customer_phone: document.querySelector('input[name="customer_phone"]').value || "",
                app_version: APP_VERSION,
                generated_at: new Date().toISOString(),
                rooms: roomsData,
            };
            
            if (withCalculations) {
                Object.assign(payload, {
                    total_thb: totalTHB,
                    total_sets: allSets,
                    total_yards: totalOpaqueYards + totalSheerYards,
                    total_opaque_yards: totalOpaqueYards,
                    total_sheer_yards: totalSheerYards,
                    total_track_m: totalTrack,
                });
            }

            return payload;
        }

        // --- Event Listeners ---
        const debouncedRecalcAndSave = debounce(() => { recalcAll(); saveData(); });

        document.addEventListener("change", (e) => {
            if (e.target.matches(SELECTORS.fabricVariant)) {
                toggleSetFabricUI(e.target.closest(SELECTORS.set));
            }
            debouncedRecalcAndSave();
        });

        document.addEventListener("input", debouncedRecalcAndSave);

        document.addEventListener("click", (e) => {
            const btn = e.target.closest("button");
            if (!btn) return;
            const act = btn.dataset.act;

            // Prevent default for all buttons inside the listener to avoid form submission
            if (btn.type !== 'submit') e.preventDefault();
            
            if (act === "del-room") delRoom(btn);
            else if (act === "del-set") delSet(btn);
            else if (act === "add-set") addSet(btn.closest(SELECTORS.room));
            else if (act === "clear-set") clearSet(btn);
            else if (act === "toggle-room") {
                const details = btn.closest("details");
                details.open = !details.open;
                updateToggleBtnText(btn);
                saveData();
            }
            else if (btn.id === "addRoomHeaderBtn") addRoom();
            else if (btn.id === "clearAllBtn") clearAllData();
            else if (btn.id === "lockBtn") toggleLock();
            else if (btn.id === "copyJsonBtn") {
                navigator.clipboard.writeText(JSON.stringify(buildPayload(), null, 2))
                    .then(() => alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å JSON ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!'))
                    .catch(err => console.error('Failed to copy: ', err));
            }
        });

        orderForm.addEventListener("submit", (e) => {
            if (isLocked) {
                e.preventDefault(); return;
            }
            const submitBtn = document.querySelector(SELECTORS.submitBtn);
            submitBtn.disabled = true;
            submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';
            
            document.querySelector(SELECTORS.payloadInput).value = JSON.stringify(buildPayload());
            
            // Re-enable button after a short delay in case submission fails
            setTimeout(() => {
                submitBtn.disabled = isLocked; // Re-apply lock state
                submitBtn.textContent = '‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì';
            }, 3000);
        });

        // --- Initial Load ---
        window.addEventListener('load', loadData);
        updateLockState();
    })();
    </script>
</body>
</html>