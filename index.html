<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Marnthara Input</title>
    <style>
      :root {
        --bg: #111215;
        --fg: #e7e7ea;
        --line: #2f2f33;
        --muted: #b8b8bf;
        --danger: #ff5a5f;
        --primary: #3a82f7;
        --secondary: #2ebd85;
        --room1: #1a1b20;
        --room2: #20222a;
        --room3: #252830;
        --accent-dark: #2f2f33;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        padding: 16px 16px 80px 16px;
        background: var(--bg);
        color: var(--fg);
        font-family: system-ui, Segoe UI, Roboto, Arial;
      }
      h1 {
        font-size: 18px;
        margin: 0;
        padding: 0;
      }
      .card {
        border: 1px solid var(--line);
        border-radius: 14px;
        padding: 12px;
        margin: 12px 0;
        background: #1a1b20;
      }
      .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .row.three-col {
        grid-template-columns: repeat(3, 1fr);
      }
      label {
        font-size: 12px;
        color: var(--muted);
        display: block;
        margin: 6px 0 4px;
      }
      .field {
        width: 100%;
        padding: 0.55rem 0.7rem;
        border: 1px solid var(--line);
        border-radius: 0.6rem;
        background: #000;
        color: inherit;
      }
      .small {
        font-size: 12px;
        color: var(--muted);
      }
      .price {
        font-weight: 600;
        color: var(--secondary);
      }
      .room-head {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 8px;
      }
      .room-head .sp {
        flex: 1;
      }
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        border: 1px solid var(--line);
        background: transparent;
        color: var(--primary);
        border-radius: 0.5rem;
        font-weight: 500;
        transition: opacity 0.15s ease;
        cursor: pointer;
      }
      .btn:hover {
        opacity: 0.85;
      }
      .btn-xs {
        padding: 0.2rem 0.45rem;
        font-size: 0.85rem;
        line-height: 1.1;
      }
      .btn-icon {
        width: 1.8rem;
        height: 1.8rem;
        padding: 0;
        display: inline-grid;
        place-items: center;
      }
      .btn-danger {
        border-color: var(--danger);
        color: var(--danger);
      }
      .actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 10px;
      }
      .total {
        border-top: 1px solid var(--line);
        padding-top: 10px;
        margin-top: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .hidden {
        display: none;
      }
      details.room > summary {
        list-style: none;
      }
      details.room > summary::-webkit-details-marker {
        display: none;
      }
      summary {
        user-select: none;
        pointer-events: none;
      }
      summary * {
        pointer-events: auto;
      }
      .chev {
        display: inline-block;
        transition: transform 0.2s;
      }
      details[open] .chev {
        transform: rotate(180deg);
      }
      details[open] [data-room-brief] {
        display: none;
      }
      [data-room-brief] {
        display: inline-block;
        margin-left: 6px;
        padding: 0.2rem 0.5rem;
        border: 1px solid var(--line);
        border-radius: 0.5rem;
        background: #0d0e12;
        color: var(--muted);
      }
      [data-room-brief] .num {
        color: var(--primary);
        font-weight: 600;
      }
      [data-room-brief] .num.price {
        color: var(--secondary);
      }
      .room-head input[name="room_name"] {
        flex: 0 0 50%;
      }
      .badge {
        border: 1px solid var(--line);
        border-radius: 0.4rem;
        padding: 0.05rem 0.35rem;
      }
      .actions-split {
        justify-content: space-between;
      }
      .actions-note {
        align-items: center;
      }
      .actions-note .note {
        color: var(--muted);
      }
      .actions .sp {
        flex: 1;
      }
      .sticky-footer {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: var(--accent-dark);
        border-top: 1px solid var(--line);
        padding: 10px 16px;
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
        gap: 10px;
        z-index: 1000;
      }
      .sticky-footer .summary-item {
        text-align: center;
      }
      .sticky-footer .summary-label {
        font-size: 11px;
        color: var(--muted);
        margin-bottom: 2px;
      }
      .sticky-footer .summary-value {
        font-weight: 600;
        font-size: 15px;
        color: var(--primary);
      }
      .sticky-footer .summary-value.price {
        color: var(--secondary);
      }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }
      .header .actions {
        margin: 0;
      }
      .room-head .badge {
        flex: 0 0 auto;
      }
      .room-head input[name="room_name"] {
        flex: 1;
        min-width: 0;
      }
      .set {
        background: #0d0e12;
        border: 1px solid #2f2f33;
        margin-bottom: 8px;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>Marnthara</h1>
      <div class="actions">
        <button type="button" class="btn btn-xs" id="addRoomBtn">
          + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á
        </button>
        <button type="button" class="btn btn-xs" id="saveStateBtn">
          ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å üíæ
        </button>
        <button type="button" class="btn btn-xs" id="loadStateBtn">
          ‡πÇ‡∏´‡∏•‡∏î üìÇ
        </button>
        <button type="button" class="btn btn-xs btn-danger" id="clearAllBtn">
          ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î üóëÔ∏è
        </button>
      </div>
    </div>

    <form id="orderForm" method="post" target="hiddenFrame">
      <input type="hidden" name="payload" id="payload" />
      <div id="rooms"></div>
      <div class="actions actions-split">
        <button type="button" class="btn btn-xs" id="copyJsonBtn">
          ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å JSON
        </button>
        <button type="submit" class="btn btn-xs">‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
      </div>
    </form>

    <div class="sticky-footer">
      <div class="summary-item">
        <div class="summary-label">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°</div>
        <div class="summary-value price" id="grandTotal">0</div>
      </div>
      <div class="summary-item">
        <div class="summary-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏∏‡∏î</div>
        <div class="summary-value" id="setCount">0</div>
      </div>
      <div class="summary-item">
        <div class="summary-label">‡∏ú‡πâ‡∏≤‡∏ó‡∏∂‡∏ö‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</div>
        <div class="summary-value" id="grandFabric">0</div>
      </div>
      <div class="summary-item">
        <div class="summary-label">‡∏ú‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡πà‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</div>
        <div class="summary-value" id="grandSheerFabric">0</div>
      </div>
      <div class="summary-item">
        <div class="summary-label">‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ (‡∏°.)</div>
        <div class="summary-value" id="grandTrack">0</div>
      </div>
    </div>

    <iframe name="hiddenFrame" class="hidden"></iframe>

    <template id="roomTpl">
      <details class="card room" data-room open>
        <summary class="room-head">
          <button
            type="button"
            class="btn btn-xs"
            data-act="toggle-room"
            data-label-closed="‡∏Ç‡∏¢‡∏≤‡∏¢"
            data-label-open="‡∏¢‡πà‡∏≠"
          >
            ‡∏¢‡πà‡∏≠
          </button>
          <span class="badge small">‡∏´‡πâ‡∏≠‡∏á</span>
          <input
            class="field"
            type="text"
            name="room_name"
            placeholder="‡∏´‡πâ‡∏≠‡∏á 01"
            required
          />
          <span class="small" data-room-brief>‡∏à‡∏∏‡∏î 0 ‚Ä¢ ‡∏ä‡∏∏‡∏î 0 ‚Ä¢ ‡∏£‡∏≤‡∏Ñ‡∏≤ 0 ‡∏ö‡∏≤‡∏ó</span>
          <button
            type="button"
            class="btn btn-icon"
            data-act="dup-room"
            title="‡∏Å‡πá‡∏≠‡∏õ‡∏´‡πâ‡∏≠‡∏á"
          >
            ‚ßâ
          </button>
          <span class="sp"></span>
          <button
            type="button"
            class="btn btn-icon btn-danger"
            data-act="del-room"
            title="‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á"
          >
            ‚úï
          </button>
        </summary>

        <div class="row three-col">
          <div>
            <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ú‡πâ‡∏≤ (‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏ï‡∏£)</label>
            <select class="field" name="price_per_m" required>
              <option value="" hidden>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>
              <option value="1000">1,000</option>
              <option value="1200">1,200</option>
              <option value="1300">1,300</option>
              <option value="1400">1,400</option>
              <option value="1500">1,500</option>
              <option value="1600">1,600</option>
              <option value="1700">1,700</option>
              <option value="1800">1,800</option>
              <option value="1900">1,900</option>
              <option value="2000">2,000</option>
              <option value="2100">2,100</option>
              <option value="2200">2,200</option>
              <option value="2300">2,300</option>
              <option value="2400">2,400</option>
              <option value="2500">2,500</option>
            </select>
          </div>
          <div>
            <label>‡∏™‡πÑ‡∏ï‡∏•‡πå</label>
            <select class="field" name="style" required>
              <option value="" hidden>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>
              <option>‡∏•‡∏≠‡∏ô</option>
              <option>‡∏ï‡∏≤‡πÑ‡∏Å‡πà</option>
              <option>‡∏à‡∏µ‡∏ö</option>
            </select>
          </div>
          <div>
            <label>‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πâ‡∏≤</label>
            <select class="field" name="open_type" required>
              <option value="" hidden>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>
              <option>‡πÅ‡∏¢‡∏Å‡∏Å‡∏•‡∏≤‡∏á</option>
              <option>‡∏™‡πÑ‡∏•‡∏î‡πå‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß</option>
            </select>
          </div>
        </div>
        
        <div data-sets></div>

        <div class="total">
          <div class="small">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ</div>
          <button type="button" class="btn btn-xs" data-act="add-set">
            + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∏‡∏î
          </button>
          <div class="price" data-room-total>0 ‡∏ö‡∏≤‡∏ó</div>
        </div>
      </details>
    </template>

    <template id="setTpl">
      <div class="card set" data-set>
        <div class="room-head" style="margin-bottom: 4px">
          <strong data-set-title>‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 01</strong>
          <span class="small" data-set-units>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô 0 ‡∏ä‡∏∏‡∏î</span>
          <button
            type="button"
            class="btn btn-icon"
            data-act="dup-set"
            title="‡∏Å‡πá‡∏≠‡∏õ‡∏à‡∏∏‡∏î"
          >
            ‚ßâ
          </button>
          <span class="sp"></span>
          <button type="button" class="btn btn-xs" data-act="clear-set">
            clear
          </button>
          <button
            type="button"
            class="btn btn-icon btn-danger"
            data-act="del-set"
            title="‡∏•‡∏ö‡∏ä‡∏∏‡∏î"
          >
            ‚àí
          </button>
        </div>
        <div class="row">
          <div>
            <label>‡∏Å‡∏ß‡πâ‡∏≤‡∏á (‡∏°.)</label>
            <input
              class="field"
              name="width_m"
              type="number"
              step="0.01"
              min="0"
              inputmode="decimal"
              placeholder="‡πÄ‡∏ä‡πà‡∏ô 3.50"
              required
              autocomplete="off"
            />
          </div>
          <div>
            <label>‡∏™‡∏π‡∏á (‡∏°.)</label>
            <input
              class="field"
              name="height_m"
              type="number"
              step="0.01"
              min="0"
              inputmode="decimal"
              placeholder="‡πÄ‡∏ä‡πà‡∏ô 2.80"
              required
              autocomplete="off"
            />
          </div>
        </div>
        <div class="row">
          <div>
            <label>‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ</label>
            <select class="field" name="fabric_variant">
              <option>‡∏ó‡∏∂‡∏ö</option>
              <option>‡πÇ‡∏õ‡∏£‡πà‡∏á</option>
              <option>‡∏ó‡∏∂‡∏ö&‡πÇ‡∏õ‡∏£‡πà‡∏á</option>
            </select>
          </div>
          <div data-sheer-wrap class="hidden">
            <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ú‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡πà‡∏á (‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏ï‡∏£)</label>
            <select class="field" name="sheer_price_per_m">
              <option value="" hidden>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>
              <option value="1000">1,000</option>
              <option value="1100">1,100</option>
              <option value="1200">1,200</option>
              <option value="1300">1,300</option>
              <option value="1400">1,400</option>
              <option value="1500">1,500</option>
            </select>
          </div>
        </div>
        <div class="small" style="margin-top: 8px">
          <span data-opaque-price-label>‡∏ó‡∏∂‡∏ö: <span class="price" data-set-price-opaque>0</span> ‡∏ö‡∏≤‡∏ó</span>
          <span data-sheer-price-label class="hidden"> ‚Ä¢ ‡πÇ‡∏õ‡∏£‡πà‡∏á: <span class="price" data-set-price-sheer>0</span> ‡∏ö‡∏≤‡∏ó</span>
          <span data-opaque-yardage-label> ‚Ä¢ ‡∏ó‡∏∂‡∏ö: <span class="price" data-set-yardage-opaque>0</span> ‡∏´‡∏•‡∏≤</span>
          <span data-sheer-yardage-label class="hidden"> ‚Ä¢ ‡πÇ‡∏õ‡∏£‡πà‡∏á: <span class="price" data-set-yardage-sheer>0</span> ‡∏´‡∏•‡∏≤</span>
          <span data-track-label> ‚Ä¢ ‡∏£‡∏≤‡∏á: <span class="price" data-set-track>0</span> ‡∏°.</span>
        </div>
      </div>
    </template>

    <script>
      const APP_VERSION = "input-ui/2025-08-19-r26";
      const WEBHOOK_URL =
        "https://hook.eu2.make.com/xul3fhuh96ybgfm2omdt2e74ejybxjoj";
      const STORAGE_KEY = "marnthara.input.v1";

      const PRICING = {
        style_surcharge: { ‡∏•‡∏≠‡∏ô: 200, ‡∏ï‡∏≤‡πÑ‡∏Å‡πà: 0, ‡∏à‡∏µ‡∏ö: 0 },
        height: { threshold: 2.5, add_per_m: 150 },
      };
      const CALC = {
        fabricYardage: (style, width) => {
          let yards = 0;
          if (width > 0) {
            if (style === "‡∏ï‡∏≤‡πÑ‡∏Å‡πà" || style === "‡∏à‡∏µ‡∏ö") {
              yards = (width * 2.0 + 0.6) / 0.9;
            } else if (style === "‡∏•‡∏≠‡∏ô") {
              yards = (width * 2.6 + 0.6) / 0.9;
            }
          }
          return yards > 0 ? yards : 0;
        },
      };

      const stylePlus = (s) => PRICING.style_surcharge[s] ?? 0;
      const heightPlus = (h) =>
        h > PRICING.height.threshold ? PRICING.height.add_per_m : 0;

      const roomsEl = document.getElementById("rooms");
      const orderForm = document.getElementById("orderForm");
      orderForm.action = WEBHOOK_URL;

      const copyBtn = document.getElementById("copyJsonBtn");
      const addRoomBtn = document.getElementById("addRoomBtn");
      const saveStateBtn = document.getElementById("saveStateBtn");
      const loadStateBtn = document.getElementById("loadStateBtn");
      const clearAllBtn = document.getElementById("clearAllBtn");
      
      let roomCount = 0;

      function toNum(v) {
        const n = parseFloat(v);
        return Number.isFinite(n) ? n : 0;
      }
      function clamp01(n) {
        return Math.max(0, toNum(n));
      }
      function fmt(n, fixed = 2, asCurrency = false) {
        if (Number.isFinite(n)) {
          if (asCurrency) {
            return n.toLocaleString("th-TH", { minimumFractionDigits: 0, maximumFractionDigits: 0 });
          } else {
            return n.toFixed(fixed).toLocaleString("th-TH");
          }
        }
        return n.toLocaleString("th-TH");
      }
      function debounce(fn, ms = 120) {
        let t;
        return (...a) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...a), ms);
        };
      }
      function addRoom(prefill) {
        roomCount++;
        const frag = document.getElementById("roomTpl").content.cloneNode(true);
        const room = frag.querySelector("[data-room]");
        room.dataset.index = roomCount;
        const bg = ["var(--room1)", "var(--room2)", "var(--room3)"][
          (roomCount - 1) % 3
        ];
        room.style.background = bg;
        roomsEl.appendChild(frag);
        const created = roomsEl.querySelector("[data-room]:last-of-type");
        
        updateToggleBtnText(created.querySelector('[data-act="toggle-room"]'));

        if (prefill) {
          created.querySelector('input[name="room_name"]').value =
            prefill.room_name || "";
          created.querySelector('select[name="price_per_m"]').value =
            prefill.price_per_m_raw || "";
          created.querySelector('select[name="style"]').value =
            prefill.style || "";
          created.querySelector('select[name="open_type"]').value =
            prefill.open_type || "";
        }

        if (prefill && prefill.sets && prefill.sets.length) {
          prefill.sets.forEach((s) => addSet(created, s));
        } else {
          addSet(created);
        }

        renumber();
        recalcAll();
      }

      function addSet(roomEl, prefill) {
        const setsWrap = roomEl.querySelector("[data-sets]");
        const frag = document.getElementById("setTpl").content.cloneNode(true);
        setsWrap.appendChild(frag);
        const created = setsWrap.querySelector("[data-set]:last-of-type");

        const mapDefault = (v) => v || "‡∏ó‡∏∂‡∏ö";

        const fvSel = created.querySelector('select[name="fabric_variant"]');
        fvSel.value = prefill?.fabric_variant || "‡∏ó‡∏∂‡∏ö";

        if (prefill) {
          created.querySelector('input[name="width_m"]').value =
            prefill.width_m ?? "";
          created.querySelector('input[name="height_m"]').value =
            prefill.height_m ?? "";
          created.querySelector('select[name="sheer_price_per_m"]').value =
            prefill.sheer_price_per_m || "";
        }

        toggleSetFabricUI(created);
        renumber();
        recalcAll();
      }

      function toggleSetFabricUI(set) {
        const variant = set.querySelector(
          'select[name="fabric_variant"]'
        ).value;
        const hasSheer = variant === "‡πÇ‡∏õ‡∏£‡πà‡∏á" || variant === "‡∏ó‡∏∂‡∏ö&‡πÇ‡∏õ‡∏£‡πà‡∏á";
        const hasOpaque = variant !== "‡πÇ‡∏õ‡∏£‡πà‡∏á";
        
        set.querySelector("[data-sheer-wrap]").classList.toggle("hidden", !hasSheer);
        set.querySelector("[data-sheer-price-label]").classList.toggle("hidden", !hasSheer);
        set.querySelector("[data-sheer-yardage-label]").classList.toggle("hidden", !hasSheer);

        set.querySelector("[data-opaque-price-label]").classList.toggle("hidden", !hasOpaque);
        set.querySelector("[data-opaque-yardage-label]").classList.toggle("hidden", !hasOpaque);
      }
      
      function updateToggleBtnText(btn) {
        const details = btn.closest("details");
        if (!details) return;
        const label = details.open ? btn.dataset.labelOpen : btn.dataset.labelClosed;
        btn.textContent = label;
      }

      function delRoom(btn) {
        btn.closest("[data-room]").remove();
        renumber();
        recalcAll();
      }

      function delSet(btn) {
        const room = btn.closest("[data-room]");
        btn.closest("[data-set]").remove();
        if (room.querySelectorAll("[data-set]").length === 0) addSet(room);
        renumber();
        recalcAll();
      }

      function dupRoom(btn) {
        const src = btn.closest("[data-room]");
        const data = serializeRoom(src);
        if (data.room_name) data.room_name = data.room_name + " (copy)";
        addRoom(data);
      }

      function dupSet(btn) {
        const set = btn.closest("[data-set]");
        const room = btn.closest("[data-room]");
        const data = serializeSet(
          set,
          room.querySelectorAll("[data-set]").length
        );
        addSet(room, data);
      }

      function clearSet(btn) {
        const set = btn.closest("[data-set]");
        set.querySelector('input[name="width_m"]').value = "";
        set.querySelector('input[name="height_m"]').value = "";
        const fvSel = set.querySelector('select[name="fabric_variant"]');
        if (fvSel) fvSel.value = "‡∏ó‡∏∂‡∏ö";
        const sheerSel = set.querySelector('select[name="sheer_price_per_m"]');
        if (sheerSel) sheerSel.value = "";
        toggleSetFabricUI(set);
        recalcAll();
      }

      function clearRoom(btn) {
        const room = btn.closest("[data-room]");
        room.querySelectorAll("select").forEach((sel) => (sel.value = ""));
        const wrap = room.querySelector("[data-sets]");
        wrap.innerHTML = "";
        addSet(room);
        recalcAll();
      }
      
      function clearAllData() {
        roomsEl.innerHTML = "";
        roomCount = 0;
        addRoom();
        localStorage.removeItem(STORAGE_KEY);
      }

      function renumber() {
        [...document.querySelectorAll("[data-room]")].forEach((room, rIdx) => {
          const input = room.querySelector('input[name="room_name"]');
          if (input && !input.value)
            input.placeholder = `‡∏´‡πâ‡∏≠‡∏á ${String(rIdx + 1).padStart(2, "0")}`;
          let setCount = 0;
          [...room.querySelectorAll("[data-set]")].forEach((set) => {
            setCount++;
            const lbl = set.querySelector("[data-set-title]");
            if (lbl)
              lbl.textContent = `‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà ${String(setCount).padStart(2, "0")}`;
          });
        });
      }

      function basePricePerMRaw(room) {
        return toNum(room.querySelector('select[name="price_per_m"]').value);
      }

      function recalcAll() {
        let grand = 0;
        let allSets = 0;
        let grandOpaqueYards = 0;
        let grandSheerYards = 0;
        let grandTrack = 0;

        [...document.querySelectorAll("[data-room]")].forEach((room) => {
          const baseRaw = basePricePerMRaw(room);
          const style = room.querySelector('select[name="style"]').value;
          const sPlus = stylePlus(style);

          let roomSum = 0;
          let roomUnits = 0;
          let roomOpaqueYards = 0;
          let roomSheerYards = 0;
          let roomTrack = 0;
          const points = room.querySelectorAll("[data-set]").length;

          room.querySelectorAll("[data-set]").forEach((set) => {
            const w = clamp01(set.querySelector('input[name="width_m"]').value);
            const h = clamp01(
              set.querySelector('input[name="height_m"]').value
            );
            const hPlus = heightPlus(h);
            const variant = set.querySelector(
              'select[name="fabric_variant"]'
            ).value;
            const hasOpaque = variant !== "‡πÇ‡∏õ‡∏£‡πà‡∏á";
            const hasSheer = variant !== "‡∏ó‡∏∂‡∏ö";
            const sheerBase = hasSheer
              ? clamp01(set.querySelector('[name="sheer_price_per_m"]').value)
              : 0;
            const opaquePerM = hasOpaque ? baseRaw + sPlus + hPlus : 0;
            const sheerPerM = hasSheer ? sheerBase + sPlus + hPlus : 0;
            const opaquePrice = Math.round(opaquePerM * w);
            const sheerPrice = Math.round(sheerPerM * w);
            const total = opaquePrice + sheerPrice;
            const units = (opaquePrice > 0 ? 1 : 0) + (sheerPrice > 0 ? 1 : 0);
            const yards = CALC.fabricYardage(style, w);
            const track = variant === "‡∏ó‡∏∂‡∏ö&‡πÇ‡∏õ‡∏£‡πà‡∏á" ? w * 2 : w;
            
            set.querySelector('[data-set-price-opaque]').textContent = fmt(opaquePrice, 0, true);
            set.querySelector('[data-set-price-sheer]').textContent = fmt(sheerPrice, 0, true);
            set.querySelector('[data-set-yardage-opaque]').textContent = fmt(yards, 2);
            set.querySelector('[data-set-yardage-sheer]').textContent = fmt(yards, 2);
            set.querySelector('[data-set-track]').textContent = fmt(track, 2);

            roomSum += total;
            roomUnits += units;
            if(hasOpaque) roomOpaqueYards += yards;
            if(hasSheer) roomSheerYards += yards;
            if (hasOpaque || hasSheer) roomTrack += track;
            allSets += units;
          });

          const rt = room.querySelector("[data-room-total]");
          if (rt) rt.textContent = fmt(roomSum, 0, true) + " ‡∏ö‡∏≤‡∏ó";

          const brief = room.querySelector("[data-room-brief]");
          if (brief) {
            brief.innerHTML = `‡∏à‡∏∏‡∏î <span class=\"num\">${fmt(points, 0, true)}</span> ‚Ä¢ ‡∏ä‡∏∏‡∏î <span class=\"num\">${fmt(roomUnits, 0, true)}</span> ‚Ä¢ ‡∏£‡∏≤‡∏Ñ‡∏≤ <span class=\"num price\">${fmt(roomSum, 0, true)}</span> ‡∏ö‡∏≤‡∏ó`;
          }

          grand += roomSum;
          grandOpaqueYards += roomOpaqueYards;
          grandSheerYards += roomSheerYards;
          grandTrack += roomTrack;
        });

        document.getElementById("grandTotal").textContent = fmt(grand, 0, true);
        document.getElementById("setCount").textContent = fmt(allSets, 0, true);
        document.getElementById("grandFabric").textContent = fmt(grandOpaqueYards, 2);
        document.getElementById("grandSheerFabric").textContent = fmt(grandSheerYards, 2);
        document.getElementById("grandTrack").textContent = fmt(grandTrack, 2);
      }

      function serializeSet(set, idx = 0) {
        const width = clamp01(set.querySelector('input[name="width_m"]').value);
        const height = clamp01(
          set.querySelector('input[name="height_m"]').value
        );
        const fabric_variant = set.querySelector(
          'select[name="fabric_variant"]'
        ).value;
        const hasOpaque = fabric_variant !== "‡πÇ‡∏õ‡∏£‡πà‡∏á";
        const hasSheer = fabric_variant !== "‡∏ó‡∏∂‡∏ö";
        const sheer_price_per_m = hasSheer
          ? clamp01(set.querySelector('[name="sheer_price_per_m"]').value)
          : 0;
        const room = set.closest("[data-room]");
        const style = room.querySelector('select[name="style"]').value;
        const yards = CALC.fabricYardage(style, width);
        const track = fabric_variant === "‡∏ó‡∏∂‡∏ö&‡πÇ‡∏õ‡∏£‡πà‡∏á" ? width * 2 : width;

        return {
          point_idx: idx + 1,
          width_m: width,
          height_m: height,
          fabric_variant,
          sheer_price_per_m,
          fabric_yards_opaque: hasOpaque ? yards : 0,
          fabric_yards_sheer: hasSheer ? yards : 0,
          track_m: track,
        };
      }

      function serializeRoom(room) {
        const ppmRaw = basePricePerMRaw(room);
        const style = room.querySelector('select[name="style"]').value;
        const sPlus2 = stylePlus(style);
        return {
          room_id: Number(room.dataset.index) || null,
          room_name: room.querySelector('input[name="room_name"]').value || "",
          price_per_m_raw: ppmRaw,
          price_per_m: ppmRaw + sPlus2,
          style,
          open_type: room.querySelector('select[name="open_type"]').value || "",
          sets: [...room.querySelectorAll("[data-set]")].map((set, i) =>
            serializeSet(set, i)
          ),
        };
      }

      function buildPayload() {
        const roomsData = [];
        let totalTHB = 0;
        let allSets = 0;
        let totalOpaqueYards = 0;
        let totalSheerYards = 0;
        let totalTrack = 0;

        document.querySelectorAll("[data-room]").forEach((room) => {
          const baseRaw = basePricePerMRaw(room);
          const style = room.querySelector('select[name="style"]').value;
          const sPlus = stylePlus(style);
          const roomObj = serializeRoom(room);
          roomObj.sets = [];

          room.querySelectorAll("[data-set]").forEach((set, i) => {
            const w = clamp01(set.querySelector('input[name="width_m"]').value);
            const h = clamp01(
              set.querySelector('input[name="height_m"]').value
            );
            const hPlus = heightPlus(h);
            const variant = set.querySelector(
              'select[name="fabric_variant"]'
            ).value;
            const hasOpaque = variant !== "‡πÇ‡∏õ‡∏£‡πà‡∏á";
            const hasSheer = variant !== "‡∏ó‡∏∂‡∏ö";
            const sheerBase = hasSheer
              ? clamp01(set.querySelector('[name="sheer_price_per_m"]').value)
              : 0;
            const opaquePerM = hasOpaque ? baseRaw + sPlus + hPlus : 0;
            const sheerPerM = hasSheer ? sheerBase + sPlus + hPlus : 0;
            const price_opaque = Math.round(opaquePerM * w);
            const price_sheer = Math.round(sheerPerM * w);
            const price = price_opaque + price_sheer;
            const units = (price_opaque > 0 ? 1 : 0) + (price_sheer > 0 ? 1 : 0);
            const yards = CALC.fabricYardage(style, w);
            const track = variant === "‡∏ó‡∏∂‡∏ö&‡πÇ‡∏õ‡∏£‡πà‡∏á" ? w * 2 : w;

            roomObj.sets.push({
              point_idx: i + 1,
              width_m: w,
              height_m: h,
              fabric_variant: variant,
              price_per_m_opaque: opaquePerM,
              price_per_m_sheer: sheerPerM,
              price_opaque,
              price_sheer,
              price,
              units,
              fabric_yards_opaque: hasOpaque ? yards : 0,
              fabric_yards_sheer: hasSheer ? yards : 0,
              track_m: track
            });

            totalTHB += price;
            allSets += units;
            if(hasOpaque) totalOpaqueYards += yards;
            if(hasSheer) totalSheerYards += yards;
            if (hasOpaque || hasSheer) totalTrack += track;
          });

          roomsData.push(roomObj);
        });

        return {
          app_version: APP_VERSION,
          generated_at: new Date().toISOString(),
          total_thb: totalTHB,
          total_sets: allSets,
          total_yards: totalOpaqueYards + totalSheerYards,
          total_opaque_yards: totalOpaqueYards,
          total_sheer_yards: totalSheerYards,
          total_track_m: totalTrack,
          rooms: roomsData,
        };
      }

      function saveState() {
        const state = {
          rooms: [...document.querySelectorAll("[data-room]")].map(
            serializeRoom
          ),
        };
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
          alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!");
        } catch (e) {
          alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ");
        }
      }

      function loadState() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) {
            alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ!");
            return false;
          }
          const state = JSON.parse(raw);
          if (!state || !Array.isArray(state.rooms) || state.rooms.length === 0) {
            alert("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!");
            return false;
          }
          roomsEl.innerHTML = "";
          roomCount = 0;
          state.rooms.forEach((r) => addRoom(r));
          recalcAll();
          alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!");
          return true;
        } catch (e) {
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•!");
          return false;
        }
      }

      const recalcSoon = debounce(recalcAll, 50);

      addRoomBtn.addEventListener("click", () => {
        addRoom();
        recalcAll();
      });

      saveStateBtn.addEventListener("click", saveState);
      loadStateBtn.addEventListener("click", loadState);
      clearAllBtn.addEventListener("click", () => {
        let ok = confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?");
        if (ok) {
            clearAllData();
            alert("‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß!");
        }
      });

      document.addEventListener("click", (e) => {
        const b = e.target.closest("[data-act]");
        if (!b) return;
        e.preventDefault();
        e.stopPropagation();
        const act = b.dataset.act;
        if (act === "add-set") {
          addSet(b.closest("[data-room]"));
          recalcAll();
        }
        if (act === "del-room") {
          let ok = true;
          try {
            ok = confirm("‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?");
          } catch (e) { ok = true; }
          if (!ok) return;
          delRoom(b);
        }
        if (act === "del-set") {
          let ok = true;
          try {
            ok = confirm("‡∏•‡∏ö‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ?");
          } catch (e) { ok = true; }
          if (!ok) return;
          delSet(b);
        }
        if (act === "dup-room") {
          dupRoom(b);
          recalcAll();
        }
        if (act === "dup-set") {
          dupSet(b);
          recalcAll();
        }
        if (act === "clear-set") {
          let ok = true;
          try {
            ok = confirm("‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ?");
          } catch (e) { ok = true; }
          if (!ok) return;
          clearSet(b);
        }
        if (act === "clear-room") {
          let ok = true;
          try {
            ok = confirm("‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ?");
          } catch (e) { ok = true; }
          if (!ok) return;
          clearRoom(b);
        }
        if (act === "toggle-room") {
          const d = b.closest("details");
          if (d) {
            d.open = !d.open;
            updateToggleBtnText(b);
          }
          recalcAll();
        }
      });
      
      document.addEventListener('toggle', (e) => {
        const btn = e.target.querySelector('[data-act="toggle-room"]');
        if (btn) {
          updateToggleBtnText(btn);
        }
      });

      document.addEventListener("input", (e) => {
        if (
          e.target.matches(
            'input[name="width_m"], input[name="height_m"], select[name="price_per_m"], select[name="style"], select[name="sheer_price_per_m"], input[name="room_name"], select[name="fabric_variant"]'
          )
        ) {
          if (e.target.name === "fabric_variant")
            toggleSetFabricUI(e.target.closest("[data-set]"));
          recalcSoon();
        }
      });

      document.addEventListener("change", (e) => {
        if (
          e.target.matches('select[name="open_type"]')
        ) {
          recalcAll();
        }
      });

      copyBtn.addEventListener("click", () => {
        const payload = buildPayload();
        const str = JSON.stringify(payload, null, 2);
        navigator.clipboard
          ?.writeText(str)
          .then(() => alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å JSON ‡πÅ‡∏•‡πâ‡∏ß"));
      });

      // Initial setup
      if (localStorage.getItem(STORAGE_KEY) === null) {
          addRoom();
      } else {
          loadState();
      }
      recalcAll();

      orderForm.addEventListener("submit", (e) => {
        const payload = buildPayload();
        document.getElementById("payload").value = JSON.stringify(payload);

        if (WEBHOOK_URL.includes("PUT-YOUR-HOOK-HERE")) {
          e.preventDefault();
          alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á Webhook URL ‡∏Ç‡∏≠‡∏á Make");
          return;
        }
      });
    </script>
  </body>
</html>