<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Marnthara Input</title>
<style>
:root{--bg:#111215;--fg:#e7e7ea;--line:#2f2f33;--muted:#b8b8bf;--danger:#ff5a5f;--primary:#3a82f7;--secondary:#2ebd85;}
*{box-sizing:border-box}
body{margin:0;padding:16px;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Arial}
h1{font-size:18px;margin:0 0 12px}
.card{border:1px solid var(--line);border-radius:14px;padding:12px;margin:12px 0;background:#1a1b20}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
label{font-size:12px;color:var(--muted);display:block;margin:6px 0 4px}
.field{width:100%;padding:.55rem .7rem;border:1px solid var(--line);border-radius:.6rem;background:#000;color:inherit}
.small{font-size:12px;color:var(--muted)}
.price{font-weight:600;color:var(--secondary)}
.room-head{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.room-head .sp{flex:1}
.btn{display:inline-flex;align-items:center;gap:.35rem;border:1px solid var(--line);background:transparent;color:var(--primary);border-radius:.5rem;font-weight:500;transition:opacity .15s ease;cursor:pointer}
.btn:hover{opacity:.85}
.btn-xs{padding:.2rem .45rem;font-size:.85rem;line-height:1.1}
.btn-icon{width:1.8rem;height:1.8rem;padding:0;display:inline-grid;place-items:center}
.btn-danger{border-color:var(--danger);color:var(--danger)}
.actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
.total{border-top:1px solid var(--line);padding-top:10px;margin-top:12px;display:flex;justify-content:space-between;align-items:center}
.hidden{display:none}
</style>
</head>
<body>
<h1>สั่งงานม่าน</h1>

<form id="orderForm" method="post" target="hiddenFrame">
  <input type="hidden" name="payload" id="payload">
  <div id="rooms"></div>

  <div class="actions">
    <button type="button" class="btn btn-xs" id="addRoomBtn">+ เพิ่มห้อง</button>
  </div>

  <div class="total">
    <div class="small">ราคารวม</div>
    <div id="grandTotal" class="price">0 บาท</div>
  </div>

  <div class="total">
    <div class="small">จำนวนชุดทั้งหมด</div>
    <div id="setCount" class="price">0 ชุด</div>
  </div>

  <div class="actions">
    <button type="submit" class="btn btn-xs">ส่งไปคำนวณ</button>
  </div>
</form>

<iframe name="hiddenFrame" class="hidden"></iframe>

<template id="roomTpl">
  <div class="card room" data-room>
    <div class="room-head">
      <label class="small" style="margin:0">ห้อง</label>
      <input class="field" type="text" name="room_name" placeholder="เช่น ห้อง 01" required>
      <span class="sp"></span>
      <button type="button" class="btn btn-icon btn-danger" data-act="del-room" title="ลบห้อง">✕</button>
    </div>

    <div class="row">
      <div>
        <label>ราคาผ้า (ต่อเมตร)</label>
        <select class="field" name="price_per_m" required>
          <option value="" hidden>เลือก</option>
          <option value="1000">1,000</option>
          <option value="1200">1,200</option>
          <option value="1300">1,300</option>
          <option value="1400">1,400</option>
          <option value="1500">1,500</option>
          <option value="1600">1,600</option>
          <option value="1700">1,700</option>
          <option value="1800">1,800</option>
          <option value="1900">1,900</option>
          <option value="2000">2,000</option>
          <option value="2100">2,100</option>
          <option value="2200">2,200</option>
          <option value="2300">2,300</option>
          <option value="2400">2,400</option>
          <option value="2500">2,500</option>
        </select>
      </div>
      <div>
        <label>สไตล์</label>
        <select class="field" name="style" required>
          <option value="" hidden>เลือก</option>
          <option>ลอน</option><option>ตาไก่</option><option>จีบ</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>ผ้า</label>
        <select class="field" name="fabric" required>
          <option value="" hidden>เลือก</option>
          <option>ทึบ</option><option>โปร่ง</option>
        </select>
      </div>
      <div>
        <label>รูปแบบเปิดผ้า</label>
        <select class="field" name="open_type" required>
          <option value="" hidden>เลือก</option>
          <option>แยกกลาง</option><option>สไลด์เดี่ยว</option>
        </select>
      </div>
    </div>

    <div data-sets></div>

    <div class="actions">
      <button type="button" class="btn btn-xs" data-act="add-set">+ เพิ่มชุด</button>
    </div>

    <div class="total">
      <div class="small">ราคารวมของห้องนี้</div>
      <div class="price" data-room-total>0 บาท</div>
    </div>
  </div>
</template>

<template id="setTpl">
  <div class="card set" data-set>
    <div class="room-head" style="margin-bottom:4px">
      <strong data-set-title>ชุดที่ 01</strong>
      <span class="sp"></span>
      <button type="button" class="btn btn-icon btn-danger" data-act="del-set" title="ลบชุด">−</button>
    </div>
    <div class="row">
      <div>
        <label>กว้าง (ม.)</label>
        <input class="field" name="width_m" type="number" step="0.01" inputmode="decimal" placeholder="เช่น 3.50" required>
      </div>
      <div>
        <label>สูง (ม.)</label>
        <input class="field" name="height_m" type="number" step="0.01" inputmode="decimal" placeholder="เช่น 2.80" required>
      </div>
    </div>
    <div class="small" style="margin-top:8px">
      สูตร: ราคา/ม. × ความกว้าง  →  ราคาชุดนี้: <span class="price" data-set-price>0</span> บาท
    </div>
  </div>
</template>

<script>
const WEBHOOK_URL = "https://hook.eu2.make.com/xul3fhuh96ybgfm2omdt2e74ejybxjoj";
const roomsEl = document.getElementById('rooms');
const orderForm = document.getElementById('orderForm');
orderForm.action = WEBHOOK_URL;

let roomCount = 0;

function toNum(v){
  const n = parseFloat(v);
  return Number.isFinite(n) ? n : 0;
}

function addRoom() {
  roomCount++;
  const frag = document.getElementById('roomTpl').content.cloneNode(true);
  const room = frag.querySelector('[data-room]');
  room.dataset.index = roomCount;
  roomsEl.appendChild(frag);
  addSet(roomsEl.querySelector('[data-room]:last-of-type'));
  renumber(); recalcAll();
}

function addSet(roomEl) {
  const setsWrap = roomEl.querySelector('[data-sets]');
  const frag = document.getElementById('setTpl').content.cloneNode(true);
  setsWrap.appendChild(frag);
  renumber();
  recalcAll();
}

function delRoom(btn) {
  btn.closest('[data-room]').remove();
  renumber(); recalcAll();
}

function delSet(btn) {
  const room = btn.closest('[data-room]');
  btn.closest('[data-set]').remove();
  if (room.querySelectorAll('[data-set]').length === 0) addSet(room);
  renumber(); recalcAll();
}

function renumber() {
  [...document.querySelectorAll('[data-room]')].forEach((room, rIdx) => {
    const input = room.querySelector('input[name="room_name"]');
    if (input) input.placeholder = `ห้อง ${String(rIdx+1).padStart(2,'0')}`;
    let setCount = 0;
    [...room.querySelectorAll('[data-set]')].forEach((set) => {
      setCount++;
      const lbl = set.querySelector('[data-set-title]');
      if (lbl) lbl.textContent = `ชุดที่ ${String(setCount).padStart(2,'0')}`;
    });
  });
}

function recalcAll(){
  let grand = 0;
  let allSets = 0;
  [...document.querySelectorAll('[data-room]')].forEach(room=>{
    let pricePerM = toNum(room.querySelector('select[name="price_per_m"]').value);
    const style = room.querySelector('select[name="style"]').value;
    if(style === 'ลอน'){
      pricePerM += 300;
    }
    let roomSum = 0;
    room.querySelectorAll('[data-set]').forEach(set=>{
      const w = toNum(set.querySelector('input[name="width_m"]').value);
      const setPrice = Math.round(pricePerM * w);
      set.querySelector('[data-set-price]').textContent = setPrice.toLocaleString('th-TH');
      roomSum += setPrice;
      if(setPrice > 0){
        allSets++;
      }
    });
    room.querySelector('[data-room-total]').textContent = roomSum.toLocaleString('th-TH')+' บาท';
    grand += roomSum;
  });
  document.getElementById('grandTotal').textContent = grand.toLocaleString('th-TH')+' บาท';
  document.getElementById('setCount').textContent = allSets.toLocaleString('th-TH')+' ชุด';
}

document.getElementById('addRoomBtn').addEventListener('click', addRoom);

document.addEventListener('click', e=>{
  const b = e.target.closest('[data-act]');
  if(!b) return;
  const act = b.dataset.act;
  if(act==='add-set') addSet(b.closest('[data-room]'));
  if(act==='del-room') delRoom(b);
  if(act==='del-set') delSet(b);
});

document.addEventListener('input', e=>{
  if(e.target.matches('input[name="width_m"], select[name="price_per_m"], select[name="style"]')) recalcAll();
});

addRoom();

orderForm.addEventListener('submit', (e)=>{
  if (WEBHOOK_URL.includes('PUT-YOUR-HOOK-HERE')) {
    e.preventDefault();
    alert('ยังไม่ได้ตั้ง Webhook URL ของ Make');
    return;
  }

  const roomsData = [];
  let totalTHB = 0;
  let allSets = 0;

  document.querySelectorAll('[data-room]').forEach(room=>{
    let pricePerM = toNum(room.querySelector('select[name="price_per_m"]').value);
    const style = room.querySelector('select[name="style"]').value;
    if(style === 'ลอน'){
      pricePerM += 300;
    }
    const roomObj = {
      room_name: room.querySelector('input[name="room_name"]').value || '',
      price_per_m: pricePerM,
      style: style,
      fabric: room.querySelector('select[name="fabric"]').value || '',
      open_type: room.querySelector('select[name="open_type"]').value || '',
      sets: []
    };

    room.querySelectorAll('[data-set]').forEach((set)=>{
      const w = toNum(set.querySelector('input[name="width_m"]').value);
      const h = toNum(set.querySelector('input[name="height_m"]').value);
      const price = Math.round(pricePerM * w);
      roomObj.sets.push({ width_m: w, height_m: h, price });
      totalTHB += price;
      if(price > 0){
        allSets++;
      }
    });

    roomsData.push(roomObj);
  });

  const payload = { total_thb: totalTHB, total_sets: allSets, rooms: roomsData };
  document.getElementById('payload').value = JSON.stringify(payload);
});
</script>
</body>
</html>
