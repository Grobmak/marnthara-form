<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Marnthara Input (v3.2)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- Variable & Base Style --- */
        :root {
            --bg: #0d0e12; --card-bg: #1a1b20; --fg: #e7e7ea;
            --line: #2f2f33; --muted: #b8b8bf; --danger: #ff5a5f;
            --primary: #5a7dff; --secondary: #4caf50; --warning: #ffc107;
            --room1-bg: #1a1b20; --room2-bg: #20222a; --room3-bg: #252830;
            --accent-dark: #2f2f33;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0; padding: 16px 16px 80px 16px; background: var(--bg);
            color: var(--fg); font-family: system-ui, Segoe UI, Roboto, Arial; line-height: 1.5;
        }
        h1 { font-size: 1.2rem; margin: 0; padding: 0; }
        /* --- Card & Layouts --- */
        .card { border: 1px solid var(--line); border-radius: 14px; padding: 12px; margin: 12px 0; background: var(--card-bg); }
        .room { border: 1px solid var(--primary); margin-bottom: 24px; transition: background-color 0.3s ease; }
        .room:nth-of-type(3n + 1) { background-color: var(--room1-bg); }
        .room:nth-of-type(3n + 2) { background-color: var(--room2-bg); }
        .room:nth-of-type(3n + 3) { background-color: var(--room3-bg); }
        .room > summary { padding: 12px; background: var(--accent-dark); border-radius: 12px 12px 0 0; margin: -12px; margin-bottom: 0; cursor: pointer; }
        .room > div, .room > .total { padding-top: 12px; }
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .row.three-col { grid-template-columns: repeat(3, 1fr); }
        .row.five-col { grid-template-columns: 2fr 1fr 1fr 1.5fr auto; align-items: end;}
        .row.deco-row { grid-template-columns: repeat(4, 1fr) auto; align-items: end; }
        /* --- Form Elements --- */
        label { font-size: 0.8rem; color: var(--muted); display: block; margin-bottom: 4px; }
        label.required::after { content: " *"; color: var(--danger); font-weight: bold; }
        .field {
            width: 100%; padding: 0.65rem 0.8rem; border: 1px solid var(--line); border-radius: 0.6rem;
            background: #000; color: inherit; appearance: none; font-size: 1rem;
        }
        .field:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(90, 125, 255, 0.2); }
        /* --- Text & Price --- */
        .small { font-size: 0.8rem; color: var(--muted); }
        .price { font-weight: 600; color: var(--secondary); }
        /* --- Buttons --- */
        .btn {
            display: inline-flex; align-items: center; gap: 0.35rem; border: 1px solid var(--line); background: transparent;
            color: var(--primary); border-radius: 0.5rem; font-weight: 500;
            transition: opacity 0.15s ease, transform 0.1s ease, background-color 0.2s; cursor: pointer; font-size: 0.9rem;
        }
        .btn:hover { opacity: 0.85; }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-xs { padding: 0.35rem 0.75rem; font-size: 0.8rem; line-height: 1; }
        .btn-icon { width: 2rem; height: 2rem; padding: 0; display: inline-grid; place-items: center; }
        .btn-danger { border-color: var(--danger); color: var(--danger); }
        .btn-primary { background: var(--primary); border-color: var(--primary); color: white; }
        .btn-primary.outline { background: transparent; color: var(--primary); }
        .btn-warning { border-color: var(--warning); color: var(--warning); }
        /* --- Layouts & Containers --- */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; gap: 8px; }
        .actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px; position: relative; }
        .total { border-top: 1px solid var(--line); padding-top: 16px; margin-top: 16px; display: flex; justify-content: space-between; align-items: center; font-size: 1.2rem; font-weight: 600; }
        .hidden { display: none !important; }
        .room-head { display: flex; gap: 12px; align-items: center; }
        .room-head input { flex: 1 1 180px; min-width: 120px; }
        .room-head [data-room-brief] { flex-shrink: 0; margin-left: auto; }
        /* --- Custom Components --- */
        .set, .deco-item { background: #0d0e12; border: 1px solid #2f2f33; margin-bottom: 12px; border-radius: 12px; padding: 12px; transition: opacity 0.3s, border-color 0.3s; }
        .set { border-left: 3px solid var(--primary); }
        .deco-item { border-left: 3px solid var(--secondary); }
        .set.is-suspended, .deco-item.is-suspended { opacity: 0.5; border-left-color: var(--muted); }
        .item-head { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--line); }
        .item-badge { font-size: 1rem; font-weight: bold; background: var(--primary); color: #fff; border: none; border-radius: 99px; width: 30px; height: 30px; display: inline-flex; align-items: center; justify-content: center; line-height: 1; flex-shrink: 0; }
        /* Updated sticky footer layout */
        .sticky-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--accent-dark); border-top: 1px solid var(--line); padding: 12px 16px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; z-index: 1000; }
        .sticky-footer .summary-item { text-align: center; }
        .sticky-footer .summary-label { font-size: 0.7rem; color: var(--muted); margin-bottom: 4px; }
        .sticky-footer .summary-value { font-weight: 600; font-size: 1rem; color: var(--primary); }
        .sticky-footer .summary-value.price { color: var(--secondary); }
        /* --- Details & Summary --- */
        details.room > summary { list-style: none; }
        details.room > summary::-webkit-details-marker { display: none; }
        [data-room-brief] { display: inline-block; padding: 0.2rem 0.5rem; border: 1px solid var(--line); border-radius: 0.5rem; background: #0d0e12; color: var(--muted); }
        [data-room-brief] .num { color: var(--primary); font-weight: 600; }
        [data-room-brief] .num.price { color: var(--secondary); }
        /* --- Confirmation Modal --- */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 2000; opacity: 0; transition: opacity 0.2s ease-in-out; pointer-events: none; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal { background: var(--card-bg); border-radius: 14px; padding: 24px; border: 1px solid var(--line); width: 90%; max-width: 400px; transform: scale(0.95); transition: transform 0.2s ease-in-out; }
        .modal-overlay.visible .modal { transform: scale(1); }
        .modal-title { font-size: 1.1rem; font-weight: 600; margin: 0 0 12px 0; }
        .modal-body { margin: 0 0 24px 0; color: var(--muted); }
        .modal-actions { display: flex; justify-content: flex-end; gap: 12px; }
        .summary-details > summary { display: inline-flex; align-items: center; padding: 0.35rem 0.75rem; font-size: 0.8rem; line-height: 1; gap: 0.35rem; border: 1px solid var(--line); background: transparent; color: var(--primary); border-radius: 0.5rem; font-weight: 500; cursor: pointer; }
        .summary-details > summary::-webkit-details-marker { display: none; }
        .summary-details[open] > summary {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }
        .summary-details > .summary-popup {
            position: absolute; right: 0; bottom: 100%; margin-bottom: -1px;
            background-color: var(--card-bg); border: 1px solid var(--line); border-radius: 8px 8px 0 0;
            padding: 12px; min-width: 180px; z-index: 1000;
        }
        .summary-details > .summary-popup > .summary-item { text-align: left; margin-bottom: 8px; }
        .summary-details > .summary-popup > .summary-item:last-child { margin-bottom: 0; }
        .actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px; position: relative; }

        /* Toast Notification Styles */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            font-size: 0.9rem;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast.toast-success {
            background-color: #d4edda; /* Light green background */
            color: #155724; /* Dark green text */
        }
        .toast.toast-warning {
            background-color: #fff3cd; /* Light yellow background */
            color: #856404; /* Dark yellow text */
        }
        .toast.toast-error {
            background-color: #f8d7da; /* Light red background */
            color: #721c24; /* Dark red text */
        }

        /* Copy Options Modal */
        .form-check {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .form-check-input {
            width: 1.2em;
            height: 1.2em;
        }
        .form-check-label {
            font-size: 1rem;
            color: var(--fg);
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Marnthara</h1>
        <button type="button" class="btn btn-xs btn-primary outline" id="addRoomHeaderBtn">+ เพิ่มห้อง</button>
        <span style="flex:1;"></span>
        <button type="button" class="btn btn-xs btn-primary" id="lockBtn"><span class="lock-text">ล็อค</span> <span class="lock-icon">🔒</span></button>
        <button type="button" class="btn btn-xs btn-danger" id="clearAllBtn">ล้างทั้งหมด 🗑️</button>
    </div>

    <form id="orderForm" method="post" target="hiddenFrame">
        <div class="card" id="customerInfo">
            <div class="row three-col">
                <div><label>ชื่อลูกค้า</label><input class="field" type="text" name="customer_name" placeholder="เช่น คุณสมชาย" /></div>
                <div><label>ที่อยู่</label><input class="field" type="text" name="customer_address" placeholder="เช่น 123/45 หมู่บ้าน..." /></div>
                <div><label>เบอร์โทร</label><input class="field" type="tel" name="customer_phone" placeholder="08xxxxxxxx" /></div>
            </div>
        </div>
        <input type="hidden" name="payload" id="payload" />
        <div id="rooms"></div>
        <div class="actions">
            <details class="summary-details">
                <summary>สรุปวัสดุ</summary>
                <div class="summary-popup">
                    <div class="summary-item"><div class="summary-label">ผ้าทึบที่ใช้</div><div class="summary-value price" id="grandFabric">0 หลา</div></div>
                    <div class="summary-item"><div class="summary-label">ผ้าโปร่งที่ใช้</div><div class="summary-value price" id="grandSheerFabric">0 หลา</div></div>
                    <div class="summary-item"><div class="summary-label">รางทึบที่ใช้</div><div class="summary-value price" id="grandOpaqueTrack">0 ม.</div></div>
                    <div class="summary-item"><div class="summary-label">รางโปร่งที่ใช้</div><div class="summary-value price" id="grandSheerTrack">0 ม.</div></div>
                </div>
            </details>
            <button type="button" class="btn btn-xs" id="copyJsonBtn">คัดลอก JSON</button>
            <button type="button" class="btn btn-xs btn-primary" id="copyTextBtn">คัดลอกข้อความ</button>
            <button type="submit" class="btn btn-xs btn-primary" id="submitBtn">ส่งไปคำนวณ</button>
        </div>
    </form>

    <div class="sticky-footer">
        <div class="summary-item"><div class="summary-label">ราคารวม</div><div class="summary-value price" id="grandTotal">0</div></div>
        <div class="summary-item"><div class="summary-label">จำนวนจุด</div><div class="summary-value" id="setCount">0</div></div>
        <div class="summary-item"><div class="summary-label">ผ้าม่าน(ชุด)</div><div class="summary-value" id="setCountSets">0</div></div>
        <div class="summary-item"><div class="summary-label">ตกแต่งเพิ่ม(ชุด)</div><div class="summary-value" id="setCountDeco">0</div></div>
    </div>

    <div id="toast-container" class="toast-container"></div>

    <iframe name="hiddenFrame" class="hidden"></iframe>

    <div id="confirmationModal" class="modal-overlay">
        <div class="modal">
            <h3 class="modal-title" id="modalTitle">ยืนยัน</h3><p class="modal-body" id="modalBody">คุณแน่ใจหรือไม่?</p>
            <div class="modal-actions">
                <button type="button" class="btn btn-xs" id="modalCancel">ยกเลิก</button>
                <button type="button" class="btn btn-xs btn-danger" id="modalConfirm">ยืนยัน</button>
            </div>
        </div>
    </div>

    <div id="copyOptionsModal" class="modal-overlay">
        <div class="modal">
            <h3 class="modal-title">เลือกข้อมูลที่ต้องการคัดลอก</h3>
            <div class="modal-body">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="copyCustomerInfo" checked>
                    <label class="form-check-label" for="copyCustomerInfo">ข้อมูลลูกค้า</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="copyRoomDetails" checked>
                    <label class="form-check-label" for="copyRoomDetails">รายละเอียดห้องและจุด</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="copySummary" checked>
                    <label class="form-check-label" for="copySummary">สรุปยอดรวม</label>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-xs" id="copyOptionsCancel">ยกเลิก</button>
                <button type="button" class="btn btn-xs btn-primary" id="copyOptionsConfirm">คัดลอก</button>
            </div>
        </div>
    </div>

    <template id="roomTpl">
        <details class="card room" data-room open>
            <summary class="room-head">
                <input class="field" type="text" name="room_name" placeholder="ห้อง 01" required />
                <span class="small" data-room-brief><span class="num">จุด 0</span> • <span class="num">ชุด 0</span> • ราคา <span class="num price">0</span> บาท</span>
                <button type="button" class="btn btn-icon btn-danger" data-act="del-room" title="ลบห้อง">✕</button>
            </summary>
            <div>
                <div class="row">
                    <div><label class="required">ราคาผ้า (ทึบ) (ต่อเมตร)</label><select class="field" name="room_price_per_m" required><option value="" hidden>เลือก</option></select></div>
                    <div><label class="required">สไตล์</label><select class="field" name="room_style" required><option value="" hidden>เลือก</option><option>ลอน</option><option>ตาไก่</option><option>จีบ</option></select></div>
                </div>
            </div>
            <div data-sets></div>
            <div data-decorations></div>
            <div class="total">
                <div class="room-actions">
                    <button type="button" class="btn btn-xs btn-primary outline" data-act="add-set">+ เพิ่มจุดผ้าม่าน</button>
                    <button type="button" class="btn btn-xs btn-secondary outline" data-act="add-deco" style="--primary: var(--secondary);">+ ตกแต่งเพิ่ม</button>
                </div>
            </div>
        </details>
    </template>

    <template id="setTpl">
        <div class="card set" data-set>
            <div class="item-head">
                <div class="item-badge" data-item-title></div>
                <button type="button" class="btn btn-xs btn-warning" data-act="toggle-suspend" style="--primary: var(--warning);"><span data-suspend-text>ระงับ</span></button>
                <span style="flex:1;"></span>
                <button type="button" class="btn btn-xs" data-act="clear-set">ล้าง</button>
                <button type="button" class="btn btn-icon btn-danger" data-act="del-set" title="ลบชุด">−</button>
            </div>
            <div class="row">
                <div><label class="required">กว้าง (ม.)</label><input class="field" name="width_m" type="number" step="0.01" min="0" required /></div>
                <div><label class="required">สูง (ม.)</label><input class="field" name="height_m" type="number" step="0.01" min="0" required /></div>
            </div>
            <div class="row" data-set-options-row>
                <div><label>รูปแบบเปิดผ้า</label><select class="field" name="open_type"><option value="" hidden>เลือก</option><option>แยกกลาง</option><option>สไลด์เดี่ยว</option></select></div>
                <div><label>ชนิดผ้าของจุดนี้</label><select class="field" name="fabric_variant"><option>ทึบ</option><option>โปร่ง</option><option>ทึบ&โปร่ง</option></select></div>
                <div data-sheer-wrap class="hidden"><label>ราคาผ้าโปร่ง </label><select class="field" name="sheer_price_per_m"><option value="" hidden>เลือก</option></select></div>
            </div>
            <div class="small" style="margin-top: 8px">
                <div>
                    ราคารวม: <span class="price" data-set-price-total>0</span> บ.
                    <span data-opaque-price-label class="ml-2">• ทึบ: <span class="price" data-set-price-opaque>0</span> บ.</span>
                    <span data-sheer-price-label class="hidden ml-2">• โปร่ง: <span class="price" data-set-price-sheer>0</span> บ.</span>
                </div>
                <div style="margin-top: 4px;">
                    <span data-opaque-yardage-label>ทึบ: <span class="price" data-set-yardage-opaque>0</span> หลา</span>
                    <span data-sheer-yardage-label class="hidden ml-2">• โปร่ง: <span class="price" data-set-yardage-sheer>0</span> หลา</span>
                    <span data-opaque-track-label class="ml-2">• รางทึบ: <span class="price" data-set-opaque-track>0</span> ม.</span>
                    <span data-sheer-track-label class="hidden ml-2">• รางโปร่ง: <span class="price" data-set-sheer-track>0</span> ม.</span>
                </div>
            </div>
        </div>
    </template>
    
    <template id="decoTpl">
        <div class="deco-item" data-deco-item>
             <div class="item-head">
                <div class="item-badge" data-item-title style="background-color: var(--secondary);"></div>
                <button type="button" class="btn btn-xs btn-warning" data-act="toggle-suspend" style="--primary: var(--warning);"><span data-suspend-text>ระงับ</span></button>
                <span style="flex:1;"></span>
                <button type="button" class="btn btn-xs" data-act="clear-deco">ล้าง</button>
                <button type="button" class="btn btn-icon btn-danger" data-act="del-deco" title="ลบรายการ">✕</button>
            </div>
            <div class="row deco-row">
                <div><label>ประเภท</label><select class="field" name="deco_type" required><option value="" hidden>เลือก</option><option>มู่ลี่ไม้</option><option>ม่านม้วน</option><option>ปรับแสง</option><option>ฉากPVC</option></select></div>
                <div><label>กว้าง(ม.)</label><input class="field" name="deco_width_m" type="number" step="0.01" min="0" required /></div>
                <div><label>สูง(ม.)</label><input class="field" name="deco_height_m" type="number" step="0.01" min="0" required /></div>
                <div><label>ราคา/ตร.หลา</label><input class="field" name="deco_price_sqyd" type="text" inputmode="numeric" required /></div>
            </div>
            <div class="small" data-deco-summary>ราคา: <span class="price">0</span> บ. • พื้นที่: <span class="price">0.00</span> ตร.หลา</div>
        </div>
    </template>

    <script>
    (function() {
        'use strict';
        const APP_VERSION = "input-ui/3.2.0";
        const WEBHOOK_URL = "https://your-make-webhook-url.com/your-unique-path";
        const STORAGE_KEY = "marnthara.input.v3";
        const SQM_TO_SQYD = 1.19599;

        const PRICING = {
            fabric: [1000, 1200, 1300, 1400, 1500, 1600, 1700, 1800, 1900, 2000, 2100, 2200, 2300, 2400, 2500],
            sheer: [1000, 1100, 1200, 1300, 1400, 1500],
            style_surcharge: { "ลอน": 200, "ตาไก่": 0, "จีบ": 0 },
            height: [{ threshold: 3.2, add_per_m: 300 }, { threshold: 2.8, add_per_m: 200 }, { threshold: 2.5, add_per_m: 150 }],
        };
        const CALC = {
            fabricYardage: (style, width) => {
                if (width <= 0) return 0;
                if (style === "ตาไก่" || style === "จีบ") return (width * 2.0 + 0.6) / 0.9;
                if (style === "ลอน") return (width * 2.6 + 0.6) / 0.9;
                return 0;
            },
        };

        const SELECTORS = {
            orderForm: '#orderForm', roomsContainer: '#rooms', roomTpl: '#roomTpl', setTpl: '#setTpl', decoTpl: '#decoTpl',
            payloadInput: '#payload', copyJsonBtn: '#copyJsonBtn', clearAllBtn: '#clearAllBtn',
            lockBtn: '#lockBtn', addRoomHeaderBtn: '#addRoomHeaderBtn', submitBtn: '#submitBtn',
            grandTotal: '#grandTotal', setCount: '#setCount', grandFabric: '#grandFabric',
            grandSheerFabric: '#grandSheerFabric',
            modal: '#confirmationModal', modalTitle: '#modalTitle', modalBody: '#modalBody',
            modalConfirm: '#modalConfirm', modalCancel: '#modalCancel',
            room: '[data-room]', set: '[data-set]', setsContainer: '[data-sets]',
            decorationsContainer: '[data-decorations]', decoItem: '[data-deco-item]',
            sheerWrap: '[data-sheer-wrap]',
            roomNameInput: 'input[name="room_name"]', roomPricePerM: 'select[name="room_price_per_m"]', roomStyle: 'select[name="room_style"]',
            setCountSets: '#setCountSets', setCountDeco: '#setCountDeco',
            toastContainer: '#toast-container',
            grandOpaqueTrack: '#grandOpaqueTrack', grandSheerTrack: '#grandSheerTrack',
            copyTextBtn: '#copyTextBtn', copyOptionsModal: '#copyOptionsModal', copyOptionsConfirm: '#copyOptionsConfirm', copyOptionsCancel: '#copyOptionsCancel',
            copyCustomerInfo: '#copyCustomerInfo', copyRoomDetails: '#copyRoomDetails', copySummary: '#copySummary'
        };

        const roomsEl = document.querySelector(SELECTORS.roomsContainer);
        const orderForm = document.querySelector(SELECTORS.orderForm);
        orderForm.action = WEBHOOK_URL;
        
        let roomCount = 0;
        let isLocked = false;
        
        const toNum = v => {
            if (typeof v === 'string') v = v.replace(/,/g, '');
            return Number.isFinite(parseFloat(v)) ? parseFloat(v) : 0;
        };
        const clamp01 = v => Math.max(0, toNum(v));
        const fmt = (n, fixed = 2, asCurrency = false) => {
            if (!Number.isFinite(n)) return "0";
            const options = asCurrency 
                ? { minimumFractionDigits: 0, maximumFractionDigits: 0 } 
                : { minimumFractionDigits: fixed, maximumFractionDigits: fixed };
            return n.toLocaleString("th-TH", options);
        };
        const debounce = (fn, ms = 120) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; };
        const stylePlus = s => PRICING.style_surcharge[s] ?? 0;
        const heightPlus = h => {
            const sorted = [...PRICING.height].sort((a, b) => b.threshold - a.threshold);
            for (const entry of sorted) { if (h > entry.threshold) return entry.add_per_m; }
            return 0;
        };

        function showToast(message, type = 'default') {
            const container = document.querySelector(SELECTORS.toastContainer);
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;

            if (type === 'success') {
                toast.classList.add('toast-success');
            } else if (type === 'warning') {
                toast.classList.add('toast-warning');
            } else if (type === 'error') {
                toast.classList.add('toast-error');
            } else {
                toast.style.backgroundColor = 'var(--card-bg)';
                toast.style.color = 'var(--fg)';
            }

            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        }
        
        const showConfirmation = (title, body) => {
            return new Promise((resolve) => {
                const modalEl = document.querySelector(SELECTORS.modal);
                modalEl.querySelector(SELECTORS.modalTitle).textContent = title;
                modalEl.querySelector(SELECTORS.modalBody).textContent = body;
                modalEl.classList.add('visible');
                const cleanup = (result) => {
                    modalEl.classList.remove('visible');
                    modalEl.querySelector(SELECTORS.modalConfirm).onclick = null;
                    modalEl.querySelector(SELECTORS.modalCancel).onclick = null;
                    resolve(result);
                };
                modalEl.querySelector(SELECTORS.modalConfirm).onclick = () => cleanup(true);
                modalEl.querySelector(SELECTORS.modalCancel).onclick = () => cleanup(false);
            });
        };

        function showCopyOptionsModal() {
            return new Promise((resolve) => {
                const modal = document.querySelector(SELECTORS.copyOptionsModal);
                modal.classList.add('visible');
                const confirmBtn = document.querySelector(SELECTORS.copyOptionsConfirm);
                const cancelBtn = document.querySelector(SELECTORS.copyOptionsCancel);
                
                const cleanup = (result) => {
                    modal.classList.remove('visible');
                    confirmBtn.onclick = null;
                    cancelBtn.onclick = null;
                    resolve(result);
                };
                
                confirmBtn.onclick = () => {
                    const options = {
                        customer: document.querySelector(SELECTORS.copyCustomerInfo).checked,
                        details: document.querySelector(SELECTORS.copyRoomDetails).checked,
                        summary: document.querySelector(SELECTORS.copySummary).checked,
                    };
                    cleanup(options);
                };
                
                cancelBtn.onclick = () => cleanup(false);
            });
        }

        function addRoom(prefill) {
            if (isLocked) return;
            roomCount++;
            const frag = document.querySelector(SELECTORS.roomTpl).content.cloneNode(true);
            const room = frag.querySelector(SELECTORS.room);
            room.dataset.index = roomCount;
            populatePriceOptions(room.querySelector(SELECTORS.roomPricePerM), PRICING.fabric);
            roomsEl.appendChild(frag);
            const created = roomsEl.querySelector(`${SELECTORS.room}:last-of-type`);

            if (prefill) {
                created.querySelector(SELECTORS.roomNameInput).value = prefill.room_name || "";
                created.querySelector(SELECTORS.roomPricePerM).value = prefill.price_per_m_raw || "";
                created.querySelector(SELECTORS.roomStyle).value = prefill.style || "";
                (prefill.sets || []).forEach(s => addSet(created, s));
                (prefill.decorations || []).forEach(d => addDeco(created, d));
            }

            if (created.querySelectorAll(SELECTORS.set).length === 0 && created.querySelectorAll(SELECTORS.decoItem).length === 0) addSet(created);
            
            renumber(); recalcAll(); saveData(); updateLockState();
            created.scrollIntoView({ behavior: 'smooth', block: 'end' });
            if (!prefill) showToast('เพิ่มห้องใหม่แล้ว', 'success');
        }

        function populatePriceOptions(selectEl, prices) {
            selectEl.innerHTML = `<option value="" hidden>เลือก</option>`;
            prices.forEach(p => {
                const option = document.createElement('option');
                option.value = p; option.textContent = p.toLocaleString("th-TH");
                selectEl.appendChild(option);
            });
        }

        function addSet(roomEl, prefill) {
            if (isLocked) return;
            const setsWrap = roomEl.querySelector(SELECTORS.setsContainer);
            const frag = document.querySelector(SELECTORS.setTpl).content.cloneNode(true);
            setsWrap.appendChild(frag);
            const created = setsWrap.querySelector(`${SELECTORS.set}:last-of-type`);
            populatePriceOptions(created.querySelector('select[name="sheer_price_per_m"]'), PRICING.sheer);

            if (prefill) {
                created.querySelector('input[name="width_m"]').value = prefill.width_m ?? "";
                created.querySelector('input[name="height_m"]').value = prefill.height_m ?? "";
                created.querySelector('select[name="fabric_variant"]').value = prefill.fabric_variant || "ทึบ";
                created.querySelector('select[name="open_type"]').value = prefill.open_type || "";
                created.querySelector('select[name="sheer_price_per_m"]').value = prefill.sheer_price_per_m || "";
                if (prefill.is_suspended) {
                    created.dataset.suspended = 'true';
                    created.classList.add('is-suspended');
                    created.querySelector('[data-suspend-text]').textContent = 'ใช้งาน';
                }
            }
            toggleSetFabricUI(created); renumber(); recalcAll(); saveData(); updateLockState();
            if (!prefill) showToast('เพิ่มจุดผ้าม่านแล้ว', 'success');
        }
        
        function addDeco(roomEl, prefill) {
            if (isLocked) return;
            const decoWrap = roomEl.querySelector(SELECTORS.decorationsContainer);
            const frag = document.querySelector(SELECTORS.decoTpl).content.cloneNode(true);
            decoWrap.appendChild(frag);
            if (prefill) {
                const created = decoWrap.querySelector(`${SELECTORS.decoItem}:last-of-type`);
                created.querySelector('[name="deco_type"]').value = prefill.type || "";
                created.querySelector('[name="deco_width_m"]').value = prefill.width_m ?? "";
                created.querySelector('[name="deco_height_m"]').value = prefill.height_m ?? "";
                created.querySelector('[name="deco_price_sqyd"]').value = fmt(prefill.price_sqyd, 0, true) ?? "";
                if (prefill.is_suspended) {
                    created.dataset.suspended = 'true';
                    created.classList.add('is-suspended');
                    created.querySelector('[data-suspend-text]').textContent = 'ใช้งาน';
                }
            }
            renumber(); recalcAll(); saveData(); updateLockState();
            if (!prefill) showToast('เพิ่มรายการตกแต่งแล้ว', 'success');
        }
        
        async function clearDeco(btn) { 
            if (isLocked || !await showConfirmation('ล้างข้อมูล', 'ยืนยันการล้างข้อมูลในรายการนี้?')) return;
            const deco = btn.closest(SELECTORS.decoItem);
            deco.querySelectorAll('input, select').forEach(el => { el.value = ''; });
            recalcAll();
            saveData();
            updateLockState();
            showToast('ล้างข้อมูลตกแต่งแล้ว', 'success');
        }

        function toggleSetFabricUI(setEl) {
            const variant = setEl.querySelector('select[name="fabric_variant"]').value;
            const hasSheer = variant === "โปร่ง" || variant === "ทึบ&โปร่ง";
            setEl.querySelector(SELECTORS.sheerWrap).classList.toggle("hidden", !hasSheer);
            setEl.querySelector('[data-set-options-row]').classList.toggle("three-col", hasSheer);
            setEl.querySelector("[data-sheer-price-label]").classList.toggle("hidden", !hasSheer);
            setEl.querySelector("[data-sheer-yardage-label]").classList.toggle("hidden", !hasSheer);
            setEl.querySelector("[data-sheer-track-label]").classList.toggle("hidden", !hasSheer);

            const hasOpaque = variant === "ทึบ" || variant === "ทึบ&โปร่ง";
            setEl.querySelector("[data-opaque-price-label]").classList.toggle("hidden", !hasOpaque);
            setEl.querySelector("[data-opaque-yardage-label]").classList.toggle("hidden", !hasOpaque);
            setEl.querySelector("[data-opaque-track-label]").classList.toggle("hidden", !hasOpaque);
        }
        
        function toggleSuspend(btn) {
            const item = btn.closest('.set, .deco-item');
            const isSuspended = !(item.dataset.suspended === 'true');
            item.dataset.suspended = isSuspended;
            item.classList.toggle('is-suspended', isSuspended);
            btn.querySelector('[data-suspend-text]').textContent = isSuspended ? 'ใช้งาน' : 'ระงับ';
            recalcAll();
            saveData();
            showToast(`รายการถูก${isSuspended ? 'ระงับ' : 'ใช้งาน'}แล้ว`, 'warning');
        }

        async function delRoom(btn) { if (isLocked || !await showConfirmation('ลบห้อง', 'ยืนยันการลบห้องนี้?')) return; btn.closest(SELECTORS.room).remove(); renumber(); recalcAll(); saveData(); updateLockState(); showToast('ลบห้องแล้ว', 'success'); }
        async function delSet(btn) { if (isLocked || !await showConfirmation('ลบจุด', 'ยืนยันการลบจุดติดตั้งนี้?')) return; const room = btn.closest(SELECTORS.room); btn.closest(SELECTORS.set).remove(); if (room.querySelectorAll(SELECTORS.set).length === 0 && room.querySelectorAll(SELECTORS.decoItem).length === 0) addSet(room); renumber(); recalcAll(); saveData(); updateLockState(); showToast('ลบจุดผ้าม่านแล้ว', 'success'); }
        async function delDeco(btn) { if (isLocked || !await showConfirmation('ลบรายการ', 'ยืนยันการลบรายการตกแต่งนี้?')) return; btn.closest(SELECTORS.decoItem).remove(); renumber(); recalcAll(); saveData(); updateLockState(); showToast('ลบรายการตกแต่งแล้ว', 'success'); }
        async function clearSet(btn) { if (isLocked || !await showConfirmation('ล้างข้อมูล', 'ยืนยันการล้างข้อมูลในจุดนี้?')) return; const set = btn.closest(SELECTORS.set); set.querySelectorAll('input, select').forEach(el => { el.value = el.name === 'fabric_variant' ? 'ทึบ' : ''; }); toggleSetFabricUI(set); recalcAll(); saveData(); updateLockState(); showToast('ล้างข้อมูลผ้าม่านแล้ว', 'success'); }
        async function clearAllData() { if (isLocked || !await showConfirmation('ล้างข้อมูลทั้งหมด', 'คำเตือน! การกระทำนี้จะลบข้อมูลทั้งหมด ไม่สามารถกู้คืนได้')) return; roomsEl.innerHTML = ""; roomCount = 0; document.querySelectorAll('#customerInfo input').forEach(i => i.value = ""); addRoom(); saveData(); updateLockState(); showToast('ล้างข้อมูลทั้งหมดแล้ว', 'warning'); }

        function renumber() {
            document.querySelectorAll(SELECTORS.room).forEach((room, rIdx) => {
                const input = room.querySelector(SELECTORS.roomNameInput);
                if (input && !input.value) input.placeholder = `ห้อง ${String(rIdx + 1).padStart(2, "0")}`;
                
                const items = room.querySelectorAll(`${SELECTORS.set}, ${SELECTORS.decoItem}`);
                const totalItems = items.length;
                
                items.forEach((item, iIdx) => {
                    const lbl = item.querySelector("[data-item-title]");
                    if (lbl) lbl.textContent = totalItems > 1 ? `${iIdx + 1}/${totalItems}` : `${iIdx + 1}`;
                });
            });
        }

function recalcAll() {
    // 🎉 แก้ไข: เพิ่มตัวแปรสำหรับรางทึบและรางโปร่ง
    let grand = 0, grandOpaqueYards = 0, grandSheerYards = 0, grandOpaqueTrack = 0, grandSheerTrack = 0;
    
    document.querySelectorAll(SELECTORS.room).forEach((room) => {
        let roomSum = 0, roomOpaqueYards = 0, roomSheerYards = 0;
        
        const baseRaw = toNum(room.querySelector(SELECTORS.roomPricePerM).value);
        const style = room.querySelector(SELECTORS.roomStyle).value;
        const sPlus = stylePlus(style);
        
        room.querySelectorAll(SELECTORS.set).forEach((set) => {
            if (set.dataset.suspended === 'true') {
                // ... (ส่วนนี้โค้ดเดิม) ...
                return;
            }
            const w = clamp01(set.querySelector('input[name="width_m"]').value), h = clamp01(set.querySelector('input[name="height_m"]').value);
            const hPlus = heightPlus(h), variant = set.querySelector('select[name="fabric_variant"]').value;
            
            let opaquePrice = 0, sheerPrice = 0, opaqueYards = 0, sheerYards = 0, opaqueTrack = 0, sheerTrack = 0;
            
            if (w > 0 && h > 0) {
                if (variant === "ทึบ" || variant === "ทึบ&โปร่ง") {
                    const opaquePerM = baseRaw + sPlus + hPlus;
                    opaquePrice = Math.round(opaquePerM * w);
                    opaqueYards = CALC.fabricYardage(style, w);
                    opaqueTrack = w;
                }
                if (variant === "โปร่ง" || variant === "ทึบ&โปร่ง") {
                    const sheerBase = clamp01(set.querySelector('select[name="sheer_price_per_m"]').value);
                    const sheerPerM = sheerBase + sPlus + hPlus;
                    sheerPrice = Math.round(sheerPerM * w);
                    sheerYards = CALC.fabricYardage(style, w);
                    sheerTrack = w;
                }
            }

            let totalSetPrice = opaquePrice + sheerPrice;
            set.querySelector('[data-set-price-total]').textContent = fmt(totalSetPrice, 0, true);
            set.querySelector('[data-set-price-opaque]').textContent = fmt(opaquePrice, 0, true);
            set.querySelector('[data-set-price-sheer]').textContent = fmt(sheerPrice, 0, true);
            set.querySelector('[data-set-yardage-opaque]').textContent = fmt(opaqueYards, 2);
            set.querySelector('[data-set-yardage-sheer]').textContent = fmt(sheerYards, 2);
            set.querySelector('[data-set-opaque-track]').textContent = fmt(opaqueTrack, 2);
            set.querySelector('[data-set-sheer-track]').textContent = fmt(sheerTrack, 2);
            
            roomSum += totalSetPrice;
            roomOpaqueYards += opaqueYards;
            roomSheerYards += sheerYards;
            grandOpaqueTrack += opaqueTrack;
            grandSheerTrack += sheerTrack;
        });

            const totalSets = [...document.querySelectorAll(`${SELECTORS.set}:not([data-suspended="true"])`)].reduce((sum, set) => {
                const variant = set.querySelector('select[name="fabric_variant"]').value;
                if (variant === "ทึบ&โปร่ง") return sum + 2;
                return sum + 1;
            }, 0);
            
            const totalDeco = document.querySelectorAll(`${SELECTORS.decoItem}:not([data-suspended="true"])`).length;
            const totalPoints = document.querySelectorAll(`${SELECTORS.set}:not([data-suspended="true"]), ${SELECTORS.decoItem}:not([data-suspended="true"])`).length;
            
            document.querySelector(SELECTORS.grandTotal).textContent = fmt(grand, 0, true);
            document.querySelector(SELECTORS.setCount).textContent = fmt(totalPoints, 0, true);
            document.querySelector(SELECTORS.setCountSets).textContent = fmt(totalSets, 0, true);
            document.querySelector(SELECTORS.setCountDeco).textContent = fmt(totalDeco, 0, true);
            
            document.querySelector(SELECTORS.grandFabric).textContent = `${fmt(grandOpaqueYards, 2)} หลา`;
            document.querySelector(SELECTORS.grandSheerFabric).textContent = `${fmt(grandSheerYards, 2)} หลา`;
            document.querySelector(SELECTORS.grandOpaqueTrack).textContent = `${fmt(grandOpaqueTrack, 2)} ม.`;
            document.querySelector(SELECTORS.grandSheerTrack).textContent = `${fmt(grandSheerTrack, 2)} ม.`;
        }

        function buildPayload() {
            return {
                customer_name: document.querySelector('input[name="customer_name"]').value || "",
                customer_address: document.querySelector('input[name="customer_address"]').value || "",
                customer_phone: document.querySelector('input[name="customer_phone"]').value || "",
                app_version: APP_VERSION,
                generated_at: new Date().toISOString(),
                rooms: [...document.querySelectorAll(SELECTORS.room)].map(room => ({
                    room_name: room.querySelector(SELECTORS.roomNameInput).value || "",
                    price_per_m_raw: toNum(room.querySelector(SELECTORS.roomPricePerM).value),
                    style: room.querySelector(SELECTORS.roomStyle).value,
                    sets: [...room.querySelectorAll(SELECTORS.set)].map(set => ({
                        width_m: clamp01(set.querySelector('input[name="width_m"]').value),
                        height_m: clamp01(set.querySelector('input[name="height_m"]').value),
                        fabric_variant: set.querySelector('select[name="fabric_variant"]').value,
                        open_type: set.querySelector('select[name="open_type"]').value,
                        sheer_price_per_m: clamp01(set.querySelector('select[name="sheer_price_per_m"]').value),
                        is_suspended: set.dataset.suspended === 'true',
                    })),
                    decorations: [...room.querySelectorAll(SELECTORS.decoItem)].map(deco => ({
                        type: deco.querySelector('[name="deco_type"]').value,
                        width_m: clamp01(deco.querySelector('[name="deco_width_m"]').value),
                        height_m: clamp01(deco.querySelector('[name="deco_height_m"]').value),
                        price_sqyd: clamp01(deco.querySelector('[name="deco_price_sqyd"]').value),
                        is_suspended: deco.dataset.suspended === 'true',
                    }))
                }))
            };
        }
        
        function buildTextPayload(options) {
            let text = "";
            const payload = buildPayload();
            
            if (options.customer) {
                text += "--- ข้อมูลลูกค้า ---\n";
                text += `ชื่อ: ${payload.customer_name}\n`;
                text += `ที่อยู่: ${payload.customer_address}\n`;
                text += `เบอร์โทร: ${payload.customer_phone}\n\n`;
            }
            
            if (options.details) {
                text += "--- รายละเอียดแต่ละจุด ---\n";
                payload.rooms.forEach((room, rIndex) => {
                    const roomName = room.room_name || `ห้อง ${String(rIndex + 1).padStart(2, "0")}`;
                    text += `\n** ห้อง: ${roomName} (${room.style} - ${fmt(room.price_per_m_raw, 0, true)} บ./ม.) **\n`;
                    
                    room.sets.forEach((set, sIndex) => {
                        if (set.is_suspended) return;
                        const w = clamp01(set.width_m), h = clamp01(set.height_m);
                        const baseRaw = toNum(room.price_per_m_raw);
                        const sPlus = stylePlus(room.style);
                        const hPlus = heightPlus(h);
                        
                        let opaquePrice = 0, sheerPrice = 0;
                        if (set.fabric_variant === "ทึบ" || set.fabric_variant === "ทึบ&โปร่ง") {
                            opaquePrice = Math.round((baseRaw + sPlus + hPlus) * w);
                        }
                        if (set.fabric_variant === "โปร่ง" || set.fabric_variant === "ทึบ&โปร่ง") {
                            sheerPrice = Math.round((set.sheer_price_per_m + sPlus + hPlus) * w);
                        }
                        const setPrice = opaquePrice + sheerPrice;

                        text += `\n• จุดที่ ${sIndex + 1}: กว้าง ${fmt(w, 2)} ม. x สูง ${fmt(h, 2)} ม.\n`;
                        text += `  - ชนิด: ${set.fabric_variant} | เปิด: ${set.open_type || 'ไม่ระบุ'}\n`;
                        text += `  - ราคา: ${fmt(setPrice, 0, true)} บ.\n`;
                    });
                    
                    room.decorations.forEach((deco, dIndex) => {
                        if (deco.is_suspended) return;
                        const decoPrice = Math.round(deco.width_m * deco.height_m * SQM_TO_SQYD * deco.price_sqyd);
                        text += `\n• รายการตกแต่งที่ ${dIndex + 1}: ${deco.type}\n`;
                        text += `  - กว้าง ${fmt(deco.width_m, 2)} ม. x สูง ${fmt(deco.deco_height_m, 2)} ม.\n`;
                        text += `  - ราคา: ${fmt(decoPrice, 0, true)} บ.\n`;
                    });
                });
                text += "\n";
            }

            if (options.summary) {
                text += "--- สรุปยอดรวม ---\n";
                const grandTotal = document.querySelector(SELECTORS.grandTotal).textContent;
                const fabricYards = document.querySelector(SELECTORS.grandFabric).textContent;
                const sheerYards = document.querySelector(SELECTORS.grandSheerFabric).textContent;
                text += `ราคารวม: ${grandTotal} บาท\n`;
                text += `ผ้าทึบที่ใช้: ${fabricYards}\n`;
                text += `ผ้าโปร่งที่ใช้: ${sheerYards}\n`;
            }
            
            return text.trim();
        }

        const debouncedRecalcAndSave = debounce(() => { recalcAll(); saveData(); });
        
        function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(buildPayload())); }

        function updateLockState() {
            const isFormLocked = isLocked || false;
            document.querySelectorAll('input, select, button').forEach(el => {
                const btn = el.closest('button');
                if (btn && (btn.id === 'lockBtn' || btn.id === 'addRoomHeaderBtn')) return;
                el.disabled = isFormLocked;
            });
            const lockBtn = document.querySelector(SELECTORS.lockBtn);
            lockBtn.classList.toggle('btn-primary', !isFormLocked);
            lockBtn.classList.toggle('btn-danger', isFormLocked);
            lockBtn.querySelector('.lock-text').textContent = isFormLocked ? 'ปลดล็อค' : 'ล็อก';
            lockBtn.querySelector('.lock-icon').textContent = isFormLocked ? '🔓' : '🔒';
        }
        
        function toggleLock() { 
            isLocked = !isLocked; 
            updateLockState(); 
            showToast(isLocked ? 'ฟอร์มถูกล็อคแล้ว' : 'ฟอร์มถูกปลดล็อคแล้ว', isLocked ? 'warning' : 'success');
        }
        
        function formatNumericInput(e) {
            const input = e.target;
            let val = input.value.replace(/[^0-9]/g, '');
            if (val) {
                input.value = parseInt(val, 10).toLocaleString('th-TH');
            } else {
                input.value = '';
            }
        }

        document.addEventListener("change", e => {
            if (e.target.matches('select[name="fabric_variant"]')) {
                const setEl = e.target.closest(SELECTORS.set);
                if (setEl) {
                    toggleSetFabricUI(setEl);
                }
            }
            debouncedRecalcAndSave();
        });

        document.addEventListener("input", e => {
            if(e.target.matches('[name="deco_price_sqyd"]')) {
                formatNumericInput(e);
            }
            debouncedRecalcAndSave();
        });

        document.addEventListener("click", async (e) => {
            const btn = e.target.closest("button");
            if (!btn) return;
            const act = btn.dataset.act;
            if (btn.type !== 'submit') e.preventDefault();
            
            const actions = {
                'del-room': delRoom, 'del-set': delSet, 'del-deco': delDeco, 'clear-deco': clearDeco,
                'add-set': (b) => addSet(b.closest(SELECTORS.room)),
                'add-deco': (b) => addDeco(b.closest(SELECTORS.room)),
                'clear-set': clearSet, 'toggle-suspend': toggleSuspend
            };
            if (actions[act]) actions[act](btn);
            else if (btn.id === "addRoomHeaderBtn") addRoom();
            else if (btn.id === "clearAllBtn") clearAllData();
            else if (btn.id === "lockBtn") toggleLock();
            else if (btn.id === "copyJsonBtn") {
                try {
                    await navigator.clipboard.writeText(JSON.stringify(buildPayload(), null, 2));
                    showToast('คัดลอก JSON แล้ว!', 'success');
                } catch(err) {
                    console.error("Failed to copy JSON: ", err);
                    showToast('ไม่สามารถคัดลอก JSON ได้', 'error');
                }
            } else if (btn.id === "copyTextBtn") {
                const options = await showCopyOptionsModal();
                if (options) {
                    const textToCopy = buildTextPayload(options);
                    try {
                        await navigator.clipboard.writeText(textToCopy);
                        showToast('คัดลอกข้อความแล้ว!', 'success');
                    } catch(err) {
                        console.error('Failed to copy text: ', err);
                        showToast('ไม่สามารถคัดลอกข้อความได้', 'error');
                    }
                }
            }
        });

        orderForm.addEventListener("submit", (e) => {
            if (isLocked) { 
                e.preventDefault(); 
                showToast('ฟอร์มถูกล็อคอยู่ ไม่สามารถส่งได้', 'error');
                return; 
            }
            const submitBtn = document.querySelector(SELECTORS.submitBtn);
            submitBtn.disabled = true; 
            submitBtn.textContent = 'กำลังส่ง...';
            document.querySelector(SELECTORS.payloadInput).value = JSON.stringify(buildPayload());
            // This part is for demonstration and assumes a successful send.
            setTimeout(() => { 
                submitBtn.disabled = isLocked; 
                submitBtn.textContent = 'ส่งไปคำนวณ'; 
                showToast('ส่งข้อมูลสำเร็จแล้ว', 'success');
            }, 3000);
        });
        
        window.addEventListener('load', () => {
            const storedData = localStorage.getItem(STORAGE_KEY);
            if (storedData) {
                try {
                    const payload = JSON.parse(storedData);
                    document.querySelector('input[name="customer_name"]').value = payload.customer_name;
                    document.querySelector('input[name="customer_address"]').value = payload.customer_address;
                    document.querySelector('input[name="customer_phone"]').value = payload.customer_phone;
                    roomsEl.innerHTML = ""; roomCount = 0;
                    if (payload.rooms && payload.rooms.length > 0) payload.rooms.forEach(addRoom);
                    else addRoom();
                } catch(err) {
                    console.error("Failed to load data from storage:", err);
                    localStorage.removeItem(STORAGE_KEY);
                    addRoom();
                }
            } else {
                addRoom();
            }
            updateLockState();
        });
    })();
    </script>
</body>
</html>