<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Marnthara Order</title>
<style>
:root{--line:#2f2f33;--muted:#c9c9cf;--danger:#ff5a5f}
*{box-sizing:border-box}
body{margin:0;padding:16px;color:#e6e6e6;background:#121216;
     font-family:system-ui,Segoe UI,Roboto,Arial}
h1{font-size:18px;margin:0 0 12px}
.card{border:1px solid var(--line);border-radius:14px;padding:12px;margin:12px 0}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.field{width:100%;padding:.55rem .7rem;border:1px solid var(--line);
       border-radius:.6rem;background:transparent;color:inherit}
label{font-size:12px;color:#b9b9bf;display:block;margin:8px 0 6px}
.small{font-size:12px;color:#b9b9bf}
.price{font-weight:700}
.btn{display:inline-flex;align-items:center;gap:.35rem;border:1px solid var(--line);
     background:transparent;color:var(--muted);border-radius:.5rem;font-weight:500;
     transition:opacity .15s ease;cursor:pointer}
.btn:hover{opacity:.85}
.btn-xs{padding:.2rem .45rem;font-size:.85rem;line-height:1.1}
.btn-icon{width:1.8rem;height:1.8rem;padding:0;display:inline-grid;place-items:center}
.btn-danger{border-color:var(--danger);color:var(--danger)}
.actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
.room-header{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.room-header .spacer{flex:1}
hr{border:none;border-top:1px solid var(--line);margin:12px 0}
.hidden{display:none}
.total-bar{display:flex;justify-content:space-between;align-items:center;
           border:1px solid var(--line);border-radius:12px;padding:10px;margin-top:14px}
</style>
</head>
<body>

<h1>สั่งงานม่าน</h1>

<form id="orderForm"
      action="https://hook.eu2.make.com/xul3fhuh96ybgfm2omdt2e74ejybxjoj"
      method="post" target="hiddenFrame">

  <div id="rooms"></div>

  <div class="total-bar">
    <div class="small">ราคารวมทุกห้อง</div>
    <div class="price"><span id="grandTotal">0</span> บาท</div>
  </div>

  <div class="actions">
    <button type="button" class="btn btn-xs" id="addRoomTop">+ เพิ่มห้อง</button>
    <button type="submit" class="btn btn-xs">ส่งไปคำนวณ</button>
  </div>

  <!-- JSON รวมทั้งหมด ส่งเข้า Make -->
  <input type="hidden" name="payload_json" id="payload_json" />
</form>

<iframe name="hiddenFrame" class="hidden"></iframe>

<!-- Templates -->
<template id="roomTpl">
  <div class="card room">
    <div class="room-header">
      <label style="margin:0">ชื่อห้อง</label>
      <input name="room_name" class="field" type="text"
             inputmode="text" placeholder="เช่น ห้องนอน 1" />
      <span class="spacer"></span>
      <button type="button" class="btn btn-xs" data-action="add-set">+ เพิ่มชุด</button>
      <button type="button" class="btn btn-xs" data-action="add-room">+ เพิ่มห้อง</button>
      <button type="button" class="btn btn-icon btn-danger" data-action="del-room"
              aria-label="ลบห้อง">✕</button>
    </div>

    <div class="row">
      <div>
        <label>ราคาผ้า (บาท/ม.)</label>
        <select name="fabric_rate" class="field rate-select" required></select>
      </div>
      <div>
        <label>รูปแบบเปิดผ้า</label>
        <select name="open_type" class="field" required>
          <option value="" hidden>เลือก</option>
          <option>แยกกลาง</option>
          <option>สไลด์เดี่ยว</option>
        </select>
      </div>
    </div>

    <div class="sets"></div>
  </div>
</template>

<template id="setTpl">
  <div class="card set">
    <div class="row">
      <div>
        <label>สไตล์</label>
        <select name="style_type" class="field" required>
          <option value="" hidden>เลือก</option>
          <option>ลอน</option><option>ตาไก่</option><option>จีบ</option>
        </select>
      </div>
      <div>
        <label>ชนิดผ้า</label>
        <select name="fabric_type" class="field" required>
          <option value="" hidden>เลือก</option>
          <option>ทึบ</option><option>โปร่ง</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>กว้าง (ม.)</label>
        <input name="width_m" class="field" type="number" step="0.01"
               inputmode="decimal" placeholder="เช่น 3.50" required />
      </div>
      <div>
        <label>สูง (ม.)</label>
        <input name="height_m" class="field" type="number" step="0.01"
               inputmode="decimal" placeholder="เช่น 2.80" required />
      </div>
    </div>

    <label>หมายเหตุ</label>
    <textarea name="notes" class="field" rows="2" placeholder="ตัวอย่าง"></textarea>

    <div class="row">
      <div class="small">
        ผ้าที่ใช้ ~ <span data-bind="panels">0</span> แผง,
        รวม <span data-bind="fabric_m">0.00</span> ม.
      </div>
      <div class="price">ราคาชุดนี้: <span data-bind="price">0</span> บาท</div>
    </div>

    <div class="actions">
      <button type="button" class="btn btn-xs" data-action="add-set">+ เพิ่มชุด</button>
      <button type="button" class="btn btn-icon btn-danger" data-action="del-set"
              aria-label="ลบชุด">✕</button>
    </div>
  </div>
</template>

<script>
/* ---------- Utilities ---------- */
const TH = new Intl.NumberFormat('th-TH');
const roomsEl = document.getElementById('rooms');
const roomTpl = document.getElementById('roomTpl');
const setTpl  = document.getElementById('setTpl');

function populateRates(selectEl){
  selectEl.innerHTML = '<option value="" hidden>เลือก</option>';
  for(let r=1000; r<=2500; r+=100){
    const opt=document.createElement('option');
    opt.value = r;
    opt.textContent = `${TH.format(r)} บาท/ม.`;
    selectEl.appendChild(opt);
  }
  selectEl.value = '1200'; // ค่าเริ่มต้น
}

function addRoom(){
  const node = roomTpl.content.firstElementChild.cloneNode(true);
  populateRates(node.querySelector('.rate-select'));
  node.querySelector('.sets').appendChild(createSet());
  roomsEl.appendChild(node);
  computeAll();
  return node;
}

function createSet(){
  return setTpl.content.firstElementChild.cloneNode(true);
}

/* ---------- Pricing ---------- */
function computeSet(setEl){
  const roomEl = setEl.closest('.room');
  const rate = parseFloat(roomEl.querySelector('select[name="fabric_rate"]').value || '0');
  const w = parseFloat(setEl.querySelector('input[name="width_m"]').value || '0');
  const h = parseFloat(setEl.querySelector('input[name="height_m"]').value || '0');
  const type = setEl.querySelector('select[name="style_type"]').value;

  // fullness ตามสไตล์
  let fullness = 2.0;
  if (type === 'จีบ') fullness = 2.2;
  else if (type === 'ตาไก่') fullness = 1.8;
  else if (type === 'ลอน')  fullness = 2.0;

  const usableWidth = 1.4;
  const dropAllowance = 0.25;
  const panels = Math.max(1, Math.ceil((w * fullness) / usableWidth));
  const fabric_m = +(panels * (h + dropAllowance)).toFixed(2);
  const price = Math.round(fabric_m * rate);

  setEl.querySelector('[data-bind="panels"]').textContent = panels;
  setEl.querySelector('[data-bind="fabric_m"]').textContent = fabric_m.toFixed(2);
  setEl.querySelector('[data-bind="price"]').textContent   = TH.format(price);
  setEl.dataset.price = String(price);
  setEl.dataset.fabric_m = String(fabric_m);
  setEl.dataset.panels = String(panels);
  return price;
}

function computeAll(){
  let grand = 0;
  document.querySelectorAll('.set').forEach(s => grand += computeSet(s));
  document.getElementById('grandTotal').textContent = TH.format(grand);
  return grand;
}

/* ---------- Events ---------- */
document.addEventListener('input', e=>{
  if (e.target.matches('input, select, textarea')) computeAll();
});

document.addEventListener('click', e=>{
  const b = e.target.closest('button[data-action]');
  if(!b) return;
  const act = b.dataset.action;
  const room = b.closest('.room');

  if (act === 'add-room'){
    addRoom();
  } else if (act === 'del-room'){
    room.remove();
    if (!roomsEl.children.length) addRoom();
    computeAll();
  } else if (act === 'add-set'){
    const wrap = room.querySelector('.sets');
    wrap.appendChild(createSet());
    computeAll();
  } else if (act === 'del-set'){
    const set = b.closest('.set');
    set.remove();
    computeAll();
  }
});

document.getElementById('addRoomTop').addEventListener('click', addRoom);

/* form submit: แนบ payload_json สำหรับ Make */
document.getElementById('orderForm').addEventListener('submit', e=>{
  const payload = [];
  document.querySelectorAll('.room').forEach(roomEl=>{
    const roomData = {
      room_name: roomEl.querySelector('input[name="room_name"]').value || "",
      fabric_rate: parseFloat(roomEl.querySelector('select[name="fabric_rate"]').value||'0'),
      open_type: roomEl.querySelector('select[name="open_type"]').value||"",
      sets: []
    };
    roomEl.querySelectorAll('.set').forEach(setEl=>{
      roomData.sets.push({
        style_type: setEl.querySelector('select[name="style_type"]').value||"",
        fabric_type: setEl.querySelector('select[name="fabric_type"]').value||"",
        width_m: parseFloat(setEl.querySelector('input[name="width_m"]').value||'0'),
        height_m: parseFloat(setEl.querySelector('input[name="height_m"]').value||'0'),
        notes: setEl.querySelector('textarea[name="notes"]').value||"",
        panels: Number(setEl.dataset.panels||0),
        fabric_m: Number(setEl.dataset.fabric_m||0),
        price: Number(setEl.dataset.price||0)
      });
    });
    payload.push(roomData);
  });
  const grand = computeAll();
  document.getElementById('payload_json').value =
    JSON.stringify({rooms: payload, grand_total: grand});
});

/* init */
addRoom();

/* เตือนถ้ายังไม่ได้ตั้ง Webhook URL */
(function(){
  const f=document.getElementById('orderForm');
  if(f.action.includes('PUT-YOUR-HOOK-HERE')){
    setTimeout(()=>alert('ยังไม่ได้ตั้ง Webhook URL ของ Make ใน form.action'),100);
  }
})();
</script>
</body>
</html>
