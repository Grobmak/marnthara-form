<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Marnthara Input (v3.1)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- Variable & Base Style --- */
        :root {
            --bg: #0d0e12; --card-bg: #1a1b20; --fg: #e7e7ea;
            --line: #2f2f33; --muted: #b8b8bf; --danger: #ff5a5f;
            --primary: #5a7dff; --secondary: #4caf50; --warning: #ffc107;
            --room1-bg: #1a1b20; --room2-bg: #20222a; --room3-bg: #252830;
            --accent-dark: #2f2f33;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0; padding: 16px 16px 80px 16px; background: var(--bg);
            color: var(--fg); font-family: system-ui, Segoe UI, Roboto, Arial; line-height: 1.5;
        }
        h1 { font-size: 1.2rem; margin: 0; padding: 0; }
        /* --- Card & Layouts --- */
        .card { border: 1px solid var(--line); border-radius: 14px; padding: 12px; margin: 12px 0; background: var(--card-bg); }
        .room { border: 1px solid var(--primary); margin-bottom: 24px; transition: background-color 0.3s ease; }
        .room:nth-of-type(3n + 1) { background-color: var(--room1-bg); }
        .room:nth-of-type(3n + 2) { background-color: var(--room2-bg); }
        .room:nth-of-type(3n + 3) { background-color: var(--room3-bg); }
        .room > summary { padding: 12px; background: var(--accent-dark); border-radius: 12px 12px 0 0; margin: -12px; margin-bottom: 0; cursor: pointer; }
        .room > div, .room > .total { padding-top: 12px; }
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .row.three-col { grid-template-columns: repeat(3, 1fr); }
        .row.five-col { grid-template-columns: 2fr 1fr 1fr 1.5fr auto; align-items: end;}
        /* --- Form Elements --- */
        label { font-size: 0.8rem; color: var(--muted); display: block; margin-bottom: 4px; }
        label.required::after { content: " *"; color: var(--danger); font-weight: bold; }
        .field {
            width: 100%; padding: 0.65rem 0.8rem; border: 1px solid var(--line); border-radius: 0.6rem;
            background: #000; color: inherit; appearance: none; font-size: 1rem;
        }
        .field:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(90, 125, 255, 0.2); }
        /* --- Text & Price --- */
        .small { font-size: 0.8rem; color: var(--muted); }
        .price { font-weight: 600; color: var(--secondary); }
        /* --- Buttons --- */
        .btn {
            display: inline-flex; align-items: center; gap: 0.35rem; border: 1px solid var(--line); background: transparent;
            color: var(--primary); border-radius: 0.5rem; font-weight: 500;
            transition: opacity 0.15s ease, transform 0.1s ease, background-color 0.2s; cursor: pointer; font-size: 0.9rem;
        }
        .btn:hover { opacity: 0.85; }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-xs { padding: 0.35rem 0.75rem; font-size: 0.8rem; line-height: 1; }
        .btn-icon { width: 2rem; height: 2rem; padding: 0; display: inline-grid; place-items: center; }
        .btn-danger { border-color: var(--danger); color: var(--danger); }
        .btn-primary { background: var(--primary); border-color: var(--primary); color: white; }
        .btn-primary.outline { background: transparent; color: var(--primary); }
        .btn-warning { border-color: var(--warning); color: var(--warning); }
        /* --- Layouts & Containers --- */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; gap: 8px; }
        .actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px; }
        .total { border-top: 1px solid var(--line); padding-top: 16px; margin-top: 16px; display: flex; justify-content: space-between; align-items: center; font-size: 1.2rem; font-weight: 600; }
        .hidden { display: none !important; }
        .room-head { display: flex; gap: 12px; align-items: center; }
        .room-head input { flex: 1 1 180px; min-width: 120px; }
        .room-head .sp { flex: 1; display: none; } /* Hide old spacer */
        .room-head [data-room-brief] { flex-shrink: 0; margin-left: auto; }
        /* --- Custom Components --- */
        .set, .deco-item { background: #0d0e12; border: 1px solid #2f2f33; margin-bottom: 12px; border-radius: 12px; padding: 12px; transition: opacity 0.3s, border-color 0.3s; }
        .set { border-left: 3px solid var(--primary); }
        .deco-item { border-left: 3px solid var(--secondary); }
        .set.is-suspended, .deco-item.is-suspended { opacity: 0.5; border-left-color: var(--muted); }
        .item-head { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--line); }
        .item-badge { font-size: 1rem; font-weight: bold; background: var(--primary); color: #fff; border: none; border-radius: 99px; width: 30px; height: 30px; display: inline-flex; align-items: center; justify-content: center; line-height: 1; flex-shrink: 0; }
        .sticky-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--accent-dark); border-top: 1px solid var(--line); padding: 12px 16px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; z-index: 1000; }
        .sticky-footer .summary-item { text-align: center; }
        .sticky-footer .summary-label { font-size: 0.7rem; color: var(--muted); margin-bottom: 4px; }
        .sticky-footer .summary-value { font-weight: 600; font-size: 1rem; color: var(--primary); }
        .sticky-footer .summary-value.price { color: var(--secondary); }
        /* --- Details & Summary --- */
        details.room > summary { list-style: none; }
        details.room > summary::-webkit-details-marker { display: none; }
        [data-room-brief] { display: inline-block; padding: 0.2rem 0.5rem; border: 1px solid var(--line); border-radius: 0.5rem; background: #0d0e12; color: var(--muted); }
        [data-room-brief] .num { color: var(--primary); font-weight: 600; }
        [data-room-brief] .num.price { color: var(--secondary); }
        /* --- Confirmation Modal --- */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 2000; opacity: 0; transition: opacity 0.2s ease-in-out; pointer-events: none; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal { background: var(--card-bg); border-radius: 14px; padding: 24px; border: 1px solid var(--line); width: 90%; max-width: 400px; transform: scale(0.95); transition: transform 0.2s ease-in-out; }
        .modal-overlay.visible .modal { transform: scale(1); }
        .modal-title { font-size: 1.1rem; font-weight: 600; margin: 0 0 12px 0; }
        .modal-body { margin: 0 0 24px 0; color: var(--muted); }
        .modal-actions { display: flex; justify-content: flex-end; gap: 12px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Marnthara</h1>
        <button type="button" class="btn btn-xs btn-primary outline" id="addRoomHeaderBtn">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á</button>
        <span style="flex:1;"></span>
        <button type="button" class="btn btn-xs btn-primary" id="lockBtn"><span class="lock-text">‡∏•‡πá‡∏≠‡∏Ñ</span> <span class="lock-icon">üîí</span></button>
        <button type="button" class="btn btn-xs btn-danger" id="clearAllBtn">‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î üóëÔ∏è</button>
    </div>

    <form id="orderForm" method="post" target="hiddenFrame">
        <div class="card" id="customerInfo">
            <div class="row three-col">
                <div><label>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label><input class="field" type="text" name="customer_name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ä‡∏≤‡∏¢" /></div>
                <div><label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label><input class="field" type="text" name="customer_address" placeholder="‡πÄ‡∏ä‡πà‡∏ô 123/45 ‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô..." /></div>
                <div><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input class="field" type="tel" name="customer_phone" placeholder="08xxxxxxxx" /></div>
            </div>
        </div>
        <input type="hidden" name="payload" id="payload" />
        <div id="rooms"></div>
        <div class="actions">
            <button type="button" class="btn btn-xs" id="copyJsonBtn">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å JSON</button>
            <button type="submit" class="btn btn-xs btn-primary" id="submitBtn">‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
        </div>
    </form>

    <div class="sticky-footer">
        <div class="summary-item"><div class="summary-label">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°</div><div class="summary-value price" id="grandTotal">0</div></div>
        <div class="summary-item"><div class="summary-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏∏‡∏î</div><div class="summary-value" id="setCount">0</div></div>
        <div class="summary-item"><div class="summary-label">‡∏ú‡πâ‡∏≤‡∏ó‡∏∂‡∏ö‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</div><div class="summary-value" id="grandFabric">0</div></div>
        <div class="summary-item"><div class="summary-label">‡∏ú‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡πà‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</div><div class="summary-value" id="grandSheerFabric">0</div></div>
        <div class="summary-item"><div class="summary-label">‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ (‡∏°.)</div><div class="summary-value" id="grandTrack">0</div></div>
    </div>

    <iframe name="hiddenFrame" class="hidden"></iframe>

    <div id="confirmationModal" class="modal-overlay">
        <div class="modal">
            <h3 class="modal-title" id="modalTitle">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</h3><p class="modal-body" id="modalBody">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
            <div class="modal-actions">
                <button type="button" class="btn btn-xs" id="modalCancel">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="button" class="btn btn-xs btn-danger" id="modalConfirm">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>
        </div>
    </div>

    <template id="roomTpl">
        <details class="card room" data-room open>
            <summary class="room-head">
                <input class="field" type="text" name="room_name" placeholder="‡∏´‡πâ‡∏≠‡∏á 01" required />
                <span class="small" data-room-brief>‡∏à‡∏∏‡∏î 0 ‚Ä¢ ‡∏ä‡∏∏‡∏î 0 ‚Ä¢ ‡∏£‡∏≤‡∏Ñ‡∏≤ 0 ‡∏ö‡∏≤‡∏ó</span>
                <button type="button" class="btn btn-icon btn-danger" data-act="del-room" title="‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á">‚úï</button>
            </summary>
            <div>
                <div class="row">
                    <div><label class="required">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ú‡πâ‡∏≤ (‡∏ó‡∏∂‡∏ö) (‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏ï‡∏£)</label><select class="field" name="room_price_per_m" required><option value="" hidden>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option></select></div>
                    <div><label class="required">‡∏™‡πÑ‡∏ï‡∏•‡πå</label><select class="field" name="room_style" required><option value="" hidden>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option><option>‡∏•‡∏≠‡∏ô</option><option>‡∏ï‡∏≤‡πÑ‡∏Å‡πà</option><option>‡∏à‡∏µ‡∏ö</option></select></div>
                </div>
            </div>
            <div data-sets></div>
            <div data-decorations></div>
            <div class="total">
                <div class="room-actions">
                    <button type="button" class="btn btn-xs btn-primary outline" data-act="add-set">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏ú‡πâ‡∏≤‡∏°‡πà‡∏≤‡∏ô</button>
                    <button type="button" class="btn btn-xs btn-secondary outline" data-act="add-deco" style="--primary: var(--secondary);">+ ‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                </div>
            </div>
        </details>
    </template>

    <template id="setTpl">
        <div class="card set" data-set>
            <div class="item-head">
                <div class="item-badge" data-item-title></div>
                <button type="button" class="btn btn-xs btn-warning" data-act="toggle-suspend" style="--primary: var(--warning);"><span data-suspend-text>‡∏£‡∏∞‡∏á‡∏±‡∏ö</span></button>
                <span style="flex:1;"></span>
                <button type="button" class="btn btn-xs" data-act="clear-set">‡∏•‡πâ‡∏≤‡∏á</button>
                <button type="button" class="btn btn-icon btn-danger" data-act="del-set" title="‡∏•‡∏ö‡∏ä‡∏∏‡∏î">‚àí</button>
            </div>
            <div class="row">
                <div><label class="required">‡∏Å‡∏ß‡πâ‡∏≤‡∏á (‡∏°.)</label><input class="field" name="width_m" type="number" step="0.01" min="0" required /></div>
                <div><label class="required">‡∏™‡∏π‡∏á (‡∏°.)</label><input class="field" name="height_m" type="number" step="0.01" min="0" required /></div>
            </div>
            <div class="row" data-set-options-row>
                <div><label>‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πâ‡∏≤</label><select class="field" name="open_type"><option value="" hidden>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option><option>‡πÅ‡∏¢‡∏Å‡∏Å‡∏•‡∏≤‡∏á</option><option>‡∏™‡πÑ‡∏•‡∏î‡πå‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß</option></select></div>
                <div><label>‡∏ä‡∏ô‡∏¥‡∏î‡∏ú‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ</label><select class="field" name="fabric_variant"><option>‡∏ó‡∏∂‡∏ö</option><option>‡πÇ‡∏õ‡∏£‡πà‡∏á</option><option>‡∏ó‡∏∂‡∏ö&‡πÇ‡∏õ‡∏£‡πà‡∏á</option></select></div>
                <div data-sheer-wrap class="hidden"><label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ú‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡πà‡∏á (‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏ï‡∏£)</label><select class="field" name="sheer_price_per_m"><option value="" hidden>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option></select></div>
            </div>
            <div class="small" style="margin-top: 8px">
                <span data-opaque-price-label>‡∏ó‡∏∂‡∏ö: <span class="price" data-set-price-opaque>0</span> ‡∏ö.</span>
                <span data-sheer-price-label class="hidden"> ‚Ä¢ ‡πÇ‡∏õ‡∏£‡πà‡∏á: <span class="price" data-set-price-sheer>0</span> ‡∏ö.</span>
                <span data-opaque-yardage-label> ‚Ä¢ ‡∏ó‡∏∂‡∏ö: <span class="price" data-set-yardage-opaque>0</span> ‡∏´‡∏•‡∏≤</span>
                <span data-sheer-yardage-label class="hidden"> ‚Ä¢ ‡πÇ‡∏õ‡∏£‡πà‡∏á: <span class="price" data-set-yardage-sheer>0</span> ‡∏´‡∏•‡∏≤</span>
                <span data-track-label> ‚Ä¢ ‡∏£‡∏≤‡∏á: <span class="price" data-set-track>0</span> ‡∏°.</span>
            </div>
        </div>
    </template>
    
    <template id="decoTpl">
        <div class="deco-item" data-deco-item>
             <div class="item-head">
                <div class="item-badge" data-item-title style="background-color: var(--secondary);"></div>
                <button type="button" class="btn btn-xs btn-warning" data-act="toggle-suspend" style="--primary: var(--warning);"><span data-suspend-text>‡∏£‡∏∞‡∏á‡∏±‡∏ö</span></button>
                <span style="flex:1;"></span>
                <button type="button" class="btn btn-icon btn-danger" data-act="del-deco" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">‚úï</button>
            </div>
            <div class="row five-col" style="grid-template-columns: 2fr 1fr 1fr 1.5fr;">
                <div><label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label><select class="field" name="deco_type" required><option value="" hidden>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option><option>‡∏°‡∏π‡∏•‡∏µ‡πà</option><option>‡∏°‡πà‡∏≤‡∏ô‡∏°‡πâ‡∏ß‡∏ô</option><option>‡∏°‡πà‡∏≤‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏á</option><option>‡∏â‡∏≤‡∏Å‡∏Å‡∏±‡πâ‡∏ô‡∏´‡πâ‡∏≠‡∏á</option></select></div>
                <div><label>‡∏Å‡∏ß‡πâ‡∏≤‡∏á(‡∏°.)</label><input class="field" name="deco_width_m" type="number" step="0.01" min="0" required /></div>
                <div><label>‡∏™‡∏π‡∏á(‡∏°.)</label><input class="field" name="deco_height_m" type="number" step="0.01" min="0" required /></div>
                <div><label>‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏ï‡∏£.‡∏´‡∏•‡∏≤</label><input class="field" name="deco_price_sqyd" type="text" inputmode="numeric" required /></div>
            </div>
            <div class="small" data-deco-summary>‡∏£‡∏≤‡∏Ñ‡∏≤: <span class="price">0</span> ‡∏ö. ‚Ä¢ ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: <span class="price">0.00</span> ‡∏ï‡∏£.‡∏´‡∏•‡∏≤</div>
        </div>
    </template>

    <script>
    (function() {
        'use strict';
        const APP_VERSION = "input-ui/3.1.0";
        const WEBHOOK_URL = "https://your-make-webhook-url.com/your-unique-path";
        const STORAGE_KEY = "marnthara.input.v3";
        const SQM_TO_SQYD = 1.19599;

        const PRICING = {
            fabric: [1000, 1200, 1300, 1400, 1500, 1600, 1700, 1800, 1900, 2000, 2100, 2200, 2300, 2400, 2500],
            sheer: [1000, 1100, 1200, 1300, 1400, 1500],
            style_surcharge: { "‡∏•‡∏≠‡∏ô": 200, "‡∏ï‡∏≤‡πÑ‡∏Å‡πà": 0, "‡∏à‡∏µ‡∏ö": 0 },
            height: [{ threshold: 3.2, add_per_m: 300 }, { threshold: 2.8, add_per_m: 200 }, { threshold: 2.5, add_per_m: 150 }],
        };
        const CALC = {
            fabricYardage: (style, width) => {
                if (width <= 0) return 0;
                if (style === "‡∏ï‡∏≤‡πÑ‡∏Å‡πà" || style === "‡∏à‡∏µ‡∏ö") return (width * 2.0 + 0.6) / 0.9;
                if (style === "‡∏•‡∏≠‡∏ô") return (width * 2.6 + 0.6) / 0.9;
                return 0;
            },
        };

        const SELECTORS = {
            orderForm: '#orderForm', roomsContainer: '#rooms', roomTpl: '#roomTpl', setTpl: '#setTpl', decoTpl: '#decoTpl',
            payloadInput: '#payload', copyJsonBtn: '#copyJsonBtn', clearAllBtn: '#clearAllBtn',
            lockBtn: '#lockBtn', addRoomHeaderBtn: '#addRoomHeaderBtn', submitBtn: '#submitBtn',
            grandTotal: '#grandTotal', setCount: '#setCount', grandFabric: '#grandFabric',
            grandSheerFabric: '#grandSheerFabric', grandTrack: '#grandTrack',
            modal: '#confirmationModal', modalTitle: '#modalTitle', modalBody: '#modalBody',
            modalConfirm: '#modalConfirm', modalCancel: '#modalCancel',
            room: '[data-room]', set: '[data-set]', setsContainer: '[data-sets]',
            decorationsContainer: '[data-decorations]', decoItem: '[data-deco-item]',
            sheerWrap: '[data-sheer-wrap]',
            roomNameInput: 'input[name="room_name"]', roomPricePerM: 'select[name="room_price_per_m"]', roomStyle: 'select[name="room_style"]',
        };

        const roomsEl = document.querySelector(SELECTORS.roomsContainer);
        const orderForm = document.querySelector(SELECTORS.orderForm);
        orderForm.action = WEBHOOK_URL;
        
        let roomCount = 0;
        let isLocked = false;
        
        const toNum = v => {
            if (typeof v === 'string') v = v.replace(/,/g, '');
            return Number.isFinite(parseFloat(v)) ? parseFloat(v) : 0;
        };
        const clamp01 = v => Math.max(0, toNum(v));
        const fmt = (n, fixed = 2, asCurrency = false) => {
            if (!Number.isFinite(n)) return "0";
            const options = asCurrency 
                ? { minimumFractionDigits: 0, maximumFractionDigits: 0 } 
                : { minimumFractionDigits: fixed, maximumFractionDigits: fixed };
            return n.toLocaleString("th-TH", options);
        };
        const debounce = (fn, ms = 120) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; };
        const stylePlus = s => PRICING.style_surcharge[s] ?? 0;
        const heightPlus = h => {
            const sorted = [...PRICING.height].sort((a, b) => b.threshold - a.threshold);
            for (const entry of sorted) { if (h > entry.threshold) return entry.add_per_m; }
            return 0;
        };
        
        const showConfirmation = (title, body) => {
            return new Promise((resolve) => {
                const modalEl = document.querySelector(SELECTORS.modal);
                modalEl.querySelector(SELECTORS.modalTitle).textContent = title;
                modalEl.querySelector(SELECTORS.modalBody).textContent = body;
                modalEl.classList.add('visible');
                const cleanup = (result) => {
                    modalEl.classList.remove('visible');
                    modalEl.querySelector(SELECTORS.modalConfirm).onclick = null;
                    modalEl.querySelector(SELECTORS.modalCancel).onclick = null;
                    resolve(result);
                };
                modalEl.querySelector(SELECTORS.modalConfirm).onclick = () => cleanup(true);
                modalEl.querySelector(SELECTORS.modalCancel).onclick = () => cleanup(false);
            });
        };

        function addRoom(prefill) {
            if (isLocked) return;
            roomCount++;
            const frag = document.querySelector(SELECTORS.roomTpl).content.cloneNode(true);
            const room = frag.querySelector(SELECTORS.room);
            room.dataset.index = roomCount;
            populatePriceOptions(room.querySelector(SELECTORS.roomPricePerM), PRICING.fabric);
            roomsEl.appendChild(frag);
            const created = roomsEl.querySelector(`${SELECTORS.room}:last-of-type`);

            if (prefill) {
                created.querySelector(SELECTORS.roomNameInput).value = prefill.room_name || "";
                created.querySelector(SELECTORS.roomPricePerM).value = prefill.price_per_m_raw || "";
                created.querySelector(SELECTORS.roomStyle).value = prefill.style || "";
                (prefill.sets || []).forEach(s => addSet(created, s));
                (prefill.decorations || []).forEach(d => addDeco(created, d));
            }

            if (created.querySelectorAll(SELECTORS.set).length === 0 && created.querySelectorAll(SELECTORS.decoItem).length === 0) addSet(created);
            
            renumber(); recalcAll(); saveData(); updateLockState();
            created.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }

        function populatePriceOptions(selectEl, prices) {
            selectEl.innerHTML = `<option value="" hidden>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>`;
            prices.forEach(p => {
                const option = document.createElement('option');
                option.value = p; option.textContent = p.toLocaleString("th-TH");
                selectEl.appendChild(option);
            });
        }

        function addSet(roomEl, prefill) {
            if (isLocked) return;
            const setsWrap = roomEl.querySelector(SELECTORS.setsContainer);
            const frag = document.querySelector(SELECTORS.setTpl).content.cloneNode(true);
            setsWrap.appendChild(frag);
            const created = setsWrap.querySelector(`${SELECTORS.set}:last-of-type`);
            populatePriceOptions(created.querySelector('select[name="sheer_price_per_m"]'), PRICING.sheer);

            if (prefill) {
                created.querySelector('input[name="width_m"]').value = prefill.width_m ?? "";
                created.querySelector('input[name="height_m"]').value = prefill.height_m ?? "";
                created.querySelector('select[name="fabric_variant"]').value = prefill.fabric_variant || "‡∏ó‡∏∂‡∏ö";
                created.querySelector('select[name="open_type"]').value = prefill.open_type || "";
                created.querySelector('select[name="sheer_price_per_m"]').value = prefill.sheer_price_per_m || "";
                if (prefill.is_suspended) {
                    created.dataset.suspended = 'true';
                    created.classList.add('is-suspended');
                    created.querySelector('[data-suspend-text]').textContent = '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
                }
            }
            toggleSetFabricUI(created); renumber(); recalcAll(); saveData(); updateLockState();
        }
        
        function addDeco(roomEl, prefill) {
            if (isLocked) return;
            const decoWrap = roomEl.querySelector(SELECTORS.decorationsContainer);
            const frag = document.querySelector(SELECTORS.decoTpl).content.cloneNode(true);
            decoWrap.appendChild(frag);
            if (prefill) {
                const created = decoWrap.querySelector(`${SELECTORS.decoItem}:last-of-type`);
                created.querySelector('[name="deco_type"]').value = prefill.type || "";
                created.querySelector('[name="deco_width_m"]').value = prefill.width_m ?? "";
                created.querySelector('[name="deco_height_m"]').value = prefill.height_m ?? "";
                created.querySelector('[name="deco_price_sqyd"]').value = fmt(prefill.price_sqyd, 0, true) ?? "";
                 if (prefill.is_suspended) {
                    created.dataset.suspended = 'true';
                    created.classList.add('is-suspended');
                    created.querySelector('[data-suspend-text]').textContent = '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
                }
            }
            renumber(); recalcAll(); saveData(); updateLockState();
        }

        function toggleSetFabricUI(setEl) {
            const variant = setEl.querySelector('select[name="fabric_variant"]').value;
            const hasSheer = variant === "‡πÇ‡∏õ‡∏£‡πà‡∏á" || variant === "‡∏ó‡∏∂‡∏ö&‡πÇ‡∏õ‡∏£‡πà‡∏á";
            setEl.querySelector(SELECTORS.sheerWrap).classList.toggle("hidden", !hasSheer);
            setEl.querySelector('[data-set-options-row]').classList.toggle("three-col", hasSheer);
            setEl.querySelector("[data-sheer-price-label]").classList.toggle("hidden", !hasSheer);
            setEl.querySelector("[data-sheer-yardage-label]").classList.toggle("hidden", !hasSheer);
            setEl.querySelector("[data-opaque-price-label]").classList.toggle("hidden", variant === "‡πÇ‡∏õ‡∏£‡πà‡∏á");
            setEl.querySelector("[data-opaque-yardage-label]").classList.toggle("hidden", variant === "‡πÇ‡∏õ‡∏£‡πà‡∏á");
        }
        
        function toggleSuspend(btn) {
            const item = btn.closest('.set, .deco-item');
            const isSuspended = !(item.dataset.suspended === 'true');
            item.dataset.suspended = isSuspended;
            item.classList.toggle('is-suspended', isSuspended);
            btn.querySelector('[data-suspend-text]').textContent = isSuspended ? '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡∏£‡∏∞‡∏á‡∏±‡∏ö';
            recalcAll();
            saveData();
        }

        async function delRoom(btn) { if (isLocked || !await showConfirmation('‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á', '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ?')) return; btn.closest(SELECTORS.room).remove(); renumber(); recalcAll(); saveData(); updateLockState(); }
        async function delSet(btn) { if (isLocked || !await showConfirmation('‡∏•‡∏ö‡∏à‡∏∏‡∏î', '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏à‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ?')) return; const room = btn.closest(SELECTORS.room); btn.closest(SELECTORS.set).remove(); if (room.querySelectorAll(SELECTORS.set).length === 0 && room.querySelectorAll(SELECTORS.decoItem).length === 0) addSet(room); renumber(); recalcAll(); saveData(); updateLockState(); }
        async function delDeco(btn) { if (isLocked || !await showConfirmation('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡∏ô‡∏µ‡πâ?')) return; btn.closest(SELECTORS.decoItem).remove(); renumber(); recalcAll(); saveData(); updateLockState(); }
        async function clearSet(btn) { if (isLocked || !await showConfirmation('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ?')) return; const set = btn.closest(SELECTORS.set); set.querySelectorAll('input, select').forEach(el => { el.value = el.name === 'fabric_variant' ? '‡∏ó‡∏∂‡∏ö' : ''; }); toggleSetFabricUI(set); recalcAll(); saveData(); updateLockState(); }
        async function clearAllData() { if (isLocked || !await showConfirmation('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', '‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô! ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ')) return; roomsEl.innerHTML = ""; roomCount = 0; document.querySelectorAll('#customerInfo input').forEach(i => i.value = ""); addRoom(); saveData(); updateLockState(); }

        function renumber() {
            document.querySelectorAll(SELECTORS.room).forEach((room, rIdx) => {
                const input = room.querySelector(SELECTORS.roomNameInput);
                if (input && !input.value) input.placeholder = `‡∏´‡πâ‡∏≠‡∏á ${String(rIdx + 1).padStart(2, "0")}`;
                
                const items = room.querySelectorAll(`${SELECTORS.set}, ${SELECTORS.decoItem}`);
                const totalItems = items.length;
                
                items.forEach((item, iIdx) => {
                    const lbl = item.querySelector("[data-item-title]");
                    if (lbl) lbl.textContent = totalItems > 1 ? `${iIdx + 1}/${totalItems}` : `${iIdx + 1}`;
                });
            });
        }

        function recalcAll() {
            let grand = 0, allSets = 0, grandOpaqueYards = 0, grandSheerYards = 0, grandTrack = 0;

            document.querySelectorAll(SELECTORS.room).forEach((room) => {
                let roomSum = 0, roomUnits = 0, roomOpaqueYards = 0, roomSheerYards = 0, roomTrack = 0;
                
                const baseRaw = toNum(room.querySelector(SELECTORS.roomPricePerM).value);
                const style = room.querySelector(SELECTORS.roomStyle).value;
                const sPlus = stylePlus(style);
                
                room.querySelectorAll(SELECTORS.set).forEach((set) => {
                    if (set.dataset.suspended === 'true') {
                        set.querySelector('[data-set-price-opaque]').textContent = '0';
                        set.querySelector('[data-set-price-sheer]').textContent = '0';
                        return;
                    }
                    const w = clamp01(set.querySelector('input[name="width_m"]').value), h = clamp01(set.querySelector('input[name="height_m"]').value);
                    const hPlus = heightPlus(h), variant = set.querySelector('select[name="fabric_variant"]').value;
                    const hasOpaque = variant !== "‡πÇ‡∏õ‡∏£‡πà‡∏á", hasSheer = variant === "‡πÇ‡∏õ‡∏£‡πà‡∏á" || variant === "‡∏ó‡∏∂‡∏ö&‡πÇ‡∏õ‡∏£‡πà‡∏á";
                    const sheerBase = hasSheer ? clamp01(set.querySelector('select[name="sheer_price_per_m"]').value) : 0;
                    const opaquePerM = hasOpaque ? baseRaw + sPlus + hPlus : 0;
                    const sheerPerM = hasSheer ? sheerBase + sPlus + hPlus : 0;
                    const opaquePrice = Math.round(opaquePerM * w), sheerPrice = Math.round(sheerPerM * w);
                    const total = opaquePrice + sheerPrice, units = (opaquePrice > 0 ? 1 : 0) + (sheerPrice > 0 ? 1 : 0);
                    const yards = CALC.fabricYardage(style, w), track = variant === "‡∏ó‡∏∂‡∏ö&‡πÇ‡∏õ‡∏£‡πà‡∏á" ? w * 2 : w;

                    set.querySelector('[data-set-price-opaque]').textContent = fmt(opaquePrice, 0, true);
                    set.querySelector('[data-set-price-sheer]').textContent = fmt(sheerPrice, 0, true);
                    set.querySelector('[data-set-yardage-opaque]').textContent = fmt(yards, 2);
                    set.querySelector('[data-set-yardage-sheer]').textContent = fmt(yards, 2);
                    set.querySelector('[data-set-track]').textContent = fmt(track, 2);

                    roomSum += total; roomUnits += units;
                    if(hasOpaque) roomOpaqueYards += yards;
                    if(hasSheer) roomSheerYards += yards;
                    if (w > 0 && (hasOpaque || hasSheer)) roomTrack += track;
                    allSets += units;
                });
                
                room.querySelectorAll(SELECTORS.decoItem).forEach(deco => {
                    const summaryEl = deco.querySelector('[data-deco-summary]');
                    if (deco.dataset.suspended === 'true') {
                         summaryEl.innerHTML = `‡∏£‡∏≤‡∏Ñ‡∏≤: <span class="price">0</span> ‡∏ö. ‚Ä¢ ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: <span class="price">0.00</span> ‡∏ï‡∏£.‡∏´‡∏•‡∏≤`;
                         return;
                    }
                    const w = clamp01(deco.querySelector('[name="deco_width_m"]').value), h = clamp01(deco.querySelector('[name="deco_height_m"]').value);
                    const price = clamp01(deco.querySelector('[name="deco_price_sqyd"]').value);
                    const areaSqyd = w * h * SQM_TO_SQYD;
                    const decoPrice = Math.round(areaSqyd * price);
                    summaryEl.innerHTML = `‡∏£‡∏≤‡∏Ñ‡∏≤: <span class="price">${fmt(decoPrice, 0, true)}</span> ‡∏ö. ‚Ä¢ ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: <span class="price">${fmt(areaSqyd, 2)}</span> ‡∏ï‡∏£.‡∏´‡∏•‡∏≤`;
                    roomSum += decoPrice;
                });
                
                const brief = room.querySelector("[data-room-brief]");
                const totalItemsInRoom = room.querySelectorAll(`${SELECTORS.set}, ${SELECTORS.decoItem}`).length;
                if (brief) brief.innerHTML = `‡∏à‡∏∏‡∏î ${fmt(totalItemsInRoom, 0, true)} ‚Ä¢ ‡∏ä‡∏∏‡∏î ${fmt(roomUnits, 0, true)} ‚Ä¢ ‡∏£‡∏≤‡∏Ñ‡∏≤ <span class="num price">${fmt(roomSum, 0, true)}</span> ‡∏ö‡∏≤‡∏ó`;
                
                grand += roomSum; grandOpaqueYards += roomOpaqueYards;
                grandSheerYards += roomSheerYards; grandTrack += roomTrack;
            });
            
            document.querySelector(SELECTORS.grandTotal).textContent = fmt(grand, 0, true);
            document.querySelector(SELECTORS.setCount).textContent = fmt(allSets, 0, true);
            document.querySelector(SELECTORS.grandFabric).textContent = fmt(grandOpaqueYards, 2);
            document.querySelector(SELECTORS.grandSheerFabric).textContent = fmt(grandSheerYards, 2);
            document.querySelector(SELECTORS.grandTrack).textContent = fmt(grandTrack, 2);
        }

        function buildPayload() {
            return {
                customer_name: document.querySelector('input[name="customer_name"]').value || "",
                customer_address: document.querySelector('input[name="customer_address"]').value || "",
                customer_phone: document.querySelector('input[name="customer_phone"]').value || "",
                app_version: APP_VERSION,
                generated_at: new Date().toISOString(),
                rooms: [...document.querySelectorAll(SELECTORS.room)].map(room => ({
                    room_name: room.querySelector(SELECTORS.roomNameInput).value || "",
                    price_per_m_raw: toNum(room.querySelector(SELECTORS.roomPricePerM).value),
                    style: room.querySelector(SELECTORS.roomStyle).value,
                    sets: [...room.querySelectorAll(SELECTORS.set)].map(set => ({
                        width_m: clamp01(set.querySelector('input[name="width_m"]').value),
                        height_m: clamp01(set.querySelector('input[name="height_m"]').value),
                        fabric_variant: set.querySelector('select[name="fabric_variant"]').value,
                        open_type: set.querySelector('select[name="open_type"]').value,
                        sheer_price_per_m: clamp01(set.querySelector('select[name="sheer_price_per_m"]').value),
                        is_suspended: set.dataset.suspended === 'true',
                    })),
                    decorations: [...room.querySelectorAll(SELECTORS.decoItem)].map(deco => ({
                        type: deco.querySelector('[name="deco_type"]').value,
                        width_m: clamp01(deco.querySelector('[name="deco_width_m"]').value),
                        height_m: clamp01(deco.querySelector('[name="deco_height_m"]').value),
                        price_sqyd: clamp01(deco.querySelector('[name="deco_price_sqyd"]').value),
                        is_suspended: deco.dataset.suspended === 'true',
                    }))
                }))
            };
        }

        const debouncedRecalcAndSave = debounce(() => { recalcAll(); saveData(); });
        
        function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(buildPayload())); }

        function updateLockState() {
            const isFormLocked = isLocked || false;
            document.querySelectorAll('input, select, button').forEach(el => {
                const btn = el.closest('button');
                if (btn && btn.id === 'lockBtn') return;
                el.disabled = isFormLocked;
            });
            const lockBtn = document.querySelector(SELECTORS.lockBtn);
            lockBtn.classList.toggle('btn-primary', !isFormLocked);
            lockBtn.classList.toggle('btn-danger', isFormLocked);
            lockBtn.querySelector('.lock-text').textContent = isFormLocked ? '‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ' : '‡∏•‡πá‡∏≠‡∏Ñ';
            lockBtn.querySelector('.lock-icon').textContent = isFormLocked ? 'üîì' : 'üîí';
        }
        
        function toggleLock() { isLocked = !isLocked; updateLockState(); }
        
        function formatNumericInput(e) {
            const input = e.target;
            let val = input.value.replace(/[^0-9]/g, '');
            if (val) {
                input.value = parseInt(val, 10).toLocaleString('th-TH');
            } else {
                input.value = '';
            }
        }

        document.addEventListener("change", debouncedRecalcAndSave);
        document.addEventListener("input", e => {
            if(e.target.matches('[name="deco_price_sqyd"]')) {
                formatNumericInput(e);
            }
            debouncedRecalcAndSave();
        });

        document.addEventListener("click", (e) => {
            const btn = e.target.closest("button");
            if (!btn) return;
            const act = btn.dataset.act;
            if (btn.type !== 'submit') e.preventDefault();
            
            const actions = {
                'del-room': delRoom, 'del-set': delSet, 'del-deco': delDeco,
                'add-set': (b) => addSet(b.closest(SELECTORS.room)),
                'add-deco': (b) => addDeco(b.closest(SELECTORS.room)),
                'clear-set': clearSet, 'toggle-suspend': toggleSuspend
            };
            if (actions[act]) actions[act](btn);
            else if (btn.id === "addRoomHeaderBtn") addRoom();
            else if (btn.id === "clearAllBtn") clearAllData();
            else if (btn.id === "lockBtn") toggleLock();
            else if (btn.id === "copyJsonBtn") navigator.clipboard.writeText(JSON.stringify(buildPayload(), null, 2)).then(() => alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å JSON ‡πÅ‡∏•‡πâ‡∏ß!'));
        });

        orderForm.addEventListener("submit", (e) => {
            if (isLocked) { e.preventDefault(); return; }
            const submitBtn = document.querySelector(SELECTORS.submitBtn);
            submitBtn.disabled = true; submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';
            document.querySelector(SELECTORS.payloadInput).value = JSON.stringify(buildPayload());
            setTimeout(() => { submitBtn.disabled = isLocked; submitBtn.textContent = '‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì'; }, 3000);
        });
        
        window.addEventListener('load', () => {
            const storedData = localStorage.getItem(STORAGE_KEY);
            if (storedData) {
                try {
                    const payload = JSON.parse(storedData);
                    document.querySelector('input[name="customer_name"]').value = payload.customer_name;
                    document.querySelector('input[name="customer_address"]').value = payload.customer_address;
                    document.querySelector('input[name="customer_phone"]').value = payload.customer_phone;
                    roomsEl.innerHTML = ""; roomCount = 0;
                    if (payload.rooms && payload.rooms.length > 0) payload.rooms.forEach(addRoom);
                    else addRoom();
                } catch(err) {
                    console.error("Failed to load data from storage:", err);
                    localStorage.removeItem(STORAGE_KEY);
                    addRoom();
                }
            } else {
                addRoom();
            }
            updateLockState();
        });
    })();
    </script>
</body>
</html>