<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Marnthara Order</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
       margin:12px;max-width:720px}
  h1{font-size:20px;margin:8px 0}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  label{font-size:14px}
  input,select,button{font-size:16px;padding:8px;width:100%}
  .card{border:1px solid #ddd;border-radius:12px;padding:12px;margin:8px 0}
  .muted{color:#666;font-size:14px}
  .right{display:flex;justify-content:flex-end}
  .total{font-weight:700;font-size:18px}
</style>
</head>
<body>
<h1>ใบสั่งงานผ้าม่าน (ห้องเดียวต่อการส่ง)</h1>

<div class="card">
  <div class="row">
    <label>ห้อง
      <select id="room" required>
        <option value="">เลือก</option>
        <option>นอน</option><option>โถง</option>
        <option>นั่งเล่น</option><option>ครัว</option>
      </select>
    </label>
  </div>
</div>

<div id="sets"></div>

<div class="right">
  <button id="add">+ เพิ่มชุดติดตั้ง</button>
</div>

<div class="card">
  <div class="row">
    <div class="total">ราคารวม: <span id="grand">0</span> บาท</div>
  </div>
  <div class="muted">สูตรเบื้องต้น: ราคา/ม. = ราคาเนื้อผ้า +
    ค่ารูปแบบ(+300 สำหรับ ลอน หรือ ตาไก่). ราคาแต่ละชุด =
    กว้าง(ม.) × ราคา/ม.</div>
</div>

<div class="right">
  <button id="submit">ส่งไป Make → Notion</button>
</div>

<script>
const MAKE_WEBHOOK = "https://hook.eu2.make.com/xul3fhuh96ybgfm2omdt2e74ejybxjoj"; //← วาง URL ของคุณ
let counter = 0;

const styleSurcharge = (style) =>
  (style === "ลอน" || style === "ตาไก่") ? 300 : 0;

function addSet(){
  counter++;
  const idx = String(counter).padStart(2,"0");
  const wrap = document.createElement("div");
  wrap.className = "card";
  wrap.dataset.idx = idx;
  wrap.innerHTML = `
    <div class="row"><strong>ชุดที่ ${idx}</strong></div>
    <div class="row">
      <label>สไตล์
        <select class="style" required>
          <option value="">เลือก</option>
          <option>ลอน</option><option>ตาไก่</option><option>จีบ</option>
        </select>
      </label>
      <label>ชนิดผ้า
        <select class="fabricKind" required>
          <option value="">เลือก</option>
          <option>ทึบ</option><option>โปร่ง</option>
        </select>
      </label>
      <label>ราคาผ้า/เมตร (บาท)
        <select class="fabricRate" required>
          <option value="">เลือก</option>
          <option>1200</option><option>1500</option><option>1800</option>
        </select>
      </label>
    </div>
    <div class="row">
      <label>กว้าง (เมตร)
        <input type="number" step="0.01" min="0" class="width" required/>
      </label>
      <label>สูง (เมตร)
        <input type="number" step="0.01" min="0" class="height"/>
      </label>
    </div>
    <div class="row">
      <div>ราคาชุดนี้: <strong><span class="lineTotal">0</span> บาท</strong></div>
      <div class="muted">คิด = กว้าง × (ราคาผ้า/ม. + ค่ารูปแบบ)</div>
    </div>
    <div class="right"><button class="remove">ลบชุดนี้</button></div>
  `;
  document.getElementById("sets").appendChild(wrap);
  wrap.addEventListener("input", recalc);
  wrap.querySelector(".remove").onclick = () => { wrap.remove(); recalc(); };
}

function recalc(){
  let grand = 0;
  document.querySelectorAll("#sets .card").forEach(card=>{
    const w = parseFloat(card.querySelector(".width").value || "0");
    const rate = parseFloat(card.querySelector(".fabricRate").value || "0");
    const style = card.querySelector(".style").value || "";
    const unit = rate + styleSurcharge(style);
    const line = Math.round(w * unit);
    card.querySelector(".lineTotal").textContent = isFinite(line)? line:0;
    grand += isFinite(line)? line:0;
  });
  document.getElementById("grand").textContent = grand;
}

async function submitForm(){
  const room = document.getElementById("room").value;
  if(!room){ alert("เลือกห้อง"); return; }
  const sets = [];
  document.querySelectorAll("#sets .card").forEach(card=>{
    const idx = card.dataset.idx;
    const style = card.querySelector(".style").value;
    const fabricKind = card.querySelector(".fabricKind").value;
    const rate = parseFloat(card.querySelector(".fabricRate").value||"0");
    const width = parseFloat(card.querySelector(".width").value||"0");
    const height = parseFloat(card.querySelector(".height").value||"0");
    const unit = rate + styleSurcharge(style);
    const price = Math.round(width * unit);
    sets.push({no: idx, style, fabricKind, rate, width, height,
               unit_price_per_m: unit, price});
  });
  if(sets.length===0){ alert("เพิ่มอย่างน้อย 1 ชุด"); return; }
  const total = sets.reduce((s,x)=>s+x.price,0);

  const payload = { room, total_price: total, sets };
  try{
    const res = await fetch(MAKE_WEBHOOK, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    if(!res.ok) throw new Error("send failed");
    alert("ส่งแล้ว");
  }catch(e){
    alert("ส่งไม่สำเร็จ");
  }
}

document.getElementById("add").onclick = addSet;
document.getElementById("submit").onclick = submitForm;
addSet(); // เริ่มด้วยชุดที่ 01
</script>
</body>
</html>
