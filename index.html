<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Marnthara Multi-Room Order</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:12px;max-width:860px}
  h1{font-size:20px;margin:8px 0}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  label{font-size:14px;flex:1 1 180px}
  input,select,button{font-size:16px;padding:8px;width:100%}
  .card{border:1px solid #ddd;border-radius:10px;padding:12px;margin:8px 0;background:#fff}
  .muted{color:#666;font-size:13px}
  .right{display:flex;justify-content:flex-end}
  .total{font-weight:700;font-size:18px}
  .room-header{display:flex;gap:8px;align-items:center}
  .room-list{margin-bottom:12px}
</style>
</head>
<body>
<h1>Marnthara — ใบสั่งงาน (หลายห้อง)</h1>

<div class="right">
  <button id="addRoom">+ เพิ่มห้อง</button>
</div>

<div id="rooms" class="room-list"></div>

<div class="card">
  <div class="row">
    <div class="total">ราคารวมทั้งหมด: <span id="grand">0</span> บาท</div>
  </div>
  <div class="muted">สูตร: ราคา/ม. = ราคาผ้า/ม. + ค่ารูปแบบ(+300 เมื่อเป็น ลอน). ชุด : กว้าง(ม.) × ราคา/ม.</div>
</div>

<div class="right">
  <button id="submit">ส่งไป Make → Notion</button>
</div>

<script>
const MAKE_WEBHOOK = "https://hook.eu2.make.com/xul3fhuh96ybgfm2omdt2e74ejybxjoj"; // ← แทนด้วย webhook จริง
let roomCounter = 0;

function fabricRateOptionsHTML(){
  let html = '<option value="">เลือก</option>';
  for(let r=1000;r<=2500;r+=100){
    html += `<option value="${r}">${r}</option>`;
  }
  return html;
}

function addRoom(){
  roomCounter++;
  const rid = String(roomCounter).padStart(2,'0');
  const wrap = document.createElement('div');
  wrap.className = 'card room';
  wrap.dataset.rid = rid;
  wrap.innerHTML = `
    <div class="room-header">
      <strong>ห้อง ${rid}</strong>
      <label style="flex:1">
        ประเภทห้อง
        <select class="roomType">
          <option value="">เลือก</option>
          <option>นอน</option><option>โถง</option><option>นั่งเล่น</option><option>ครัว</option><option>อื่นๆ</option>
        </select>
      </label>
      <label style="flex:1">
        ชื่อห้อง (ถ้าต้องการ)
        <input class="roomLabel" placeholder="เช่น ห้องนอนใหญ่"/>
      </label>
      <button class="removeRoom">ลบห้อง</button>
    </div>
    <div class="sets"></div>
    <div class="right" style="margin-top:8px">
      <button class="addSet">+ เพิ่มชุดติดตั้ง</button>
    </div>
  `;
  document.getElementById('rooms').appendChild(wrap);

  wrap.querySelector('.removeRoom').onclick = () => { wrap.remove(); recalc(); };
  wrap.querySelector('.addSet').onclick = ()=> addSet(wrap);
  addSet(wrap);
}

function addSet(roomEl){
  const setsDiv = roomEl.querySelector('.sets');
  const sidx = setsDiv.children.length + 1;
  const setCard = document.createElement('div');
  setCard.className = 'card';
  setCard.style.margin = '8px 0';
  setCard.innerHTML = `
    <div class="row">
      <label>สไตล์
        <select class="style">
          <option value="">เลือก</option>
          <option>ลอน</option><option>ตาไก่</option><option>จีบ</option>
        </select>
      </label>
      <label>ชนิดผ้า
        <select class="fabricKind">
          <option value="">เลือก</option>
          <option>ทึบ</option><option>โปร่ง</option>
        </select>
      </label>
      <label>ราคาผ้า/เมตร
        <select class="fabricRate">
          ${fabricRateOptionsHTML()}
        </select>
      </label>
    </div>
    <div class="row">
      <label>กว้าง (ม.)
        <input type="number" step="0.01" min="0" class="width" placeholder="เช่น 3.50"/>
      </label>
      <label>สูง (ม.)
        <input type="number" step="0.01" min="0" class="height" placeholder="เช่น 2.80"/>
      </label>
      <label>หมายเหตุ
        <input class="note" placeholder="เช่น หน้าต่าง 2 บาน"/>
      </label>
    </div>
    <div class="row">
      <div>ราคาชุดนี้: <strong><span class="lineTotal">0</span> บาท</strong></div>
      <div class="muted">คิด = กว้าง × (ราคาผ้า/ม. + ค่ารูปแบบ)</div>
    </div>
    <div class="right"><button class="removeSet">ลบชุด</button></div>
  `;
  setsDiv.appendChild(setCard);

  setCard.querySelector('.removeSet').onclick = ()=> { setCard.remove(); recalc(); };
  setCard.addEventListener('input', recalc);
  recalc();
}

function styleSurcharge(style){
  return style === 'ลอน' ? 300 : 0;
}

function recalc(){
  let grand = 0;
  document.querySelectorAll('#rooms .card.room').forEach(room=>{
    room.querySelectorAll('.sets .card').forEach(set=>{
      const w = parseFloat(set.querySelector('.width').value || '0');
      const rate = parseFloat(set.querySelector('.fabricRate').value || '0');
      const style = set.querySelector('.style').value || '';
      const unit = (isFinite(rate) ? rate : 0) + styleSurcharge(style);
      const line = Math.round(w * unit);
      set.querySelector('.lineTotal').textContent = isFinite(line) ? line : 0;
      grand += isFinite(line) ? line : 0;
    });
  });
  document.getElementById('grand').textContent = grand;
}

async function submitForm(){
  const rooms = [];
  document.querySelectorAll('#rooms .card.room').forEach(room=>{
    const type = room.querySelector('.roomType').value || '';
    const label = room.querySelector('.roomLabel').value || '';
    const sets = [];
    room.querySelectorAll('.sets .card').forEach(set=>{
      const style = set.querySelector('.style').value || '';
      const fabricKind = set.querySelector('.fabricKind').value || '';
      const rate = parseFloat(set.querySelector('.fabricRate').value || '0');
      const width = parseFloat(set.querySelector('.width').value || '0');
      const height = parseFloat(set.querySelector('.height').value || '0');
      const note = set.querySelector('.note').value || '';
      const unit = (isFinite(rate) ? rate : 0) + styleSurcharge(style);
      const price = Math.round(width * unit);
      sets.push({style,fabricKind,rate,width,height,note,unit_price_per_m:unit,price});
    });
    if(sets.length>0) rooms.push({type,label,sets});
  });
  if(rooms.length===0){ alert('ยังไม่มีชุดติดตั้งใด ๆ'); return; }
  const total = rooms.flatMap(r=>r.sets).reduce((s,x)=>s+x.price,0);
  const payload = {rooms, total_price: total, submitted_at: new Date().toISOString()};
  try{
    const res = await fetch(MAKE_WEBHOOK, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if(!res.ok) throw new Error('send failed');
    alert('ส่งเรียบร้อย');
  }catch(e){
    console.error(e);
    alert('ส่งไม่สำเร็จ ดู console หรือ network');
  }
}

document.getElementById('addRoom').onclick = addRoom;
document.getElementById('submit').onclick = submitForm;
addRoom();
</script>
</body>
</html>
