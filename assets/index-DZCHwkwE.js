(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))r(a);new MutationObserver(a=>{for(const n of a)if(n.type==="childList")for(const s of n.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function o(a){const n={};return a.integrity&&(n.integrity=a.integrity),a.referrerPolicy&&(n.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?n.credentials="include":a.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function r(a){if(a.ep)return;a.ep=!0;const n=o(a);fetch(a.href,n)}})();const at="6.0.0",st="https://your-make-webhook-url.com/your-unique-path",pe="marnthara.input.v6",lt=500,ke={name:"ม่านธารา ผ้าม่านและของตกแต่ง",phone:"092-985-9395, 082-552-5595",baseVatRate:.07},ct=1.19599,ge={ROLL_WIDTH_M:.53,ROLL_LENGTH_M:10,STRIPS_PER_ROLL_UNDER_2_5M:3},ye={fabric:[1e3,1100,1200,1300,1400,1500,1600,1700,1800,1900,2e3,2100,2200],sheer:[1e3,1100,1200,1300,1400,1500],style_surcharge:{ลอน:200,ตาไก่:0,จีบ:0},height:[{threshold:3.2,add_per_m:300},{threshold:2.8,add_per_m:200},{threshold:2.5,add_per_m:100}]},h={orderForm:"#orderForm",roomsContainer:"#rooms",setTpl:"#setTpl",wallTpl:"#wallTpl",clearAllBtn:"#clearAllBtn",lockBtn:"#lockBtn",grandTotal:"#grandTotal",modal:"#confirmationModal",modalTitle:"#modalTitle",modalBody:"#modalBody",room:"[data-room]",allItemsContainer:"[data-all-items]",wallsContainer:"[data-walls-container]",sheerWrap:"[data-sheer-wrap]",sheerCodeWrap:"[data-sheer-code-wrap]",roomNameInput:'input[name="room_name"]',toastContainer:"#toast-container",copyTextBtn:"#copyTextBtn",copyOptionsModal:"#copyOptionsModal",menuBtn:"#menuBtn",menuDropdown:"#menuDropdown",importBtn:"#importBtn",exportBtn:"#exportBtn",fileImporter:"#fileImporter",submitBtn:"#submitBtn",clearItemsBtn:"#clearItemsBtn",exportPdfBtn:"#exportPdfBtn",exportOptionsModal:"#exportOptionsModal",printableContent:"#printable-content",quickNavBtn:"#quickNavBtn",quickNavDropdown:"#quickNavDropdown",quickNavRoomList:"#quickNavRoomList",toggleAllRoomsBtn:"#toggleAllRoomsBtn"},_=e=>{typeof e=="string"&&(e=e.replace(/,/g,""));const t=parseFloat(e);return Number.isFinite(t)?t:0},z=e=>{const t=_(e);return t>0?t.toFixed(2):""},X=(e,t=2,o=!1)=>Number.isFinite(e)?e.toLocaleString("en-US",{minimumFractionDigits:o?2:t,maximumFractionDigits:o?2:t}):"0",k=(e,t=0)=>Number.isFinite(e)?e.toLocaleString("th-TH",{minimumFractionDigits:t,maximumFractionDigits:t}):"0",it=(e,t=150)=>{let o;return(...r)=>{clearTimeout(o),o=setTimeout(()=>e(...r),t)}},ut=(e,t=700)=>{let o=!1;return(...r)=>{if(!o){o=!0;try{return e(...r)}finally{setTimeout(()=>{o=!1},t)}}}},x=e=>{if(typeof e!="string")return"";const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,o=>t[o])},Ye=e=>typeof e!="string"?"":e.replace(/[\\/?%*:|"<>\x00-\x1f]/g,"").trim()||"file",Be="marnthara.favorites.v5",U={fabric:[],sheer:[],wallpaper:[],wooden_blind:[],roller_blind:[],vertical_blind:[],partition:[],pleated_screen:[],aluminum_blind:[]};function Y(){try{const e=localStorage.getItem(Be);return e?{...U,...JSON.parse(e)}:{...U}}catch(e){return console.error("Failed to parse favorites from localStorage",e),{...U}}}function ve(e){try{localStorage.setItem(Be,JSON.stringify(e))}catch(t){console.error("Failed to save favorites to localStorage",t)}}function De(e){if(!e||typeof e!="object")return console.error("Invalid favorites data for import."),!1;const t={...U};for(const o in U)Object.hasOwnProperty.call(e,o)&&Array.isArray(e[o])&&(t[o]=e[o]);return ve(t),!0}function Je(e){if(!e||typeof e!="object")return console.error("Invalid favorites data for merge."),0;const t=Y();let o=0;for(const r in U)Object.hasOwnProperty.call(e,r)&&Array.isArray(e[r])&&(t[r]||(t[r]=[]),e[r].forEach(a=>{a&&a.code&&(t[r].some(s=>s.code===a.code)||(t[r].push(a),o++))}),t[r].sort((a,n)=>a.code.localeCompare(n.code)));return o>0&&ve(t),o}function dt(e,t,o){if(!t||!e||!U.hasOwnProperty(e))return!1;const r=Y(),a=r[e],n=a.findIndex(s=>s.code===t);return n>-1?a[n].price=o:a.push({code:t,price:o}),a.sort((s,l)=>s.code.localeCompare(l.code)),ve(r),!0}function Te(e,t){if(!t||!e||!U.hasOwnProperty(e))return!1;const o=Y(),r=o[e],a=r.findIndex(n=>n.code===t);return a>-1?(r.splice(a,1),ve(o),!0):!1}function Ke(e,t){if(!e||!t)return;const o=Y(),r=t.trim();return(o[e]||[]).find(n=>n.code===r)}function Qe(e,t){return!!Ke(e,t)}function Se(e,t,o){const r=t.trim();return r?Qe(e,r)?(Te(e,r),!1):(dt(e,r,o),!0):!1}function mt(){localStorage.removeItem(Be)}function B(){var o,r,a,n,s,l;const e=Y(),t={app_version:at,customer_name:((o=document.querySelector('[name="customer_name"]'))==null?void 0:o.value)||"",customer_phone:((r=document.querySelector('[name="customer_phone"]'))==null?void 0:r.value)||"",customer_address:((a=document.querySelector('[name="customer_address"]'))==null?void 0:a.value)||"",customer_card_open:(n=document.querySelector("#customerDetailsCard"))==null?void 0:n.open,discount:{type:((s=document.querySelector("#discount_type"))==null?void 0:s.value)||"amount",value:_((l=document.querySelector("#discount_value"))==null?void 0:l.value)},rooms:[],favorites:e};return document.querySelectorAll(h.room).forEach(m=>{var d,p;const i={id:m.id,room_name:((d=m.querySelector(h.roomNameInput))==null?void 0:d.value)||"",is_suspended:m.classList.contains("is-suspended"),is_open:m.open,items:[]};(p=m.querySelector(h.allItemsContainer))==null||p.childNodes.forEach(c=>{var u,v,g,b,q,w,L,M,C,A,R,j,K,D,oe,Q,W,ne,Ae,Pe,Ne,Re,Oe,Fe,He,je;if(c.nodeType!==1||!c.matches(".item-card"))return;const y=c.dataset.type;if(!y)return;const f={type:y,is_suspended:c.classList.contains("is-suspended")};y==="set"?Object.assign(f,{width_m:_((u=c.querySelector('input[name="width_m"]'))==null?void 0:u.value),height_m:_((v=c.querySelector('input[name="height_m"]'))==null?void 0:v.value),style:((g=c.querySelector('select[name="set_style"]'))==null?void 0:g.value)||"",fabric_variant:((b=c.querySelector('select[name="fabric_variant"]'))==null?void 0:b.value)||"",price_per_m_raw:_((q=c.querySelector('select[name="set_price_per_m"]'))==null?void 0:q.value),sheer_price_per_m:_((w=c.querySelector('select[name="sheer_price_per_m"]'))==null?void 0:w.value),fabric_code:((L=c.querySelector('input[name="fabric_code"]'))==null?void 0:L.value)||"",sheer_fabric_code:((M=c.querySelector('input[name="sheer_fabric_code"]'))==null?void 0:M.value)||"",opening_style:((C=c.querySelector('select[name="opening_style"]'))==null?void 0:C.value)||"",track_color:((A=c.querySelector('input[name="track_color"]'))==null?void 0:A.value)||"ขาว",bracket_color:((R=c.querySelector('input[name="bracket_color"]'))==null?void 0:R.value)||"ขาว",finial_color:((j=c.querySelector('input[name="finial_color"]'))==null?void 0:j.value)||"ขาว",grommet_color:((K=c.querySelector('input[name="grommet_color"]'))==null?void 0:K.value)||"เงิน",notes:((D=c.querySelector('input[name="notes"]'))==null?void 0:D.value)||""}):y==="wallpaper"?Object.assign(f,{height_m:_((oe=c.querySelector('[name="wallpaper_height_m"]'))==null?void 0:oe.value),wallpaper_code:((Q=c.querySelector('[name="wallpaper_code"]'))==null?void 0:Q.value)||"",price_per_roll:_((W=c.querySelector('[name="wallpaper_price_roll"]'))==null?void 0:W.value),install_cost_per_roll:_((ne=c.querySelector('[name="wallpaper_install_cost"]'))==null?void 0:ne.value),notes:((Ae=c.querySelector('[name="wallpaper_notes"]'))==null?void 0:Ae.value)||"",widths:Array.from(c.querySelectorAll('[name="wall_width_m"]')).map(nt=>_(nt.value))}):c.matches(".area-based-item")&&(Object.assign(f,{width_m:_((Pe=c.querySelector('[name="area_width_m"]'))==null?void 0:Pe.value),height_m:_((Ne=c.querySelector('[name="area_height_m"]'))==null?void 0:Ne.value),price_sqyd:_((Re=c.querySelector('[name="area_price_sqyd"]'))==null?void 0:Re.value),code:((Oe=c.querySelector('[name="area_code"]'))==null?void 0:Oe.value)||"",notes:((Fe=c.querySelector('[name="area_notes"]'))==null?void 0:Fe.value)||""}),(y==="partition"||y==="pleated_screen")&&(f.opening_style=((He=c.querySelector('select[name="opening_style"]'))==null?void 0:He.value)||"แยกกลาง"),["wooden_blind","roller_blind","vertical_blind","aluminum_blind"].includes(y)&&(f.adjustment_side=((je=c.querySelector('select[name="adjustment_side"]'))==null?void 0:je.value)||"ปรับขวา")),i.items.push(f)}),t.rooms.push(i)}),t}function I(){try{localStorage.setItem(pe,JSON.stringify(B()))}catch(e){console.error("Failed to save data to localStorage:",e)}}const T={stylePlus:e=>ye.style_surcharge[e]??0,heightPlus:e=>{const t=[...ye.height].sort((o,r)=>r.threshold-o.threshold);for(const o of t)if(e>o.threshold)return o.add_per_m;return 0},fabricYardage:(e,t)=>{const o=_(t);return o<=0||!e?0:e==="ตาไก่"||e==="จีบ"?(o*2+.6)/.9:e==="ลอน"?(o*2.6+.6)/.9:0},calculateGrommets:function(e){if(!e||e.style!=="ตาไก่"||_(e.width_m)<=0)return 0;const t=_(e.width_m),o=2,r=.05,a=.16;let n;e.opening_style==="แยกกลาง"?n=t/2:n=t;const s=n*o+2*r;let l=Math.round(s/a);return l%2!==0&&(l+=1),l<4&&(l=4),e.opening_style==="แยกกลาง"?l*2:l},wallpaperRolls:(e,t)=>{const o=_(e),r=_(t);if(o<=0||r<=0)return 0;const a=r>2.5?Math.floor(ge.ROLL_LENGTH_M/r):ge.STRIPS_PER_ROLL_UNDER_2_5M;if(a<=0)return 0;const n=Math.ceil(o/ge.ROLL_WIDTH_M);return Math.ceil(n/a)},calculateSetPrice:function(e){var s,l;if(!e||e.is_suspended||_(e.width_m)<=0)return{total:0,opaque:0,sheer:0};const t=this.stylePlus(e.style),o=this.heightPlus(_(e.height_m)),r=_(e.width_m),a=(s=e.fabric_variant)!=null&&s.includes("ทึบ")&&_(e.price_per_m_raw)>0?(_(e.price_per_m_raw)+t+o)*r:0,n=(l=e.fabric_variant)!=null&&l.includes("โปร่ง")&&_(e.sheer_price_per_m)>0?(_(e.sheer_price_per_m)+t+o)*r:0;return{total:Math.round(a+n),opaque:Math.round(a),sheer:Math.round(n)}},calculateDecoPrice:function(e){if(!e||e.is_suspended||_(e.width_m)<=0||_(e.height_m)<=0)return{total:0,sqm:0,sqyd:0};const t=_(e.width_m)*_(e.height_m),o=t*ct,r=o*_(e.price_sqyd);return{total:Math.round(r),sqm:t,sqyd:o}},calculateWallpaperPrice:function(e){var s;if(!e||e.is_suspended)return{total:0,material:0,install:0,rolls:0,sqm:0};const t=((s=e.widths)==null?void 0:s.reduce((l,m)=>l+_(m),0))||0;if(t<=0)return{total:0,material:0,install:0,rolls:0,sqm:0};const o=_(e.height_m),r=this.wallpaperRolls(t,o),a=r*_(e.price_per_roll),n=r*_(e.install_cost_per_roll??300);return{total:Math.round(a+n),material:Math.round(a),install:Math.round(n),rolls:r,sqm:t*o}}},he={set:"ผ้าม่าน",wallpaper:"วอลล์เปเปอร์",wooden_blind:"มู่ลี่ไม้",roller_blind:"ม่านม้วน",vertical_blind:"ม่านปรับแสง",partition:"ฉากกั้นห้อง",pleated_screen:"มุ้งจีบ",aluminum_blind:"มู่ลี่อลูมิเนียม"};function pt(e){let t=`
📃 *สรุปรายการสินค้า*
`,o=!1;return e.rooms.forEach(r=>{if(r.is_suspended||!r.items)return;const a=r.items.filter(n=>!n.is_suspended&&(_(n.width_m)>0||n.type==="wallpaper"&&(n.widths||[]).reduce((s,l)=>s+_(l),0)>0));a.length!==0&&(o=!0,t+=`
*🚪 ห้อง: ${r.room_name||"ไม่ระบุ"}*
`,a.forEach((n,s)=>{const l=he[n.type]||"สินค้าตกแต่ง";t+=` ${s+1}) ${l}${n.type==="set"?` ${n.style} (${n.fabric_variant})`:""}
`}))}),o?t+`------------------------------
`:""}function ze(e){return e.rooms.reduce((t,o)=>{var a;if(o.is_suspended)return t;const r=((a=o.items)==null?void 0:a.reduce((n,s)=>{if(s.is_suspended)return n;switch(s.type){case"set":return n+T.calculateSetPrice(s).total;case"wallpaper":return n+T.calculateWallpaperPrice(s).total;default:return n+T.calculateDecoPrice(s).total}},0))||0;return t+r},0)}function ft(e,t){var l,m;const o=ze(e),r=((l=e.discount)==null?void 0:l.value)>0?e.discount.value:0,a=((m=e.discount)==null?void 0:m.type)==="percent"?o*(r/100):r,n=o-a;let s=`🗓️ สรุปข้อมูล (${new Date().toLocaleDateString("th-TH",{day:"numeric",month:"short",year:"2-digit"})})
`;return s+=`👤 ลูกค้า: ${e.customer_name||"-"}
`,(t==="customer"||t==="owner")&&(s+=`📞 โทร: ${e.customer_phone||"-"}
🏠 ที่อยู่: ${e.customer_address||"-"}
`),s+=`------------------------------
`,t==="customer"&&(s+=pt(e),a>0&&(s+=`
ยอดรวม: ${k(o)} บาท
`,s+=`🏷️ ส่วนลด${e.discount.type==="percent"?` (${e.discount.value}%)`:""}: -${k(a)} บาท
`),s+=`
💰 *ยอดสุทธิ: ${k(n)} บาท*

ขอบคุณที่ใช้บริการค่ะ
${ke.name}
โทร: ${ke.phone}`),s}function yt(e){if(!e.rooms||e.rooms.length===0)return'<p class="empty-summary">ไม่มีข้อมูลสำหรับแสดงผล</p>';const t=e.rooms.reduce((a,n)=>(n.is_suspended||!n.items||n.items.forEach(s=>{if(s.is_suspended)return;(s.type==="set"?T.calculateSetPrice(s).total:s.type==="wallpaper"?T.calculateWallpaperPrice(s).total:T.calculateDecoPrice(s).total)>0&&(a[s.type]=(a[s.type]||0)+1)}),a),{}),o=Object.entries(t).map(([a,n])=>`<span class="summary-tag" data-filter-type="${x(a)}" title="คลิกเพื่อกรองเฉพาะรายการนี้">${x(he[a]||"ของตกแต่ง")} <strong>${n}</strong></span>`).join("");let r="";return e.rooms.forEach(a=>{if(a.is_suspended||!a.items)return;const n={};let s=0;if(a.items.forEach(l=>{if(l.is_suspended)return;(l.type==="set"?T.calculateSetPrice(l).total:l.type==="wallpaper"?T.calculateWallpaperPrice(l).total:T.calculateDecoPrice(l).total)>0&&(n[l.type]=(n[l.type]||0)+1,s++)}),s>0){const l=Object.entries(n).map(([m,i])=>`<div class="overview-item"><span>${x(he[m]||"ของตกแต่ง")}</span><span>${i}</span></div>`).join("");r+=`<details class="overview-room-card"><summary class="overview-room-summary"><span class="room-name">${x(a.room_name)||"ไม่ระบุชื่อห้อง"}</span><div class="summary-tags"><span class="room-item-count">${s} รายการ</span><i class="ph ph-caret-down expand-icon"></i></div></summary><div class="overview-room-items">${l}</div></details>`}}),!o&&!r?'<p class="empty-summary">ไม่มีรายการที่มีราคาสำหรับแสดงผล</p>':`
        ${o?`<div class="overview-summary-group"><h4><i class="ph ph-stack"></i> สรุปประเภทรายการ</h4><div class="summary-tags-container">${o}</div></div>`:""}
        ${r?`<div class="overview-breakdown-group"><h4><i class="ph ph-map-pin-line"></i> แจกแจงตามห้อง</h4>${r}</div>`:""}
    `}function ht(e,t){var u,v;const{pageBreakBuffer:o=3}=t,r=[];e.rooms.forEach(g=>{if(g.is_suspended||!g.items)return;const b=[];g.items.forEach(q=>{if(q.is_suspended)return;let w,L,M,C,A=1;const R=he[q.type]||"สินค้าตกแต่ง";switch(q.type){case"set":L=T.calculateSetPrice(q).total,L>0&&(M=_(q.width_m),C=_(q.height_m),w=`${R} ${x(q.style)} (${x(q.fabric_variant)})<br><small>ขนาด ${M.toFixed(2)}x${C.toFixed(2)} ม.</small>`,A=1.5,b.push({description:w,total:L,units:A}));break;case"wallpaper":L=T.calculateWallpaperPrice(q).total,L>0&&(C=_(q.height_m),w=`${R}<br><small>รหัส: ${x(q.wallpaper_code)||"-"}, สูง ${C.toFixed(2)} ม.</small>`,A=1.5,b.push({description:w,total:L,units:A}));break;default:L=T.calculateDecoPrice(q).total,L>0&&(M=_(q.width_m),C=_(q.height_m),w=`${R}<br><small>รหัส: ${x(q.code)||"-"}, ขนาด ${M.toFixed(2)}x${C.toFixed(2)} ม.</small>`,A=1.5,b.push({description:w,total:L,units:A}));break}}),b.length>0&&(r.push({isRoomHeader:!0,roomName:x(g.room_name)||"ไม่ระบุชื่อห้อง",units:1.2}),r.push(...b))});const a=r.reduce((g,b)=>g+(b.total||0),0);if(a===0)return null;const n=((u=e.discount)==null?void 0:u.value)>0?e.discount.value:0;((v=e.discount)==null?void 0:v.type)==="percent"&&a*(n/100);const s={first:17,subsequent:23},l=[];let m=[],i=0;r.forEach((g,b)=>{const q=l.length===0?s.first:s.subsequent,w=q-(i+g.units)<o&&b<r.length-1;(i+g.units>q||w)&&m.length>0&&(l.push(m),m=[],i=0),m.push(g),i+=g.units}),m.length>0&&l.push(m);const d=new Date;d.toLocaleDateString("th-TH",{year:"numeric",month:"long",day:"numeric"});const p=`QT-${d.getFullYear()}${(d.getMonth()+1).toString().padStart(2,"0")}${d.getDate().toString().padStart(2,"0")}`;let c="",y=0,f=1;return l.forEach((g,b)=>{const q=b===0,w=b===l.length-1;let L=q?"":`<tr class="pdf-subtotal-row"><td colspan="4">ยอดยกมา</td><td class="pdf-text-right">${X(y,2,!0)}</td></tr>`;g.forEach(M=>{M.isRoomHeader?L+=`<tr class="pdf-room-header"><td colspan="5">ห้อง: ${M.roomName}</td></tr>`:(L+=`<tr><td class="pdf-text-center">${f++}</td><td>${M.description}</td><td class="pdf-text-center">1</td><td class="pdf-text-right">${X(M.total,2,!0)}</td><td class="pdf-text-right">${X(M.total,2,!0)}</td></tr>`,y+=M.total)}),w||`${X(y,2,!0)}`,c+='<div class="pdf-page">...</div>'}),{html:`<div id="quotation-template">${c}</div>`,fileName:`${p}_${Ye(e.customer_name||"quote")}`}}function vt(e){var s,l;const t=ze(e),o=((s=e.discount)==null?void 0:s.value)>0?e.discount.value:0;((l=e.discount)==null?void 0:l.type)==="percent"&&t*(o/100);let r=!1,a=e.rooms.map(m=>{if(m.is_suspended)return"";const i=m.items.filter(p=>!p.is_suspended&&(_(p.width_m)>0||p.type==="wallpaper"&&(p.widths||[]).reduce((c,y)=>c+_(y),0)>0));if(i.length===0)return"";r=!0;const d=i.map((p,c)=>"...").join('<hr class="lookbook-hr">');return`<div class="lookbook-room"><h4><i class="ph ph-map-pin"></i> ${x(m.room_name)}</h4>${d}</div>`}).join("");return r?"..."+a:'<p class="empty-summary">ไม่มีรายการสำหรับสร้างรายงาน</p>'}const se=[],_t=10;function Z(e){se.length>=_t&&se.shift(),se.push(e)}function gt(){return se.pop()}function St(){return se.length>0}let F=!1,V=null,E=null,de=null,le=!1,P=null,qe=null,be=!1,te=null;const We=document.querySelector("#undoBtn"),me={};function qt(e){if(me[e])return me[e];const t=new Promise((o,r)=>{const a=document.createElement("script");a.src=e,a.onload=()=>{console.log(`${e} loaded successfully.`),o()},a.onerror=()=>{console.error(`Script load error for ${e}`),delete me[e],r(new Error(`Script load error for ${e}`))},document.head.appendChild(a)});return me[e]=t,t}const ee={set:{templateId:"#setTpl",name:"ผ้าม่าน"},wallpaper:{templateId:"#wallpaperTpl",name:"วอลล์เปเปอร์"},wooden_blind:{templateId:"#areaBasedTpl",name:"มู่ลี่ไม้"},roller_blind:{templateId:"#areaBasedTpl",name:"ม่านม้วน"},vertical_blind:{templateId:"#areaBasedTpl",name:"ม่านปรับแสง"},partition:{templateId:"#areaBasedTpl",name:"ฉากกั้นห้อง"},pleated_screen:{templateId:"#areaBasedTpl",name:"มุ้งจีบ"},aluminum_blind:{templateId:"#areaBasedTpl",name:"มู่ลี่อลูมิเนียม"}},bt={มู่ลี่ไม้:"wooden_blind",ม่านม้วน:"roller_blind",ม่านปรับแสง:"vertical_blind",ฉากกั้นห้อง:"partition",มุ้งจีบ:"pleated_screen",มู่ลี่อลูมิเนียม:"aluminum_blind"},Ie="marnthara.theme";function Xe(){const e=localStorage.getItem(Ie),t=document.querySelector("#themeToggleBtn");if(!t)return;const o=t.querySelector("i"),r=t.querySelector("span");switch(document.body.classList.remove("dark-theme","neutral-theme"),e){case"dark":document.body.classList.add("dark-theme"),o&&(o.className="ph-fill ph-sun"),r&&(r.textContent=" สว่าง");break;case"neutral":document.body.classList.add("neutral-theme"),o&&(o.className="ph-fill ph-moon"),r&&(r.textContent=" มืด");break;default:o&&(o.className="ph-fill ph-palette"),r&&(r.textContent=" กลาง");break}}function wt(){const e=localStorage.getItem(Ie);let t;!e||e==="light"?t="neutral":e==="neutral"?t="dark":t="light",localStorage.setItem(Ie,t),Xe()}function H(){We&&(We.disabled=!St())}function Lt(){const e=gt();e&&(Ee(e,!1),S("ยกเลิกการกระทำล่าสุดแล้ว","success")),H()}function we(){te="suspended";const e=document.getElementById("filterStatusBar");let t=0;if(document.querySelectorAll(".room-card").forEach(o=>{let r=!1;o.querySelectorAll(".item-card").forEach(a=>{const n=a.classList.contains("is-suspended")||o.classList.contains("is-suspended");a.classList.toggle("item-hidden",!n),n&&(r=!0,t++)}),o.classList.toggle("item-hidden",!r)}),t===0){Ze(),S("ไม่มีรายการที่ถูกระงับแล้ว","success");return}e&&(e.innerHTML=`
            <span><i class="ph ph-warning"></i> รายการที่ถูกระงับ (${t} รายการ)</span>
            <button type="button" class="btn-chip" data-act="clear-filter" title="ยกเลิกการกรอง">
                <i class="ph ph-x"></i>&nbsp;ปิด
            </button>
        `,e.classList.add("is-visible"),e.dataset.filterType="suspended"),J(),O(),_e()}function kt(e,t){if(!e)return;te=e;const o=document.getElementById("filterStatusBar");let r=0;document.querySelectorAll(h.room).forEach(a=>{let n=0;a.querySelectorAll(".item-card").forEach(s=>{const l=s.dataset.type===e;s.classList.toggle("item-hidden",!l),l&&n++}),a.classList.toggle("item-hidden",n===0),r+=n}),o&&(o.innerHTML=`
            <span>เฉพาะ: <strong>${x(t)}</strong> (${r} รายการ)</span>
            <button type="button" class="btn-chip" data-act="clear-filter" title="ยกเลิกการกรอง">
                <i class="ph ph-x"></i>&nbsp;ปิด
            </button>
        `,o.classList.add("is-visible"),o.dataset.filterType=e),J(),O(),_e()}function Ze(){te=null;const e=document.getElementById("filterStatusBar");e&&(e.classList.remove("is-visible"),e.innerHTML="",e.removeAttribute("data-filter-type")),document.querySelectorAll(".item-hidden").forEach(t=>t.classList.remove("item-hidden")),J(),O(),_e()}function Tt(e){const t=e.target.closest(".item-card");document.querySelectorAll(".item-details-more.show").forEach(o=>{const r=o.closest(".item-card");r!==t&&xe(r,!1)})}function Ve(e){if(!e)return;const t=document.querySelector(".main-header"),o=document.querySelector(".summary-footer"),r=t?t.offsetHeight+16:80,a=o?o.offsetHeight+16:100,n=e.getBoundingClientRect();if(!(n.top>=r&&n.bottom<=window.innerHeight-a)){const l=window.innerHeight-r-a,m=n.height>l?"start":"center";e.scrollIntoView({behavior:"smooth",block:m})}}function It(e){if(!V)return;const t=V.closest(".item-card");if(!t)return;const o=e.dataset.code,r=_(e.dataset.price);V.value=o,V.classList.add("input-highlight"),setTimeout(()=>V.classList.remove("input-highlight"),1200);const a=V.dataset.favoriteType;let n;a==="fabric"?n="set_price_per_m":a==="sheer"?n="sheer_price_per_m":a==="wallpaper"?n="wallpaper_price_roll":n="area_price_sqyd";const s=t.querySelector(`[name="${n}"]`);s&&r>0&&(s.tagName==="SELECT"?s.value=r:s.value=k(r),s.classList.add("input-highlight"),setTimeout(()=>s.classList.remove("input-highlight"),1200)),G(V),re(t),I(),document.querySelector("#favoritesModal").classList.remove("visible")}async function et(e){var y;V=e;const t=e.dataset.favoriteType;if(!t)return;const o=document.querySelector("#favoritesModal"),r=o.querySelector("#favoritesModalTitle"),a=o.querySelector("#favoritesModalBody"),n=o.querySelector("#favSearchInput"),s=o.querySelector("#favoritesModalManageBtn"),l=document.querySelector("#favSelectorItemTpl"),m=((y=ee[t])==null?void 0:y.name)||t;r.textContent=`เลือก '${x(m)}'`;const d=Y()[t]||[];d.length>0?a.innerHTML=d.map(f=>l.innerHTML.replace(/{CODE}/g,x(f.code)).replace(/{PRICE}/g,f.price>0?k(f.price):"-").replace(/{RAW_PRICE}/g,f.price)).join(""):a.innerHTML='<p class="empty-state">ไม่มีรายการโปรดที่บันทึกไว้</p>',n.value="";const p=()=>{const f=n.value.toLowerCase();a.querySelectorAll(".fav-selector-item").forEach(u=>{const v=u.dataset.code.toLowerCase();u.classList.toggle("is-hidden",!v.includes(f))})};n.addEventListener("input",p);const c=f=>{const u=f.target.closest(".fav-selector-item");u&&(It(u),a.removeEventListener("click",c),n.removeEventListener("input",p))};a.addEventListener("click",c),s.onclick=async()=>{o.classList.remove("visible"),await Mt(t),le&&await et(e)},await $("#favoritesModal",()=>{n.removeEventListener("input",p),a.removeEventListener("click",c)})}function fe(e){const t=document.querySelector("#favManagerBody"),o=document.querySelector("#favManagerItemTpl"),a=Y()[e]||[];!t||!o||(a.length===0?t.innerHTML='<p class="empty-state">ไม่มีรายการโปรดที่บันทึกไว้</p>':t.innerHTML=a.map(n=>o.innerHTML.replace(/{CODE}/g,x(n.code)).replace(/{PRICE}/g,k(n.price)).replace(/{RAW_PRICE}/g,n.price)).join(""),Me(null))}function Me(e){const t=document.querySelector('[data-act="edit-selected-fav"]'),o=document.querySelector('[data-act="del-selected-fav"]');!t||!o||(e?(t.disabled=!1,o.disabled=!1,P={code:e.dataset.code,price:_(e.dataset.price)}):(t.disabled=!0,o.disabled=!0,P=null))}async function Mt(e){var r;const t=document.querySelector("#favManagerModal");if(!t||!e)return;const o=((r=ee[e])==null?void 0:r.name)||e;t.dataset.currentType=e,le=!1,P=null,document.querySelector("#favManagerTitle").textContent=`จัดการ '${o}'`,fe(e),await $("#favManagerModal")}function S(e,t="default"){const o=document.querySelector(h.toastContainer);if(!o)return;const r={success:"ph-bold ph-check-circle",warning:"ph-bold ph-warning",error:"ph-bold ph-x-circle",default:"ph-bold ph-info"},a=document.createElement("div");a.className=`toast toast-${t}`,a.innerHTML=`<i class="${r[t]||r.default}"></i> ${e}`,o.appendChild(a),setTimeout(()=>a.classList.add("show"),10),setTimeout(()=>{a.classList.remove("show"),a.addEventListener("transitionend",()=>a.remove())},3e3)}function $(e,t){return new Promise(o=>{const r=document.querySelector(e);if(!r){o(null);return}const a=document.querySelector(".modal-wrapper.visible");a&&a.classList.add("is-underlay"),r.classList.add("visible");const n=r.querySelector('[id$="Confirm"]'),s=r.querySelector('[id$="Cancel"], [data-act="close-modal"]'),l=Array.from(r.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])')).filter(c=>!c.disabled&&c.offsetParent!==null),m=l[0],i=l[l.length-1];setTimeout(()=>m==null?void 0:m.focus(),50);const d=c=>{if(c.key==="Escape"&&!r.classList.contains("is-underlay")){p({cancelled:!0});return}if(c.key==="Tab"){if(l.length<=1){c.preventDefault();return}c.shiftKey?document.activeElement===m&&(i.focus(),c.preventDefault()):document.activeElement===i&&(m.focus(),c.preventDefault())}},p=c=>{r.classList.remove("visible"),document.removeEventListener("keydown",d),n&&(n.onclick=null),s&&(s.onclick=null),a&&a.classList.remove("is-underlay"),typeof c=="object"&&c.cancelled&&t&&t(),o(c)};n&&(n.onclick=()=>p(!0)),s&&(s.onclick=()=>{r.classList.contains("is-underlay")||p({cancelled:!0})}),document.addEventListener("keydown",d)})}async function ce(e,t){const o=document.querySelector(h.modal);return o?(o.querySelector(h.modalTitle).textContent=e,o.querySelector(h.modalBody).textContent=t,await $(h.modal)===!0):!0}async function Et(){var o,r,a;const e=document.querySelector(h.exportOptionsModal);if(!e)return null;const t=await $(h.exportOptionsModal);return!t||t.cancelled?null:{vatOption:((o=e.querySelector('input[name="vat_option"]:checked'))==null?void 0:o.value)||"include",exportMethod:((r=e.querySelector("#exportMethod"))==null?void 0:r.value)||"direct",pageBreakBuffer:parseInt((a=e.querySelector("#pageBreakBuffer"))==null?void 0:a.value,10)||3}}async function Bt(){const e=document.querySelector("#discountModal");if(!e)return;const t=e.querySelector("#discountSubtotal"),o=e.querySelector("#discountPercent"),r=e.querySelector("#discountAmount"),a=e.querySelector("#discountFinalTotal"),n=document.querySelector("#discount_type"),s=document.querySelector("#discount_value"),l=_(document.querySelector("#originalTotal").dataset.rawTotal||document.querySelector("#grandTotal").textContent);t.textContent=k(l);const m=c=>{if(be)return;be=!0;let y=0;if(c==="percent"){const f=_(o.value);y=l*((f>=0?f:0)/100),r.value=y>0?k(Math.round(y)):""}else y=_(r.value);if(y=y>=0?Math.min(y,l):0,c!=="percent"){const f=l>0?y/l*100:0;o.value=f>0&&isFinite(f)?X(f,2):""}a.textContent=k(l-y),setTimeout(()=>{be=!1},20)};o.addEventListener("input",()=>m("percent")),r.addEventListener("input",()=>m("amount")),r.addEventListener("focus",c=>{_(c.target.value)>0&&(c.target.value=_(c.target.value))}),r.addEventListener("blur",c=>{_(c.target.value)>0&&(c.target.value=k(_(c.target.value))),m("amount")});const i=n.value,d=_(s.value);o.value="",r.value="",d>0?i==="percent"?(o.value=d,m("percent")):(r.value=k(d),m("amount")):m();const p=await $("#discountModal");if(p&&!p.cancelled){const c=_(o.value),y=_(r.value);document.activeElement===o&&c>0?(n.value="percent",s.value=c):y>0?(n.value="amount",s.value=y):(n.value="amount",s.value=0),N(),I()}}async function xt(){var r,a,n,s,l;if(!E)return;const e=document.querySelector("#hardwareModal"),t=((r=E.querySelector('[name="set_style"]'))==null?void 0:r.value)==="ตาไก่";e.querySelector('[name="modal_track_color"]').value=((a=E.querySelector('[name="track_color"]'))==null?void 0:a.value)||"ขาว",e.querySelector('[name="modal_bracket_color"]').value=((n=E.querySelector('[name="bracket_color"]'))==null?void 0:n.value)||"ขาว",e.querySelector('[name="modal_finial_color"]').value=((s=E.querySelector('[name="finial_color"]'))==null?void 0:s.value)||"ขาว",e.querySelector('[name="modal_grommet_color"]').value=((l=E.querySelector('[name="grommet_color"]'))==null?void 0:l.value)||"เงิน",e.querySelector("#grommetColorGroup").style.display=t?"":"none";const o=await $("#hardwareModal");o&&!o.cancelled&&(E.querySelector('[name="track_color"]').value=e.querySelector('[name="modal_track_color"]').value,E.querySelector('[name="bracket_color"]').value=e.querySelector('[name="modal_bracket_color"]').value,E.querySelector('[name="finial_color"]').value=e.querySelector('[name="modal_finial_color"]').value,t&&(E.querySelector('[name="grommet_color"]').value=e.querySelector('[name="modal_grommet_color"]').value),I(),S("บันทึกการตั้งค่าอุปกรณ์แล้ว","success")),E=null}function Le(e,t,o){e&&(Z(B()),H(),e.classList.add("item-removing"),e.addEventListener("animationend",()=>{e.remove(),t&&S(t),o&&o(),ie(),J(),N(),I(),ue()},{once:!0}))}function J(){document.querySelectorAll(h.room).forEach(e=>{const t=e.querySelectorAll(".item-card:not(.is-suspended):not(.item-hidden)"),o=t.length;t.forEach((a,n)=>{const s=a.querySelector("[data-item-title]");s&&(s.textContent=`${n+1}/${o}`)}),e.querySelectorAll(".item-card.is-suspended, .item-card.item-hidden").forEach(a=>{const n=a.querySelector("[data-item-title]");n&&(n.textContent="-")})})}function tt(){const e=document.querySelector(h.orderForm),t=document.querySelector(h.lockBtn);!e||!t||(e.classList.toggle("is-locked",F),t.classList.toggle("is-locked",F),t.querySelector("i").className=F?"ph-bold ph-lock-key":"ph ph-paw-print",e.querySelectorAll("input, select, textarea, button").forEach(o=>{o.closest(".summary-footer")||o.closest(".main-header")||o.closest(".modal-wrapper")||o.dataset.act==="toggle-more-details"||o.dataset.act==="collapse-room"||(o.disabled=F)}),S(F?"ฟอร์มถูกล็อค":"ปลดล็อคฟอร์มแล้ว",F?"warning":"success"))}function O(){const e=document.querySelectorAll(h.room);if(e.length===0)return;const t=[...e].some(r=>r.open),o=document.querySelector(h.toggleAllRoomsBtn);o&&(o.querySelector("i").className="ph ph-rows",o.querySelector("span").textContent=t?"ย่อทั้งหมด":"ขยายทั้งหมด")}function $t(){var r;const e=document.querySelectorAll(h.room),t=[...e].some(a=>a.open);e.forEach(a=>{a.open=!t});const o=document.querySelector(h.quickNavDropdown);o&&o.classList.contains("show")&&(o.classList.remove("show"),(r=document.querySelector(h.quickNavBtn))==null||r.setAttribute("aria-expanded","false")),setTimeout(()=>{O(),I()},50)}function ie(){const e=document.querySelector(h.quickNavRoomList);e&&(e.innerHTML="",document.querySelectorAll(h.room).forEach(t=>{var a;const o=((a=t.querySelector(h.roomNameInput))==null?void 0:a.value)||"ห้อง",r=document.createElement("a");r.href=`#${t.id}`,r.dataset.jumpTo=t.id,r.innerHTML=`<i class="ph ph-share-fat"></i> ${o}`,e.appendChild(r)}))}function rt(e){var o;const t=document.getElementById("quickNavBtnText");t&&(e?t.textContent=((o=e.querySelector('input[name="room_name"]'))==null?void 0:o.value)||"...":t.textContent="ไปยังห้อง")}function ue(){if(de&&de.disconnect(),!document.getElementById("quickNavBtnText"))return;const e={root:null,rootMargin:"-60px 0px -150px 0px",threshold:0},t=o=>{const r=o.filter(a=>a.isIntersecting).sort((a,n)=>a.target.getBoundingClientRect().top-n.target.getBoundingClientRect().top);r.length>0&&rt(r[0].target)};de=new IntersectionObserver(t,e),document.querySelectorAll(h.room).forEach(o=>de.observe(o))}function G(e){if(!e)return;const t=e.closest(".form-group-with-favorites").querySelector(".btn-favorite");if(!t)return;const o=e.dataset.favoriteType,r=e.value;t.classList.toggle("is-favorite",Qe(o,r))}function xe(e,t=null){if(!e)return;const o=e.querySelector(".item-details-more"),r=e.querySelector('[data-act="toggle-more-details"]'),a=r==null?void 0:r.parentElement;if(!o||!r||!a)return;const n=o.classList.contains("show"),s=t!==null?t:!n;if(n===s)return;o.classList.toggle("show",s),r.classList.toggle("expanded",s);const l=r.querySelector("i");l&&(l.className=s?"ph ph-caret-up":"ph ph-caret-down");const m=r.querySelector("span");if(m&&(m.textContent=s?"ย่อน้อยลง":"เพิ่มเติม"),s)o.appendChild(a),setTimeout(()=>{e.scrollIntoView({behavior:"smooth",block:"start"})},50);else{const i=e.querySelector(".item-grid");i&&i.appendChild(a)}}function $e(e,t){var l;const o=ee[e];if(!o)return null;const r=document.querySelector(o.templateId);if(!r||!t)return null;const a=r.content.cloneNode(!0),n=a.firstElementChild;n.dataset.type=e,n.classList.add(`${e.replace(/_/g,"-")}-item`);const s=n.querySelector(".item-type-display");if(s&&(s.textContent=o.name),o.templateId==="#areaBasedTpl"){const m=n.querySelector('input[name="area_code"]'),i=n.querySelector(".btn-favorite"),d=n.querySelector(".btn-show-favs");m&&(m.dataset.favoriteType=e),i&&(i.dataset.type=e),d&&(d.dataset.type=e);const p=n.querySelector(".item-details-more .item-grid"),c=(l=p==null?void 0:p.querySelector('input[name="area_price_sqyd"]'))==null?void 0:l.closest(".form-group");if(p&&c){let y=null;e==="partition"||e==="pleated_screen"?(y=document.createElement("div"),y.className="form-group",y.innerHTML=`
                    <label>รูปแบบเปิด
                        <select name="opening_style">
                            <option value="แยกกลาง">แยกกลาง</option>
                            <option value="เก็บข้างเดียว">เก็บข้างเดียว</option>
                        </select>
                    </label>
                `):["wooden_blind","roller_blind","vertical_blind","aluminum_blind"].includes(e)&&(y=document.createElement("div"),y.className="form-group",y.innerHTML=`
                    <label>เชือกปรับ
                        <select name="adjustment_side">
                            <option value="ปรับขวา">ปรับขวา</option>
                            <option value="ปรับซ้าย">ปรับซ้าย</option>
                        </select>
                    </label>
                `),y&&(c.classList.remove("full-width-item"),c.parentNode.insertBefore(y,c))}}return t.appendChild(a),n}function Ct(e,t){var a;if(!t)return;const o=t.querySelector(h.allItemsContainer);if(!o)return;Z(B()),H();const r=$e(e,o);if(r){if(e==="wallpaper"){const n=Ce(r.querySelector('[data-act="add-wall"]'));n&&((a=n.querySelector("input"))==null||a.focus())}else{const n=r.querySelector('input:not([type="hidden"]), select, textarea');n&&n.focus()}r.classList.add("item-created"),r.scrollIntoView({behavior:"smooth",block:"center"}),J(),N(),I()}}async function Ue(e,t=null){const o=document.querySelector("#itemTypeModal");if(!o)return null;o.querySelector("#itemTypeModalTitle").textContent=e;let r=t;t&&!ee[t]&&(r="wooden_blind");const a=o.querySelector(`input[name="item_type_option"][value="${r||"set"}"]`);a&&(a.checked=!0);const n=await $("#itemTypeModal");if(!n||n.cancelled)return null;const s=o.querySelector('input[name="item_type_option"]:checked');return s?s.value:null}function At(e,t){if(!ee[t])return;const r=e.parentElement;r&&(Z(B()),H(),e.classList.add("item-removing"),e.addEventListener("animationend",()=>{var n;const a=$e(t,r);a&&(e.replaceWith(a),a.classList.add("item-created"),a.scrollIntoView({behavior:"smooth",block:"center"}),(n=a.querySelector('input:not([type="hidden"]), select, textarea'))==null||n.focus(),J(),N(),I(),S("เปลี่ยนประเภทรายการแล้ว","success"))},{once:!0}))}function ae(){Z(B()),H();const e=document.querySelector(h.roomsContainer);if(!e)return;const t=document.querySelector("#roomTpl");if(!t)return;const o=Array.from(document.querySelectorAll(h.roomNameInput)).map(m=>parseInt(m.value.replace(/[^0-9]/g,""),10)).filter(m=>!isNaN(m)),n=`ห้อง ${(o.length>0?Math.max(...o):0)+1}`,l=t.content.cloneNode(!0).firstElementChild;if(l){l.id=`room-${Date.now()}`;const m=l.querySelector('input[name="room_name"]'),i=l.querySelector(".room-header-controls .form-group > label");if(m&&i){const p=`room_name_${l.id}`;m.id=p,i.setAttribute("for",p)}m&&(m.value=n);const d=l.querySelector("[data-room-name-display]");d&&(d.textContent=n),l.open=!0,e.appendChild(l),l.classList.add("item-created"),l.scrollIntoView({behavior:"smooth",block:"center"})}ie(),O(),ue(),I()}function Ce(e){var o;const t=(o=e==null?void 0:e.closest(".walls-section"))==null?void 0:o.querySelector(h.wallsContainer);if(t){const r=document.querySelector(h.wallTpl);if(!r)return null;const a=r.content.cloneNode(!0),n=a.querySelector(".wall-input-row");if(!n)return null;const s=n.querySelector("input"),l=n.querySelector("label");if(s&&l){const m=`wall-input-${Date.now()}-${Math.random().toString(36).substring(2,7)}`;s.id=m,l.setAttribute("for",m)}return t.appendChild(a),requestAnimationFrame(()=>{n.classList.add("item-created")}),re(e),n}return null}function re(e){var s,l,m,i,d,p,c,y,f,u,v,g;if(!e)return;const t=e.closest(".item-card");if(!t){N();return}const o=t.dataset.type;let r,a,n;switch(o){case"set":r=t.querySelector("[data-set-summary]"),a={width_m:(s=t.querySelector('input[name="width_m"]'))==null?void 0:s.value,height_m:(l=t.querySelector('input[name="height_m"]'))==null?void 0:l.value,style:(m=t.querySelector('select[name="set_style"]'))==null?void 0:m.value,fabric_variant:(i=t.querySelector('select[name="fabric_variant"]'))==null?void 0:i.value,price_per_m_raw:(d=t.querySelector('select[name="set_price_per_m"]'))==null?void 0:d.value,sheer_price_per_m:(p=t.querySelector('select[name="sheer_price_per_m"]'))==null?void 0:p.value},n=T.calculateSetPrice(a),t.dataset.totalPrice=n.total;let b=`ราคา: <b>${k(n.total)}</b> บ.`;n.opaque>0&&n.sheer>0&&(b+=` <small>(ทึบ: ${k(n.opaque)}, โปร่ง: ${k(n.sheer)})</small>`),r&&(r.innerHTML=b);break;case"wallpaper":r=t.querySelector("[data-wallpaper-summary]"),a={height_m:(c=t.querySelector('input[name="wallpaper_height_m"]'))==null?void 0:c.value,price_per_roll:(y=t.querySelector('input[name="wallpaper_price_roll"]'))==null?void 0:y.value,install_cost_per_roll:(f=t.querySelector('input[name="wallpaper_install_cost"]'))==null?void 0:f.value,widths:Array.from(t.querySelectorAll('input[name="wall_width_m"]')).map(L=>L.value)},n=T.calculateWallpaperPrice(a),t.dataset.totalPrice=n.total;let q=`รวม: <b>${k(n.total)}</b> บ. `;(n.material>0||n.install>0)&&(q+=`<small>(วอลล์: ${k(n.material)}, ค่าช่าง: ${k(n.install)})</small>`),n.rolls>0&&(q+=` &bull; พื้นที่: ${X(n.sqm,2)} ตร.ม. &bull; ใช้: ${n.rolls} ม้วน`),r&&(r.innerHTML=q);break;default:r=t.querySelector("[data-area-summary]"),a={width_m:(u=t.querySelector('input[name="area_width_m"]'))==null?void 0:u.value,height_m:(v=t.querySelector('input[name="area_height_m"]'))==null?void 0:v.value,price_sqyd:(g=t.querySelector('input[name="area_price_sqyd"]'))==null?void 0:g.value},n=T.calculateDecoPrice(a),t.dataset.totalPrice=n.total;let w="";n.sqyd>0&&(w=` &bull; พื้นที่: ${X(n.sqyd,2)} ตร.หลา`),r&&(r.innerHTML=`ราคา: <b>${k(n.total)}</b> บ.${w}`);break}N()}function _e(){const e=document.getElementById("suspendedItemsBtn");if(!e)return;if(te){e.classList.remove("is-visible");return}const t=document.getElementById("suspendedCountBadge"),o=document.querySelectorAll(".item-card.is-suspended").length,r=document.querySelectorAll(".room-card.is-suspended");let a=0;r.forEach(s=>{a+=s.querySelectorAll(".item-card:not(.is-suspended)").length});const n=o+a;n>0?(t&&(t.textContent=n),e.classList.add("is-visible")):e.classList.remove("is-visible")}function N(){let e=0;document.querySelectorAll(h.room).forEach(s=>{let l=0,m=0;const i=s.classList.contains("is-suspended");s.querySelectorAll(".item-card").forEach(p=>{const c=_(p.dataset.totalPrice),y=p.classList.contains("is-suspended");!i&&!y&&(l+=c,c>0&&m++)});const d=s.querySelector("[data-room-brief]");d&&(i?d.textContent="(ระงับชั่วคราว)":m>0?d.innerHTML=`<span>${m}</span> &bull; ${k(l)} บาท`:d.innerHTML="<span>0</span> รายการ"),i||(e+=l)});const t=document.querySelector("#discount_type").value,o=_(document.querySelector("#discount_value").value);let r=0;o>0&&(r=t==="percent"?e*(o/100):o);const a=e-r;document.querySelector("#grandTotal").textContent=k(a);const n=document.querySelector("#originalTotal");r>0?(n.textContent=k(e),n.dataset.rawTotal=e,n.style.display="block"):(n.style.display="none",n.dataset.rawTotal=""),_e()}async function Ee(e,t=!1){if(e!=null&&e.favorites)if(t){const n=document.querySelector("#favoritesConflictModal");if(n){const s=await $("#favoritesConflictModal");if(!s||s.cancelled){S("ยกเลิกการนำเข้า","warning");return}switch(n.querySelector('input[name="fav_conflict_option"]:checked').value){case"overwrite":De(e.favorites)&&S("เขียนทับรายการโปรดสำเร็จ","success");break;case"merge":const m=Je(e.favorites);S(`รวมข้อมูลสำเร็จ (เพิ่ม ${m} รายการใหม่)`,"success");break}}}else De(e.favorites);if(!(e!=null&&e.rooms)||!Array.isArray(e.rooms)){e.favorites||S("ไม่พบข้อมูลสำหรับนำเข้าในไฟล์","error");return}const o=document.querySelector(h.roomsContainer);if(!o)return;o.innerHTML="",document.querySelector("#customer_name").value=e.customer_name||"",document.querySelector("#customer_phone").value=e.customer_phone||"",document.querySelector("#customer_address").value=e.customer_address||"",e.discount&&(document.querySelector("#discount_type").value=e.discount.type||"amount",document.querySelector("#discount_value").value=e.discount.value||0),document.querySelector("#customerDetailsCard").open=e.customer_card_open??!0;let r=0;const a=()=>{if(r>=e.rooms.length){document.querySelectorAll("input[data-favorite-type]").forEach(G),N(),J(),ie(),O(),ue(),t&&S("นำเข้าข้อมูลฟอร์มสำเร็จ","success");return}const n=e.rooms[r],s=document.querySelector("#roomTpl");if(!s){console.error("Room template not found.");return}const m=s.content.cloneNode(!0).firstElementChild;if(o.appendChild(m),m){m.id=n.id||`room-${Date.now()}`,n.is_suspended&&m.classList.add("is-suspended"),m.open=n.is_open===!0;const i=n.room_name||"ห้อง (ไม่มีชื่อ)",d=m.querySelector('input[name="room_name"]'),p=m.querySelector(".room-header-controls .form-group > label");if(d&&p){const f=`room_name_${m.id}`;d.id=f,p.setAttribute("for",f)}d&&(d.value=i);const c=m.querySelector("[data-room-name-display]");c&&(c.textContent=i);const y=m.querySelector(h.allItemsContainer);if(y&&n.items){const f=document.createDocumentFragment();n.items.forEach(u=>{var g,b,q;u.type==="deco"&&u.deco_type?(u.type=bt[u.deco_type]||"wooden_blind",u.code=u.deco_code,u.width_m=u.deco_width_m,u.height_m=u.deco_height_m,u.price_sqyd=u.deco_price_sqyd,u.notes=u.deco_notes):u.type==="deco"&&(u.type="wooden_blind",u.code=u.deco_code);const v=$e(u.type,f);if(v){switch(u.is_suspended&&v.classList.add("is-suspended"),u.type){case"set":v.querySelector('input[name="width_m"]').value=z(u.width_m),v.querySelector('input[name="height_m"]').value=z(u.height_m);const w=v.querySelector('select[name="fabric_variant"]');w.value=u.fabric_variant||"ทึบ",v.querySelector('select[name="set_style"]').value=u.style||u.set_style||"ลอน",v.querySelector('select[name="set_price_per_m"]').value=u.price_per_m_raw||u.set_price_per_m||"",v.querySelector('select[name="sheer_price_per_m"]').value=u.sheer_price_per_m||"",v.querySelector('select[name="opening_style"]').value=u.opening_style||"แยกกลาง",v.querySelector('input[name="track_color"]').value=u.track_color||"ขาว",v.querySelector('input[name="bracket_color"]').value=u.bracket_color||"ขาว",v.querySelector('input[name="finial_color"]').value=u.finial_color||"ขาว",v.querySelector('input[name="grommet_color"]').value=u.grommet_color||"เงิน",v.querySelector('input[name="fabric_code"]').value=u.fabric_code||"",v.querySelector('input[name="sheer_fabric_code"]').value=u.sheer_fabric_code||"",v.querySelector('input[name="notes"]').value=u.notes||"";const L=w.value,M=L==null?void 0:L.includes("โปร่ง"),C=L==="โปร่ง",A=L==="ทึบ";(g=v.querySelector(h.sheerWrap))==null||g.classList.toggle("hidden",!M),(b=v.querySelector(h.sheerCodeWrap))==null||b.classList.toggle("hidden",!M);const R=v.querySelector('select[name="set_price_per_m"]'),j=v.querySelector('input[name="fabric_code"]'),K=v.querySelector('select[name="sheer_price_per_m"]'),D=v.querySelector('input[name="sheer_fabric_code"]');R&&(R.disabled=C),j&&(j.disabled=C),C&&(R&&(R.value=""),j&&(j.value="",G(j))),K&&(K.disabled=A),D&&(D.disabled=A),A&&(K&&(K.value=""),D&&(D.value="",G(D)));break;case"wallpaper":v.querySelector('input[name="wallpaper_height_m"]').value=z(u.height_m||u.wallpaper_height_m),v.querySelector('input[name="wallpaper_code"]').value=u.wallpaper_code||"";const oe=_(u.price_per_roll||u.wallpaper_price_roll);v.querySelector('input[name="wallpaper_price_roll"]').value=oe>0?k(oe):"",v.querySelector('input[name="wallpaper_install_cost"]').value=u.hasOwnProperty("install_cost_per_roll")?k(u.install_cost_per_roll):u.wallpaper_install_cost?k(u.wallpaper_install_cost):"300",v.querySelector('input[name="wallpaper_notes"]').value=u.notes||u.wallpaper_notes||"",u.widths&&u.widths.forEach(Q=>{const W=Ce(v.querySelector('[data-act="add-wall"]'));W&&(W.querySelector('input[name="wall_width_m"]').value=z(Q))});break;default:if(((q=ee[u.type])==null?void 0:q.templateId)==="#areaBasedTpl"){v.querySelector('input[name="area_width_m"]').value=z(u.width_m),v.querySelector('input[name="area_height_m"]').value=z(u.height_m);const Q=_(u.price_sqyd);v.querySelector('input[name="area_price_sqyd"]').value=Q>0?k(Q):"",v.querySelector('input[name="area_code"]').value=u.code||"",v.querySelector('input[name="area_notes"]').value=u.notes||"";const W=v.querySelector('select[name="opening_style"]');W&&(W.value=u.opening_style||"แยกกลาง");const ne=v.querySelector('select[name="adjustment_side"]');ne&&(ne.value=u.adjustment_side||"ปรับขวา")}break}re(v)}}),y.appendChild(f)}}r++,requestAnimationFrame(a)};requestAnimationFrame(a)}function Pt(e){if(document.getElementById("loading-overlay"))return;const t=document.createElement("div");t.id="loading-overlay",t.innerHTML=`<div class="loading-spinner"></div><p>${e}</p>`,document.body.appendChild(t),document.body.style.overflow="hidden"}function Nt(){const e=document.getElementById("loading-overlay");e&&e.remove(),document.body.style.overflow=""}async function Rt(e,t){var r,a;const o=document.querySelector(h.printableContent);if(!o||!e||!e.html){S("ไม่พบข้อมูลสำหรับสร้างเอกสาร","error");return}if(t==="direct"){Pt("กำลังสร้าง PDF...");let n;try{typeof html2pdf>"u"&&(S("กำลังโหลดไลบรารี PDF...","default"),await qt("https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js")),n=document.createElement("div"),n.style.position="fixed",n.style.left="-300mm",n.style.top="0",n.style.width="210mm",n.style.background="#fff",n.innerHTML=e.html,document.body.appendChild(n),await new Promise(l=>setTimeout(l,500));const s={margin:0,filename:`${e.fileName}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0,logging:!1,width:((r=n.querySelector(".pdf-page"))==null?void 0:r.scrollWidth)||210*3.77,windowWidth:((a=n.querySelector(".pdf-page"))==null?void 0:a.scrollWidth)||210*3.77},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}};await window.html2pdf().from(n).set(s).save(),S("ดาวน์โหลด PDF สำเร็จ","success")}catch(s){console.error("PDF Generation Error:",s),S("สร้าง PDF ล้มเหลว, โปรดลองวิธีที่ 2 (พิมพ์)","error")}finally{Nt(),n&&document.body.contains(n)&&document.body.removeChild(n)}}t==="print"&&(o.innerHTML=e.html,setTimeout(()=>{window.print(),setTimeout(()=>{o.innerHTML=""},1e3)},lt))}function Ot(e){if(!e||!e.html){S("ไม่พบข้อมูลสำหรับสร้างไฟล์ HTML","error");return}try{const t=`
            <!DOCTYPE html><html lang="th"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>${e.fileName}</title>
                <link rel="stylesheet" href="https://grobmak.github.io/marnthara-form/src/style.css">
                <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/bold/style.css">
                <style>#printable-content { display: block !important; } .pdf-page { border: 1px solid #eee; box-shadow: 0 0 10px rgba(0,0,0,0.1); margin: 10mm auto; } i.ph { vertical-align: middle; }</style>
            </head>
            <body>${e.html}</body></html>`,o=new Blob([t],{type:"text/html;charset=utf-8"}),r=URL.createObjectURL(o),a=document.createElement("a");a.href=r,a.download=`${e.fileName}.html`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(r),S("ดาวน์โหลดไฟล์ HTML สำเร็จ","success")}catch(t){console.error("HTML Export Error:",t),S("สร้างไฟล์ HTML ล้มเหลว","error")}}function Ft(e){if(!e)return;const t=e.closest(".item-card");if(!t)return;const o=_(e.value);let r,a;const n=e.getAttribute("name");if(n==="set_price_per_m"?(r=t.querySelector('input[name="fabric_code"]'),a="fabric"):n==="sheer_price_per_m"?(r=t.querySelector('input[name="sheer_fabric_code"]'),a="sheer"):n==="wallpaper_price_roll"?(r=t.querySelector('input[name="wallpaper_code"]'),a="wallpaper"):n==="area_price_sqyd"&&(r=t.querySelector('input[name="area_code"]'),r&&(a=r.dataset.favoriteType)),r&&a&&r.value.trim()){const s=Ke(a,r.value);s&&s.price!==o&&(r.value="",G(r))}}function ot(e){const{roomId:t,itemIndex:o}=e.dataset;if(!t||o===void 0)return;const r=document.getElementById("lookbookModal");r&&r.classList.remove("visible");const a=document.getElementById(t);if(!a){S("ไม่พบห้องที่ต้องการ","error");return}const s=Array.from(a.querySelectorAll(".item-card:not(.item-hidden)"))[parseInt(o,10)];if(!s){S("ไม่พบรายการที่ต้องการ","error");return}a.open=!0,O(),setTimeout(()=>{s.scrollIntoView({behavior:"smooth",block:"center"}),s.classList.add("scrolling-jump"),setTimeout(()=>s.classList.remove("scrolling-jump"),2500)},150)}const Ht=it(e=>{e.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_price_per_m"]')&&Ft(e),re(e),I()},200);function Ge(e){var o,r;if(F){e.preventDefault();return}const t=e.target;if(t.matches('select[name="fabric_variant"]')){const a=t.closest(".set-item");if(a){const n=t.value,s=n==null?void 0:n.includes("โปร่ง");n==null||n.includes("ทึบ");const l=n==="โปร่ง",m=n==="ทึบ";(o=a.querySelector(h.sheerWrap))==null||o.classList.toggle("hidden",!s),(r=a.querySelector(h.sheerCodeWrap))==null||r.classList.toggle("hidden",!s);const i=a.querySelector('select[name="set_price_per_m"]'),d=a.querySelector('input[name="fabric_code"]'),p=a.querySelector('select[name="sheer_price_per_m"]'),c=a.querySelector('input[name="sheer_fabric_code"]');i&&(i.disabled=l),d&&(d.disabled=l),l&&(i&&(i.value=""),d&&(d.value="",G(d))),p&&(p.disabled=m),c&&(c.disabled=m),m&&(p&&(p.value=""),c&&(c.value="",G(c)))}}if(t.matches(h.roomNameInput)){const a=t.closest(".room-card");if(a){const n=a.querySelector("[data-room-name-display]");n&&(n.textContent=t.value||"ห้อง")}ie(),ue()}t.matches("input[data-favorite-type]")&&G(t),Ht(t)}function jt(e){const t=e.target;t.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_install_cost"]')?t.value=_(t.value)>0?k(_(t.value)):"":t.matches('input[name$="_m"], input[name$="width_m"]')&&(t.value=z(t.value))}function Dt(e){const t=e.target;t.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_install_cost"]')&&_(t.value)>0&&(t.value=_(t.value))}const Wt=async e=>{var i,d,p;const t=e.target.closest(".summary-tag[data-filter-type]");if(t){const c=t.dataset.filterType,y=t.textContent.trim().replace(/\s*\d+\s*$/,""),f=document.querySelector("#overviewModal");f&&f.classList.remove("visible"),kt(c,y);return}const o=e.target.closest(".fav-manager-item");if(o){const c=o.parentElement.querySelector(".is-selected");c&&c.classList.remove("is-selected"),c!==o?(o.classList.add("is-selected"),Me(o)):Me(null);return}const r=e.target.closest("[data-act]");if(!r)return;if(r.dataset.act==="jump-to-item"){ot(r);return}const a=["toggle-more-details","show-discount-modal","collapse-room","show-suspended-items","clear-filter"];if(F&&!r.closest(".unlockable")&&!a.includes(r.dataset.act))return;const n=r.dataset.act,s=r.closest(h.room),l=r.closest(".item-card"),m=(c,y,f)=>ce(c,y).then(u=>u&&f());switch(n){case"add-room":ae();break;case"add-item":{if(qe=r.closest(h.room),qe){const f=await Ue("เพิ่มรายการใหม่");f&&Ct(f,qe)}break}case"collapse-room":s&&(e.preventDefault(),s.open=!1);break;case"clear-filter":e.stopPropagation(),Ze();break;case"show-suspended-items":we();break;case"change-type":{const f=l==null?void 0:l.dataset.type;if(l&&f){const u=await Ue("เปลี่ยนประเภทรายการ",f);u&&u!==f&&m("ยืนยันการเปลี่ยนแปลง","ข้อมูลทั้งหมดในรายการนี้จะถูกลบและสร้างใหม่ คุณแน่ใจหรือไม่?",()=>At(l,u))}break}case"add-wall":{const f=Ce(r);f&&((i=f.querySelector('input[name="wall_width_m"]'))==null||i.focus());break}case"show-discount-modal":Bt();break;case"open-hardware-modal":{E=l,xt();break}case"apply-hardware-to-room":{const f=r.closest("#hardwareModal"),u=E==null?void 0:E.closest(h.room);if(!f||!u)break;const v=f.querySelector('[name="modal_track_color"]').value,g=f.querySelector('[name="modal_bracket_color"]').value,b=f.querySelector('[name="modal_finial_color"]').value,q=f.querySelector('[name="modal_grommet_color"]').value;u.querySelectorAll(".set-item").forEach(w=>{w.querySelector('[name="track_color"]').value=v,w.querySelector('[name="bracket_color"]').value=g,w.querySelector('[name="finial_color"]').value=b,w.querySelector('[name="grommet_color"]').value=q}),I(),S("ใช้การตั้งค่ากับทุกรายการในห้องแล้ว","success");break}case"toggle-more-details":{Tt(e),xe(l);break}case"show-favorites":{const f=r.closest(".form-group-with-favorites").querySelector("input[data-favorite-type]");f&&et(f);break}case"toggle-favorite":{const f=r.closest(".form-group-with-favorites").querySelector("input[data-favorite-type]");if(!f||!l)break;const u=f.dataset.favoriteType,v=f.value;let g;u==="fabric"?g="set_price_per_m":u==="sheer"?g="sheer_price_per_m":u==="wallpaper"?g="wallpaper_price_roll":g="area_price_sqyd";const b=l.querySelector(`[name="${g}"]`),q=_(b==null?void 0:b.value);if(!v.trim()){S("โปรดระบุรหัสก่อนบันทึก","warning");break}if(q<=0&&u!=="fabric"&&u!=="sheer"){S("โปรดระบุราคาก่อนบันทึก","warning");break}const w=Se(u,v,q);r.classList.toggle("is-favorite",w),S(w?"เพิ่มในรายการโปรดแล้ว":"ลบออกจากรายการโปรด","success"),I();break}case"add-new-fav-form":{const u=r.closest("#favManagerModal").dataset.currentType;if(!u)break;const v=document.querySelector("#favAddModal");v.querySelector("h3").textContent=`เพิ่ม '${((d=ee[u])==null?void 0:d.name)||u}'`;const g=v.querySelector('[name="fav_code_add"]'),b=v.querySelector('[name="fav_price_add"]');g.value="",b.value="";const q=await $("#favAddModal");if(q&&!q.cancelled){const w=g.value.trim(),L=_(b.value);w&&(Se(u,w,L),le=!0,fe(u),S("เพิ่มรายการโปรดแล้ว","success"))}break}case"edit-selected-fav":{if(!P)break;const u=r.closest("#favManagerModal").dataset.currentType;if(!u)break;const v=document.querySelector("#favEditModal");v.querySelector("h3").textContent=`แก้ไข '${P.code}'`;const g=v.querySelector('[name="fav_code_edit"]'),b=v.querySelector('[name="fav_price_edit"]');g.value=P.code,b.value=P.price>0?P.price:"";const q=await $("#favEditModal");if(q&&!q.cancelled){const w=g.value.trim(),L=_(b.value);w&&(w!==P.code&&Te(u,P.code),Se(u,w,L),le=!0,fe(u),S("แก้ไขรายการโปรดแล้ว","success"))}break}case"del-selected-fav":{if(!P)break;const u=r.closest("#favManagerModal").dataset.currentType;if(!u)break;await ce("ลบรายการโปรด",`ยืนยันการลบรหัส "${P.code}"?`)&&(Te(u,P.code),le=!0,fe(u),S("ลบรายการโปรดแล้ว","success"));break}case"del-room":m("ลบห้อง","ยืนยันการลบห้องนี้?",()=>Le(s,"ลบห้องแล้ว"));break;case"del-item":m("ลบรายการ","ยืนยันการลบรายการนี้?",()=>Le(l,"ลบรายการแล้ว"));break;case"del-wall":m("ลบผนัง","ยืนยันการลบผนังนี้?",()=>Le(r.closest(".wall-input-row"),"ลบผนังแล้ว",()=>re(l)));break;case"clear-room":m("ล้างข้อมูลในห้อง","ยืนยันลบทุกรายการในห้องนี้?",()=>{Z(B()),H(),s.querySelector(h.allItemsContainer).innerHTML="",J(),N(),I(),S("ล้างข้อมูลในห้องแล้ว","success")});break;case"toggle-room-menu":e.preventDefault();const c=r.nextElementSibling;if(!c||!s)return;const y=!c.classList.contains("show");document.querySelectorAll(".room-options-menu.show").forEach(f=>f.classList.remove("show")),y&&c.classList.add("show");break;case"toggle-suspend-room":e.preventDefault(),s==null||s.classList.toggle("is-suspended"),(p=r.closest(".room-options-menu"))==null||p.classList.remove("show"),N(),I(),te==="suspended"&&we();break;case"toggle-suspend":e.preventDefault(),l==null||l.classList.toggle("is-suspended"),re(r),I(),te==="suspended"&&we();break}};function Vt(){F=!F,tt()}function Ut(e){if(!e||e.closest(".modal-wrapper"))return;const t=e.getAttribute("name"),o=e.closest(".item-card"),n=(s=>{const l=s[t];if(!l)return null;const m=o||document;let i=null;return typeof l=="string"?i=m.querySelector(`[name="${l}"]:not(:disabled)`):typeof l=="function"&&(i=l(e)),!i&&o&&typeof l=="string"&&(i=document.querySelector(`[name="${l}"]:not(:disabled)`)),i})({customer_name:"customer_phone",customer_phone:"customer_address",customer_address:()=>document.querySelector(".room-name-input"),room_name:s=>{var l;return(l=s.closest(".room-card"))==null?void 0:l.querySelector('[data-act="add-item"]')},width_m:"height_m",height_m:"set_price_per_m",set_price_per_m:s=>{var i;const l=s.closest(".set-item"),m=(i=l==null?void 0:l.querySelector('[name="fabric_variant"]'))==null?void 0:i.value;return m!=null&&m.includes("โปร่ง")?l==null?void 0:l.querySelector('[name="sheer_price_per_m"]'):l==null?void 0:l.querySelector('[data-act="toggle-more-details"]')},sheer_price_per_m:s=>{var l;return(l=s.closest(".item-card"))==null?void 0:l.querySelector('[data-act="toggle-more-details"]')},area_width_m:"area_height_m",area_height_m:"area_price_sqyd",area_price_sqyd:"area_code",wall_width_m:s=>{var m,i;const l=(m=s.closest(".wall-input-row"))==null?void 0:m.nextElementSibling;return l!=null&&l.matches(".wall-input-row")?l.querySelector("input"):(i=s.closest(".item-card"))==null?void 0:i.querySelector('[name="wallpaper_price_roll"]')},wallpaper_price_roll:"wallpaper_height_m",wallpaper_height_m:"wallpaper_code"});n&&(n.focus(),typeof n.select=="function"&&n.select())}function Gt(){const e=document.querySelector(h.setTpl);if(!e)return;const t=e.content.querySelector('select[name="set_price_per_m"]'),o=e.content.querySelector('select[name="sheer_price_per_m"]'),r=a=>{let n='<option value="" hidden>เลือกราคา</option>';return Array.isArray(a)?(a.forEach(s=>{n+=`<option value="${s}">${s.toLocaleString("th-TH")}</option>`}),n):(console.error("Price data for dropdown is not available or not an array.",a),n)};t&&(t.innerHTML=r(ye.fabric)),o&&(o.innerHTML=r(ye.sheer))}function Yt(){Gt(),Xe();const e=document.querySelector(h.orderForm),t=document.querySelector(h.fileImporter),o=document.querySelector("#favImporter"),r=document.querySelector(h.menuDropdown),a=document.querySelector(h.quickNavDropdown),n=document.querySelector("#pageBreakBuffer"),s=document.querySelector("#pageBreakBufferValue");n&&s&&n.addEventListener("input",()=>{s.textContent=n.value}),e.addEventListener("input",Ge),e.addEventListener("change",Ge),document.addEventListener("click",Wt),e.addEventListener("blur",jt,!0),e.addEventListener("focusin",Dt,!0),e.addEventListener("focusin",i=>{const d=i.target.closest(".item-card");d&&Ve(d)},!0),e.addEventListener("keydown",i=>{const d=i.target;i.key==="Enter"&&!d.matches("textarea, button, [data-act]")&&(i.preventDefault(),Ut(d))});const l=i=>{const d=i.target.closest(h.room);d&&rt(d)};e.addEventListener("click",l),e.addEventListener("focusin",l),document.body.addEventListener("click",i=>{const d=i.target.closest("summary");if(d){const c=d.closest("details.card");setTimeout(()=>{O(),I(),c&&c.open&&Ve(c)},50)}const p=i.target.closest('[data-act="jump-to-item"]');p&&ot(p)}),document.querySelector("#undoBtn").addEventListener("click",i=>{i.preventDefault(),Lt()}),document.querySelector(h.lockBtn).addEventListener("click",Vt),document.querySelector(h.toggleAllRoomsBtn).addEventListener("click",$t),document.querySelector(h.quickNavBtn).addEventListener("click",i=>{var p;i.stopPropagation(),r.classList.remove("show");const d=!a.classList.contains("show");a.classList.toggle("show"),i.currentTarget.setAttribute("aria-expanded",d),d&&((p=document.querySelector(h.menuBtn))==null||p.setAttribute("aria-expanded","false"))}),document.querySelector(h.quickNavRoomList).addEventListener("click",i=>{var p;const d=i.target.closest("a[data-jump-to]");if(d){i.preventDefault();const c=d.dataset.jumpTo,y=document.getElementById(c);y&&(document.body.classList.add("disable-animations"),y.open=!0,y.scrollIntoView({behavior:"auto",block:"start"}),y.classList.add("scrolling-jump"),setTimeout(()=>{y.classList.remove("scrolling-jump"),document.body.classList.remove("disable-animations"),O()},1e3)),a.classList.remove("show"),(p=document.querySelector(h.quickNavBtn))==null||p.setAttribute("aria-expanded","false")}});const m=document.querySelector("#addRoomQuickNavBtn");if(m){const i=ut(ae,700);m.addEventListener("click",d=>{var p;d.stopPropagation(),i(),a.classList.remove("show"),(p=document.querySelector(h.quickNavBtn))==null||p.setAttribute("aria-expanded","false")})}document.querySelector(h.menuBtn).addEventListener("click",i=>{var p;i.stopPropagation(),a.classList.remove("show");const d=!r.classList.contains("show");r.classList.toggle("show"),i.currentTarget.setAttribute("aria-expanded",d),d&&((p=document.querySelector(h.quickNavBtn))==null||p.setAttribute("aria-expanded","false"))}),document.querySelector("#themeToggleBtn").addEventListener("click",i=>{i.preventDefault(),wt()}),document.querySelector("#overviewBtn").addEventListener("click",async i=>{var y;i.preventDefault(),r.classList.remove("show"),(y=document.querySelector(h.menuBtn))==null||y.setAttribute("aria-expanded","false");const d=B(),p=document.querySelector("#overviewModalHeader"),c=document.querySelector("#overviewModalBody");if(p&&c){const f=d.rooms.reduce((g,b)=>{if(b.is_suspended)return g;const q=(b.items||[]).filter(w=>{if(w.is_suspended)return!1;let L=0;switch(w.type){case"set":L=T.calculateSetPrice(w).total;break;case"wallpaper":L=T.calculateWallpaperPrice(w).total;break;default:L=T.calculateDecoPrice(w).total;break}return L>0}).length;return g+q},0),u=document.querySelector(h.grandTotal).textContent||"0",v=d.rooms.filter(g=>!g.is_suspended&&g.items&&g.items.some(b=>!b.is_suspended)).length;p.innerHTML=`
                <div class="overview-stats-grid">
                    <div class="overview-stat-card">
                        <i class="ph-bold ph-map-pin-line"></i>
                        <div class="stat-value">${v}</div>
                        <div class="stat-label">ห้อง</div>
                    </div>
                    <div class="overview-stat-card">
                        <i class="ph-bold ph-stack"></i>
                        <div class="stat-value">${f}</div>
                        <div class="stat-label">รายการ</div>
                    </div>
                    <div class="overview-stat-card">
                        <i class="ph-bold ph-coins"></i>
                        <div class="stat-value">${u}</div>
                        <div class="stat-label">ยอดรวม</div>
                    </div>
                </div>
            `,c.innerHTML=yt(d),$("#overviewModal")}}),document.querySelector(h.exportPdfBtn).addEventListener("click",async i=>{var y;i.preventDefault(),r.classList.remove("show"),(y=document.querySelector(h.menuBtn))==null||y.setAttribute("aria-expanded","false");const d=await Et();if(!d)return;const p=B(),c=ht(p,{vatRate:d.vatOption==="include"?ke.baseVatRate:0,pageBreakBuffer:d.pageBreakBuffer});if(!c){S("ไม่มีรายการที่มีราคาสำหรับสร้างเอกสาร","warning");return}d.exportMethod==="html"?Ot(c):Rt(c,d.exportMethod)}),document.querySelector("#visualReportsBtn").addEventListener("click",async i=>{var d;i.preventDefault(),r.classList.remove("show"),(d=document.querySelector(h.menuBtn))==null||d.setAttribute("aria-expanded","false"),$("#visualReportsModal")}),document.querySelector("#visualReportsConfirm").addEventListener("click",async i=>{var c;i.preventDefault();const d=document.querySelector("#visualReportsModal"),p=(c=d.querySelector('input[name="report_type_option"]:checked'))==null?void 0:c.value;if(!p){S("โปรดเลือกประเภทรายงาน","warning");return}if(d.classList.remove("visible"),p==="lookbook"){const y=B(),f=vt(y),u=document.querySelector("#lookbookModalBody");f&&u?(u.innerHTML=f,$("#lookbookModal")):S("ไม่มีข้อมูลสำหรับสร้างรายงาน","warning")}else S(`รายงานประเภท '${p}' ยังไม่พร้อมใช้งาน`,"default")}),document.querySelector(h.importBtn).addEventListener("click",i=>{var d;i.preventDefault(),r.classList.remove("show"),(d=document.querySelector(h.menuBtn))==null||d.setAttribute("aria-expanded","false"),t.click()}),t.addEventListener("change",i=>{var c;const d=(c=i.target.files)==null?void 0:c[0];if(!d)return;const p=new FileReader;p.onload=async y=>{try{const f=JSON.parse(y.target.result);await Ee(f,!0)}catch(f){S("ไฟล์ JSON ไม่ถูกต้อง","error"),console.error("JSON Parse Error:",f)}},p.readAsText(d),i.target.value=null}),document.querySelector(h.exportBtn).addEventListener("click",i=>{var d;i.preventDefault(),r.classList.remove("show"),(d=document.querySelector(h.menuBtn))==null||d.setAttribute("aria-expanded","false");try{const p=B(),c=JSON.stringify(p,null,4),y=new Blob([c],{type:"application/json"}),f=URL.createObjectURL(y),u=document.createElement("a"),v=new Date,g=`${v.getFullYear()}${(v.getMonth()+1).toString().padStart(2,"0")}${v.getDate().toString().padStart(2,"0")}`,b=`${v.getHours().toString().padStart(2,"0")}${v.getMinutes().toString().padStart(2,"0")}`,q=Ye(p.customer_name||"data");u.href=f,u.download=`MTR-${g}${b}-${q}.json`,u.click(),URL.revokeObjectURL(f),S("Export ข้อมูลสำเร็จ","success")}catch{S("Export ข้อมูลล้มเหลว","error")}}),document.querySelector("#importFavsBtn").addEventListener("click",i=>{var d;i.preventDefault(),r.classList.remove("show"),(d=document.querySelector(h.menuBtn))==null||d.setAttribute("aria-expanded","false"),o.click()}),o.addEventListener("change",i=>{var c;const d=(c=i.target.files)==null?void 0:c[0];if(!d)return;const p=new FileReader;p.onload=y=>{try{const f=JSON.parse(y.target.result),u=Je(f);u>0?S(`เพิ่มรายการโปรดใหม่ ${u} รายการ`,"success"):S("ไม่พบรายการโปรดใหม่ที่จะเพิ่ม","default"),I()}catch(f){S("ไฟล์ JSON ไม่ถูกต้อง","error"),console.error("Favorites JSON Parse Error:",f)}},p.readAsText(d),i.target.value=null}),document.querySelector("#exportFavsBtn").addEventListener("click",i=>{var d;i.preventDefault(),r.classList.remove("show"),(d=document.querySelector(h.menuBtn))==null||d.setAttribute("aria-expanded","false");try{const p=Y(),c=JSON.stringify(p,null,4),y=new Blob([c],{type:"application/json"}),f=URL.createObjectURL(y),u=document.createElement("a"),v=new Date,g=`${v.getFullYear()}${(v.getMonth()+1).toString().padStart(2,"0")}${v.getDate().toString().padStart(2,"0")}`;u.href=f,u.download=`MTR-Favorites-${g}.json`,u.click(),URL.revokeObjectURL(f),S("Export รายการโปรดสำเร็จ","success")}catch{S("Export รายการโปรดล้มเหลว","error")}}),document.querySelector(h.submitBtn).addEventListener("click",async i=>{var d;if(i.preventDefault(),r.classList.remove("show"),(d=document.querySelector(h.menuBtn))==null||d.setAttribute("aria-expanded","false"),await ce("ส่งข้อมูล","ยืนยันการส่งข้อมูลการประเมินราคา?")){const p=B();if(!p.customer_name&&!p.customer_phone){S("กรุณาระบุชื่อหรือเบอร์โทรลูกค้า","warning");return}S("กำลังส่งข้อมูล...","default");try{const c=await fetch(st,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(p)});c.ok?S("ส่งข้อมูลสำเร็จ!","success"):S(`ส่งข้อมูลล้มเหลว: ${c.status}`,"error")}catch{S("เกิดข้อผิดพลาดในการเชื่อมต่อ","error")}}}),document.querySelector(h.copyTextBtn).addEventListener("click",async i=>{var c;i.preventDefault(),r.classList.remove("show"),(c=document.querySelector(h.menuBtn))==null||c.setAttribute("aria-expanded","false");const d=document.querySelector(h.copyOptionsModal);d.querySelector('input[name="copy_option"][value="customer"]').checked=!0;const p=await $(h.copyOptionsModal);if(p&&!p.cancelled){const y=d.querySelector('input[name="copy_option"]:checked').value,f=ft(B(),y);try{await navigator.clipboard.writeText(f),S("คัดลอกสรุปสำเร็จ!","success")}catch{S("คัดลอกล้มเหลว","error")}}}),document.querySelector(h.clearItemsBtn).addEventListener("click",async i=>{var d;if(i.preventDefault(),r.classList.remove("show"),(d=document.querySelector(h.menuBtn))==null||d.setAttribute("aria-expanded","false"),await ce("ล้างทุกรายการ","คุณแน่ใจหรือไม่ว่าต้องการลบรายการสินค้าและส่วนลดทั้งหมด (ข้อมูลลูกค้าและห้องจะยังคงอยู่)?")){Z(B()),H(),document.querySelectorAll(h.room).forEach(y=>{const f=y.querySelector(h.allItemsContainer);f&&(f.innerHTML="")});const p=document.querySelector("#discount_type"),c=document.querySelector("#discount_value");p&&(p.value="amount"),c&&(c.value="0"),N(),I(),S("ล้างทุกรายการและส่วนลดแล้ว","success")}}),document.querySelector(h.clearAllBtn).addEventListener("click",async i=>{var d;if(i.preventDefault(),r.classList.remove("show"),(d=document.querySelector(h.menuBtn))==null||d.setAttribute("aria-expanded","false"),await ce("ลบข้อมูลทั้งหมด",'คำเตือน! การกระทำนี้จะลบข้อมูลลูกค้า, ทุกรายการ, และ "รายการโปรด" ทั้งหมดอย่างถาวร ยืนยันหรือไม่?')){Z(B()),H(),localStorage.removeItem(pe),mt();const p=document.querySelector("#customer_name"),c=document.querySelector("#customer_phone"),y=document.querySelector("#customer_address");p&&(p.value=""),c&&(c.value=""),y&&(y.value="");const f=document.querySelector("#discount_type"),u=document.querySelector("#discount_value");f&&(f.value="amount"),u&&(u.value="0");const v=document.querySelector(h.roomsContainer);v&&(v.innerHTML=""),N(),ie(),O(),ae();const g=document.querySelector("#customerDetailsCard");g&&(g.open=!0),S("ลบข้อมูลทั้งหมดแล้ว เริ่มต้นใหม่","success")}}),window.addEventListener("click",i=>{var d,p;i.target.closest(".modal-wrapper")||(i.target.closest(".menu-container")||(r.classList.contains("show")&&(r.classList.remove("show"),(d=document.querySelector(h.menuBtn))==null||d.setAttribute("aria-expanded","false")),a.classList.contains("show")&&(a.classList.remove("show"),(p=document.querySelector(h.quickNavBtn))==null||p.setAttribute("aria-expanded","false"))),i.target.closest(".room-options-container")||document.querySelectorAll(".room-options-menu.show").forEach(c=>c.classList.remove("show")),i.target.closest('[data-act="toggle-more-details"]')||document.querySelectorAll(".item-details-more.show").forEach(c=>{const y=c.closest(".item-card");y&&!y.contains(i.target)&&xe(y,!1)}))}),window.addEventListener("beforeunload",I);try{const i=localStorage.getItem(pe);if(i&&i.length>2&&i!=="null")Ee(JSON.parse(i),!1);else{ae();const d=document.querySelector("#customerDetailsCard");d&&(d.open=!0)}}catch(i){console.error("Failed to load data from localStorage:",i),localStorage.removeItem(pe),ae()}N(),tt(),O(),ue(),H()}document.addEventListener("DOMContentLoaded",Yt);
