(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))t(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&t(a)}).observe(document,{childList:!0,subtree:!0});function n(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function t(o){if(o.ep)return;o.ep=!0;const s=n(o);fetch(o.href,s)}})();const pt="vite-refactor/6.1.0",ft="https://your-make-webhook-url.com/your-unique-path",ve="marnthara.input.v6.1",mt=500,H={name:"ม่านธารา ผ้าม่านและของตกแต่ง",address:"65/8 หมู่ 2 ต.ท่าศาลา อ.เมือง จ.ลพบุรี 15000",phone:"092-985-9395, 082-552-5595",taxId:"1600668000020",logoUrl:"./assets/logo.png",baseVatRate:.07,pdf:{paymentTerms:"ชำระมัดจำ 50%",priceValidity:"30 วัน",notes:["ราคานี้รวมค่าติดตั้งแล้ว","ชำระมัดจำ 50% เพื่อยืนยันการสั่งผลิตสินค้า","ใบเสนอราคานี้มีอายุ 30 วัน นับจากวันที่เสนอราคา"]}},ht=1.19599,Fe={ROLL_WIDTH_M:.53,ROLL_LENGTH_M:10,STRIPS_PER_ROLL_UNDER_2_5M:3},ge={fabric:[1e3,1100,1200,1300,1400,1500,1600,1700,1800,1900,2e3,2100,2200,2300,2400,2500,2600,2700,2800,2900,3e3],sheer:[1e3,1100,1200,1300,1400,1500],louis:[2200,2300,2400,2500,2600,2700,2800,2900,3e3,3100,3200,3300,3400,3500],style_surcharge:{ลอน:200,ตาไก่:0,จีบ:0,ม่านพับ:0,หลุยส์:0},height:[{threshold:3.2,add_per_m:300},{threshold:2.8,add_per_m:200},{threshold:2.5,add_per_m:100}]},D={set:{templateId:"#setTpl",name:"ผ้าม่าน"},wallpaper:{templateId:"#wallpaperTpl",name:"วอลล์เปเปอร์"},wooden_blind:{templateId:"#areaBasedTpl",name:"มู่ลี่ไม้"},roller_blind:{templateId:"#areaBasedTpl",name:"ม่านม้วน"},vertical_blind:{templateId:"#areaBasedTpl",name:"ม่านปรับแสง"},partition:{templateId:"#areaBasedTpl",name:"ฉากกั้นห้อง"},pleated_screen:{templateId:"#areaBasedTpl",name:"มุ้งจีบ"},aluminum_blind:{templateId:"#areaBasedTpl",name:"มู่ลี่อลูมิเนียม"}},f={orderForm:"#orderForm",roomsContainer:"#rooms",toastContainer:"#toast-container",printableContent:"#printable-content",filterStatusBar:"#filterStatusBar",menuBtn:"#menuBtn",menuDropdown:"#menuDropdown",undoBtn:"#undoBtn",themeToggleBtn:"#themeToggleBtn",overviewBtn:"#overviewBtn",copyTextBtn:"#copyTextBtn",visualReportsBtn:"#visualReportsBtn",exportPdfBtn:"#exportPdfBtn",submitBtn:"#submitBtn",importBtn:"#importBtn",exportBtn:"#exportBtn",importFavsBtn:"#importFavsBtn",exportFavsBtn:"#exportFavsBtn",clearItemsBtn:"#clearItemsBtn",clearAllBtn:"#clearAllBtn",lockBtn:"#lockBtn",quickNavBtn:"#quickNavBtn",quickNavDropdown:"#quickNavDropdown",quickNavRoomList:"#quickNavRoomList",quickNavBtnText:"#quickNavBtnText",toggleAllRoomsBtn:"#toggleAllRoomsBtn",suspendedItemsBtn:"#suspendedItemsBtn",suspendedCountBadge:"#suspendedCountBadge",originalTotal:"#originalTotal",grandTotal:"#grandTotal",fileImporter:"#fileImporter",favImporter:"#favImporter",customerCard:"#customerDetailsCard",customerNameInput:"#customer_name",customerPhoneInput:"#customer_phone",customerAddressInput:"#customer_address",room:".room-card",roomTpl:"#roomTpl",roomNameInput:'input[name="room_name"]',roomNameDisplay:"[data-room-name-display]",roomBrief:"[data-room-brief]",allItemsContainer:"[data-all-items]",roomDefaultsBtn:'[data-act="open-room-defaults"]',itemCard:".item-card",itemDetailsMore:".item-details-more",itemGrid:".item-grid",itemTitle:"[data-item-title]",toggleDetailsBtn:'[data-act="toggle-more-details"]',setTpl:"#setTpl",setWidthInput:'input[name="width_m"]',setHeightInput:'input[name="height_m"]',setStyleSelect:'select[name="set_style"]',setFabricVariantSelect:'select[name="fabric_variant"]',setPricePerMSelect:'select[name="set_price_per_m"]',setSheerPricePerMSelect:'select[name="sheer_price_per_m"]',setLouisPricePerMSelect:'select[name="louis_price_per_m"]',setFabricCodeInput:'input[name="fabric_code"]',setSheerCodeInput:'input[name="sheer_fabric_code"]',setOpeningStyleSelect:'select[name="opening_style"]',setAdjustmentSideSelect:'select[name="adjustment_side"]',setTrackColorInput:'input[name="track_color"]',setBracketColorInput:'input[name="bracket_color"]',setFinialColorInput:'input[name="finial_color"]',setGrommetColorInput:'input[name="grommet_color"]',setLouisValanceInput:'input[name="louis_valance"]',setLouisTasselsInput:'input[name="louis_tassels"]',setNotesInput:'input[name="notes"]',wallpaperTpl:"#wallpaperTpl",wallTpl:"#wallTpl",wallHeightInput:'[name="wallpaper_height_m"]',wallCodeInput:'[name="wallpaper_code"]',wallPriceRollInput:'[name="wallpaper_price_roll"]',wallInstallCostInput:'[name="wallpaper_install_cost"]',wallNotesInput:'[name="wallpaper_notes"]',wallWidthInput:'[name="wall_width_m"]',areaBasedTpl:"#areaBasedTpl",areaBasedItem:".area-based-item",areaWidthInput:'[name="area_width_m"]',areaHeightInput:'[name="area_height_m"]',areaPriceSqydInput:'[name="area_price_sqyd"]',areaCodeInput:'[name="area_code"]',areaNotesInput:'[name="area_notes"]',modal:"#confirmationModal",modalTitle:"#modalTitle",modalBody:"#modalBody",discountModal:"#discountModal",discountSubtotal:"#discountSubtotal",discountPercent:"#discountPercent",discountAmount:"#discountAmount",discountFinalTotal:"#discountFinalTotal",discountTypeInput:"#discount_type",discountValueInput:"#discount_value",copyOptionsModal:"#copyOptionsModal",visualReportsModal:"#visualReportsModal",lookbookModal:"#lookbookModal",lookbookModalBody:"#lookbookModalBody",exportOptionsModal:"#exportOptionsModal",pdfOptionsModal:"#pdfOptionsModal",exportPdfWithDetailsBtn:"#exportPdfWithDetailsBtn",exportPdfWithoutDetailsBtn:"#exportPdfWithoutDetailsBtn",itemTypeModal:"#itemTypeModal",itemTypeModalTitle:"#itemTypeModalTitle",hardwareModal:"#hardwareModal",modalTrackColor:'[name="modal_track_color"]',modalBracketColor:'[name="modal_bracket_color"]',modalFinialColor:'[name="modal_finial_color"]',modalGrommetColor:'[name="modal_grommet_color"]',modalLouisValance:'[name="modal_louis_valance"]',modalLouisTassels:'[name="modal_louis_tassels"]',trackColorGroup:"#trackColorGroup",bracketColorGroup:"#bracketColorGroup",finialColorGroup:"#finialColorGroup",grommetColorGroup:"#grommetColorGroup",louisValanceGroup:"#louisValanceGroup",louisTasselGroup:"#louisTasselGroup",hardwareApplyToRoomBtn:"#hardwareApplyToRoom",favoritesConflictModal:"#favoritesConflictModal",favoritesModal:"#favoritesModal",favoritesModalTitle:"#favoritesModalTitle",favoritesModalBody:"#favoritesModalBody",favSearchInput:"#favSearchInput",favSelectorItemTpl:"#favSelectorItemTpl",favInput:"input[data-favorite-type]",favManagerModal:"#favManagerModal",favManagerTitle:"#favManagerTitle",favManagerBody:"#favManagerBody",favManagerItemTpl:"#favManagerItemTpl",favManagerEditBtn:'#favManagerModal [data-act="edit-selected-fav"]',favManagerDelBtn:'#favManagerModal [data-act="del-selected-fav"]',favAddModal:"#favAddModal",favAddCodeInput:'[name="fav_code_add"]',favAddPriceInput:'[name="fav_price_add"]',favEditModal:"#favEditModal",favEditCodeInput:'[name="fav_code_edit"]',favEditPriceInput:'[name="fav_price_edit"]',roomDefaultsModal:"#roomDefaultsModal",roomDefaultsForm:"#roomDefaultsForm",roomDefaultsApplyBtn:"#roomDefaultsApplyBtn",roomDefaultsConfirmBtn:"#roomDefaultsConfirmBtn",roomDefaultsCancelBtn:"#roomDefaultsCancelBtn",overviewModal:"#overviewModal",overviewModalHeader:"#overviewModalHeader",overviewModalBody:"#overviewModalBody"},y=e=>{typeof e=="string"&&(e=e.replace(/,/g,""));const r=parseFloat(e);return Number.isFinite(r)?r:0},ue=e=>{const r=y(e);return r>0?r.toFixed(2):""},Z=(e,r=2,n=!1)=>Number.isFinite(e)?e.toLocaleString("en-US",{minimumFractionDigits:n?2:r,maximumFractionDigits:n?2:r}):"0",C=(e,r=0)=>Number.isFinite(e)?e.toLocaleString("th-TH",{minimumFractionDigits:r,maximumFractionDigits:r}):"0",we=(e,r=150)=>{let n;return(...t)=>{clearTimeout(n),n=setTimeout(()=>e(...t),r)}},yt=(e,r=700)=>{let n=!1;return(...t)=>{if(!n){n=!0;try{return e(...t)}finally{setTimeout(()=>{n=!1},r)}}}},T=e=>typeof e!="string"?"":e.replace(/[&<>"']/g,function(r){switch(r){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";default:return"&#039;"}}),tt=e=>typeof e!="string"?"":e.replace(/[\\/?%*:|"<>\x00-\x1f]/g,"").trim()||"file";function _t(e){let r=y(e);if(isNaN(r))return"ข้อมูลตัวเลขไม่ถูกต้อง";if(r===0)return"ศูนย์บาทถ้วน";const n=["","หนึ่ง","สอง","สาม","สี่","ห้า","หก","เจ็ด","แปด","เก้า"],t=["","สิบ","ร้อย","พัน","หมื่น","แสน","ล้าน"];let o=Math.floor(r),s=Math.round((r-o)*100);const a=u=>{if(u===0)return"";let i="";const p=String(u);for(let d=0;d<p.length;d++){const m=p[d],v=p.length-d-1;m!=="0"&&(v===1&&m==="1"?i+=t[v]:v===1&&m==="2"?i+="ยี่"+t[v]:v===0&&m==="1"&&p.length>1?i+="เอ็ด":i+=n[parseInt(m)]+t[v])}return i};let l="";if(o>0){const u=Math.floor(o/1e6),i=o%1e6;u>0&&(l+=a(u)+"ล้าน"),l+=a(i),l+="บาท"}let c="";return s>0?c=a(s)+"สตางค์":o>0&&(l+="ถ้วน"),(l+c).trim()}const Ve="marnthara.favorites.v4",be={fabric:[],sheer:[],wallpaper:[],wooden_blind:[],roller_blind:[],vertical_blind:[],partition:[],pleated_screen:[],aluminum_blind:[]};function se(){try{const e=localStorage.getItem(Ve);return e?{...be,...JSON.parse(e)}:be}catch(e){return console.error("Failed to parse favorites from localStorage",e),be}}function Le(e){try{localStorage.setItem(Ve,JSON.stringify(e))}catch(r){console.error("Failed to save favorites to localStorage",r)}}function Ye(e){if(!e||typeof e!="object")return console.error("Invalid favorites data for import."),!1;const r={...be,...e};return Le(r),!0}function He(e){if(!e||typeof e!="object")return console.error("Invalid favorites data for merge."),0;const r=se();let n=0;for(const t in e)Object.hasOwnProperty.call(e,t)&&Array.isArray(e[t])&&(r[t]||(r[t]=[]),e[t].forEach(o=>{!r[t].some(a=>a.code===o.code)&&o.code&&(r[t].push(o),n++)}),r[t].sort((o,s)=>o.code.localeCompare(s.code)));return n>0&&Le(r),n}function vt(e,r,n){const t=se();if(!t[e]){if(!Object.hasOwnProperty.call(be,e))return console.error(`Attempted to add favorite to an invalid type: ${e}`),!1;t[e]=[]}const o=t[e],s=o.find(a=>a.code===r);return s?s.price=n:o.push({code:r,price:n}),o.sort((a,l)=>a.code.localeCompare(l.code)),Le(t),!0}function je(e,r){const n=se();if(!n[e])return!1;const t=n[e].findIndex(o=>o.code===r);return t>-1?(n[e].splice(t,1),Le(n),!0):!1}function Ue(e,r){if(!e||!r)return;const n=se(),t=r.trim();return(n[e]||[]).find(s=>s.code===t)}function ot(e,r){return!!Ue(e,r)}function Ie(e,r,n){return ot(e,r)?(je(e,r),!1):(vt(e,r,n),!0)}function gt(){localStorage.removeItem(Ve),console.log("All favorites have been cleared.")}function J(){const e=se(),r={app_version:pt,customer_name:document.querySelector(f.customerNameInput)?.value||"",customer_phone:document.querySelector(f.customerPhoneInput)?.value||"",customer_address:document.querySelector(f.customerAddressInput)?.value||"",customer_card_open:document.querySelector(f.customerCard)?.open,discount:{type:document.querySelector(f.discountTypeInput)?.value||"amount",value:y(document.querySelector(f.discountValueInput)?.value)},rooms:[],favorites:e};return document.querySelectorAll(f.room).forEach(n=>{const t={id:n.id,room_name:n.querySelector(f.roomNameInput)?.value||"",is_suspended:n.classList.contains("is-suspended"),is_open:n.open,room_defaults:JSON.parse(n.dataset.roomDefaults||"{}"),items:[]};n.querySelector(f.allItemsContainer)?.childNodes.forEach(o=>{if(o.nodeType!==1||!o.matches(f.itemCard))return;const s=o.dataset.type;if(!s)return;let a={type:s,is_suspended:o.classList.contains("is-suspended")};s==="set"?Object.assign(a,{width_m:y(o.querySelector(f.setWidthInput)?.value),height_m:y(o.querySelector(f.setHeightInput)?.value),style:o.querySelector(f.setStyleSelect)?.value||"",fabric_variant:o.querySelector(f.setFabricVariantSelect)?.value||"",price_per_m_raw:y(o.querySelector(f.setPricePerMSelect)?.value),sheer_price_per_m:y(o.querySelector(f.setSheerPricePerMSelect)?.value),louis_price_per_m:y(o.querySelector('select[name="louis_price_per_m"]')?.value),fabric_code:o.querySelector(f.setFabricCodeInput)?.value||"",sheer_fabric_code:o.querySelector(f.setSheerCodeInput)?.value||"",opening_style:o.querySelector(f.setOpeningStyleSelect)?.value||"",adjustment_side:o.querySelector(f.setAdjustmentSideSelect)?.value||"ปรับขวา",track_color:o.querySelector(f.setTrackColorInput)?.value||"ขาว",bracket_color:o.querySelector(f.setBracketColorInput)?.value||"ขาว",finial_color:o.querySelector(f.setFinialColorInput)?.value||"ขาว",grommet_color:o.querySelector(f.setGrommetColorInput)?.value||"เงิน",louis_valance:o.querySelector('input[name="louis_valance"]')?.value||"กล่องหลุยส์",louis_tassels:o.querySelector('input[name="louis_tassels"]')?.value||"สีเข้ากับผ้า",notes:o.querySelector(f.setNotesInput)?.value||""}):s==="wallpaper"?Object.assign(a,{height_m:y(o.querySelector(f.wallHeightInput)?.value),wallpaper_code:o.querySelector(f.wallCodeInput)?.value||"",price_per_roll:y(o.querySelector(f.wallPriceRollInput)?.value),install_cost_per_roll:y(o.querySelector(f.wallInstallCostInput)?.value),notes:o.querySelector(f.wallNotesInput)?.value||"",widths:Array.from(o.querySelectorAll(f.wallWidthInput)).map(l=>y(l.value))}):o.matches(f.areaBasedItem)&&(Object.assign(a,{width_m:y(o.querySelector(f.areaWidthInput)?.value),height_m:y(o.querySelector(f.areaHeightInput)?.value),price_sqyd:y(o.querySelector(f.areaPriceSqydInput)?.value),code:o.querySelector(f.areaCodeInput)?.value||"",notes:o.querySelector(f.areaNotesInput)?.value||""}),(s==="partition"||s==="pleated_screen")&&(a.opening_style=o.querySelector('select[name="opening_style"]')?.value||"แยกกลาง"),["wooden_blind","roller_blind","vertical_blind","aluminum_blind"].includes(s)&&(a.adjustment_side=o.querySelector('select[name="adjustment_side"]')?.value||"ปรับขวา")),t.items.push(a)}),r.rooms.push(t)}),r}function X(){try{const e=J();localStorage.setItem(ve,JSON.stringify(e))}catch(e){console.error("Failed to save data to localStorage:",e)}}const me=[],bt=10;function ne(e){if(!e){console.warn("Attempted to push invalid state to undo stack.");return}try{const r=JSON.parse(JSON.stringify(e));me.push(r),me.length>bt&&me.shift()}catch(r){console.error("Failed to clone state for undo history:",r)}}function St(){if(me.length!==0)return me.pop()}function wt(){return me.length>0}const F={stylePlus:e=>ge.style_surcharge[e]??0,heightPlus:e=>{const r=[...ge.height].sort((n,t)=>t.threshold-n.threshold);for(const n of r)if(e>n.threshold)return n.add_per_m;return 0},fabricYardage:(e,r)=>{const n=y(r);if(n<=0||!e)return 0;if(e==="ตาไก่"||e==="จีบ")return(n*2+.6)/.9;if(e==="ลอน")return(n*2.6+.6)/.9;if(e==="ม่านพับ")return(n+.3)/.9;if(e==="หลุยส์"){const o=Math.max(3,Math.ceil(n/.8))*1.5,s=2.5*2;return(n*2+.6+o+s)/.9}return 0},calculateGrommets:function(e){if(!e||e.style!=="ตาไก่"||y(e.width_m)<=0)return 0;const r=y(e.width_m),n=2,t=.05,o=.16;let s;e.opening_style==="แยกกลาง"?s=r/2:s=r;const a=s*n+2*t;let l=Math.round(a/o);return l%2!==0&&(l+=1),l<4&&(l=4),e.opening_style==="แยกกลาง"?l*2:l},wallpaperRolls:(e,r)=>{const n=y(e),t=y(r);if(n<=0||t<=0)return 0;const o=t>2.5?Math.floor(Fe.ROLL_LENGTH_M/t):Fe.STRIPS_PER_ROLL_UNDER_2_5M;if(o<=0)return 0;const s=Math.ceil(n/Fe.ROLL_WIDTH_M);return Math.ceil(s/o)},calculateSetPrice:function(e){if(!e||e.is_suspended||y(e.width_m)<=0)return{total:0,opaque:0,sheer:0,louis:0};const r=this.stylePlus(e.style),n=this.heightPlus(y(e.height_m)),t=y(e.width_m),o=y(e.price_per_m_raw),s=y(e.sheer_price_per_m),a=y(e.louis_price_per_m);let l=0,c=0,u=0;return e.style==="หลุยส์"?(e.fabric_variant?.includes("ทึบ")&&o>0&&(l=(o+r+n)*t),e.fabric_variant?.includes("โปร่ง")&&s>0&&(c=(s+r+n)*t),a>0&&(u=(a+n)*t)):(e.fabric_variant?.includes("ทึบ")&&o>0&&(l=(o+r+n)*t),e.fabric_variant?.includes("โปร่ง")&&s>0&&(c=(s+r+n)*t)),{total:Math.round(l+c+u),opaque:Math.round(l),sheer:Math.round(c),louis:Math.round(u)}},calculateAreaBasedPrice:function(e){if(!e||e.is_suspended||y(e.width_m)<=0||y(e.height_m)<=0)return{total:0,sqm:0,sqyd:0};const r=y(e.width_m)*y(e.height_m),n=r*ht,t=n*y(e.price_sqyd);return{total:Math.round(t),sqm:r,sqyd:n}},calculateWallpaperPrice:function(e){if(!e||e.is_suspended)return{total:0,material:0,install:0,rolls:0,sqm:0};const r=e.widths?.reduce((l,c)=>l+y(c),0)||0;if(r<=0)return{total:0,material:0,install:0,rolls:0,sqm:0};const n=y(e.height_m),t=this.wallpaperRolls(r,n),o=t*y(e.price_per_roll),s=e.install_cost_per_roll===""||e.install_cost_per_roll===null||e.install_cost_per_roll===void 0?300:y(e.install_cost_per_roll),a=t*s;return{total:Math.round(o+a),material:Math.round(o),install:Math.round(a),rolls:t,sqm:r*n}}},Y=Object.entries(D).reduce((e,[r,n])=>(e[r]=n.name,e),{});Y.set_louis="ม่านหลุยส์";function ie(e){const{width:r=0,height:n=0}=e,t=15,o=100-t*2,s=100-t*2,a=r>0&&n>0?Math.min(o/r,s/n):1,l=r*a,c=n*a,u=(100-l)/2,i=(100-c)/2,p=`
        <line x1="${u}" y1="${i+c+5}" x2="${u+l}" y2="${i+c+5}" class="dimension-line" />
        <line x1="${u}" y1="${i+c+3}" x2="${u}" y2="${i+c+7}" class="dimension-tick" />
        <line x1="${u+l}" y1="${i+c+3}" x2="${u+l}" y2="${i+c+7}" class="dimension-tick" />
        <text x="50" y="${i+c+14}" class="dimension-text">${r.toFixed(2)} ม.</text>

        <line x1="${u-5}" y1="${i}" x2="${u-5}" y2="${i+c}" class="dimension-line" />
        <line x1="${u-7}" y1="${i}" x2="${u-3}" y2="${i}" class="dimension-tick" />
        <line x1="${u-7}" y1="${i+c}" x2="${u-3}" y2="${i+c}" class="dimension-tick" />
        <text x="${u-9}" y="50" class="dimension-text" transform="rotate(-90, ${u-9}, 50)">${n.toFixed(2)} ม.</text>
    `;return{x:u,y:i,svgWidth:l,svgHeight:c,lines:p}}function rt(e,{y:r,svgHeight:n}){if(!e.opening_style||e.opening_style==="สไลด์เดี่ยว")return"";const t=e.opening_style==="แยกกลาง"?"< >":"→";return`
        <rect x="40" y="${r+n/2-8}" width="20" height="16" rx="3" class="opening-text-bg" />
        <text x="50" y="${r+n/2+1}" class="opening-text">${t}</text>
    `}function Ce(e,{x:r,y:n,svgWidth:t}){if(!e.adjustment_side)return"";const s=e.adjustment_side==="ปรับซ้าย"?r+8:r+t-8;return`
        <g class="adjustment-cord">
            <circle cx="${s}" cy="${n+3}" r="2"/>
            <line x1="${s}" y1="${n+5}" x2="${s}" y2="${n+15}"/>
        </g>
    `}function qt(e){const r=y(e.width_m),n=y(e.height_m);if(r<=0||n<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:t,y:o,svgWidth:s,svgHeight:a,lines:l}=ie({width:r,height:n});let c="";const u=e.fabric_variant.includes("โปร่ง"),i=e.fabric_variant.includes("ทึบ"),p=(v,_)=>(e.opening_style||"แยกกลาง")==="แยกกลาง"?`
                <rect x="${t}" y="${o+_}" width="${s/2-1}" height="${a}" class="${v}" />
                <rect x="${t+s/2+1}" y="${o+_}" width="${s/2-1}" height="${a}" class="${v}" />
            `:`<rect x="${t}" y="${o+_}" width="${s}" height="${a}" class="${v}" />`;u&&(c+=p("curtain-panel-sheer",0)),i&&(c+=p("curtain-panel-opaque",u?-2:0));let d="";if(e.style==="ตาไก่"){const v=F.calculateGrommets(e)/((e.opening_style||"แยกกลาง")==="แยกกลาง"?2:1),_=Math.min(Math.floor(v),Math.max(8,Math.floor(s/8)));for(let h=0;h<_;h++){const S=t+s/(_>1?_-1:1)*h;d+=`<circle cx="${S}" cy="${o+2}" r="2" class="style-grommet" />`}}else if(e.style==="ลอน"){const v=Math.max(4,Math.floor(s/10));let _=`M ${t},${o}`;for(let h=0;h<v;h++)_+=" q 5,-4 10,0";d=`<path d="${_}" class="style-ripplefold-path" />`}else e.style==="จีบ"&&(d=`<text x="${t+2}" y="${o+5}" class="style-pleat-text">||| ||| ||| ||| |||</text>`);const m=rt(e,{y:o,svgHeight:a});return`<svg viewBox="0 0 100 100">${c}${d}${m}${l}</svg>`}function $t(e){const r=y(e.width_m),n=y(e.height_m);if(r<=0||n<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:t,y:o,svgWidth:s,svgHeight:a,lines:l}=ie({width:r,height:n});let c="";const u=e.fabric_variant.includes("โปร่ง"),i=e.fabric_variant.includes("ทึบ"),p=(h,S)=>`
        <rect x="${t}" y="${o+S}" width="${s/2-1}" height="${a}" class="${h}" />
        <rect x="${t+s/2+1}" y="${o+S}" width="${s/2-1}" height="${a}" class="${h}" />
    `;u&&(c+=p("curtain-panel-sheer",0)),i&&(c+=p("curtain-panel-opaque",u?-2:0));const d=Math.max(3,Math.floor(s/15)),m=s/d;let v="";for(let h=0;h<d;h++){const S=t+h*m;v+=`<path d="M ${S},${o} Q ${S+m/2},${o+10} ${S+m},${o}" class="louis-swag" />`}v+=`
        <polygon points="${t},${o} ${t+8},${o} ${t},${o+15}" class="louis-tail" />
        <polygon points="${t+s},${o} ${t+s-8},${o} ${t+s},${o+15}" class="louis-tail" />
    `;let _="";if(e.louis_tassels&&e.louis_tassels!=="ไม่มี"){_+=`<circle cx="${t+5}" cy="${o+18}" r="2" class="louis-tassel" />`,_+=`<circle cx="${t+s-5}" cy="${o+18}" r="2" class="louis-tassel" />`;for(let h=1;h<d;h++)_+=`<circle cx="${t+h*m}" cy="${o+8}" r="2" class="louis-tassel" />`}return`<svg viewBox="0 0 100 100">${c}${v}${_}${l}</svg>`}function kt(e){const r=y(e.width_m),n=y(e.height_m);if(r<=0||n<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:t,y:o,svgWidth:s,svgHeight:a,lines:l}=ie({width:r,height:n});let c=`<rect x="${t}" y="${o}" width="${s}" height="${a}" class="blind-frame" />`;const u=5,i=a/u;for(let d=0;d<u;d++)c+=`<rect x="${t+1}" y="${o+d*i}" width="${s-2}" height="${i-1.5}" class="blind-slat" />`;const p=Ce(e,{x:t,y:o,svgWidth:s});return`<svg viewBox="0 0 100 100">${c}${l}${p}</svg>`}function Qe(e,r=!1){const n=y(e.width_m),t=y(e.height_m);if(n<=0||t<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:o,y:s,svgWidth:a,svgHeight:l,lines:c}=ie({width:n,height:t});let u=`<rect x="${o}" y="${s}" width="${a}" height="${l}" class="blind-frame" />`;if(r){const p=Math.max(4,Math.floor(a/8)),d=a/p;for(let m=0;m<p;m++)u+=`<rect x="${o+m*d+1}" y="${s}" width="${d-2}" height="${l}" class="blind-slat" />`}else{const p=Math.max(3,Math.floor(l/6)),d=l/p;for(let m=0;m<p;m++)u+=`<rect x="${o+1}" y="${s+m*d+.5}" width="${a-2}" height="${d-1}" class="blind-slat" />`}const i=Ce(e,{x:o,y:s,svgWidth:a});return`<svg viewBox="0 0 100 100">${u}${c}${i}</svg>`}function xt(e){const r=y(e.width_m),n=y(e.height_m);if(r<=0||n<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:t,y:o,svgWidth:s,svgHeight:a,lines:l}=ie({width:r,height:n});let c=`<rect x="${t}" y="${o}" width="${s}" height="${a}" class="blind-frame" />`;const u=Math.max(3,Math.floor(a/8)),i=a/u;for(let h=0;h<u;h++)c+=`<rect x="${t+1}" y="${o+h*i}" width="${s-2}" height="${i-1.5}" rx="0.5" class="wooden-blind-slat" />`;const p=Math.max(2,s*.05),d=t+s*.25-p/2,m=t+s*.75-p/2,v=`
        <rect x="${d}" y="${o}" width="${p}" height="${a}" class="wooden-blind-strip" />
        <rect x="${m}" y="${o}" width="${p}" height="${a}" class="wooden-blind-strip" />
    `,_=Ce(e,{x:t,y:o,svgWidth:s});return`<svg viewBox="0 0 100 100">${c}${v}${l}${_}</svg>`}function It(e){const r=y(e.width_m),n=y(e.height_m);if(r<=0||n<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:t,y:o,svgWidth:s,svgHeight:a,lines:l}=ie({width:r,height:n}),c=`
        <rect x="${t}" y="${o}" width="${s}" height="${a}" class="roller-fabric" />
        <rect x="${t-1}" y="${o-4}" width="${s+2}" height="5" rx="2" class="roller-roll" />
        <line x1="${t}" y1="${o+a}" x2="${t+s}" y2="${o+a}" class="roller-bar" />
    `,u=Ce(e,{x:t,y:o-2,svgWidth:s});return`<svg viewBox="0 0 100 100">${c}${l}${u}</svg>`}function Ke(e,r=!1){const n=y(e.width_m),t=y(e.height_m);if(n<=0||t<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:o,y:s,svgWidth:a,svgHeight:l,lines:c}=ie({width:n,height:t});let u="";if(r)u=`
            <defs>
                <pattern id="pleated-mesh" width="6" height="6" patternUnits="userSpaceOnUse">
                    <path d="M -1 1 L 1 -1 M 0 6 L 6 0" class="pleated-screen-mesh" />
                </pattern>
            </defs>
            <rect x="${o}" y="${s}" width="${a}" height="${l}" class="blind-frame" />
            <rect x="${o}" y="${s}" width="${a}" height="${l}" fill="url(#pleated-mesh)" />
        `;else{const p=Math.max(4,Math.floor(a/10)),d=a/p;for(let m=0;m<p;m++)u+=`<rect x="${o+m*d}" y="${s}" width="${d}" height="${l}" class="partition-panel" />`,m>0&&(u+=`<line x1="${o+m*d}" y1="${s}" x2="${o+m*d}" y2="${s+l}" class="partition-hinge" />`)}const i=rt(e,{y:s,svgHeight:l});return`<svg viewBox="0 0 100 100">${u}${i}${c}</svg>`}function Tt(e){const r=(e.widths||[]).reduce((d,m)=>d+y(m),0),n=y(e.height_m);if(r<=0||n<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:t,y:o,svgWidth:s,svgHeight:a,lines:l}=ie({width:r,height:n});let c="";const u=Math.floor(s/10),i=Math.floor(a/10);for(let d=0;d<i;d++)for(let m=0;m<u;m++)c+=`<circle cx="${t+m*10+5}" cy="${o+d*10+5}" r="1.5" class="wallpaper-pattern" />`;return`<svg viewBox="0 0 100 100">${`<rect x="${t}" y="${o}" width="${s}" height="${a}" class="blind-frame" /> ${c}`}${l}</svg>`}function Mt(e,r,n){let t="",o=Y[e.type]||"ของตกแต่ง";switch(e.type){case"set":e.style==="ม่านพับ"?t=kt(e):e.style==="หลุยส์"?(t=$t(e),o=Y.set_louis||"ม่านหลุยส์"):t=qt(e);break;case"wooden_blind":t=xt(e);break;case"aluminum_blind":t=Qe(e,!1);break;case"vertical_blind":t=Qe(e,!0);break;case"roller_blind":t=It(e);break;case"partition":t=Ke(e,!1);break;case"pleated_screen":t=Ke(e,!0);break;case"wallpaper":t=Tt(e);break;default:t=`<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">${T(o)}</text></svg>`;break}return`<div class="visual-placeholder is-clickable"
                 data-act="jump-to-item"
                 data-room-id="${r}"
                 data-item-index="${n}"
                 title="คลิกเพื่อไปยังรายการนี้">${t}</div>`}function Xe(e){let r=`
📃 *สรุปรายการสินค้า*
`,n=!1;return e.rooms.forEach(t=>{if(t.is_suspended||!t.items)return;const o=t.items.filter(a=>a.is_suspended?!1:a.type==="wallpaper"?(a.widths||[]).reduce((l,c)=>l+y(c),0)>0:a.type==="set"||D[a.type]?.templateId==="#areaBasedTpl"?y(a.width_m)>0:!0);if(o.length===0)return;n=!0,r+=`
*🚪 ห้อง: ${t.room_name||"ไม่ระบุ"}*
`;let s=0;o.forEach(a=>{s++;let l=Y[a.type]||"สินค้าตกแต่ง";a.type==="set"?a.style==="หลุยส์"?(l=Y.set_louis||"ม่านหลุยส์",r+=` ${s}) ${l} (${a.fabric_variant||""})
`):r+=` ${s}) ${l} ${a.style||""} (${a.fabric_variant||""})
`:r+=` ${s}) ${l}
`})}),n?r+`------------------------------
`:""}function at(e){return e.rooms.reduce((r,n)=>{if(n.is_suspended)return r;const t=n.items?.reduce((o,s)=>{if(s.is_suspended)return o;switch(s.type){case"set":return o+F.calculateSetPrice(s).total;case"wallpaper":return o+F.calculateWallpaperPrice(s).total;default:return D[s.type]?.templateId==="#areaBasedTpl"?o+F.calculateAreaBasedPrice(s).total:o}},0)||0;return r+t},0)}function Lt(e,r){const n=at(e);let t=0,o="";e.discount&&e.discount.value>0&&(e.discount.type==="percent"?(t=n*(e.discount.value/100),o=`🏷️ ส่วนลด (${e.discount.value}%): -${C(t)} บาท
`):(t=e.discount.value,o=`🏷️ ส่วนลด: -${C(t)} บาท
`));const s=n-t;let a=`🗓️ สรุปข้อมูล (${new Date().toLocaleDateString("th-TH",{day:"numeric",month:"short",year:"2-digit"})})
`;if(a+=`👤 ลูกค้า: ${e.customer_name||"-"}
`,(r==="customer"||r==="owner")&&(a+=`📞 โทร: ${e.customer_phone||"-"}
`,a+=`🏠 ที่อยู่: ${e.customer_address||"-"}
`),a+=`------------------------------
`,r==="customer")return a+=Xe(e),t>0&&(a+=`
ยอดรวม: ${C(n)} บาท
`,a+=o),a+=`
💰 *ยอดสุทธิ: ${C(s)} บาท*
`,a+=`
ขอบคุณที่ใช้บริการค่ะ
${H.name}
โทร: ${H.phone}`,a;if(r==="purchase_order"||r==="owner"){r==="owner"&&(a+=Xe(e));const l={opaqueFabrics:[],sheerFabrics:[],wallpapers:[],allSets:[]};e.rooms.forEach(g=>{g.is_suspended||!g.items||g.items.forEach(b=>{let k=!b.is_suspended;if(b.type==="set"||D[b.type]?.templateId==="#areaBasedTpl")k=k&&y(b.width_m)>0&&y(b.height_m)>0;else if(b.type==="wallpaper"){const x=(b.widths||[]).reduce((w,M)=>w+y(M),0);k=k&&x>0&&y(b.height_m)>0}if(k)switch(b.type){case"set":l.allSets.push(b),b.fabric_variant.includes("ทึบ")&&l.opaqueFabrics.push({code:b.fabric_code||"??",yards:F.fabricYardage(b.style,b.width_m)}),b.fabric_variant.includes("โปร่ง")&&l.sheerFabrics.push({code:b.sheer_fabric_code||"??",yards:F.fabricYardage(b.style,b.width_m)});break;case"wallpaper":const x=(b.widths||[]).reduce((M,$)=>M+y($),0),w=F.wallpaperRolls(x,b.height_m);w>0&&l.wallpapers.push({code:b.wallpaper_code||"xxx",rolls:w});break;default:if(D[b.type]?.templateId==="#areaBasedTpl"){const M=b.type;l[M]||(l[M]=[]),l[M].push({code:b.code||"xxx",width:y(b.width_m),height:y(b.height_m),opening_style:b.opening_style,adjustment_side:b.adjustment_side})}break}})});const c={};if([...l.opaqueFabrics,...l.sheerFabrics].forEach(g=>{g.yards>0&&(c[g.code]=(c[g.code]||0)+g.yards)}),Object.keys(c).length>0){a+=`✂️ *รายการสั่งซื้อ (ผ้า)*
`,a+=`------------------------------
`,l.opaqueFabrics.filter(g=>g.yards>0).forEach(g=>{a+=`- ผ้าทึบ (Curtain)
`,a+=`  รหัส: #${g.code||"??"}
`,a+=`  จำนวน: ${g.yards.toFixed(2)} หลา

`}),l.sheerFabrics.filter(g=>g.yards>0).forEach(g=>{a+=`- ผ้าโปร่ง (Sheer)
`,a+=`  รหัส: #${g.code||"??"}
`,a+=`  จำนวน: ${g.yards.toFixed(2)} หลา

`}),a+=`------------------------------
`,a+=`📊 *สรุปยอดรวมผ้า (ตามรหัส)*
`,a+=`------------------------------
`;for(const[g,b]of Object.entries(c))a+=`  - รหัส #${g}: ${b.toFixed(2)} หลา
`;a+=`
`}const u=l.allSets.filter(g=>g.style==="หลุยส์"),i=l.allSets.filter(g=>g.style==="ม่านพับ"),p=l.allSets.filter(g=>g.style==="ตาไก่"),d=l.allSets.filter(g=>!["ม่านพับ","ตาไก่","หลุยส์"].includes(g.style));if(u.length>0){a+=`------------------------------
`,a+=`👑 *รายการสั่งซื้อ ราง (หลุยส์)*
`,a+=`------------------------------

`;let g=1;u.forEach(w=>{a+=`(${g++}) ราง ${w.style}, สี: ${w.track_color||"ขาว"}
`,a+=`  - รางหลัก (ทึบ/โปร่ง): ${Number(w.width_m).toFixed(2)} ม.
`,a+=`  - หัวหลุยส์: ${w.louis_valance||"กล่องหลุยส์"}
`,a+=`  - พู่: ${w.louis_tassels||"สีเข้ากับผ้า"}
`,w.notes&&r==="owner"&&(a+=`  📝 หมายเหตุ: ${w.notes}
`),a+=`
`});const b=[];u.forEach(w=>{b.push(Number(w.width_m)),w.fabric_variant==="ทึบ&โปร่ง"&&b.push(Number(w.width_m))});const k=b.reduce((w,M)=>{const $=M.toFixed(2);return w[$]=(w[$]||0)+1,w},{}),x=Object.entries(k).sort((w,M)=>parseFloat(M[0])-parseFloat(w[0]));if(x.length>0){a+=`--- สรุปยอดรวมรางหลุยส์ ---
`,a+=`*จำนวนรางที่ต้องตัด (โดยประมาณ):*
`;for(const[w,M]of x)a+=`  - ขนาด ${w} ม. = ${M} เส้น
`;a+=`
`}}if(i.length>0){a+=`------------------------------
`,a+=`📏 *รายการสั่งซื้อ รางม่านพับ*
`,a+=`------------------------------

`;let g=1;i.forEach(x=>{a+=`(${g++}) รางม่านพับ
`,a+=`  - ขนาด: ${Number(x.width_m).toFixed(2)} ม.
`,a+=`  - สีราง: ${x.track_color||"ขาว"}
`,a+=`  - เชือกปรับ: ${x.adjustment_side||"ปรับขวา"}
`,x.notes&&r==="owner"&&(a+=`  📝 หมายเหตุ: ${x.notes}
`),a+=`
`});const b=i.reduce((x,w)=>{const M=Number(w.width_m).toFixed(2);return x[M]=(x[M]||0)+1,x},{}),k=Object.entries(b).sort((x,w)=>parseFloat(w[0])-parseFloat(x[0]));if(k.length>0){a+=`--- สรุปยอดรวมรางม่านพับ ---
`,a+=`*จำนวนรางที่ต้องตัด:*
`;for(const[x,w]of k)a+=`  - ขนาด ${x} ม. = ${w} เส้น
`;a+=`
`}}if(d.length>0){a+=`------------------------------
`,a+=`📏 *รายการสั่งซื้อ ราง (ลอน/จีบ)*
`,a+=`------------------------------

`;let g=1;d.forEach(w=>{a+=`(${g++}) ราง ${w.style}, สี: ${w.track_color||"ขาว"}
`,w.fabric_variant.includes("ทึบ")&&(a+=`  - รางทึบ: ${Number(w.width_m).toFixed(2)} ม.
`),w.fabric_variant.includes("โปร่ง")&&(a+=`  - รางโปร่ง: ${Number(w.width_m).toFixed(2)} ม.
`),w.notes&&r==="owner"&&(a+=`  📝 หมายเหตุ: ${w.notes}
`),a+=`
`});const b=[];d.forEach(w=>{w.fabric_variant.includes("ทึบ")&&b.push(Number(w.width_m)),w.fabric_variant.includes("โปร่ง")&&b.push(Number(w.width_m))});const k=b.reduce((w,M)=>{const $=M.toFixed(2);return w[$]=(w[$]||0)+1,w},{}),x=Object.entries(k).sort((w,M)=>parseFloat(M[0])-parseFloat(w[0]));if(x.length>0){a+=`--- สรุปยอดรวมรางลอน/จีบ ---
`,a+=`*จำนวนรางที่ต้องตัด:*
`;for(const[w,M]of x)a+=`  - ขนาด ${w} ม. = ${M} เส้น
`;a+=`
`}}if(p.length>0){a+=`------------------------------
`,a+=`📏 *รายการสั่งซื้อ ราง (ตาไก่)*
`,a+=`------------------------------

`;let g=1;p.forEach($=>{a+=`(${g++}) ราง ${$.style}, สี: ${$.track_color||"ขาว"}
`,$.fabric_variant.includes("ทึบ")&&(a+=`  - รางทึบ: ${Number($.width_m).toFixed(2)} ม.
`),$.fabric_variant.includes("โปร่ง")&&(a+=`  - รางโปร่ง: ${Number($.width_m).toFixed(2)} ม.
`),$.notes&&r==="owner"&&(a+=`  📝 หมายเหตุ: ${$.notes}
`),a+=`
`}),a+=`--- สรุปยอดรวมรางตาไก่ ---
`;const b=[];p.forEach($=>{$.fabric_variant.includes("ทึบ")&&b.push(Number($.width_m)),$.fabric_variant.includes("โปร่ง")&&b.push(Number($.width_m))});const k=6;b.sort(($,B)=>B-$);const x=[];for(const $ of b){let B=!1;for(let I=0;I<x.length;I++)if(x[I]>=$-.001){x[I]-=$,B=!0;break}B||x.push(k-$)}a+=`ใช้รางเต็ม (6 ม.) ทั้งหมด: *${x.length} เส้น*

`;const w=b.reduce(($,B)=>{const I=B.toFixed(2);return $[I]=($[I]||0)+1,$},{}),M=Object.entries(w).sort(($,B)=>parseFloat(B[0])-parseFloat($[0]));if(M.length>0){a+=`*สรุปจำนวนรางที่ต้องตัด:*
`;for(const[$,B]of M)a+=`  - ขนาด ${$} ม. = ${B} เส้น
`;a+=`
`}}const m={};let v={};l.allSets.forEach(g=>{const b=g.track_color||"ขาว",k=g.style,x=g.fabric_variant==="ทึบ&โปร่ง",w=y(g.width_m)>=1.6?3:2;if(m[b]||(m[b]={brackets:{},finials:0,grommets:{}}),m[b].brackets[k]||(m[b].brackets[k]={single:0,double:0}),k!=="ม่านพับ"&&k!=="หลุยส์"&&(x?m[b].brackets[k].double+=w:m[b].brackets[k].single+=w),k==="ตาไก่"){const M=x?4:2;m[b].finials+=M}if(k==="ตาไก่"){const M=g.grommet_color||"เงิน",$=F.calculateGrommets(g);m[b].grommets[M]||(m[b].grommets[M]=0),m[b].grommets[M]+=$}if(k==="หลุยส์"){const M=g.louis_tassels||"สีเข้ากับผ้า";M!=="ไม่มี"&&(v[M]=(v[M]||0)+2)}});const _=l.allSets.filter(g=>g.style!=="ม่านพับ"&&g.style!=="หลุยส์").length*2,h=Object.values(m).some(g=>Object.values(g.brackets).some(b=>b.single>0||b.double>0)||g.finials>0||Object.values(g.grommets).some(b=>b>0))||_>0,S=Object.keys(v).length>0;if(h||S){a+=`------------------------------
`,a+=`🔩 *รายการสั่งซื้อ อุปกรณ์ (Hardware)*
`,a+=`------------------------------

`;for(const[b,k]of Object.entries(m)){let x=!1,w=`**สี${b}**
`;const M=Object.keys(k.brackets);if(M.length>0){let B="";M.forEach(I=>{!["ม่านพับ","หลุยส์"].includes(I)&&(k.brackets[I].single>0||k.brackets[I].double>0)&&(B+=`    - ${I} (ชั้นเดียว): ${k.brackets[I].single} ตัว
`,B+=`    - ${I} (2ชั้น): ${k.brackets[I].double} ตัว
`)}),B&&(x=!0,w+=`  - ขาจับ:
${B}`)}k.finials>0&&(x=!0,w+=`  - หัวราง (ตาไก่): ${k.finials} ตัว
`);const $=Object.keys(k.grommets);if($.length>0){let B="";$.forEach(I=>{const j=k.grommets[I];j>0&&(B+=`    - สี${I}: ${j} ตัว
`)}),B&&(x=!0,w+=`  - ตาไก่:
${B}`)}x&&(a+=w+`
`)}let g="";if(_>0&&(g+=`  - ตะขอรวบม่าน (มาตรฐาน): ${_} ตัว
`),S){g+=`  - พู่/สายรวบ (หลุยส์):
`;for(const[b,k]of Object.entries(v))g+=`    - ${b}: ${k} ชุด
`}g&&(a+=`**อุปกรณ์รวม**
`+g+`
`)}const L=Object.keys(l).filter(g=>!["opaqueFabrics","sheerFabrics","wallpapers","allSets"].includes(g));L.length>0&&L.sort().forEach(g=>{const b=l[g],k=Y[g]||g;a+=`------------------------------
`,a+=`📦 *รายการสั่งซื้อ ${k}*
`,a+=`------------------------------

`,b.forEach(x=>{a+=`- รหัส: #${x.code||"xxx"}
  ขนาด: ${x.width.toFixed(2)} x ${x.height.toFixed(2)} ม.
`,x.opening_style&&(a+=`  รูปแบบเปิด: ${x.opening_style}
`),x.adjustment_side&&(a+=`  เชือกปรับ: ${x.adjustment_side}
`),a+=`
`})});const E={};if(l.wallpapers.forEach(g=>{E[g.code]=(E[g.code]||0)+g.rolls}),Object.keys(E).length>0){a+=`------------------------------
`,a+=`🎨 *รายการสั่งซื้อ (Wallpaper)*
`,a+=`------------------------------

`;for(const[g,b]of Object.entries(E))a+=`  - รหัส #${g}: ${b} ม้วน
`;a+=`
`}if(r==="purchase_order")return a+=`------------------------------
`,a}if(r==="seamstress"||r==="owner"){a+=`
🧵 *รายละเอียดสำหรับช่างเย็บผ้า*
`;let l=0;if(e.rooms.forEach(c=>{if(c.is_suspended||!c.items)return;const u=c.items.filter(i=>i.type==="set"&&!i.is_suspended&&y(i.width_m)>0&&y(i.height_m)>0);u.length!==0&&(l>0&&(a+=`==============================
`),a+=`
*🚪 ห้อง: ${c.room_name||"ไม่ระบุ"}*

`,u.forEach((i,p)=>{p>0&&(a+=`--------------------
`);const d=i.style==="หลุยส์"?Y.set_louis||"ม่านหลุยส์":i.style;a+=`*ชุดที่ ${p+1}/${u.length}: ${d} ${i.fabric_variant}*
`,i.style==="ม่านพับ"?a+=`  - เชือกปรับ: ${i.adjustment_side||"ปรับขวา"}
`:i.style==="หลุยส์"?(a+=`  - หัวหลุยส์: ${i.louis_valance||"กล่องหลุยส์"}
`,a+=`  - พู่: ${i.louis_tassels||"สีเข้ากับผ้า"}
`):a+=`  - รูปแบบเปิด: ${i.opening_style||"แยกกลาง"}
`,i.style==="หลุยส์"?(i.fabric_variant.includes("ทึบ")&&(a+=`  - ผ้าฐาน (ทึบ): #${i.fabric_code||"-"}
`),i.fabric_variant.includes("โปร่ง")&&(a+=`  - ผ้าฐาน (โปร่ง): #${i.sheer_fabric_code||"-"}
`)):(i.fabric_variant.includes("ทึบ")&&(a+=`  - ผ้าทึบ: #${i.fabric_code||"-"}
`),i.fabric_variant.includes("โปร่ง")&&(a+=`  - ผ้าโปร่ง: #${i.sheer_fabric_code||"-"}
`)),a+=`  - ขนาด: กว้าง ${Number(i.width_m).toFixed(2)} x สูง ${Number(i.height_m).toFixed(2)} ม.
`,i.notes&&r==="owner"&&(a+=`  📝 หมายเหตุ: ${i.notes}
`)}),a+=`
`,l++)}),l>0?a+=`==============================
`:a+=`ไม่มีรายการสำหรับช่าง
------------------------------
`,r==="seamstress")return a}return r==="owner"&&(a+=`
💰 *สรุปยอดรวม: ${C(s)} บาท*
`,t>0&&(a+=`   (ยอดก่อนลด: ${C(n)} บาท ${o.trim()})
`)),a}function Ct(e){if(!e.rooms||e.rooms.length===0)return'<p class="empty-summary">ไม่มีข้อมูลสำหรับแสดงผล</p>';let r="";const n={};let t=0;if(e.rooms.forEach(a=>{a.is_suspended||!a.items||a.items.forEach(l=>{if(l.is_suspended)return;let c=null,u=0;switch(l.type){case"set":u=F.calculateSetPrice(l).total,u>0&&(c=l.style==="หลุยส์"?"set_louis":"set");break;case"wallpaper":u=F.calculateWallpaperPrice(l).total,u>0&&(c=l.type);break;default:D[l.type]?.templateId==="#areaBasedTpl"&&(u=F.calculateAreaBasedPrice(l).total,u>0&&(c=l.type));break}c&&(n[c]=(n[c]||0)+1,t++)})}),t>0){const a=Object.entries(n).map(([l,c])=>{const u=Y[l]||Y[l.split("_")[0]]||"ของตกแต่ง";return`
                <span class="summary-tag" data-filter-type="${T(l)}" title="คลิกเพื่อกรองเฉพาะรายการนี้">
                    ${T(u)} <strong>${c}</strong>
                </span>`}).join("");a&&(r+=`
                <div class="overview-summary-group">
                    <h4><i class="ph ph-stack"></i> สรุปประเภทรายการ</h4>
                    <div class="summary-tags-container">
                        ${a}
                    </div>
                </div>`)}let o="",s=0;return e.rooms.forEach(a=>{if(a.is_suspended||!a.items)return;const l={};let c=0;if(a.items.forEach(u=>{if(u.is_suspended)return;let i=null,p=0;switch(u.type){case"set":p=F.calculateSetPrice(u).total,p>0&&(i=u.style==="หลุยส์"?"set_louis":"set");break;case"wallpaper":p=F.calculateWallpaperPrice(u).total,p>0&&(i=u.type);break;default:D[u.type]?.templateId==="#areaBasedTpl"&&(p=F.calculateAreaBasedPrice(u).total,p>0&&(i=u.type));break}i&&(l[i]=(l[i]||0)+1,c++)}),c>0){s+=c;const u=Object.entries(l).map(([i,p])=>{const d=Y[i]||Y[i.split("_")[0]]||"ของตกแต่ง";return`
                    <div class="overview-item">
                        <span>${T(d)}</span>
                        <span>${p}</span>
                    </div>`}).join("");o+=`
                <details class="overview-room-card">
                    <summary class="overview-room-summary">
                        <span class="room-name">${T(a.room_name)||"ไม่ระบุชื่อห้อง"}</span>
                        <div class="summary-tags">
                            <span class="room-item-count">${c} รายการ</span>
                            <i class="ph ph-caret-down expand-icon"></i>
                        </div>
                    </summary>
                    <div class="overview-room-items">${u}</div>
                </details>`}}),o&&(r+=`
            <div class="overview-breakdown-group">
                <h4><i class="ph ph-map-pin-line"></i> แจกแจงตามห้อง</h4>
                ${o}
            </div>`),t===0&&s===0?'<p class="empty-summary">ไม่มีรายการที่มีราคาสำหรับแสดงผล</p>':r}function Bt(e,r){const{vatRate:n=H.baseVatRate,pageBreakBuffer:t=3,showDetails:o=!0}=r,s=[];e.rooms.forEach($=>{if($.is_suspended||!$.items)return;const B=[];$.items.forEach(I=>{if(I.is_suspended)return;let j="",W=0,N=0,A=0,P=1,z=I.type==="set"&&I.style==="หลุยส์"?Y.set_louis||"ม่านหลุยส์":Y[I.type]||"สินค้าตกแต่ง",Q="";switch(I.type){case"set":if(W=F.calculateSetPrice(I).total,W>0){N=y(I.width_m),A=y(I.height_m);const K=I.style==="หลุยส์"?"":` ${T(I.style||"")}`;j=`${z}${K} (${T(I.fabric_variant||"")})`,o&&(Q=`<br><small>ขนาด ${N.toFixed(2)} x ${A.toFixed(2)} ม.${I.notes?` - ${T(I.notes)}`:""}</small>`),P=o?1.5:1}break;case"wallpaper":if(W=F.calculateWallpaperPrice(I).total,W>0){const K=(I.widths||[]).reduce((fe,dt)=>fe+y(dt),0),pe=F.wallpaperRolls(K,I.height_m);A=y(I.height_m),j=`${z}`,o&&(Q=`<br><small>รหัส: ${T(I.wallpaper_code)||"-"}, สูง ${A.toFixed(2)} ม. (ใช้ ${pe} ม้วน)</small>`),P=o?1.5:1}break;default:D[I.type]?.templateId==="#areaBasedTpl"&&(W=F.calculateAreaBasedPrice(I).total,W>0&&(N=y(I.width_m),A=y(I.height_m),j=`${z}`,o&&(Q=`<br><small>รหัส: ${T(I.code)||"-"}, ขนาด ${N.toFixed(2)} x ${A.toFixed(2)} ม.</small>`),P=o?1.5:1));break}W>0&&j&&B.push({description:j+Q,total:W,units:P})}),B.length>0&&(s.push({isRoomHeader:!0,roomName:T($.room_name)||"ไม่ระบุชื่อห้อง",units:1.2}),s.push(...B))});const a=s.reduce(($,B)=>$+(B.total||0),0);if(a===0)return null;let l=0,c="",u=a;e.discount&&e.discount.value>0&&(e.discount.type==="percent"?(l=a*(e.discount.value/100),c=`<tr><td class="pdf-label">ส่วนลด (${e.discount.value}%)</td><td class="pdf-amount">-${Z(l,2,!0)}</td></tr>`):(l=e.discount.value,c=`<tr><td class="pdf-label">ส่วนลด</td><td class="pdf-amount">-${Z(l,2,!0)}</td></tr>`),u=a-l);const i=u*n,p=u+i,d=o?17:20,m=o?23:28,v=[];let _=[],h=0;s.forEach(($,B)=>{const I=v.length===0?d:m,j=h+$.units>I;let W=!1;if($.isRoomHeader&&B<s.length-1){const A=s[B+1].units||(o?1.5:1);h+$.units+A>I&&h+$.units<=I&&(W=!0)}let N=!1;if(!j&&!W&&B<s.length-1){const A=I-(h+$.units),P=s[B+1].units||(o?1.5:1);A>0&&A<t&&A<P&&!$.isRoomHeader&&(N=!0)}(j||W||N)&&_.length>0&&(v.push(_),_=[],h=0),_.push($),h+=$.units}),_.length>0&&v.push(_);const S=new Date,L=S.toLocaleDateString("th-TH",{year:"numeric",month:"long",day:"numeric"}),E=`QT-${S.getFullYear()}${(S.getMonth()+1).toString().padStart(2,"0")}${S.getDate().toString().padStart(2,"0")}`;let g="";try{g=new URL(H.logoUrl,document.baseURI).href}catch($){console.warn("Could not create absolute logo URL:",$),g=H.logoUrl}let b="",k=0,x=1;v.forEach(($,B)=>{const I=B===0,j=B===v.length-1,W=`
            <div class="pdf-page-header">
                <div class="pdf-header">
                    <div class="pdf-shop-info">
                        ${g?`<img src="${g}" alt="Logo" class="pdf-logo">`:""}
                        <div class="pdf-shop-address">
                            <strong><i class="ph ph-github-logo"></i> ${T(H.name)}</strong><br>
                            ${T(H.address).replace(/\n/g,"<br>")}<br>
                            โทร: ${T(H.phone)} | เลขประจำตัวผู้เสียภาษี: ${T(H.taxId)}
                        </div>
                    </div>
                    <div class="pdf-quote-details">
                        <div class="pdf-title-box"><h1>ใบเสนอราคา ${v.length>1?I?"":"(ต่อ)":""}</h1></div>
                        <table class="pdf-quote-meta">
                            <tr><td>เลขที่:</td><td>${E}</td></tr>
                            <tr><td>วันที่:</td><td>${L}</td></tr>
                        </table>
                    </div>
                </div>
                ${I?`
                <section class="pdf-customer-details">
                    <div class="pdf-customer-info">
                        <strong>ลูกค้า:</strong> ${T(e.customer_name)||"-"}<br>
                        <strong>ที่อยู่:</strong> ${T(e.customer_address||"-").replace(/\n/g,"<br>")}<br>
                        <strong>โทร:</strong> ${T(e.customer_phone)||"-"}
                    </div>
                    <div class="pdf-customer-meta">
                        <strong>เงื่อนไขชำระเงิน:</strong> ${T(H.pdf.paymentTerms)}<br>
                        <strong>ยืนราคา:</strong> ${T(H.pdf.priceValidity)}
                    </div>
                </section>`:""}
            </div>`,N=`
            <div class="pdf-page-footer">
                <div class="pdf-footer-info">
                    <span><i class="ph ph-github-logo"></i> ${T(H.name)} | โทร: ${T(H.phone)}</span>
                    <span>หน้า ${B+1} / ${v.length}</span>
                </div>
            </div>`;let A="";I||(A+=`<tr class="pdf-subtotal-row"><td colspan="4">ยอดยกมา (Brought Forward)</td><td class="pdf-text-right">${Z(k,2,!0)}</td></tr>`),$.forEach(K=>{K.isRoomHeader?A+=`<tr class="pdf-room-header"><td colspan="5">ห้อง: ${K.roomName}</td></tr>`:(A+=`<tr><td class="pdf-text-center">${x++}</td><td>${K.description}</td><td class="pdf-text-center">1</td><td class="pdf-text-right">${Z(K.total,2,!0)}</td><td class="pdf-text-right">${Z(K.total,2,!0)}</td></tr>`,k+=K.total)});let P="";j||(P=`<tfoot><tr class="pdf-subtotal-row"><td colspan="4">ยอดยกไป (Carried Forward)</td><td class="pdf-text-right">${Z(k,2,!0)}</td></tr></tfoot>`);let z="";o&&H.pdf.notes&&H.pdf.notes.length>0&&(z=`
                <strong>หมายเหตุ:</strong>
                <ul>${H.pdf.notes.map(K=>`<li>${T(K)}</li>`).join("")}</ul>
            `);const Q=j?`
            <div class="pdf-summary-wrapper">
                <section class="pdf-summary-section">
                    <div class="pdf-amount-in-words">
                        ${z}
                        <div class="pdf-amount-text">( ${_t(p)} )</div>
                    </div>
                    <div class="pdf-totals-block">
                        <table>
                            <tr><td class="pdf-label">รวมเป็นเงิน</td><td class="pdf-amount">${Z(a,2,!0)}</td></tr>
                            ${c}
                            ${n>0?`<tr><td class="pdf-label">ภาษีมูลค่าเพิ่ม ${(n*100).toFixed(0)}%</td><td class="pdf-amount">${Z(i,2,!0)}</td></tr>`:""}
                            <tr class="pdf-grand-total"><td class="pdf-label">ยอดรวมสุทธิ</td><td class="pdf-amount">${Z(p,2,!0)}</td></tr>
                        </table>
                    </div>
                </section>
                <footer class="pdf-footer-section">
                    <div class="pdf-signature-box"><p>.................................................</p><p>ผู้เสนอราคา</p><p>(<i class="ph ph-github-logo"></i> ${T(H.name)})</p><p>วันที่: ${L}</p></div>
                    <div class="pdf-signature-box"><p>.................................................</p><p>ลูกค้า / ผู้มีอำนาจลงนาม</p><p>&nbsp;</p><p>วันที่: ......./......./............</p></div>
                </footer>
            </div>
        `:"";b+=`
            <div class="pdf-page">
                <div class="pdf-page-content">
                    ${W}
                    <div class="pdf-page-body">
                        <table class="pdf-items-table">
                            <thead><tr><th style="width:5%;">ลำดับ</th><th style="width:50%;">รายการ</th><th style="width:10%;">จำนวน</th><th style="width:17.5%;">ราคา/หน่วย</th><th style="width:17.5%;">รวม (บาท)</th></tr></thead>
                            <tbody>${A}</tbody>
                            ${P}
                        </table>
                        ${Q}
                    </div>
                    ${N}
                </div>
            </div>`});const w=e.customer_name||"quote",M=tt(w);return{html:`<div id="quotation-template">${b}</div>`,fileName:`${E}_${M}`}}function At(e){const r=at(e);let n=0;e.discount?.value>0&&(n=e.discount.type==="percent"?r*(e.discount.value/100):e.discount.value);const t=r-n;let o=!1,s=e.rooms.map(l=>{if(l.is_suspended)return"";const c=l.items.filter(i=>i.is_suspended?!1:i.type==="set"||D[i.type]?.templateId==="#areaBasedTpl"?y(i.width_m)>0&&y(i.height_m)>0:i.type==="wallpaper"?(i.widths||[]).reduce((d,m)=>d+y(m),0)>0&&y(i.height_m)>0:!1);if(c.length===0)return"";const u=c.map((i,p)=>{let d="",m="",v="",_="";switch(i.type==="set"?i.style==="หลุยส์"?(_=Y.set_louis||"ม่านหลุยส์",m=`<h5 class="lookbook-item-title">${T(_)}</h5>`):_=Y.set||"ผ้าม่าน":(_=Y[i.type]||"ของตกแต่ง",m=`<h5 class="lookbook-item-title">${T(_)}</h5>`),i.type){case"set":v=`<tr><td>ขนาด</td><td>${y(i.width_m).toFixed(2)} x ${y(i.height_m).toFixed(2)} ม.</td></tr>`,i.style==="หลุยส์"?d=`
                            <tr><td>แบบ</td><td>${_} (${T(i.fabric_variant||"")})</td></tr>
                            ${i.fabric_variant.includes("ทึบ")?`<tr><td>ผ้าฐาน</td><td>#${T(i.fabric_code)||"-"}</td></tr>`:""}
                            ${i.fabric_variant.includes("โปร่ง")?`<tr><td>ผ้าโปร่ง</td><td>#${T(i.sheer_fabric_code)||"-"}</td></tr>`:""}
                            <tr><td>หัวหลุยส์</td><td>${T(i.louis_valance||"กล่องหลุยส์")}</td></tr>
                            <tr><td>พู่</td><td>${T(i.louis_tassels||"สีเข้ากับผ้า")}</td></tr>
                         `:(d=`
                            <tr><td>แบบ</td><td>${T(i.style||"")} (${T(i.fabric_variant||"")})</td></tr>
                            ${i.fabric_variant.includes("ทึบ")?`<tr><td>ทึบ</td><td>#${T(i.fabric_code)||"-"}</td></tr>`:""}
                            ${i.fabric_variant.includes("โปร่ง")?`<tr><td>โปร่ง</td><td>#${T(i.sheer_fabric_code)||"-"}</td></tr>`:""}
                        `,i.style==="ม่านพับ"?d+=`<tr><td>เชือก</td><td>${T(i.adjustment_side||"ปรับขวา")}</td></tr>`:d+=`<tr><td>เปิด</td><td>${T(i.opening_style||"แยกกลาง")}</td></tr>`);break;case"wallpaper":const h=(i.widths||[]).reduce((L,E)=>L+y(E),0),S=F.wallpaperRolls(h,i.height_m);v=`<tr><td>ขนาด</td><td>รวม ${h.toFixed(2)} ม., สูง ${y(i.height_m).toFixed(2)} ม.</td></tr>`,d=`
                        <tr><td>รหัส</td><td>#${T(i.wallpaper_code)||"-"}</td></tr>
                        <tr><td>ใช้</td><td>${S} ม้วน</td></tr>
                    `;break;default:D[i.type]?.templateId==="#areaBasedTpl"&&(v=`<tr><td>ขนาด</td><td>${y(i.width_m).toFixed(2)} x ${y(i.height_m).toFixed(2)} ม.</td></tr>`,d=`<tr><td>รหัส</td><td>#${T(i.code)||"-"}</td></tr>`,i.opening_style&&(d+=`<tr><td>เปิด</td><td>${T(i.opening_style)}</td></tr>`),i.adjustment_side&&(d+=`<tr><td>เชือก</td><td>${T(i.adjustment_side)}</td></tr>`));break}return d&&(o=!0),`
                 <div class="lookbook-details">
                    ${Mt(i,l.id,p)}
                    <div class="spec-table-wrapper">
                        ${m}
                        <table class="spec-table">
                            ${d}
                            ${v}
                            ${i.notes?`<tr><td>โน้ต</td><td>${T(i.notes)}</td></tr>`:""}
                        </table>
                    </div>
                </div>
            `}).join('<hr class="lookbook-hr">');return u.trim()?`
            <div class="lookbook-room">
                <h4><i class="ph ph-map-pin"></i> ${T(l.room_name)||"ไม่ระบุชื่อห้อง"}</h4>
                ${u}
            </div>
        `:""}).join("");return o?`
        <div class="lookbook-summary">
            <div class="lookbook-customer-info">
                <strong>ลูกค้า:</strong> ${T(e.customer_name)||"-"}<br/>
                <strong>ที่อยู่:</strong> ${T(e.customer_address||"-").replace(/\n/g,"<br/>")}
            </div>
            <div class="lookbook-totals">
                <span>ยอดรวม (ก่อนส่วนลด): ${C(r)} บาท</span>
                ${n>0?`<span>ส่วนลด: -${C(n)} บาท</span>`:""}
                <span class="grand-total">ยอดสุทธิ: ${C(t)} บาท</span>
            </div>
        </div>
    `+s:'<p class="empty-summary">ไม่มีรายการสำหรับสร้างรายงาน</p>'}function nt(e={}){const r=document.querySelector(f.roomTpl);if(!r)return console.error("Room template not found"),null;const t=r.content.cloneNode(!0).firstElementChild;t.id=e.id||`room-${Date.now()}`,t.open=e.is_open!==!1,t.dataset.roomDefaults=JSON.stringify(e.room_defaults||{});const o=t.querySelector(f.roomNameInput),s=t.querySelector("[data-room-name-display]"),a=t.querySelector("[data-room-brief]"),l=t.querySelector(f.allItemsContainer),c=()=>{const p=o.value||"ห้อง (ไม่มีชื่อ)";s&&(s.textContent=p)};o&&o.addEventListener("input",c);const u=t.querySelector("summary");u&&u.addEventListener("click",()=>{});const i=e.room_name||`ห้อง ${document.querySelectorAll(f.room).length+1}`;if(o){o.value=i;const p=`room_name_${t.id}`;o.id=p;const d=o.closest(".form-group")?.querySelector("label");d&&d.setAttribute("for",p)}return s&&(s.textContent=i),e.is_suspended&&t.classList.add("is-suspended"),t.getItemsContainer=()=>l,t.updateBrief=p=>{a&&(a.innerHTML=p)},t}function Be(e={}){const r=document.querySelector(f.setTpl);if(!r)return console.error("Set template not found"),null;const t=r.content.cloneNode(!0).firstElementChild;t.dataset.type="set";const o=t.querySelector('input[name="width_m"]'),s=t.querySelector('input[name="height_m"]'),a=t.querySelector('select[name="set_style"]'),l=t.querySelector('select[name="fabric_variant"]'),c=t.querySelector('select[name="set_price_per_m"]'),u=t.querySelector('select[name="sheer_price_per_m"]'),i=t.querySelector('select[name="louis_price_per_m"]'),p=t.querySelector('input[name="fabric_code"]'),d=t.querySelector('input[name="sheer_fabric_code"]'),m=t.querySelector('select[name="opening_style"]'),v=t.querySelector('select[name="adjustment_side"]'),_=t.querySelector('input[name="notes"]'),h=t.querySelector('[data-set-control="opening_style_wrap"]'),S=t.querySelector('[data-set-control="adjustment_side_wrap"]'),L=t.querySelector('[data-set-control="louis_price_wrap"]'),E=t.querySelector('[data-set-control="fabric_price_wrap"]'),g=t.querySelector('[data-set-control="fabric_code_wrap"]'),b=t.querySelector("[data-sheer-wrap]"),k=t.querySelector("[data-sheer-code-wrap]"),x=t.querySelector("[data-set-summary]"),w=t.querySelector(".item-details-more"),M=t.querySelector('[data-act="toggle-more-details"]')?.parentElement,$=()=>({width_m:o.value,height_m:s.value,style:a.value,fabric_variant:l.value,price_per_m_raw:c.value,sheer_price_per_m:u.value,louis_price_per_m:i.value,is_suspended:t.classList.contains("is-suspended")}),B=()=>{const N=$(),A=F.calculateSetPrice(N);t.dataset.totalPrice=A.total;let P=`ราคา: <b>${C(A.total)}</b> บ.`;if(N.style==="หลุยส์"){const Q=[];A.opaque>0&&Q.push(`ทึบ: ${C(A.opaque)}`),A.sheer>0&&Q.push(`โปร่ง: ${C(A.sheer)}`),A.louis>0&&Q.push(`หลุยส์: ${C(A.louis)}`),Q.length>0&&(P+=` <small>(${Q.join(", ")})</small>`)}else A.opaque>0&&A.sheer>0&&(P+=` <small>(ทึบ: ${C(A.opaque)}, โปร่ง: ${C(A.sheer)})</small>`);const z=F.fabricYardage(N.style,N.width_m);z>0&&(P+=` &bull; ใช้ผ้า: ${z.toFixed(2)} หลา`),x?x.innerHTML=P:console.warn("Summary element not found for set item.")},I=we(()=>{B(),t.dispatchEvent(new CustomEvent("item-update",{bubbles:!0}))},200),j=()=>{const N=a.value,A=l.value,P=N==="หลุยส์",z=A.includes("โปร่ง"),Q=A==="โปร่ง"&&!P,K=A==="ทึบ"&&!P;b?.classList.toggle("hidden",!z||P),k?.classList.toggle("hidden",!z||P);const pe=Q||P;c&&(c.disabled=pe,pe&&(c.value="")),p&&(p.disabled=pe,pe&&(p.value=""));const fe=K||P;u&&(u.disabled=fe,fe&&(u.value="")),d&&(d.disabled=fe,fe&&(d.value=""))},W=()=>{const N=a.value,A=N==="ม่านพับ",P=N==="หลุยส์";h&&h.classList.toggle("hidden",A||P),S&&S.classList.toggle("hidden",!A),L&&L.classList.toggle("hidden",!P),E&&E.classList.toggle("hidden",P),g&&g.classList.toggle("hidden",P),j()};if(t.addEventListener("input",N=>{N.target===l&&j(),N.target===a&&W(),I()}),w&&M){const N=t.querySelector(".item-grid");N&&N.appendChild(M)}return o.value=ue(e.width_m),s.value=ue(e.height_m),a.value=e.style||"ลอน",l.value=e.fabric_variant||"ทึบ",c.value=e.price_per_m_raw||"",u.value=e.sheer_price_per_m||"",i.value=e.louis_price_per_m||"",p.value=e.fabric_code||"",d.value=e.sheer_fabric_code||"",m.value=e.opening_style||"แยกกลาง",v.value=e.adjustment_side||"ปรับขวา",_.value=e.notes||"",t.querySelector('input[name="track_color"]').value=e.track_color||"ขาว",t.querySelector('input[name="bracket_color"]').value=e.bracket_color||"ขาว",t.querySelector('input[name="finial_color"]').value=e.finial_color||"ขาว",t.querySelector('input[name="grommet_color"]').value=e.grommet_color||"เงิน",t.querySelector('input[name="louis_valance"]').value=e.louis_valance||"กล่องหลุยส์",t.querySelector('input[name="louis_tassels"]').value=e.louis_tassels||"สีเข้ากับผ้า",e.is_suspended&&t.classList.add("is-suspended"),W(),B(),t}function We(e={}){const r=document.querySelector(f.wallTpl);if(!r)return null;const t=r.content.cloneNode(!0).firstElementChild,o=t.querySelector('input[name="wall_width_m"]');o.value=ue(e.width);const s=`wall_width_${Date.now()}_${Math.random().toString(36).substring(2,7)}`;o.id=s;const a=t.querySelector("label");return a&&a.setAttribute("for",s),t}function Ae(e={}){const r=document.querySelector(f.wallpaperTpl);if(!r)return console.error("Wallpaper template not found"),null;const t=r.content.cloneNode(!0).firstElementChild;t.dataset.type="wallpaper";const o=t.querySelector('[name="wallpaper_height_m"]'),s=t.querySelector('[name="wallpaper_price_roll"]'),a=t.querySelector('[name="wallpaper_install_cost"]'),l=t.querySelector('[name="wallpaper_code"]'),c=t.querySelector('[name="wallpaper_notes"]'),u=t.querySelector("[data-walls-container]"),i=t.querySelector("[data-wallpaper-summary]"),p=t.querySelector(".item-details-more"),d=t.querySelector('[data-act="toggle-more-details"]')?.parentElement,m=()=>({height_m:o.value,price_per_roll:s.value,install_cost_per_roll:a.value,widths:Array.from(u.querySelectorAll('input[name="wall_width_m"]')).map(h=>h.value),is_suspended:t.classList.contains("is-suspended")}),v=()=>{const h=m(),S=F.calculateWallpaperPrice(h);t.dataset.totalPrice=S.total;let L=`รวม: <b>${C(S.total)}</b> บ. `;(S.material>0||S.install>0)&&(L+=`<small>(วอลล์: ${C(S.material)}, ค่าช่าง: ${C(S.install)})</small>`),S.rolls>0&&(L+=` &bull; พื้นที่: ${Z(S.sqm,2)} ตร.ม. &bull; ใช้: ${S.rolls} ม้วน`),i&&(i.innerHTML=L)},_=we(()=>{v(),t.dispatchEvent(new CustomEvent("item-update",{bubbles:!0}))},200);if(t.addEventListener("input",_),p&&d){const h=t.querySelector(".item-grid");h&&h.appendChild(d)}if(e.widths&&e.widths.length>0)e.widths.forEach(h=>{const S=We({width:h});S&&u.appendChild(S)});else{const h=We();h&&u.appendChild(h)}return o.value=ue(e.height_m),s.value=e.price_per_roll>0?C(e.price_per_roll):"",e.hasOwnProperty("install_cost_per_roll")?a.value=e.install_cost_per_roll===0?"0":e.install_cost_per_roll>0?C(e.install_cost_per_roll):"":a.value=a.value,l.value=e.wallpaper_code||"",c.value=e.notes||"",e.is_suspended&&t.classList.add("is-suspended"),v(),t}function Ee(e,r={}){const n=document.querySelector(f.areaBasedTpl);if(!n)return console.error("AreaBased template not found"),null;const o=n.content.cloneNode(!0).firstElementChild;o.dataset.type=e;const s=D[e]||{name:"ของตกแต่ง"};o.classList.add(`${e.replace(/_/g,"-")}-item`);const a=o.querySelector(".item-type-display"),l=o.querySelector('[name="area_width_m"]'),c=o.querySelector('[name="area_height_m"]'),u=o.querySelector('[name="area_price_sqyd"]'),i=o.querySelector('[name="area_code"]'),p=o.querySelector('[name="area_notes"]'),d=o.querySelector(".btn-favorite"),m=o.querySelector(".btn-show-favs"),v=o.querySelector("[data-area-summary]"),_=o.querySelector(".item-details-more"),h=o.querySelector('[data-act="toggle-more-details"]')?.parentElement,S=_?.querySelector(".item-grid"),L=S?.querySelector('[name="area_price_sqyd"]')?.closest(".form-group");let E,g;if(S&&L){if(e==="partition"||e==="pleated_screen"){const w=document.createElement("div");w.className="form-group",w.innerHTML=`
                <label>รูปแบบเปิด
                    <select name="opening_style">
                        <option value="แยกกลาง">แยกกลาง</option>
                        <option value="เก็บข้างเดียว">เก็บข้างเดียว</option>
                    </select>
                </label>
            `,S.insertBefore(w,L),E=w.querySelector("select")}else if(["wooden_blind","roller_blind","vertical_blind","aluminum_blind"].includes(e)){const w=document.createElement("div");w.className="form-group",w.innerHTML=`
                <label>เชือกปรับ
                    <select name="adjustment_side">
                        <option value="ปรับขวา">ปรับขวา</option>
                        <option value="ปรับซ้าย">ปรับซ้าย</option>
                    </select>
                </label>
            `,S.insertBefore(w,L),g=w.querySelector("select")}(E||g)&&L&&L.classList.remove("full-width-item")}const b=()=>({width_m:l.value,height_m:c.value,price_sqyd:u.value,is_suspended:o.classList.contains("is-suspended")}),k=()=>{const w=b(),M=F.calculateAreaBasedPrice(w);o.dataset.totalPrice=M.total;const $=M.sqyd>0?` &bull; พื้นที่: ${Z(M.sqyd,2)} ตร.หลา`:"";v&&(v.innerHTML=`ราคา: <b>${C(M.total)}</b> บ.${$}`)},x=we(()=>{k(),o.dispatchEvent(new CustomEvent("item-update",{bubbles:!0}))},200);if(o.addEventListener("input",x),_&&h){const w=o.querySelector(".item-grid");w&&w.appendChild(h)}return a&&(a.textContent=s.name),i&&(i.dataset.favoriteType=e),d&&(d.dataset.type=e),m&&(m.dataset.type=e),l.value=ue(r.width_m),c.value=ue(r.height_m),u.value=r.price_sqyd>0?C(r.price_sqyd):"",i.value=r.code||"",p.value=r.notes||"",E&&(E.value=r.opening_style||"แยกกลาง"),g&&(g.value=r.adjustment_side||"ปรับขวา"),r.is_suspended&&o.classList.add("is-suspended"),k(),o}const O=[];let ee=!1,ke=null,R=null,ye=null,G=null,Ne=!1,Se=null,de=null,le=[];const ze=document.querySelector("#undoBtn"),Ge="marnthara.theme",xe={};function Et(e){if(xe[e])return xe[e];const r=new Promise((n,t)=>{const o=document.createElement("script");o.src=e,o.onload=()=>n(),o.onerror=()=>{console.error(`Script load error for ${e}`),delete xe[e],t(new Error(`Script load error for ${e}`))},document.head.appendChild(o)});return xe[e]=r,r}function st(){const e=localStorage.getItem(Ge),r=document.querySelector("#themeToggleBtn");if(!r)return;const n=r.querySelector("i"),t=r.querySelector("span");switch(document.body.classList.remove("dark-theme","neutral-theme"),e){case"dark":document.body.classList.add("dark-theme"),n&&(n.className="ph-fill ph-sun"),t&&(t.textContent=" สว่าง");break;case"neutral":document.body.classList.add("neutral-theme"),n&&(n.className="ph-fill ph-moon"),t&&(t.textContent=" มืด");break;default:n&&(n.className="ph-fill ph-palette"),t&&(t.textContent=" กลาง");break}}function Pt(){const e=localStorage.getItem(Ge);let r="neutral";!e||e==="light"?r="neutral":e==="neutral"?r="dark":r="light",localStorage.setItem(Ge,r),st()}function te(){ze&&(ze.disabled=!wt())}function Ft(){const e=St();e&&(Je(e,!1),q("ยกเลิกการกระทำล่าสุดแล้ว","success")),te()}function _e(){const e=document.getElementById("suspendedItemsBtn");if(!e)return;if(ye){e.classList.remove("is-visible");return}const r=document.getElementById("suspendedCountBadge"),n=document.querySelectorAll(".item-card.is-suspended").length,t=document.querySelectorAll(".room-card.is-suspended");let o=0;t.forEach(a=>{o+=a.querySelectorAll(".item-card:not(.is-suspended)").length});const s=n+o;r&&(r.textContent=s),e.classList.toggle("is-visible",s>0)}function De(){ye="suspended";const e=document.getElementById("filterStatusBar");let r=0;if(document.querySelectorAll(".room-card").forEach(n=>{let t=!1;const o=n.classList.contains("is-suspended");n.querySelectorAll(".item-card").forEach(a=>{const c=a.classList.contains("is-suspended")||o;a.classList.toggle("item-hidden",!c),c&&(t=!0,r++)});const s=o||t;n.classList.toggle("item-hidden",!s)}),r===0){lt(),q("ไม่มีรายการที่ถูกระงับแล้ว","success");return}e&&(e.innerHTML=`
            <span><i class="ph ph-warning"></i> รายการที่ถูกระงับ (${r} รายการ)</span>
            <button type="button" class="btn-chip" data-act="clear-filter" title="ยกเลิกการกรอง">
                <i class="ph ph-x"></i>&nbsp;ปิด
            </button>
        `,e.classList.add("is-visible"),e.dataset.filterType="suspended"),ae(),re(),_e()}function Nt(e,r){if(!e)return;ye=e;const n=document.getElementById("filterStatusBar");let t=0;document.querySelectorAll(f.room).forEach(o=>{let s=0;o.querySelectorAll(".item-card").forEach(a=>{const l=a.dataset.type===e;a.classList.toggle("item-hidden",!l),l&&s++}),o.classList.toggle("item-hidden",s===0),s>0&&(t+=s)}),n&&(n.innerHTML=`
            <span>เฉพาะ: <strong>${T(r)}</strong> (${t} รายการ)</span>
            <button type="button" class="btn-chip" data-act="clear-filter" title="ยกเลิกการกรอง">
                <i class="ph ph-x"></i>&nbsp;ปิด
            </button>
        `,n.classList.add("is-visible"),n.dataset.filterType=e),ae(),re(),_e()}function lt(){ye=null;const e=document.getElementById("filterStatusBar");e&&(e.classList.remove("is-visible"),e.innerHTML="",e.removeAttribute("data-filter-type")),document.querySelectorAll(".item-hidden").forEach(r=>r.classList.remove("item-hidden")),ae(),re(),_e()}function q(e,r="default"){const n=document.querySelector(f.toastContainer);if(!n)return;const t={success:"ph-bold ph-check-circle",warning:"ph-bold ph-warning",error:"ph-bold ph-x-circle",default:"ph-bold ph-info"},o=document.createElement("div");o.className=`toast toast-${r}`,o.innerHTML=`<i class="${t[r]||t.default}"></i> ${T(e)}`,n.appendChild(o),setTimeout(()=>o.classList.add("show"),10),setTimeout(()=>{o.classList.remove("show"),o.addEventListener("transitionend",()=>o.remove())},3e3)}function U(e,r){return new Promise(n=>{const t=document.querySelector(e);if(!t){console.error("Modal not found:",e),n(null);return}if(O.length>0){const d=O[O.length-1];d&&d.classList.contains("visible")&&d.classList.add("is-underlay")}O.push(t),t.classList.add("visible");const o=t.querySelector('[id$="Confirm"]'),s=t.querySelector('[id$="Cancel"], [data-act="close-modal"], #roomDefaultsCancelBtn, #manageFavsTypeCancel, #forceApplyCancel'),a=Array.from(t.querySelectorAll('button, [href], input:not([type="hidden"]), select, textarea, [tabindex]:not([tabindex="-1"])')).filter(d=>!d.disabled&&d.offsetParent!==null),l=a[0],c=a[a.length-1];setTimeout(()=>l?.focus(),50);const u=d=>{t.classList.remove("visible"),document.removeEventListener("keydown",i),t.removeEventListener("click",p),o&&(o.onclick=null),s&&(s.onclick=null),t.closeModal===u&&(t.closeModal=null);const m=O.pop();m!==t&&(console.error(`[cleanup] Modal stack mismatch! Expected #${t.id}, but popped #${m?.id}. Resetting stack.`),O.length=0);const v=O.length>0?O[O.length-1]:null;v&&v.classList.contains("visible")&&v.classList.remove("is-underlay"),e==="#roomDefaultsModal"&&(le.forEach(({element:_,event:h,handler:S})=>{_.removeEventListener(h,S)}),le=[],de=null),e==="#favoritesModal"&&(Se=null),d?.cancelled&&typeof r=="function"&&r(),n(d)};t.closeModal=u;const i=d=>{const m=O.length>0&&O[O.length-1]===t;d.key==="Escape"&&m&&u({cancelled:!0}),d.key==="Tab"&&a.length>1&&(d.shiftKey?document.activeElement===l&&(c.focus(),d.preventDefault()):document.activeElement===c&&(l.focus(),d.preventDefault()))},p=d=>{const m=O.length>0&&O[O.length-1]===t;d.target===t&&m&&(d.stopPropagation(),u({cancelled:!0}))};o&&(o.onclick=()=>u(!0)),s&&(s.onclick=()=>{O.length>0&&O[O.length-1]===t&&u({cancelled:!0})}),document.addEventListener("keydown",i),t.addEventListener("click",p)})}async function oe(e,r){const n=document.querySelector(f.modal);return n?(n.querySelector(f.modalTitle).textContent=e,n.querySelector(f.modalBody).textContent=r,await U(f.modal)===!0):!0}async function Dt(){const e=document.querySelector(f.exportOptionsModal);if(!e)return null;const r=e.querySelector("#pageBreakBuffer"),n=e.querySelector("#pageBreakBufferValue");r&&n&&(n.textContent=r.value,r.oninput=()=>{n.textContent=r.value});const t=await U(f.exportOptionsModal);return r&&(r.oninput=null),!t||t.cancelled?null:{vatOption:e.querySelector('input[name="vat_option"]:checked')?.value||"include",showDetails:(e.querySelector('input[name="item_details_option"]:checked')?.value||"show_details")==="show_details",exportMethod:e.querySelector("#exportMethod")?.value||"direct",pageBreakBuffer:parseInt(r?.value,10)||3}}async function Rt(){const e=document.querySelector("#discountModal");if(!e)return Promise.resolve({cancelled:!0});const r=e.querySelector("#discountSubtotal"),n=e.querySelector("#discountPercent"),t=e.querySelector("#discountAmount"),o=e.querySelector("#discountFinalTotal"),s=document.querySelector("#discount_type"),a=document.querySelector("#discount_value"),l=y(document.querySelector("#originalTotal").dataset.rawTotal||document.querySelector("#grandTotal").textContent);r&&(r.textContent=C(l));const c=h=>{if(Ne)return;Ne=!0;let S=0;if(h==="percent"){const L=y(n.value);S=l*(Math.max(0,L)/100),t.value=S>0?C(Math.round(S)):""}else S=y(t.value);if(S=Math.max(0,Math.min(S,l)),h!=="percent"){const L=l>0?S/l*100:0;n.value=L>0&&isFinite(L)?Z(L,2):""}o&&(o.textContent=C(l-S)),setTimeout(()=>{Ne=!1},50)},u=()=>c("percent"),i=()=>c("amount"),p=h=>{y(h.target.value)>0&&(h.target.value=y(h.target.value))},d=h=>{const S=y(h.target.value);h.target.value=S>0?C(S):"",c("amount")};n.addEventListener("input",u),t.addEventListener("input",i),t.addEventListener("focus",p),t.addEventListener("blur",d);const m=s.value,v=y(a.value);n.value="",t.value="",v>0?m==="percent"?(n.value=v,c("percent")):(t.value=v,t.value=C(v),c("amount")):c();const _=await U("#discountModal");if(n.removeEventListener("input",u),t.removeEventListener("input",i),t.removeEventListener("focus",p),t.removeEventListener("blur",d),_&&!_.cancelled){const h=y(n.value),S=y(t.value),L=document.activeElement;h>0&&L===n?(s.value="percent",a.value=h):S>0?(s.value="amount",a.value=S):h>0?(s.value="percent",a.value=h):(s.value="amount",a.value=0),V()}}async function Ot(){if(!R)return;const e=document.querySelector("#hardwareModal");if(!e)return;const r=R.querySelector('[name="set_style"]'),n=r?r.value:null,t=n==="ตาไก่",o=n==="ม่านพับ",s=n==="หลุยส์",a=e.querySelector("#trackColorGroup"),l=e.querySelector("#bracketColorGroup"),c=e.querySelector("#finialColorGroup"),u=e.querySelector("#grommetColorGroup"),i=e.querySelector("#louisValanceGroup"),p=e.querySelector("#louisTasselGroup"),d=e.querySelector("#hardwareApplyToRoom");e.querySelector('[name="modal_track_color"]').value=R.querySelector('[name="track_color"]')?.value||"ขาว",e.querySelector('[name="modal_bracket_color"]').value=R.querySelector('[name="bracket_color"]')?.value||"ขาว",e.querySelector('[name="modal_finial_color"]').value=R.querySelector('[name="finial_color"]')?.value||"ขาว",e.querySelector('[name="modal_grommet_color"]').value=R.querySelector('[name="grommet_color"]')?.value||"เงิน",e.querySelector('[name="modal_louis_valance"]').value=R.querySelector('[name="louis_valance"]')?.value||"กล่องหลุยส์",e.querySelector('[name="modal_louis_tassels"]').value=R.querySelector('[name="louis_tassels"]')?.value||"สีเข้ากับผ้า",a&&(a.style.display=""),l&&(l.style.display=""),c&&(c.style.display=t?"":"none"),u&&(u.style.display=t?"":"none"),i&&(i.style.display=s?"":"none"),p&&(p.style.display=s?"":"none"),d&&(d.disabled=o||s);const m=await U("#hardwareModal");m&&!m.cancelled&&(R.querySelector('[name="track_color"]').value=e.querySelector('[name="modal_track_color"]').value,R.querySelector('[name="bracket_color"]').value=e.querySelector('[name="modal_bracket_color"]').value,t?(R.querySelector('[name="finial_color"]').value=e.querySelector('[name="modal_finial_color"]').value,R.querySelector('[name="grommet_color"]').value=e.querySelector('[name="modal_grommet_color"]').value):s&&(R.querySelector('[name="louis_valance"]').value=e.querySelector('[name="modal_louis_valance"]').value,R.querySelector('[name="louis_tassels"]').value=e.querySelector('[name="modal_louis_tassels"]').value),X(),q("บันทึกการตั้งค่าอุปกรณ์แล้ว","success")),R=null}async function Ht(e){if(!e)return;de=e;const r=document.querySelector(f.roomDefaultsModal),n=document.querySelector(f.roomDefaultsForm);if(!r||!n)return;le.forEach(({element:c,event:u,handler:i})=>{c.removeEventListener(u,i)}),le=[];const t=JSON.parse(de.dataset.roomDefaults||"{}"),o=r.querySelectorAll(".defaults-tab"),s=r.querySelectorAll(".defaults-content"),a=c=>{const u=c.currentTarget,i=u.dataset.target;if(!i)return;o.forEach(d=>d.classList.remove("is-active")),s.forEach(d=>d.classList.remove("is-active")),u.classList.add("is-active");const p=r.querySelector(`.defaults-content[data-type="${i}"]`);p&&p.classList.add("is-active")};o.forEach(c=>{c.addEventListener("click",a),le.push({element:c,event:"click",handler:a})}),o[0]&&o[0].classList.add("is-active"),s[0]&&s[0].classList.add("is-active");const l=c=>{const u=c.target,i=u.closest(".defaults-content");if(!i)return;const p=u.checked,d=i.querySelector(".defaults-inputs-grid");i.classList.toggle("is-enabled-content",p),d&&d.querySelectorAll('input[type="text"], input[type="number"], select').forEach(m=>{m.disabled=!p})};s.forEach(c=>{const u=c.querySelector('.defaults-enable-toggle input[type="checkbox"]');if(!u)return;const i=u.name,p=t[i]===!0||t[i]==="1";u.checked=p,l({target:u}),u.addEventListener("change",l),le.push({element:u,event:"change",handler:l});const d=c.querySelector(".defaults-inputs-grid");d&&d.querySelectorAll('input[type="text"], input[type="number"]').forEach(m=>{const v=m.name,_=t[v];m.type==="text"&&m.inputMode==="numeric"?(m.value=_!=null&&_>=0?C(_):"",m.addEventListener("focus",Ze),m.addEventListener("blur",et),le.push({element:m,event:"focus",handler:Ze}),le.push({element:m,event:"blur",handler:et})):m.value=_||""})}),await U(f.roomDefaultsModal)}async function jt(){const e=document.querySelector("#forceApplyModal");if(!e)return;const r=e.querySelector('[name="force_apply_type"]'),n=e.querySelector('[name="force_apply_code"]'),t=e.querySelector('[name="force_apply_price"]');r&&(r.value=""),n&&(n.value=""),t&&(t.value=""),await U("#forceApplyModal")}function Ze(e){y(e.target.value)>0&&(e.target.value=y(e.target.value))}function et(e){const r=y(e.target.value);e.target.value=r!=null&&r>=0?C(r):""}function Wt(){if(!de)return;const e=document.querySelector(f.roomDefaultsForm);if(!e)return;const r={};e.querySelectorAll(".defaults-content").forEach(t=>{const o=t.querySelector('.defaults-enable-toggle input[type="checkbox"]');if(o){const s=o.name,a=o.checked;if(r[s]=a,a){const l=t.querySelector(".defaults-inputs-grid");l&&l.querySelectorAll('input[type="text"], input[type="number"]').forEach(c=>{const u=c.name,i=c.type==="text"&&c.inputMode==="numeric"?y(c.value):c.value.trim();(typeof i=="number"||typeof i=="string"&&i!=="")&&(r[u]=i)})}}}),de.dataset.roomDefaults=JSON.stringify(r),X();const n=document.querySelector(f.roomDefaultsModal);n&&typeof n.closeModal=="function"?(n.closeModal(!0),setTimeout(()=>q("บันทึกค่าเริ่มต้นห้องแล้ว","success"),50)):console.error("Could not find room defaults modal or its closer function.")}async function Gt(){if(!de)return;const e=document.querySelector(f.roomDefaultsModal),r=document.querySelector(f.roomDefaultsForm);if(!e||!r)return;const n={};if(r.querySelectorAll(".defaults-content").forEach(s=>{const a=s.querySelector('.defaults-enable-toggle input[type="checkbox"]');if(a&&a.checked){const l=s.querySelector(".defaults-inputs-grid");l&&l.querySelectorAll('input[type="text"], input[type="number"]').forEach(c=>{const u=c.name,i=c.type==="text"&&c.inputMode==="numeric"?y(c.value):c.value.trim();(typeof i=="number"||typeof i=="string"&&i!=="")&&(n[u]=i)})}}),Object.keys(n).length===0){q("ยังไม่มีการเลือกค่าเริ่มต้นที่จะใช้","warning");return}if(!await oe("ใช้ค่าเริ่มต้น","ใช้ค่าเริ่มต้นที่ *เลือกไว้* กับรายการที่ยังไม่มีข้อมูลในห้องนี้?"))return;ne(J()),te();let t=0;de.getItemsContainer().querySelectorAll(".item-card").forEach(s=>{const a=s.dataset.type;let l=!1;const c=(u,i)=>{const p=n[i],d=s.querySelector(u);if(!d||p==null)return;const m=d.tagName==="SELECT",v=m?d.value:d.value.trim(),_=m?null:y(v);let h=!1;if(m?h=!v:d.matches('input[type="text"][inputmode="numeric"]')?h=!v||_===0:h=!v,h){let S=!1;m?Array.from(d.options).some(L=>L.value==p)&&(d.value=p,S=!0):d.matches('input[type="text"][inputmode="numeric"]')?p>=0&&(d.value=C(p),S=!0):d.matches('input[type="text"]:not([inputmode])')&&(d.value=p,S=!0),S&&(l=!0,d.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0})))}};switch(a){case"set":c(f.setFabricCodeInput,"defaults_fabric_code"),c(f.setPricePerMSelect,"defaults_fabric_price"),c(f.setSheerCodeInput,"defaults_sheer_code"),c(f.setSheerPricePerMSelect,"defaults_sheer_price");break;case"wallpaper":c(f.wallCodeInput,"defaults_wallpaper_code"),c(f.wallPriceRollInput,"defaults_wallpaper_price_roll"),c(f.wallInstallCostInput,"defaults_wallpaper_install_cost");break;case"wooden_blind":c(f.areaCodeInput,"defaults_wooden_blind_code"),c(f.areaPriceSqydInput,"defaults_wooden_blind_price_sqyd");break;case"roller_blind":c(f.areaCodeInput,"defaults_roller_blind_code"),c(f.areaPriceSqydInput,"defaults_roller_blind_price_sqyd");break;case"vertical_blind":c(f.areaCodeInput,"defaults_vertical_blind_code"),c(f.areaPriceSqydInput,"defaults_vertical_blind_price_sqyd");break;case"partition":c(f.areaCodeInput,"defaults_partition_code"),c(f.areaPriceSqydInput,"defaults_partition_price_sqyd");break;case"pleated_screen":c(f.areaCodeInput,"defaults_pleated_screen_code"),c(f.areaPriceSqydInput,"defaults_pleated_screen_price_sqyd");break;case"aluminum_blind":c(f.areaCodeInput,"defaults_aluminum_blind_code"),c(f.areaPriceSqydInput,"defaults_aluminum_blind_price_sqyd");break}l&&(t++,s.querySelectorAll("input[data-favorite-type]").forEach(ce))}),e&&typeof e.closeModal=="function"?e.closeModal({cancelled:!0}):console.error("Could not find room defaults modal or its closer function."),setTimeout(()=>{t>0?(V(),q(`ใช้ค่าเริ่มต้นกับ ${t} รายการแล้ว`,"success")):q("ไม่มีรายการใดที่ต้องอัปเดต","default")},50)}async function Vt(){const e=document.querySelector("#forceApplyModal");if(!e)return;const r=e.querySelector('[name="force_apply_type"]'),n=e.querySelector('[name="force_apply_code"]'),t=e.querySelector('[name="force_apply_price"]'),o=r.value,s=n.value.trim(),a=y(t.value);if(!o){q("โปรดเลือกประเภทรายการที่จะบังคับใช้","warning"),r.focus();return}if(!s){q("โปรดกรอกรหัสที่จะบังคับใช้","warning"),n.focus();return}if(a<0||a<=0&&!["fabric","sheer","wallpaper"].includes(o)){q("โปรดกรอกราคาที่ถูกต้อง (> 0)","warning"),t.focus();return}let l=r.options[r.selectedIndex].text;const c="ยืนยันการบังคับใช้",u=`⚠️ ยืนยันการเปลี่ยนรหัสเป็น "${s}" และราคาเป็น ${C(a)} บาท สำหรับรายการประเภท "${l}" ***ทุกรายการ*** ในทุกห้องหรือไม่? การกระทำนี้ไม่สามารถยกเลิกได้ง่ายๆ`;if(!await oe(c,u))return;ne(J()),te();let i=0;document.querySelectorAll(".item-card").forEach(d=>{const m=d.dataset.type;let v=null,_=null;if(o==="fabric"&&m==="set"?(v=d.querySelector('input[name="fabric_code"]'),_=d.querySelector('select[name="set_price_per_m"]')):o==="sheer"&&m==="set"?(v=d.querySelector('input[name="sheer_fabric_code"]'),_=d.querySelector('select[name="sheer_price_per_m"]')):o==="wallpaper"&&m==="wallpaper"?(v=d.querySelector('input[name="wallpaper_code"]'),_=d.querySelector('input[name="wallpaper_price_roll"]')):m===o&&d.matches(".area-based-item")&&(v=d.querySelector('input[name="area_code"]'),_=d.querySelector('input[name="area_price_sqyd"]')),v&&_){let h=!1,S=!1;if(v.value!==s&&(v.value=s,h=!0),_.tagName==="SELECT")_.value!=a&&(Array.from(_.options).some(L=>L.value==a)?(_.value=a,S=!0):console.warn(`Price ${a} not found in options for`,_));else{const L=_.value,E=a!=null&&a>=0?C(a):"";L!==E&&(_.value=E,S=!0)}(h||S)&&(i++,h&&(v.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0})),ce(v)),S&&(_.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0})),_.dispatchEvent(new Event("blur",{bubbles:!0,cancelable:!0}))),v.classList.add("input-highlight"),_.classList.add("input-highlight"),setTimeout(()=>{v.classList.remove("input-highlight"),_.classList.remove("input-highlight")},1200))}}),i>0?(V(),q(`บังคับใช้ค่าใหม่กับ ${i} รายการ (${l}) สำเร็จ`,"success"),e&&typeof e.closeModal=="function"&&e.closeModal({cancelled:!0})):q(`ไม่พบรายการประเภท "${l}" ที่ต้องอัปเดต`,"default")}async function Ut(){const e=document.querySelector("#manageFavsTypeModal"),r=document.querySelector("#manageFavsTypeBody");if(!e||!r)return;const n=Object.keys(se());let t="",o=null;const s={fabric:"ph-rows",sheer:"ph-waves",wallpaper:"ph-paint-roller",wooden_blind:"ph-table",roller_blind:"ph-scroll",vertical_blind:"ph-sidebar-simple",partition:"ph-columns",pleated_screen:"ph-squares-four",aluminum_blind:"ph-stack-simple"};if(n.includes("fabric")&&(t+=`
             <label data-item-type="fabric">
                 <input type="radio" name="manage_fav_type_option" value="fabric">
                 <span class="radio-card-content">
                     <strong><i class="ph ${s.fabric}"></i> ผ้าทึบ</strong>
                     <small>Fabric Codes</small>
                 </span>
             </label>`,o||(o="fabric")),n.includes("sheer")&&(t+=`
              <label data-item-type="sheer">
                  <input type="radio" name="manage_fav_type_option" value="sheer">
                  <span class="radio-card-content">
                      <strong><i class="ph ${s.sheer}"></i> ผ้าโปร่ง</strong>
                      <small>Sheer Codes</small>
                  </span>
              </label>`,o||(o="sheer")),n.forEach(l=>{if(l==="fabric"||l==="sheer")return;const c=D[l];if(c){const u=c.name,i=s[l]||"ph-star";t+=`
                <label data-item-type="${l}">
                    <input type="radio" name="manage_fav_type_option" value="${l}">
                    <span class="radio-card-content">
                        <strong><i class="ph ${i}"></i> ${T(u)}</strong>
                        <small>${l.replace(/_/g," ").replace(/\b\w/g,p=>p.toUpperCase())} Codes</small>
                    </span>
                </label>`,o||(o=l)}}),r.innerHTML=t,o){const l=r.querySelector(`input[value="${o}"]`);l&&(l.checked=!0)}const a=await U("#manageFavsTypeModal");if(a&&!a.cancelled){const l=r.querySelector('input[name="manage_fav_type_option"]:checked')?.value;l&&await ut(l)}}function Re(e,r){e&&(ne(J()),te(),e.classList.add("item-removing"),e.addEventListener("animationend",()=>{e.remove(),q(r),Pe(),ae(),V(),$e()},{once:!0}))}function Jt(e){if(!e)return;const r=document.querySelector(".main-header");if(!r){e.scrollIntoView({behavior:"smooth",block:"center"});return}const n=r.offsetHeight,t=16,s=(e.querySelector(".item-header")||e).getBoundingClientRect(),a=n+t,l=s.top-a;Math.abs(l)>5&&window.scrollBy({top:l,behavior:"smooth"})}function qe(e){if(!e)return;const r=document.querySelector(".main-header"),n=document.querySelector(".summary-footer"),t=r?r.offsetHeight+16:80,o=n?n.offsetHeight+16:100;requestAnimationFrame(()=>{const s=e.getBoundingClientRect(),a=window.innerHeight;if(!(s.top>=t&&s.bottom<=a-o)){const c=a-t-o,u=s.height>c?"start":"center";e.scrollIntoView({behavior:"smooth",block:u})}})}function ae(){document.querySelectorAll(f.room).forEach(e=>{const r=e.querySelectorAll(".item-card:not(.item-hidden)");let n=0;const t=Array.from(r).filter(o=>!o.classList.contains("is-suspended")).length;r.forEach(o=>{const s=o.querySelector("[data-item-title]");s&&(o.classList.contains("is-suspended")?s.textContent="-":(n++,s.textContent=`${n}/${t}`))}),e.querySelectorAll(".item-card.item-hidden").forEach(o=>{const s=o.querySelector("[data-item-title]");s&&(s.textContent="-")})})}function ct(){const e=document.querySelector(f.orderForm),r=document.querySelector(f.lockBtn);!e||!r||(e.classList.toggle("is-locked",ee),r.classList.toggle("is-locked",ee),r.querySelector("i").className=ee?"ph-bold ph-lock-key":"ph ph-paw-print",e.querySelectorAll('input:not([type="hidden"]), select, textarea, button:not(.unlockable):not([data-act="toggle-more-details"]):not([data-act="collapse-room"])').forEach(n=>{!n.closest(".main-header")&&!n.closest(".summary-footer")&&!n.closest(".modal-wrapper")&&(n.disabled=ee)}),document.querySelectorAll(".unlockable").forEach(n=>n.disabled=!1))}function Yt(){ee=!ee,ct(),q(ee?"ฟอร์มถูกล็อค":"ปลดล็อคฟอร์มแล้ว",ee?"warning":"success")}function re(){const e=document.querySelectorAll(f.room+":not(.item-hidden)");if(e.length===0){const t=document.querySelector(f.toggleAllRoomsBtn);t&&(t.querySelector("i").className="ph ph-caret-down",t.querySelector("span").textContent="ขยายทั้งหมด");return}const r=[...e].some(t=>t.open),n=document.querySelector(f.toggleAllRoomsBtn);n&&(n.querySelector("i").className=r?"ph ph-caret-up":"ph ph-caret-down",n.querySelector("span").textContent=r?"ย่อทั้งหมด":"ขยายทั้งหมด")}function Qt(){const e=document.querySelectorAll(f.room+":not(.item-hidden)");if(e.length===0)return;const r=[...e].some(t=>t.open);e.forEach(t=>{t.open=!r});const n=document.querySelector(f.quickNavDropdown);n&&n.classList.contains("show")&&(n.classList.remove("show"),document.querySelector(f.quickNavBtn)?.setAttribute("aria-expanded","false")),setTimeout(()=>{re(),X()},50)}function Pe(){const e=document.querySelector(f.quickNavRoomList);e&&(e.innerHTML="",document.querySelectorAll(f.room).forEach(r=>{const n=r.querySelector(f.roomNameInput)?.value||"ห้อง",t=document.createElement("a");t.href=`#${r.id}`,t.dataset.jumpTo=r.id,t.innerHTML=`<i class="ph ph-share-fat"></i> ${T(n)||"ห้อง (ไม่มีชื่อ)"}`,e.appendChild(t)}))}function Oe(e){const r=document.getElementById("quickNavBtnText");r&&(e?r.textContent=e.querySelector('input[name="room_name"]')?.value||"...":r.textContent="ไปยังห้อง")}function $e(){if(ke&&ke.disconnect(),!document.getElementById("quickNavBtnText"))return;const r={root:null,rootMargin:"-60px 0px -150px 0px",threshold:0},n=o=>{const s=o.filter(a=>a.isIntersecting).sort((a,l)=>a.target.getBoundingClientRect().top-l.target.getBoundingClientRect().top);s.length>0&&Oe(s[0].target)};ke=new IntersectionObserver(n,r),document.querySelectorAll(f.room).forEach(o=>ke.observe(o));const t=Array.from(document.querySelectorAll(f.room));if(t.length>0){t.sort((s,a)=>s.getBoundingClientRect().top-a.getBoundingClientRect().top);const o=t.find(s=>s.getBoundingClientRect().bottom>60);Oe(o||t[0])}else Oe(null)}function ce(e){if(!e)return;const r=e.closest(".form-group-with-favorites")?.querySelector(".btn-favorite");if(!r)return;const n=e.dataset.favoriteType,t=e.value;r.classList.toggle("is-favorite",ot(n,t))}function Te(e,r=null){if(!e)return;const n=e.querySelector(".item-details-more"),t=e.querySelector('[data-act="toggle-more-details"]'),o=t?.parentElement;if(!n||!t||!o)return;const s=n.classList.contains("show"),a=r!==null?r:!s;if(s===a)return;n.classList.toggle("show",a),t.classList.toggle("expanded",a);const l=t.querySelector("i");l&&(l.className=a?"ph ph-caret-up":"ph ph-caret-down");const c=t.querySelector("span");if(c&&(c.textContent=a?"ย่อน้อยลง":"เพิ่มเติม"),a)n.appendChild(o),setTimeout(()=>Jt(e),100);else{const u=e.querySelector(".item-grid");u&&u.appendChild(o)}}function he(e={}){const r=document.querySelector(f.roomsContainer);if(!r)return null;Object.keys(e).length===0&&(ne(J()),te());const n=nt(e);return n?(r.appendChild(n),Object.keys(e).length===0&&(n.classList.add("item-created"),qe(n),n.querySelector('input[name="room_name"]')?.focus()),Pe(),re(),$e(),Object.keys(e).length===0&&X(),n):null}async function it(e,r=null){const n=document.querySelector("#itemTypeModal");if(!n)return null;n.querySelector("#itemTypeModalTitle").textContent=e;let t=r||"set";r&&!D[r]&&(t="set");const o=n.querySelector(`input[name="item_type_option"][value="${t}"]`);if(o)o.checked=!0;else{const l=n.querySelector('input[name="item_type_option"][value="set"]');l&&(l.checked=!0)}const s=await U("#itemTypeModal");if(!s||s.cancelled)return null;const a=n.querySelector('input[name="item_type_option"]:checked');return a?a.value:null}async function Kt(e,r){if(!r||!e||!D[e])return;const n=r.getItemsContainer();if(!n)return;ne(J()),te();const t=JSON.parse(r.dataset.roomDefaults||"{}");let o={};const s=l=>t[`enable_defaults_${l}`]===!0;switch(e){case"set":s("set")&&(o.fabric_code=t.defaults_fabric_code,o.price_per_m_raw=t.defaults_fabric_price,o.sheer_fabric_code=t.defaults_sheer_code,o.sheer_price_per_m=t.defaults_sheer_price);break;case"wallpaper":s("wallpaper")&&(o.wallpaper_code=t.defaults_wallpaper_code,o.price_per_roll=t.defaults_wallpaper_price_roll,o.install_cost_per_roll=t.defaults_wallpaper_install_cost??300);break;case"wooden_blind":s("wooden_blind")&&(o.code=t.defaults_wooden_blind_code,o.price_sqyd=t.defaults_wooden_blind_price_sqyd);break;case"roller_blind":s("roller_blind")&&(o.code=t.defaults_roller_blind_code,o.price_sqyd=t.defaults_roller_blind_price_sqyd);break;case"vertical_blind":s("vertical_blind")&&(o.code=t.defaults_vertical_blind_code,o.price_sqyd=t.defaults_vertical_blind_price_sqyd);break;case"partition":s("partition")&&(o.code=t.defaults_partition_code,o.price_sqyd=t.defaults_partition_price_sqyd);break;case"pleated_screen":s("pleated_screen")&&(o.code=t.defaults_pleated_screen_code,o.price_sqyd=t.defaults_pleated_screen_price_sqyd);break;case"aluminum_blind":s("aluminum_blind")&&(o.code=t.defaults_aluminum_blind_code,o.price_sqyd=t.defaults_aluminum_blind_price_sqyd);break}let a;if(e==="set")a=Be(o);else if(e==="wallpaper")a=Ae(o);else if(D[e].templateId==="#areaBasedTpl")a=Ee(e,o);else return;a&&(n.appendChild(a),a.classList.add("item-created"),a.querySelectorAll("input[data-favorite-type]").forEach(ce),qe(a),a.querySelector('input:not([type="hidden"]), select, textarea')?.focus(),ae(),V())}async function Xt(e){if(!e)return;const r=e.dataset.type,n=await it("เปลี่ยนประเภทรายการ",r);if(!n||n===r||!await oe("ยืนยันการเปลี่ยนแปลง","ข้อมูลทั้งหมดในรายการนี้จะถูกลบและสร้างใหม่ คุณแน่ใจหรือไม่?"))return;ne(J()),te();const t=e.closest(f.room),o=JSON.parse(t?.dataset.roomDefaults||"{}");let s={};const a=c=>o[`enable_defaults_${c}`]===!0;switch(n){case"set":a("set")&&(s.fabric_code=o.defaults_fabric_code,s.price_per_m_raw=o.defaults_fabric_price,s.sheer_fabric_code=o.defaults_sheer_code,s.sheer_price_per_m=o.defaults_sheer_price);break;case"wallpaper":a("wallpaper")&&(s.wallpaper_code=o.defaults_wallpaper_code,s.price_per_roll=o.defaults_wallpaper_price_roll,s.install_cost_per_roll=o.defaults_wallpaper_install_cost??300);break;case"wooden_blind":a("wooden_blind")&&(s.code=o.defaults_wooden_blind_code,s.price_sqyd=o.defaults_wooden_blind_price_sqyd);break;case"roller_blind":a("roller_blind")&&(s.code=o.defaults_roller_blind_code,s.price_sqyd=o.defaults_roller_blind_price_sqyd);break;case"vertical_blind":a("vertical_blind")&&(s.code=o.defaults_vertical_blind_code,s.price_sqyd=o.defaults_vertical_blind_price_sqyd);break;case"partition":a("partition")&&(s.code=o.defaults_partition_code,s.price_sqyd=o.defaults_partition_price_sqyd);break;case"pleated_screen":a("pleated_screen")&&(s.code=o.defaults_pleated_screen_code,s.price_sqyd=o.defaults_pleated_screen_price_sqyd);break;case"aluminum_blind":a("aluminum_blind")&&(s.code=o.defaults_aluminum_blind_code,s.price_sqyd=o.defaults_aluminum_blind_price_sqyd);break}let l;if(n==="set")l=Be(s);else if(n==="wallpaper")l=Ae(s);else if(D[n]?.templateId==="#areaBasedTpl")l=Ee(n,s);else return;l&&(e.replaceWith(l),l.classList.add("item-created"),l.querySelectorAll("input[data-favorite-type]").forEach(ce),qe(l),l.querySelector('input:not([type="hidden"]), select, textarea')?.focus(),ae(),V(),q("เปลี่ยนประเภทรายการแล้ว","success"))}const V=we(()=>{let e=0;document.querySelectorAll(f.room).forEach(u=>{let i=0,p=0;const d=u.classList.contains("is-suspended");d||(u.querySelectorAll(".item-card:not(.is-suspended)").forEach(m=>{const v=y(m.dataset.totalPrice);v>0&&(i+=v,p++)}),e+=i),typeof u.updateBrief=="function"&&(d?u.updateBrief("(ระงับชั่วคราว)"):p>0?u.updateBrief(`<span>${p}</span> &bull; ${C(i)} บาท`):u.updateBrief("<span>0</span> รายการ"))});const r=document.querySelector("#discount_type"),n=document.querySelector("#discount_value"),t=r?r.value:"amount",o=n?y(n.value):0;let s=0;o>0&&(s=t==="percent"?e*(o/100):o,s=Math.min(e,s));const a=e-s,l=document.querySelector("#grandTotal"),c=document.querySelector("#originalTotal");l&&(l.textContent=C(a)),c&&(s>0?(c.textContent=C(e),c.dataset.rawTotal=e,c.style.display="block"):(c.style.display="none",c.dataset.rawTotal="")),_e(),X()},200);async function Je(e,r=!1){if(!e){q("ข้อมูลสำหรับโหลดไม่ถูกต้อง","error");return}if(e.favorites)if(r){const u=document.querySelector("#favoritesConflictModal");if(u){const i=u.querySelector('input[name="fav_conflict_option"][value="merge"]');i&&(i.checked=!0);const p=await U("#favoritesConflictModal");if(!p||p.cancelled){q("ยกเลิกการนำเข้า","warning");return}const d=u.querySelector('input[name="fav_conflict_option"]:checked').value;let m=0;switch(d){case"overwrite":Ye(e.favorites)&&q("เขียนทับรายการโปรดสำเร็จ","success");break;case"merge":m=He(e.favorites),q(`รวมข้อมูลสำเร็จ (เพิ่ม ${m} รายการใหม่)`,"success");break;case"skip":q("ข้ามการนำเข้ารายการโปรด","default");break}}else He(e.favorites)}else Ye(e.favorites);const n=document.querySelector(f.roomsContainer);if(!n)return;n.innerHTML="";const t=document.querySelector("#customer_name"),o=document.querySelector("#customer_phone"),s=document.querySelector("#customer_address"),a=document.querySelector("#customerDetailsCard");t&&(t.value=e.customer_name||""),o&&(o.value=e.customer_phone||""),s&&(s.value=e.customer_address||""),a&&(a.open=e.customer_card_open??!0);const l=document.querySelector("#discount_type"),c=document.querySelector("#discount_value");if(e.discount&&l&&c?(l.value=e.discount.type||"amount",c.value=e.discount.value||0):l&&c&&(l.value="amount",c.value=0),!Array.isArray(e.rooms)){q("ไม่พบข้อมูลห้องในไฟล์","warning"),n.children.length===0&&he();return}for(const u of e.rooms){const i=nt(u);if(!i)continue;n.appendChild(i);const p=i.getItemsContainer();if(p&&Array.isArray(u.items))for(const d of u.items){let m;if(d.type==="set")m=Be(d);else if(d.type==="wallpaper")m=Ae(d);else if(D[d.type]?.templateId==="#areaBasedTpl")m=Ee(d.type,d);else continue;m&&p.appendChild(m)}}document.querySelectorAll("input[data-favorite-type]").forEach(ce),ae(),Pe(),re(),$e(),te(),V(),r&&q("นำเข้าข้อมูลฟอร์มสำเร็จ","success")}async function zt(e,r){const n=document.querySelector(f.printableContent);if(!n||!e){q("ไม่พบข้อมูลสำหรับสร้างเอกสาร","error");return}const t=document.title;if(r==="direct"){q("กำลังสร้าง PDF...","default");let o;try{typeof window.html2pdf>"u"&&(q("กำลังโหลดไลบรารี PDF...","default"),await Et("https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js")),o=document.createElement("div"),o.style.position="fixed",o.style.left="-300mm",o.style.top="0",o.style.width="210mm",o.style.background="#fff",o.innerHTML=e,document.body.appendChild(o),await new Promise(a=>setTimeout(a,300));const s={margin:0,filename:`${t}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0,logging:!1,width:o.querySelector(".pdf-page")?.scrollWidth||794,windowWidth:o.querySelector(".pdf-page")?.scrollWidth||794},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}};await window.html2pdf().from(o).set(s).save(),q("ดาวน์โหลด PDF สำเร็จ","success")}catch(s){console.error("PDF Generation Error:",s),q("สร้าง PDF ล้มเหลว, โปรดลองวิธีที่ 2 (พิมพ์)","error")}finally{o&&document.body.contains(o)&&document.body.removeChild(o)}}else r==="print"&&(n.innerHTML=e,setTimeout(()=>{window.print(),setTimeout(()=>{n.innerHTML=""},1e3)},mt))}function Zt(e){if(!e||!e.html){q("ไม่พบข้อมูลสำหรับสร้างไฟล์ HTML","error");return}try{const r=`<!DOCTYPE html><html lang="th"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>${e.fileName}</title><link rel="stylesheet" href="./src/styles/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/bold/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/fill/style.css"><style>body { background-color: #eee; } #printable-content { display: block !important; max-width: 210mm; margin: 10mm auto; } .pdf-page { border: 1px solid #ccc; box-shadow: 0 0 10px rgba(0,0,0,0.1); margin-bottom: 10mm; background: #fff; page-break-inside: avoid; } .pdf-page-content { padding: 12mm; } @media print { body { background-color: #fff; } #printable-content { max-width: 100%; margin: 0; } .pdf-page { border: none; box-shadow: none; margin-bottom: 0; page-break-after: always; } .pdf-page:last-child { page-break-after: avoid; } } i.ph { vertical-align: middle; }</style></head><body><div id="printable-content">${e.html}</div></body></html>`,n=new Blob([r],{type:"text/html;charset=utf-8"}),t=URL.createObjectURL(n),o=document.createElement("a");o.href=t,o.download=`${e.fileName}.html`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(t),q("ดาวน์โหลดไฟล์ HTML สำเร็จ","success")}catch(r){console.error("HTML Export Error:",r),q("สร้างไฟล์ HTML ล้มเหลว","error")}}function eo(e){const r=e.closest(".item-card");if(!r)return;const n=y(e.value);let t;const o=e.getAttribute("name");if(o==="set_price_per_m")t=r.querySelector('input[name="fabric_code"]');else if(o==="sheer_price_per_m")t=r.querySelector('input[name="sheer_fabric_code"]');else if(o==="wallpaper_price_roll")t=r.querySelector('input[name="wallpaper_code"]');else if(o==="area_price_sqyd")t=r.querySelector('input[name="area_code"]');else return;if(t&&t.value.trim()){const s=t.dataset.favoriteType,a=t.value.trim(),l=Ue(s,a);if(l&&l.price!==n){const c=t.closest(".form-group-with-favorites")?.querySelector(".btn-favorite");c?.classList.contains("is-favorite")&&(Ie(s,a,l.price),c.classList.remove("is-favorite"),q(`ยกเลิก Favorite '${a}' เนื่องจากราคาไม่ตรงกัน`,"warning"),X())}}}function to(e){const{roomId:r,itemIndex:n}=e.dataset;if(!r||n===void 0)return;const t=document.getElementById("lookbookModal");t&&typeof t.closeModal=="function"&&t.closeModal({cancelled:!0});const o=document.getElementById(r);if(!o){q("ไม่พบห้องที่ต้องการ","error");return}const a=Array.from(o.querySelectorAll(".item-card:not(.item-hidden)"))[parseInt(n,10)];if(!a){q("ไม่พบรายการที่ต้องการ","error");return}o.open=!0,re(),setTimeout(()=>{a.scrollIntoView({behavior:"smooth",block:"center"}),a.classList.add("scrolling-jump"),setTimeout(()=>a.classList.remove("scrolling-jump"),2500)},150)}function oo(e){if(!Se)return;const r=Se.closest(".item-card");if(!r)return;const n=Se,t=n.dataset.favoriteType;let o;t==="fabric"?o="set_price_per_m":t==="sheer"?o="sheer_price_per_m":t==="wallpaper"?o="wallpaper_price_roll":o="area_price_sqyd";const a=r.querySelector(`[name="${o}"]`),l=e.dataset.code,c=y(e.dataset.price);n.value=l,n.classList.add("input-highlight"),setTimeout(()=>{n&&n.classList.remove("input-highlight")},1200),a&&(c>0||["fabric","sheer","wallpaper"].includes(t))&&(a.tagName==="SELECT"?Array.from(a.options).some(p=>y(p.value)===c)?a.value=c:q(`ราคา ${C(c)} ไม่มีในตัวเลือก`,"warning"):a.value=t==="wallpaper"&&o==="wallpaper_install_cost"&&c===0?"0":c>=0?C(c):"",a.classList.add("input-highlight"),setTimeout(()=>{a&&a.classList.remove("input-highlight")},1200)),ce(n),(a||n).dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0}));const i=document.querySelector("#favoritesModal");i&&typeof i.closeModal=="function"&&i.closeModal({cancelled:!1,applied:!0})}async function ro(e){Se=e;const r=e.dataset.favoriteType;if(!r)return;const n=document.querySelector("#favoritesModal"),t=n.querySelector("#favoritesModalTitle"),o=n.querySelector("#favoritesModalBody"),s=n.querySelector("#favSearchInput"),a=n.querySelector('[data-act="manage-favorites"]'),l=document.querySelector("#favSelectorItemTpl");if(!n||!t||!o||!s||!a||!l){console.error("Missing elements for favorites modal");return}let c=D[r]?.name||r;r==="fabric"?c="ผ้าทึบ":r==="sheer"&&(c="ผ้าโปร่ง"),t.textContent=`เลือก '${T(c)}'`,(()=>{const _=se()[r]||[];_.length>0?o.innerHTML=_.map(h=>{let S="-";return(h.price>0||["fabric","sheer","wallpaper"].includes(r)&&h.price===0)&&(S=C(h.price)),l.innerHTML.replace(/{CODE}/g,T(h.code)).replace(/{PRICE}/g,S).replace(/{RAW_PRICE}/g,h.price)}).join(""):o.innerHTML='<p class="empty-state">ไม่มีรายการโปรดที่บันทึกไว้</p>',s.value=""})();const i=()=>{const v=s.value.toLowerCase();o.querySelectorAll(".fav-selector-item").forEach(_=>{const h=_.dataset.code.toLowerCase();_.classList.toggle("is-hidden",!h.includes(v))})},p=v=>{const _=v.target.closest(".fav-selector-item");_&&(oo(_),m())},d=async()=>{const v=document.querySelector("#favoritesModal");if(v&&typeof v.closeModal=="function")v.closeModal({cancelled:!0,manageClicked:!0});else{console.error("Could not find favorites modal or its closer function to close before opening manager.");return}await ut(r)},m=()=>{s.removeEventListener("input",i),o.removeEventListener("click",p),a&&(a.onclick=null)};s.addEventListener("input",i),o.addEventListener("click",p),a.onclick=d,await U("#favoritesModal",m)}function Me(e){const r=document.querySelector("#favManagerBody"),n=document.querySelector("#favManagerItemTpl"),o=se()[e]||[];if(!r||!n)return;o.length===0?r.innerHTML='<p class="empty-state">ไม่มีรายการโปรดที่บันทึกไว้</p>':r.innerHTML=o.map(l=>{let c="-";return(l.price>0||["fabric","sheer","wallpaper"].includes(e)&&l.price===0)&&(c=C(l.price)),n.innerHTML.replace(/{CODE}/g,T(l.code)).replace(/{PRICE}/g,c).replace(/{RAW_PRICE}/g,l.price)}).join(""),G=null;const s=document.querySelector('#favManagerModal [data-act="edit-selected-fav"]'),a=document.querySelector('#favManagerModal [data-act="del-selected-fav"]');s&&(s.disabled=!0),a&&(a.disabled=!0)}async function ut(e){const r=document.querySelector("#favManagerModal");if(!r||!e)return;let n=D[e]?.name||e;e==="fabric"?n="ผ้าทึบ":e==="sheer"&&(n="ผ้าโปร่ง"),r.dataset.currentType=e,G=null,document.querySelector("#favManagerTitle").textContent=`จัดการ '${T(n)}'`,Me(e),await U("#favManagerModal")}function ao(e){if(!e||!e.matches(f.itemCard))return null;const r=e.dataset.type;if(!r)return null;let n={type:r,is_suspended:e.classList.contains("is-suspended")};try{return r==="set"?Object.assign(n,{width_m:y(e.querySelector(f.setWidthInput)?.value),height_m:y(e.querySelector(f.setHeightInput)?.value),style:e.querySelector(f.setStyleSelect)?.value||"",fabric_variant:e.querySelector(f.setFabricVariantSelect)?.value||"",price_per_m_raw:y(e.querySelector(f.setPricePerMSelect)?.value),sheer_price_per_m:y(e.querySelector(f.setSheerPricePerMSelect)?.value),louis_price_per_m:y(e.querySelector('select[name="louis_price_per_m"]')?.value),fabric_code:e.querySelector(f.setFabricCodeInput)?.value||"",sheer_fabric_code:e.querySelector(f.setSheerCodeInput)?.value||"",opening_style:e.querySelector(f.setOpeningStyleSelect)?.value||"",adjustment_side:e.querySelector(f.setAdjustmentSideSelect)?.value||"ปรับขวา",track_color:e.querySelector('input[name="track_color"]')?.value||"ขาว",bracket_color:e.querySelector('input[name="bracket_color"]')?.value||"ขาว",finial_color:e.querySelector('input[name="finial_color"]')?.value||"ขาว",grommet_color:e.querySelector('input[name="grommet_color"]')?.value||"เงิน",louis_valance:e.querySelector('input[name="louis_valance"]')?.value||"กล่องหลุยส์",louis_tassels:e.querySelector('input[name="louis_tassels"]')?.value||"สีเข้ากับผ้า",notes:e.querySelector(f.setNotesInput)?.value||""}):r==="wallpaper"?Object.assign(n,{height_m:y(e.querySelector(f.wallHeightInput)?.value),wallpaper_code:e.querySelector(f.wallCodeInput)?.value||"",price_per_roll:y(e.querySelector(f.wallPriceRollInput)?.value),install_cost_per_roll:y(e.querySelector(f.wallInstallCostInput)?.value),notes:e.querySelector(f.wallNotesInput)?.value||"",widths:Array.from(e.querySelectorAll(f.wallWidthInput)).map(t=>y(t.value))}):e.matches(f.areaBasedItem)&&(Object.assign(n,{width_m:y(e.querySelector(f.areaWidthInput)?.value),height_m:y(e.querySelector(f.areaHeightInput)?.value),price_sqyd:y(e.querySelector(f.areaPriceSqydInput)?.value),code:e.querySelector(f.areaCodeInput)?.value||"",notes:e.querySelector(f.areaNotesInput)?.value||""}),(r==="partition"||r==="pleated_screen")&&(n.opening_style=e.querySelector('select[name="opening_style"]')?.value||"แยกกลาง"),["wooden_blind","roller_blind","vertical_blind","aluminum_blind"].includes(r)&&(n.adjustment_side=e.querySelector('select[name="adjustment_side"]')?.value||"ปรับขวา")),n}catch(t){return console.error("Failed to extract item data:",t,e),null}}function no(e){if(!e)return;const r=ao(e);if(!r){q("ไม่สามารถคัดลอกรายการได้","error");return}const n=e.closest(f.room);if(!n||!n.getItemsContainer())return;ne(J()),te();let o;if(r.type==="set")o=Be(r);else if(r.type==="wallpaper")o=Ae(r);else if(D[r.type]?.templateId==="#areaBasedTpl")o=Ee(r.type,r);else{q("ไม่รู้จักประเภทรายการ","error");return}if(o){e.after(o),o.classList.add("item-created");const s=e.querySelector(f.itemDetailsMore);s&&s.classList.contains("show")&&Te(o,!0),qe(o),ae(),V(),q("คัดลอกรายการแล้ว","success")}}function so(){const e=document.querySelector(f.orderForm),r=document.querySelector(f.fileImporter),n=document.querySelector("#favImporter"),t=document.querySelector(f.menuDropdown),o=document.querySelector(f.quickNavDropdown),s=document.querySelector(f.menuBtn),a=document.querySelector(f.quickNavBtn);if(e){if(e.addEventListener("item-update",V),e.addEventListener("input",l=>{if(ee){l.preventDefault();return}l.target.closest("#customerInfo")&&X();const c=l.target.closest("input[data-favorite-type]");if(c&&ce(c),l.target.matches(f.roomNameInput)){const i=l.target.closest(".room-card")?.querySelector("[data-room-name-display]");i&&(i.textContent=l.target.value||"ห้อง"),Pe(),$e(),we(X,300)()}l.target.matches('input[name$="_m"], input[name$="price_sqyd"], input[name$="price_roll"], input[name$="install_cost"]')&&V()}),e.addEventListener("change",l=>{if(ee){l.preventDefault();return}l.target.matches("select")&&V()}),e.addEventListener("blur",l=>{const c=l.target;c.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_install_cost"]')?(eo(c),c.name==="wallpaper_install_cost"&&y(c.value)===0?c.value="0":c.value=y(c.value)>0?C(y(c.value)):""):c.matches('input[name$="_m"], input[name^="wall_width_m"]')&&(c.value=ue(c.value)),c.matches('input:not([type="hidden"]), select, textarea')&&X()},!0),e.addEventListener("focusin",l=>{const c=l.target;if(c.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_install_cost"]')&&(c.name==="wallpaper_install_cost"&&c.value==="0"||y(c.value)>0&&(c.value=y(c.value))),c.matches('input:not([type="hidden"]), select, textarea')){const u=document.querySelector(".main-header"),i=document.querySelector(".summary-footer"),p=u?u.offsetHeight+16:80,d=i?i.offsetHeight+16:100,m=window.innerHeight,v=c.getBoundingClientRect();if(v.top<p||v.bottom>m-d){const h=c.closest(".item-card, .room-card");h&&qe(h)}}},!0),e.addEventListener("keydown",l=>{if(ee){l.preventDefault();return}const c=l.target;l.key==="Enter"&&c.matches("input, select")&&!c.closest(".modal-wrapper")&&l.preventDefault()}),document.addEventListener("click",async l=>{l.target.closest(".menu-container")||(t?.classList.remove("show"),s?.setAttribute("aria-expanded","false"),o?.classList.remove("show"),a?.setAttribute("aria-expanded","false")),l.target.closest(".room-options-container")||document.querySelectorAll(".room-options-menu.show").forEach(p=>p.classList.remove("show"));const c=l.target.closest(".summary-tag[data-filter-type]");if(c&&c.closest("#overviewModal")){const p=c.dataset.filterType,d=c.textContent.trim().replace(/\s*\d+\s*$/,""),m=document.querySelector("#overviewModal");m&&typeof m.closeModal=="function"&&m.closeModal({cancelled:!0}),Nt(p,d);return}const u=l.target.closest(".fav-manager-item");if(u){const p=u.closest("#favManagerModal"),d=p?.querySelector(".fav-manager-item.is-selected");d&&d.classList.remove("is-selected"),d!==u?(u.classList.add("is-selected"),G={code:u.dataset.code,price:y(u.dataset.price)}):G=null,p&&(p.querySelector('[data-act="edit-selected-fav"]').disabled=!G,p.querySelector('[data-act="del-selected-fav"]').disabled=!G);return}const i=l.target.closest("[data-act]");if(i){const p=i.dataset.act,d=i.closest(".item-card"),m=i.closest(".room-card"),v=["toggle-more-details","collapse-room","show-discount-modal","show-suspended-items","clear-filter","close-modal","jump-to-item","manage-favorites"];if(ee&&!i.closest(".unlockable")&&!v.includes(p)){q("ฟอร์มถูกล็อคอยู่","warning");return}switch(["toggle-more-details","close-modal","collapse-room"].includes(p)||l.preventDefault(),p!=="close-modal"&&l.stopPropagation(),p){case"show-discount-modal":Rt();break;case"show-suspended-items":De();break;case"clear-filter":lt();break;case"add-room":he();break;case"add-item":if(m){const _=await it("เพิ่มรายการใหม่");_&&Kt(_,m)}break;case"collapse-room":m&&(m.open=!1,setTimeout(()=>{re(),X()},50));break;case"toggle-room-menu":i.nextElementSibling?.classList.toggle("show");break;case"open-room-defaults":m&&(Ht(m),i.closest(".room-options-menu")?.classList.remove("show"));break;case"apply-room-defaults":Gt();break;case"open-force-apply-modal":jt();break;case"force-apply-defaults":Vt();break;case"toggle-suspend-room":m&&(m.classList.toggle("is-suspended"),i.closest(".room-options-menu")?.classList.remove("show"),V(),ye==="suspended"?De():_e());break;case"clear-room":m&&await oe("ล้างข้อมูลในห้อง","?")&&(ne(J()),te(),m.getItemsContainer().innerHTML="",ae(),V(),q("ล้างแล้ว","success"));break;case"del-room":m&&await oe("ลบห้อง","?")&&Re(m,"ลบแล้ว");break;case"del-item":d&&await oe("ลบรายการ","?")&&Re(d,"ลบแล้ว");break;case"duplicate-item":d&&no(d);break;case"toggle-suspend":d&&(d.classList.toggle("is-suspended"),V(),ye==="suspended"?De():_e());break;case"change-type":d&&Xt(d);break;case"toggle-more-details":d&&!d.querySelector(".item-details-more")?.classList.contains("show")&&document.querySelectorAll(".item-details-more.show").forEach(_=>{_.closest(".item-card")!==d&&Te(_.closest(".item-card"),!1)}),Te(d);break;case"open-hardware-modal":R=d,R&&Ot();break;case"apply-hardware-to-room":{const _=i.closest("#hardwareModal"),h=R?.closest(f.room);if(!_||!h||!R)break;const S=R.querySelector('[name="set_style"]');if(S?.value==="ม่านพับ"||S?.value==="หลุยส์"){q("ไม่สามารถใช้กับม่านพับหรือม่านหลุยส์ได้","warning");break}const L=_.querySelector('[name="modal_track_color"]').value,E=_.querySelector('[name="modal_bracket_color"]').value,g=_.querySelector('[name="modal_finial_color"]').value,b=_.querySelector('[name="modal_grommet_color"]').value;h.querySelectorAll('.set-item:not(:has(select[name="set_style"][value="ม่านพับ"])):not(:has(select[name="set_style"][value="หลุยส์"]))').forEach(k=>{k.querySelector('[name="track_color"]').value=L,k.querySelector('[name="bracket_color"]').value=E,k.querySelector('select[name="set_style"]')?.value==="ตาไก่"&&(k.querySelector('[name="finial_color"]').value=g,k.querySelector('[name="grommet_color"]').value=b)}),X(),q("ใช้กับรายการที่เข้ากันได้ในห้องแล้ว","success");break}case"add-wall":{const _=i.closest(".walls-section")?.querySelector("[data-walls-container]");if(_){const h=We();h&&(_.appendChild(h),h.querySelector("input")?.focus(),V())}break}case"del-wall":{const _=i.closest(".wall-input-row");_&&await oe("ลบผนัง","?")&&Re(_,"ลบแล้ว");break}case"show-favorites":{const _=i.closest(".form-group-with-favorites")?.querySelector("input[data-favorite-type]");_&&ro(_);break}case"toggle-favorite":{const h=i.closest(".form-group-with-favorites")?.querySelector("input[data-favorite-type]");if(!h||!d)break;const S=h.dataset.favoriteType,L=h.value;let E=0,g;if(h.name==="fabric_code"?g=d.querySelector('[name="set_price_per_m"]'):h.name==="sheer_fabric_code"?g=d.querySelector('[name="sheer_price_per_m"]'):h.name==="wallpaper_code"?g=d.querySelector('[name="wallpaper_price_roll"]'):h.name==="area_code"&&(g=d.querySelector('[name="area_price_sqyd"]')),E=y(g?.value),!L.trim()){q("โปรดระบุรหัส","warning");break}if(E<0||E<=0&&!["fabric","sheer","wallpaper"].includes(S)&&!(S==="wallpaper"&&g?.name==="wallpaper_install_cost")){if(!Ue(S,L)){q("โปรดระบุราคา","warning");break}E=0}const b=Ie(S,L,E);b!==null&&(i.classList.toggle("is-favorite",b),q(b?"เพิ่มแล้ว":"ลบแล้ว","success"),X());break}case"add-new-fav-form":{const h=i.closest("#favManagerModal")?.dataset.currentType;if(!h)break;const S=document.querySelector("#favAddModal");if(!S)break;let L=D[h]?.name||h;h==="fabric"?L="ผ้าทึบ":h==="sheer"&&(L="ผ้าโปร่ง"),S.querySelector("h3").textContent=`เพิ่ม '${L}'`;const E=S.querySelector('[name="fav_code_add"]'),g=S.querySelector('[name="fav_price_add"]');E.value="",g.value="";const b=await U("#favAddModal");if(b&&!b.cancelled){const k=E.value.trim(),x=y(g.value);k?Ie(h,k,x)!==null?(Me(h),q("เพิ่มแล้ว","success")):q("ล้มเหลว","error"):q("ต้องระบุรหัส","warning")}break}case"edit-selected-fav":{if(!G)break;const h=i.closest("#favManagerModal")?.dataset.currentType;if(!h)break;const S=document.querySelector("#favEditModal");if(!S)break;S.querySelector("h3").textContent=`แก้ไข '${G.code}'`;const L=S.querySelector('[name="fav_code_edit"]'),E=S.querySelector('[name="fav_price_edit"]');L.value=G.code,E.value=G.price!==null&&G.price>=0?G.price:"";const g=await U("#favEditModal");if(g&&!g.cancelled){const b=L.value.trim(),k=y(E.value);b?(b!==G.code&&je(h,G.code),Ie(h,b,k),Me(h),q("แก้ไขรายการโปรดแล้ว","success")):q("ต้องระบุรหัส","warning")}break}case"del-selected-fav":{if(!G)break;const h=i.closest("#favManagerModal")?.dataset.currentType;if(!h)break;await oe("ลบรายการโปรด",`"${G.code}"?`)&&(je(h,G.code)?(Me(h),q("ลบแล้ว","success")):q("ล้มเหลว","error"));break}case"manage-favorites-from-defaults":await Ut();break;case"jump-to-item":to(i);break}}else{const p=l.target.closest("summary");p&&p.closest("details.card")&&setTimeout(()=>{re(),X()},50)}}),document.querySelector("#undoBtn")?.addEventListener("click",l=>{l.preventDefault(),Ft()}),document.querySelector(f.lockBtn)?.addEventListener("click",l=>{l.preventDefault(),Yt()}),document.querySelector(f.toggleAllRoomsBtn)?.addEventListener("click",l=>{l.preventDefault(),Qt()}),a&&o){a.addEventListener("click",c=>{c.stopPropagation(),t?.classList.remove("show");const u=!o.classList.contains("show");o.classList.toggle("show",u),a.setAttribute("aria-expanded",u),u&&s?.setAttribute("aria-expanded","false")}),document.querySelector(f.quickNavRoomList)?.addEventListener("click",c=>{const u=c.target.closest("a[data-jump-to]");if(u){c.preventDefault();const i=u.dataset.jumpTo,p=document.getElementById(i);p&&(p.open=!0,p.scrollIntoView({behavior:"smooth",block:"center"}),p.classList.add("scrolling-jump"),setTimeout(()=>p.classList.remove("scrolling-jump"),2500),setTimeout(re,100)),o.classList.remove("show"),a.setAttribute("aria-expanded","false")}});const l=document.querySelector("#addRoomQuickNavBtn");if(l){const c=yt(he,700);l.addEventListener("click",u=>{u.stopPropagation(),c(),o.classList.remove("show"),a.setAttribute("aria-expanded","false")})}}s&&t&&s.addEventListener("click",l=>{l.stopPropagation(),o?.classList.remove("show");const c=!t.classList.contains("show");t.classList.toggle("show",c),s.setAttribute("aria-expanded",c),c&&a?.setAttribute("aria-expanded","false")}),document.querySelector("#themeToggleBtn")?.addEventListener("click",l=>{l.preventDefault(),Pt(),t?.classList.remove("show"),s?.setAttribute("aria-expanded","false")}),document.querySelector("#overviewBtn")?.addEventListener("click",async l=>{l.preventDefault(),t?.classList.remove("show"),s?.setAttribute("aria-expanded","false");const c=J(),u=document.querySelector("#overviewModalHeader"),i=document.querySelector("#overviewModalBody");if(u&&i){const p=c.rooms.reduce((v,_)=>v+(_.is_suspended?0:(_.items||[]).filter(h=>!h.is_suspended&&(F.calculateSetPrice(h)?.total>0||F.calculateWallpaperPrice(h)?.total>0||F.calculateAreaBasedPrice(h)?.total>0)).length),0),d=document.querySelector(f.grandTotal)?.textContent||"0",m=c.rooms.filter(v=>!v.is_suspended&&v.items?.some(_=>!_.is_suspended)).length;u.innerHTML=`<div class="overview-stats-grid"><div class="overview-stat-card"><i class="ph-bold ph-map-pin-line"></i><div class="stat-value">${m}</div><div class="stat-label">ห้อง</div></div><div class="overview-stat-card"><i class="ph-bold ph-stack"></i><div class="stat-value">${p}</div><div class="stat-label">รายการ</div></div><div class="overview-stat-card"><i class="ph-bold ph-coins"></i><div class="stat-value">${d}</div><div class="stat-label">ยอดรวม</div></div></div>`,i.innerHTML=Ct(c),U("#overviewModal")}}),document.querySelector("#copyTextBtn")?.addEventListener("click",async l=>{l.preventDefault(),t?.classList.remove("show"),s?.setAttribute("aria-expanded","false");const c=document.querySelector(f.copyOptionsModal);if(!c)return;c.querySelector('input[name="copy_option"][value="customer"]').checked=!0;const u=await U(f.copyOptionsModal);if(u&&!u.cancelled){const i=c.querySelector('input[name="copy_option"]:checked').value,p=Lt(J(),i);try{await navigator.clipboard.writeText(p),q("คัดลอกสำเร็จ!","success")}catch{q("คัดลอกล้มเหลว","error")}}}),document.querySelector("#visualReportsBtn")?.addEventListener("click",async l=>{l.preventDefault(),t?.classList.remove("show"),s?.setAttribute("aria-expanded","false");const c=document.querySelector("#visualReportsModal");if(!c)return;c.querySelector('input[name="report_type_option"][value="lookbook"]').checked=!0;const u=await U("#visualReportsModal");if(u&&!u.cancelled){const i=c.querySelector('input[name="report_type_option"]:checked').value;if(i==="lookbook"){const p=J(),d=At(p),m=document.querySelector("#lookbookModalBody");d&&m?(m.innerHTML=d,U("#lookbookModal")):q("ไม่มีข้อมูล","warning")}else q(`'${i}' ยังไม่พร้อม`,"default")}}),document.querySelector(f.exportPdfBtn)?.addEventListener("click",async l=>{l.preventDefault(),t?.classList.remove("show"),s?.setAttribute("aria-expanded","false");const c=await Dt();if(!c)return;const u=J(),i=Bt(u,{vatRate:c.vatOption==="include"?H.baseVatRate:0,pageBreakBuffer:c.pageBreakBuffer,showDetails:c.showDetails});if(!i){q("ไม่มีรายการ","warning");return}c.exportMethod==="html"?Zt(i):zt(i.html,c.exportMethod)}),document.querySelector(f.submitBtn)?.addEventListener("click",async l=>{if(l.preventDefault(),t?.classList.remove("show"),s?.setAttribute("aria-expanded","false"),await oe("ส่งข้อมูล","?")){const c=J();if(!c.customer_name&&!c.customer_phone){q("ใส่ชื่อ/เบอร์","warning");return}q("กำลังส่ง...","default");try{const u=await fetch(ft,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});u.ok?q("ส่งแล้ว!","success"):q(`ล้มเหลว: ${u.status}`,"error")}catch{q("เชื่อมต่อผิดพลาด","error")}}}),document.querySelector(f.importBtn)?.addEventListener("click",l=>{l.preventDefault(),t?.classList.remove("show"),s?.setAttribute("aria-expanded","false"),r?.click()}),r?.addEventListener("change",l=>{const c=l.target.files?.[0];if(!c)return;const u=new FileReader;u.onload=async i=>{try{const p=JSON.parse(i.target.result);if(p&&typeof p=="object")await Je(p,!0);else throw new Error("Invalid JSON")}catch(p){q("ไฟล์ JSON ไม่ถูก","error"),console.error(p)}},u.readAsText(c),l.target.value=null}),document.querySelector(f.exportBtn)?.addEventListener("click",l=>{l.preventDefault(),t?.classList.remove("show"),s?.setAttribute("aria-expanded","false");try{const c=J(),u=JSON.stringify(c,null,4),i=new Blob([u],{type:"application/json"}),p=URL.createObjectURL(i),d=document.createElement("a"),m=new Date,v=`${m.getFullYear()}${(m.getMonth()+1).toString().padStart(2,"0")}${m.getDate().toString().padStart(2,"0")}`,_=`${m.getHours().toString().padStart(2,"0")}${m.getMinutes().toString().padStart(2,"0")}`,h=tt(c.customer_name||"data");d.href=p,d.download=`MTR-${v}${_}-${h}.json`,d.click(),URL.revokeObjectURL(p),q("Export สำเร็จ","success")}catch{q("Export ล้มเหลว","error")}}),document.querySelector("#importFavsBtn")?.addEventListener("click",l=>{l.preventDefault(),t?.classList.remove("show"),s?.setAttribute("aria-expanded","false"),n?.click()}),n?.addEventListener("change",l=>{const c=l.target.files?.[0];if(!c)return;const u=new FileReader;u.onload=i=>{try{const p=JSON.parse(i.target.result),d=He(p);d>0?q(`เพิ่ม ${d} รายการ`,"success"):q("ไม่พบรายการใหม่","default"),document.querySelectorAll("input[data-favorite-type]").forEach(ce)}catch{q("ไฟล์ JSON ไม่ถูก","error")}},u.readAsText(c),l.target.value=null}),document.querySelector("#exportFavsBtn")?.addEventListener("click",l=>{l.preventDefault(),t?.classList.remove("show"),s?.setAttribute("aria-expanded","false");try{const c=se();if(Object.values(c).every(v=>v.length===0)){q("ไม่มีรายการ","warning");return}const u=JSON.stringify(c,null,4),i=new Blob([u],{type:"application/json"}),p=URL.createObjectURL(i),d=document.createElement("a"),m=new Date().toISOString().slice(0,10).replace(/-/g,"");d.href=p,d.download=`MTR-Favorites-${m}.json`,d.click(),URL.revokeObjectURL(p),q("Export สำเร็จ","success")}catch{q("Export ล้มเหลว","error")}}),document.querySelector(f.clearItemsBtn)?.addEventListener("click",async l=>{if(l.preventDefault(),t?.classList.remove("show"),s?.setAttribute("aria-expanded","false"),await oe("ล้างทุกรายการ","?")){ne(J()),te(),document.querySelectorAll(f.room).forEach(i=>{i.getItemsContainer().innerHTML=""});const c=document.querySelector("#discount_type"),u=document.querySelector("#discount_value");c&&(c.value="amount"),u&&(u.value="0"),ae(),V(),q("ล้างแล้ว","success")}}),document.querySelector(f.clearAllBtn)?.addEventListener("click",async l=>{if(l.preventDefault(),t?.classList.remove("show"),s?.setAttribute("aria-expanded","false"),await oe("ลบข้อมูลทั้งหมด","คำเตือน! ข้อมูลทั้งหมดรวมถึงรายการโปรดจะถูกลบถาวร ยืนยันหรือไม่?")){const c=document.querySelector(f.roomsContainer);c&&(c.innerHTML=""),localStorage.removeItem(ve),gt(),q("ลบข้อมูลทั้งหมดแล้ว กำลังรีโหลด...","success"),setTimeout(()=>window.location.reload(),500)}}),document.querySelector("#roomDefaultsConfirmBtn")?.addEventListener("click",Wt),window.addEventListener("click",l=>{l.target.closest(".menu-container")||(t?.classList.remove("show"),o?.classList.remove("show"),s?.setAttribute("aria-expanded","false"),a?.setAttribute("aria-expanded","false")),l.target.closest(".room-options-container")||document.querySelectorAll(".room-options-menu.show").forEach(u=>u.classList.remove("show"));const c=l.target.closest(".item-card");document.querySelectorAll(".item-details-more.show").forEach(u=>{const i=u.closest(".item-card");i!==c&&Te(i,!1)})}),window.addEventListener("beforeunload",X)}}function lo(){const e=document.querySelector(f.setTpl);if(!e)return;const r=e.content.querySelector(f.setPricePerMSelect),n=e.content.querySelector(f.setSheerPricePerMSelect),t=e.content.querySelector(f.setLouisPricePerMSelect),o=s=>{let a='<option value="" hidden>เลือกราคา</option>';return Array.isArray(s)?(s.forEach(l=>{a+=`<option value="${l}">${l.toLocaleString("th-TH")}</option>`}),a):(console.error("Price data for dropdown is not available or not an array.",s),a)};r&&(r.innerHTML=o(ge.fabric)),n&&(n.innerHTML=o(ge.sheer)),t&&(t.innerHTML=o(ge.louis))}function co(){lo(),st(),so();try{const e=localStorage.getItem(ve);if(e&&e!=="null"&&e!=="{}"){const r=JSON.parse(e);if(r&&Array.isArray(r.rooms))Je(r,!1);else{console.warn("Stored data structure seems invalid, starting fresh."),localStorage.removeItem(ve),he();const n=document.querySelector(f.customerCard);n&&(n.open=!0)}}else{he();const r=document.querySelector(f.customerCard);r&&(r.open=!0)}}catch(e){console.error("Failed to load or parse data from localStorage:",e),localStorage.removeItem(ve),he();const r=document.querySelector(f.customerCard);r&&(r.open=!0)}V(),ct(),re(),$e(),te(),console.log("Marnthara App Initialized (Vite Refactor)")}document.addEventListener("DOMContentLoaded",co);
