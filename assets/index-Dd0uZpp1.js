(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function r(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(o){if(o.ep)return;o.ep=!0;const a=r(o);fetch(o.href,a)}})();const We="input-ui/5.7.0",Ue="https://your-make-webhook-url.com/your-unique-path",me="marnthara.input.v5",Ve=500,C={name:"ม่านธารา ผ้าม่านและของตกแต่ง",address:"65/8 หมู่ 2 ต.ท่าศาลา อ.เมือง จ.ลพบุรี 15000",phone:"092-985-9395, 082-552-5595",taxId:"1234567890123",logoUrl:"./assets/logo.png",baseVatRate:.07,pdf:{paymentTerms:"ชำระมัดจำ 50%",priceValidity:"30 วัน",notes:["ราคานี้รวมค่าติดตั้งแล้ว","ชำระมัดจำ 50% เพื่อยืนยันการสั่งผลิตสินค้า","ใบเสนอราคานี้มีอายุ 30 วัน นับจากวันที่เสนอราคา"]}},Ye=1.19599,Se={ROLL_WIDTH_M:.53,ROLL_LENGTH_M:10,STRIPS_PER_ROLL_UNDER_2_5M:3},ve={fabric:[1e3,1100,1200,1300,1400,1500,1600,1700,1800,1900,2e3,2100,2200],sheer:[1e3,1100,1200,1300,1400,1500],style_surcharge:{ลอน:200,ตาไก่:0,จีบ:0},height:[{threshold:3.2,add_per_m:300},{threshold:2.8,add_per_m:200},{threshold:2.5,add_per_m:100}]},f={orderForm:"#orderForm",roomsContainer:"#rooms",setTpl:"#setTpl",wallTpl:"#wallTpl",clearAllBtn:"#clearAllBtn",lockBtn:"#lockBtn",grandTotal:"#grandTotal",modal:"#confirmationModal",modalTitle:"#modalTitle",modalBody:"#modalBody",room:"[data-room]",allItemsContainer:"[data-all-items]",wallsContainer:"[data-walls-container]",sheerWrap:"[data-sheer-wrap]",sheerCodeWrap:"[data-sheer-code-wrap]",roomNameInput:'input[name="room_name"]',toastContainer:"#toast-container",copyTextBtn:"#copyTextBtn",copyOptionsModal:"#copyOptionsModal",menuBtn:"#menuBtn",menuDropdown:"#menuDropdown",importBtn:"#importBtn",exportBtn:"#exportBtn",fileImporter:"#fileImporter",submitBtn:"#submitBtn",clearItemsBtn:"#clearItemsBtn",exportPdfBtn:"#exportPdfBtn",exportOptionsModal:"#exportOptionsModal",printableContent:"#printable-content",quickNavBtn:"#quickNavBtn",quickNavDropdown:"#quickNavDropdown",quickNavRoomList:"#quickNavRoomList",toggleAllRoomsBtn:"#toggleAllRoomsBtn"},_=e=>{typeof e=="string"&&(e=e.replace(/,/g,""));const t=parseFloat(e);return Number.isFinite(t)?t:0},K=e=>{const t=_(e);return t>0?t.toFixed(2):""},R=(e,t=2,r=!1)=>Number.isFinite(e)?e.toLocaleString("en-US",{minimumFractionDigits:r?2:t,maximumFractionDigits:r?2:t}):"0",$=(e,t=0)=>Number.isFinite(e)?e.toLocaleString("th-TH",{minimumFractionDigits:t,maximumFractionDigits:t}):"0",Ge=(e,t=150)=>{let r;return(...n)=>{clearTimeout(r),r=setTimeout(()=>e(...n),t)}},Je=(e,t=700)=>{let r=!1;return(...n)=>{if(!r){r=!0;try{return e(...n)}finally{setTimeout(()=>{r=!1},t)}}}},L=e=>typeof e!="string"?"":e.replace(/[&<>"']/g,function(t){switch(t){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";default:return"&#039;"}}),Fe=e=>typeof e!="string"?"":e.replace(/[\\/?%*:|"<>\x00-\x1f]/g,"").trim()||"file";function Qe(e){let t=_(e);if(isNaN(t))return"ข้อมูลตัวเลขไม่ถูกต้อง";if(t===0)return"ศูนย์บาทถ้วน";const r=["","หนึ่ง","สอง","สาม","สี่","ห้า","หก","เจ็ด","แปด","เก้า"],n=["","สิบ","ร้อย","พัน","หมื่น","แสน","ล้าน"];let o=Math.floor(t),a=Math.round((t-o)*100);const s=i=>{if(i===0)return"";let d="";const p=String(i);for(let u=0;u<p.length;u++){const h=p[u];p.length-1;const m=p.length-u-1;h!=="0"&&(m===1&&h==="1"?d+=n[m]:m===1&&h==="2"?d+="ยี่"+n[m]:m===0&&h==="1"&&p.length>1?d+="เอ็ด":d+=r[parseInt(h)]+n[m])}return d};let l="";if(o>0){const i=Math.floor(o/1e6),d=o%1e6;i>0&&(l+=s(i)+"ล้าน"),l+=s(d),l+="บาท"}let c="";return a>0?c=s(a)+"สตางค์":l+="ถ้วน",(l+c).trim()}const Ie="marnthara.favorites.v4",fe={fabric:[],sheer:[],wallpaper:[],wooden_blind:[],roller_blind:[],vertical_blind:[],partition:[],pleated_screen:[],aluminum_blind:[]};function te(){try{const e=localStorage.getItem(Ie);return e?{...fe,...JSON.parse(e)}:fe}catch(e){return console.error("Failed to parse favorites from localStorage",e),fe}}function Ee(e){try{localStorage.setItem(Ie,JSON.stringify(e))}catch(t){console.error("Failed to save favorites to localStorage",t)}}function Ke(e){if(!e||typeof e!="object")return console.error("Invalid favorites data for import."),!1;const t={...fe,...e};return Ee(t),!0}function ze(e,t,r){const n=te();n[e]||(n[e]=[]);const o=n[e],a=o.find(s=>s.code===t);return a?a.price=r:o.push({code:t,price:r}),o.sort((s,l)=>s.code.localeCompare(l.code)),Ee(n),!0}function $e(e,t){const r=te();if(!r[e])return!1;const n=r[e].findIndex(o=>o.code===t);return n>-1?(r[e].splice(n,1),Ee(r),!0):!1}function Me(e,t){if(!e||!t)return;const r=te(),n=t.trim();return(r[e]||[]).find(a=>a.code===n)}function Xe(e,t){return!!Me(e,t)}function be(e,t,r){const n=Me(e,t);return n&&n.price===r?($e(e,t),!1):(ze(e,t,r),!0)}function Ze(){localStorage.removeItem(Ie),console.log("All favorites have been cleared.")}function H(){var r,n,o,a,s,l;const e=te(),t={app_version:We,customer_name:((r=document.querySelector('[name="customer_name"]'))==null?void 0:r.value)||"",customer_phone:((n=document.querySelector('[name="customer_phone"]'))==null?void 0:n.value)||"",customer_address:((o=document.querySelector('[name="customer_address"]'))==null?void 0:o.value)||"",customer_card_open:(a=document.querySelector("#customerDetailsCard"))==null?void 0:a.open,discount:{type:((s=document.querySelector("#discount_type"))==null?void 0:s.value)||"amount",value:_((l=document.querySelector("#discount_value"))==null?void 0:l.value)},rooms:[],favorites:e};return document.querySelectorAll(f.room).forEach(c=>{var d,p;const i={id:c.id,room_name:((d=c.querySelector(f.roomNameInput))==null?void 0:d.value)||"",is_suspended:c.classList.contains("is-suspended"),is_open:c.open,items:[]};(p=c.querySelector(f.allItemsContainer))==null||p.childNodes.forEach(u=>{var v,y,g,T,b,q,x,E,J,B,A,w,I,M,D,P,U,Q,Z,F,ue;if(u.nodeType!==1||!u.matches(".item-card"))return;const h=u.dataset.type;if(!h)return;let m={type:h,is_suspended:u.classList.contains("is-suspended")};h==="set"?Object.assign(m,{width_m:_((v=u.querySelector('input[name="width_m"]'))==null?void 0:v.value),height_m:_((y=u.querySelector('input[name="height_m"]'))==null?void 0:y.value),style:((g=u.querySelector('select[name="set_style"]'))==null?void 0:g.value)||"",fabric_variant:((T=u.querySelector('select[name="fabric_variant"]'))==null?void 0:T.value)||"",price_per_m_raw:_((b=u.querySelector('select[name="set_price_per_m"]'))==null?void 0:b.value),sheer_price_per_m:_((q=u.querySelector('select[name="sheer_price_per_m"]'))==null?void 0:q.value),fabric_code:((x=u.querySelector('input[name="fabric_code"]'))==null?void 0:x.value)||"",sheer_fabric_code:((E=u.querySelector('input[name="sheer_fabric_code"]'))==null?void 0:E.value)||"",opening_style:((J=u.querySelector('select[name="opening_style"]'))==null?void 0:J.value)||"",track_color:((B=u.querySelector('select[name="track_color"]'))==null?void 0:B.value)||"",notes:((A=u.querySelector('input[name="notes"]'))==null?void 0:A.value)||""}):h==="wallpaper"?Object.assign(m,{height_m:_((w=u.querySelector('[name="wallpaper_height_m"]'))==null?void 0:w.value),wallpaper_code:((I=u.querySelector('[name="wallpaper_code"]'))==null?void 0:I.value)||"",price_per_roll:_((M=u.querySelector('[name="wallpaper_price_roll"]'))==null?void 0:M.value),install_cost_per_roll:_((D=u.querySelector('[name="wallpaper_install_cost"]'))==null?void 0:D.value),notes:((P=u.querySelector('[name="wallpaper_notes"]'))==null?void 0:P.value)||"",widths:Array.from(u.querySelectorAll('[name="wall_width_m"]')).map(je=>_(je.value))}):u.matches(".area-based-item")&&Object.assign(m,{width_m:_((U=u.querySelector('[name="area_width_m"]'))==null?void 0:U.value),height_m:_((Q=u.querySelector('[name="area_height_m"]'))==null?void 0:Q.value),price_sqyd:_((Z=u.querySelector('[name="area_price_sqyd"]'))==null?void 0:Z.value),code:((F=u.querySelector('[name="area_code"]'))==null?void 0:F.value)||"",notes:((ue=u.querySelector('[name="area_notes"]'))==null?void 0:ue.value)||""}),i.items.push(m)}),t.rooms.push(i)}),t}function N(){try{localStorage.setItem(me,JSON.stringify(H()))}catch(e){console.error("Failed to save data to localStorage:",e)}}const k={stylePlus:e=>ve.style_surcharge[e]??0,heightPlus:e=>{const t=[...ve.height].sort((r,n)=>n.threshold-r.threshold);for(const r of t)if(e>r.threshold)return r.add_per_m;return 0},fabricYardage:(e,t)=>{const r=_(t);return r<=0||!e?0:e==="ตาไก่"||e==="จีบ"?(r*2+.6)/.9:e==="ลอน"?(r*2.6+.6)/.9:0},wallpaperRolls:(e,t)=>{const r=_(e),n=_(t);if(r<=0||n<=0)return 0;const o=n>2.5?Math.floor(Se.ROLL_LENGTH_M/n):Se.STRIPS_PER_ROLL_UNDER_2_5M;if(o<=0)return 0;const a=Math.ceil(r/Se.ROLL_WIDTH_M);return Math.ceil(a/o)},calculateSetPrice:function(e){var s,l;if(!e||e.is_suspended||_(e.width_m)<=0)return{total:0,opaque:0,sheer:0};const t=this.stylePlus(e.style),r=this.heightPlus(_(e.height_m)),n=_(e.width_m),o=(s=e.fabric_variant)!=null&&s.includes("ทึบ")&&_(e.price_per_m_raw)>0?(_(e.price_per_m_raw)+t+r)*n:0,a=(l=e.fabric_variant)!=null&&l.includes("โปร่ง")&&_(e.sheer_price_per_m)>0?(_(e.sheer_price_per_m)+t+r)*n:0;return{total:Math.round(o+a),opaque:Math.round(o),sheer:Math.round(a)}},calculateDecoPrice:function(e){if(!e||e.is_suspended||_(e.width_m)<=0||_(e.height_m)<=0)return{total:0,sqm:0,sqyd:0};const t=_(e.width_m)*_(e.height_m),r=t*Ye,n=r*_(e.price_sqyd);return{total:Math.round(n),sqm:t,sqyd:r}},calculateWallpaperPrice:function(e){var s;if(!e||e.is_suspended)return{total:0,material:0,install:0,rolls:0,sqm:0};const t=((s=e.widths)==null?void 0:s.reduce((l,c)=>l+_(c),0))||0;if(t<=0)return{total:0,material:0,install:0,rolls:0,sqm:0};const r=_(e.height_m),n=this.wallpaperRolls(t,r),o=n*_(e.price_per_roll),a=n*_(e.install_cost_per_roll??300);return{total:Math.round(o+a),material:Math.round(o),install:Math.round(a),rolls:n,sqm:t*r}}},se={set:"ผ้าม่าน",wallpaper:"วอลล์เปเปอร์",wooden_blind:"มู่ลี่ไม้",roller_blind:"ม่านม้วน",vertical_blind:"ม่านปรับแสง",partition:"ฉากกั้นห้อง",pleated_screen:"มุ้งจีบ",aluminum_blind:"มู่ลี่อลูมิเนียม"};function et(e){return e.rooms.reduce((t,r)=>{var o;if(r.is_suspended)return t;const n=((o=r.items)==null?void 0:o.reduce((a,s)=>{if(s.is_suspended)return a;switch(s.type){case"set":return a+k.calculateSetPrice(s).total;case"wallpaper":return a+k.calculateWallpaperPrice(s).total;default:return a+k.calculateDecoPrice(s).total}},0))||0;return t+n},0)}function tt(e,t){const r=et(e);let n=0,o="";e.discount&&e.discount.value>0&&(e.discount.type==="percent"?(n=r*(e.discount.value/100),o=`ส่วนลด (${e.discount.value}%): -${$(n)} บาท
`):(n=e.discount.value,o=`ส่วนลด: -${$(n)} บาท
`));const a=r-n;let s=`สรุปข้อมูล (${new Date().toLocaleDateString("th-TH",{day:"numeric",month:"numeric",year:"numeric"})})
`;if(s+=`ลูกค้า: ${e.customer_name||"-"}
`,(t==="customer"||t==="owner")&&(s+=`เบอร์โทร: ${e.customer_phone||"-"}
`,s+=`ที่อยู่: ${e.customer_address||"-"}
`),s+=`------------------------------
`,t==="customer")return s+=`
สรุปรายการ
`,e.rooms.forEach(l=>{if(l.is_suspended||!l.items)return;const c=l.items.filter(d=>d.is_suspended?!1:d.type==="wallpaper"?(d.widths||[]).reduce((p,u)=>p+u,0)>0:d.width_m>0);if(c.length===0)return;s+=`
*ห้อง: ${l.room_name||"ไม่ระบุ"}*
`;let i=0;c.forEach(d=>{i++;const p=se[d.type]||"สินค้าตกแต่ง";d.type==="set"?s+=` ${i}) ${p} ${d.style} (${d.fabric_variant})
`:s+=` ${i}) ${p}
`})}),s+=`------------------------------
`,n>0&&(s+=`
ยอดรวม: ${$(r)} บาท
`,s+=o),s+=`
สรุปยอดสุทธิ: ${$(a)} บาท
`,s+=`
ขอบคุณที่ใช้บริการ
${C.name}
โทร: ${C.phone}`,s;if(t==="purchase_order"||t==="owner"){const l={opaqueFabrics:[],sheerFabrics:[],decorations:{},wallpapers:[],allSets:[]};e.rooms.forEach(p=>{p.is_suspended||!p.items||p.items.forEach(u=>{if(!(u.is_suspended||u.width_m<=0))switch(u.type){case"set":l.allSets.push(u),u.fabric_variant.includes("ทึบ")&&l.opaqueFabrics.push({code:u.fabric_code||"??",yards:k.fabricYardage(u.style,u.width_m)}),u.fabric_variant.includes("โปร่ง")&&l.sheerFabrics.push({code:u.sheer_fabric_code||"??",yards:k.fabricYardage(u.style,u.width_m)});break;case"wallpaper":const h=(u.widths||[]).reduce((v,y)=>v+y,0);if(h>0){const v=k.wallpaperRolls(h,u.height_m);v>0&&l.wallpapers.push({code:u.wallpaper_code||"xxx",rolls:v})}break;default:const m=se[u.type]||u.type;l.decorations[m]||(l.decorations[m]=[]),l.decorations[m].push({code:u.code||"xxx",width:u.width_m,height:u.height_m});break}})}),s+=`📋 *แจกแจงรายการสั่งซื้อ (ผ้า)*
`,s+=`------------------------------
`,l.opaqueFabrics.length>0&&l.opaqueFabrics.forEach(p=>{s+=`- ผ้าทึบ (Curtain Fabric)
`,s+=`  รหัส: #${p.code||"??"}
`,s+=`  จำนวน: ${p.yards.toFixed(2)} หลา

`}),l.sheerFabrics.length>0&&l.sheerFabrics.forEach(p=>{s+=`- ผ้าโปร่ง (Sheer Fabric)
`,s+=`  รหัส: #${p.code||"??"}
`,s+=`  จำนวน: ${p.yards.toFixed(2)} หลา

`});const c={};if([...l.opaqueFabrics,...l.sheerFabrics].forEach(p=>{c[p.code]=(c[p.code]||0)+p.yards}),Object.keys(c).length>0){s+=`------------------------------
`,s+=`📊 *สรุปยอดรวมผ้า (ตามรหัส)*
`,s+=`------------------------------
`;for(const[p,u]of Object.entries(c))s+=`  - รหัส #${p}: รวมทั้งหมด ${u.toFixed(2)} หลา
`;s+=`
`}if(s+=`------------------------------
`,s+=`📋 *สำหรับสั่งซื้อ ราง*
`,s+=`------------------------------

`,l.allSets.length>0){let p=1;l.allSets.forEach(u=>{s+=`(${p++}) รางม่าน: ${u.style}, สี: ${u.track_color}
`,u.fabric_variant.includes("ทึบ")&&(s+=`  - รางทึบ: ${Number(u.width_m).toFixed(2)} ม. (1 เส้น)
`),u.fabric_variant.includes("โปร่ง")&&(s+=`  - รางโปร่ง: ${Number(u.width_m).toFixed(2)} ม. (1 เส้น)
`),u.fabric_variant==="ทึบ&โปร่ง"&&(s+=`  (❗️ต้องใช้ขาสองชั้น)
`),s+=`
`})}const i=l.decorations;Object.keys(i).length>0&&Object.entries(i).forEach(([p,u])=>{s+=`------------------------------
`,s+=`📋 *สำหรับสั่งซื้อ ${p}*
`,s+=`------------------------------

`,u.forEach(h=>{s+=`รหัส: #${h.code||"xxx"}
`,s+=`ขนาด: ${h.width.toFixed(2)} x ${h.height.toFixed(2)} m.
`,s+=`จำนวน: 1 ชุด

`})}),s+=`------------------------------
`,s+=`📋 *แจกแจงรายการสั่งซื้อ (Wallpaper)*
`,s+=`------------------------------

`,l.wallpapers.length>0&&l.wallpapers.forEach(p=>{s+=`- วอลเปเปอร์ -
`,s+=`  รหัส: #${p.code||"xxx"}
`,s+=`  จำนวน: ${p.rolls} ม้วน

`});const d={};if(l.wallpapers.forEach(p=>{d[p.code]=(d[p.code]||0)+p.rolls}),Object.keys(d).length>0){s+=`------------------------------
`,s+=`📊 *สรุปยอดรวมวอลเปเปอร์ (ตามรหัส)*
`,s+=`------------------------------
`;for(const[p,u]of Object.entries(d))s+=`  - รหัส #${p}: รวมทั้งหมด ${u} ม้วน
`;s+=`
`}if(s+=`------------------------------
`,t==="purchase_order")return s}return(t==="seamstress"||t==="owner")&&(s+=`
🧵 *รายละเอียดสำหรับช่าง*
`,e.rooms.forEach(l=>{if(l.is_suspended||!l.items)return;const c=l.items.filter(d=>d.type==="set"&&!d.is_suspended&&d.width_m>0);if(c.length===0)return;s+=`
*ห้อง: ${l.room_name||"ไม่ระบุ"}*
`;let i=1;c.forEach(d=>{s+=`${i++}) *ผ้าม่าน ${d.style} ${d.fabric_variant}*
`,s+=`  กว้าง ${Number(d.width_m).toFixed(2)} x สูง ${Number(d.height_m).toFixed(2)} ม.
`,s+=`  รูปแบบเปิด: ${d.opening_style}
`,d.fabric_variant.includes("ทึบ")&&(s+=`  ผ้าทึบ: รหัส ${d.fabric_code||"-"}
`),d.fabric_variant.includes("โปร่ง")&&(s+=`  ผ้าโปร่ง: รหัส ${d.sheer_fabric_code||"-"}
`)})}),s+=`------------------------------
`,t==="seamstress")||t==="owner"&&(s+=`
💰 *สรุปยอดรวม: ${$(a)} บาท*
`),s}function rt(e){if(!e.rooms||e.rooms.length===0)return'<p class="empty-summary">ไม่มีข้อมูลสำหรับแสดงผล</p>';let t="";const r={};e.rooms.forEach(s=>{s.is_suspended||!s.items||s.items.forEach(l=>{if(l.is_suspended)return;let c=null,i=0;switch(l.type){case"set":i=k.calculateSetPrice(l).total,i>0&&(c=l.type);break;case"wallpaper":i=k.calculateWallpaperPrice(l).total,i>0&&(c=l.type);break;default:i=k.calculateDecoPrice(l).total,i>0&&(c=l.type);break}c&&(r[c]=(r[c]||0)+1)})});const n=Object.entries(r).map(([s,l])=>{const c=se[s]||"ของตกแต่ง";return`
            <span class="summary-tag" data-filter-type="${L(s)}" title="คลิกเพื่อกรองเฉพาะรายการนี้">
                ${L(c)} <strong>${l}</strong>
            </span>`}).join("");n&&(t+=`
            <div class="overview-summary-group">
                <h4><i class="ph ph-stack"></i> สรุปประเภทรายการ</h4>
                <div class="summary-tags-container">
                    ${n}
                </div>
            </div>`);let o="",a=0;return e.rooms.forEach(s=>{if(s.is_suspended||!s.items)return;const l={};let c=0;if(s.items.forEach(i=>{if(i.is_suspended)return;let d=null,p=0;switch(i.type){case"set":p=k.calculateSetPrice(i).total,p>0&&(d=i.type);break;case"wallpaper":p=k.calculateWallpaperPrice(i).total,p>0&&(d=i.type);break;default:p=k.calculateDecoPrice(i).total,p>0&&(d=i.type);break}d&&(l[d]=(l[d]||0)+1,c++)}),c>0){a+=c;const i=Object.entries(l).map(([d,p])=>`
                    <div class="overview-item">
                        <span>${L(se[d]||"ของตกแต่ง")}</span>
                        <span>${p}</span>
                    </div>`).join("");o+=`
                <details class="overview-room-card">
                    <summary class="overview-room-summary">
                        <span class="room-name">${L(s.room_name)||"ไม่ระบุชื่อห้อง"}</span>
                        <div class="summary-tags">
                            <span class="room-item-count">${c} รายการ</span>
                            <i class="ph ph-caret-down expand-icon"></i>
                        </div>
                    </summary>
                    <div class="overview-room-items">${i}</div>
                </details>`}}),o&&(t+=`
            <div class="overview-breakdown-group">
                <h4><i class="ph ph-map-pin-line"></i> แจกแจงตามห้อง</h4>
                ${o}
            </div>`),a===0?'<p class="empty-summary">ไม่มีรายการสำหรับแสดงผล</p>':t}function ot(e,t){const{vatRate:r,pageBreakBuffer:n=3}=t,o=[];e.rooms.forEach(B=>{if(B.is_suspended||!B.items)return;const A=[];B.items.forEach(w=>{if(w.is_suspended)return;let I,M,D,P;const U=se[w.type]||"สินค้าตกแต่ง";switch(w.type){case"set":M=k.calculateSetPrice(w).total,M>0&&(D=w.width_m||0,P=w.height_m||0,I=`${U} ${L(w.style)} (${L(w.fabric_variant)}) <br><small>ขนาด ${D.toFixed(2)} x ${P.toFixed(2)} ม.${w.notes?` - ${L(w.notes)}`:""}</small>`,A.push({description:I,total:M,units:I.includes("<br>")?1.5:1}));break;case"wallpaper":if(M=k.calculateWallpaperPrice(w).total,M>0){const Q=(w.widths||[]).reduce((F,ue)=>F+ue,0),Z=k.wallpaperRolls(Q,w.height_m);P=w.height_m||0,I=`${U} <br><small>รหัส: ${L(w.wallpaper_code)||"-"}, สูง ${P.toFixed(2)} ม. (ใช้ ${Z} ม้วน)</small>`,A.push({description:I,total:M,units:I.includes("<br>")?1.5:1})}break;default:M=k.calculateDecoPrice(w).total,M>0&&(D=w.width_m||0,P=w.height_m||0,I=`${U} <br><small>รหัส: ${L(w.code)||"-"}, ขนาด ${D.toFixed(2)} x ${P.toFixed(2)} ม.</small>`,A.push({description:I,total:M,units:I.includes("<br>")?1.5:1}));break}}),A.length>0&&(o.push({isRoomHeader:!0,roomName:L(B.room_name)||"ไม่ระบุชื่อห้อง",units:1.2}),o.push(...A))});const a=o.reduce((B,A)=>B+(A.total||0),0);if(a===0)return null;let s=0,l="",c=a;e.discount&&e.discount.value>0&&(e.discount.type==="percent"?(s=a*(e.discount.value/100),l=`<tr><td class="pdf-label">ส่วนลด (${e.discount.value}%)</td><td class="pdf-amount">-${R(s,2,!0)}</td></tr>`):(s=e.discount.value,l=`<tr><td class="pdf-label">ส่วนลด</td><td class="pdf-amount">-${R(s,2,!0)}</td></tr>`),c=a-s,l+=`<tr><td class="pdf-label">ยอดหลังหักส่วนลด</td><td class="pdf-amount">${R(c,2,!0)}</td></tr>`);const i=c*r,d=c+i,p=17,u=23,h=[];let m=[],v=0;o.forEach((B,A)=>{const w=h.length===0?p:u,I=v+B.units>w;let M=!1;if(!I&&A<o.length-1){const D=w-(v+B.units);D>0&&D<n&&(M=!0)}(I||M)&&m.length>0&&(h.push(m),m=[],v=0),m.push(B),v+=B.units}),m.length>0&&h.push(m);const y=new Date,g=y.toLocaleDateString("th-TH",{year:"numeric",month:"long",day:"numeric"}),T=`QT-${y.getFullYear()}${(y.getMonth()+1).toString().padStart(2,"0")}${y.getDate().toString().padStart(2,"0")}`;let b="",q=0,x=1;h.forEach((B,A)=>{const w=A===0,I=A===h.length-1,M=`
            <div class="pdf-page-header">
                <div class="pdf-header">
                    <div class="pdf-shop-info">
                        ${`<img src="${C.logoUrl}" alt="Logo" class="pdf-logo">`}
                        <div class="pdf-shop-address">
                            <strong>${L(C.name)}</strong><br>
                            ${L(C.address).replace(/\n/g,"<br>")}<br>
                            โทร: ${L(C.phone)} | เลขประจำตัวผู้เสียภาษี: ${L(C.taxId)}
                        </div>
                    </div>
                    <div class="pdf-quote-details">
                        <div class="pdf-title-box"><h1>ใบเสนอราคา ${h.length>1?w?"":"(ต่อ)":""}</h1></div>
                        <table class="pdf-quote-meta">
                            <tr><td>เลขที่:</td><td>${T}</td></tr>
                            <tr><td>วันที่:</td><td>${g}</td></tr>
                        </table>
                    </div>
                </div>
                ${w?`
                <section class="pdf-customer-details">
                    <div class="pdf-customer-info">
                        <strong>ลูกค้า:</strong> ${L(e.customer_name)||""}<br>
                        <strong>ที่อยู่:</strong> ${L(e.customer_address).replace(/\n/g,"<br>")||""}<br>
                        <strong>โทร:</strong> ${L(e.customer_phone)||""}
                    </div>
                    <div class="pdf-customer-meta">
                        <strong>เงื่อนไขชำระเงิน:</strong> ${L(C.pdf.paymentTerms)}<br>
                        <strong>ยืนราคา:</strong> ${L(C.pdf.priceValidity)}
                    </div>
                </section>`:""}
            </div>`,D=`
            <div class="pdf-page-footer">
                <div class="pdf-footer-info">
                    <span>${L(C.name)} | โทร: ${L(C.phone)}</span>
                    <span>หน้า ${A+1} / ${h.length}</span>
                </div>
            </div>`;let P="";w||(P+=`<tr class="pdf-subtotal-row"><td colspan="4">ยอดยกมา (Brought Forward)</td><td class="pdf-text-right">${R(q,2,!0)}</td></tr>`),B.forEach(F=>{F.isRoomHeader?P+=`<tr class="pdf-room-header"><td colspan="5">ห้อง: ${F.roomName}</td></tr>`:(P+=`<tr><td class="pdf-text-center">${x++}</td><td>${F.description}</td><td class="pdf-text-center">1</td><td class="pdf-text-right">${R(F.total,2,!0)}</td><td class="pdf-text-right">${R(F.total,2,!0)}</td></tr>`,q+=F.total)});let U="";I||(U=`<tfoot><tr class="pdf-subtotal-row"><td colspan="4">ยอดยกไป (Carried Forward)</td><td class="pdf-text-right">${R(q,2,!0)}</td></tr></tfoot>`);let Q="";C.pdf.notes&&C.pdf.notes.length>0&&(Q=`
                <strong>หมายเหตุ:</strong>
                <ul>${C.pdf.notes.map(F=>`<li>${L(F)}</li>`).join("")}</ul>
            `);const Z=I?`
            <div class="pdf-summary-wrapper">
                <section class="pdf-summary-section">
                    <div class="pdf-amount-in-words">
                        ${Q}
                        <div class="pdf-amount-text">( ${Qe(d)} )</div>
                    </div>
                    <div class="pdf-totals-block">
                        <table>
                            <tr><td class="pdf-label">รวมเป็นเงิน</td><td class="pdf-amount">${R(a,2,!0)}</td></tr>
                            ${l}
                            ${r>0?`<tr><td class="pdf-label">ภาษีมูลค่าเพิ่ม ${(r*100).toFixed(0)}%</td><td class="pdf-amount">${R(i,2,!0)}</td></tr>`:""}
                            <tr class="pdf-grand-total"><td class="pdf-label">ยอดรวมสุทธิ</td><td class="pdf-amount">${R(d,2,!0)}</td></tr>
                        </table>
                    </div>
                </section>
                <footer class="pdf-footer-section">
                    <div class="pdf-signature-box"><p>.................................................</p><p>ผู้เสนอราคา</p><p>(${L(C.name)})</p><p>วันที่: ${g}</p></div>
                    <div class="pdf-signature-box"><p>.................................................</p><p>ลูกค้า / ผู้มีอำนาจลงนาม</p><p>&nbsp;</p><p>วันที่: ......./......./............</p></div>
                </footer>
            </div>
        `:"";b+=`
            <div class="pdf-page">
                <div class="pdf-page-content">
                    ${M}
                    <div class="pdf-page-body">
                        <table class="pdf-items-table">
                            <thead><tr><th style="width:5%;">ลำดับ</th><th style="width:50%;">รายการ</th><th style="width:10%;">จำนวน</th><th style="width:17.5%;">ราคา/หน่วย</th><th style="width:17.5%;">รวม (บาท)</th></tr></thead>
                            <tbody>${P}</tbody>
                            ${U}
                        </table>
                        ${Z}
                    </div>
                    ${D}
                </div>
            </div>`});const E=e.customer_name||"quote",J=Fe(E);return{html:`<div id="quotation-template">${b}</div>`,fileName:`${T}_${J}`}}const oe=[],nt=10;function z(e){oe.push(e),oe.length>nt&&oe.shift()}function at(){return oe.pop()}function st(){return oe.length>0}let W=!1,ye=null,de=null,ne=!1,O=null,we=null,qe=!1;const Ce=document.querySelector("#undoBtn"),pe={};function lt(e){if(pe[e])return pe[e];const t=new Promise((r,n)=>{const o=document.createElement("script");o.src=e,o.onload=()=>{console.log(`${e} loaded successfully.`),r()},o.onerror=()=>{console.error(`Script load error for ${e}`),delete pe[e],n(new Error(`Script load error for ${e}`))},document.head.appendChild(o)});return pe[e]=t,t}const le={set:{templateId:"#setTpl",name:"ผ้าม่าน"},wallpaper:{templateId:"#wallpaperTpl",name:"วอลล์เปเปอร์"},wooden_blind:{templateId:"#areaBasedTpl",name:"มู่ลี่ไม้"},roller_blind:{templateId:"#areaBasedTpl",name:"ม่านม้วน"},vertical_blind:{templateId:"#areaBasedTpl",name:"ม่านปรับแสง"},partition:{templateId:"#areaBasedTpl",name:"ฉากกั้นห้อง"},pleated_screen:{templateId:"#areaBasedTpl",name:"มุ้งจีบ"},aluminum_blind:{templateId:"#areaBasedTpl",name:"มู่ลี่อลูมิเนียม"}},ct={มู่ลี่ไม้:"wooden_blind",ม่านม้วน:"roller_blind",ม่านปรับแสง:"vertical_blind",ฉากกั้นห้อง:"partition",มุ้งจีบ:"pleated_screen",มู่ลี่อลูมิเนียม:"aluminum_blind"},Te="marnthara.theme";function Re(){const e=localStorage.getItem(Te),t=document.querySelector("#themeToggleBtn");if(!t)return;const r=t.querySelector("i"),n=t.querySelector("span");switch(document.body.classList.remove("dark-theme","neutral-theme"),e){case"dark":document.body.classList.add("dark-theme"),r&&(r.className="ph-fill ph-sun"),n&&(n.textContent=" สว่าง");break;case"neutral":document.body.classList.add("neutral-theme"),r&&(r.className="ph-fill ph-moon"),n&&(n.textContent=" มืด");break;default:r&&(r.className="ph-fill ph-palette"),n&&(n.textContent=" กลาง");break}}function it(){const e=localStorage.getItem(Te);let t;!e||e==="light"?t="neutral":e==="neutral"?t="dark":t="light",localStorage.setItem(Te,t),Re()}function Y(){Ce&&(Ce.disabled=!st())}function ut(){const e=at();e&&(xe(e),S("ยกเลิกการกระทำล่าสุดแล้ว","success")),Y()}function dt(e,t){if(!e)return;const r=document.getElementById("filterStatusBar");r&&(r.innerHTML=`
            <span>แสดงผลเฉพาะ: <strong>${L(t)}</strong></span>
            <button type="button" class="btn-chip" data-act="clear-filter" title="ยกเลิกการกรอง">
                <i class="ph ph-x"></i>&nbsp;ปิด
            </button>
        `,r.classList.add("is-visible"),r.dataset.filterType=e),document.querySelectorAll(f.room).forEach(n=>{let o=0;n.querySelectorAll(".item-card").forEach(a=>{const s=a.dataset.type===e;a.classList.toggle("item-hidden",!s),s&&o++}),n.classList.toggle("item-hidden",o===0)}),X(),V()}function pt(){const e=document.getElementById("filterStatusBar");e&&(e.classList.remove("is-visible"),e.innerHTML="",e.removeAttribute("data-filter-type")),document.querySelectorAll(".item-hidden").forEach(t=>t.classList.remove("item-hidden")),X(),V()}function _e(){document.querySelectorAll(".favorite-chips-container.show").forEach(e=>{e.classList.remove("show")}),document.querySelectorAll(".item-card.overflow-visible").forEach(e=>{e.classList.remove("overflow-visible")})}function Oe(e){var c;const t=e.dataset.favoriteType,r=(c=e.closest(".form-group-with-favorites"))==null?void 0:c.querySelector(".favorite-chips-container");if(!t||!r)return;_e();const n=e.closest(".item-card"),a=te()[t]||[];let l=Array.from(a.reduce((i,d)=>{const p=d.code.trim();return p&&!i.has(p.toLowerCase())&&i.set(p.toLowerCase(),d),i},new Map).values()).map(i=>`<button type="button" class="btn-chip" data-code="${L(i.code)}" data-price="${i.price}">${L(i.code)}</button>`).join("");l+=`<button type="button" class="btn-manage-favorites" data-act="manage-favorites" data-type="${t}"><i class="ph ph-pencil-simple"></i> จัดการรายการโปรด</button>`,r.innerHTML=l,r.classList.add("show"),n&&n.classList.add("overflow-visible")}function mt(e){const t=e.closest(".form-group-with-favorites"),r=e.closest(".item-card");if(!t||!r)return;const n=e.dataset.code,o=_(e.dataset.price),a=t.querySelector("input[data-favorite-type]");a&&(a.value=n,a.classList.add("input-highlight"),setTimeout(()=>a.classList.remove("input-highlight"),1200));const s=a.dataset.favoriteType;let l;s==="fabric"?l="set_price_per_m":s==="sheer"?l="sheer_price_per_m":s==="wallpaper"?l="wallpaper_price_roll":l="area_price_sqyd";const c=r.querySelector(`[name="${l}"]`);c&&o>0&&(c.tagName==="SELECT"?c.value=o:c.value=$(o),c.classList.add("input-highlight"),setTimeout(()=>c.classList.remove("input-highlight"),1200)),ge(a),ee(r),N(),_e()}function he(e){const t=document.querySelector("#favManagerBody"),r=document.querySelector("#favManagerItemTpl"),o=te()[e]||[];!t||!r||(o.length===0?t.innerHTML='<p class="empty-state">ไม่มีรายการโปรดที่บันทึกไว้</p>':t.innerHTML=o.map(a=>r.innerHTML.replace(/{CODE}/g,L(a.code)).replace(/{PRICE}/g,$(a.price)).replace(/{RAW_PRICE}/g,a.price)).join(""),ke(null))}function ke(e){const t=document.querySelector('[data-act="edit-selected-fav"]'),r=document.querySelector('[data-act="del-selected-fav"]');!t||!r||(e?(t.disabled=!1,r.disabled=!1,O={code:e.dataset.code,price:_(e.dataset.price)}):(t.disabled=!0,r.disabled=!0,O=null))}async function ft(e){const t=document.querySelector("#favManagerModal");if(!t||!e)return;const r={fabric:"ผ้าทึบ",sheer:"ผ้าโปร่ง",wallpaper:"วอลล์เปเปอร์",wooden_blind:"มู่ลี่ไม้",roller_blind:"ม่านม้วน",vertical_blind:"ม่านปรับแสง",partition:"ฉากกั้นห้อง",pleated_screen:"มุ้งจีบ",aluminum_blind:"มู่ลี่อลูมิเนียม",deco:"ของตกแต่ง"};t.dataset.currentType=e,ne=!1,O=null,document.querySelector("#favManagerTitle").textContent=`จัดการ '${r[e]||e}'`,he(e),await G("#favManagerModal",()=>{ne&&ye&&Oe(ye)})}function S(e,t="default"){const r=document.querySelector(f.toastContainer);if(!r)return;const n={success:"ph-bold ph-check-circle",warning:"ph-bold ph-warning",error:"ph-bold ph-x-circle",default:"ph-bold ph-info"},o=document.createElement("div");o.className=`toast toast-${t}`,o.innerHTML=`<i class="${n[t]||n.default}"></i> ${e}`,r.appendChild(o),setTimeout(()=>o.classList.add("show"),10),setTimeout(()=>{o.classList.remove("show"),o.addEventListener("transitionend",()=>o.remove())},3e3)}function G(e,t){return new Promise(r=>{const n=document.querySelector(e);if(!n){r(null);return}const o=document.querySelector(".modal-wrapper.visible");o&&o.classList.add("is-underlay"),n.classList.add("visible");const a=n.querySelector('[id$="Confirm"]'),s=n.querySelector('[id$="Cancel"], [data-act="close-modal"]'),l=Array.from(n.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])')).filter(u=>!u.disabled&&u.offsetParent!==null),c=l[0],i=l[l.length-1];setTimeout(()=>c==null?void 0:c.focus(),50);const d=u=>{if(u.key==="Escape"&&!n.classList.contains("is-underlay")){p({cancelled:!0});return}if(u.key==="Tab"){if(l.length<=1){u.preventDefault();return}u.shiftKey?document.activeElement===c&&(i.focus(),u.preventDefault()):document.activeElement===i&&(c.focus(),u.preventDefault())}},p=u=>{n.classList.remove("visible"),document.removeEventListener("keydown",d),a&&(a.onclick=null),s&&(s.onclick=null),o&&o.classList.remove("is-underlay"),typeof u=="object"&&u.cancelled&&t&&t(),r(u)};a&&(a.onclick=()=>p(!0)),s&&(s.onclick=()=>{n.classList.contains("is-underlay")||p({cancelled:!0})}),document.addEventListener("keydown",d)})}async function ae(e,t){const r=document.querySelector(f.modal);return r?(r.querySelector(f.modalTitle).textContent=e,r.querySelector(f.modalBody).textContent=t,await G(f.modal)===!0):!0}async function ht(){var r,n,o;const e=document.querySelector(f.exportOptionsModal);if(!e)return null;const t=await G(f.exportOptionsModal);return!t||t.cancelled?null:{vatOption:((r=e.querySelector('input[name="vat_option"]:checked'))==null?void 0:r.value)||"include",exportMethod:((n=e.querySelector("#exportMethod"))==null?void 0:n.value)||"direct",pageBreakBuffer:parseInt((o=e.querySelector("#pageBreakBuffer"))==null?void 0:o.value,10)||3}}async function vt(){const e=document.querySelector("#discountModal");if(!e)return;const t=e.querySelector("#discountSubtotal"),r=e.querySelector("#discountPercent"),n=e.querySelector("#discountAmount"),o=e.querySelector("#discountFinalTotal"),a=document.querySelector("#discount_type"),s=document.querySelector("#discount_value"),l=_(document.querySelector("#originalTotal").dataset.rawTotal||document.querySelector("#grandTotal").textContent);t.textContent=$(l);const c=u=>{if(qe)return;qe=!0;let h=0;if(u==="percent"){const m=_(r.value);h=l*((m>=0?m:0)/100),n.value=h>0?$(Math.round(h)):""}else h=_(n.value);if(h=h>=0?Math.min(h,l):0,u!=="percent"){const m=l>0?h/l*100:0;r.value=m>0&&isFinite(m)?R(m,2):""}o.textContent=$(l-h),setTimeout(()=>{qe=!1},20)};r.addEventListener("input",()=>c("percent")),n.addEventListener("input",()=>c("amount")),n.addEventListener("focus",u=>{_(u.target.value)>0&&(u.target.value=_(u.target.value))}),n.addEventListener("blur",u=>{_(u.target.value)>0&&(u.target.value=$(_(u.target.value))),c("amount")});const i=a.value,d=_(s.value);r.value="",n.value="",d>0?i==="percent"?(r.value=d,c("percent")):(n.value=$(d),c("amount")):c();const p=await G("#discountModal");if(p&&!p.cancelled){const u=_(r.value),h=_(n.value);document.activeElement===r&&u>0?(a.value="percent",s.value=u):h>0?(a.value="amount",s.value=h):(a.value="amount",s.value=0),j(),N()}}function Le(e,t,r){e&&(z(H()),Y(),e.classList.add("item-removing"),e.addEventListener("animationend",()=>{e.remove(),t&&S(t),r&&r(),ce(),X(),j(),N(),ie()},{once:!0}))}function X(){document.querySelectorAll(f.room).forEach(e=>{const t=e.querySelectorAll(".item-card:not(.is-suspended):not(.item-hidden)"),r=t.length;t.forEach((o,a)=>{const s=o.querySelector("[data-item-title]");s&&(s.textContent=`${a+1}/${r}`)}),e.querySelectorAll(".item-card.is-suspended, .item-card.item-hidden").forEach(o=>{const a=o.querySelector("[data-item-title]");a&&(a.textContent="-")})})}function He(){const e=document.querySelector(f.orderForm),t=document.querySelector(f.lockBtn);!e||!t||(e.classList.toggle("is-locked",W),t.classList.toggle("is-locked",W),t.querySelector("i").className=W?"ph-bold ph-lock-key":"ph-bold ph-lock-key-open",e.querySelectorAll("input, select, textarea, button").forEach(r=>{r.closest(".summary-footer")||r.closest(".main-header")||r.closest(".modal-wrapper")||r.dataset.act==="toggle-more-details"||r.dataset.act==="collapse-room"||(r.disabled=W)}),S(W?"ฟอร์มถูกล็อค":"ปลดล็อคฟอร์มแล้ว",W?"warning":"success"))}function V(){const e=document.querySelectorAll(f.room);if(e.length===0)return;const t=[...e].some(n=>n.open),r=document.querySelector(f.toggleAllRoomsBtn);r&&(r.querySelector("i").className="ph ph-rows",r.querySelector("span").textContent=t?"ย่อ":"ขยาย")}function yt(){const e=document.querySelectorAll(f.room),t=[...e].some(r=>r.open);e.forEach(r=>{r.open=!t}),setTimeout(()=>{V(),N()},50)}function ce(){const e=document.querySelector(f.quickNavRoomList);e&&(e.innerHTML="",document.querySelectorAll(f.room).forEach(t=>{var o;const r=((o=t.querySelector(f.roomNameInput))==null?void 0:o.value)||"ห้อง",n=document.createElement("a");n.href=`#${t.id}`,n.dataset.jumpTo=t.id,n.innerHTML=`<i class="ph ph-arrow-bend-left-up"></i> ${r}`,e.appendChild(n)}))}function De(e){var r;const t=document.getElementById("quickNavBtnText");t&&(e?t.textContent=((r=e.querySelector('input[name="room_name"]'))==null?void 0:r.value)||"...":t.textContent="ไปยังห้อง")}function ie(){if(de&&de.disconnect(),!document.getElementById("quickNavBtnText"))return;const e={root:null,rootMargin:"-60px 0px -150px 0px",threshold:0},t=r=>{const n=r.filter(o=>o.isIntersecting).sort((o,a)=>o.target.getBoundingClientRect().top-a.target.getBoundingClientRect().top);n.length>0&&De(n[0].target)};de=new IntersectionObserver(t,e),document.querySelectorAll(f.room).forEach(r=>de.observe(r))}function ge(e){if(!e)return;const t=e.closest(".form-group-with-favorites").querySelector(".btn-favorite");if(!t)return;const r=e.dataset.favoriteType,n=e.value;t.classList.toggle("is-favorite",Xe(r,n))}function Be(e,t){const r=le[e];if(!r)return null;const n=document.querySelector(r.templateId);if(!n||!t)return null;const o=n.content.cloneNode(!0),a=o.firstElementChild;a.dataset.type=e,a.classList.add(`${e.replace(/_/g,"-")}-item`);const s=a.querySelector(".item-type-display");if(s&&(s.textContent=r.name),r.templateId==="#areaBasedTpl"){const l=a.querySelector("input[data-favorite-type]");l&&(l.dataset.favoriteType=e)}return t.appendChild(o),a}function _t(e,t){var o;if(!t)return;const r=t.querySelector(f.allItemsContainer);if(!r)return;z(H()),Y(),_e();const n=Be(e,r);if(n){if(e==="wallpaper"){const a=Ae(n.querySelector('[data-act="add-wall"]'));a&&((o=a.querySelector("input"))==null||o.focus())}else{const a=n.querySelector('input:not([type="hidden"]), select, textarea');a&&a.focus()}n.classList.add("item-created"),n.scrollIntoView({behavior:"smooth",block:"center"}),X(),j(),N()}}async function Ne(e,t=null){const r=document.querySelector("#itemTypeModal");if(!r)return null;r.querySelector("#itemTypeModalTitle").textContent=e;let n=t;t&&!le[t]&&(n="wooden_blind");const o=r.querySelector(`input[name="item_type_option"][value="${n||"set"}"]`);o&&(o.checked=!0);const a=await G("#itemTypeModal");if(!a||a.cancelled)return null;const s=r.querySelector('input[name="item_type_option"]:checked');return s?s.value:null}function gt(e,t){if(!le[t])return;const n=e.parentElement;n&&(z(H()),Y(),e.classList.add("item-removing"),e.addEventListener("animationend",()=>{var a;const o=Be(t,n);o&&(e.replaceWith(o),o.classList.add("item-created"),o.scrollIntoView({behavior:"smooth",block:"center"}),(a=o.querySelector('input:not([type="hidden"]), select, textarea'))==null||a.focus(),X(),j(),N(),S("เปลี่ยนประเภทรายการแล้ว","success"))},{once:!0}))}function re(){z(H()),Y();const e=document.querySelector(f.roomsContainer);if(!e)return;const t=document.querySelector("#roomTpl");if(!t)return;const r=Array.from(document.querySelectorAll(f.roomNameInput)).map(c=>parseInt(c.value.replace(/[^0-9]/g,""),10)).filter(c=>!isNaN(c)),a=`ห้อง ${(r.length>0?Math.max(...r):0)+1}`,l=t.content.cloneNode(!0).firstElementChild;if(l){l.id=`room-${Date.now()}`;const c=l.querySelector('input[name="room_name"]'),i=l.querySelector(".room-header-controls .form-group > label");if(c&&i){const p=`room_name_${l.id}`;c.id=p,i.setAttribute("for",p)}c&&(c.value=a);const d=l.querySelector("[data-room-name-display]");d&&(d.textContent=a),l.open=!0,e.appendChild(l),l.classList.add("item-created"),l.scrollIntoView({behavior:"smooth",block:"center"})}ce(),V(),ie(),N()}function Ae(e){var r;const t=(r=e==null?void 0:e.closest(".walls-section"))==null?void 0:r.querySelector(f.wallsContainer);if(t){const n=document.querySelector(f.wallTpl);if(!n)return null;const o=n.content.cloneNode(!0),a=o.querySelector(".wall-input-row");if(!a)return null;const s=a.querySelector("input"),l=a.querySelector("label");if(s&&l){const c=`wall-input-${Date.now()}-${Math.random().toString(36).substring(2,7)}`;s.id=c,l.setAttribute("for",c)}return t.appendChild(o),requestAnimationFrame(()=>{a.classList.add("item-created")}),ee(e),a}return null}function ee(e){var s,l,c,i,d,p,u,h,m,v,y,g;if(!e)return;const t=e.closest(".item-card");if(!t){j();return}const r=t.dataset.type;let n,o,a;switch(r){case"set":n=t.querySelector("[data-set-summary]"),o={width_m:(s=t.querySelector('input[name="width_m"]'))==null?void 0:s.value,height_m:(l=t.querySelector('input[name="height_m"]'))==null?void 0:l.value,style:(c=t.querySelector('select[name="set_style"]'))==null?void 0:c.value,fabric_variant:(i=t.querySelector('select[name="fabric_variant"]'))==null?void 0:i.value,price_per_m_raw:(d=t.querySelector('select[name="set_price_per_m"]'))==null?void 0:d.value,sheer_price_per_m:(p=t.querySelector('select[name="sheer_price_per_m"]'))==null?void 0:p.value},a=k.calculateSetPrice(o),t.dataset.totalPrice=a.total;let T=`ราคา: <b>${$(a.total)}</b> บ.`;a.opaque>0&&a.sheer>0&&(T+=` <small>(ทึบ: ${$(a.opaque)}, โปร่ง: ${$(a.sheer)})</small>`),n&&(n.innerHTML=T);break;case"wallpaper":n=t.querySelector("[data-wallpaper-summary]"),o={height_m:(u=t.querySelector('input[name="wallpaper_height_m"]'))==null?void 0:u.value,price_per_roll:(h=t.querySelector('input[name="wallpaper_price_roll"]'))==null?void 0:h.value,install_cost_per_roll:(m=t.querySelector('input[name="wallpaper_install_cost"]'))==null?void 0:m.value,widths:Array.from(t.querySelectorAll('input[name="wall_width_m"]')).map(x=>x.value)},a=k.calculateWallpaperPrice(o),t.dataset.totalPrice=a.total;let b=`รวม: <b>${$(a.total)}</b> บ. `;(a.material>0||a.install>0)&&(b+=`<small>(วอลล์: ${$(a.material)}, ค่าช่าง: ${$(a.install)})</small>`),a.rolls>0&&(b+=` &bull; พื้นที่: ${R(a.sqm,2)} ตร.ม. &bull; ใช้: ${a.rolls} ม้วน`),n&&(n.innerHTML=b);break;default:n=t.querySelector("[data-area-summary]"),o={width_m:(v=t.querySelector('input[name="area_width_m"]'))==null?void 0:v.value,height_m:(y=t.querySelector('input[name="area_height_m"]'))==null?void 0:y.value,price_sqyd:(g=t.querySelector('input[name="area_price_sqyd"]'))==null?void 0:g.value},a=k.calculateDecoPrice(o),t.dataset.totalPrice=a.total;let q="";a.sqyd>0&&(q=` &bull; พื้นที่: ${R(a.sqyd,2)} ตร.หลา`),n&&(n.innerHTML=`ราคา: <b>${$(a.total)}</b> บ.${q}`);break}j()}function j(){let e=0;document.querySelectorAll(f.room).forEach(s=>{let l=0,c=0;const i=s.classList.contains("is-suspended");s.querySelectorAll(".item-card").forEach(p=>{const u=_(p.dataset.totalPrice),h=p.classList.contains("is-suspended");!i&&!h&&(l+=u,u>0&&c++)});const d=s.querySelector("[data-room-brief]");d&&(i?d.textContent="(ระงับชั่วคราว)":c>0?d.innerHTML=`<span>${c}</span> &bull; ${$(l)} บาท`:d.innerHTML="<span>0</span> รายการ"),i||(e+=l)});const t=document.querySelector("#discount_type").value,r=_(document.querySelector("#discount_value").value);let n=0;r>0&&(n=t==="percent"?e*(r/100):r);const o=e-n;document.querySelector("#grandTotal").textContent=$(o);const a=document.querySelector("#originalTotal");n>0?(a.textContent=$(e),a.dataset.rawTotal=e,a.style.display="block"):(a.style.display="none",a.dataset.rawTotal="")}function xe(e){if(e!=null&&e.favorites&&(Ke(e.favorites)?S("นำเข้ารายการโปรดสำเร็จ","success"):S("ข้อมูลรายการโปรดในไฟล์ไม่ถูกต้อง","warning")),!(e!=null&&e.rooms)||!Array.isArray(e.rooms)){e.favorites||S("ไม่พบข้อมูลสำหรับนำเข้าในไฟล์","error");return}const t=document.querySelector(f.roomsContainer);if(!t)return;t.innerHTML="",document.querySelector("#customer_name").value=e.customer_name||"",document.querySelector("#customer_phone").value=e.customer_phone||"",document.querySelector("#customer_address").value=e.customer_address||"",e.discount&&(document.querySelector("#discount_type").value=e.discount.type||"amount",document.querySelector("#discount_value").value=e.discount.value||0),document.querySelector("#customerDetailsCard").open=e.customer_card_open??!0;let r=0;const n=()=>{if(r>=e.rooms.length){document.querySelectorAll("input[data-favorite-type]").forEach(ge),j(),X(),ce(),V(),ie(),S("นำเข้าข้อมูลฟอร์มสำเร็จ","success");return}const o=e.rooms[r],a=document.querySelector("#roomTpl");if(!a){console.error("Room template not found.");return}const l=a.content.cloneNode(!0).firstElementChild;if(t.appendChild(l),l){l.id=o.id||`room-${Date.now()}`,o.is_suspended&&l.classList.add("is-suspended"),l.open=o.is_open===!0;const c=o.room_name||"ห้อง (ไม่มีชื่อ)",i=l.querySelector('input[name="room_name"]'),d=l.querySelector(".room-header-controls .form-group > label");if(i&&d){const h=`room_name_${l.id}`;i.id=h,d.setAttribute("for",h)}i&&(i.value=c);const p=l.querySelector("[data-room-name-display]");p&&(p.textContent=c);const u=l.querySelector(f.allItemsContainer);if(u&&o.items){const h=document.createDocumentFragment();o.items.forEach(m=>{var y,g,T;m.type==="deco"&&m.deco_type?(m.type=ct[m.deco_type]||"wooden_blind",m.code=m.deco_code,m.width_m=m.deco_width_m,m.height_m=m.deco_height_m,m.price_sqyd=m.deco_price_sqyd,m.notes=m.deco_notes):m.type==="deco"&&(m.type="wooden_blind",m.code=m.deco_code);const v=Be(m.type,h);if(v){switch(m.is_suspended&&v.classList.add("is-suspended"),m.type){case"set":v.querySelector('input[name="width_m"]').value=K(m.width_m),v.querySelector('input[name="height_m"]').value=K(m.height_m),v.querySelector('select[name="set_style"]').value=m.style||m.set_style||"ลอน",v.querySelector('select[name="fabric_variant"]').value=m.fabric_variant||"ทึบ",v.querySelector('select[name="set_price_per_m"]').value=m.price_per_m_raw||m.set_price_per_m||"",v.querySelector('select[name="sheer_price_per_m"]').value=m.sheer_price_per_m||"",v.querySelector('select[name="opening_style"]').value=m.opening_style||"แยกกลาง",v.querySelector('select[name="track_color"]').value=m.track_color||"ขาว",v.querySelector('input[name="fabric_code"]').value=m.fabric_code||"",v.querySelector('input[name="sheer_fabric_code"]').value=m.sheer_fabric_code||"",v.querySelector('input[name="notes"]').value=m.notes||"";const b=(m.fabric_variant||"").includes("โปร่ง");(y=v.querySelector(f.sheerWrap))==null||y.classList.toggle("hidden",!b),(g=v.querySelector(f.sheerCodeWrap))==null||g.classList.toggle("hidden",!b);break;case"wallpaper":v.querySelector('input[name="wallpaper_height_m"]').value=K(m.height_m||m.wallpaper_height_m),v.querySelector('input[name="wallpaper_code"]').value=m.wallpaper_code||"";const q=_(m.price_per_roll||m.wallpaper_price_roll);v.querySelector('input[name="wallpaper_price_roll"]').value=q>0?$(q):"",v.querySelector('input[name="wallpaper_install_cost"]').value=m.hasOwnProperty("install_cost_per_roll")?$(m.install_cost_per_roll):m.wallpaper_install_cost?$(m.wallpaper_install_cost):"300",v.querySelector('input[name="wallpaper_notes"]').value=m.notes||m.wallpaper_notes||"",m.widths&&m.widths.forEach(x=>{const E=Ae(v.querySelector('[data-act="add-wall"]'));E&&(E.querySelector('input[name="wall_width_m"]').value=K(x))});break;default:if(((T=le[m.type])==null?void 0:T.templateId)==="#areaBasedTpl"){v.querySelector('input[name="area_width_m"]').value=K(m.width_m),v.querySelector('input[name="area_height_m"]').value=K(m.height_m);const x=_(m.price_sqyd);v.querySelector('input[name="area_price_sqyd"]').value=x>0?$(x):"",v.querySelector('input[name="area_code"]').value=m.code||"",v.querySelector('input[name="area_notes"]').value=m.notes||""}break}ee(v)}}),u.appendChild(h)}}r++,requestAnimationFrame(n)};requestAnimationFrame(n)}function St(e){if(document.getElementById("loading-overlay"))return;const t=document.createElement("div");t.id="loading-overlay",t.innerHTML=`<div class="loading-spinner"></div><p>${e}</p>`,document.body.appendChild(t),document.body.style.overflow="hidden"}function bt(){const e=document.getElementById("loading-overlay");e&&e.remove(),document.body.style.overflow=""}async function wt(e,t){var n,o;const r=document.querySelector(f.printableContent);if(!r||!e||!e.html){S("ไม่พบข้อมูลสำหรับสร้างเอกสาร","error");return}if(t==="direct"){St("กำลังสร้าง PDF...");try{typeof html2pdf>"u"&&(S("กำลังโหลดไลบรารี PDF...","default"),await lt("https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"));const a=document.createElement("div");a.style.position="fixed",a.style.left="-300mm",a.style.top="0",a.style.width="210mm",a.style.background="#fff",a.innerHTML=e.html,document.body.appendChild(a),await new Promise(l=>setTimeout(l,500));const s={margin:0,filename:`${e.fileName}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0,logging:!1,width:((n=a.querySelector(".pdf-page"))==null?void 0:n.scrollWidth)||210*3.77,windowWidth:((o=a.querySelector(".pdf-page"))==null?void 0:o.scrollWidth)||210*3.77},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}};await window.html2pdf().from(a).set(s).save(),S("ดาวน์โหลด PDF สำเร็จ","success"),document.body.contains(a)&&document.body.removeChild(a)}catch(a){console.error("PDF Generation Error:",a),S("สร้าง PDF ล้มเหลว, โปรดลองวิธีที่ 2 (พิมพ์)","error")}finally{bt()}}t==="print"&&(r.innerHTML=e.html,setTimeout(()=>{window.print(),setTimeout(()=>{r.innerHTML=""},1e3)},Ve))}function qt(e){if(!e||!e.html){S("ไม่พบข้อมูลสำหรับสร้างไฟล์ HTML","error");return}try{const t=`
            <!DOCTYPE html><html lang="th"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>${e.fileName}</title>
                <link rel="stylesheet" href="https://grobmak.github.io/marnthara-form/src/style.css">
                <style>#printable-content { display: block !important; } .pdf-page { border: 1px solid #eee; box-shadow: 0 0 10px rgba(0,0,0,0.1); margin: 10mm auto; }</style>
            </head>
            <body>${e.html}</body></html>`,r=new Blob([t],{type:"text/html;charset=utf-8"}),n=URL.createObjectURL(r),o=document.createElement("a");o.href=n,o.download=`${e.fileName}.html`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n),S("ดาวน์โหลดไฟล์ HTML สำเร็จ","success")}catch(t){console.error("HTML Export Error:",t),S("สร้างไฟล์ HTML ล้มเหลว","error")}}function Lt(e){if(!e)return;const t=e.closest(".item-card");if(!t)return;const r=_(e.value);let n,o;const a=e.getAttribute("name");if(a==="set_price_per_m"?(n=t.querySelector('input[name="fabric_code"]'),o="fabric"):a==="sheer_price_per_m"?(n=t.querySelector('input[name="sheer_fabric_code"]'),o="sheer"):a==="wallpaper_price_roll"?(n=t.querySelector('input[name="wallpaper_code"]'),o="wallpaper"):a==="area_price_sqyd"&&(n=t.querySelector('input[name="area_code"]'),n&&(o=n.dataset.favoriteType)),n&&o&&n.value.trim()){const s=Me(o,n.value);s&&s.price!==r&&(n.value="",ge(n))}}const $t=Ge(e=>{e.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_price_per_m"]')&&Lt(e),ee(e),N()},200);function Pe(e){var r,n,o;if(W){e.preventDefault();return}const t=e.target;if(t.matches('select[name="fabric_variant"]')){const a=t.closest(".set-item");if(a){const s=(r=t.value)==null?void 0:r.includes("โปร่ง");(n=a.querySelector(f.sheerWrap))==null||n.classList.toggle("hidden",!s),(o=a.querySelector(f.sheerCodeWrap))==null||o.classList.toggle("hidden",!s)}}if(t.matches(f.roomNameInput)){const a=t.closest(".room-card");if(a){const s=a.querySelector("[data-room-name-display]");s&&(s.textContent=t.value||"ห้อง")}ce(),ie()}t.matches("input[data-favorite-type]")&&ge(t),$t(t)}function Tt(e){const t=e.target;t.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_install_cost"]')?t.value=_(t.value)>0?$(_(t.value)):"":t.matches('input[name$="_m"], input[name$="width_m"]')&&(t.value=K(t.value))}function kt(e){const t=e.target;t.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_install_cost"]')&&_(t.value)>0&&(t.value=_(t.value)),t.matches("input[data-favorite-type]")&&(ye=t,Oe(t))}const xt=async e=>{var d,p,u,h;const t=e.target.closest(".summary-tag[data-filter-type]");if(t){const m=t.dataset.filterType,v=t.textContent.trim().replace(/\s*\d+\s*$/,""),y=document.querySelector("#overviewModal");y&&y.classList.remove("visible"),dt(m,v);return}const r=e.target.closest(".favorite-chips-container .btn-chip");if(r){mt(r);return}const n=e.target.closest(".fav-manager-item");if(n){const m=n.parentElement.querySelector(".is-selected");m&&m.classList.remove("is-selected"),m!==n?(n.classList.add("is-selected"),ke(n)):ke(null);return}const o=e.target.closest("[data-act]");if(!o)return;const a=["toggle-more-details","show-discount-modal","collapse-room"];if(W&&!o.closest(".unlockable")&&!a.includes(o.dataset.act))return;const s=o.dataset.act,l=o.closest(f.room),c=o.closest(".item-card"),i=(m,v,y)=>ae(m,v).then(g=>g&&y());switch(s){case"add-room":re();break;case"add-item":{if(we=o.closest(f.room),we){const y=await Ne("เพิ่มรายการใหม่");y&&_t(y,we)}break}case"collapse-room":l&&(e.preventDefault(),l.open=!1,(d=l.querySelector("summary"))==null||d.scrollIntoView({behavior:"smooth",block:"center"}));break;case"clear-filter":pt();break;case"change-type":{const y=c==null?void 0:c.dataset.type;if(c&&y){const g=await Ne("เปลี่ยนประเภทรายการ",y);g&&g!==y&&i("ยืนยันการเปลี่ยนแปลง","ข้อมูลทั้งหมดในรายการนี้จะถูกลบและสร้างใหม่ คุณแน่ใจหรือไม่?",()=>gt(c,g))}break}case"add-wall":{const y=Ae(o);y&&((p=y.querySelector('input[name="wall_width_m"]'))==null||p.focus());break}case"show-discount-modal":vt();break;case"toggle-more-details":{const y=c==null?void 0:c.querySelector(".item-details-more");if(y){const g=y.classList.toggle("show");o.classList.toggle("expanded",g),o.querySelector("i").className=g?"ph ph-caret-up":"ph ph-caret-down",o.querySelector("span").textContent=g?"ย่อน้อยลง":"เพิ่มเติม"}break}case"toggle-favorite":{const y=o.closest(".form-group-with-favorites").querySelector("input[data-favorite-type]");if(!y||!c)break;const g=y.dataset.favoriteType,T=y.value;let b;g==="fabric"?b="set_price_per_m":g==="sheer"?b="sheer_price_per_m":g==="wallpaper"?b="wallpaper_price_roll":b="area_price_sqyd";const q=c.querySelector(`[name="${b}"]`),x=_(q==null?void 0:q.value);if(!T.trim()){S("โปรดระบุรหัสก่อนบันทึก","warning");break}if(x<=0&&g!=="fabric"&&g!=="sheer"){S("โปรดระบุราคาก่อนบันทึก","warning");break}const E=be(g,T,x);o.classList.toggle("is-favorite",E),S(E?"เพิ่มในรายการโปรดแล้ว":"ลบออกจากรายการโปรด","success"),N();break}case"manage-favorites":{const y=o.dataset.type;ye=o.closest(".form-group-with-favorites").querySelector("input[data-favorite-type]"),ft(y);break}case"add-new-fav-form":{const g=o.closest("#favManagerModal").dataset.currentType;if(!g)break;const T=document.querySelector("#favAddModal");T.querySelector("h3").textContent=`เพิ่ม '${((u=le[g])==null?void 0:u.name)||g}'`;const b=T.querySelector('[name="fav_code_add"]'),q=T.querySelector('[name="fav_price_add"]');b.value="",q.value="";const x=await G("#favAddModal");if(x&&!x.cancelled){const E=b.value.trim(),J=_(q.value);E&&(be(g,E,J),ne=!0,he(g),S("เพิ่มรายการโปรดแล้ว","success"))}break}case"edit-selected-fav":{if(!O)break;const g=o.closest("#favManagerModal").dataset.currentType;if(!g)break;const T=document.querySelector("#favEditModal");T.querySelector("h3").textContent=`แก้ไข '${O.code}'`;const b=T.querySelector('[name="fav_code_edit"]'),q=T.querySelector('[name="fav_price_edit"]');b.value=O.code,q.value=O.price>0?O.price:"";const x=await G("#favEditModal");if(x&&!x.cancelled){const E=b.value.trim(),J=_(q.value);E&&(E!==O.code&&$e(g,O.code),be(g,E,J),ne=!0,he(g),S("แก้ไขรายการโปรดแล้ว","success"))}break}case"del-selected-fav":{if(!O)break;const g=o.closest("#favManagerModal").dataset.currentType;if(!g)break;await ae("ลบรายการโปรด",`ยืนยันการลบรหัส "${O.code}"?`)&&($e(g,O.code),ne=!0,he(g),S("ลบรายการโปรดแล้ว","success"));break}case"del-room":i("ลบห้อง","ยืนยันการลบห้องนี้?",()=>Le(l,"ลบห้องแล้ว"));break;case"del-item":i("ลบรายการ","ยืนยันการลบรายการนี้?",()=>Le(c,"ลบรายการแล้ว"));break;case"del-wall":i("ลบผนัง","ยืนยันการลบผนังนี้?",()=>Le(o.closest(".wall-input-row"),"ลบผนังแล้ว",()=>ee(c)));break;case"clear-room":i("ล้างข้อมูลในห้อง","ยืนยันลบทุกรายการในห้องนี้?",()=>{z(H()),Y(),l.querySelector(f.allItemsContainer).innerHTML="",X(),j(),N(),S("ล้างข้อมูลในห้องแล้ว","success")});break;case"toggle-room-menu":e.preventDefault();const m=o.nextElementSibling;if(!m||!l)return;const v=!m.classList.contains("show");document.querySelectorAll(".room-options-menu.show").forEach(y=>y.classList.remove("show")),document.querySelectorAll(".card.overflow-visible").forEach(y=>y.classList.remove("overflow-visible")),v&&(m.classList.add("show"),l.classList.add("overflow-visible"));break;case"toggle-suspend-room":e.preventDefault(),l==null||l.classList.toggle("is-suspended"),j(),N(),(h=o.closest(".room-options-menu"))==null||h.classList.remove("show"),l==null||l.classList.remove("overflow-visible");break;case"toggle-suspend":e.preventDefault(),c==null||c.classList.toggle("is-suspended"),ee(o),N();break}};function It(){W=!W,He()}function Et(e){if(!e||e.closest(".modal-wrapper"))return;const t=e.getAttribute("name"),r=e.closest(".item-card"),a=(s=>{const l=s[t];if(!l)return null;const c=r||document;let i=null;return typeof l=="string"?i=c.querySelector(`[name="${l}"]:not(:disabled)`):typeof l=="function"&&(i=l(e)),!i&&r&&typeof l=="string"&&(i=document.querySelector(`[name="${l}"]:not(:disabled)`)),i})({customer_name:"customer_phone",customer_phone:"customer_address",customer_address:()=>document.querySelector(".room-name-input"),room_name:s=>{var l;return(l=s.closest(".room-card"))==null?void 0:l.querySelector('[data-act="add-item"]')},width_m:"height_m",height_m:"set_price_per_m",set_price_per_m:s=>{var i;const l=s.closest(".set-item"),c=(i=l==null?void 0:l.querySelector('[name="fabric_variant"]'))==null?void 0:i.value;return c!=null&&c.includes("โปร่ง")?l==null?void 0:l.querySelector('[name="sheer_price_per_m"]'):l==null?void 0:l.querySelector('[data-act="toggle-more-details"]')},sheer_price_per_m:s=>{var l;return(l=s.closest(".item-card"))==null?void 0:l.querySelector('[data-act="toggle-more-details"]')},area_width_m:"area_height_m",area_height_m:"area_price_sqyd",area_price_sqyd:"area_code",wall_width_m:s=>{var c,i;const l=(c=s.closest(".wall-input-row"))==null?void 0:c.nextElementSibling;return l!=null&&l.matches(".wall-input-row")?l.querySelector("input"):(i=s.closest(".item-card"))==null?void 0:i.querySelector('[name="wallpaper_price_roll"]')},wallpaper_price_roll:"wallpaper_height_m",wallpaper_height_m:"wallpaper_code"});a&&(a.focus(),typeof a.select=="function"&&a.select())}function Mt(){const e=document.querySelector(f.setTpl);if(!e)return;const t=e.content.querySelector('select[name="set_price_per_m"]'),r=e.content.querySelector('select[name="sheer_price_per_m"]'),n=o=>{let a='<option value="" hidden>เลือกราคา</option>';return Array.isArray(o)?(o.forEach(s=>{a+=`<option value="${s}">${s.toLocaleString("th-TH")}</option>`}),a):(console.error("Price data for dropdown is not available or not an array.",o),a)};t&&(t.innerHTML=n(ve.fabric)),r&&(r.innerHTML=n(ve.sheer))}function Bt(){Mt(),Re();const e=document.querySelector(f.orderForm),t=document.querySelector(f.fileImporter),r=document.querySelector(f.menuDropdown),n=document.querySelector(f.quickNavDropdown),o=document.querySelector("#pageBreakBuffer"),a=document.querySelector("#pageBreakBufferValue");o&&a&&o.addEventListener("input",()=>{a.textContent=o.value}),e.addEventListener("input",Pe),e.addEventListener("change",Pe),document.addEventListener("click",xt),e.addEventListener("blur",Tt,!0),e.addEventListener("focusin",kt,!0),e.addEventListener("keydown",c=>{const i=c.target;c.key==="Enter"&&!i.matches("textarea, button, [data-act]")&&(c.preventDefault(),Et(i))});const s=c=>{const i=c.target.closest(f.room);i&&De(i)};e.addEventListener("click",s),e.addEventListener("focusin",s),document.body.addEventListener("click",c=>{c.target.closest("summary")&&setTimeout(()=>{V(),N()},50)}),document.querySelector("#undoBtn").addEventListener("click",c=>{c.preventDefault(),ut()}),document.querySelector(f.lockBtn).addEventListener("click",It),document.querySelector(f.toggleAllRoomsBtn).addEventListener("click",yt),document.querySelector(f.quickNavBtn).addEventListener("click",c=>{var d;c.stopPropagation(),r.classList.remove("show");const i=!n.classList.contains("show");n.classList.toggle("show"),c.currentTarget.setAttribute("aria-expanded",i),i&&((d=document.querySelector(f.menuBtn))==null||d.setAttribute("aria-expanded","false"))}),document.querySelector(f.quickNavRoomList).addEventListener("click",c=>{var d;const i=c.target.closest("a[data-jump-to]");if(i){c.preventDefault();const p=i.dataset.jumpTo,u=document.getElementById(p);u&&(document.body.classList.add("disable-animations"),u.open=!0,u.scrollIntoView({behavior:"auto",block:"start"}),u.classList.add("scrolling-jump"),setTimeout(()=>{u.classList.remove("scrolling-jump"),document.body.classList.remove("disable-animations"),V()},1e3)),n.classList.remove("show"),(d=document.querySelector(f.quickNavBtn))==null||d.setAttribute("aria-expanded","false")}});const l=document.querySelector("#addRoomQuickNavBtn");if(l){const c=Je(re,700);l.addEventListener("click",i=>{var d;i.stopPropagation(),c(),n.classList.remove("show"),(d=document.querySelector(f.quickNavBtn))==null||d.setAttribute("aria-expanded","false")})}document.querySelector(f.menuBtn).addEventListener("click",c=>{var d;c.stopPropagation(),n.classList.remove("show");const i=!r.classList.contains("show");r.classList.toggle("show"),c.currentTarget.setAttribute("aria-expanded",i),i&&((d=document.querySelector(f.quickNavBtn))==null||d.setAttribute("aria-expanded","false"))}),document.querySelector("#themeToggleBtn").addEventListener("click",c=>{c.preventDefault(),it()}),document.querySelector("#overviewBtn").addEventListener("click",async c=>{var u;c.preventDefault(),r.classList.remove("show"),(u=document.querySelector(f.menuBtn))==null||u.setAttribute("aria-expanded","false");const i=H(),d=document.querySelector("#overviewModalHeader"),p=document.querySelector("#overviewModalBody");if(d&&p){const h=i.rooms.reduce((y,g)=>{if(g.is_suspended)return y;const T=(g.items||[]).filter(b=>{if(b.is_suspended)return!1;let q=0;switch(b.type){case"set":q=k.calculateSetPrice(b).total;break;case"wallpaper":q=k.calculateWallpaperPrice(b).total;break;default:q=k.calculateDecoPrice(b).total;break}return q>0}).length;return y+T},0),m=document.querySelector(f.grandTotal).textContent||"0",v=i.rooms.filter(y=>!y.is_suspended&&y.items&&y.items.some(g=>!g.is_suspended)).length;d.innerHTML=`
                <div class="overview-stats-grid">
                    <div class="overview-stat-card">
                        <i class="ph-bold ph-map-pin-line"></i>
                        <div class="stat-value">${v}</div>
                        <div class="stat-label">ห้อง</div>
                    </div>
                    <div class="overview-stat-card">
                        <i class="ph-bold ph-stack"></i>
                        <div class="stat-value">${h}</div>
                        <div class="stat-label">รายการ</div>
                    </div>
                    <div class="overview-stat-card">
                        <i class="ph-bold ph-coins"></i>
                        <div class="stat-value">${m}</div>
                        <div class="stat-label">ยอดรวม</div>
                    </div>
                </div>
            `,p.innerHTML=rt(i),G("#overviewModal")}}),document.querySelector(f.exportPdfBtn).addEventListener("click",async c=>{var u;c.preventDefault(),r.classList.remove("show"),(u=document.querySelector(f.menuBtn))==null||u.setAttribute("aria-expanded","false");const i=await ht();if(!i)return;const d=H(),p=ot(d,{vatRate:i.vatOption==="include"?C.baseVatRate:0,pageBreakBuffer:i.pageBreakBuffer});if(!p){S("ไม่มีรายการที่มีราคาสำหรับสร้างเอกสาร","warning");return}i.exportMethod==="html"?qt(p):wt(p,i.exportMethod)}),document.querySelector(f.importBtn).addEventListener("click",c=>{var i;c.preventDefault(),r.classList.remove("show"),(i=document.querySelector(f.menuBtn))==null||i.setAttribute("aria-expanded","false"),t.click()}),t.addEventListener("change",c=>{var p;const i=(p=c.target.files)==null?void 0:p[0];if(!i)return;const d=new FileReader;d.onload=u=>{try{const h=JSON.parse(u.target.result);xe(h)}catch(h){S("ไฟล์ JSON ไม่ถูกต้อง","error"),console.error("JSON Parse Error:",h)}},d.readAsText(i),c.target.value=null}),document.querySelector(f.exportBtn).addEventListener("click",c=>{var i;c.preventDefault(),r.classList.remove("show"),(i=document.querySelector(f.menuBtn))==null||i.setAttribute("aria-expanded","false");try{const d=H(),p=JSON.stringify(d,null,4),u=new Blob([p],{type:"application/json"}),h=URL.createObjectURL(u),m=document.createElement("a"),v=new Date,y=`${v.getFullYear()}${(v.getMonth()+1).toString().padStart(2,"0")}${v.getDate().toString().padStart(2,"0")}`,g=`${v.getHours().toString().padStart(2,"0")}${v.getMinutes().toString().padStart(2,"0")}`,T=Fe(d.customer_name||"data");m.href=h,m.download=`MTR-${y}${g}-${T}.json`,m.click(),URL.revokeObjectURL(h),S("Export ข้อมูลสำเร็จ","success")}catch{S("Export ข้อมูลล้มเหลว","error")}}),document.querySelector(f.submitBtn).addEventListener("click",async c=>{var i;if(c.preventDefault(),r.classList.remove("show"),(i=document.querySelector(f.menuBtn))==null||i.setAttribute("aria-expanded","false"),await ae("ส่งข้อมูล","ยืนยันการส่งข้อมูลการประเมินราคา?")){const d=H();if(!d.customer_name&&!d.customer_phone){S("กรุณาระบุชื่อหรือเบอร์โทรลูกค้า","warning");return}S("กำลังส่งข้อมูล...","default");try{const p=await fetch(Ue,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)});p.ok?S("ส่งข้อมูลสำเร็จ!","success"):S(`ส่งข้อมูลล้มเหลว: ${p.status}`,"error")}catch{S("เกิดข้อผิดพลาดในการเชื่อมต่อ","error")}}}),document.querySelector(f.copyTextBtn).addEventListener("click",async c=>{var p;c.preventDefault(),r.classList.remove("show"),(p=document.querySelector(f.menuBtn))==null||p.setAttribute("aria-expanded","false");const i=document.querySelector(f.copyOptionsModal);i.querySelector('input[name="copy_option"][value="customer"]').checked=!0;const d=await G(f.copyOptionsModal);if(d&&!d.cancelled){const u=i.querySelector('input[name="copy_option"]:checked').value,h=tt(H(),u);try{await navigator.clipboard.writeText(h),S("คัดลอกสรุปสำเร็จ!","success")}catch{S("คัดลอกล้มเหลว","error")}}}),document.querySelector(f.clearItemsBtn).addEventListener("click",async c=>{var i;c.preventDefault(),r.classList.remove("show"),(i=document.querySelector(f.menuBtn))==null||i.setAttribute("aria-expanded","false"),await ae("ล้างทุกรายการ","คุณแน่ใจหรือไม่ว่าต้องการลบรายการสินค้าทั้งหมด (ข้อมูลลูกค้าและห้องจะยังคงอยู่)?")&&(z(H()),Y(),document.querySelectorAll(f.room).forEach(d=>{const p=d.querySelector(f.allItemsContainer);p&&(p.innerHTML="")}),j(),N(),S("ล้างทุกรายการแล้ว","success"))}),document.querySelector(f.clearAllBtn).addEventListener("click",async c=>{var i;if(c.preventDefault(),r.classList.remove("show"),(i=document.querySelector(f.menuBtn))==null||i.setAttribute("aria-expanded","false"),await ae("ลบข้อมูลทั้งหมด",'คำเตือน! การกระทำนี้จะลบข้อมูลลูกค้า, ทุกรายการ, และ "รายการโปรด" ทั้งหมดอย่างถาวร ยืนยันหรือไม่?')){z(H()),Y(),localStorage.removeItem(me),Ze();const d=document.querySelector("#customer_name"),p=document.querySelector("#customer_phone"),u=document.querySelector("#customer_address");d&&(d.value=""),p&&(p.value=""),u&&(u.value="");const h=document.querySelector("#discount_type"),m=document.querySelector("#discount_value");h&&(h.value="amount"),m&&(m.value="0");const v=document.querySelector(f.roomsContainer);v&&(v.innerHTML=""),j(),ce(),V(),re();const y=document.querySelector("#customerDetailsCard");y&&(y.open=!0),S("ลบข้อมูลทั้งหมดแล้ว เริ่มต้นใหม่","success")}}),window.addEventListener("click",c=>{var i,d;c.target.closest(".modal-wrapper")||(c.target.closest(".menu-container")||(r.classList.contains("show")&&(r.classList.remove("show"),(i=document.querySelector(f.menuBtn))==null||i.setAttribute("aria-expanded","false")),n.classList.contains("show")&&(n.classList.remove("show"),(d=document.querySelector(f.quickNavBtn))==null||d.setAttribute("aria-expanded","false"))),c.target.closest(".room-options-container")||(document.querySelectorAll(".room-options-menu.show").forEach(p=>p.classList.remove("show")),document.querySelectorAll(".card.overflow-visible").forEach(p=>p.classList.remove("overflow-visible"))),c.target.closest(".form-group-with-favorites")||_e())}),window.addEventListener("beforeunload",N);try{const c=localStorage.getItem(me);if(c&&c.length>2&&c!=="null")xe(JSON.parse(c));else{re();const i=document.querySelector("#customerDetailsCard");i&&(i.open=!0)}}catch(c){console.error("Failed to load data from localStorage:",c),localStorage.removeItem(me),re()}j(),He(),V(),ie(),Y()}document.addEventListener("DOMContentLoaded",Bt);
