(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const c of o)if(c.type==="childList")for(const a of c.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function n(o){const c={};return o.integrity&&(c.integrity=o.integrity),o.referrerPolicy&&(c.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?c.credentials="include":o.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function r(o){if(o.ep)return;o.ep=!0;const c=n(o);fetch(o.href,c)}})();const Le="input-ui/5.6.0-final",Te="https://your-make-webhook-url.com/your-unique-path",re="marnthara.input.v4",$e=500,I={name:"ม่านธารา ผ้าม่านและของตกแต่ง",address:"65/8 หมู่ 2 ต.ท่าศาลา อ.เมือง จ.ลพบุรี 15000",phone:"092-985-9395, 082-552-5595",taxId:"1234567890123",logoUrl:"https://i.imgur.com/l7y85nI.png",baseVatRate:.07,pdf:{paymentTerms:"ชำระมัดจำ 50%",priceValidity:"30 วัน",notes:["ราคานี้รวมค่าติดตั้งแล้ว","ชำระมัดจำ 50% เพื่อยืนยันการสั่งผลิตสินค้า","ใบเสนอราคานี้มีอายุ 30 วัน นับจากวันที่เสนอราคา"]}},Ce=1.19599,ue={ROLL_WIDTH_M:.53,ROLL_LENGTH_M:10,STRIPS_PER_ROLL_UNDER_2_5M:3},ce={fabric:[1e3,1100,1200,1300,1400,1500,1600,1700,1800,1900,2e3,2100,2200],sheer:[1e3,1100,1200,1300,1400,1500],style_surcharge:{ลอน:200,ตาไก่:0,จีบ:0},height:[{threshold:3.2,add_per_m:300},{threshold:2.8,add_per_m:200},{threshold:2.5,add_per_m:100}]},m={orderForm:"#orderForm",roomsContainer:"#rooms",setTpl:"#setTpl",clearAllBtn:"#clearAllBtn",lockBtn:"#lockBtn",grandTotal:"#grandTotal",setCount:"#setCount",modal:"#confirmationModal",modalTitle:"#modalTitle",modalBody:"#modalBody",room:"[data-room]",set:"[data-set]",setsContainer:"[data-sets]",decorationsContainer:"[data-decorations]",decoItem:"[data-deco-item]",wallpapersContainer:"[data-wallpapers]",wallpaperItem:"[data-wallpaper-item]",wallsContainer:"[data-walls-container]",sheerWrap:"[data-sheer-wrap]",roomNameInput:'input[name="room_name"]',toastContainer:"#toast-container",copyTextBtn:"#copyTextBtn",copyOptionsModal:"#copyOptionsModal",menuBtn:"#menuBtn",menuDropdown:"#menuDropdown",importBtn:"#importBtn",exportBtn:"#exportBtn",fileImporter:"#fileImporter",submitBtn:"#submitBtn",clearItemsBtn:"#clearItemsBtn",exportPdfBtn:"#exportPdfBtn",exportOptionsModal:"#exportOptionsModal",printableContent:"#printable-content",quickNavBtn:"#quickNavBtn",quickNavDropdown:"#quickNavDropdown",quickNavRoomList:"#quickNavRoomList",toggleAllRoomsBtn:"#toggleAllRoomsBtn",allDetailsCards:'.card[id="customerDetailsCard"], .room-card'},v=t=>{typeof t=="string"&&(t=t.replace(/,/g,""));const e=parseFloat(t);return Number.isFinite(e)?e:0},O=t=>{const e=v(t);return e>0?e.toFixed(2):""},M=(t,e=2,n=!1)=>Number.isFinite(t)?t.toLocaleString("en-US",{minimumFractionDigits:n?2:e,maximumFractionDigits:n?2:e}):"0",T=(t,e=0)=>Number.isFinite(t)?t.toLocaleString("th-TH",{minimumFractionDigits:e,maximumFractionDigits:e}):"0",Ee=(t,e=150)=>{let n;return(...r)=>{clearTimeout(n),n=setTimeout(()=>t(...r),e)}},ke=(t,e=700)=>{let n=!1;return(...r)=>{if(!n){n=!0;try{return t(...r)}finally{setTimeout(()=>{n=!1},e)}}}};function Ie(t){let e=v(t);if(isNaN(e))return"ข้อมูลตัวเลขไม่ถูกต้อง";if(e===0)return"ศูนย์บาทถ้วน";const n=["","หนึ่ง","สอง","สาม","สี่","ห้า","หก","เจ็ด","แปด","เก้า"],r=["","สิบ","ร้อย","พัน","หมื่น","แสน","ล้าน"];let o=Math.floor(e),c=Math.round((e-o)*100);const a=i=>{if(i===0)return"";let d="";const u=String(i);for(let p=0;p<u.length;p++){const f=u[p];u.length-1;const y=u.length-p-1;f!=="0"&&(y===1&&f==="1"?d+=r[y]:y===1&&f==="2"?d+="ยี่"+r[y]:y===0&&f==="1"&&u.length>1?d+="เอ็ด":d+=n[parseInt(f)]+r[y])}return d};let l="";if(o>0){const i=Math.floor(o/1e6),d=o%1e6;i>0&&(l+=a(i)+"ล้าน"),l+=a(d),l+="บาท"}let s="";return c>0?s=a(c)+"สตางค์":l+="ถ้วน",(l+s).trim()}function j(){var e,n,r,o;const t={app_version:Le,customer_name:((e=document.querySelector('[name="customer_name"]'))==null?void 0:e.value)||"",customer_phone:((n=document.querySelector('[name="customer_phone"]'))==null?void 0:n.value)||"",customer_address:((r=document.querySelector('[name="customer_address"]'))==null?void 0:r.value)||"",customer_card_open:(o=document.querySelector("#customerDetailsCard"))==null?void 0:o.open,rooms:[]};return document.querySelectorAll(m.room).forEach(c=>{var l;const a={id:c.id,room_name:((l=c.querySelector(m.roomNameInput))==null?void 0:l.value)||"",is_suspended:c.classList.contains("is-suspended"),sets:[],decorations:[],wallpapers:[]};c.querySelectorAll(m.set).forEach(s=>{var i,d,u,p,f,y,w,S,h,q,_;a.sets.push({width_m:v((i=s.querySelector('input[name="width_m"]'))==null?void 0:i.value),height_m:v((d=s.querySelector('input[name="height_m"]'))==null?void 0:d.value),style:((u=s.querySelector('select[name="set_style"]'))==null?void 0:u.value)||"",fabric_variant:((p=s.querySelector('select[name="fabric_variant"]'))==null?void 0:p.value)||"",price_per_m_raw:v((f=s.querySelector('select[name="set_price_per_m"]'))==null?void 0:f.value),sheer_price_per_m:v((y=s.querySelector('select[name="sheer_price_per_m"]'))==null?void 0:y.value),fabric_code:((w=s.querySelector('input[name="fabric_code"]'))==null?void 0:w.value)||"",sheer_fabric_code:((S=s.querySelector('input[name="sheer_fabric_code"]'))==null?void 0:S.value)||"",opening_style:((h=s.querySelector('select[name="opening_style"]'))==null?void 0:h.value)||"",track_color:((q=s.querySelector('select[name="track_color"]'))==null?void 0:q.value)||"",notes:((_=s.querySelector('input[name="notes"]'))==null?void 0:_.value)||"",is_suspended:s.classList.contains("is-suspended")})}),c.querySelectorAll(m.decoItem).forEach(s=>{var i,d,u,p,f,y;a.decorations.push({type:((i=s.querySelector('[name="deco_type"]'))==null?void 0:i.value)||"",width_m:v((d=s.querySelector('[name="deco_width_m"]'))==null?void 0:d.value),height_m:v((u=s.querySelector('[name="deco_height_m"]'))==null?void 0:u.value),price_sqyd:v((p=s.querySelector('[name="deco_price_sqyd"]'))==null?void 0:p.value),deco_code:((f=s.querySelector('[name="deco_code"]'))==null?void 0:f.value)||"",notes:((y=s.querySelector('[name="deco_notes"]'))==null?void 0:y.value)||"",is_suspended:s.classList.contains("is-suspended")})}),c.querySelectorAll(m.wallpaperItem).forEach(s=>{var i,d,u,p,f;a.wallpapers.push({height_m:v((i=s.querySelector('[name="wallpaper_height_m"]'))==null?void 0:i.value),wallpaper_code:((d=s.querySelector('[name="wallpaper_code"]'))==null?void 0:d.value)||"",price_per_roll:v((u=s.querySelector('[name="wallpaper_price_roll"]'))==null?void 0:u.value),install_cost_per_roll:v((p=s.querySelector('[name="wallpaper_install_cost"]'))==null?void 0:p.value),notes:((f=s.querySelector('[name="wallpaper_notes"]'))==null?void 0:f.value)||"",widths:Array.from(s.querySelectorAll('[name="wall_width_m"]')).map(y=>v(y.value)),is_suspended:s.classList.contains("is-suspended")})}),t.rooms.push(a)}),t}function A(){localStorage.setItem(re,JSON.stringify(j()))}const L={stylePlus:t=>ce.style_surcharge[t]??0,heightPlus:t=>{const e=[...ce.height].sort((n,r)=>r.threshold-n.threshold);for(const n of e)if(t>n.threshold)return n.add_per_m;return 0},fabricYardage:(t,e)=>{const n=v(e);return n<=0||!t?0:t==="ตาไก่"||t==="จีบ"?(n*2+.6)/.9:t==="ลอน"?(n*2.6+.6)/.9:0},wallpaperRolls:(t,e)=>{const n=v(t),r=v(e);if(n<=0||r<=0)return 0;const o=r>2.5?Math.floor(ue.ROLL_LENGTH_M/r):ue.STRIPS_PER_ROLL_UNDER_2_5M;if(o<=0)return 0;const c=Math.ceil(n/ue.ROLL_WIDTH_M);return Math.ceil(c/o)},calculateSetPrice:function(t){var a,l;if(!t||t.is_suspended||v(t.width_m)<=0)return{total:0,opaque:0,sheer:0};const e=this.stylePlus(t.style),n=this.heightPlus(v(t.height_m)),r=v(t.width_m),o=(a=t.fabric_variant)!=null&&a.includes("ทึบ")&&v(t.price_per_m_raw)>0?(v(t.price_per_m_raw)+e+n)*r:0,c=(l=t.fabric_variant)!=null&&l.includes("โปร่ง")&&v(t.sheer_price_per_m)>0?(v(t.sheer_price_per_m)+e+n)*r:0;return{total:Math.round(o+c),opaque:Math.round(o),sheer:Math.round(c)}},calculateDecoPrice:function(t){if(!t||t.is_suspended||v(t.width_m)<=0)return{total:0,sqm:0,sqyd:0};const e=v(t.width_m)*v(t.height_m),n=e*Ce,r=n*v(t.price_sqyd);return{total:Math.round(r),sqm:e,sqyd:n}},calculateWallpaperPrice:function(t){var a;if(!t||t.is_suspended)return{total:0,material:0,install:0,rolls:0,sqm:0};const e=((a=t.widths)==null?void 0:a.reduce((l,s)=>l+v(s),0))||0;if(e<=0)return{total:0,material:0,install:0,rolls:0,sqm:0};const n=v(t.height_m),r=this.wallpaperRolls(e,n),o=r*v(t.price_per_roll),c=r*v(t.install_cost_per_roll??300);return{total:Math.round(o+c),material:Math.round(o),install:Math.round(c),rolls:r,sqm:e*n}}};function xe(t){return t.rooms.reduce((e,n)=>{if(n.is_suspended)return e;const r=n.sets.reduce((a,l)=>a+L.calculateSetPrice(l).total,0),o=n.decorations.reduce((a,l)=>a+L.calculateDecoPrice(l).total,0),c=n.wallpapers.reduce((a,l)=>a+L.calculateWallpaperPrice(l).total,0);return e+r+o+c},0)}function Be(t,e){const n=xe(t);let r=`สรุปข้อมูล (${new Date().toLocaleDateString("th-TH",{day:"numeric",month:"numeric",year:"numeric"})})
`;if(r+=`ลูกค้า: ${t.customer_name||"-"}
`,(e==="customer"||e==="owner")&&(r+=`เบอร์โทร: ${t.customer_phone||"-"}
`,r+=`ที่อยู่: ${t.customer_address||"-"}
`),r+=`------------------------------
`,e==="customer")return r+=`
สรุปรายการ
`,t.rooms.forEach(o=>{if(o.is_suspended||[...o.sets,...o.decorations,...o.wallpapers].filter(l=>l.is_suspended?!1:l.widths?l.widths.reduce((s,i)=>s+i,0)>0:l.width_m>0).length===0)return;r+=`
*ห้อง: ${o.room_name||"ไม่ระบุ"}*
`;let a=0;o.sets.forEach(l=>{l.is_suspended||l.width_m<=0||(a++,r+=` ${a}) ผ้าม่าน ${l.style} (${l.fabric_variant})
`)}),o.decorations.forEach(l=>{l.is_suspended||l.width_m<=0||(a++,r+=` ${a}) ${l.type||"ของตกแต่ง"}
`)}),o.wallpapers.forEach(l=>{l.is_suspended||l.widths.reduce((s,i)=>s+i,0)<=0||(a++,r+=` ${a}) วอลเปเปอร์
`)})}),r+=`------------------------------
`,r+=`
สรุปยอดรวม: ${T(n)} บาท
`,r+=`
ขอบคุณที่ใช้บริการ
${I.name}
โทร: ${I.phone}`,r;if(e==="purchase_order"||e==="owner"){const o={opaqueFabrics:[],sheerFabrics:[],decorations:[],wallpapers:[],allSets:[]};if(t.rooms.forEach(c=>{c.is_suspended||(c.sets.forEach(a=>{a.is_suspended||a.width_m<=0||(o.allSets.push(a),a.fabric_variant.includes("ทึบ")&&o.opaqueFabrics.push({code:a.fabric_code||"??",yards:L.fabricYardage(a.style,a.width_m)}),a.fabric_variant.includes("โปร่ง")&&o.sheerFabrics.push({code:a.sheer_fabric_code||"??",yards:L.fabricYardage(a.style,a.width_m)}))}),c.decorations.forEach(a=>{a.is_suspended||!a.type||a.width_m<=0||o.decorations.push({type:a.type,code:a.deco_code||"xxx",width:a.width_m,height:a.height_m})}),c.wallpapers.forEach(a=>{if(a.is_suspended)return;const l=a.widths.reduce((s,i)=>s+i,0);if(l>0){const s=L.wallpaperRolls(l,a.height_m);s>0&&o.wallpapers.push({code:a.wallpaper_code||"xxx",rolls:s})}}))}),r+=`📋 *สรุปวัสดุสำหรับสั่งซื้อผ้า*
`,r+=`------------------------------
`,o.opaqueFabrics.length>0&&o.opaqueFabrics.forEach(c=>{r+=`- ผ้าทึบ (Curtain Fabric)
`,r+=`รหัส: #${c.code||"??"}
`,r+=`จำนวน: ${c.yards.toFixed(2)} หลา

`}),o.sheerFabrics.length>0&&o.sheerFabrics.forEach(c=>{r+=`- ผ้าโปร่ง (Sheer Fabric)
`,r+=`รหัส: #${c.code||"??"}
`,r+=`จำนวน: ${c.yards.toFixed(2)} หลา

`}),r+=`------------------------------
`,r+=`📋 *สำหรับสั่งซื้อ ราง*
`,r+=`------------------------------

`,o.allSets.length>0){let c=1;o.allSets.forEach(a=>{r+=`(${c++}) รางม่าน: ${a.style}, สี: ${a.track_color}
`,a.fabric_variant.includes("ทึบ")&&(r+=`  - รางทึบ: ${a.width_m.toFixed(2)} ม. (1 เส้น)
`),a.fabric_variant.includes("โปร่ง")&&(r+=`  - รางโปร่ง: ${a.width_m.toFixed(2)} ม. (1 เส้น)
`),a.fabric_variant==="ทึบ&โปร่ง"&&(r+=`  (❗️ต้องใช้ขาสองชั้น)
`),r+=`
`})}if(r+=`------------------------------
`,r+=`📋 *สำหรับสั่งซื้อ Blind*
`,r+=`------------------------------

`,o.decorations.length>0){const c={มู่ลี่ไม้:"Wooden Blind",ม่านม้วน:"Roller Blind",ปรับแสง:"Vertical Blind",ฉากกั้นห้อง:"Partition",มุ้งจีบ:"Pleated Insect Screen",มู่ลี่มิเนียม:"Aluminium Blind"};o.decorations.forEach(a=>{const l=c[a.type]?` (${c[a.type]})`:"";r+=`- ${a.type}${l}
`,r+=`รหัส: #${a.code||"xxx"}
`,r+=`ขนาด: ${a.width.toFixed(2)} x ${a.height.toFixed(2)} m.
`,r+=`จำนวน: 1 ชุด

`})}if(r+=`------------------------------
`,r+=`📋 *สำหรับสั่งซื้อ Wallpaper*
`,r+=`------------------------------

`,o.wallpapers.length>0&&o.wallpapers.forEach(c=>{r+=`- วอลเปเปอร์ -
`,r+=`รหัส: #${c.code||"xxx"}
`,r+=`จำนวน: ${c.rolls} ม้วน

`}),r+=`------------------------------
`,e==="purchase_order")return r}return(e==="seamstress"||e==="owner")&&(r+=`
🧵 *รายละเอียดสำหรับช่าง*
`,t.rooms.forEach(o=>{if(o.is_suspended||o.sets.filter(l=>!l.is_suspended&&l.width_m>0).length===0)return;r+=`
*ห้อง: ${o.room_name||"ไม่ระบุ"}*
`;let a=1;o.sets.forEach(l=>{l.is_suspended||l.width_m<=0||(r+=`${a++}) *ผ้าม่าน ${l.style} ${l.fabric_variant}*
`,r+=`  กว้าง ${l.width_m} x สูง ${l.height_m} ม.
`,r+=`  รูปแบบเปิด: ${l.opening_style}
`,l.fabric_variant.includes("ทึบ")&&(r+=`  ผ้าทึบ: รหัส ${l.fabric_code||"-"}
`),l.fabric_variant.includes("โปร่ง")&&(r+=`  ผ้าโปร่ง: รหัส ${l.sheer_fabric_code||"-"}
`))})}),r+=`------------------------------
`,e==="seamstress")||e==="owner"&&(r+=`
💰 *สรุปยอดรวม: ${T(n)} บาท*
`),r}function Me(t){if(!t.rooms||t.rooms.length===0)return'<p class="empty-summary">ไม่มีข้อมูลสำหรับแสดงผล</p>';const e={};let n=0,r="";if(t.rooms.forEach(a=>{if(a.is_suspended)return;const l={};a.sets.forEach(i=>{if(L.calculateSetPrice(i).total>0){const d="ผ้าม่าน";l[d]=(l[d]||0)+1,e[d]=(e[d]||0)+1}}),a.decorations.forEach(i=>{if(i.type&&L.calculateDecoPrice(i).total>0){const d=i.type;l[d]=(l[d]||0)+1,e[d]=(e[d]||0)+1}}),a.wallpapers.forEach(i=>{if(L.calculateWallpaperPrice(i).total>0){const d="วอลเปเปอร์";l[d]=(l[d]||0)+1,e[d]=(e[d]||0)+1}});const s=Object.entries(l);s.length>0&&(r+=`<tr class="room-header-row"><td colspan="3">${a.room_name||"ไม่ระบุชื่อห้อง"}</td></tr>`,s.forEach(([i,d])=>{r+=`<tr><td></td><td class="item-type-cell">${i}</td><td class="pdf-text-center">${d}</td></tr>`,n+=d}))}),n===0)return'<p class="empty-summary">ไม่มีรายการที่มีราคาสำหรับแสดงผล</p>';let c=`<div id="detailed-material-summary">
        <h4><i class="ph ph-stack"></i> ยอดรวมทุกประเภท</h4>
        <ul><li class="summary-note">${Object.entries(e).map(([a,l])=>`${a}: ${l}`).join(" , ")}</li></ul>
    </div>`;return c+=`<table>
        <thead><tr><th>ห้อง</th><th>รายการ</th><th class="pdf-text-center">จำนวน</th></tr></thead>
        <tbody>${r}</tbody>
    </table>`,c}function Pe(t,e){const{vatRate:n,pageBreakBuffer:r=3}=e,o=[];t.rooms.forEach($=>{if($.is_suspended)return;const C=[];$.sets.forEach(b=>{const k=L.calculateSetPrice(b).total;if(k>0){let x=`ผ้าม่าน ${b.style} (${b.fabric_variant}) <br><small>ขนาด ${b.width_m.toFixed(2)} x ${b.height_m.toFixed(2)} ม.${b.notes?` - ${b.notes}`:""}</small>`;C.push({description:x,total:k,units:x.includes("<br>")?1.5:1})}}),$.decorations.forEach(b=>{const k=L.calculateDecoPrice(b).total;if(k>0){let x=`${b.type||"งานตกแต่ง"} <br><small>รหัส: ${b.deco_code||"-"}, ขนาด ${b.width_m.toFixed(2)} x ${b.height_m.toFixed(2)} ม.</small>`;C.push({description:x,total:k,units:x.includes("<br>")?1.5:1})}}),$.wallpapers.forEach(b=>{const k=L.calculateWallpaperPrice(b).total;if(k>0){const x=b.widths.reduce((ee,de)=>ee+de,0),U=L.wallpaperRolls(x,b.height_m);let D=`วอลเปเปอร์ <br><small>รหัส: ${b.wallpaper_code||"-"}, สูง ${b.height_m.toFixed(2)} ม. (ใช้ ${U} ม้วน)</small>`;C.push({description:D,total:k,units:D.includes("<br>")?1.5:1})}}),C.length>0&&(o.push({isRoomHeader:!0,roomName:$.room_name||"ไม่ระบุชื่อห้อง",units:1.2}),o.push(...C))});const c=o.reduce(($,C)=>$+(C.total||0),0);if(c===0)return null;const a=c*n,l=c+a,s=17,i=23,d=[];let u=[],p=0;o.forEach(($,C)=>{const b=d.length===0?s:i,k=p+$.units>b;let x=!1;if(!k&&C<o.length-1){const U=b-(p+$.units);U>0&&U<r&&(x=!0)}(k||x)&&u.length>0&&(d.push(u),u=[],p=0),u.push($),p+=$.units}),u.length>0&&d.push(u);const f=new Date,y=f.toLocaleDateString("th-TH",{year:"numeric",month:"long",day:"numeric"}),w=`QT-${f.getFullYear()}${(f.getMonth()+1).toString().padStart(2,"0")}${f.getDate().toString().padStart(2,"0")}`;let S="",h=0,q=1;d.forEach(($,C)=>{const b=C===0,k=C===d.length-1,x=`
            <div class="pdf-page-header">
                <div class="pdf-header">
                    <div class="pdf-shop-info">
                        ${`<img src="${I.logoUrl}" alt="Logo" class="pdf-logo">`}
                        <div class="pdf-shop-address">
                            <strong>${I.name}</strong><br>
                            ${I.address.replace(/\n/g,"<br>")}<br>
                            โทร: ${I.phone} | เลขประจำตัวผู้เสียภาษี: ${I.taxId}
                        </div>
                    </div>
                    <div class="pdf-quote-details">
                        <div class="pdf-title-box"><h1>ใบเสนอราคา ${d.length>1?b?"":"(ต่อ)":""}</h1></div>
                        <table class="pdf-quote-meta">
                            <tr><td>เลขที่:</td><td>${w}</td></tr>
                            <tr><td>วันที่:</td><td>${y}</td></tr>
                        </table>
                    </div>
                </div>
                ${b?`
                <section class="pdf-customer-details">
                    <div class="pdf-customer-info">
                        <strong>ลูกค้า:</strong> ${t.customer_name||""}<br>
                        <strong>ที่อยู่:</strong> ${t.customer_address.replace(/\n/g,"<br>")||""}<br>
                        <strong>โทร:</strong> ${t.customer_phone||""}
                    </div>
                    <div class="pdf-customer-meta">
                        <strong>เงื่อนไขชำระเงิน:</strong> ${I.pdf.paymentTerms}<br>
                        <strong>ยืนราคา:</strong> ${I.pdf.priceValidity}
                    </div>
                </section>`:""}
            </div>`,U=`
            <div class="pdf-page-footer">
                <div class="pdf-footer-info">
                    <span>${I.name} | โทร: ${I.phone}</span>
                    <span>หน้า ${C+1} / ${d.length}</span>
                </div>
            </div>`;let D="";b||(D+=`<tr class="pdf-subtotal-row"><td colspan="4">ยอดยกมา (Brought Forward)</td><td class="pdf-text-right">${M(h,2,!0)}</td></tr>`),$.forEach(F=>{F.isRoomHeader?D+=`<tr class="pdf-room-header"><td colspan="5">ห้อง: ${F.roomName}</td></tr>`:(D+=`<tr><td class="pdf-text-center">${q++}</td><td>${F.description}</td><td class="pdf-text-center">1</td><td class="pdf-text-right">${M(F.total,2,!0)}</td><td class="pdf-text-right">${M(F.total,2,!0)}</td></tr>`,h+=F.total)});let ee="";k||(ee=`<tfoot><tr class="pdf-subtotal-row"><td colspan="4">ยอดยกไป (Carried Forward)</td><td class="pdf-text-right">${M(h,2,!0)}</td></tr></tfoot>`);const de=k?`
            <div class="pdf-summary-wrapper">
                <section class="pdf-summary-section">
                    <div class="pdf-amount-in-words">
                        <strong>หมายเหตุ:</strong>
                        <ul>${I.pdf.notes.map(F=>`<li>${F}</li>`).join("")}</ul>
                        <div class="pdf-amount-text">( ${Ie(l)} )</div>
                    </div>
                    <div class="pdf-totals-block">
                        <table>
                            <tr><td class="pdf-label">รวมเป็นเงิน</td><td class="pdf-amount">${M(c,2,!0)}</td></tr>
                            ${n>0?`<tr><td class="pdf-label">ภาษีมูลค่าเพิ่ม ${(n*100).toFixed(0)}%</td><td class="pdf-amount">${M(a,2,!0)}</td></tr>`:""}
                            <tr class="pdf-grand-total"><td class="pdf-label">ยอดรวมสุทธิ</td><td class="pdf-amount">${M(l,2,!0)}</td></tr>
                        </table>
                    </div>
                </section>
                <footer class="pdf-footer-section">
                    <div class="pdf-signature-box"><p>.................................................</p><p>ผู้เสนอราคา</p><p>(${I.name})</p><p>วันที่: ${y}</p></div>
                    <div class="pdf-signature-box"><p>.................................................</p><p>ลูกค้า / ผู้มีอำนาจลงนาม</p><p>&nbsp;</p><p>วันที่: ......./......./............</p></div>
                </footer>
            </div>
        `:"";S+=`
            <div class="pdf-page">
                <div class="pdf-page-content">
                    ${x}
                    <div class="pdf-page-body">
                        <table class="pdf-items-table">
                            <thead><tr><th style="width:5%;">ลำดับ</th><th style="width:50%;">รายการ</th><th style="width:10%;">จำนวน</th><th style="width:17.5%;">ราคา/หน่วย</th><th style="width:17.5%;">รวม (บาท)</th></tr></thead>
                            <tbody>${D}</tbody>
                            ${ee}
                        </table>
                        ${de}
                    </div>
                    ${U}
                </div>
            </div>`});const N=(t.customer_name||"quote").trim().replace(/\s+/g,"-");return{html:`<div id="quotation-template">${S}</div>`,fileName:`${w}_${N}`}}const pe="marnthara.favorites.v3";function W(){try{const t=localStorage.getItem(pe),e={fabric:[],sheer:[],deco:{},wallpaper:[]};return t?{...e,...JSON.parse(t)}:e}catch(t){return console.error("Failed to parse favorites from localStorage",t),{fabric:[],sheer:[],deco:{},wallpaper:[]}}}function se(t){try{localStorage.setItem(pe,JSON.stringify(t))}catch(e){console.error("Failed to save favorites to localStorage",e)}}function z(t,e,n){return e==="deco"?n?(t.deco[n]||(t.deco[n]=[]),t.deco[n]):null:(t[e]||(t[e]=[]),t[e])}function Ne(t,e,n,r=null){const o=W(),c=z(o,t,r);if(!c)return!1;const a=c.find(l=>l.code===e);return a?a.price=n:c.push({code:e,price:n}),c.sort((l,s)=>l.code.localeCompare(s.code)),se(o),!0}function Fe(t,e,n,r=null){const o=W(),c=z(o,t,r);return!c||c.some(a=>a.code===e)?!1:(c.push({code:e,price:n}),c.sort((a,l)=>a.code.localeCompare(l.code)),se(o),!0)}function Ae(t,e,n,r,o=null){const c=W(),a=z(c,t,o);if(!a||e!==n&&a.some(s=>s.code===n))return!1;const l=a.find(s=>s.code===e);return l?(l.code=n,l.price=r,a.sort((s,i)=>s.code.localeCompare(i.code)),se(c),!0):!1}function ye(t,e,n=null){const r=W(),o=z(r,t,n);if(!o)return!1;const c=o.findIndex(a=>a.code===e);return c>-1?(o.splice(c,1),se(r),!0):!1}function fe(t,e,n=null){if(!t||!e)return;const r=W(),o=e.trim(),c=z(r,t,n);return c==null?void 0:c.find(a=>a.code===o)}function Re(t,e,n=null){return!!fe(t,e,n)}function De(t,e,n,r=null){const o=fe(t,e,r);return o&&o.price===n?(ye(t,e,r),!1):(Ne(t,e,n,r),!0)}function Oe(){localStorage.removeItem(pe),console.log("All favorites have been cleared.")}let B=!1,Q=null,te=null,J=!1,E=null;const _e="marnthara.theme";function ve(){const t=localStorage.getItem(_e),e=document.querySelector("#themeToggleBtn");if(!e)return;const n=e.querySelector("i"),r=e.querySelector("span");t==="dark"?(document.body.classList.add("dark-theme"),n&&(n.className="ph-fill ph-sun"),r&&(r.textContent=" Light Mode")):(document.body.classList.remove("dark-theme"),n&&(n.className="ph-fill ph-moon"),r&&(r.textContent=" Dark Mode"))}function He(){document.body.classList.toggle("dark-theme");const t=document.body.classList.contains("dark-theme");localStorage.setItem(_e,t?"dark":"light"),ve()}function g(t,e="default"){const n=document.querySelector(m.toastContainer);if(!n)return;const r={success:"ph-bold ph-check-circle",warning:"ph-bold ph-warning",error:"ph-bold ph-x-circle",default:"ph-bold ph-info"},o=document.createElement("div");o.className=`toast toast-${e}`,o.innerHTML=`<i class="${r[e]||r.default}"></i> ${t}`,n.appendChild(o),setTimeout(()=>o.classList.add("show"),10),setTimeout(()=>{o.classList.remove("show"),o.addEventListener("transitionend",()=>o.remove())},3e3)}function H(t,e){return new Promise(n=>{const r=document.querySelector(t);if(!r){n(null);return}const o=document.querySelector(".modal-wrapper.visible");o&&o.classList.add("is-underlay"),r.classList.add("visible");const c=r.querySelector('[id$="Confirm"]'),a=r.querySelector('[id$="Cancel"], [data-act="close-modal"]'),l=d=>{r.classList.remove("visible"),c&&(c.onclick=null),a&&(a.onclick=null),document.removeEventListener("keydown",s),o&&o.classList.remove("is-underlay"),typeof d=="object"&&d.cancelled&&e&&e(),n(d)},s=d=>{d.key==="Escape"&&!r.classList.contains("is-underlay")&&l({cancelled:!0})},i=()=>{r.classList.contains("is-underlay")||l({cancelled:!0})};c&&(c.onclick=()=>l(!0)),a&&(a.onclick=i),document.addEventListener("keydown",s)})}async function oe(t,e){const n=document.querySelector(m.modal);if(!n)return!0;const r=n.querySelector(m.modalTitle),o=n.querySelector(m.modalBody);return r&&(r.textContent=t),o&&(o.textContent=e),await H(m.modal)}async function We(){const t=document.querySelector(m.exportOptionsModal);if(!t||!await H(m.exportOptionsModal))return null;const n=t.querySelector('input[name="vat_option"]:checked'),r=t.querySelector("#exportMethod"),o=t.querySelector("#pageBreakBuffer");return{vatOption:n?n.value:"include",exportMethod:r?r.value:"direct",pageBreakBuffer:o?parseInt(o.value,10):3}}function G(t,e){t&&(t.classList.add("item-removing"),t.addEventListener("animationend",()=>{t.remove(),e&&g(e),ie(),le(),R(),A(),Y()},{once:!0}))}function le(){document.querySelectorAll(m.room).forEach(t=>{const e=t.querySelectorAll(".item-card"),n=e.length;e.forEach((r,o)=>{const c=r.querySelector("[data-item-title]");c&&(c.textContent=`${o+1}/${n}`)})})}function ge(){const t=document.querySelector(m.orderForm),e=document.querySelector(m.lockBtn);if(!t||!e)return;const n=t.querySelectorAll("input, select, textarea, button");t.classList.toggle("is-locked",B),e.classList.toggle("is-locked",B);const r=e.querySelector("i");r&&(r.className=B?"ph-bold ph-lock-key":"ph-bold ph-lock-key-open"),n.forEach(o=>{o.closest(".summary-footer")||o.closest(".main-header")||o.closest(".modal-wrapper")||(o.disabled=B)}),g(B?"ฟอร์มถูกล็อค":"ปลดล็อคฟอร์มแล้ว",B?"warning":"success")}function V(){const t=document.querySelectorAll(m.allDetailsCards);if(t.length===0)return;const e=[...t].some(r=>r.open),n=document.querySelector(m.toggleAllRoomsBtn);if(n){const r=n.querySelector("i"),o=n.querySelector("span");r&&(r.className=e?"ph ph-rows-slash":"ph ph-rows"),o&&(o.textContent=e?"ย่อทั้งหมด":"ขยายทั้งหมด")}}function Ue(){const t=document.querySelectorAll(m.allDetailsCards),e=[...t].some(n=>n.open);t.forEach(n=>{n.open=!e}),setTimeout(V,50)}function ie(){const t=document.querySelector(m.quickNavRoomList);if(!t)return;t.innerHTML="",document.querySelectorAll(m.room).forEach(n=>{const r=n.querySelector(m.roomNameInput),o=r?r.value:"ห้อง",c=document.createElement("a");c.href=`#${n.id}`,c.dataset.jumpTo=n.id,c.innerHTML=`<i class="ph ph-arrow-bend-left-up"></i> ${o||"ห้อง (ไม่มีชื่อ)"}`,t.appendChild(c)})}function Se(t){const e=document.getElementById("quickNavBtnText");if(e)if(t){const n=t.querySelector('input[name="room_name"]');n&&(e.textContent=n.value||"...")}else e.textContent="ไปยังห้อง"}function Y(){if(te&&te.disconnect(),!document.getElementById("quickNavBtnText"))return;const e={root:null,rootMargin:"-60px 0px -150px 0px",threshold:0},n=o=>{const c=o.filter(a=>a.isIntersecting).sort((a,l)=>a.target.getBoundingClientRect().top-l.target.getBoundingClientRect().top);c.length>0&&Se(c[0].target)};te=new IntersectionObserver(n,e),document.querySelectorAll(m.room).forEach(o=>te.observe(o))}function je(){document.querySelectorAll("[data-favorite-type]").forEach(P)}function me(){const t=document.querySelector('[data-act="edit-selected-fav"]'),e=document.querySelector('[data-act="del-selected-fav"]');if(t&&e){const n=E!==null;t.disabled=!n,e.disabled=!n}}function ne(t,e=null){const n=document.getElementById("favManagerBody");if(!n)return;const r=W();let o=[];if(t==="deco"?o=r.deco[e]||[]:o=r[t]||[],n.innerHTML="",o.length===0)n.innerHTML='<p class="empty-state">ไม่มีรายการโปรดที่บันทึกไว้</p>';else{const c=document.getElementById("favManagerItemTpl").innerHTML;o.forEach(a=>{const l=c.replace(/{CODE}/g,a.code).replace(/{PRICE}/g,T(a.price)).replace(/{RAW_PRICE}/g,a.price),s=document.createElement("div");s.innerHTML=l;const i=s.firstElementChild;i.dataset.type=t,e&&(i.dataset.subType=e),n.appendChild(i)})}E=null,me()}async function Ve(t,e=null){J=!1,E=null;const n=document.getElementById("favManagerTitle");if(!n)return;let r="รายการโปรด";t==="deco"?r=`รายการโปรด: ${e||"ของตกแต่ง"}`:r=`รายการโปรด: ${{fabric:"ผ้าทึบ",sheer:"ผ้าโปร่ง",wallpaper:"วอลเปเปอร์"}[t]||t}`,n.textContent=r,n.dataset.type=t,n.dataset.subType=e||"",ne(t,e),await H("#favManagerModal"),J&&(je(),Q&&we(Q))}async function Ye(){const t=document.querySelector("#favAddModal");if(!t)return null;const e=t.querySelector("#fav_code_add"),n=t.querySelector("#fav_price_add");e.value="",n.value="";const r=await H("#favAddModal");return r&&!r.cancelled?{newCode:e.value.trim(),newPrice:v(n.value)}:null}async function Ge(t){const e=document.querySelector("#favEditModal");if(!e)return null;const n=e.querySelector("#fav_code_edit"),r=e.querySelector("#fav_price_edit");n.value=t.code,r.value=t.price;const o=await H("#favEditModal");return o&&!o.cancelled?{newCode:n.value.trim(),newPrice:v(r.value)}:null}function K(){document.querySelectorAll(".favorite-chips-container.show").forEach(t=>{t.classList.remove("show")}),document.querySelectorAll(".item-card.overflow-visible").forEach(t=>{t.classList.remove("overflow-visible")}),Q=null}function P(t){var l;if(!t||!t.matches("[data-favorite-type]"))return;const e=t.nextElementSibling;if(!e||!e.matches(".btn-favorite"))return;const n=e.dataset.type,r=t.value;if(!r){e.classList.remove("is-favorite"),e.querySelector("i").className="ph ph-star";return}const o=t.closest(".item-card");if(!o)return;let c=null;n==="deco"&&(c=(l=o.querySelector('[name="deco_type"]'))==null?void 0:l.value);const a=Re(n,r,c);e.classList.toggle("is-favorite",a),e.querySelector("i").className=a?"ph-fill ph-star":"ph ph-star"}function we(t){var s,i;K();const e=t.dataset.favoriteType;if(!e)return;let n=null,r=[];const o=W();e==="deco"?(n=(i=(s=t.closest(".item-card"))==null?void 0:s.querySelector('[name="deco_type"]'))==null?void 0:i.value,n&&(r=o.deco[n]||[])):r=o[e]||[];const c=t.closest(".form-group-with-favorites").querySelector(".favorite-chips-container");if(!c)return;c.innerHTML="",r.length>0&&r.forEach(d=>{const u=document.createElement("button");u.type="button",u.className="btn-chip",u.textContent=d.code,u.dataset.act="select-favorite",u.dataset.code=d.code,u.dataset.price=d.price,c.appendChild(u)});const a=document.createElement("button");a.type="button",a.className="btn-manage-favorites",a.dataset.act="manage-favorites",a.dataset.type=e,n&&(a.dataset.subType=n),a.innerHTML='<i class="ph ph-pencil-simple"></i> แก้ไข',c.appendChild(a),c.classList.add("show");const l=t.closest(".item-card");l&&l.classList.add("overflow-visible")}function X(t,e,n=!0){K();const r=document.querySelector(t);if(!r||!e)return null;const o=r.content.cloneNode(!0),c=o.firstElementChild;e.appendChild(o),c.querySelectorAll("input[data-favorite-type]").forEach(P),n&&c&&(c.classList.add("item-created"),c.scrollIntoView({behavior:"smooth",block:"center"}));const a=c.querySelector('input:not([type="hidden"]), select, textarea');return a&&a.focus(),le(),R(),A(),c}function ae(){const t=document.querySelector(m.roomsContainer);if(!t)return;const e=document.querySelectorAll(m.roomNameInput);let n=0;e.forEach(c=>{const a=c.value.match(/\d+/g);if(a){const l=parseInt(a[a.length-1],10);l>n&&(n=l)}});const r=n+1,o=X("#roomTpl",t,!0);if(o){o.id=`room-${Date.now()}`;const c=o.querySelector(m.roomNameInput);c&&(c.value=`ห้อง ${r}`),o.open=!0}ie(),V(),Y()}function Je(t){if(!t)return;const e=t.querySelector(m.setsContainer);e&&X("#setTpl",e)}function Qe(t){if(!t)return;const e=t.querySelector(m.decorationsContainer);e&&X("#decoTpl",e)}function Ke(t){if(!t)return;const e=t.querySelector(m.wallpapersContainer);if(e){const n=X("#wallpaperTpl",e);n&&qe(n.querySelector('[data-act="add-wall"]'))}}function qe(t){var n;const e=(n=t==null?void 0:t.closest(".walls-section"))==null?void 0:n.querySelector(m.wallsContainer);e&&(X("#wallTpl",e,!0),Z(t))}function be(t){var o,c;if(!t)return;const e=(o=t.querySelector('select[name="fabric_variant"]'))==null?void 0:o.value,n=e&&e.includes("โปร่ง");(c=t.querySelector(m.sheerWrap))==null||c.classList.toggle("hidden",!n);const r=t.querySelector('input[name="sheer_fabric_code"]');if(r){const a=r.closest(".form-group-with-favorites");a&&a.classList.toggle("hidden",!n)}}function ze(t,e,n,r=null){let o=0;document.querySelectorAll(`
        [name="fabric_code"], 
        [name="sheer_fabric_code"], 
        [name="deco_code"], 
        [name="wallpaper_code"]
    `).forEach(a=>{var l;if(a.value.trim()===t){const s=a.closest(".item-card");if(!s)return;const i=a.dataset.favoriteType;let d=null;if(i===n){if(n==="deco"&&((l=s.querySelector('[name="deco_type"]'))==null?void 0:l.value)!==r)return;n==="fabric"&&(d=s.querySelector('[name="set_price_per_m"]')),n==="sheer"&&(d=s.querySelector('[name="sheer_price_per_m"]')),n==="deco"&&(d=s.querySelector('[name="deco_price_sqyd"]')),n==="wallpaper"&&(d=s.querySelector('[name="wallpaper_price_roll"]')),a.value=e.newCode,d&&(d.tagName==="SELECT"?d.value=e.newPrice:d.value=T(v(e.newPrice)),a.classList.add("input-highlight"),d.classList.add("input-highlight"),setTimeout(()=>{a.classList.remove("input-highlight"),d.classList.remove("input-highlight")},1500),d.dispatchEvent(new Event("change",{bubbles:!0}))),o++}}}),o>0&&g(`อัปเดต ${o} รายการที่ใช้รหัสนี้แล้ว`,"success")}function Xe(t,e,n=null){document.querySelectorAll(`input[data-favorite-type="${e}"]`).forEach(r=>{var o;if(r.value.trim()===t)if(e==="deco"){const c=r.closest(".item-card");((o=c==null?void 0:c.querySelector('[name="deco_type"]'))==null?void 0:o.value)===n&&P(r)}else P(r)})}const Ze=Ee(t=>{Z(t),A()});function et(t){if(B){g("ฟอร์มถูกล็อค ไม่สามารถแก้ไขได้","warning"),t.preventDefault();return}t.target.matches("input[data-favorite-type]")&&P(t.target),t.target.matches(m.roomNameInput)&&Y(),Ze(t.target)}function tt(t){var c;if(B)return;const e=t.target,n=e.matches('input[name="deco_price_sqyd"]'),r=e.matches('input[name="wallpaper_price_roll"]');if(n||r){const a=e.closest(".item-card");if(a){const l=v(e.value);let s,i,d=null;if(n?(s=a.querySelector('input[name="deco_code"]'),i="deco",d=(c=a.querySelector('select[name="deco_type"]'))==null?void 0:c.value):(s=a.querySelector('input[name="wallpaper_code"]'),i="wallpaper"),s&&s.value&&i){const u=fe(i,s.value,d);u&&u.price!==l&&(s.value="")}}}if(e.matches('select[name="fabric_variant"]')&&be(e.closest(m.set)),e.matches('select[name="deco_type"]')){const a=e.closest(m.decoItem);if(a){const l=a.querySelector(".deco-type-display");l&&(l.textContent=e.value||"ตกแต่ง");const s=a.querySelector('input[name="deco_code"]');s&&P(s)}}if(e.matches(m.roomNameInput)&&(ie(),Y()),["set_price_per_m","sheer_price_per_m","deco_price_sqyd","wallpaper_price_roll"].includes(e.name)){const a=e.closest(".item-card");if(a){let l;e.name==="set_price_per_m"&&(l=a.querySelector('[name="fabric_code"]')),e.name==="sheer_price_per_m"&&(l=a.querySelector('[name="sheer_fabric_code"]')),e.name==="deco_price_sqyd"&&(l=a.querySelector('[name="deco_code"]')),e.name==="wallpaper_price_roll"&&(l=a.querySelector('[name="wallpaper_code"]')),l&&P(l)}}Z(e),A()}function rt(t){const e=t.target,n=e.matches('[name="deco_price_sqyd"], [name="wallpaper_price_roll"], [name="wallpaper_install_cost"], [name="fav_price_edit"], [name="fav_price_add"]'),r=e.matches('input[name="width_m"], input[name="height_m"], input[name="deco_width_m"], input[name="deco_height_m"], input[name="wallpaper_height_m"], input[name="wall_width_m"]');if(n){const o=v(e.value);o>0?e.value=T(o):e.value=""}else r&&(e.value=O(e.value))}function ot(t){const e=t.target;e.matches("input[data-favorite-type]")&&(Q=e,we(e))}function Z(t){var o,c,a,l,s,i,d,u,p,f,y,w;if(!t)return;const e=t.closest(m.set);if(e){const S=e.querySelector("[data-set-summary]");if(S){const h={width_m:(o=e.querySelector('input[name="width_m"]'))==null?void 0:o.value,height_m:(c=e.querySelector('input[name="height_m"]'))==null?void 0:c.value,style:(a=e.querySelector('select[name="set_style"]'))==null?void 0:a.value,fabric_variant:(l=e.querySelector('select[name="fabric_variant"]'))==null?void 0:l.value,price_per_m_raw:(s=e.querySelector('select[name="set_price_per_m"]'))==null?void 0:s.value,sheer_price_per_m:(i=e.querySelector('select[name="sheer_price_per_m"]'))==null?void 0:i.value},q=L.calculateSetPrice(h);let _=`ราคา: <b>${T(q.total)}</b> บ.`;q.opaque>0&&q.sheer>0&&(_+=` <small>(ทึบ: ${T(q.opaque)}, โปร่ง: ${T(q.sheer)})</small>`),S.innerHTML=_}}const n=t.closest(m.decoItem);if(n){const S=n.querySelector("[data-deco-summary]");if(S){const h={width_m:(d=n.querySelector('input[name="deco_width_m"]'))==null?void 0:d.value,height_m:(u=n.querySelector('input[name="deco_height_m"]'))==null?void 0:u.value,price_sqyd:(p=n.querySelector('input[name="deco_price_sqyd"]'))==null?void 0:p.value},q=L.calculateDecoPrice(h);S.innerHTML=`ราคา: <b>${T(q.total)}</b> บ. &bull; พื้นที่: ${M(q.sqyd,2)} ตร.หลา`}}const r=t.closest(m.wallpaperItem);if(r){const S=r.querySelector("[data-wallpaper-summary]");if(S){const h={height_m:(f=r.querySelector('input[name="wallpaper_height_m"]'))==null?void 0:f.value,price_per_roll:(y=r.querySelector('input[name="wallpaper_price_roll"]'))==null?void 0:y.value,install_cost_per_roll:(w=r.querySelector('input[name="wallpaper_install_cost"]'))==null?void 0:w.value,widths:Array.from(r.querySelectorAll('input[name="wall_width_m"]')).map(N=>N.value)},q=L.calculateWallpaperPrice(h);let _=`รวม: <b>${T(q.total)}</b> บ. `;(q.material>0||q.install>0)&&(_+=`<small>(วอลล์: ${T(q.material)}, ค่าช่าง: ${T(q.install)})</small>`),_+=` &bull; พื้นที่: ${M(q.sqm,2)} ตร.ม. &bull; ใช้: ${q.rolls} ม้วน`,S.innerHTML=_}}R()}function R(){let t=0,e=0;document.querySelectorAll(m.room).forEach(o=>{let c=0,a=0;const l=o.classList.contains("is-suspended");o.querySelectorAll(m.set).forEach(i=>{var u,p,f,y,w,S;const d=L.calculateSetPrice({is_suspended:l||i.classList.contains("is-suspended"),width_m:(u=i.querySelector('input[name="width_m"]'))==null?void 0:u.value,height_m:(p=i.querySelector('input[name="height_m"]'))==null?void 0:p.value,style:(f=i.querySelector('select[name="set_style"]'))==null?void 0:f.value,fabric_variant:(y=i.querySelector('select[name="fabric_variant"]'))==null?void 0:y.value,price_per_m_raw:(w=i.querySelector('select[name="set_price_per_m"]'))==null?void 0:w.value,sheer_price_per_m:(S=i.querySelector('select[name="sheer_price_per_m"]'))==null?void 0:S.value}).total;c+=d,d>0&&(e++,a++)}),o.querySelectorAll(m.decoItem).forEach(i=>{var u,p,f;const d=L.calculateDecoPrice({is_suspended:l||i.classList.contains("is-suspended"),width_m:(u=i.querySelector('input[name="deco_width_m"]'))==null?void 0:u.value,height_m:(p=i.querySelector('input[name="deco_height_m"]'))==null?void 0:p.value,price_sqyd:(f=i.querySelector('input[name="deco_price_sqyd"]'))==null?void 0:f.value}).total;c+=d,d>0&&(e++,a++)}),o.querySelectorAll(m.wallpaperItem).forEach(i=>{var u,p,f;const d=L.calculateWallpaperPrice({is_suspended:l||i.classList.contains("is-suspended"),height_m:(u=i.querySelector('input[name="wallpaper_height_m"]'))==null?void 0:u.value,price_per_roll:(p=i.querySelector('input[name="wallpaper_price_roll"]'))==null?void 0:p.value,install_cost_per_roll:(f=i.querySelector('input[name="wallpaper_install_cost"]'))==null?void 0:f.value,widths:Array.from(i.querySelectorAll('input[name="wall_width_m"]')).map(y=>y.value)}).total;c+=d,d>0&&(e++,a++)});const s=o.querySelector("[data-room-brief]");s&&(l?s.textContent="(ระงับชั่วคราว)":a>0?s.innerHTML=`<span>${a}</span> &bull; ${T(c)} บาท`:s.textContent=""),t+=l?0:c});const n=document.querySelector(m.grandTotal),r=document.querySelector(m.setCount);n&&(n.textContent=T(t)),r&&(r.textContent=e)}function he(t){if(!t||!t.rooms)return;const e=document.querySelector(m.roomsContainer);if(!e)return;e.innerHTML="";const n=document.querySelector("#customer_name"),r=document.querySelector("#customer_phone"),o=document.querySelector("#customer_address");n&&(n.value=t.customer_name||""),r&&(r.value=t.customer_phone||""),o&&(o.value=t.customer_address||""),t.rooms.forEach(c=>{const a=document.querySelector("#roomTpl");if(!a)return;const l=a.content.cloneNode(!0),s=l.querySelector(m.room);if(!s)return;s.id=c.id||`room-${Date.now()}`,c.is_suspended&&s.classList.add("is-suspended");const i=s.querySelector(m.roomNameInput);i&&(i.value=c.room_name||"ห้อง (ไม่มีชื่อ)");const d=s.querySelector(m.setsContainer),u=s.querySelector(m.decorationsContainer),p=s.querySelector(m.wallpapersContainer),f=document.querySelector("#setTpl"),y=document.querySelector("#decoTpl"),w=document.querySelector("#wallpaperTpl"),S=document.querySelector("#wallTpl");d&&f&&c.sets&&c.sets.forEach(h=>{const q=f.content.cloneNode(!0),_=q.querySelector(m.set);h.is_suspended&&_.classList.add("is-suspended"),_.querySelector('input[name="width_m"]').value=O(h.width_m),_.querySelector('input[name="height_m"]').value=O(h.height_m),_.querySelector('select[name="set_style"]').value=h.style||"ลอน",_.querySelector('select[name="fabric_variant"]').value=h.fabric_variant||"ทึบ",_.querySelector('select[name="set_price_per_m"]').value=h.price_per_m_raw||"",_.querySelector('select[name="sheer_price_per_m"]').value=h.sheer_price_per_m||"",_.querySelector('select[name="opening_style"]').value=h.opening_style||"แยกกลาง",_.querySelector('select[name="track_color"]').value=h.track_color||"ขาว",_.querySelector('input[name="fabric_code"]').value=h.fabric_code||"",_.querySelector('input[name="sheer_fabric_code"]').value=h.sheer_fabric_code||"",_.querySelector('input[name="notes"]').value=h.notes||"",be(_),d.appendChild(q)}),u&&y&&c.decorations&&c.decorations.forEach(h=>{const q=y.content.cloneNode(!0),_=q.querySelector(m.decoItem);h.is_suspended&&_.classList.add("is-suspended");const N=_.querySelector('select[name="deco_type"]');N.value=h.type||"",_.querySelector(".deco-type-display").textContent=h.type||"ตกแต่ง",_.querySelector('input[name="deco_width_m"]').value=O(h.width_m),_.querySelector('input[name="deco_height_m"]').value=O(h.height_m),_.querySelector('input[name="deco_price_sqyd"]').value=T(h.price_sqyd)||"",_.querySelector('input[name="deco_code"]').value=h.deco_code||"",_.querySelector('input[name="deco_notes"]').value=h.notes||"",u.appendChild(q)}),p&&w&&c.wallpapers&&c.wallpapers.forEach(h=>{const q=w.content.cloneNode(!0),_=q.querySelector(m.wallpaperItem);h.is_suspended&&_.classList.add("is-suspended"),_.querySelector('input[name="wallpaper_height_m"]').value=O(h.height_m),_.querySelector('input[name="wallpaper_code"]').value=h.wallpaper_code||"",_.querySelector('input[name="wallpaper_price_roll"]').value=T(h.price_per_roll)||"",_.querySelector('input[name="wallpaper_install_cost"]').value=h.hasOwnProperty("install_cost_per_roll")?T(h.install_cost_per_roll):"300",_.querySelector('input[name="wallpaper_notes"]').value=h.notes||"";const N=_.querySelector(m.wallsContainer);N&&S&&h.widths&&h.widths.forEach($=>{const C=S.content.cloneNode(!0);C.querySelector('input[name="wall_width_m"]').value=O($),N.appendChild(C)}),p.appendChild(q)}),e.appendChild(l)}),document.querySelectorAll("input[data-favorite-type]").forEach(P),document.querySelectorAll(".item-card").forEach(c=>{Z(c)}),le(),R(),ie(),V(),Y(),g("นำเข้าข้อมูลสำเร็จ","success")}function nt(t){if(document.getElementById("loading-overlay"))return;const e=document.createElement("div");e.id="loading-overlay",e.innerHTML=`<div class="loading-spinner"></div><p>${t}</p>`,document.body.appendChild(e),document.body.style.overflow="hidden"}function at(){const t=document.getElementById("loading-overlay");t&&t.remove(),document.body.style.overflow=""}async function ct(t,e){const n=document.querySelector(m.printableContent);if(!n||!t||!t.html){g("ไม่พบข้อมูลสำหรับสร้างเอกสาร","error");return}if(e==="direct"){nt("กำลังสร้าง PDF...");const r=document.createElement("div");r.style.position="fixed",r.style.left="-300mm",r.style.top="0",r.style.width="210mm",r.style.background="#fff",r.innerHTML=t.html,document.body.appendChild(r),await new Promise(o=>setTimeout(o,1e3));try{const o=r.querySelectorAll(".pdf-page");if(o.length===0)throw new Error("No pages found to generate.");const c={image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0,logging:!1,width:o[0].scrollWidth,windowWidth:o[0].scrollWidth},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}},a=await html2pdf().from(o[0]).set(c).toPdf().get("pdf");if(o.length>1)for(let l=1;l<o.length;l++){a.addPage();const i=(await html2canvas(o[l],c.html2canvas)).toDataURL(c.image.type,c.image.quality),d=a.internal.pageSize.getWidth(),u=a.internal.pageSize.getHeight();a.addImage(i,"JPEG",0,0,d,u)}a.save(`${t.fileName}.pdf`),g("ดาวน์โหลด PDF สำเร็จ","success")}catch(o){console.error("PDF Generation Error:",o),g("สร้าง PDF ล้มเหลว, โปรดลองวิธีที่ 2 (พิมพ์)","error")}finally{at(),document.body.removeChild(r)}}e==="print"&&(n.innerHTML=t.html,setTimeout(()=>{window.print(),setTimeout(()=>{n.innerHTML=""},1e3)},$e))}function st(t){if(!t||!t.html){g("ไม่พบข้อมูลสำหรับสร้างไฟล์ HTML","error");return}try{const e=`
            <!DOCTYPE html><html lang="th"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>${t.fileName}</title>
                <link rel="stylesheet" href="https://grobmak.github.io/marnthara-form/src/style.css">
                <style>#printable-content { display: block !important; } .pdf-page { border: 1px solid #eee; box-shadow: 0 0 10px rgba(0,0,0,0.1); margin: 10mm auto; }</style>
            </head>
            <body>${t.html}</body></html>`,n=new Blob([e],{type:"text/html;charset=utf-8"}),r=URL.createObjectURL(n),o=document.createElement("a");o.href=r,o.download=`${t.fileName}.html`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(r),g("ดาวน์โหลดไฟล์ HTML สำเร็จ","success")}catch(e){console.error("HTML Export Error:",e),g("สร้างไฟล์ HTML ล้มเหลว","error")}}const lt=async t=>{var a,l,s;const e=t.target.closest("[data-act]"),n=t.target.closest(".fav-manager-item");if(n&&!e&&n.closest("#favManagerBody")){E===n?(E.classList.remove("is-selected"),E=null):(E&&E.classList.remove("is-selected"),n.classList.add("is-selected"),E=n),me();return}if(!e||B&&!e.closest(".unlockable")&&!["select-favorite","manage-favorites","close-modal","add-new-fav-form","edit-selected-fav","del-selected-fav"].includes(e.dataset.act))return;const r=e.dataset.act,o=e.closest(m.room),c=(i,d,u)=>{oe(i,d).then(p=>{p===!0&&u()})};switch(r){case"add-room":ae();break;case"add-set":Je(o);break;case"add-deco":Qe(o);break;case"add-wallpaper":Ke(o);break;case"add-wall":qe(e);break;case"del-room":c("ลบห้อง","ยืนยันการลบห้องนี้?",()=>G(o,"ลบห้องแล้ว"));break;case"del-set":c("ลบรายการ","ยืนยันการลบรายการผ้าม่าน?",()=>G(e.closest(m.set),"ลบรายการผ้าม่านแล้ว"));break;case"del-deco":c("ลบรายการ","ยืนยันการลบรายการตกแต่ง?",()=>G(e.closest(m.decoItem),"ลบรายการตกแต่งแล้ว"));break;case"del-wallpaper":c("ลบรายการ","ยืนยันการลบรายการวอลเปเปอร์?",()=>G(e.closest(m.wallpaperItem),"ลบรายการวอลเปเปอร์แล้ว"));break;case"del-wall":c("ลบผนัง","ยืนยันการลบผนังนี้?",()=>G(e.closest(".wall-input-row"),"ลบผนังแล้ว"));break;case"clear-room":c("ล้างข้อมูลในห้อง","ยืนยันลบทุกรายการในห้องนี้?",()=>{o.querySelector(m.setsContainer).innerHTML="",o.querySelector(m.decorationsContainer).innerHTML="",o.querySelector(m.wallpapersContainer).innerHTML="",le(),R(),A(),g("ล้างข้อมูลในห้องแล้ว","success")});break;case"toggle-room-menu":t.preventDefault();const i=e.nextElementSibling;if(!i||!o)return;const d=!i.classList.contains("show");document.querySelectorAll(".room-options-menu.show").forEach(u=>u.classList.remove("show")),document.querySelectorAll(".card.overflow-visible").forEach(u=>u.classList.remove("overflow-visible")),d&&(i.classList.add("show"),o.classList.add("overflow-visible"));break;case"toggle-suspend-room":t.preventDefault(),o==null||o.classList.toggle("is-suspended"),R(),A(),(a=e.closest(".room-options-menu"))==null||a.classList.remove("show"),o==null||o.classList.remove("overflow-visible");break;case"toggle-suspend":t.preventDefault(),(l=e.closest(".item-card"))==null||l.classList.toggle("is-suspended"),Z(e),A();break;case"toggle-favorite":{const u=e.dataset.type,p=e.previousElementSibling,f=p==null?void 0:p.value;if(!f||f.trim()===""){g("กรุณากรอกรหัสก่อนบันทึก","warning");return}const y=e.closest(".item-card");if(!y)return;let w=0,S=null,h=null;if(u==="fabric"&&(S=y.querySelector('[name="set_price_per_m"]')),u==="sheer"&&(S=y.querySelector('[name="sheer_price_per_m"]')),u==="wallpaper"&&(S=y.querySelector('[name="wallpaper_price_roll"]')),u==="deco"&&(S=y.querySelector('[name="deco_price_sqyd"]'),h=(s=y.querySelector('[name="deco_type"]'))==null?void 0:s.value,!h)){g("กรุณาเลือกประเภทของตกแต่งก่อนบันทึก","warning");return}if(S&&S.value&&(w=v(S.value)),w<=0){g("กรุณากรอกราคาก่อนบันทึกเป็นรายการโปรด","warning");return}const q=De(u,f,w,h);P(p),g(q?"บันทึกรหัสโปรดแล้ว":"ลบรหัสโปรดแล้ว","success");break}case"select-favorite":{const u=e.dataset.code,p=e.dataset.price,f=e.closest(".form-group-with-favorites"),y=f?f.querySelector("input[data-favorite-type]"):Q;if(y){y.value=u;const w=e.closest(".item-card");if(w&&p){const S=y.dataset.favoriteType;let h=null;S==="fabric"&&(h=w.querySelector('[name="set_price_per_m"]')),S==="sheer"&&(h=w.querySelector('[name="sheer_price_per_m"]')),S==="deco"&&(h=w.querySelector('[name="deco_price_sqyd"]')),S==="wallpaper"&&(h=w.querySelector('[name="wallpaper_price_roll"]')),h&&(h.tagName==="SELECT"?h.value=p:h.value=T(v(p)),h.classList.add("input-highlight"),setTimeout(()=>h.classList.remove("input-highlight"),1200),h.dispatchEvent(new Event("change",{bubbles:!0})))}y.dispatchEvent(new Event("input",{bubbles:!0})),K(),g(`เลือกโค้ด ${u} แล้ว`,"success")}break}case"manage-favorites":{K();const u=e.dataset.type,p=e.dataset.subType||null;if(u==="deco"&&!p){g("กรุณาเลือกประเภทของตกแต่งก่อน","warning");return}Ve(u,p);break}case"del-selected-fav":{if(!E)return;const{type:u,subType:p,code:f}=E.dataset;c("ลบรายการโปรด",`ยืนยันการลบ "${f}"?`,()=>{ye(u,f,p)&&(J=!0,E.remove(),E=null,me(),g("ลบรายการโปรดแล้ว","success"),Xe(f,u,p),document.querySelector(".fav-manager-item")||ne(u,p))});break}case"edit-selected-fav":{if(!E)return;const{type:u,subType:p,code:f,price:y}=E.dataset,w=await Ge({code:f,price:y});if(w){if(!w.newCode){g("รหัสห้ามว่าง","error");return}Ae(u,f,w.newCode,w.newPrice,p)?(J=!0,g("อัปเดตรายการแล้ว","success"),ne(u,p),ze(f,w,u,p)):g("อัปเดตล้มเหลว รหัสอาจซ้ำซ้อน","error")}break}case"add-new-fav-form":{const{type:u,subType:p}=document.getElementById("favManagerTitle").dataset,f=await Ye();if(f){if(!f.newCode){g("กรุณากรอกรหัส","error");return}if(f.newPrice<=0){g("กรุณากรอกราคา","error");return}Fe(u,f.newCode,f.newPrice,p)?(J=!0,g("เพิ่มรายการใหม่สำเร็จ","success"),ne(u,p)):g("เพิ่มล้มเหลว รหัสอาจซ้ำ","error")}break}}};function it(){B=!B,ge()}function dt(){const t=document.querySelector(m.setTpl);if(!t)return;const e=t.content.querySelector('select[name="set_price_per_m"]'),n=t.content.querySelector('select[name="sheer_price_per_m"]'),r=o=>{let c='<option value="" hidden>เลือกราคา</option>';return o.forEach(a=>{c+=`<option value="${a}">${a.toLocaleString("th-TH")}</option>`}),c};e&&(e.innerHTML=r(ce.fabric)),n&&(n.innerHTML=r(ce.sheer))}function ut(){dt(),ve();const t=document.querySelector(m.orderForm),e=document.querySelector(m.fileImporter),n=document.querySelector(m.menuDropdown),r=document.querySelector(m.quickNavDropdown),o=document.querySelector("#pageBreakBuffer"),c=document.querySelector("#pageBreakBufferValue");o&&c&&o.addEventListener("input",()=>{c.textContent=o.value}),t.addEventListener("input",et),t.addEventListener("change",tt),document.addEventListener("click",lt),t.addEventListener("blur",rt,!0),t.addEventListener("focusin",ot);const a=s=>{const i=s.target.closest(m.room);i&&Se(i)};t.addEventListener("click",a),t.addEventListener("focusin",a),document.body.addEventListener("click",s=>{s.target.closest("summary")&&setTimeout(V,50)}),document.querySelector(m.lockBtn).addEventListener("click",it),document.querySelector(m.toggleAllRoomsBtn).addEventListener("click",Ue),document.querySelector(m.quickNavBtn).addEventListener("click",s=>{s.stopPropagation(),n.classList.remove("show"),r.classList.toggle("show")}),document.querySelector(m.quickNavRoomList).addEventListener("click",s=>{const i=s.target.closest("a[data-jump-to]");if(i){s.preventDefault();const d=i.dataset.jumpTo,u=document.getElementById(d);u&&(document.body.classList.add("disable-animations"),u.open=!0,u.scrollIntoView({behavior:"auto",block:"start"}),u.classList.add("scrolling-jump"),setTimeout(()=>{u.classList.remove("scrolling-jump"),document.body.classList.remove("disable-animations"),V()},1e3)),r.classList.remove("show")}});const l=document.querySelector("#addRoomQuickNavBtn");if(l){const s=ke(ae,700);l.addEventListener("click",i=>{i.stopPropagation(),s(),r.classList.remove("show")})}document.querySelector(m.menuBtn).addEventListener("click",s=>{s.stopPropagation(),r.classList.remove("show"),n.classList.toggle("show")}),document.querySelector("#themeToggleBtn").addEventListener("click",s=>{s.preventDefault(),He()}),document.querySelector("#overviewBtn").addEventListener("click",async s=>{s.preventDefault(),n.classList.remove("show");const i=j(),d=Me(i),u=document.querySelector("#overviewModalBody");u&&(u.innerHTML=d,H("#overviewModal",()=>{}))}),document.querySelector(m.exportPdfBtn).addEventListener("click",async s=>{s.preventDefault(),n.classList.remove("show");const i=await We();if(!i)return;const d=j(),u=i.vatOption==="include"?I.baseVatRate:0,p=Pe(d,{vatRate:u,pageBreakBuffer:i.pageBreakBuffer});if(!p){g("ไม่มีรายการที่มีราคาสำหรับสร้างเอกสาร","warning");return}i.exportMethod==="html"?st(p):await ct(p,i.exportMethod)}),document.querySelector(m.importBtn).addEventListener("click",s=>{s.preventDefault(),n.classList.remove("show"),e.click()}),e.addEventListener("change",s=>{var u;const i=(u=s.target.files)==null?void 0:u[0];if(!i)return;const d=new FileReader;d.onload=p=>{try{const f=JSON.parse(p.target.result);he(f)}catch{g("ไฟล์ JSON ไม่ถูกต้อง","error")}},d.readAsText(i),s.target.value=null}),document.querySelector(m.exportBtn).addEventListener("click",s=>{s.preventDefault(),n.classList.remove("show");try{const i=j(),d=JSON.stringify(i,null,4),u=new Blob([d],{type:"application/json"}),p=URL.createObjectURL(u),f=document.createElement("a"),y=new Date,w=`${y.getFullYear()}${(y.getMonth()+1).toString().padStart(2,"0")}${y.getDate().toString().padStart(2,"0")}`,S=(i.customer_name||"data").trim().replace(/\s+/g,"-");f.href=p,f.download=`MTR-${S}-${w}.json`,f.click(),URL.revokeObjectURL(p),g("Export ข้อมูลสำเร็จ","success")}catch{g("Export ข้อมูลล้มเหลว","error")}}),document.querySelector(m.submitBtn).addEventListener("click",async s=>{if(s.preventDefault(),n.classList.remove("show"),await oe("ส่งข้อมูล","ยืนยันการส่งข้อมูลการประเมินราคา?")){const i=j();if(!i.customer_name&&!i.customer_phone){g("กรุณาระบุชื่อหรือเบอร์โทรลูกค้า","warning");return}g("กำลังส่งข้อมูล...","default");try{const d=await fetch(Te,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});d.ok?g("ส่งข้อมูลสำเร็จ!","success"):g(`ส่งข้อมูลล้มเหลว: ${d.status}`,"error")}catch{g("เกิดข้อผิดพลาดในการเชื่อมต่อ","error")}}}),document.querySelector(m.copyTextBtn).addEventListener("click",async s=>{s.preventDefault(),n.classList.remove("show");const i=document.querySelector(m.copyOptionsModal);if(i.querySelector('input[name="copy_option"][value="customer"]').checked=!0,await H(m.copyOptionsModal)){const d=i.querySelector('input[name="copy_option"]:checked').value,u=Be(j(),d);try{await navigator.clipboard.writeText(u),g("คัดลอกสรุปสำเร็จ!","success")}catch{g("คัดลอกล้มเหลว","error")}}}),document.querySelector(m.clearItemsBtn).addEventListener("click",async s=>{s.preventDefault(),n.classList.remove("show"),await oe("ล้างทุกรายการ","คุณแน่ใจหรือไม่ว่าต้องการลบรายการสินค้าทั้งหมด (ข้อมูลลูกค้าและห้องจะยังคงอยู่)?")&&(document.querySelectorAll(m.room).forEach(i=>{i.querySelector(m.setsContainer).innerHTML="",i.querySelector(m.decorationsContainer).innerHTML="",i.querySelector(m.wallpapersContainer).innerHTML=""}),R(),A(),g("ล้างทุกรายการแล้ว","success"))}),document.querySelector(m.clearAllBtn).addEventListener("click",async s=>{s.preventDefault(),n.classList.remove("show"),await oe("ลบข้อมูลทั้งหมด","คุณแน่ใจหรือไม่ว่าต้องการลบข้อมูลทั้งหมดในฟอร์มนี้? การกระทำนี้ไม่สามารถย้อนกลับได้")&&(localStorage.removeItem(re),localStorage.removeItem("marnthara.theme"),Oe(),window.location.reload())}),window.addEventListener("click",s=>{s.target.closest(".menu-container")||(n.classList.remove("show"),r.classList.remove("show")),s.target.closest(".room-options-container")||(document.querySelectorAll(".room-options-menu.show").forEach(i=>i.classList.remove("show")),document.querySelectorAll(".card.overflow-visible").forEach(i=>i.classList.remove("overflow-visible"))),s.target.closest(".form-group-with-favorites")||K()});try{const s=localStorage.getItem(re);if(s)he(JSON.parse(s));else{ae();const i=document.querySelector("#customerDetailsCard");i&&(i.open=!0)}}catch{localStorage.removeItem(re),ae()}R(),ge(),V(),Y()}document.addEventListener("DOMContentLoaded",ut);
