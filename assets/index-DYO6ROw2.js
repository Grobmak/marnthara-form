(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function r(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(n){if(n.ep)return;n.ep=!0;const s=r(n);fetch(n.href,s)}})();const Ye="input-ui/5.7.0",Ge="https://your-make-webhook-url.com/your-unique-path",me="marnthara.input.v5",Je=500,N={name:"ม่านธารา ผ้าม่านและของตกแต่ง",address:"65/8 หมู่ 2 ต.ท่าศาลา อ.เมือง จ.ลพบุรี 15000",phone:"092-985-9395, 082-552-5595",taxId:"1234567890123",logoUrl:"./assets/logo.png",baseVatRate:.07,pdf:{paymentTerms:"ชำระมัดจำ 50%",priceValidity:"30 วัน",notes:["ราคานี้รวมค่าติดตั้งแล้ว","ชำระมัดจำ 50% เพื่อยืนยันการสั่งผลิตสินค้า","ใบเสนอราคานี้มีอายุ 30 วัน นับจากวันที่เสนอราคา"]}},Ke=1.19599,be={ROLL_WIDTH_M:.53,ROLL_LENGTH_M:10,STRIPS_PER_ROLL_UNDER_2_5M:3},ve={fabric:[1e3,1100,1200,1300,1400,1500,1600,1700,1800,1900,2e3,2100,2200],sheer:[1e3,1100,1200,1300,1400,1500],style_surcharge:{ลอน:200,ตาไก่:0,จีบ:0},height:[{threshold:3.2,add_per_m:300},{threshold:2.8,add_per_m:200},{threshold:2.5,add_per_m:100}]},v={orderForm:"#orderForm",roomsContainer:"#rooms",setTpl:"#setTpl",wallTpl:"#wallTpl",clearAllBtn:"#clearAllBtn",lockBtn:"#lockBtn",grandTotal:"#grandTotal",modal:"#confirmationModal",modalTitle:"#modalTitle",modalBody:"#modalBody",room:"[data-room]",allItemsContainer:"[data-all-items]",wallsContainer:"[data-walls-container]",sheerWrap:"[data-sheer-wrap]",sheerCodeWrap:"[data-sheer-code-wrap]",roomNameInput:'input[name="room_name"]',toastContainer:"#toast-container",copyTextBtn:"#copyTextBtn",copyOptionsModal:"#copyOptionsModal",menuBtn:"#menuBtn",menuDropdown:"#menuDropdown",importBtn:"#importBtn",exportBtn:"#exportBtn",fileImporter:"#fileImporter",submitBtn:"#submitBtn",clearItemsBtn:"#clearItemsBtn",exportPdfBtn:"#exportPdfBtn",exportOptionsModal:"#exportOptionsModal",printableContent:"#printable-content",quickNavBtn:"#quickNavBtn",quickNavDropdown:"#quickNavDropdown",quickNavRoomList:"#quickNavRoomList",toggleAllRoomsBtn:"#toggleAllRoomsBtn"},g=e=>{typeof e=="string"&&(e=e.replace(/,/g,""));const t=parseFloat(e);return Number.isFinite(t)?t:0},z=e=>{const t=g(e);return t>0?t.toFixed(2):""},O=(e,t=2,r=!1)=>Number.isFinite(e)?e.toLocaleString("en-US",{minimumFractionDigits:r?2:t,maximumFractionDigits:r?2:t}):"0",x=(e,t=0)=>Number.isFinite(e)?e.toLocaleString("th-TH",{minimumFractionDigits:t,maximumFractionDigits:t}):"0",Qe=(e,t=150)=>{let r;return(...o)=>{clearTimeout(r),r=setTimeout(()=>e(...o),t)}},ze=(e,t=700)=>{let r=!1;return(...o)=>{if(!r){r=!0;try{return e(...o)}finally{setTimeout(()=>{r=!1},t)}}}},k=e=>typeof e!="string"?"":e.replace(/[&<>"']/g,function(t){switch(t){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";default:return"&#039;"}}),Oe=e=>typeof e!="string"?"":e.replace(/[\\/?%*:|"<>\x00-\x1f]/g,"").trim()||"file";function Xe(e){let t=g(e);if(isNaN(t))return"ข้อมูลตัวเลขไม่ถูกต้อง";if(t===0)return"ศูนย์บาทถ้วน";const r=["","หนึ่ง","สอง","สาม","สี่","ห้า","หก","เจ็ด","แปด","เก้า"],o=["","สิบ","ร้อย","พัน","หมื่น","แสน","ล้าน"];let n=Math.floor(t),s=Math.round((t-n)*100);const a=l=>{if(l===0)return"";let i="";const m=String(l);for(let d=0;d<m.length;d++){const y=m[d];m.length-1;const u=m.length-d-1;y!=="0"&&(u===1&&y==="1"?i+=o[u]:u===1&&y==="2"?i+="ยี่"+o[u]:u===0&&y==="1"&&m.length>1?i+="เอ็ด":i+=r[parseInt(y)]+o[u])}return i};let c="";if(n>0){const l=Math.floor(n/1e6),i=n%1e6;l>0&&(c+=a(l)+"ล้าน"),c+=a(i),c+="บาท"}let p="";return s>0?p=a(s)+"สตางค์":c+="ถ้วน",(c+p).trim()}const Ie="marnthara.favorites.v4",fe={fabric:[],sheer:[],wallpaper:[],wooden_blind:[],roller_blind:[],vertical_blind:[],partition:[],pleated_screen:[],aluminum_blind:[]};function K(){try{const e=localStorage.getItem(Ie);return e?{...fe,...JSON.parse(e)}:fe}catch(e){return console.error("Failed to parse favorites from localStorage",e),fe}}function _e(e){try{localStorage.setItem(Ie,JSON.stringify(e))}catch(t){console.error("Failed to save favorites to localStorage",t)}}function Ce(e){if(!e||typeof e!="object")return console.error("Invalid favorites data for import."),!1;const t={...fe,...e};return _e(t),!0}function He(e){if(!e||typeof e!="object")return console.error("Invalid favorites data for merge."),0;const t=K();let r=0;for(const o in e)Object.hasOwnProperty.call(e,o)&&Array.isArray(e[o])&&(t[o]||(t[o]=[]),e[o].forEach(n=>{!t[o].some(a=>a.code===n.code)&&n.code&&(t[o].push(n),r++)}),t[o].sort((n,s)=>n.code.localeCompare(s.code)));return r>0&&_e(t),r}function Ze(e,t,r){const o=K();o[e]||(o[e]=[]);const n=o[e],s=n.find(a=>a.code===t);return s?s.price=r:n.push({code:t,price:r}),n.sort((a,c)=>a.code.localeCompare(c.code)),_e(o),!0}function Te(e,t){const r=K();if(!r[e])return!1;const o=r[e].findIndex(n=>n.code===t);return o>-1?(r[e].splice(o,1),_e(r),!0):!1}function Me(e,t){if(!e||!t)return;const r=K(),o=t.trim();return(r[e]||[]).find(s=>s.code===o)}function et(e,t){return!!Me(e,t)}function we(e,t,r){const o=Me(e,t);return o&&o.price===r?(Te(e,t),!1):(Ze(e,t,r),!0)}function tt(){localStorage.removeItem(Ie),console.log("All favorites have been cleared.")}function D(){var r,o,n,s,a,c;const e=K(),t={app_version:Ye,customer_name:((r=document.querySelector('[name="customer_name"]'))==null?void 0:r.value)||"",customer_phone:((o=document.querySelector('[name="customer_phone"]'))==null?void 0:o.value)||"",customer_address:((n=document.querySelector('[name="customer_address"]'))==null?void 0:n.value)||"",customer_card_open:(s=document.querySelector("#customerDetailsCard"))==null?void 0:s.open,discount:{type:((a=document.querySelector("#discount_type"))==null?void 0:a.value)||"amount",value:g((c=document.querySelector("#discount_value"))==null?void 0:c.value)},rooms:[],favorites:e};return document.querySelectorAll(v.room).forEach(p=>{var i,m;const l={id:p.id,room_name:((i=p.querySelector(v.roomNameInput))==null?void 0:i.value)||"",is_suspended:p.classList.contains("is-suspended"),is_open:p.open,items:[]};(m=p.querySelector(v.allItemsContainer))==null||m.childNodes.forEach(d=>{var _,f,h,w,L,q,S,$,B,A,C,T,I,M,j,F,Y,Q,ee,R,ue;if(d.nodeType!==1||!d.matches(".item-card"))return;const y=d.dataset.type;if(!y)return;let u={type:y,is_suspended:d.classList.contains("is-suspended")};y==="set"?Object.assign(u,{width_m:g((_=d.querySelector('input[name="width_m"]'))==null?void 0:_.value),height_m:g((f=d.querySelector('input[name="height_m"]'))==null?void 0:f.value),style:((h=d.querySelector('select[name="set_style"]'))==null?void 0:h.value)||"",fabric_variant:((w=d.querySelector('select[name="fabric_variant"]'))==null?void 0:w.value)||"",price_per_m_raw:g((L=d.querySelector('select[name="set_price_per_m"]'))==null?void 0:L.value),sheer_price_per_m:g((q=d.querySelector('select[name="sheer_price_per_m"]'))==null?void 0:q.value),fabric_code:((S=d.querySelector('input[name="fabric_code"]'))==null?void 0:S.value)||"",sheer_fabric_code:(($=d.querySelector('input[name="sheer_fabric_code"]'))==null?void 0:$.value)||"",opening_style:((B=d.querySelector('select[name="opening_style"]'))==null?void 0:B.value)||"",track_color:((A=d.querySelector('select[name="track_color"]'))==null?void 0:A.value)||"",notes:((C=d.querySelector('input[name="notes"]'))==null?void 0:C.value)||""}):y==="wallpaper"?Object.assign(u,{height_m:g((T=d.querySelector('[name="wallpaper_height_m"]'))==null?void 0:T.value),wallpaper_code:((I=d.querySelector('[name="wallpaper_code"]'))==null?void 0:I.value)||"",price_per_roll:g((M=d.querySelector('[name="wallpaper_price_roll"]'))==null?void 0:M.value),install_cost_per_roll:g((j=d.querySelector('[name="wallpaper_install_cost"]'))==null?void 0:j.value),notes:((F=d.querySelector('[name="wallpaper_notes"]'))==null?void 0:F.value)||"",widths:Array.from(d.querySelectorAll('[name="wall_width_m"]')).map(Ve=>g(Ve.value))}):d.matches(".area-based-item")&&Object.assign(u,{width_m:g((Y=d.querySelector('[name="area_width_m"]'))==null?void 0:Y.value),height_m:g((Q=d.querySelector('[name="area_height_m"]'))==null?void 0:Q.value),price_sqyd:g((ee=d.querySelector('[name="area_price_sqyd"]'))==null?void 0:ee.value),code:((R=d.querySelector('[name="area_code"]'))==null?void 0:R.value)||"",notes:((ue=d.querySelector('[name="area_notes"]'))==null?void 0:ue.value)||""}),l.items.push(u)}),t.rooms.push(l)}),t}function P(){try{localStorage.setItem(me,JSON.stringify(D()))}catch(e){console.error("Failed to save data to localStorage:",e)}}const E={stylePlus:e=>ve.style_surcharge[e]??0,heightPlus:e=>{const t=[...ve.height].sort((r,o)=>o.threshold-r.threshold);for(const r of t)if(e>r.threshold)return r.add_per_m;return 0},fabricYardage:(e,t)=>{const r=g(t);return r<=0||!e?0:e==="ตาไก่"||e==="จีบ"?(r*2+.6)/.9:e==="ลอน"?(r*2.6+.6)/.9:0},wallpaperRolls:(e,t)=>{const r=g(e),o=g(t);if(r<=0||o<=0)return 0;const n=o>2.5?Math.floor(be.ROLL_LENGTH_M/o):be.STRIPS_PER_ROLL_UNDER_2_5M;if(n<=0)return 0;const s=Math.ceil(r/be.ROLL_WIDTH_M);return Math.ceil(s/n)},calculateSetPrice:function(e){var a,c;if(!e||e.is_suspended||g(e.width_m)<=0)return{total:0,opaque:0,sheer:0};const t=this.stylePlus(e.style),r=this.heightPlus(g(e.height_m)),o=g(e.width_m),n=(a=e.fabric_variant)!=null&&a.includes("ทึบ")&&g(e.price_per_m_raw)>0?(g(e.price_per_m_raw)+t+r)*o:0,s=(c=e.fabric_variant)!=null&&c.includes("โปร่ง")&&g(e.sheer_price_per_m)>0?(g(e.sheer_price_per_m)+t+r)*o:0;return{total:Math.round(n+s),opaque:Math.round(n),sheer:Math.round(s)}},calculateDecoPrice:function(e){if(!e||e.is_suspended||g(e.width_m)<=0||g(e.height_m)<=0)return{total:0,sqm:0,sqyd:0};const t=g(e.width_m)*g(e.height_m),r=t*Ke,o=r*g(e.price_sqyd);return{total:Math.round(o),sqm:t,sqyd:r}},calculateWallpaperPrice:function(e){var a;if(!e||e.is_suspended)return{total:0,material:0,install:0,rolls:0,sqm:0};const t=((a=e.widths)==null?void 0:a.reduce((c,p)=>c+g(p),0))||0;if(t<=0)return{total:0,material:0,install:0,rolls:0,sqm:0};const r=g(e.height_m),o=this.wallpaperRolls(t,r),n=o*g(e.price_per_roll),s=o*g(e.install_cost_per_roll??300);return{total:Math.round(n+s),material:Math.round(n),install:Math.round(s),rolls:o,sqm:t*r}}},se={set:"ผ้าม่าน",wallpaper:"วอลล์เปเปอร์",wooden_blind:"มู่ลี่ไม้",roller_blind:"ม่านม้วน",vertical_blind:"ม่านปรับแสง",partition:"ฉากกั้นห้อง",pleated_screen:"มุ้งจีบ",aluminum_blind:"มู่ลี่อลูมิเนียม"};function Ne(e){let t=`
📄 *สรุปรายการ (สำหรับลูกค้า)*
`,r=!1;return e.rooms.forEach(o=>{if(o.is_suspended||!o.items)return;const n=o.items.filter(a=>a.is_suspended?!1:a.type==="wallpaper"?(a.widths||[]).reduce((c,p)=>c+p,0)>0:a.width_m>0);if(n.length===0)return;r=!0,t+=`
*ห้อง: ${o.room_name||"ไม่ระบุ"}*
`;let s=0;n.forEach(a=>{s++;const c=se[a.type]||"สินค้าตกแต่ง";a.type==="set"?t+=` ${s}) ${c} ${a.style} (${a.fabric_variant})
`:t+=` ${s}) ${c}
`})}),r?t+`------------------------------
`:""}function rt(e){return e.rooms.reduce((t,r)=>{var n;if(r.is_suspended)return t;const o=((n=r.items)==null?void 0:n.reduce((s,a)=>{if(a.is_suspended)return s;switch(a.type){case"set":return s+E.calculateSetPrice(a).total;case"wallpaper":return s+E.calculateWallpaperPrice(a).total;default:return s+E.calculateDecoPrice(a).total}},0))||0;return t+o},0)}function ot(e,t){const r=rt(e);let o=0,n="";e.discount&&e.discount.value>0&&(e.discount.type==="percent"?(o=r*(e.discount.value/100),n=`ส่วนลด (${e.discount.value}%): -${x(o)} บาท
`):(o=e.discount.value,n=`ส่วนลด: -${x(o)} บาท
`));const s=r-o;let a=`สรุปข้อมูล (${new Date().toLocaleDateString("th-TH",{day:"numeric",month:"numeric",year:"numeric"})})
`;if(a+=`ลูกค้า: ${e.customer_name||"-"}
`,(t==="customer"||t==="owner")&&(a+=`เบอร์โทร: ${e.customer_phone||"-"}
`,a+=`ที่อยู่: ${e.customer_address||"-"}
`),a+=`------------------------------
`,t==="customer")return a+=Ne(e).replace(" (สำหรับลูกค้า)",""),o>0&&(a+=`
ยอดรวม: ${x(r)} บาท
`,a+=n),a+=`
สรุปยอดสุทธิ: ${x(s)} บาท
`,a+=`
ขอบคุณที่ใช้บริการ
${N.name}
โทร: ${N.phone}`,a;if(t==="purchase_order"||t==="owner"){t==="owner"&&(a+=Ne(e));const c={opaqueFabrics:[],sheerFabrics:[],decorations:{},wallpapers:[],allSets:[]};e.rooms.forEach(f=>{f.is_suspended||!f.items||f.items.forEach(h=>{const w=h.type==="set"||h.type.includes("_blind")||h.type==="partition"||h.type==="pleated_screen";if(!(h.is_suspended||w&&h.width_m<=0))switch(h.type){case"set":c.allSets.push(h),h.fabric_variant.includes("ทึบ")&&c.opaqueFabrics.push({code:h.fabric_code||"??",yards:E.fabricYardage(h.style,h.width_m)}),h.fabric_variant.includes("โปร่ง")&&c.sheerFabrics.push({code:h.sheer_fabric_code||"??",yards:E.fabricYardage(h.style,h.width_m)});break;case"wallpaper":const L=(h.widths||[]).reduce((S,$)=>S+$,0);if(L>0){const S=E.wallpaperRolls(L,h.height_m);S>0&&c.wallpapers.push({code:h.wallpaper_code||"xxx",rolls:S})}break;default:const q=se[h.type]||h.type;c.decorations[q]||(c.decorations[q]=[]),c.decorations[q].push({code:h.code||"xxx",width:h.width_m,height:h.height_m});break}})});const p={};if([...c.opaqueFabrics,...c.sheerFabrics].forEach(f=>{p[f.code]=(p[f.code]||0)+f.yards}),Object.keys(p).length>0){a+=`📋 *แจกแจงรายการสั่งซื้อ (ผ้า)*
`,a+=`------------------------------
`,c.opaqueFabrics.length>0&&c.opaqueFabrics.forEach(f=>{a+=`- ผ้าทึบ (Curtain Fabric)
`,a+=`  รหัส: #${f.code||"??"}
`,a+=`  จำนวน: ${f.yards.toFixed(2)} หลา

`}),c.sheerFabrics.length>0&&c.sheerFabrics.forEach(f=>{a+=`- ผ้าโปร่ง (Sheer Fabric)
`,a+=`  รหัส: #${f.code||"??"}
`,a+=`  จำนวน: ${f.yards.toFixed(2)} หลา

`}),a+=`------------------------------
`,a+=`📊 *สรุปยอดรวมผ้า (ตามรหัส)*
`,a+=`------------------------------
`;for(const[f,h]of Object.entries(p))a+=`  - รหัส #${f}: รวมทั้งหมด ${h.toFixed(2)} หลา
`;a+=`
`}const l=c.allSets.filter(f=>f.style==="ตาไก่"),i=c.allSets.filter(f=>f.style!=="ตาไก่");if(i.length>0){a+=`------------------------------
`,a+=`📋 *สำหรับสั่งซื้อ ราง (ลอน/จีบ)*
`,a+=`------------------------------

`;let f=1;i.forEach(h=>{a+=`(${f++}) รางม่าน: ${h.style}, สี: ${h.track_color}
`,h.fabric_variant.includes("ทึบ")&&(a+=`  - รางทึบ: ${Number(h.width_m).toFixed(2)} ม. (1 เส้น)
`),h.fabric_variant.includes("โปร่ง")&&(a+=`  - รางโปร่ง: ${Number(h.width_m).toFixed(2)} ม. (1 เส้น)
`),h.fabric_variant==="ทึบ&โปร่ง"&&(a+=`  (❗️ต้องใช้ขาสองชั้น)
`),a+=`
`})}if(l.length>0){a+=`------------------------------
`,a+=`📋 *สำหรับสั่งซื้อ ราง (ตาไก่)*
`,a+=`------------------------------

`;const f=[];l.forEach(S=>{S.fabric_variant.includes("ทึบ")&&f.push(Number(S.width_m)),S.fabric_variant.includes("โปร่ง")&&f.push(Number(S.width_m))});const h=6;f.sort((S,$)=>$-S);const w=[];for(const S of f){let $=!1;for(let B=0;B<w.length;B++)if(w[B]>=S-.001){w[B]-=S,$=!0;break}$||w.push(h-S)}a+=`ต้องใช้รางเต็ม (6 เมตร) ทั้งหมด: *${w.length} เส้น*

`;const L=f.reduce((S,$)=>{const B=$.toFixed(2);return S[B]=(S[B]||0)+1,S},{}),q=Object.entries(L).sort((S,$)=>parseFloat($[0])-parseFloat(S[0]));if(q.length>0){a+=`*สรุปจำนวนรางที่ต้องตัด:*
`;for(const[S,$]of q)a+=`  - ราง ${S} เมตร จำนวน ${$} เส้น
`;a+=`
`}}let m=0,d=0;l.forEach(f=>{f.width_m>=1.6?m+=3:f.width_m>0&&(m+=2),d+=f.fabric_variant==="ทึบ&โปร่ง"?4:2});const y=c.allSets.length*2;(m>0||d>0||y>0)&&(a+=`------------------------------
`,a+=`📋 *สำหรับสั่งซื้อ อุปกรณ์ (Hardware)*
`,a+=`------------------------------

`,m>0&&(a+=`  - ขาจับราง (ตาไก่): ${m} ตัว
`),d>0&&(a+=`  - หัวราง (ตาไก่): ${d} ตัว
`),y>0&&(a+=`  - ตะขอรวบม่าน (ทุกชนิด): ${y} ตัว
`),a+=`
`);const u=c.decorations;Object.keys(u).length>0&&Object.entries(u).forEach(([f,h])=>{a+=`------------------------------
`,a+=`📋 *สำหรับสั่งซื้อ ${f}*
`,a+=`------------------------------

`,h.forEach(w=>{a+=`รหัส: #${w.code||"xxx"}
ขนาด: ${w.width.toFixed(2)} x ${w.height.toFixed(2)} m.
จำนวน: 1 ชุด

`})});const _={};if(c.wallpapers.forEach(f=>{_[f.code]=(_[f.code]||0)+f.rolls}),Object.keys(_).length>0){a+=`------------------------------
`,a+=`📋 *สำหรับสั่งซื้อ (Wallpaper)*
`,a+=`------------------------------

`;for(const[f,h]of Object.entries(_))a+=`  - รหัส #${f}: รวมทั้งหมด ${h} ม้วน
`;a+=`
`}if(t==="purchase_order")return a+=`------------------------------
`,a}if(t==="seamstress"||t==="owner"){a+=`
🧵 *รายละเอียดสำหรับช่าง*
`;let c=0;if(e.rooms.forEach(p=>{if(p.is_suspended||!p.items)return;const l=p.items.filter(i=>i.type==="set"&&!i.is_suspended&&i.width_m>0);l.length!==0&&(c>0&&(a+=`==============================
`),a+=`
*ห้อง: ${p.room_name||"ไม่ระบุ"}*

`,l.forEach((i,m)=>{m>0&&(a+=`--------------------
`),a+=`*ผ้าม่าน ${i.style} ${i.fabric_variant}* (${m+1}/${l.length})
`,a+=`  ขนาด: กว้าง ${Number(i.width_m).toFixed(2)} x สูง ${Number(i.height_m).toFixed(2)} ม.
`,a+=`  รูปแบบเปิด: ${i.opening_style}
`,i.fabric_variant.includes("ทึบ")&&(a+=`  ผ้าทึบ: รหัส ${i.fabric_code||"-"}
`),i.fabric_variant.includes("โปร่ง")&&(a+=`  ผ้าโปร่ง: รหัส ${i.sheer_fabric_code||"-"}
`)}),a+=`
`,c++)}),c>0?a+=`==============================
`:a+=`ไม่มีรายการสำหรับช่าง
------------------------------
`,t==="seamstress")return a}return t==="owner"&&(a+=`
💰 *สรุปยอดรวม: ${x(s)} บาท*
`),a}function nt(e){if(!e.rooms||e.rooms.length===0)return'<p class="empty-summary">ไม่มีข้อมูลสำหรับแสดงผล</p>';let t="";const r={};e.rooms.forEach(a=>{a.is_suspended||!a.items||a.items.forEach(c=>{if(c.is_suspended)return;let p=null,l=0;switch(c.type){case"set":l=E.calculateSetPrice(c).total,l>0&&(p=c.type);break;case"wallpaper":l=E.calculateWallpaperPrice(c).total,l>0&&(p=c.type);break;default:l=E.calculateDecoPrice(c).total,l>0&&(p=c.type);break}p&&(r[p]=(r[p]||0)+1)})});const o=Object.entries(r).map(([a,c])=>{const p=se[a]||"ของตกแต่ง";return`
            <span class="summary-tag" data-filter-type="${k(a)}" title="คลิกเพื่อกรองเฉพาะรายการนี้">
                ${k(p)} <strong>${c}</strong>
            </span>`}).join("");o&&(t+=`
            <div class="overview-summary-group">
                <h4><i class="ph ph-stack"></i> สรุปประเภทรายการ</h4>
                <div class="summary-tags-container">
                    ${o}
                </div>
            </div>`);let n="",s=0;return e.rooms.forEach(a=>{if(a.is_suspended||!a.items)return;const c={};let p=0;if(a.items.forEach(l=>{if(l.is_suspended)return;let i=null,m=0;switch(l.type){case"set":m=E.calculateSetPrice(l).total,m>0&&(i=l.type);break;case"wallpaper":m=E.calculateWallpaperPrice(l).total,m>0&&(i=l.type);break;default:m=E.calculateDecoPrice(l).total,m>0&&(i=l.type);break}i&&(c[i]=(c[i]||0)+1,p++)}),p>0){s+=p;const l=Object.entries(c).map(([i,m])=>`
                    <div class="overview-item">
                        <span>${k(se[i]||"ของตกแต่ง")}</span>
                        <span>${m}</span>
                    </div>`).join("");n+=`
                <details class="overview-room-card">
                    <summary class="overview-room-summary">
                        <span class="room-name">${k(a.room_name)||"ไม่ระบุชื่อห้อง"}</span>
                        <div class="summary-tags">
                            <span class="room-item-count">${p} รายการ</span>
                            <i class="ph ph-caret-down expand-icon"></i>
                        </div>
                    </summary>
                    <div class="overview-room-items">${l}</div>
                </details>`}}),n&&(t+=`
            <div class="overview-breakdown-group">
                <h4><i class="ph ph-map-pin-line"></i> แจกแจงตามห้อง</h4>
                ${n}
            </div>`),s===0?'<p class="empty-summary">ไม่มีรายการสำหรับแสดงผล</p>':t}function at(e,t){const{vatRate:r,pageBreakBuffer:o=3}=t,n=[];e.rooms.forEach(A=>{if(A.is_suspended||!A.items)return;const C=[];A.items.forEach(T=>{if(T.is_suspended)return;let I,M,j,F;const Y=se[T.type]||"สินค้าตกแต่ง";switch(T.type){case"set":M=E.calculateSetPrice(T).total,M>0&&(j=T.width_m||0,F=T.height_m||0,I=`${Y} ${k(T.style)} (${k(T.fabric_variant)}) <br><small>ขนาด ${j.toFixed(2)} x ${F.toFixed(2)} ม.${T.notes?` - ${k(T.notes)}`:""}</small>`,C.push({description:I,total:M,units:I.includes("<br>")?1.5:1}));break;case"wallpaper":if(M=E.calculateWallpaperPrice(T).total,M>0){const Q=(T.widths||[]).reduce((R,ue)=>R+ue,0),ee=E.wallpaperRolls(Q,T.height_m);F=T.height_m||0,I=`${Y} <br><small>รหัส: ${k(T.wallpaper_code)||"-"}, สูง ${F.toFixed(2)} ม. (ใช้ ${ee} ม้วน)</small>`,C.push({description:I,total:M,units:I.includes("<br>")?1.5:1})}break;default:M=E.calculateDecoPrice(T).total,M>0&&(j=T.width_m||0,F=T.height_m||0,I=`${Y} <br><small>รหัส: ${k(T.code)||"-"}, ขนาด ${j.toFixed(2)} x ${F.toFixed(2)} ม.</small>`,C.push({description:I,total:M,units:I.includes("<br>")?1.5:1}));break}}),C.length>0&&(n.push({isRoomHeader:!0,roomName:k(A.room_name)||"ไม่ระบุชื่อห้อง",units:1.2}),n.push(...C))});const s=n.reduce((A,C)=>A+(C.total||0),0);if(s===0)return null;let a=0,c="",p=s;e.discount&&e.discount.value>0&&(e.discount.type==="percent"?(a=s*(e.discount.value/100),c=`<tr><td class="pdf-label">ส่วนลด (${e.discount.value}%)</td><td class="pdf-amount">-${O(a,2,!0)}</td></tr>`):(a=e.discount.value,c=`<tr><td class="pdf-label">ส่วนลด</td><td class="pdf-amount">-${O(a,2,!0)}</td></tr>`),p=s-a,c+=`<tr><td class="pdf-label">ยอดหลังหักส่วนลด</td><td class="pdf-amount">${O(p,2,!0)}</td></tr>`);const l=p*r,i=p+l,m=17,d=23,y=[];let u=[],_=0;n.forEach((A,C)=>{const T=y.length===0?m:d,I=_+A.units>T;let M=!1;if(!I&&C<n.length-1){const j=T-(_+A.units);j>0&&j<o&&(M=!0)}(I||M)&&u.length>0&&(y.push(u),u=[],_=0),u.push(A),_+=A.units}),u.length>0&&y.push(u);const f=new Date,h=f.toLocaleDateString("th-TH",{year:"numeric",month:"long",day:"numeric"}),w=`QT-${f.getFullYear()}${(f.getMonth()+1).toString().padStart(2,"0")}${f.getDate().toString().padStart(2,"0")}`;let L="",q=0,S=1;y.forEach((A,C)=>{const T=C===0,I=C===y.length-1,M=`
            <div class="pdf-page-header">
                <div class="pdf-header">
                    <div class="pdf-shop-info">
                        ${`<img src="${N.logoUrl}" alt="Logo" class="pdf-logo">`}
                        <div class="pdf-shop-address">
                            <strong><i class="ph ph-github-logo"></i> ${k(N.name)}</strong><br>
                            ${k(N.address).replace(/\n/g,"<br>")}<br>
                            โทร: ${k(N.phone)} | เลขประจำตัวผู้เสียภาษี: ${k(N.taxId)}
                        </div>
                    </div>
                    <div class="pdf-quote-details">
                        <div class="pdf-title-box"><h1>ใบเสนอราคา ${y.length>1?T?"":"(ต่อ)":""}</h1></div>
                        <table class="pdf-quote-meta">
                            <tr><td>เลขที่:</td><td>${w}</td></tr>
                            <tr><td>วันที่:</td><td>${h}</td></tr>
                        </table>
                    </div>
                </div>
                ${T?`
                <section class="pdf-customer-details">
                    <div class="pdf-customer-info">
                        <strong>ลูกค้า:</strong> ${k(e.customer_name)||""}<br>
                        <strong>ที่อยู่:</strong> ${k(e.customer_address).replace(/\n/g,"<br>")||""}<br>
                        <strong>โทร:</strong> ${k(e.customer_phone)||""}
                    </div>
                    <div class="pdf-customer-meta">
                        <strong>เงื่อนไขชำระเงิน:</strong> ${k(N.pdf.paymentTerms)}<br>
                        <strong>ยืนราคา:</strong> ${k(N.pdf.priceValidity)}
                    </div>
                </section>`:""}
            </div>`,j=`
            <div class="pdf-page-footer">
                <div class="pdf-footer-info">
                    <span><i class="ph ph-github-logo"></i> ${k(N.name)} | โทร: ${k(N.phone)}</span>
                    <span>หน้า ${C+1} / ${y.length}</span>
                </div>
            </div>`;let F="";T||(F+=`<tr class="pdf-subtotal-row"><td colspan="4">ยอดยกมา (Brought Forward)</td><td class="pdf-text-right">${O(q,2,!0)}</td></tr>`),A.forEach(R=>{R.isRoomHeader?F+=`<tr class="pdf-room-header"><td colspan="5">ห้อง: ${R.roomName}</td></tr>`:(F+=`<tr><td class="pdf-text-center">${S++}</td><td>${R.description}</td><td class="pdf-text-center">1</td><td class="pdf-text-right">${O(R.total,2,!0)}</td><td class="pdf-text-right">${O(R.total,2,!0)}</td></tr>`,q+=R.total)});let Y="";I||(Y=`<tfoot><tr class="pdf-subtotal-row"><td colspan="4">ยอดยกไป (Carried Forward)</td><td class="pdf-text-right">${O(q,2,!0)}</td></tr></tfoot>`);let Q="";N.pdf.notes&&N.pdf.notes.length>0&&(Q=`
                <strong>หมายเหตุ:</strong>
                <ul>${N.pdf.notes.map(R=>`<li>${k(R)}</li>`).join("")}</ul>
            `);const ee=I?`
            <div class="pdf-summary-wrapper">
                <section class="pdf-summary-section">
                    <div class="pdf-amount-in-words">
                        ${Q}
                        <div class="pdf-amount-text">( ${Xe(i)} )</div>
                    </div>
                    <div class="pdf-totals-block">
                        <table>
                            <tr><td class="pdf-label">รวมเป็นเงิน</td><td class="pdf-amount">${O(s,2,!0)}</td></tr>
                            ${c}
                            ${r>0?`<tr><td class="pdf-label">ภาษีมูลค่าเพิ่ม ${(r*100).toFixed(0)}%</td><td class="pdf-amount">${O(l,2,!0)}</td></tr>`:""}
                            <tr class="pdf-grand-total"><td class="pdf-label">ยอดรวมสุทธิ</td><td class="pdf-amount">${O(i,2,!0)}</td></tr>
                        </table>
                    </div>
                </section>
                <footer class="pdf-footer-section">
                    <div class="pdf-signature-box"><p>.................................................</p><p>ผู้เสนอราคา</p><p>(<i class="ph ph-github-logo"></i> ${k(N.name)})</p><p>วันที่: ${h}</p></div>
                    <div class="pdf-signature-box"><p>.................................................</p><p>ลูกค้า / ผู้มีอำนาจลงนาม</p><p>&nbsp;</p><p>วันที่: ......./......./............</p></div>
                </footer>
            </div>
        `:"";L+=`
            <div class="pdf-page">
                <div class="pdf-page-content">
                    ${M}
                    <div class="pdf-page-body">
                        <table class="pdf-items-table">
                            <thead><tr><th style="width:5%;">ลำดับ</th><th style="width:50%;">รายการ</th><th style="width:10%;">จำนวน</th><th style="width:17.5%;">ราคา/หน่วย</th><th style="width:17.5%;">รวม (บาท)</th></tr></thead>
                            <tbody>${F}</tbody>
                            ${Y}
                        </table>
                        ${ee}
                    </div>
                    ${j}
                </div>
            </div>`});const $=e.customer_name||"quote",B=Oe($);return{html:`<div id="quotation-template">${L}</div>`,fileName:`${w}_${B}`}}const oe=[],st=10;function X(e){oe.push(e),oe.length>st&&oe.shift()}function ct(){return oe.pop()}function lt(){return oe.length>0}let U=!1,ye=null,de=null,ne=!1,H=null,qe=null,Le=!1;const Pe=document.querySelector("#undoBtn"),pe={};function it(e){if(pe[e])return pe[e];const t=new Promise((r,o)=>{const n=document.createElement("script");n.src=e,n.onload=()=>{console.log(`${e} loaded successfully.`),r()},n.onerror=()=>{console.error(`Script load error for ${e}`),delete pe[e],o(new Error(`Script load error for ${e}`))},document.head.appendChild(n)});return pe[e]=t,t}const ce={set:{templateId:"#setTpl",name:"ผ้าม่าน"},wallpaper:{templateId:"#wallpaperTpl",name:"วอลล์เปเปอร์"},wooden_blind:{templateId:"#areaBasedTpl",name:"มู่ลี่ไม้"},roller_blind:{templateId:"#areaBasedTpl",name:"ม่านม้วน"},vertical_blind:{templateId:"#areaBasedTpl",name:"ม่านปรับแสง"},partition:{templateId:"#areaBasedTpl",name:"ฉากกั้นห้อง"},pleated_screen:{templateId:"#areaBasedTpl",name:"มุ้งจีบ"},aluminum_blind:{templateId:"#areaBasedTpl",name:"มู่ลี่อลูมิเนียม"}},ut={มู่ลี่ไม้:"wooden_blind",ม่านม้วน:"roller_blind",ม่านปรับแสง:"vertical_blind",ฉากกั้นห้อง:"partition",มุ้งจีบ:"pleated_screen",มู่ลี่อลูมิเนียม:"aluminum_blind"},ke="marnthara.theme";function De(){const e=localStorage.getItem(ke),t=document.querySelector("#themeToggleBtn");if(!t)return;const r=t.querySelector("i"),o=t.querySelector("span");switch(document.body.classList.remove("dark-theme","neutral-theme"),e){case"dark":document.body.classList.add("dark-theme"),r&&(r.className="ph-fill ph-sun"),o&&(o.textContent=" สว่าง");break;case"neutral":document.body.classList.add("neutral-theme"),r&&(r.className="ph-fill ph-moon"),o&&(o.textContent=" มืด");break;default:r&&(r.className="ph-fill ph-palette"),o&&(o.textContent=" กลาง");break}}function dt(){const e=localStorage.getItem(ke);let t;!e||e==="light"?t="neutral":e==="neutral"?t="dark":t="light",localStorage.setItem(ke,t),De()}function J(){Pe&&(Pe.disabled=!lt())}function pt(){const e=ct();e&&(Ee(e),b("ยกเลิกการกระทำล่าสุดแล้ว","success")),J()}function mt(e,t){if(!e)return;const r=document.getElementById("filterStatusBar");r&&(r.innerHTML=`
            <span>แสดงผลเฉพาะ: <strong>${k(t)}</strong></span>
            <button type="button" class="btn-chip" data-act="clear-filter" title="ยกเลิกการกรอง">
                <i class="ph ph-x"></i>&nbsp;ปิด
            </button>
        `,r.classList.add("is-visible"),r.dataset.filterType=e),document.querySelectorAll(v.room).forEach(o=>{let n=0;o.querySelectorAll(".item-card").forEach(s=>{const a=s.dataset.type===e;s.classList.toggle("item-hidden",!a),a&&n++}),o.classList.toggle("item-hidden",n===0)}),Z(),G()}function ft(){const e=document.getElementById("filterStatusBar");e&&(e.classList.remove("is-visible"),e.innerHTML="",e.removeAttribute("data-filter-type")),document.querySelectorAll(".item-hidden").forEach(t=>t.classList.remove("item-hidden")),Z(),G()}function ge(){document.querySelectorAll(".favorite-chips-container.show").forEach(e=>{e.classList.remove("show")}),document.querySelectorAll(".item-card.overflow-visible").forEach(e=>{e.classList.remove("overflow-visible")})}function je(e){var p;const t=e.dataset.favoriteType,r=(p=e.closest(".form-group-with-favorites"))==null?void 0:p.querySelector(".favorite-chips-container");if(!t||!r)return;ge();const o=e.closest(".item-card"),s=K()[t]||[];let c=Array.from(s.reduce((l,i)=>{const m=i.code.trim();return m&&!l.has(m.toLowerCase())&&l.set(m.toLowerCase(),i),l},new Map).values()).map(l=>`<button type="button" class="btn-chip" data-code="${k(l.code)}" data-price="${l.price}">${k(l.code)}</button>`).join("");c+=`<button type="button" class="btn-manage-favorites" data-act="manage-favorites" data-type="${t}"><i class="ph ph-pencil-simple"></i> จัดการรายการโปรด</button>`,r.innerHTML=c,r.classList.add("show"),o&&o.classList.add("overflow-visible")}function ht(e){const t=e.closest(".form-group-with-favorites"),r=e.closest(".item-card");if(!t||!r)return;const o=e.dataset.code,n=g(e.dataset.price),s=t.querySelector("input[data-favorite-type]");s&&(s.value=o,s.classList.add("input-highlight"),setTimeout(()=>s.classList.remove("input-highlight"),1200));const a=s.dataset.favoriteType;let c;a==="fabric"?c="set_price_per_m":a==="sheer"?c="sheer_price_per_m":a==="wallpaper"?c="wallpaper_price_roll":c="area_price_sqyd";const p=r.querySelector(`[name="${c}"]`);p&&n>0&&(p.tagName==="SELECT"?p.value=n:p.value=x(n),p.classList.add("input-highlight"),setTimeout(()=>p.classList.remove("input-highlight"),1200)),Se(s),te(r),P(),ge()}function he(e){const t=document.querySelector("#favManagerBody"),r=document.querySelector("#favManagerItemTpl"),n=K()[e]||[];!t||!r||(n.length===0?t.innerHTML='<p class="empty-state">ไม่มีรายการโปรดที่บันทึกไว้</p>':t.innerHTML=n.map(s=>r.innerHTML.replace(/{CODE}/g,k(s.code)).replace(/{PRICE}/g,x(s.price)).replace(/{RAW_PRICE}/g,s.price)).join(""),xe(null))}function xe(e){const t=document.querySelector('[data-act="edit-selected-fav"]'),r=document.querySelector('[data-act="del-selected-fav"]');!t||!r||(e?(t.disabled=!1,r.disabled=!1,H={code:e.dataset.code,price:g(e.dataset.price)}):(t.disabled=!0,r.disabled=!0,H=null))}async function vt(e){const t=document.querySelector("#favManagerModal");if(!t||!e)return;const r={fabric:"ผ้าทึบ",sheer:"ผ้าโปร่ง",wallpaper:"วอลล์เปเปอร์",wooden_blind:"มู่ลี่ไม้",roller_blind:"ม่านม้วน",vertical_blind:"ม่านปรับแสง",partition:"ฉากกั้นห้อง",pleated_screen:"มุ้งจีบ",aluminum_blind:"มู่ลี่อลูมิเนียม",deco:"ของตกแต่ง"};t.dataset.currentType=e,ne=!1,H=null,document.querySelector("#favManagerTitle").textContent=`จัดการ '${r[e]||e}'`,he(e),await V("#favManagerModal",()=>{ne&&ye&&je(ye)})}function b(e,t="default"){const r=document.querySelector(v.toastContainer);if(!r)return;const o={success:"ph-bold ph-check-circle",warning:"ph-bold ph-warning",error:"ph-bold ph-x-circle",default:"ph-bold ph-info"},n=document.createElement("div");n.className=`toast toast-${t}`,n.innerHTML=`<i class="${o[t]||o.default}"></i> ${e}`,r.appendChild(n),setTimeout(()=>n.classList.add("show"),10),setTimeout(()=>{n.classList.remove("show"),n.addEventListener("transitionend",()=>n.remove())},3e3)}function V(e,t){return new Promise(r=>{const o=document.querySelector(e);if(!o){r(null);return}const n=document.querySelector(".modal-wrapper.visible");n&&n.classList.add("is-underlay"),o.classList.add("visible");const s=o.querySelector('[id$="Confirm"]'),a=o.querySelector('[id$="Cancel"], [data-act="close-modal"]'),c=Array.from(o.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])')).filter(d=>!d.disabled&&d.offsetParent!==null),p=c[0],l=c[c.length-1];setTimeout(()=>p==null?void 0:p.focus(),50);const i=d=>{if(d.key==="Escape"&&!o.classList.contains("is-underlay")){m({cancelled:!0});return}if(d.key==="Tab"){if(c.length<=1){d.preventDefault();return}d.shiftKey?document.activeElement===p&&(l.focus(),d.preventDefault()):document.activeElement===l&&(p.focus(),d.preventDefault())}},m=d=>{o.classList.remove("visible"),document.removeEventListener("keydown",i),s&&(s.onclick=null),a&&(a.onclick=null),n&&n.classList.remove("is-underlay"),typeof d=="object"&&d.cancelled&&t&&t(),r(d)};s&&(s.onclick=()=>m(!0)),a&&(a.onclick=()=>{o.classList.contains("is-underlay")||m({cancelled:!0})}),document.addEventListener("keydown",i)})}async function ae(e,t){const r=document.querySelector(v.modal);return r?(r.querySelector(v.modalTitle).textContent=e,r.querySelector(v.modalBody).textContent=t,await V(v.modal)===!0):!0}async function yt(){var r,o,n;const e=document.querySelector(v.exportOptionsModal);if(!e)return null;const t=await V(v.exportOptionsModal);return!t||t.cancelled?null:{vatOption:((r=e.querySelector('input[name="vat_option"]:checked'))==null?void 0:r.value)||"include",exportMethod:((o=e.querySelector("#exportMethod"))==null?void 0:o.value)||"direct",pageBreakBuffer:parseInt((n=e.querySelector("#pageBreakBuffer"))==null?void 0:n.value,10)||3}}async function _t(){const e=document.querySelector("#discountModal");if(!e)return;const t=e.querySelector("#discountSubtotal"),r=e.querySelector("#discountPercent"),o=e.querySelector("#discountAmount"),n=e.querySelector("#discountFinalTotal"),s=document.querySelector("#discount_type"),a=document.querySelector("#discount_value"),c=g(document.querySelector("#originalTotal").dataset.rawTotal||document.querySelector("#grandTotal").textContent);t.textContent=x(c);const p=d=>{if(Le)return;Le=!0;let y=0;if(d==="percent"){const u=g(r.value);y=c*((u>=0?u:0)/100),o.value=y>0?x(Math.round(y)):""}else y=g(o.value);if(y=y>=0?Math.min(y,c):0,d!=="percent"){const u=c>0?y/c*100:0;r.value=u>0&&isFinite(u)?O(u,2):""}n.textContent=x(c-y),setTimeout(()=>{Le=!1},20)};r.addEventListener("input",()=>p("percent")),o.addEventListener("input",()=>p("amount")),o.addEventListener("focus",d=>{g(d.target.value)>0&&(d.target.value=g(d.target.value))}),o.addEventListener("blur",d=>{g(d.target.value)>0&&(d.target.value=x(g(d.target.value))),p("amount")});const l=s.value,i=g(a.value);r.value="",o.value="",i>0?l==="percent"?(r.value=i,p("percent")):(o.value=x(i),p("amount")):p();const m=await V("#discountModal");if(m&&!m.cancelled){const d=g(r.value),y=g(o.value);document.activeElement===r&&d>0?(s.value="percent",a.value=d):y>0?(s.value="amount",a.value=y):(s.value="amount",a.value=0),W(),P()}}function $e(e,t,r){e&&(X(D()),J(),e.classList.add("item-removing"),e.addEventListener("animationend",()=>{e.remove(),t&&b(t),r&&r(),le(),Z(),W(),P(),ie()},{once:!0}))}function Z(){document.querySelectorAll(v.room).forEach(e=>{const t=e.querySelectorAll(".item-card:not(.is-suspended):not(.item-hidden)"),r=t.length;t.forEach((n,s)=>{const a=n.querySelector("[data-item-title]");a&&(a.textContent=`${s+1}/${r}`)}),e.querySelectorAll(".item-card.is-suspended, .item-card.item-hidden").forEach(n=>{const s=n.querySelector("[data-item-title]");s&&(s.textContent="-")})})}function We(){const e=document.querySelector(v.orderForm),t=document.querySelector(v.lockBtn);!e||!t||(e.classList.toggle("is-locked",U),t.classList.toggle("is-locked",U),t.querySelector("i").className=U?"ph-bold ph-lock-key":"ph ph-paw-print",e.querySelectorAll("input, select, textarea, button").forEach(r=>{r.closest(".summary-footer")||r.closest(".main-header")||r.closest(".modal-wrapper")||r.dataset.act==="toggle-more-details"||r.dataset.act==="collapse-room"||(r.disabled=U)}),b(U?"ฟอร์มถูกล็อค":"ปลดล็อคฟอร์มแล้ว",U?"warning":"success"))}function G(){const e=document.querySelectorAll(v.room);if(e.length===0)return;const t=[...e].some(o=>o.open),r=document.querySelector(v.toggleAllRoomsBtn);r&&(r.querySelector("i").className="ph ph-rows",r.querySelector("span").textContent=t?"ย่อ":"ขยาย")}function gt(){const e=document.querySelectorAll(v.room),t=[...e].some(r=>r.open);e.forEach(r=>{r.open=!t}),setTimeout(()=>{G(),P()},50)}function le(){const e=document.querySelector(v.quickNavRoomList);e&&(e.innerHTML="",document.querySelectorAll(v.room).forEach(t=>{var n;const r=((n=t.querySelector(v.roomNameInput))==null?void 0:n.value)||"ห้อง",o=document.createElement("a");o.href=`#${t.id}`,o.dataset.jumpTo=t.id,o.innerHTML=`<i class="ph ph-share-fat"></i> ${r}`,e.appendChild(o)}))}function Ue(e){var r;const t=document.getElementById("quickNavBtnText");t&&(e?t.textContent=((r=e.querySelector('input[name="room_name"]'))==null?void 0:r.value)||"...":t.textContent="ไปยังห้อง")}function ie(){if(de&&de.disconnect(),!document.getElementById("quickNavBtnText"))return;const e={root:null,rootMargin:"-60px 0px -150px 0px",threshold:0},t=r=>{const o=r.filter(n=>n.isIntersecting).sort((n,s)=>n.target.getBoundingClientRect().top-s.target.getBoundingClientRect().top);o.length>0&&Ue(o[0].target)};de=new IntersectionObserver(t,e),document.querySelectorAll(v.room).forEach(r=>de.observe(r))}function Se(e){if(!e)return;const t=e.closest(".form-group-with-favorites").querySelector(".btn-favorite");if(!t)return;const r=e.dataset.favoriteType,o=e.value;t.classList.toggle("is-favorite",et(r,o))}function Be(e,t){const r=ce[e];if(!r)return null;const o=document.querySelector(r.templateId);if(!o||!t)return null;const n=o.content.cloneNode(!0),s=n.firstElementChild;s.dataset.type=e,s.classList.add(`${e.replace(/_/g,"-")}-item`);const a=s.querySelector(".item-type-display");if(a&&(a.textContent=r.name),r.templateId==="#areaBasedTpl"){const c=s.querySelector("input[data-favorite-type]");c&&(c.dataset.favoriteType=e)}return t.appendChild(n),s}function St(e,t){var n;if(!t)return;const r=t.querySelector(v.allItemsContainer);if(!r)return;X(D()),J(),ge();const o=Be(e,r);if(o){if(e==="wallpaper"){const s=Ae(o.querySelector('[data-act="add-wall"]'));s&&((n=s.querySelector("input"))==null||n.focus())}else{const s=o.querySelector('input:not([type="hidden"]), select, textarea');s&&s.focus()}o.classList.add("item-created"),o.scrollIntoView({behavior:"smooth",block:"center"}),Z(),W(),P()}}async function Fe(e,t=null){const r=document.querySelector("#itemTypeModal");if(!r)return null;r.querySelector("#itemTypeModalTitle").textContent=e;let o=t;t&&!ce[t]&&(o="wooden_blind");const n=r.querySelector(`input[name="item_type_option"][value="${o||"set"}"]`);n&&(n.checked=!0);const s=await V("#itemTypeModal");if(!s||s.cancelled)return null;const a=r.querySelector('input[name="item_type_option"]:checked');return a?a.value:null}function bt(e,t){if(!ce[t])return;const o=e.parentElement;o&&(X(D()),J(),e.classList.add("item-removing"),e.addEventListener("animationend",()=>{var s;const n=Be(t,o);n&&(e.replaceWith(n),n.classList.add("item-created"),n.scrollIntoView({behavior:"smooth",block:"center"}),(s=n.querySelector('input:not([type="hidden"]), select, textarea'))==null||s.focus(),Z(),W(),P(),b("เปลี่ยนประเภทรายการแล้ว","success"))},{once:!0}))}function re(){X(D()),J();const e=document.querySelector(v.roomsContainer);if(!e)return;const t=document.querySelector("#roomTpl");if(!t)return;const r=Array.from(document.querySelectorAll(v.roomNameInput)).map(p=>parseInt(p.value.replace(/[^0-9]/g,""),10)).filter(p=>!isNaN(p)),s=`ห้อง ${(r.length>0?Math.max(...r):0)+1}`,c=t.content.cloneNode(!0).firstElementChild;if(c){c.id=`room-${Date.now()}`;const p=c.querySelector('input[name="room_name"]'),l=c.querySelector(".room-header-controls .form-group > label");if(p&&l){const m=`room_name_${c.id}`;p.id=m,l.setAttribute("for",m)}p&&(p.value=s);const i=c.querySelector("[data-room-name-display]");i&&(i.textContent=s),c.open=!0,e.appendChild(c),c.classList.add("item-created"),c.scrollIntoView({behavior:"smooth",block:"center"})}le(),G(),ie(),P()}function Ae(e){var r;const t=(r=e==null?void 0:e.closest(".walls-section"))==null?void 0:r.querySelector(v.wallsContainer);if(t){const o=document.querySelector(v.wallTpl);if(!o)return null;const n=o.content.cloneNode(!0),s=n.querySelector(".wall-input-row");if(!s)return null;const a=s.querySelector("input"),c=s.querySelector("label");if(a&&c){const p=`wall-input-${Date.now()}-${Math.random().toString(36).substring(2,7)}`;a.id=p,c.setAttribute("for",p)}return t.appendChild(n),requestAnimationFrame(()=>{s.classList.add("item-created")}),te(e),s}return null}function te(e){var a,c,p,l,i,m,d,y,u,_,f,h;if(!e)return;const t=e.closest(".item-card");if(!t){W();return}const r=t.dataset.type;let o,n,s;switch(r){case"set":o=t.querySelector("[data-set-summary]"),n={width_m:(a=t.querySelector('input[name="width_m"]'))==null?void 0:a.value,height_m:(c=t.querySelector('input[name="height_m"]'))==null?void 0:c.value,style:(p=t.querySelector('select[name="set_style"]'))==null?void 0:p.value,fabric_variant:(l=t.querySelector('select[name="fabric_variant"]'))==null?void 0:l.value,price_per_m_raw:(i=t.querySelector('select[name="set_price_per_m"]'))==null?void 0:i.value,sheer_price_per_m:(m=t.querySelector('select[name="sheer_price_per_m"]'))==null?void 0:m.value},s=E.calculateSetPrice(n),t.dataset.totalPrice=s.total;let w=`ราคา: <b>${x(s.total)}</b> บ.`;s.opaque>0&&s.sheer>0&&(w+=` <small>(ทึบ: ${x(s.opaque)}, โปร่ง: ${x(s.sheer)})</small>`),o&&(o.innerHTML=w);break;case"wallpaper":o=t.querySelector("[data-wallpaper-summary]"),n={height_m:(d=t.querySelector('input[name="wallpaper_height_m"]'))==null?void 0:d.value,price_per_roll:(y=t.querySelector('input[name="wallpaper_price_roll"]'))==null?void 0:y.value,install_cost_per_roll:(u=t.querySelector('input[name="wallpaper_install_cost"]'))==null?void 0:u.value,widths:Array.from(t.querySelectorAll('input[name="wall_width_m"]')).map(S=>S.value)},s=E.calculateWallpaperPrice(n),t.dataset.totalPrice=s.total;let L=`รวม: <b>${x(s.total)}</b> บ. `;(s.material>0||s.install>0)&&(L+=`<small>(วอลล์: ${x(s.material)}, ค่าช่าง: ${x(s.install)})</small>`),s.rolls>0&&(L+=` &bull; พื้นที่: ${O(s.sqm,2)} ตร.ม. &bull; ใช้: ${s.rolls} ม้วน`),o&&(o.innerHTML=L);break;default:o=t.querySelector("[data-area-summary]"),n={width_m:(_=t.querySelector('input[name="area_width_m"]'))==null?void 0:_.value,height_m:(f=t.querySelector('input[name="area_height_m"]'))==null?void 0:f.value,price_sqyd:(h=t.querySelector('input[name="area_price_sqyd"]'))==null?void 0:h.value},s=E.calculateDecoPrice(n),t.dataset.totalPrice=s.total;let q="";s.sqyd>0&&(q=` &bull; พื้นที่: ${O(s.sqyd,2)} ตร.หลา`),o&&(o.innerHTML=`ราคา: <b>${x(s.total)}</b> บ.${q}`);break}W()}function W(){let e=0;document.querySelectorAll(v.room).forEach(a=>{let c=0,p=0;const l=a.classList.contains("is-suspended");a.querySelectorAll(".item-card").forEach(m=>{const d=g(m.dataset.totalPrice),y=m.classList.contains("is-suspended");!l&&!y&&(c+=d,d>0&&p++)});const i=a.querySelector("[data-room-brief]");i&&(l?i.textContent="(ระงับชั่วคราว)":p>0?i.innerHTML=`<span>${p}</span> &bull; ${x(c)} บาท`:i.innerHTML="<span>0</span> รายการ"),l||(e+=c)});const t=document.querySelector("#discount_type").value,r=g(document.querySelector("#discount_value").value);let o=0;r>0&&(o=t==="percent"?e*(r/100):r);const n=e-o;document.querySelector("#grandTotal").textContent=x(n);const s=document.querySelector("#originalTotal");o>0?(s.textContent=x(e),s.dataset.rawTotal=e,s.style.display="block"):(s.style.display="none",s.dataset.rawTotal="")}async function Ee(e){if(e!=null&&e.favorites){const n=document.querySelector("#favoritesConflictModal");if(n){const s=await V("#favoritesConflictModal");if(!s||s.cancelled){b("ยกเลิกการนำเข้า","warning");return}switch(n.querySelector('input[name="fav_conflict_option"]:checked').value){case"overwrite":Ce(e.favorites)&&b("เขียนทับรายการโปรดสำเร็จ","success");break;case"merge":const c=He(e.favorites);b(`รวมข้อมูลสำเร็จ (เพิ่ม ${c} รายการใหม่)`,"success");break;case"skip":b("ข้ามการนำเข้ารายการโปรด","default");break}}else Ce(e.favorites)}if(!(e!=null&&e.rooms)||!Array.isArray(e.rooms)){e.favorites||b("ไม่พบข้อมูลสำหรับนำเข้าในไฟล์","error");return}const t=document.querySelector(v.roomsContainer);if(!t)return;t.innerHTML="",document.querySelector("#customer_name").value=e.customer_name||"",document.querySelector("#customer_phone").value=e.customer_phone||"",document.querySelector("#customer_address").value=e.customer_address||"",e.discount&&(document.querySelector("#discount_type").value=e.discount.type||"amount",document.querySelector("#discount_value").value=e.discount.value||0),document.querySelector("#customerDetailsCard").open=e.customer_card_open??!0;let r=0;const o=()=>{if(r>=e.rooms.length){document.querySelectorAll("input[data-favorite-type]").forEach(Se),W(),Z(),le(),G(),ie(),b("นำเข้าข้อมูลฟอร์มสำเร็จ","success");return}const n=e.rooms[r],s=document.querySelector("#roomTpl");if(!s){console.error("Room template not found.");return}const c=s.content.cloneNode(!0).firstElementChild;if(t.appendChild(c),c){c.id=n.id||`room-${Date.now()}`,n.is_suspended&&c.classList.add("is-suspended"),c.open=n.is_open===!0;const p=n.room_name||"ห้อง (ไม่มีชื่อ)",l=c.querySelector('input[name="room_name"]'),i=c.querySelector(".room-header-controls .form-group > label");if(l&&i){const y=`room_name_${c.id}`;l.id=y,i.setAttribute("for",y)}l&&(l.value=p);const m=c.querySelector("[data-room-name-display]");m&&(m.textContent=p);const d=c.querySelector(v.allItemsContainer);if(d&&n.items){const y=document.createDocumentFragment();n.items.forEach(u=>{var f,h,w;u.type==="deco"&&u.deco_type?(u.type=ut[u.deco_type]||"wooden_blind",u.code=u.deco_code,u.width_m=u.deco_width_m,u.height_m=u.deco_height_m,u.price_sqyd=u.deco_price_sqyd,u.notes=u.deco_notes):u.type==="deco"&&(u.type="wooden_blind",u.code=u.deco_code);const _=Be(u.type,y);if(_){switch(u.is_suspended&&_.classList.add("is-suspended"),u.type){case"set":_.querySelector('input[name="width_m"]').value=z(u.width_m),_.querySelector('input[name="height_m"]').value=z(u.height_m),_.querySelector('select[name="set_style"]').value=u.style||u.set_style||"ลอน",_.querySelector('select[name="fabric_variant"]').value=u.fabric_variant||"ทึบ",_.querySelector('select[name="set_price_per_m"]').value=u.price_per_m_raw||u.set_price_per_m||"",_.querySelector('select[name="sheer_price_per_m"]').value=u.sheer_price_per_m||"",_.querySelector('select[name="opening_style"]').value=u.opening_style||"แยกกลาง",_.querySelector('select[name="track_color"]').value=u.track_color||"ขาว",_.querySelector('input[name="fabric_code"]').value=u.fabric_code||"",_.querySelector('input[name="sheer_fabric_code"]').value=u.sheer_fabric_code||"",_.querySelector('input[name="notes"]').value=u.notes||"";const L=(u.fabric_variant||"").includes("โปร่ง");(f=_.querySelector(v.sheerWrap))==null||f.classList.toggle("hidden",!L),(h=_.querySelector(v.sheerCodeWrap))==null||h.classList.toggle("hidden",!L);break;case"wallpaper":_.querySelector('input[name="wallpaper_height_m"]').value=z(u.height_m||u.wallpaper_height_m),_.querySelector('input[name="wallpaper_code"]').value=u.wallpaper_code||"";const q=g(u.price_per_roll||u.wallpaper_price_roll);_.querySelector('input[name="wallpaper_price_roll"]').value=q>0?x(q):"",_.querySelector('input[name="wallpaper_install_cost"]').value=u.hasOwnProperty("install_cost_per_roll")?x(u.install_cost_per_roll):u.wallpaper_install_cost?x(u.wallpaper_install_cost):"300",_.querySelector('input[name="wallpaper_notes"]').value=u.notes||u.wallpaper_notes||"",u.widths&&u.widths.forEach(S=>{const $=Ae(_.querySelector('[data-act="add-wall"]'));$&&($.querySelector('input[name="wall_width_m"]').value=z(S))});break;default:if(((w=ce[u.type])==null?void 0:w.templateId)==="#areaBasedTpl"){_.querySelector('input[name="area_width_m"]').value=z(u.width_m),_.querySelector('input[name="area_height_m"]').value=z(u.height_m);const S=g(u.price_sqyd);_.querySelector('input[name="area_price_sqyd"]').value=S>0?x(S):"",_.querySelector('input[name="area_code"]').value=u.code||"",_.querySelector('input[name="area_notes"]').value=u.notes||""}break}te(_)}}),d.appendChild(y)}}r++,requestAnimationFrame(o)};requestAnimationFrame(o)}function wt(e){if(document.getElementById("loading-overlay"))return;const t=document.createElement("div");t.id="loading-overlay",t.innerHTML=`<div class="loading-spinner"></div><p>${e}</p>`,document.body.appendChild(t),document.body.style.overflow="hidden"}function qt(){const e=document.getElementById("loading-overlay");e&&e.remove(),document.body.style.overflow=""}async function Lt(e,t){var o,n;const r=document.querySelector(v.printableContent);if(!r||!e||!e.html){b("ไม่พบข้อมูลสำหรับสร้างเอกสาร","error");return}if(t==="direct"){wt("กำลังสร้าง PDF...");try{typeof html2pdf>"u"&&(b("กำลังโหลดไลบรารี PDF...","default"),await it("https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"));const s=document.createElement("div");s.style.position="fixed",s.style.left="-300mm",s.style.top="0",s.style.width="210mm",s.style.background="#fff",s.innerHTML=e.html,document.body.appendChild(s),await new Promise(c=>setTimeout(c,500));const a={margin:0,filename:`${e.fileName}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0,logging:!1,width:((o=s.querySelector(".pdf-page"))==null?void 0:o.scrollWidth)||210*3.77,windowWidth:((n=s.querySelector(".pdf-page"))==null?void 0:n.scrollWidth)||210*3.77},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}};await window.html2pdf().from(s).set(a).save(),b("ดาวน์โหลด PDF สำเร็จ","success"),document.body.contains(s)&&document.body.removeChild(s)}catch(s){console.error("PDF Generation Error:",s),b("สร้าง PDF ล้มเหลว, โปรดลองวิธีที่ 2 (พิมพ์)","error")}finally{qt()}}t==="print"&&(r.innerHTML=e.html,setTimeout(()=>{window.print(),setTimeout(()=>{r.innerHTML=""},1e3)},Je))}function $t(e){if(!e||!e.html){b("ไม่พบข้อมูลสำหรับสร้างไฟล์ HTML","error");return}try{const t=`
            <!DOCTYPE html><html lang="th"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>${e.fileName}</title>
                <link rel="stylesheet" href="https://grobmak.github.io/marnthara-form/src/style.css">
                <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/bold/style.css">
                <style>#printable-content { display: block !important; } .pdf-page { border: 1px solid #eee; box-shadow: 0 0 10px rgba(0,0,0,0.1); margin: 10mm auto; } i.ph { vertical-align: middle; }</style>
            </head>
            <body>${e.html}</body></html>`,r=new Blob([t],{type:"text/html;charset=utf-8"}),o=URL.createObjectURL(r),n=document.createElement("a");n.href=o,n.download=`${e.fileName}.html`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(o),b("ดาวน์โหลดไฟล์ HTML สำเร็จ","success")}catch(t){console.error("HTML Export Error:",t),b("สร้างไฟล์ HTML ล้มเหลว","error")}}function Tt(e){if(!e)return;const t=e.closest(".item-card");if(!t)return;const r=g(e.value);let o,n;const s=e.getAttribute("name");if(s==="set_price_per_m"?(o=t.querySelector('input[name="fabric_code"]'),n="fabric"):s==="sheer_price_per_m"?(o=t.querySelector('input[name="sheer_fabric_code"]'),n="sheer"):s==="wallpaper_price_roll"?(o=t.querySelector('input[name="wallpaper_code"]'),n="wallpaper"):s==="area_price_sqyd"&&(o=t.querySelector('input[name="area_code"]'),o&&(n=o.dataset.favoriteType)),o&&n&&o.value.trim()){const a=Me(n,o.value);a&&a.price!==r&&(o.value="",Se(o))}}const kt=Qe(e=>{e.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_price_per_m"]')&&Tt(e),te(e),P()},200);function Re(e){var r,o,n;if(U){e.preventDefault();return}const t=e.target;if(t.matches('select[name="fabric_variant"]')){const s=t.closest(".set-item");if(s){const a=(r=t.value)==null?void 0:r.includes("โปร่ง");(o=s.querySelector(v.sheerWrap))==null||o.classList.toggle("hidden",!a),(n=s.querySelector(v.sheerCodeWrap))==null||n.classList.toggle("hidden",!a)}}if(t.matches(v.roomNameInput)){const s=t.closest(".room-card");if(s){const a=s.querySelector("[data-room-name-display]");a&&(a.textContent=t.value||"ห้อง")}le(),ie()}t.matches("input[data-favorite-type]")&&Se(t),kt(t)}function xt(e){const t=e.target;t.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_install_cost"]')?t.value=g(t.value)>0?x(g(t.value)):"":t.matches('input[name$="_m"], input[name$="width_m"]')&&(t.value=z(t.value))}function Et(e){const t=e.target;t.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_install_cost"]')&&g(t.value)>0&&(t.value=g(t.value)),t.matches("input[data-favorite-type]")&&(ye=t,je(t))}const It=async e=>{var i,m,d,y;const t=e.target.closest(".summary-tag[data-filter-type]");if(t){const u=t.dataset.filterType,_=t.textContent.trim().replace(/\s*\d+\s*$/,""),f=document.querySelector("#overviewModal");f&&f.classList.remove("visible"),mt(u,_);return}const r=e.target.closest(".favorite-chips-container .btn-chip");if(r){ht(r);return}const o=e.target.closest(".fav-manager-item");if(o){const u=o.parentElement.querySelector(".is-selected");u&&u.classList.remove("is-selected"),u!==o?(o.classList.add("is-selected"),xe(o)):xe(null);return}const n=e.target.closest("[data-act]");if(!n)return;const s=["toggle-more-details","show-discount-modal","collapse-room"];if(U&&!n.closest(".unlockable")&&!s.includes(n.dataset.act))return;const a=n.dataset.act,c=n.closest(v.room),p=n.closest(".item-card"),l=(u,_,f)=>ae(u,_).then(h=>h&&f());switch(a){case"add-room":re();break;case"add-item":{if(qe=n.closest(v.room),qe){const f=await Fe("เพิ่มรายการใหม่");f&&St(f,qe)}break}case"collapse-room":c&&(e.preventDefault(),c.open=!1,(i=c.querySelector("summary"))==null||i.scrollIntoView({behavior:"smooth",block:"center"}));break;case"clear-filter":ft();break;case"change-type":{const f=p==null?void 0:p.dataset.type;if(p&&f){const h=await Fe("เปลี่ยนประเภทรายการ",f);h&&h!==f&&l("ยืนยันการเปลี่ยนแปลง","ข้อมูลทั้งหมดในรายการนี้จะถูกลบและสร้างใหม่ คุณแน่ใจหรือไม่?",()=>bt(p,h))}break}case"add-wall":{const f=Ae(n);f&&((m=f.querySelector('input[name="wall_width_m"]'))==null||m.focus());break}case"show-discount-modal":_t();break;case"toggle-more-details":{const f=p==null?void 0:p.querySelector(".item-details-more");if(f){const h=f.classList.toggle("show");n.classList.toggle("expanded",h),n.querySelector("i").className=h?"ph ph-caret-up":"ph ph-caret-down",n.querySelector("span").textContent=h?"ย่อน้อยลง":"เพิ่มเติม"}break}case"toggle-favorite":{const f=n.closest(".form-group-with-favorites").querySelector("input[data-favorite-type]");if(!f||!p)break;const h=f.dataset.favoriteType,w=f.value;let L;h==="fabric"?L="set_price_per_m":h==="sheer"?L="sheer_price_per_m":h==="wallpaper"?L="wallpaper_price_roll":L="area_price_sqyd";const q=p.querySelector(`[name="${L}"]`),S=g(q==null?void 0:q.value);if(!w.trim()){b("โปรดระบุรหัสก่อนบันทึก","warning");break}if(S<=0&&h!=="fabric"&&h!=="sheer"){b("โปรดระบุราคาก่อนบันทึก","warning");break}const $=we(h,w,S);n.classList.toggle("is-favorite",$),b($?"เพิ่มในรายการโปรดแล้ว":"ลบออกจากรายการโปรด","success"),P();break}case"manage-favorites":{const f=n.dataset.type;ye=n.closest(".form-group-with-favorites").querySelector("input[data-favorite-type]"),vt(f);break}case"add-new-fav-form":{const h=n.closest("#favManagerModal").dataset.currentType;if(!h)break;const w=document.querySelector("#favAddModal");w.querySelector("h3").textContent=`เพิ่ม '${((d=ce[h])==null?void 0:d.name)||h}'`;const L=w.querySelector('[name="fav_code_add"]'),q=w.querySelector('[name="fav_price_add"]');L.value="",q.value="";const S=await V("#favAddModal");if(S&&!S.cancelled){const $=L.value.trim(),B=g(q.value);$&&(we(h,$,B),ne=!0,he(h),b("เพิ่มรายการโปรดแล้ว","success"))}break}case"edit-selected-fav":{if(!H)break;const h=n.closest("#favManagerModal").dataset.currentType;if(!h)break;const w=document.querySelector("#favEditModal");w.querySelector("h3").textContent=`แก้ไข '${H.code}'`;const L=w.querySelector('[name="fav_code_edit"]'),q=w.querySelector('[name="fav_price_edit"]');L.value=H.code,q.value=H.price>0?H.price:"";const S=await V("#favEditModal");if(S&&!S.cancelled){const $=L.value.trim(),B=g(q.value);$&&($!==H.code&&Te(h,H.code),we(h,$,B),ne=!0,he(h),b("แก้ไขรายการโปรดแล้ว","success"))}break}case"del-selected-fav":{if(!H)break;const h=n.closest("#favManagerModal").dataset.currentType;if(!h)break;await ae("ลบรายการโปรด",`ยืนยันการลบรหัส "${H.code}"?`)&&(Te(h,H.code),ne=!0,he(h),b("ลบรายการโปรดแล้ว","success"));break}case"del-room":l("ลบห้อง","ยืนยันการลบห้องนี้?",()=>$e(c,"ลบห้องแล้ว"));break;case"del-item":l("ลบรายการ","ยืนยันการลบรายการนี้?",()=>$e(p,"ลบรายการแล้ว"));break;case"del-wall":l("ลบผนัง","ยืนยันการลบผนังนี้?",()=>$e(n.closest(".wall-input-row"),"ลบผนังแล้ว",()=>te(p)));break;case"clear-room":l("ล้างข้อมูลในห้อง","ยืนยันลบทุกรายการในห้องนี้?",()=>{X(D()),J(),c.querySelector(v.allItemsContainer).innerHTML="",Z(),W(),P(),b("ล้างข้อมูลในห้องแล้ว","success")});break;case"toggle-room-menu":e.preventDefault();const u=n.nextElementSibling;if(!u||!c)return;const _=!u.classList.contains("show");document.querySelectorAll(".room-options-menu.show").forEach(f=>f.classList.remove("show")),document.querySelectorAll(".card.overflow-visible").forEach(f=>f.classList.remove("overflow-visible")),_&&(u.classList.add("show"),c.classList.add("overflow-visible"));break;case"toggle-suspend-room":e.preventDefault(),c==null||c.classList.toggle("is-suspended"),W(),P(),(y=n.closest(".room-options-menu"))==null||y.classList.remove("show"),c==null||c.classList.remove("overflow-visible");break;case"toggle-suspend":e.preventDefault(),p==null||p.classList.toggle("is-suspended"),te(n),P();break}};function Mt(){U=!U,We()}function Bt(e){if(!e||e.closest(".modal-wrapper"))return;const t=e.getAttribute("name"),r=e.closest(".item-card"),s=(a=>{const c=a[t];if(!c)return null;const p=r||document;let l=null;return typeof c=="string"?l=p.querySelector(`[name="${c}"]:not(:disabled)`):typeof c=="function"&&(l=c(e)),!l&&r&&typeof c=="string"&&(l=document.querySelector(`[name="${c}"]:not(:disabled)`)),l})({customer_name:"customer_phone",customer_phone:"customer_address",customer_address:()=>document.querySelector(".room-name-input"),room_name:a=>{var c;return(c=a.closest(".room-card"))==null?void 0:c.querySelector('[data-act="add-item"]')},width_m:"height_m",height_m:"set_price_per_m",set_price_per_m:a=>{var l;const c=a.closest(".set-item"),p=(l=c==null?void 0:c.querySelector('[name="fabric_variant"]'))==null?void 0:l.value;return p!=null&&p.includes("โปร่ง")?c==null?void 0:c.querySelector('[name="sheer_price_per_m"]'):c==null?void 0:c.querySelector('[data-act="toggle-more-details"]')},sheer_price_per_m:a=>{var c;return(c=a.closest(".item-card"))==null?void 0:c.querySelector('[data-act="toggle-more-details"]')},area_width_m:"area_height_m",area_height_m:"area_price_sqyd",area_price_sqyd:"area_code",wall_width_m:a=>{var p,l;const c=(p=a.closest(".wall-input-row"))==null?void 0:p.nextElementSibling;return c!=null&&c.matches(".wall-input-row")?c.querySelector("input"):(l=a.closest(".item-card"))==null?void 0:l.querySelector('[name="wallpaper_price_roll"]')},wallpaper_price_roll:"wallpaper_height_m",wallpaper_height_m:"wallpaper_code"});s&&(s.focus(),typeof s.select=="function"&&s.select())}function At(){const e=document.querySelector(v.setTpl);if(!e)return;const t=e.content.querySelector('select[name="set_price_per_m"]'),r=e.content.querySelector('select[name="sheer_price_per_m"]'),o=n=>{let s='<option value="" hidden>เลือกราคา</option>';return Array.isArray(n)?(n.forEach(a=>{s+=`<option value="${a}">${a.toLocaleString("th-TH")}</option>`}),s):(console.error("Price data for dropdown is not available or not an array.",n),s)};t&&(t.innerHTML=o(ve.fabric)),r&&(r.innerHTML=o(ve.sheer))}function Ct(){At(),De();const e=document.querySelector(v.orderForm),t=document.querySelector(v.fileImporter),r=document.querySelector("#favImporter"),o=document.querySelector(v.menuDropdown),n=document.querySelector(v.quickNavDropdown),s=document.querySelector("#pageBreakBuffer"),a=document.querySelector("#pageBreakBufferValue");s&&a&&s.addEventListener("input",()=>{a.textContent=s.value}),e.addEventListener("input",Re),e.addEventListener("change",Re),document.addEventListener("click",It),e.addEventListener("blur",xt,!0),e.addEventListener("focusin",Et,!0),e.addEventListener("keydown",l=>{const i=l.target;l.key==="Enter"&&!i.matches("textarea, button, [data-act]")&&(l.preventDefault(),Bt(i))});const c=l=>{const i=l.target.closest(v.room);i&&Ue(i)};e.addEventListener("click",c),e.addEventListener("focusin",c),document.body.addEventListener("click",l=>{l.target.closest("summary")&&setTimeout(()=>{G(),P()},50)}),document.querySelector("#undoBtn").addEventListener("click",l=>{l.preventDefault(),pt()}),document.querySelector(v.lockBtn).addEventListener("click",Mt),document.querySelector(v.toggleAllRoomsBtn).addEventListener("click",gt),document.querySelector(v.quickNavBtn).addEventListener("click",l=>{var m;l.stopPropagation(),o.classList.remove("show");const i=!n.classList.contains("show");n.classList.toggle("show"),l.currentTarget.setAttribute("aria-expanded",i),i&&((m=document.querySelector(v.menuBtn))==null||m.setAttribute("aria-expanded","false"))}),document.querySelector(v.quickNavRoomList).addEventListener("click",l=>{var m;const i=l.target.closest("a[data-jump-to]");if(i){l.preventDefault();const d=i.dataset.jumpTo,y=document.getElementById(d);y&&(document.body.classList.add("disable-animations"),y.open=!0,y.scrollIntoView({behavior:"auto",block:"start"}),y.classList.add("scrolling-jump"),setTimeout(()=>{y.classList.remove("scrolling-jump"),document.body.classList.remove("disable-animations"),G()},1e3)),n.classList.remove("show"),(m=document.querySelector(v.quickNavBtn))==null||m.setAttribute("aria-expanded","false")}});const p=document.querySelector("#addRoomQuickNavBtn");if(p){const l=ze(re,700);p.addEventListener("click",i=>{var m;i.stopPropagation(),l(),n.classList.remove("show"),(m=document.querySelector(v.quickNavBtn))==null||m.setAttribute("aria-expanded","false")})}document.querySelector(v.menuBtn).addEventListener("click",l=>{var m;l.stopPropagation(),n.classList.remove("show");const i=!o.classList.contains("show");o.classList.toggle("show"),l.currentTarget.setAttribute("aria-expanded",i),i&&((m=document.querySelector(v.quickNavBtn))==null||m.setAttribute("aria-expanded","false"))}),document.querySelector("#themeToggleBtn").addEventListener("click",l=>{l.preventDefault(),dt()}),document.querySelector("#overviewBtn").addEventListener("click",async l=>{var y;l.preventDefault(),o.classList.remove("show"),(y=document.querySelector(v.menuBtn))==null||y.setAttribute("aria-expanded","false");const i=D(),m=document.querySelector("#overviewModalHeader"),d=document.querySelector("#overviewModalBody");if(m&&d){const u=i.rooms.reduce((h,w)=>{if(w.is_suspended)return h;const L=(w.items||[]).filter(q=>{if(q.is_suspended)return!1;let S=0;switch(q.type){case"set":S=E.calculateSetPrice(q).total;break;case"wallpaper":S=E.calculateWallpaperPrice(q).total;break;default:S=E.calculateDecoPrice(q).total;break}return S>0}).length;return h+L},0),_=document.querySelector(v.grandTotal).textContent||"0",f=i.rooms.filter(h=>!h.is_suspended&&h.items&&h.items.some(w=>!w.is_suspended)).length;m.innerHTML=`
                <div class="overview-stats-grid">
                    <div class="overview-stat-card">
                        <i class="ph-bold ph-map-pin-line"></i>
                        <div class="stat-value">${f}</div>
                        <div class="stat-label">ห้อง</div>
                    </div>
                    <div class="overview-stat-card">
                        <i class="ph-bold ph-stack"></i>
                        <div class="stat-value">${u}</div>
                        <div class="stat-label">รายการ</div>
                    </div>
                    <div class="overview-stat-card">
                        <i class="ph-bold ph-coins"></i>
                        <div class="stat-value">${_}</div>
                        <div class="stat-label">ยอดรวม</div>
                    </div>
                </div>
            `,d.innerHTML=nt(i),V("#overviewModal")}}),document.querySelector(v.exportPdfBtn).addEventListener("click",async l=>{var y;l.preventDefault(),o.classList.remove("show"),(y=document.querySelector(v.menuBtn))==null||y.setAttribute("aria-expanded","false");const i=await yt();if(!i)return;const m=D(),d=at(m,{vatRate:i.vatOption==="include"?N.baseVatRate:0,pageBreakBuffer:i.pageBreakBuffer});if(!d){b("ไม่มีรายการที่มีราคาสำหรับสร้างเอกสาร","warning");return}i.exportMethod==="html"?$t(d):Lt(d,i.exportMethod)}),document.querySelector(v.importBtn).addEventListener("click",l=>{var i;l.preventDefault(),o.classList.remove("show"),(i=document.querySelector(v.menuBtn))==null||i.setAttribute("aria-expanded","false"),t.click()}),t.addEventListener("change",l=>{var d;const i=(d=l.target.files)==null?void 0:d[0];if(!i)return;const m=new FileReader;m.onload=async y=>{try{const u=JSON.parse(y.target.result);await Ee(u)}catch(u){b("ไฟล์ JSON ไม่ถูกต้อง","error"),console.error("JSON Parse Error:",u)}},m.readAsText(i),l.target.value=null}),document.querySelector(v.exportBtn).addEventListener("click",l=>{var i;l.preventDefault(),o.classList.remove("show"),(i=document.querySelector(v.menuBtn))==null||i.setAttribute("aria-expanded","false");try{const m=D(),d=JSON.stringify(m,null,4),y=new Blob([d],{type:"application/json"}),u=URL.createObjectURL(y),_=document.createElement("a"),f=new Date,h=`${f.getFullYear()}${(f.getMonth()+1).toString().padStart(2,"0")}${f.getDate().toString().padStart(2,"0")}`,w=`${f.getHours().toString().padStart(2,"0")}${f.getMinutes().toString().padStart(2,"0")}`,L=Oe(m.customer_name||"data");_.href=u,_.download=`MTR-${h}${w}-${L}.json`,_.click(),URL.revokeObjectURL(u),b("Export ข้อมูลสำเร็จ","success")}catch{b("Export ข้อมูลล้มเหลว","error")}}),document.querySelector("#importFavsBtn").addEventListener("click",l=>{var i;l.preventDefault(),o.classList.remove("show"),(i=document.querySelector(v.menuBtn))==null||i.setAttribute("aria-expanded","false"),r.click()}),r.addEventListener("change",l=>{var d;const i=(d=l.target.files)==null?void 0:d[0];if(!i)return;const m=new FileReader;m.onload=y=>{try{const u=JSON.parse(y.target.result),_=He(u);_>0?b(`เพิ่มรายการโปรดใหม่ ${_} รายการ`,"success"):b("ไม่พบรายการโปรดใหม่ที่จะเพิ่ม","default"),P()}catch(u){b("ไฟล์ JSON ไม่ถูกต้อง","error"),console.error("Favorites JSON Parse Error:",u)}},m.readAsText(i),l.target.value=null}),document.querySelector("#exportFavsBtn").addEventListener("click",l=>{var i;l.preventDefault(),o.classList.remove("show"),(i=document.querySelector(v.menuBtn))==null||i.setAttribute("aria-expanded","false");try{const m=K(),d=JSON.stringify(m,null,4),y=new Blob([d],{type:"application/json"}),u=URL.createObjectURL(y),_=document.createElement("a"),f=new Date,h=`${f.getFullYear()}${(f.getMonth()+1).toString().padStart(2,"0")}${f.getDate().toString().padStart(2,"0")}`;_.href=u,_.download=`MTR-Favorites-${h}.json`,_.click(),URL.revokeObjectURL(u),b("Export รายการโปรดสำเร็จ","success")}catch{b("Export รายการโปรดล้มเหลว","error")}}),document.querySelector(v.submitBtn).addEventListener("click",async l=>{var i;if(l.preventDefault(),o.classList.remove("show"),(i=document.querySelector(v.menuBtn))==null||i.setAttribute("aria-expanded","false"),await ae("ส่งข้อมูล","ยืนยันการส่งข้อมูลการประเมินราคา?")){const m=D();if(!m.customer_name&&!m.customer_phone){b("กรุณาระบุชื่อหรือเบอร์โทรลูกค้า","warning");return}b("กำลังส่งข้อมูล...","default");try{const d=await fetch(Ge,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(m)});d.ok?b("ส่งข้อมูลสำเร็จ!","success"):b(`ส่งข้อมูลล้มเหลว: ${d.status}`,"error")}catch{b("เกิดข้อผิดพลาดในการเชื่อมต่อ","error")}}}),document.querySelector(v.copyTextBtn).addEventListener("click",async l=>{var d;l.preventDefault(),o.classList.remove("show"),(d=document.querySelector(v.menuBtn))==null||d.setAttribute("aria-expanded","false");const i=document.querySelector(v.copyOptionsModal);i.querySelector('input[name="copy_option"][value="customer"]').checked=!0;const m=await V(v.copyOptionsModal);if(m&&!m.cancelled){const y=i.querySelector('input[name="copy_option"]:checked').value,u=ot(D(),y);try{await navigator.clipboard.writeText(u),b("คัดลอกสรุปสำเร็จ!","success")}catch{b("คัดลอกล้มเหลว","error")}}}),document.querySelector(v.clearItemsBtn).addEventListener("click",async l=>{var i;l.preventDefault(),o.classList.remove("show"),(i=document.querySelector(v.menuBtn))==null||i.setAttribute("aria-expanded","false"),await ae("ล้างทุกรายการ","คุณแน่ใจหรือไม่ว่าต้องการลบรายการสินค้าทั้งหมด (ข้อมูลลูกค้าและห้องจะยังคงอยู่)?")&&(X(D()),J(),document.querySelectorAll(v.room).forEach(m=>{const d=m.querySelector(v.allItemsContainer);d&&(d.innerHTML="")}),W(),P(),b("ล้างทุกรายการแล้ว","success"))}),document.querySelector(v.clearAllBtn).addEventListener("click",async l=>{var i;if(l.preventDefault(),o.classList.remove("show"),(i=document.querySelector(v.menuBtn))==null||i.setAttribute("aria-expanded","false"),await ae("ลบข้อมูลทั้งหมด",'คำเตือน! การกระทำนี้จะลบข้อมูลลูกค้า, ทุกรายการ, และ "รายการโปรด" ทั้งหมดอย่างถาวร ยืนยันหรือไม่?')){X(D()),J(),localStorage.removeItem(me),tt();const m=document.querySelector("#customer_name"),d=document.querySelector("#customer_phone"),y=document.querySelector("#customer_address");m&&(m.value=""),d&&(d.value=""),y&&(y.value="");const u=document.querySelector("#discount_type"),_=document.querySelector("#discount_value");u&&(u.value="amount"),_&&(_.value="0");const f=document.querySelector(v.roomsContainer);f&&(f.innerHTML=""),W(),le(),G(),re();const h=document.querySelector("#customerDetailsCard");h&&(h.open=!0),b("ลบข้อมูลทั้งหมดแล้ว เริ่มต้นใหม่","success")}}),window.addEventListener("click",l=>{var i,m;l.target.closest(".modal-wrapper")||(l.target.closest(".menu-container")||(o.classList.contains("show")&&(o.classList.remove("show"),(i=document.querySelector(v.menuBtn))==null||i.setAttribute("aria-expanded","false")),n.classList.contains("show")&&(n.classList.remove("show"),(m=document.querySelector(v.quickNavBtn))==null||m.setAttribute("aria-expanded","false"))),l.target.closest(".room-options-container")||(document.querySelectorAll(".room-options-menu.show").forEach(d=>d.classList.remove("show")),document.querySelectorAll(".card.overflow-visible").forEach(d=>d.classList.remove("overflow-visible"))),l.target.closest(".form-group-with-favorites")||ge())}),window.addEventListener("beforeunload",P);try{const l=localStorage.getItem(me);if(l&&l.length>2&&l!=="null")Ee(JSON.parse(l));else{re();const i=document.querySelector("#customerDetailsCard");i&&(i.open=!0)}}catch(l){console.error("Failed to load data from localStorage:",l),localStorage.removeItem(me),re()}W(),We(),G(),ie(),J()}document.addEventListener("DOMContentLoaded",Ct);
