(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function n(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(o){if(o.ep)return;o.ep=!0;const a=n(o);fetch(o.href,a)}})();const ye="input-ui/5.6.0-final",ve="https://your-make-webhook-url.com/your-unique-path",z="marnthara.input.v4",ge=500,C={name:"ม่านธารา ผ้าม่านและของตกแต่ง",address:"65/8 หมู่ 2 ต.ท่าศาลา อ.เมือง จ.ลพบุรี 15000",phone:"092-985-9395, 082-552-5595",taxId:"1234567890123",logoUrl:"https://i.imgur.com/l7y85nI.png",baseVatRate:.07,pdf:{paymentTerms:"ชำระมัดจำ 50%",priceValidity:"30 วัน",notes:["ราคานี้รวมค่าติดตั้งแล้ว","ชำระมัดจำ 50% เพื่อยืนยันการสั่งผลิตสินค้า","ใบเสนอราคานี้มีอายุ 30 วัน นับจากวันที่เสนอราคา"]}},Se=1.19599,se={ROLL_WIDTH_M:.53,ROLL_LENGTH_M:10,STRIPS_PER_ROLL_UNDER_2_5M:3},te={fabric:[1e3,1100,1200,1300,1400,1500,1600,1700,1800,1900,2e3,2100,2200],sheer:[1e3,1100,1200,1300,1400,1500],style_surcharge:{ลอน:200,ตาไก่:0,จีบ:0},height:[{threshold:3.2,add_per_m:300},{threshold:2.8,add_per_m:200},{threshold:2.5,add_per_m:100}]},d={orderForm:"#orderForm",roomsContainer:"#rooms",setTpl:"#setTpl",clearAllBtn:"#clearAllBtn",lockBtn:"#lockBtn",grandTotal:"#grandTotal",setCount:"#setCount",modal:"#confirmationModal",modalTitle:"#modalTitle",modalBody:"#modalBody",room:"[data-room]",set:"[data-set]",setsContainer:"[data-sets]",decorationsContainer:"[data-decorations]",decoItem:"[data-deco-item]",wallpapersContainer:"[data-wallpapers]",wallpaperItem:"[data-wallpaper-item]",wallsContainer:"[data-walls-container]",sheerWrap:"[data-sheer-wrap]",roomNameInput:'input[name="room_name"]',toastContainer:"#toast-container",copyTextBtn:"#copyTextBtn",copyOptionsModal:"#copyOptionsModal",menuBtn:"#menuBtn",menuDropdown:"#menuDropdown",importBtn:"#importBtn",exportBtn:"#exportBtn",fileImporter:"#fileImporter",submitBtn:"#submitBtn",clearItemsBtn:"#clearItemsBtn",exportPdfBtn:"#exportPdfBtn",exportOptionsModal:"#exportOptionsModal",printableContent:"#printable-content",quickNavBtn:"#quickNavBtn",quickNavDropdown:"#quickNavDropdown",quickNavRoomList:"#quickNavRoomList",toggleAllRoomsBtn:"#toggleAllRoomsBtn",allDetailsCards:'.card[id="customerDetailsCard"], .room-card'},g=e=>{typeof e=="string"&&(e=e.replace(/,/g,""));const t=parseFloat(e);return Number.isFinite(t)?t:0},A=e=>{const t=g(e);return t>0?t.toFixed(2):""},I=(e,t=2,n=!1)=>Number.isFinite(e)?e.toLocaleString("en-US",{minimumFractionDigits:n?2:t,maximumFractionDigits:n?2:t}):"0",$=(e,t=0)=>Number.isFinite(e)?e.toLocaleString("th-TH",{minimumFractionDigits:t,maximumFractionDigits:t}):"0",qe=(e,t=150)=>{let n;return(...r)=>{clearTimeout(n),n=setTimeout(()=>e(...r),t)}},we=(e,t=700)=>{let n=!1;return(...r)=>{if(!n){n=!0;try{return e(...r)}finally{setTimeout(()=>{n=!1},t)}}}};function be(e){let t=g(e);if(isNaN(t))return"ข้อมูลตัวเลขไม่ถูกต้อง";if(t===0)return"ศูนย์บาทถ้วน";const n=["","หนึ่ง","สอง","สาม","สี่","ห้า","หก","เจ็ด","แปด","เก้า"],r=["","สิบ","ร้อย","พัน","หมื่น","แสน","ล้าน"];let o=Math.floor(t),a=Math.round((t-o)*100);const s=i=>{if(i===0)return"";let u="";const m=String(i);for(let p=0;p<m.length;p++){const h=m[p];m.length-1;const _=m.length-p-1;h!=="0"&&(_===1&&h==="1"?u+=r[_]:_===1&&h==="2"?u+="ยี่"+r[_]:_===0&&h==="1"&&m.length>1?u+="เอ็ด":u+=n[parseInt(h)]+r[_])}return u};let l="";if(o>0){const i=Math.floor(o/1e6),u=o%1e6;i>0&&(l+=s(i)+"ล้าน"),l+=s(u),l+="บาท"}let c="";return a>0?c=s(a)+"สตางค์":l+="ถ้วน",(l+c).trim()}function O(){var t,n,r,o;const e={app_version:ye,customer_name:((t=document.querySelector('[name="customer_name"]'))==null?void 0:t.value)||"",customer_phone:((n=document.querySelector('[name="customer_phone"]'))==null?void 0:n.value)||"",customer_address:((r=document.querySelector('[name="customer_address"]'))==null?void 0:r.value)||"",customer_card_open:(o=document.querySelector("#customerDetailsCard"))==null?void 0:o.open,rooms:[]};return document.querySelectorAll(d.room).forEach(a=>{var l;const s={id:a.id,room_name:((l=a.querySelector(d.roomNameInput))==null?void 0:l.value)||"",is_suspended:a.classList.contains("is-suspended"),sets:[],decorations:[],wallpapers:[]};a.querySelectorAll(d.set).forEach(c=>{var i,u,m,p,h,_,w,v,f,S,y;s.sets.push({width_m:g((i=c.querySelector('input[name="width_m"]'))==null?void 0:i.value),height_m:g((u=c.querySelector('input[name="height_m"]'))==null?void 0:u.value),style:((m=c.querySelector('select[name="set_style"]'))==null?void 0:m.value)||"",fabric_variant:((p=c.querySelector('select[name="fabric_variant"]'))==null?void 0:p.value)||"",price_per_m_raw:g((h=c.querySelector('select[name="set_price_per_m"]'))==null?void 0:h.value),sheer_price_per_m:g((_=c.querySelector('select[name="sheer_price_per_m"]'))==null?void 0:_.value),fabric_code:((w=c.querySelector('input[name="fabric_code"]'))==null?void 0:w.value)||"",sheer_fabric_code:((v=c.querySelector('input[name="sheer_fabric_code"]'))==null?void 0:v.value)||"",opening_style:((f=c.querySelector('select[name="opening_style"]'))==null?void 0:f.value)||"",track_color:((S=c.querySelector('select[name="track_color"]'))==null?void 0:S.value)||"",notes:((y=c.querySelector('input[name="notes"]'))==null?void 0:y.value)||"",is_suspended:c.classList.contains("is-suspended")})}),a.querySelectorAll(d.decoItem).forEach(c=>{var i,u,m,p,h,_;s.decorations.push({type:((i=c.querySelector('[name="deco_type"]'))==null?void 0:i.value)||"",width_m:g((u=c.querySelector('[name="deco_width_m"]'))==null?void 0:u.value),height_m:g((m=c.querySelector('[name="deco_height_m"]'))==null?void 0:m.value),price_sqyd:g((p=c.querySelector('[name="deco_price_sqyd"]'))==null?void 0:p.value),deco_code:((h=c.querySelector('[name="deco_code"]'))==null?void 0:h.value)||"",notes:((_=c.querySelector('[name="deco_notes"]'))==null?void 0:_.value)||"",is_suspended:c.classList.contains("is-suspended")})}),a.querySelectorAll(d.wallpaperItem).forEach(c=>{var i,u,m,p,h;s.wallpapers.push({height_m:g((i=c.querySelector('[name="wallpaper_height_m"]'))==null?void 0:i.value),wallpaper_code:((u=c.querySelector('[name="wallpaper_code"]'))==null?void 0:u.value)||"",price_per_roll:g((m=c.querySelector('[name="wallpaper_price_roll"]'))==null?void 0:m.value),install_cost_per_roll:g((p=c.querySelector('[name="wallpaper_install_cost"]'))==null?void 0:p.value),notes:((h=c.querySelector('[name="wallpaper_notes"]'))==null?void 0:h.value)||"",widths:Array.from(c.querySelectorAll('[name="wall_width_m"]')).map(_=>g(_.value)),is_suspended:c.classList.contains("is-suspended")})}),e.rooms.push(s)}),e}function P(){localStorage.setItem(z,JSON.stringify(O()))}const L={stylePlus:e=>te.style_surcharge[e]??0,heightPlus:e=>{const t=[...te.height].sort((n,r)=>r.threshold-n.threshold);for(const n of t)if(e>n.threshold)return n.add_per_m;return 0},fabricYardage:(e,t)=>{const n=g(t);return n<=0||!e?0:e==="ตาไก่"||e==="จีบ"?(n*2+.6)/.9:e==="ลอน"?(n*2.6+.6)/.9:0},wallpaperRolls:(e,t)=>{const n=g(e),r=g(t);if(n<=0||r<=0)return 0;const o=r>2.5?Math.floor(se.ROLL_LENGTH_M/r):se.STRIPS_PER_ROLL_UNDER_2_5M;if(o<=0)return 0;const a=Math.ceil(n/se.ROLL_WIDTH_M);return Math.ceil(a/o)},calculateSetPrice:function(e){var s,l;if(!e||e.is_suspended||g(e.width_m)<=0)return{total:0,opaque:0,sheer:0};const t=this.stylePlus(e.style),n=this.heightPlus(g(e.height_m)),r=g(e.width_m),o=(s=e.fabric_variant)!=null&&s.includes("ทึบ")&&g(e.price_per_m_raw)>0?(g(e.price_per_m_raw)+t+n)*r:0,a=(l=e.fabric_variant)!=null&&l.includes("โปร่ง")&&g(e.sheer_price_per_m)>0?(g(e.sheer_price_per_m)+t+n)*r:0;return{total:Math.round(o+a),opaque:Math.round(o),sheer:Math.round(a)}},calculateDecoPrice:function(e){if(!e||e.is_suspended||g(e.width_m)<=0)return{total:0,sqm:0,sqyd:0};const t=g(e.width_m)*g(e.height_m),n=t*Se,r=n*g(e.price_sqyd);return{total:Math.round(r),sqm:t,sqyd:n}},calculateWallpaperPrice:function(e){var s;if(!e||e.is_suspended)return{total:0,material:0,install:0,rolls:0,sqm:0};const t=((s=e.widths)==null?void 0:s.reduce((l,c)=>l+g(c),0))||0;if(t<=0)return{total:0,material:0,install:0,rolls:0,sqm:0};const n=g(e.height_m),r=this.wallpaperRolls(t,n),o=r*g(e.price_per_roll),a=r*(g(e.install_cost_per_roll)||0);return{total:Math.round(o+a),material:Math.round(o),install:Math.round(a),rolls:r,sqm:t*n}}};function Le(e){return e.rooms.reduce((t,n)=>{if(n.is_suspended)return t;const r=n.sets.reduce((s,l)=>s+L.calculateSetPrice(l).total,0),o=n.decorations.reduce((s,l)=>s+L.calculateDecoPrice(l).total,0),a=n.wallpapers.reduce((s,l)=>s+L.calculateWallpaperPrice(l).total,0);return t+r+o+a},0)}function $e(e,t){const n=Le(e);let r=`สรุปข้อมูล (${new Date().toLocaleDateString("th-TH",{day:"numeric",month:"numeric",year:"numeric"})})
`;if(r+=`ลูกค้า: ${e.customer_name||"-"}
`,(t==="customer"||t==="owner")&&(r+=`เบอร์โทร: ${e.customer_phone||"-"}
`,r+=`ที่อยู่: ${e.customer_address||"-"}
`),r+=`------------------------------
`,t==="customer")return r+=`
สรุปรายการ
`,e.rooms.forEach(o=>{if(o.is_suspended||[...o.sets,...o.decorations,...o.wallpapers].filter(l=>l.is_suspended?!1:l.widths?l.widths.reduce((c,i)=>c+i,0)>0:l.width_m>0).length===0)return;r+=`
*ห้อง: ${o.room_name||"ไม่ระบุ"}*
`;let s=0;o.sets.forEach(l=>{l.is_suspended||l.width_m<=0||(s++,r+=` ${s}) ผ้าม่าน ${l.style} (${l.fabric_variant})
`)}),o.decorations.forEach(l=>{l.is_suspended||l.width_m<=0||(s++,r+=` ${s}) ${l.type||"ของตกแต่ง"}
`)}),o.wallpapers.forEach(l=>{l.is_suspended||l.widths.reduce((c,i)=>c+i,0)<=0||(s++,r+=` ${s}) วอลเปเปอร์
`)})}),r+=`------------------------------
`,r+=`
สรุปยอดรวม: ${$(n)} บาท
`,r+=`
ขอบคุณที่ใช้บริการ
${C.name}
โทร: ${C.phone}`,r;if(t==="purchase_order"||t==="owner"){const o={opaqueFabrics:[],sheerFabrics:[],decorations:[],wallpapers:[],allSets:[]};if(e.rooms.forEach(a=>{a.is_suspended||(a.sets.forEach(s=>{s.is_suspended||s.width_m<=0||(o.allSets.push(s),s.fabric_variant.includes("ทึบ")&&o.opaqueFabrics.push({code:s.fabric_code||"??",yards:L.fabricYardage(s.style,s.width_m)}),s.fabric_variant.includes("โปร่ง")&&o.sheerFabrics.push({code:s.sheer_fabric_code||"??",yards:L.fabricYardage(s.style,s.width_m)}))}),a.decorations.forEach(s=>{s.is_suspended||!s.type||s.width_m<=0||o.decorations.push({type:s.type,code:s.deco_code||"xxx",width:s.width_m,height:s.height_m})}),a.wallpapers.forEach(s=>{if(s.is_suspended)return;const l=s.widths.reduce((c,i)=>c+i,0);if(l>0){const c=L.wallpaperRolls(l,s.height_m);c>0&&o.wallpapers.push({code:s.wallpaper_code||"xxx",rolls:c})}}))}),r+=`📋 *สรุปวัสดุสำหรับสั่งซื้อผ้า*
`,r+=`------------------------------
`,o.opaqueFabrics.length>0&&o.opaqueFabrics.forEach(a=>{r+=`- ผ้าทึบ (Curtain Fabric)
`,r+=`รหัส: #${a.code||"??"}
`,r+=`จำนวน: ${a.yards.toFixed(2)} หลา

`}),o.sheerFabrics.length>0&&o.sheerFabrics.forEach(a=>{r+=`- ผ้าโปร่ง (Sheer Fabric)
`,r+=`รหัส: #${a.code||"??"}
`,r+=`จำนวน: ${a.yards.toFixed(2)} หลา

`}),r+=`------------------------------
`,r+=`📋 *สำหรับสั่งซื้อ ราง*
`,r+=`------------------------------

`,o.allSets.length>0){let a=1;o.allSets.forEach(s=>{r+=`(${a++}) รางม่าน: ${s.style}, สี: ${s.track_color}
`,s.fabric_variant.includes("ทึบ")&&(r+=`  - รางทึบ: ${s.width_m.toFixed(2)} ม. (1 เส้น)
`),s.fabric_variant.includes("โปร่ง")&&(r+=`  - รางโปร่ง: ${s.width_m.toFixed(2)} ม. (1 เส้น)
`),s.fabric_variant==="ทึบ&โปร่ง"&&(r+=`  (❗️ต้องใช้ขาสองชั้น)
`),r+=`
`})}if(r+=`------------------------------
`,r+=`📋 *สำหรับสั่งซื้อ Blind*
`,r+=`------------------------------

`,o.decorations.length>0){const a={มู่ลี่ไม้:"Wooden Blind",ม่านม้วน:"Roller Blind",ปรับแสง:"Vertical Blind",ฉากกั้นห้อง:"Partition",มุ้งจีบ:"Pleated Insect Screen",มู่ลี่มิเนียม:"Aluminium Blind"};o.decorations.forEach(s=>{const l=a[s.type]?` (${a[s.type]})`:"";r+=`- ${s.type}${l}
`,r+=`รหัส: #${s.code||"xxx"}
`,r+=`ขนาด: ${s.width.toFixed(2)} x ${s.height.toFixed(2)} m.
`,r+=`จำนวน: 1 ชุด

`})}if(r+=`------------------------------
`,r+=`📋 *สำหรับสั่งซื้อ Wallpaper*
`,r+=`------------------------------

`,o.wallpapers.length>0&&o.wallpapers.forEach(a=>{r+=`- วอลเปเปอร์ -
`,r+=`รหัส: #${a.code||"xxx"}
`,r+=`จำนวน: ${a.rolls} ม้วน

`}),r+=`------------------------------
`,t==="purchase_order")return r}return(t==="seamstress"||t==="owner")&&(r+=`
🧵 *รายละเอียดสำหรับช่าง*
`,e.rooms.forEach(o=>{if(o.is_suspended||o.sets.filter(l=>!l.is_suspended&&l.width_m>0).length===0)return;r+=`
*ห้อง: ${o.room_name||"ไม่ระบุ"}*
`;let s=1;o.sets.forEach(l=>{l.is_suspended||l.width_m<=0||(r+=`${s++}) *ผ้าม่าน ${l.style} ${l.fabric_variant}*
`,r+=`  กว้าง ${l.width_m} x สูง ${l.height_m} ม.
`,r+=`  รูปแบบเปิด: ${l.opening_style}
`,l.fabric_variant.includes("ทึบ")&&(r+=`  ผ้าทึบ: รหัส ${l.fabric_code||"-"}
`),l.fabric_variant.includes("โปร่ง")&&(r+=`  ผ้าโปร่ง: รหัส ${l.sheer_fabric_code||"-"}
`))})}),r+=`------------------------------
`,t==="seamstress")||t==="owner"&&(r+=`
💰 *สรุปยอดรวม: ${$(n)} บาท*
`),r}function Te(e){if(!e.rooms||e.rooms.length===0)return'<p class="empty-summary">ไม่มีข้อมูลสำหรับแสดงผล</p>';const t={};let n=0,r="";if(e.rooms.forEach(s=>{if(s.is_suspended)return;const l={};s.sets.forEach(i=>{if(L.calculateSetPrice(i).total>0){const u="ผ้าม่าน";l[u]=(l[u]||0)+1,t[u]=(t[u]||0)+1}}),s.decorations.forEach(i=>{if(i.type&&L.calculateDecoPrice(i).total>0){const u=i.type;l[u]=(l[u]||0)+1,t[u]=(t[u]||0)+1}}),s.wallpapers.forEach(i=>{if(L.calculateWallpaperPrice(i).total>0){const u="วอลเปเปอร์";l[u]=(l[u]||0)+1,t[u]=(t[u]||0)+1}});const c=Object.entries(l);c.length>0&&(r+=`<tr class="room-header-row"><td colspan="3">${s.room_name||"ไม่ระบุชื่อห้อง"}</td></tr>`,c.forEach(([i,u])=>{r+=`<tr><td></td><td class="item-type-cell">${i}</td><td class="pdf-text-center">${u}</td></tr>`,n+=u}))}),n===0)return'<p class="empty-summary">ไม่มีรายการที่มีราคาสำหรับแสดงผล</p>';let a=`<div id="detailed-material-summary">
        <h4><i class="ph ph-stack"></i> ยอดรวมทุกประเภท</h4>
        <ul><li class="summary-note">${Object.entries(t).map(([s,l])=>`${s}: ${l}`).join(" , ")}</li></ul>
    </div>`;return a+=`<table>
        <thead><tr><th>ห้อง</th><th>รายการ</th><th class="pdf-text-center">จำนวน</th></tr></thead>
        <tbody>${r}</tbody>
    </table>`,a}function ke(e,t){const{vatRate:n,pageBreakBuffer:r=3}=t,o=[];e.rooms.forEach(T=>{if(T.is_suspended)return;const k=[];T.sets.forEach(q=>{const E=L.calculateSetPrice(q).total;if(E>0){let x=`ผ้าม่าน ${q.style} (${q.fabric_variant}) <br><small>ขนาด ${q.width_m.toFixed(2)} x ${q.height_m.toFixed(2)} ม.${q.notes?` - ${q.notes}`:""}</small>`;k.push({description:x,total:E,units:x.includes("<br>")?1.5:1})}}),T.decorations.forEach(q=>{const E=L.calculateDecoPrice(q).total;if(E>0){let x=`${q.type||"งานตกแต่ง"} <br><small>รหัส: ${q.deco_code||"-"}, ขนาด ${q.width_m.toFixed(2)} x ${q.height_m.toFixed(2)} ม.</small>`;k.push({description:x,total:E,units:x.includes("<br>")?1.5:1})}}),T.wallpapers.forEach(q=>{const E=L.calculateWallpaperPrice(q).total;if(E>0){const x=q.widths.reduce((K,ae)=>K+ae,0),D=L.wallpaperRolls(x,q.height_m);let F=`วอลเปเปอร์ <br><small>รหัส: ${q.wallpaper_code||"-"}, สูง ${q.height_m.toFixed(2)} ม. (ใช้ ${D} ม้วน)</small>`;k.push({description:F,total:E,units:F.includes("<br>")?1.5:1})}}),k.length>0&&(o.push({isRoomHeader:!0,roomName:T.room_name||"ไม่ระบุชื่อห้อง",units:1.2}),o.push(...k))});const a=o.reduce((T,k)=>T+(k.total||0),0);if(a===0)return null;const s=a*n,l=a+s,c=17,i=23,u=[];let m=[],p=0;o.forEach((T,k)=>{const q=u.length===0?c:i,E=p+T.units>q;let x=!1;if(!E&&k<o.length-1){const D=q-(p+T.units);D>0&&D<r&&(x=!0)}(E||x)&&m.length>0&&(u.push(m),m=[],p=0),m.push(T),p+=T.units}),m.length>0&&u.push(m);const h=new Date,_=h.toLocaleDateString("th-TH",{year:"numeric",month:"long",day:"numeric"}),w=`QT-${h.getFullYear()}${(h.getMonth()+1).toString().padStart(2,"0")}${h.getDate().toString().padStart(2,"0")}`;let v="",f=0,S=1;u.forEach((T,k)=>{const q=k===0,E=k===u.length-1,x=`
            <div class="pdf-page-header">
                <div class="pdf-header">
                    <div class="pdf-shop-info">
                        ${`<img src="${C.logoUrl}" alt="Logo" class="pdf-logo">`}
                        <div class="pdf-shop-address">
                            <strong>${C.name}</strong><br>
                            ${C.address.replace(/\n/g,"<br>")}<br>
                            โทร: ${C.phone} | เลขประจำตัวผู้เสียภาษี: ${C.taxId}
                        </div>
                    </div>
                    <div class="pdf-quote-details">
                        <div class="pdf-title-box"><h1>ใบเสนอราคา ${u.length>1?q?"":"(ต่อ)":""}</h1></div>
                        <table class="pdf-quote-meta">
                            <tr><td>เลขที่:</td><td>${w}</td></tr>
                            <tr><td>วันที่:</td><td>${_}</td></tr>
                        </table>
                    </div>
                </div>
                ${q?`
                <section class="pdf-customer-details">
                    <div class="pdf-customer-info">
                        <strong>ลูกค้า:</strong> ${e.customer_name||""}<br>
                        <strong>ที่อยู่:</strong> ${e.customer_address.replace(/\n/g,"<br>")||""}<br>
                        <strong>โทร:</strong> ${e.customer_phone||""}
                    </div>
                    <div class="pdf-customer-meta">
                        <strong>เงื่อนไขชำระเงิน:</strong> ${C.pdf.paymentTerms}<br>
                        <strong>ยืนราคา:</strong> ${C.pdf.priceValidity}
                    </div>
                </section>`:""}
            </div>`,D=`
            <div class="pdf-page-footer">
                <div class="pdf-footer-info">
                    <span>${C.name} | โทร: ${C.phone}</span>
                    <span>หน้า ${k+1} / ${u.length}</span>
                </div>
            </div>`;let F="";q||(F+=`<tr class="pdf-subtotal-row"><td colspan="4">ยอดยกมา (Brought Forward)</td><td class="pdf-text-right">${I(f,2,!0)}</td></tr>`),T.forEach(M=>{M.isRoomHeader?F+=`<tr class="pdf-room-header"><td colspan="5">ห้อง: ${M.roomName}</td></tr>`:(F+=`<tr><td class="pdf-text-center">${S++}</td><td>${M.description}</td><td class="pdf-text-center">1</td><td class="pdf-text-right">${I(M.total,2,!0)}</td><td class="pdf-text-right">${I(M.total,2,!0)}</td></tr>`,f+=M.total)});let K="";E||(K=`<tfoot><tr class="pdf-subtotal-row"><td colspan="4">ยอดยกไป (Carried Forward)</td><td class="pdf-text-right">${I(f,2,!0)}</td></tr></tfoot>`);const ae=E?`
            <div class="pdf-summary-wrapper">
                <section class="pdf-summary-section">
                    <div class="pdf-amount-in-words">
                        <strong>หมายเหตุ:</strong>
                        <ul>${C.pdf.notes.map(M=>`<li>${M}</li>`).join("")}</ul>
                        <div class="pdf-amount-text">( ${be(l)} )</div>
                    </div>
                    <div class="pdf-totals-block">
                        <table>
                            <tr><td colspan="2" class="pdf-label">รวมเป็นเงิน</td><td class="pdf-amount">${I(a,2,!0)}</td></tr>
                            ${n>0?`<tr><td colspan="2" class="pdf-label">ภาษีมูลค่าเพิ่ม ${(n*100).toFixed(0)}%</td><td class="pdf-amount">${I(s,2,!0)}</td></tr>`:""}
                            <tr class="pdf-grand-total"><td colspan="2" class="pdf-label">ยอดรวมสุทธิ</td><td class="pdf-amount">${I(l,2,!0)}</td></tr>
                        </table>
                    </div>
                </section>
                <footer class="pdf-footer-section">
                    <div class="pdf-signature-box"><p>.................................................</p><p>ผู้เสนอราคา</p><p>(${C.name})</p><p>วันที่: ${_}</p></div>
                    <div class="pdf-signature-box"><p>.................................................</p><p>ลูกค้า / ผู้มีอำนาจลงนาม</p><p>&nbsp;</p><p>วันที่: ......./......./............</p></div>
                </footer>
            </div>
        `:"";v+=`
            <div class="pdf-page">
                <div class="pdf-page-content">
                    ${x}
                    <div class="pdf-page-body">
                        <table class="pdf-items-table">
                            <thead><tr><th style="width:5%;">ลำดับ</th><th style="width:50%;">รายการ</th><th style="width:10%;">จำนวน</th><th style="width:17.5%;">ราคา/หน่วย</th><th style="width:17.5%;">รวม (บาท)</th></tr></thead>
                            <tbody>${F}</tbody>
                            ${K}
                        </table>
                        ${ae}
                    </div>
                    ${D}
                </div>
            </div>`});const N=(e.customer_name||"quote").trim().replace(/\s+/g,"-");return{html:`<div id="quotation-template">${v}</div>`,fileName:`${w}_${N}`}}const ce="marnthara.favorites.v3";function G(){try{const e=localStorage.getItem(ce),t={fabric:[],sheer:[],deco:{},wallpaper:[]};return e?{...t,...JSON.parse(e)}:t}catch(e){return console.error("Failed to parse favorites from localStorage",e),{fabric:[],sheer:[],deco:{},wallpaper:[]}}}function Ee(e,t,n=null){var a;if(!e||!t)return;const r=G(),o=t.trim();return e==="deco"?!n||!r.deco[n]?void 0:r.deco[n].find(s=>s.code===o):(a=r[e])==null?void 0:a.find(s=>s.code===o)}function Ce(e){try{localStorage.setItem(ce,JSON.stringify(e))}catch(t){console.error("Failed to save favorites to localStorage",t)}}function le(e,t,n=0,r=null){if(!e||!t||typeof t!="string"||t.trim()==="")return!1;if(e==="deco"&&!r)return console.error("Sub-type is required for deco favorites."),!1;const o=t.trim(),a=G();let s=!1,l;e==="deco"?(a.deco[r]||(a.deco[r]=[]),l=a.deco[r]):(a[e]||(a[e]=[]),l=a[e]);const c=l.findIndex(i=>i.code===o);return c>-1?(l.splice(c,1),s=!1):(l.push({code:o,price:n}),l.sort((i,u)=>i.code.localeCompare(u.code)),s=!0),Ce(a),s}function xe(e,t,n=null){var a;if(!e||!t)return!1;const r=G(),o=t.trim();return e==="deco"?!n||!r.deco[n]?!1:r.deco[n].some(s=>s.code===o):((a=r[e])==null?void 0:a.some(s=>s.code===o))??!1}function Be(){localStorage.removeItem(ce),console.log("All favorites have been cleared.")}let B=!1,V=null,X=null;const ue="marnthara.theme";function de(){const e=localStorage.getItem(ue),t=document.querySelector("#themeToggleBtn");if(!t)return;const n=t.querySelector("i"),r=t.querySelector("span");e==="dark"?(document.body.classList.add("dark-theme"),n&&(n.className="ph-fill ph-sun"),r&&(r.textContent=" Light Mode")):(document.body.classList.remove("dark-theme"),n&&(n.className="ph-fill ph-moon"),r&&(r.textContent=" Dark Mode"))}function Ie(){document.body.classList.toggle("dark-theme");const e=document.body.classList.contains("dark-theme");localStorage.setItem(ue,e?"dark":"light"),de()}function b(e,t="default"){const n=document.querySelector(d.toastContainer);if(!n)return;const r={success:"ph-bold ph-check-circle",warning:"ph-bold ph-warning",error:"ph-bold ph-x-circle",default:"ph-bold ph-info"},o=document.createElement("div");o.className=`toast toast-${t}`,o.innerHTML=`<i class="${r[t]||r.default}"></i> ${e}`,n.appendChild(o),setTimeout(()=>o.classList.add("show"),10),setTimeout(()=>{o.classList.remove("show"),o.addEventListener("transitionend",()=>o.remove())},3e3)}function Y(e,t){return new Promise(n=>{const r=document.querySelector(e);if(!r){n(null);return}r.classList.add("visible");const o=r.querySelector('[id$="Confirm"]'),a=r.querySelector('[id$="Cancel"], [data-act="close-modal"]'),s=c=>{r.classList.remove("visible"),o&&(o.onclick=null),a&&(a.onclick=null),document.removeEventListener("keydown",l),!c&&t&&t(),n(c)},l=c=>{c.key==="Escape"&&s(!1)};o&&(o.onclick=()=>s(!0)),a&&(a.onclick=()=>s(!1)),document.addEventListener("keydown",l)})}async function Z(e,t){const n=document.querySelector(d.modal);if(!n)return!0;const r=n.querySelector(d.modalTitle),o=n.querySelector(d.modalBody);return r&&(r.textContent=e),o&&(o.textContent=t),await Y(d.modal)}async function Ne(){const e=document.querySelector(d.exportOptionsModal);if(!e||!await Y(d.exportOptionsModal))return null;const n=e.querySelector('input[name="vat_option"]:checked'),r=e.querySelector("#exportMethod"),o=e.querySelector("#pageBreakBuffer");return{vatOption:n?n.value:"include",exportMethod:r?r.value:"direct",pageBreakBuffer:o?parseInt(o.value,10):3}}function j(e,t){e&&(e.classList.add("item-removing"),e.addEventListener("animationend",()=>{e.remove(),t&&b(t),ne(),oe(),R(),P(),U()},{once:!0}))}function oe(){document.querySelectorAll(d.room).forEach(e=>{const t=e.querySelectorAll(".item-card"),n=t.length;t.forEach((r,o)=>{const a=r.querySelector("[data-item-title]");a&&(a.textContent=`${o+1}/${n}`)})})}function me(){const e=document.querySelector(d.orderForm),t=document.querySelector(d.lockBtn);if(!e||!t)return;const n=e.querySelectorAll("input, select, textarea, button");e.classList.toggle("is-locked",B),t.classList.toggle("is-locked",B);const r=t.querySelector("i");r&&(r.className=B?"ph-bold ph-lock-key":"ph-bold ph-lock-key-open"),n.forEach(o=>{o.closest(".summary-footer")||o.closest(".main-header")||o.closest(".modal-wrapper")||(o.disabled=B)}),b(B?"ฟอร์มถูกล็อค":"ปลดล็อคฟอร์มแล้ว",B?"warning":"success")}function H(){const e=document.querySelectorAll(d.allDetailsCards);if(e.length===0)return;const t=[...e].some(r=>r.open),n=document.querySelector(d.toggleAllRoomsBtn);if(n){const r=n.querySelector("i"),o=n.querySelector("span");r&&(r.className=t?"ph ph-rows-slash":"ph ph-rows"),o&&(o.textContent=t?"ย่อทั้งหมด":"ขยายทั้งหมด")}}function Me(){const e=document.querySelectorAll(d.allDetailsCards),t=[...e].some(n=>n.open);e.forEach(n=>{n.open=!t}),setTimeout(H,50)}function ne(){const e=document.querySelector(d.quickNavRoomList);if(!e)return;e.innerHTML="",document.querySelectorAll(d.room).forEach(n=>{const r=n.querySelector(d.roomNameInput),o=r?r.value:"ห้อง",a=document.createElement("a");a.href=`#${n.id}`,a.dataset.jumpTo=n.id,a.innerHTML=`<i class="ph ph-arrow-bend-left-up"></i> ${o||"ห้อง (ไม่มีชื่อ)"}`,e.appendChild(a)})}function pe(e){const t=document.getElementById("quickNavBtnText");if(t)if(e){const n=e.querySelector('input[name="room_name"]');n&&(t.textContent=n.value||"...")}else t.textContent="ไปยังห้อง"}function U(){if(X&&X.disconnect(),!document.getElementById("quickNavBtnText"))return;const t={root:null,rootMargin:"-60px 0px -150px 0px",threshold:0},n=o=>{const a=o.filter(s=>s.isIntersecting).sort((s,l)=>s.target.getBoundingClientRect().top-l.target.getBoundingClientRect().top);a.length>0&&pe(a[0].target)};X=new IntersectionObserver(n,t),document.querySelectorAll(d.room).forEach(o=>X.observe(o))}function Pe(e,t=null){const n=document.getElementById("favManagerTitle"),r=document.getElementById("favManagerBody");if(!n||!r)return;const o=G();let a=[],s="รายการโปรด";e==="deco"?(s=`รายการโปรด: ${t||"ของตกแต่ง"}`,a=o.deco[t]||[]):(s=`รายการโปรด: ${{fabric:"ผ้าทึบ",sheer:"ผ้าโปร่ง",wallpaper:"วอลเปเปอร์"}[e]||e}`,a=o[e]||[]),n.textContent=s,r.innerHTML="",a.length===0?r.innerHTML='<p class="empty-state">ไม่มีรายการโปรดที่บันทึกไว้</p>':a.forEach(l=>{const c=document.createElement("div");c.className="fav-manager-item",c.innerHTML=`
                <span class="fav-manager-code">${l.code}</span>
                <span class="fav-manager-price">${$(l.price)}</span>
                <button type="button" class="btn-icon btn-icon-small danger" data-act="del-favorite" 
                        data-code="${l.code}" data-type="${e}" ${t?`data-sub-type="${t}"`:""}>
                    <i class="ph-bold ph-trash"></i>
                </button>
            `,r.appendChild(c)}),Y("#favManagerModal")}function re(){document.querySelectorAll(".favorite-chips-container.show").forEach(e=>{e.classList.remove("show")}),V=null}function W(e){var a,s;if(!e)return;const t=e.nextElementSibling;if(!t||!t.matches(".btn-favorite"))return;const n=t.dataset.type;let r=null;n==="deco"&&(r=(s=(a=e.closest(".item-card"))==null?void 0:a.querySelector('[name="deco_type"]'))==null?void 0:s.value);const o=xe(n,e.value,r);t.classList.toggle("is-favorite",o),t.querySelector("i").className=o?"ph-fill ph-star":"ph ph-star"}function fe(e){var l,c;re();const t=e.dataset.favoriteType;if(!t)return;let n=null,r=[];const o=G();t==="deco"?(n=(c=(l=e.closest(".item-card"))==null?void 0:l.querySelector('[name="deco_type"]'))==null?void 0:c.value,n&&(r=o.deco[n]||[])):r=o[t]||[];const a=e.closest(".form-group-with-favorites").querySelector(".favorite-chips-container");if(!a)return;a.innerHTML="",r.length>0&&r.forEach(i=>{const u=document.createElement("button");u.type="button",u.className="btn-chip",u.textContent=i.code,u.dataset.act="select-favorite",u.dataset.code=i.code,u.dataset.price=i.price,a.appendChild(u)});const s=document.createElement("button");s.type="button",s.className="btn-manage-favorites",s.dataset.act="manage-favorites",s.dataset.type=t,n&&(s.dataset.subType=n),s.innerHTML='<i class="ph ph-pencil-simple"></i> แก้ไข',a.appendChild(s),a.classList.add("show")}function J(e,t,n=!0){const r=document.querySelector(e);if(!r||!t)return null;const o=r.content.cloneNode(!0),a=o.firstElementChild;t.appendChild(o),a.querySelectorAll("input[data-favorite-type]").forEach(W),n&&a&&(a.classList.add("item-created"),a.scrollIntoView({behavior:"smooth",block:"center"}));const s=a.querySelector('input:not([type="hidden"]), select, textarea');return s&&s.focus(),oe(),R(),P(),a}function ee(){const e=document.querySelector(d.roomsContainer);if(!e)return;const t=document.querySelectorAll(d.roomNameInput);let n=0;t.forEach(a=>{const s=a.value.match(/\d+/g);if(s){const l=parseInt(s[s.length-1],10);l>n&&(n=l)}});const r=n+1,o=J("#roomTpl",e,!0);if(o){o.id=`room-${Date.now()}`;const a=o.querySelector(d.roomNameInput);a&&(a.value=`ห้อง ${r}`),o.open=!0}ne(),H(),U()}function Re(e){if(!e)return;const t=e.querySelector(d.setsContainer);t&&J("#setTpl",t)}function Fe(e){if(!e)return;const t=e.querySelector(d.decorationsContainer);t&&J("#decoTpl",t)}function Ae(e){if(!e)return;const t=e.querySelector(d.wallpapersContainer);if(t){const n=J("#wallpaperTpl",t);n&&he(n.querySelector('[data-act="add-wall"]'))}}function he(e){var n;const t=(n=e==null?void 0:e.closest(".walls-section"))==null?void 0:n.querySelector(d.wallsContainer);t&&(J("#wallTpl",t,!0),Q(e))}function _e(e){var o,a;if(!e)return;const t=(o=e.querySelector('select[name="fabric_variant"]'))==null?void 0:o.value,n=t&&t.includes("โปร่ง");(a=e.querySelector(d.sheerWrap))==null||a.classList.toggle("hidden",!n);const r=e.querySelector('input[name="sheer_fabric_code"]');if(r){const s=r.closest(".form-group-with-favorites");s&&s.classList.toggle("hidden",!n)}}const De=qe(e=>{Q(e),P()});function Oe(e){if(B){b("ฟอร์มถูกล็อค ไม่สามารถแก้ไขได้","warning"),e.preventDefault();return}e.target.matches("input[data-favorite-type]")&&W(e.target),e.target.matches(d.roomNameInput)&&U(),De(e.target)}function He(e){var r;if(B)return;const t=e.target;if(t.matches('select[name="fabric_variant"]')&&_e(t.closest(d.set)),t.matches('select[name="deco_type"]')){const o=t.closest(d.decoItem),a=o==null?void 0:o.querySelector(".deco-type-display");a&&(a.textContent=t.value||"ตกแต่ง")}if(t.matches(d.roomNameInput)&&(ne(),U()),["set_price_per_m","sheer_price_per_m","deco_price_sqyd","wallpaper_price_roll"].includes(t.name)){const o=t.closest(".item-card");if(o){let a;if(t.name==="set_price_per_m"&&(a=o.querySelector('[name="fabric_code"]')),t.name==="sheer_price_per_m"&&(a=o.querySelector('[name="sheer_fabric_code"]')),t.name==="deco_price_sqyd"&&(a=o.querySelector('[name="deco_code"]')),t.name==="wallpaper_price_roll"&&(a=o.querySelector('[name="wallpaper_code"]')),a&&a.value){const s=a.dataset.favoriteType;let l=null;s==="deco"&&(l=(r=o.querySelector('[name="deco_type"]'))==null?void 0:r.value);const c=Ee(s,a.value,l);c&&g(t.value)!==c.price&&(a.value="",W(a),b("ล้างรหัสเนื่องจากราคาไม่ตรงกับ Favorite","warning"))}}}Q(t),P()}function We(e){const t=e.target,n=t.matches('[name="deco_price_sqyd"], [name="wallpaper_price_roll"], [name="wallpaper_install_cost"]'),r=t.matches('input[name="width_m"], input[name="height_m"], input[name="deco_width_m"], input[name="deco_height_m"], input[name="wallpaper_height_m"], input[name="wall_width_m"]');if(n){const o=g(t.value);o>0?t.value=$(o):t.value=""}else r&&(t.value=A(t.value))}function Ue(e){const t=e.target;t.matches("input[data-favorite-type]")&&(V=t,fe(t))}function Q(e){var o,a,s,l,c,i,u,m,p,h,_,w;if(!e)return;const t=e.closest(d.set);if(t){const v=t.querySelector("[data-set-summary]");if(v){const f={width_m:(o=t.querySelector('input[name="width_m"]'))==null?void 0:o.value,height_m:(a=t.querySelector('input[name="height_m"]'))==null?void 0:a.value,style:(s=t.querySelector('select[name="set_style"]'))==null?void 0:s.value,fabric_variant:(l=t.querySelector('select[name="fabric_variant"]'))==null?void 0:l.value,price_per_m_raw:(c=t.querySelector('select[name="set_price_per_m"]'))==null?void 0:c.value,sheer_price_per_m:(i=t.querySelector('select[name="sheer_price_per_m"]'))==null?void 0:i.value},S=L.calculateSetPrice(f);let y=`ราคา: <b>${$(S.total)}</b> บ.`;S.opaque>0&&S.sheer>0&&(y+=` <small>(ทึบ: ${$(S.opaque)}, โปร่ง: ${$(S.sheer)})</small>`),v.innerHTML=y}}const n=e.closest(d.decoItem);if(n){const v=n.querySelector("[data-deco-summary]");if(v){const f={width_m:(u=n.querySelector('input[name="deco_width_m"]'))==null?void 0:u.value,height_m:(m=n.querySelector('input[name="deco_height_m"]'))==null?void 0:m.value,price_sqyd:(p=n.querySelector('input[name="deco_price_sqyd"]'))==null?void 0:p.value},S=L.calculateDecoPrice(f);v.innerHTML=`ราคา: <b>${$(S.total)}</b> บ. &bull; พื้นที่: ${I(S.sqyd,2)} ตร.หลา`}}const r=e.closest(d.wallpaperItem);if(r){const v=r.querySelector("[data-wallpaper-summary]");if(v){const f={height_m:(h=r.querySelector('input[name="wallpaper_height_m"]'))==null?void 0:h.value,price_per_roll:(_=r.querySelector('input[name="wallpaper_price_roll"]'))==null?void 0:_.value,install_cost_per_roll:(w=r.querySelector('input[name="wallpaper_install_cost"]'))==null?void 0:w.value,widths:Array.from(r.querySelectorAll('input[name="wall_width_m"]')).map(N=>N.value)},S=L.calculateWallpaperPrice(f);let y=`รวม: <b>${$(S.total)}</b> บ. `;(S.material>0||S.install>0)&&(y+=`<small>(วอลล์: ${$(S.material)}, ค่าช่าง: ${$(S.install)})</small>`),y+=` &bull; พื้นที่: ${I(S.sqm,2)} ตร.ม. &bull; ใช้: ${S.rolls} ม้วน`,v.innerHTML=y}}R()}function R(){let e=0,t=0;document.querySelectorAll(d.room).forEach(o=>{let a=0,s=0;const l=o.classList.contains("is-suspended");o.querySelectorAll(d.set).forEach(i=>{var m,p,h,_,w,v;const u=L.calculateSetPrice({is_suspended:l||i.classList.contains("is-suspended"),width_m:(m=i.querySelector('input[name="width_m"]'))==null?void 0:m.value,height_m:(p=i.querySelector('input[name="height_m"]'))==null?void 0:p.value,style:(h=i.querySelector('select[name="set_style"]'))==null?void 0:h.value,fabric_variant:(_=i.querySelector('select[name="fabric_variant"]'))==null?void 0:_.value,price_per_m_raw:(w=i.querySelector('select[name="set_price_per_m"]'))==null?void 0:w.value,sheer_price_per_m:(v=i.querySelector('select[name="sheer_price_per_m"]'))==null?void 0:v.value}).total;a+=u,u>0&&(t++,s++)}),o.querySelectorAll(d.decoItem).forEach(i=>{var m,p,h;const u=L.calculateDecoPrice({is_suspended:l||i.classList.contains("is-suspended"),width_m:(m=i.querySelector('input[name="deco_width_m"]'))==null?void 0:m.value,height_m:(p=i.querySelector('input[name="deco_height_m"]'))==null?void 0:p.value,price_sqyd:(h=i.querySelector('input[name="deco_price_sqyd"]'))==null?void 0:h.value}).total;a+=u,u>0&&(t++,s++)}),o.querySelectorAll(d.wallpaperItem).forEach(i=>{var m,p,h;const u=L.calculateWallpaperPrice({is_suspended:l||i.classList.contains("is-suspended"),height_m:(m=i.querySelector('input[name="wallpaper_height_m"]'))==null?void 0:m.value,price_per_roll:(p=i.querySelector('input[name="wallpaper_price_roll"]'))==null?void 0:p.value,install_cost_per_roll:(h=i.querySelector('input[name="wallpaper_install_cost"]'))==null?void 0:h.value,widths:Array.from(i.querySelectorAll('input[name="wall_width_m"]')).map(_=>_.value)}).total;a+=u,u>0&&(t++,s++)});const c=o.querySelector("[data-room-brief]");c&&(l?c.textContent="(ระงับชั่วคราว)":s>0?c.innerHTML=`<span>${s}</span> &bull; ${$(a)} บาท`:c.textContent=""),e+=l?0:a});const n=document.querySelector(d.grandTotal),r=document.querySelector(d.setCount);n&&(n.textContent=$(e)),r&&(r.textContent=t)}function ie(e){if(!e||!e.rooms)return;const t=document.querySelector(d.roomsContainer);if(!t)return;t.innerHTML="";const n=document.querySelector("#customer_name"),r=document.querySelector("#customer_phone"),o=document.querySelector("#customer_address");n&&(n.value=e.customer_name||""),r&&(r.value=e.customer_phone||""),o&&(o.value=e.customer_address||""),e.rooms.forEach(a=>{const s=document.querySelector("#roomTpl");if(!s)return;const l=s.content.cloneNode(!0),c=l.querySelector(d.room);if(!c)return;c.id=a.id||`room-${Date.now()}`,a.is_suspended&&c.classList.add("is-suspended");const i=c.querySelector(d.roomNameInput);i&&(i.value=a.room_name||"ห้อง (ไม่มีชื่อ)");const u=c.querySelector(d.setsContainer),m=c.querySelector(d.decorationsContainer),p=c.querySelector(d.wallpapersContainer),h=document.querySelector("#setTpl"),_=document.querySelector("#decoTpl"),w=document.querySelector("#wallpaperTpl"),v=document.querySelector("#wallTpl");u&&h&&a.sets&&a.sets.forEach(f=>{const S=h.content.cloneNode(!0),y=S.querySelector(d.set);f.is_suspended&&y.classList.add("is-suspended"),y.querySelector('input[name="width_m"]').value=A(f.width_m),y.querySelector('input[name="height_m"]').value=A(f.height_m),y.querySelector('select[name="set_style"]').value=f.style||"ลอน",y.querySelector('select[name="fabric_variant"]').value=f.fabric_variant||"ทึบ",y.querySelector('select[name="set_price_per_m"]').value=f.price_per_m_raw||"",y.querySelector('select[name="sheer_price_per_m"]').value=f.sheer_price_per_m||"",y.querySelector('select[name="opening_style"]').value=f.opening_style||"แยกกลาง",y.querySelector('select[name="track_color"]').value=f.track_color||"ขาว",y.querySelector('input[name="fabric_code"]').value=f.fabric_code||"",y.querySelector('input[name="sheer_fabric_code"]').value=f.sheer_fabric_code||"",y.querySelector('input[name="notes"]').value=f.notes||"",_e(y),u.appendChild(S)}),m&&_&&a.decorations&&a.decorations.forEach(f=>{const S=_.content.cloneNode(!0),y=S.querySelector(d.decoItem);f.is_suspended&&y.classList.add("is-suspended");const N=y.querySelector('select[name="deco_type"]');N.value=f.type||"",y.querySelector(".deco-type-display").textContent=f.type||"ตกแต่ง",y.querySelector('input[name="deco_width_m"]').value=A(f.width_m),y.querySelector('input[name="deco_height_m"]').value=A(f.height_m),y.querySelector('input[name="deco_price_sqyd"]').value=$(f.price_sqyd)||"",y.querySelector('input[name="deco_code"]').value=f.deco_code||"",y.querySelector('input[name="deco_notes"]').value=f.notes||"",m.appendChild(S)}),p&&w&&a.wallpapers&&a.wallpapers.forEach(f=>{const S=w.content.cloneNode(!0),y=S.querySelector(d.wallpaperItem);f.is_suspended&&y.classList.add("is-suspended"),y.querySelector('input[name="wallpaper_height_m"]').value=A(f.height_m),y.querySelector('input[name="wallpaper_code"]').value=f.wallpaper_code||"",y.querySelector('input[name="wallpaper_price_roll"]').value=$(f.price_per_roll)||"",y.querySelector('input[name="wallpaper_install_cost"]').value=f.hasOwnProperty("install_cost_per_roll")?$(f.install_cost_per_roll):"300",y.querySelector('input[name="wallpaper_notes"]').value=f.notes||"";const N=y.querySelector(d.wallsContainer);N&&v&&f.widths&&f.widths.forEach(T=>{const k=v.content.cloneNode(!0);k.querySelector('input[name="wall_width_m"]').value=A(T),N.appendChild(k)}),p.appendChild(S)}),t.appendChild(l)}),document.querySelectorAll("input[data-favorite-type]").forEach(W),document.querySelectorAll(".item-card").forEach(a=>{Q(a)}),oe(),R(),ne(),H(),U(),b("นำเข้าข้อมูลสำเร็จ","success")}function je(e,t){const n=document.querySelector(d.printableContent);!n||!e||!e.html||(n.innerHTML=e.html,setTimeout(()=>{if(t==="direct"){const r=document.getElementById("quotation-template");r&&html2pdf().from(r).set({margin:[15,12,10,12],filename:`${e.fileName}.pdf`,pagebreak:{mode:["css","legacy"]},html2canvas:{scale:2,useCORS:!0},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}}).save().then(()=>{n.innerHTML=""})}else t==="print"&&(window.print(),n.innerHTML="")},ge))}function Ve(e){if(!e||!e.html)return;const t=new Blob([e.html],{type:"text/html;charset=utf-8"}),n=URL.createObjectURL(t),r=document.createElement("a");r.href=n,r.download=`${e.fileName}.html`,r.click(),URL.revokeObjectURL(n),b("Export ไฟล์ HTML สำเร็จ","success")}const Ye=e=>{var a,s,l,c;const t=e.target.closest("[data-act]");if(!t||B&&!t.closest(".unlockable")&&!["select-favorite","manage-favorites","del-favorite","close-modal"].includes(t.dataset.act))return;const n=t.dataset.act,r=t.closest(d.room),o=(i,u,m)=>{Z(i,u).then(p=>{p&&m()})};switch(n){case"add-room":ee();break;case"add-set":Re(r);break;case"add-deco":Fe(r);break;case"add-wallpaper":Ae(r);break;case"add-wall":he(t);break;case"del-room":o("ลบห้อง","ยืนยันการลบห้องนี้?",()=>j(r,"ลบห้องแล้ว"));break;case"del-set":o("ลบรายการ","ยืนยันการลบรายการผ้าม่าน?",()=>j(t.closest(d.set),"ลบรายการผ้าม่านแล้ว"));break;case"del-deco":o("ลบรายการ","ยืนยันการลบรายการตกแต่ง?",()=>j(t.closest(d.decoItem),"ลบรายการตกแต่งแล้ว"));break;case"del-wallpaper":o("ลบรายการ","ยืนยันการลบรายการวอลเปเปอร์?",()=>j(t.closest(d.wallpaperItem),"ลบรายการวอลเปเปอร์แล้ว"));break;case"del-wall":o("ลบผนัง","ยืนยันการลบผนังนี้?",()=>j(t.closest(".wall-input-row"),"ลบผนังแล้ว"));break;case"clear-room":o("ล้างข้อมูลในห้อง","ยืนยันลบทุกรายการในห้องนี้?",()=>{r.querySelector(d.setsContainer).innerHTML="",r.querySelector(d.decorationsContainer).innerHTML="",r.querySelector(d.wallpapersContainer).innerHTML="",oe(),R(),P(),b("ล้างข้อมูลในห้องแล้ว","success")});break;case"toggle-room-menu":e.preventDefault();const i=t.nextElementSibling;if(!i||!r)return;const u=!i.classList.contains("show");document.querySelectorAll(".room-options-menu.show").forEach(m=>m.classList.remove("show")),document.querySelectorAll(".card.overflow-visible").forEach(m=>m.classList.remove("overflow-visible")),u&&(i.classList.add("show"),r.classList.add("overflow-visible"));break;case"toggle-suspend-room":e.preventDefault(),r==null||r.classList.toggle("is-suspended"),R(),P(),(a=t.closest(".room-options-menu"))==null||a.classList.remove("show"),r==null||r.classList.remove("overflow-visible");break;case"toggle-suspend":e.preventDefault(),(s=t.closest(".item-card"))==null||s.classList.toggle("is-suspended"),Q(t),P();break;case"toggle-favorite":{const m=t.dataset.type,p=t.previousElementSibling,h=p==null?void 0:p.value;if(!h||h.trim()===""){b("กรุณากรอกรหัสก่อนบันทึก","warning");return}const _=t.closest(".item-card");if(!_)return;let w=0,v=null,f=null;if(m==="fabric"&&(v=_.querySelector('[name="set_price_per_m"]')),m==="sheer"&&(v=_.querySelector('[name="sheer_price_per_m"]')),m==="wallpaper"&&(v=_.querySelector('[name="wallpaper_price_roll"]')),m==="deco"&&(v=_.querySelector('[name="deco_price_sqyd"]'),f=(l=_.querySelector('[name="deco_type"]'))==null?void 0:l.value,!f)){b("กรุณาเลือกประเภทของตกแต่งก่อนบันทึก","warning");return}v&&v.value&&(w=g(v.value));const S=le(m,h,w,f);W(p),b(S?"บันทึกรหัสโปรดแล้ว":"ลบรหัสโปรดแล้ว","success");break}case"select-favorite":{const m=t.dataset.code,p=t.dataset.price,h=t.closest(".form-group-with-favorites"),_=h?h.querySelector("input[data-favorite-type]"):V;if(_){_.value=m;const w=t.closest(".item-card");if(w&&p){const v=_.dataset.favoriteType;let f=null;v==="fabric"&&(f=w.querySelector('[name="set_price_per_m"]')),v==="sheer"&&(f=w.querySelector('[name="sheer_price_per_m"]')),v==="deco"&&(f=w.querySelector('[name="deco_price_sqyd"]')),v==="wallpaper"&&(f=w.querySelector('[name="wallpaper_price_roll"]')),f&&(f.tagName==="SELECT"?f.value=p:f.value=$(g(p)),f.dispatchEvent(new Event("change",{bubbles:!0})))}_.dispatchEvent(new Event("input",{bubbles:!0})),re(),b(`เลือกโค้ด ${m} แล้ว`,"success")}break}case"manage-favorites":{re();const m=t.dataset.type,p=t.dataset.subType||null;if(m==="deco"&&!p){b("กรุณาเลือกประเภทของตกแต่งก่อน","warning");return}Pe(m,p);break}case"del-favorite":{const{code:m,type:p,subType:h}=t.dataset;le(p,m,0,h),(c=t.closest(".fav-manager-item"))==null||c.remove(),V&&fe(V);const _=document.getElementById("favManagerBody");_&&!_.firstElementChild&&(_.innerHTML='<p class="empty-state">ไม่มีรายการโปรดที่บันทึกไว้</p>'),b("ลบรายการโปรดแล้ว","success"),document.querySelectorAll(`input[data-favorite-type="${p}"]`).forEach(W);break}}};function Ge(){B=!B,me()}function Je(){const e=document.querySelector(d.setTpl);if(!e)return;const t=e.content.querySelector('select[name="set_price_per_m"]'),n=e.content.querySelector('select[name="sheer_price_per_m"]'),r=o=>{let a='<option value="" hidden>เลือกราคา</option>';return o.forEach(s=>{a+=`<option value="${s}">${s.toLocaleString("th-TH")}</option>`}),a};t&&(t.innerHTML=r(te.fabric)),n&&(n.innerHTML=r(te.sheer))}function Qe(){Je(),de();const e=document.querySelector(d.orderForm),t=document.querySelector(d.fileImporter),n=document.querySelector(d.menuDropdown),r=document.querySelector(d.quickNavDropdown),o=document.querySelector("#pageBreakBuffer"),a=document.querySelector("#pageBreakBufferValue");o&&a&&o.addEventListener("input",()=>{a.textContent=o.value}),e.addEventListener("input",Oe),e.addEventListener("change",He),e.addEventListener("click",Ye),e.addEventListener("blur",We,!0),e.addEventListener("focusin",Ue);const s=c=>{const i=c.target.closest(d.room);i&&pe(i)};e.addEventListener("click",s),e.addEventListener("focusin",s),document.body.addEventListener("click",c=>{c.target.closest("summary")&&setTimeout(H,50)}),document.querySelector(d.lockBtn).addEventListener("click",Ge),document.querySelector(d.toggleAllRoomsBtn).addEventListener("click",Me),document.querySelector(d.quickNavBtn).addEventListener("click",c=>{c.stopPropagation(),n.classList.remove("show"),r.classList.toggle("show")}),document.querySelector(d.quickNavRoomList).addEventListener("click",c=>{const i=c.target.closest("a[data-jump-to]");if(i){c.preventDefault();const u=i.dataset.jumpTo,m=document.getElementById(u);m&&(document.body.classList.add("disable-animations"),m.open=!0,m.scrollIntoView({behavior:"auto",block:"start"}),m.classList.add("scrolling-jump"),setTimeout(()=>{m.classList.remove("scrolling-jump"),document.body.classList.remove("disable-animations"),H()},1e3)),r.classList.remove("show")}});const l=document.querySelector("#addRoomQuickNavBtn");if(l){const c=we(ee,700);l.addEventListener("click",i=>{i.stopPropagation(),c(),r.classList.remove("show")})}document.querySelector(d.menuBtn).addEventListener("click",c=>{c.stopPropagation(),r.classList.remove("show"),n.classList.toggle("show")}),document.querySelector("#themeToggleBtn").addEventListener("click",c=>{c.preventDefault(),Ie()}),document.querySelector("#overviewBtn").addEventListener("click",async c=>{c.preventDefault(),n.classList.remove("show");const i=O(),u=Te(i),m=document.querySelector("#overviewModalBody");m&&(m.innerHTML=u,Y("#overviewModal",()=>{}))}),document.querySelector(d.exportPdfBtn).addEventListener("click",async c=>{c.preventDefault(),n.classList.remove("show");const i=await Ne();if(!i)return;const u=O(),m=i.vatOption==="include"?C.baseVatRate:0,p=ke(u,{vatRate:m,pageBreakBuffer:i.pageBreakBuffer});if(!p){b("ไม่มีรายการที่มีราคาสำหรับสร้างเอกสาร","warning");return}i.exportMethod==="html"?Ve(p):je(p,i.exportMethod)}),document.querySelector(d.importBtn).addEventListener("click",c=>{c.preventDefault(),n.classList.remove("show"),t.click()}),t.addEventListener("change",c=>{var m;const i=(m=c.target.files)==null?void 0:m[0];if(!i)return;const u=new FileReader;u.onload=p=>{try{const h=JSON.parse(p.target.result);ie(h)}catch{b("ไฟล์ JSON ไม่ถูกต้อง","error")}},u.readAsText(i),c.target.value=null}),document.querySelector(d.exportBtn).addEventListener("click",c=>{c.preventDefault(),n.classList.remove("show");try{const i=O(),u=JSON.stringify(i,null,4),m=new Blob([u],{type:"application/json"}),p=URL.createObjectURL(m),h=document.createElement("a"),_=new Date,w=`${_.getFullYear()}${(_.getMonth()+1).toString().padStart(2,"0")}${_.getDate().toString().padStart(2,"0")}`,v=(i.customer_name||"data").trim().replace(/\s+/g,"-");h.href=p,h.download=`MTR-${v}-${w}.json`,h.click(),URL.revokeObjectURL(p),b("Export ข้อมูลสำเร็จ","success")}catch{b("Export ข้อมูลล้มเหลว","error")}}),document.querySelector(d.submitBtn).addEventListener("click",async c=>{if(c.preventDefault(),n.classList.remove("show"),await Z("ส่งข้อมูล","ยืนยันการส่งข้อมูลการประเมินราคา?")){const i=O();if(!i.customer_name&&!i.customer_phone){b("กรุณาระบุชื่อหรือเบอร์โทรลูกค้า","warning");return}b("กำลังส่งข้อมูล...","default");try{const u=await fetch(ve,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});u.ok?b("ส่งข้อมูลสำเร็จ!","success"):b(`ส่งข้อมูลล้มเหลว: ${u.status}`,"error")}catch{b("เกิดข้อผิดพลาดในการเชื่อมต่อ","error")}}}),document.querySelector(d.copyTextBtn).addEventListener("click",async c=>{c.preventDefault(),n.classList.remove("show");const i=document.querySelector(d.copyOptionsModal);if(i.querySelector('input[name="copy_option"][value="customer"]').checked=!0,await Y(d.copyOptionsModal)){const u=i.querySelector('input[name="copy_option"]:checked').value,m=$e(O(),u);try{await navigator.clipboard.writeText(m),b("คัดลอกสรุปสำเร็จ!","success")}catch{b("คัดลอกล้มเหลว","error")}}}),document.querySelector(d.clearItemsBtn).addEventListener("click",async c=>{c.preventDefault(),n.classList.remove("show"),await Z("ล้างทุกรายการ","คุณแน่ใจหรือไม่ว่าต้องการลบรายการสินค้าทั้งหมด (ข้อมูลลูกค้าและห้องจะยังคงอยู่)?")&&(document.querySelectorAll(d.room).forEach(i=>{i.querySelector(d.setsContainer).innerHTML="",i.querySelector(d.decorationsContainer).innerHTML="",i.querySelector(d.wallpapersContainer).innerHTML=""}),R(),P(),b("ล้างทุกรายการแล้ว","success"))}),document.querySelector(d.clearAllBtn).addEventListener("click",async c=>{c.preventDefault(),n.classList.remove("show"),await Z("ลบข้อมูลทั้งหมด","คุณแน่ใจหรือไม่ว่าต้องการลบข้อมูลทั้งหมดในฟอร์มนี้? การกระทำนี้ไม่สามารถย้อนกลับได้")&&(localStorage.removeItem(z),localStorage.removeItem("marnthara.theme"),Be(),window.location.reload())}),window.addEventListener("click",c=>{c.target.closest(".menu-container")||(n.classList.remove("show"),r.classList.remove("show")),c.target.closest(".room-options-container")||(document.querySelectorAll(".room-options-menu.show").forEach(i=>i.classList.remove("show")),document.querySelectorAll(".card.overflow-visible").forEach(i=>i.classList.remove("overflow-visible"))),c.target.closest(".form-group-with-favorites")||re()});try{const c=localStorage.getItem(z);if(c)ie(JSON.parse(c));else{ee();const i=document.querySelector("#customerDetailsCard");i&&(i.open=!0)}}catch{localStorage.removeItem(z),ee()}R(),me(),H(),U()}document.addEventListener("DOMContentLoaded",Qe);
