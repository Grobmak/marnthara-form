(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))n(a);new MutationObserver(a=>{for(const s of a)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function o(a){const s={};return a.integrity&&(s.integrity=a.integrity),a.referrerPolicy&&(s.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?s.credentials="include":a.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(a){if(a.ep)return;a.ep=!0;const s=o(a);fetch(a.href,s)}})();const Ne="input-ui/5.6.0-final",Fe="https://your-make-webhook-url.com/your-unique-path",fe="marnthara.input.v4",Re=500,I={name:"ม่านธารา ผ้าม่านและของตกแต่ง",address:"65/8 หมู่ 2 ต.ท่าศาลา อ.เมือง จ.ลพบุรี 15000",phone:"092-985-9395, 082-552-5595",taxId:"1234567890123",logoUrl:"https://i.imgur.com/l7y85nI.png",baseVatRate:.07,pdf:{paymentTerms:"ชำระมัดจำ 50%",priceValidity:"30 วัน",notes:["ราคานี้รวมค่าติดตั้งแล้ว","ชำระมัดจำ 50% เพื่อยืนยันการสั่งผลิตสินค้า","ใบเสนอราคานี้มีอายุ 30 วัน นับจากวันที่เสนอราคา"]}},Oe=1.19599,ve={ROLL_WIDTH_M:.53,ROLL_LENGTH_M:10,STRIPS_PER_ROLL_UNDER_2_5M:3},ye={fabric:[1e3,1100,1200,1300,1400,1500,1600,1700,1800,1900,2e3,2100,2200],sheer:[1e3,1100,1200,1300,1400,1500],style_surcharge:{ลอน:200,ตาไก่:0,จีบ:0},height:[{threshold:3.2,add_per_m:300},{threshold:2.8,add_per_m:200},{threshold:2.5,add_per_m:100}]},m={orderForm:"#orderForm",roomsContainer:"#rooms",setTpl:"#setTpl",clearAllBtn:"#clearAllBtn",lockBtn:"#lockBtn",setCount:"#setCount",modal:"#confirmationModal",modalTitle:"#modalTitle",modalBody:"#modalBody",room:"[data-room]",set:"[data-set]",decoItem:"[data-deco-item]",wallpaperItem:"[data-wallpaper-item]",allItemsContainer:"[data-all-items]",wallsContainer:"[data-walls-container]",sheerWrap:"[data-sheer-wrap]",roomNameInput:'input[name="room_name"]',toastContainer:"#toast-container",copyTextBtn:"#copyTextBtn",copyOptionsModal:"#copyOptionsModal",menuBtn:"#menuBtn",menuDropdown:"#menuDropdown",importBtn:"#importBtn",exportBtn:"#exportBtn",fileImporter:"#fileImporter",submitBtn:"#submitBtn",clearItemsBtn:"#clearItemsBtn",exportPdfBtn:"#exportPdfBtn",exportOptionsModal:"#exportOptionsModal",printableContent:"#printable-content",quickNavBtn:"#quickNavBtn",quickNavDropdown:"#quickNavDropdown",quickNavRoomList:"#quickNavRoomList",toggleAllRoomsBtn:"#toggleAllRoomsBtn"},g=e=>{typeof e=="string"&&(e=e.replace(/,/g,""));const t=parseFloat(e);return Number.isFinite(t)?t:0},J=e=>{const t=g(e);return t>0?t.toFixed(2):""},M=(e,t=2,o=!1)=>Number.isFinite(e)?e.toLocaleString("en-US",{minimumFractionDigits:o?2:t,maximumFractionDigits:o?2:t}):"0",q=(e,t=0)=>Number.isFinite(e)?e.toLocaleString("th-TH",{minimumFractionDigits:t,maximumFractionDigits:t}):"0",He=(e,t=150)=>{let o;return(...n)=>{clearTimeout(o),o=setTimeout(()=>e(...n),t)}},We=(e,t=700)=>{let o=!1;return(...n)=>{if(!o){o=!0;try{return e(...n)}finally{setTimeout(()=>{o=!1},t)}}}},L=e=>typeof e!="string"?"":e.replace(/[&<>"']/g,function(t){switch(t){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";default:return"&#039;"}}),ke=e=>typeof e!="string"?"":e.replace(/[\\/?%*:|"<>\x00-\x1f]/g,"").trim()||"file";function De(e){let t=g(e);if(isNaN(t))return"ข้อมูลตัวเลขไม่ถูกต้อง";if(t===0)return"ศูนย์บาทถ้วน";const o=["","หนึ่ง","สอง","สาม","สี่","ห้า","หก","เจ็ด","แปด","เก้า"],n=["","สิบ","ร้อย","พัน","หมื่น","แสน","ล้าน"];let a=Math.floor(t),s=Math.round((t-a)*100);const r=p=>{if(p===0)return"";let l="";const y=String(p);for(let c=0;c<y.length;c++){const d=y[c];y.length-1;const h=y.length-c-1;d!=="0"&&(h===1&&d==="1"?l+=n[h]:h===1&&d==="2"?l+="ยี่"+n[h]:h===0&&d==="1"&&y.length>1?l+="เอ็ด":l+=o[parseInt(d)]+n[h])}return l};let u="";if(a>0){const p=Math.floor(a/1e6),l=a%1e6;p>0&&(u+=r(p)+"ล้าน"),u+=r(l),u+="บาท"}let i="";return s>0?i=r(s)+"สตางค์":u+="ถ้วน",(u+i).trim()}const be="marnthara.favorites.v3";function U(){try{const e=localStorage.getItem(be),t={fabric:[],sheer:[],deco:{},wallpaper:[]};return e?{...t,...JSON.parse(e)}:t}catch(e){return console.error("Failed to parse favorites from localStorage",e),{fabric:[],sheer:[],deco:{},wallpaper:[]}}}function ce(e){try{localStorage.setItem(be,JSON.stringify(e))}catch(t){console.error("Failed to save favorites to localStorage",t)}}function je(e){if(!e||typeof e!="object")return console.error("Invalid favorites data for import."),!1;const o={...{fabric:[],sheer:[],deco:{},wallpaper:[]},...e};return ce(o),!0}function le(e,t,o){return t==="deco"?o?(e.deco[o]||(e.deco[o]=[]),e.deco[o]):null:(e[t]||(e[t]=[]),e[t])}function Ue(e,t,o,n=null){const a=U(),s=le(a,e,n);if(!s)return!1;const r=s.find(u=>u.code===t);return r?r.price=o:s.push({code:t,price:o}),s.sort((u,i)=>u.code.localeCompare(i.code)),ce(a),!0}function Ve(e,t,o,n=null){const a=U(),s=le(a,e,n);return!s||s.some(r=>r.code===t)?!1:(s.push({code:t,price:o}),s.sort((r,u)=>r.code.localeCompare(u.code)),ce(a),!0)}function Ye(e,t,o,n,a=null){const s=U(),r=le(s,e,a);if(!r||t!==o&&r.some(i=>i.code===o))return!1;const u=r.find(i=>i.code===t);return u?(u.code=o,u.price=n,r.sort((i,p)=>i.code.localeCompare(p.code)),ce(s),!0):!1}function Ie(e,t,o=null){const n=U(),a=le(n,e,o);if(!a)return!1;const s=a.findIndex(r=>r.code===t);return s>-1?(a.splice(s,1),ce(n),!0):!1}function qe(e,t,o=null){if(!e||!t)return;const n=U(),a=t.trim(),s=le(n,e,o);return s==null?void 0:s.find(r=>r.code===a)}function Je(e,t,o,n=null){const a=qe(e,t,n);return a&&a.price===o?(Ie(e,t,n),!1):(Ue(e,t,o,n),!0)}function Ge(){localStorage.removeItem(be),console.log("All favorites have been cleared.")}function z(){var o,n,a,s,r,u;const e=U(),t={app_version:Ne,customer_name:((o=document.querySelector('[name="customer_name"]'))==null?void 0:o.value)||"",customer_phone:((n=document.querySelector('[name="customer_phone"]'))==null?void 0:n.value)||"",customer_address:((a=document.querySelector('[name="customer_address"]'))==null?void 0:a.value)||"",customer_card_open:(s=document.querySelector("#customerDetailsCard"))==null?void 0:s.open,discount:{type:((r=document.querySelector("#discount_type"))==null?void 0:r.value)||"amount",value:g((u=document.querySelector("#discount_value"))==null?void 0:u.value)},rooms:[],favorites:e};return document.querySelectorAll(m.room).forEach(i=>{var l,y;const p={id:i.id,room_name:((l=i.querySelector(m.roomNameInput))==null?void 0:l.value)||"",is_suspended:i.classList.contains("is-suspended"),is_open:i.open,items:[]};(y=i.querySelector(m.allItemsContainer))==null||y.childNodes.forEach(c=>{var d,h,_,f,w,v,T,P,Q,V,pe,$,k,b,N,O,H,x,Y,j,K,B;c.nodeType===1&&(c.matches(m.set)?p.items.push({type:"set",width_m:g((d=c.querySelector('input[name="width_m"]'))==null?void 0:d.value),height_m:g((h=c.querySelector('input[name="height_m"]'))==null?void 0:h.value),style:((_=c.querySelector('select[name="set_style"]'))==null?void 0:_.value)||"",fabric_variant:((f=c.querySelector('select[name="fabric_variant"]'))==null?void 0:f.value)||"",price_per_m_raw:g((w=c.querySelector('select[name="set_price_per_m"]'))==null?void 0:w.value),sheer_price_per_m:g((v=c.querySelector('select[name="sheer_price_per_m"]'))==null?void 0:v.value),fabric_code:((T=c.querySelector('input[name="fabric_code"]'))==null?void 0:T.value)||"",sheer_fabric_code:((P=c.querySelector('input[name="sheer_fabric_code"]'))==null?void 0:P.value)||"",opening_style:((Q=c.querySelector('select[name="opening_style"]'))==null?void 0:Q.value)||"",track_color:((V=c.querySelector('select[name="track_color"]'))==null?void 0:V.value)||"",notes:((pe=c.querySelector('input[name="notes"]'))==null?void 0:pe.value)||"",is_suspended:c.classList.contains("is-suspended")}):c.matches(m.decoItem)?p.items.push({type:"deco",deco_type:(($=c.querySelector('[name="deco_type"]'))==null?void 0:$.value)||"",width_m:g((k=c.querySelector('[name="deco_width_m"]'))==null?void 0:k.value),height_m:g((b=c.querySelector('[name="deco_height_m"]'))==null?void 0:b.value),price_sqyd:g((N=c.querySelector('[name="deco_price_sqyd"]'))==null?void 0:N.value),deco_code:((O=c.querySelector('[name="deco_code"]'))==null?void 0:O.value)||"",notes:((H=c.querySelector('[name="deco_notes"]'))==null?void 0:H.value)||"",is_suspended:c.classList.contains("is-suspended")}):c.matches(m.wallpaperItem)&&p.items.push({type:"wallpaper",height_m:g((x=c.querySelector('[name="wallpaper_height_m"]'))==null?void 0:x.value),wallpaper_code:((Y=c.querySelector('[name="wallpaper_code"]'))==null?void 0:Y.value)||"",price_per_roll:g((j=c.querySelector('[name="wallpaper_price_roll"]'))==null?void 0:j.value),install_cost_per_roll:g((K=c.querySelector('[name="wallpaper_install_cost"]'))==null?void 0:K.value),notes:((B=c.querySelector('[name="wallpaper_notes"]'))==null?void 0:B.value)||"",widths:Array.from(c.querySelectorAll('[name="wall_width_m"]')).map(Pe=>g(Pe.value)),is_suspended:c.classList.contains("is-suspended")}))}),t.rooms.push(p)}),t}function A(){localStorage.setItem(fe,JSON.stringify(z()))}const E={stylePlus:e=>ye.style_surcharge[e]??0,heightPlus:e=>{const t=[...ye.height].sort((o,n)=>n.threshold-o.threshold);for(const o of t)if(e>o.threshold)return o.add_per_m;return 0},fabricYardage:(e,t)=>{const o=g(t);return o<=0||!e?0:e==="ตาไก่"||e==="จีบ"?(o*2+.6)/.9:e==="ลอน"?(o*2.6+.6)/.9:0},wallpaperRolls:(e,t)=>{const o=g(e),n=g(t);if(o<=0||n<=0)return 0;const a=n>2.5?Math.floor(ve.ROLL_LENGTH_M/n):ve.STRIPS_PER_ROLL_UNDER_2_5M;if(a<=0)return 0;const s=Math.ceil(o/ve.ROLL_WIDTH_M);return Math.ceil(s/a)},calculateSetPrice:function(e){var r,u;if(!e||e.is_suspended||g(e.width_m)<=0)return{total:0,opaque:0,sheer:0};const t=this.stylePlus(e.style),o=this.heightPlus(g(e.height_m)),n=g(e.width_m),a=(r=e.fabric_variant)!=null&&r.includes("ทึบ")&&g(e.price_per_m_raw)>0?(g(e.price_per_m_raw)+t+o)*n:0,s=(u=e.fabric_variant)!=null&&u.includes("โปร่ง")&&g(e.sheer_price_per_m)>0?(g(e.sheer_price_per_m)+t+o)*n:0;return{total:Math.round(a+s),opaque:Math.round(a),sheer:Math.round(s)}},calculateDecoPrice:function(e){if(!e||e.is_suspended||g(e.width_m)<=0)return{total:0,sqm:0,sqyd:0};const t=g(e.width_m)*g(e.height_m),o=t*Oe,n=o*g(e.price_sqyd);return{total:Math.round(n),sqm:t,sqyd:o}},calculateWallpaperPrice:function(e){var r;if(!e||e.is_suspended)return{total:0,material:0,install:0,rolls:0,sqm:0};const t=((r=e.widths)==null?void 0:r.reduce((u,i)=>u+g(i),0))||0;if(t<=0)return{total:0,material:0,install:0,rolls:0,sqm:0};const o=g(e.height_m),n=this.wallpaperRolls(t,o),a=n*g(e.price_per_roll),s=n*g(e.install_cost_per_roll??300);return{total:Math.round(a+s),material:Math.round(a),install:Math.round(s),rolls:n,sqm:t*o}}};function Qe(e){return e.rooms.reduce((t,o)=>{var a;if(o.is_suspended)return t;const n=((a=o.items)==null?void 0:a.reduce((s,r)=>{if(r.is_suspended)return s;switch(r.type){case"set":return s+E.calculateSetPrice(r).total;case"deco":return s+E.calculateDecoPrice(r).total;case"wallpaper":return s+E.calculateWallpaperPrice(r).total;default:return s}},0))||0;return t+n},0)}function Ke(e,t){const o=Qe(e);let n=0,a="";e.discount&&e.discount.value>0&&(e.discount.type==="percent"?(n=o*(e.discount.value/100),a=`ส่วนลด (${e.discount.value}%): -${q(n)} บาท
`):(n=e.discount.value,a=`ส่วนลด: -${q(n)} บาท
`));const s=o-n;let r=`สรุปข้อมูล (${new Date().toLocaleDateString("th-TH",{day:"numeric",month:"numeric",year:"numeric"})})
`;if(r+=`ลูกค้า: ${e.customer_name||"-"}
`,(t==="customer"||t==="owner")&&(r+=`เบอร์โทร: ${e.customer_phone||"-"}
`,r+=`ที่อยู่: ${e.customer_address||"-"}
`),r+=`------------------------------
`,t==="customer")return r+=`
สรุปรายการ
`,e.rooms.forEach(u=>{if(u.is_suspended||!u.items)return;const i=u.items.filter(l=>l.is_suspended?!1:l.type==="wallpaper"?(l.widths||[]).reduce((y,c)=>y+c,0)>0:l.width_m>0);if(i.length===0)return;r+=`
*ห้อง: ${u.room_name||"ไม่ระบุ"}*
`;let p=0;i.forEach(l=>{switch(p++,l.type){case"set":r+=` ${p}) ผ้าม่าน ${l.style} (${l.fabric_variant})
`;break;case"deco":r+=` ${p}) ${l.deco_type||"ของตกแต่ง"}
`;break;case"wallpaper":r+=` ${p}) วอลเปเปอร์
`;break}})}),r+=`------------------------------
`,n>0&&(r+=`
ยอดรวม: ${q(o)} บาท
`,r+=a),r+=`
สรุปยอดสุทธิ: ${q(s)} บาท
`,r+=`
ขอบคุณที่ใช้บริการ
${I.name}
โทร: ${I.phone}`,r;if(t==="purchase_order"||t==="owner"){const u={opaqueFabrics:[],sheerFabrics:[],decorations:{},wallpapers:[],allSets:[]};e.rooms.forEach(c=>{c.is_suspended||!c.items||c.items.forEach(d=>{if(!d.is_suspended)switch(d.type){case"set":if(d.width_m<=0)return;u.allSets.push(d),d.fabric_variant.includes("ทึบ")&&u.opaqueFabrics.push({code:d.fabric_code||"??",yards:E.fabricYardage(d.style,d.width_m)}),d.fabric_variant.includes("โปร่ง")&&u.sheerFabrics.push({code:d.sheer_fabric_code||"??",yards:E.fabricYardage(d.style,d.width_m)});break;case"deco":if(!d.deco_type||d.width_m<=0)return;const h=d.deco_type;u.decorations[h]||(u.decorations[h]=[]),u.decorations[h].push({code:d.deco_code||"xxx",width:d.width_m,height:d.height_m});break;case"wallpaper":const _=(d.widths||[]).reduce((f,w)=>f+w,0);if(_>0){const f=E.wallpaperRolls(_,d.height_m);f>0&&u.wallpapers.push({code:d.wallpaper_code||"xxx",rolls:f})}break}})}),r+=`📋 *แจกแจงรายการสั่งซื้อ (ผ้า)*
`,r+=`------------------------------
`,u.opaqueFabrics.length>0&&u.opaqueFabrics.forEach(c=>{r+=`- ผ้าทึบ (Curtain Fabric)
`,r+=`  รหัส: #${c.code||"??"}
`,r+=`  จำนวน: ${c.yards.toFixed(2)} หลา

`}),u.sheerFabrics.length>0&&u.sheerFabrics.forEach(c=>{r+=`- ผ้าโปร่ง (Sheer Fabric)
`,r+=`  รหัส: #${c.code||"??"}
`,r+=`  จำนวน: ${c.yards.toFixed(2)} หลา

`});const i={};if([...u.opaqueFabrics,...u.sheerFabrics].forEach(c=>{i[c.code]=(i[c.code]||0)+c.yards}),Object.keys(i).length>0){r+=`------------------------------
`,r+=`📊 *สรุปยอดรวมผ้า (ตามรหัส)*
`,r+=`------------------------------
`;for(const[c,d]of Object.entries(i))r+=`  - รหัส #${c}: รวมทั้งหมด ${d.toFixed(2)} หลา
`;r+=`
`}if(r+=`------------------------------
`,r+=`📋 *สำหรับสั่งซื้อ ราง*
`,r+=`------------------------------

`,u.allSets.length>0){let c=1;u.allSets.forEach(d=>{r+=`(${c++}) รางม่าน: ${d.style}, สี: ${d.track_color}
`,d.fabric_variant.includes("ทึบ")&&(r+=`  - รางทึบ: ${Number(d.width_m).toFixed(2)} ม. (1 เส้น)
`),d.fabric_variant.includes("โปร่ง")&&(r+=`  - รางโปร่ง: ${Number(d.width_m).toFixed(2)} ม. (1 เส้น)
`),d.fabric_variant==="ทึบ&โปร่ง"&&(r+=`  (❗️ต้องใช้ขาสองชั้น)
`),r+=`
`})}const p={มู่ลี่ไม้:"Wooden Blind",ม่านม้วน:"Roller Blind",ม่านปรับแสง:"Vertical Blind",ฉากกั้นห้อง:"Partition",มุ้งจีบ:"Pleated Insect Screen",มู่ลี่อลูมิเนียม:"Aluminium Blind"},l=u.decorations;Object.keys(l).length>0&&Object.entries(l).forEach(([c,d])=>{const h=p[c]?` (${p[c]})`:"";r+=`------------------------------
`,r+=`📋 *สำหรับสั่งซื้อ ${c}${h}*
`,r+=`------------------------------

`,d.forEach(_=>{r+=`รหัส: #${_.code||"xxx"}
`,r+=`ขนาด: ${_.width.toFixed(2)} x ${_.height.toFixed(2)} m.
`,r+=`จำนวน: 1 ชุด

`})}),r+=`------------------------------
`,r+=`📋 *แจกแจงรายการสั่งซื้อ (Wallpaper)*
`,r+=`------------------------------

`,u.wallpapers.length>0&&u.wallpapers.forEach(c=>{r+=`- วอลเปเปอร์ -
`,r+=`  รหัส: #${c.code||"xxx"}
`,r+=`  จำนวน: ${c.rolls} ม้วน

`});const y={};if(u.wallpapers.forEach(c=>{y[c.code]=(y[c.code]||0)+c.rolls}),Object.keys(y).length>0){r+=`------------------------------
`,r+=`📊 *สรุปยอดรวมวอลเปเปอร์ (ตามรหัส)*
`,r+=`------------------------------
`;for(const[c,d]of Object.entries(y))r+=`  - รหัส #${c}: รวมทั้งหมด ${d} ม้วน
`;r+=`
`}if(r+=`------------------------------
`,t==="purchase_order")return r}return(t==="seamstress"||t==="owner")&&(r+=`
🧵 *รายละเอียดสำหรับช่าง*
`,e.rooms.forEach(u=>{if(u.is_suspended||!u.items)return;const i=u.items.filter(l=>l.type==="set"&&!l.is_suspended&&l.width_m>0);if(i.length===0)return;r+=`
*ห้อง: ${u.room_name||"ไม่ระบุ"}*
`;let p=1;i.forEach(l=>{r+=`${p++}) *ผ้าม่าน ${l.style} ${l.fabric_variant}*
`,r+=`  กว้าง ${Number(l.width_m).toFixed(2)} x สูง ${Number(l.height_m).toFixed(2)} ม.
`,r+=`  รูปแบบเปิด: ${l.opening_style}
`,l.fabric_variant.includes("ทึบ")&&(r+=`  ผ้าทึบ: รหัส ${l.fabric_code||"-"}
`),l.fabric_variant.includes("โปร่ง")&&(r+=`  ผ้าโปร่ง: รหัส ${l.sheer_fabric_code||"-"}
`)})}),r+=`------------------------------
`,t==="seamstress")||t==="owner"&&(r+=`
💰 *สรุปยอดรวม: ${q(s)} บาท*
`),r}function ze(e){if(!e.rooms||e.rooms.length===0)return'<p class="empty-summary">ไม่มีข้อมูลสำหรับแสดงผล</p>';const t={};let o=0,n="";if(e.rooms.forEach(r=>{if(r.is_suspended)return;const u={};r.items&&Array.isArray(r.items)&&r.items.forEach(p=>{if(!p.is_suspended)switch(p.type){case"set":if(E.calculateSetPrice(p).total>0){const l="ผ้าม่าน";u[l]=(u[l]||0)+1,t[l]=(t[l]||0)+1}break;case"deco":if(E.calculateDecoPrice(p).total>0){const l=p.deco_type||"ของตกแต่ง (ไม่ระบุประเภท)";u[l]=(u[l]||0)+1,t[l]=(t[l]||0)+1}break;case"wallpaper":if(E.calculateWallpaperPrice(p).total>0){const l="วอลเปเปอร์";u[l]=(u[l]||0)+1,t[l]=(t[l]||0)+1}break}});const i=Object.entries(u);i.length>0&&(n+=`<tr class="room-header-row"><td colspan="3">${L(r.room_name)||"ไม่ระบุชื่อห้อง"}</td></tr>`,i.forEach(([p,l])=>{n+=`<tr><td></td><td class="item-type-cell">${L(p)}</td><td class="pdf-text-center">${l}</td></tr>`,o+=l}))}),o===0)return'<p class="empty-summary">ไม่มีรายการที่มีราคาสำหรับแสดงผล</p>';let s=`<div id="detailed-material-summary">
        <h4><i class="ph ph-stack"></i> ยอดรวมทุกประเภท</h4>
        <ul>${Object.entries(t).map(([r,u])=>`<li><b>${L(r)}</b> <span>${u} รายการ</span></li>`).join("")}</ul>
    </div>`;return s+=`<table>
        <thead><tr><th>ห้อง</th><th>รายการ</th><th class="pdf-text-center">จำนวน</th></tr></thead>
        <tbody>${n}</tbody>
    </table>`,s}function Xe(e,t){const{vatRate:o,pageBreakBuffer:n=3}=t,a=[];e.rooms.forEach($=>{if($.is_suspended||!$.items)return;const k=[];$.items.forEach(b=>{if(!b.is_suspended)switch(b.type){case"set":const N=E.calculateSetPrice(b).total;if(N>0){let x=`ผ้าม่าน ${L(b.style)} (${L(b.fabric_variant)}) <br><small>ขนาด ${b.width_m.toFixed(2)} x ${b.height_m.toFixed(2)} ม.${b.notes?` - ${L(b.notes)}`:""}</small>`;k.push({description:x,total:N,units:x.includes("<br>")?1.5:1})}break;case"deco":const O=E.calculateDecoPrice(b).total;if(O>0){let x=`${L(b.deco_type)||"งานตกแต่ง"} <br><small>รหัส: ${L(b.deco_code)||"-"}, ขนาด ${b.width_m.toFixed(2)} x ${b.height_m.toFixed(2)} ม.</small>`;k.push({description:x,total:O,units:x.includes("<br>")?1.5:1})}break;case"wallpaper":const H=E.calculateWallpaperPrice(b).total;if(H>0){const x=(b.widths||[]).reduce((K,B)=>K+B,0),Y=E.wallpaperRolls(x,b.height_m);let j=`วอลเปเปอร์ <br><small>รหัส: ${L(b.wallpaper_code)||"-"}, สูง ${b.height_m.toFixed(2)} ม. (ใช้ ${Y} ม้วน)</small>`;k.push({description:j,total:H,units:j.includes("<br>")?1.5:1})}break}}),k.length>0&&(a.push({isRoomHeader:!0,roomName:L($.room_name)||"ไม่ระบุชื่อห้อง",units:1.2}),a.push(...k))});const s=a.reduce(($,k)=>$+(k.total||0),0);if(s===0)return null;let r=0,u="",i=s;e.discount&&e.discount.value>0&&(e.discount.type==="percent"?(r=s*(e.discount.value/100),u=`<tr><td class="pdf-label">ส่วนลด (${e.discount.value}%)</td><td class="pdf-amount">-${M(r,2,!0)}</td></tr>`):(r=e.discount.value,u=`<tr><td class="pdf-label">ส่วนลด</td><td class="pdf-amount">-${M(r,2,!0)}</td></tr>`),i=s-r,u+=`<tr><td class="pdf-label">ยอดหลังหักส่วนลด</td><td class="pdf-amount">${M(i,2,!0)}</td></tr>`);const p=i*o,l=i+p,y=17,c=23,d=[];let h=[],_=0;a.forEach(($,k)=>{const b=d.length===0?y:c,N=_+$.units>b;let O=!1;if(!N&&k<a.length-1){const H=b-(_+$.units);H>0&&H<n&&(O=!0)}(N||O)&&h.length>0&&(d.push(h),h=[],_=0),h.push($),_+=$.units}),h.length>0&&d.push(h);const f=new Date,w=f.toLocaleDateString("th-TH",{year:"numeric",month:"long",day:"numeric"}),v=`QT-${f.getFullYear()}${(f.getMonth()+1).toString().padStart(2,"0")}${f.getDate().toString().padStart(2,"0")}`;let T="",P=0,Q=1;d.forEach(($,k)=>{const b=k===0,N=k===d.length-1,O=`
            <div class="pdf-page-header">
                <div class="pdf-header">
                    <div class="pdf-shop-info">
                        ${`<img src="${I.logoUrl}" alt="Logo" class="pdf-logo">`}
                        <div class="pdf-shop-address">
                            <strong>${L(I.name)}</strong><br>
                            ${L(I.address).replace(/\n/g,"<br>")}<br>
                            โทร: ${L(I.phone)} | เลขประจำตัวผู้เสียภาษี: ${L(I.taxId)}
                        </div>
                    </div>
                    <div class="pdf-quote-details">
                        <div class="pdf-title-box"><h1>ใบเสนอราคา ${d.length>1?b?"":"(ต่อ)":""}</h1></div>
                        <table class="pdf-quote-meta">
                            <tr><td>เลขที่:</td><td>${v}</td></tr>
                            <tr><td>วันที่:</td><td>${w}</td></tr>
                        </table>
                    </div>
                </div>
                ${b?`
                <section class="pdf-customer-details">
                    <div class="pdf-customer-info">
                        <strong>ลูกค้า:</strong> ${L(e.customer_name)||""}<br>
                        <strong>ที่อยู่:</strong> ${L(e.customer_address).replace(/\n/g,"<br>")||""}<br>
                        <strong>โทร:</strong> ${L(e.customer_phone)||""}
                    </div>
                    <div class="pdf-customer-meta">
                        <strong>เงื่อนไขชำระเงิน:</strong> ${L(I.pdf.paymentTerms)}<br>
                        <strong>ยืนราคา:</strong> ${L(I.pdf.priceValidity)}
                    </div>
                </section>`:""}
            </div>`,H=`
            <div class="pdf-page-footer">
                <div class="pdf-footer-info">
                    <span>${L(I.name)} | โทร: ${L(I.phone)}</span>
                    <span>หน้า ${k+1} / ${d.length}</span>
                </div>
            </div>`;let x="";b||(x+=`<tr class="pdf-subtotal-row"><td colspan="4">ยอดยกมา (Brought Forward)</td><td class="pdf-text-right">${M(P,2,!0)}</td></tr>`),$.forEach(B=>{B.isRoomHeader?x+=`<tr class="pdf-room-header"><td colspan="5">ห้อง: ${B.roomName}</td></tr>`:(x+=`<tr><td class="pdf-text-center">${Q++}</td><td>${B.description}</td><td class="pdf-text-center">1</td><td class="pdf-text-right">${M(B.total,2,!0)}</td><td class="pdf-text-right">${M(B.total,2,!0)}</td></tr>`,P+=B.total)});let Y="";N||(Y=`<tfoot><tr class="pdf-subtotal-row"><td colspan="4">ยอดยกไป (Carried Forward)</td><td class="pdf-text-right">${M(P,2,!0)}</td></tr></tfoot>`);let j="";I.pdf.notes&&I.pdf.notes.length>0&&(j=`
                <strong>หมายเหตุ:</strong>
                <ul>${I.pdf.notes.map(B=>`<li>${L(B)}</li>`).join("")}</ul>
            `);const K=N?`
            <div class="pdf-summary-wrapper">
                <section class="pdf-summary-section">
                    <div class="pdf-amount-in-words">
                        ${j}
                        <div class="pdf-amount-text">( ${De(l)} )</div>
                    </div>
                    <div class="pdf-totals-block">
                        <table>
                            <tr><td class="pdf-label">รวมเป็นเงิน</td><td class="pdf-amount">${M(s,2,!0)}</td></tr>
                            ${u}
                            ${o>0?`<tr><td class="pdf-label">ภาษีมูลค่าเพิ่ม ${(o*100).toFixed(0)}%</td><td class="pdf-amount">${M(p,2,!0)}</td></tr>`:""}
                            <tr class="pdf-grand-total"><td class="pdf-label">ยอดรวมสุทธิ</td><td class="pdf-amount">${M(l,2,!0)}</td></tr>
                        </table>
                    </div>
                </section>
                <footer class="pdf-footer-section">
                    <div class="pdf-signature-box"><p>.................................................</p><p>ผู้เสนอราคา</p><p>(${L(I.name)})</p><p>วันที่: ${w}</p></div>
                    <div class="pdf-signature-box"><p>.................................................</p><p>ลูกค้า / ผู้มีอำนาจลงนาม</p><p>&nbsp;</p><p>วันที่: ......./......./............</p></div>
                </footer>
            </div>
        `:"";T+=`
            <div class="pdf-page">
                <div class="pdf-page-content">
                    ${O}
                    <div class="pdf-page-body">
                        <table class="pdf-items-table">
                            <thead><tr><th style="width:5%;">ลำดับ</th><th style="width:50%;">รายการ</th><th style="width:10%;">จำนวน</th><th style="width:17.5%;">ราคา/หน่วย</th><th style="width:17.5%;">รวม (บาท)</th></tr></thead>
                            <tbody>${x}</tbody>
                            ${Y}
                        </table>
                        ${K}
                    </div>
                    ${H}
                </div>
            </div>`});const V=e.customer_name||"quote",pe=ke(V);return{html:`<div id="quotation-template">${T}</div>`,fileName:`${v}_${pe}`}}let F=!1,ae=null,me=null,oe=!1,C=null,ee=null,_e=null,ge=!1;const Se="marnthara.theme";function Ee(){const e=localStorage.getItem(Se),t=document.querySelector("#themeToggleBtn");if(!t)return;const o=t.querySelector("i"),n=t.querySelector("span");switch(document.body.classList.remove("dark-theme","neutral-theme"),e){case"dark":document.body.classList.add("dark-theme"),o&&(o.className="ph-fill ph-sun"),n&&(n.textContent=" สว่าง");break;case"neutral":document.body.classList.add("neutral-theme"),o&&(o.className="ph-fill ph-moon"),n&&(n.textContent=" มืด");break;default:o&&(o.className="ph-fill ph-palette"),n&&(n.textContent=" กลาง");break}}function Ze(){const e=localStorage.getItem(Se);let t;!e||e==="light"?t="neutral":e==="neutral"?t="dark":t="light",localStorage.setItem(Se,t),Ee()}function S(e,t="default"){const o=document.querySelector(m.toastContainer);if(!o)return;const n={success:"ph-bold ph-check-circle",warning:"ph-bold ph-warning",error:"ph-bold ph-x-circle",default:"ph-bold ph-info"},a=document.createElement("div");a.className=`toast toast-${t}`,a.innerHTML=`<i class="${n[t]||n.default}"></i> ${e}`,o.appendChild(a),setTimeout(()=>a.classList.add("show"),10),setTimeout(()=>{a.classList.remove("show"),a.addEventListener("transitionend",()=>a.remove())},3e3)}function W(e,t){return new Promise(o=>{const n=document.querySelector(e);if(!n){o(null);return}const a=document.querySelector(".modal-wrapper.visible");a&&a.classList.add("is-underlay"),n.classList.add("visible");const s=n.querySelector('[id$="Confirm"]'),r=n.querySelector('[id$="Cancel"], [data-act="close-modal"]'),u=Array.from(n.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])')).filter(c=>!c.disabled&&c.offsetParent!==null),i=u[0],p=u[u.length-1];setTimeout(()=>i==null?void 0:i.focus(),50);const l=c=>{if(c.key==="Escape"&&!n.classList.contains("is-underlay")){y({cancelled:!0});return}if(c.key==="Tab"){if(u.length<=1){c.preventDefault();return}c.shiftKey?document.activeElement===i&&(p.focus(),c.preventDefault()):document.activeElement===p&&(i.focus(),c.preventDefault())}},y=c=>{n.classList.remove("visible"),document.removeEventListener("keydown",l),s&&(s.onclick=null),r&&(r.onclick=null),a&&a.classList.remove("is-underlay"),typeof c=="object"&&c.cancelled&&t&&t(),o(c)};s&&(s.onclick=()=>y(!0)),r&&(r.onclick=()=>{n.classList.contains("is-underlay")||y({cancelled:!0})}),document.addEventListener("keydown",l)})}async function ne(e,t){const o=document.querySelector(m.modal);if(!o)return!0;const n=o.querySelector(m.modalTitle),a=o.querySelector(m.modalBody);return n&&(n.textContent=e),a&&(a.textContent=t),await W(m.modal)===!0}async function et(){const e=document.querySelector(m.exportOptionsModal);if(!e)return null;const t=await W(m.exportOptionsModal);if(!t||t.cancelled)return null;const o=e.querySelector('input[name="vat_option"]:checked'),n=e.querySelector("#exportMethod"),a=e.querySelector("#pageBreakBuffer");return{vatOption:o?o.value:"include",exportMethod:n?n.value:"direct",pageBreakBuffer:a?parseInt(a.value,10):3}}async function tt(){const e=document.querySelector("#discountModal");if(!e)return;const t=e.querySelector("#discountSubtotal"),o=e.querySelector("#discountPercent"),n=e.querySelector("#discountAmount"),a=e.querySelector("#discountFinalTotal"),s=document.querySelector("#discount_type"),r=document.querySelector("#discount_value"),u=g(document.querySelector("#originalTotal").dataset.rawTotal||document.querySelector("#grandTotal").textContent);t.textContent=q(u);const i=c=>{if(ge)return;ge=!0;let d=0,h=0;if(c==="percent"){const _=g(o.value);d=_>=0?_:0,h=u*(d/100),h=Math.min(h,u),n.value=h>0?q(Math.round(h)):""}else if(h=g(n.value),h=h>=0?Math.min(h,u):0,d=h,u>0){const _=h/u*100;o.value=_>0&&isFinite(_)?M(_,2):""}else o.value="";a.textContent=q(u-h),setTimeout(()=>{ge=!1},20)};o.addEventListener("input",()=>i("percent")),n.addEventListener("input",()=>i("amount")),n.addEventListener("focus",c=>{const d=g(c.target.value);d>0&&(c.target.value=d)}),n.addEventListener("blur",c=>{const d=g(c.target.value);d>0&&(c.target.value=q(d)),i("amount")});const p=s.value,l=g(r.value);o.value="",n.value="",l>0?p==="percent"?(o.value=l,i("percent")):(n.value=q(l),i("amount")):i();const y=await W("#discountModal");if(y&&!y.cancelled){const c=g(o.value),d=g(n.value);document.activeElement===o&&c>0?(s.value="percent",r.value=c):d>0?(s.value="amount",r.value=d):(s.value="amount",r.value=0),R(),A()}}function te(e,t,o){e&&(e.classList.add("item-removing"),e.addEventListener("animationend",()=>{e.remove(),t&&S(t),o&&o(),ue(),ie(),R(),A(),Z()},{once:!0}))}function ie(){document.querySelectorAll(m.room).forEach(e=>{const t=e.querySelectorAll(".item-card:not(.is-suspended)"),o=t.length;t.forEach((n,a)=>{const s=n.querySelector("[data-item-title]");s&&(s.textContent=`${a+1}/${o}`)})})}function xe(){const e=document.querySelector(m.orderForm),t=document.querySelector(m.lockBtn);if(!e||!t)return;const o=e.querySelectorAll("input, select, textarea, button");e.classList.toggle("is-locked",F),t.classList.toggle("is-locked",F);const n=t.querySelector("i");n&&(n.className=F?"ph-bold ph-lock-key":"ph-bold ph-lock-key-open"),o.forEach(a=>{a.closest(".summary-footer")||a.closest(".main-header")||a.closest(".modal-wrapper")||a.dataset.act==="toggle-more-details"||(a.disabled=F)}),S(F?"ฟอร์มถูกล็อค":"ปลดล็อคฟอร์มแล้ว",F?"warning":"success")}function G(){const e=document.querySelectorAll(m.room);if(e.length===0)return;const t=[...e].some(n=>n.open),o=document.querySelector(m.toggleAllRoomsBtn);if(o){const n=o.querySelector("i"),a=o.querySelector("span");n&&(n.className="ph ph-rows"),a&&(a.textContent=t?"ย่อ":"ขยาย")}}function rt(){const e=document.querySelectorAll(m.room),t=[...e].some(o=>o.open);e.forEach(o=>{o.open=!t}),setTimeout(()=>{G(),A()},50)}function ue(){const e=document.querySelector(m.quickNavRoomList);if(!e)return;e.innerHTML="",document.querySelectorAll(m.room).forEach(o=>{const n=o.querySelector(m.roomNameInput),a=n?n.value:"ห้อง",s=document.createElement("a");s.href=`#${o.id}`,s.dataset.jumpTo=o.id,s.innerHTML=`<i class="ph ph-arrow-bend-left-up"></i> ${a||"ห้อง (ไม่มีชื่อ)"}`,e.appendChild(s)})}function Ce(e){const t=document.getElementById("quickNavBtnText");if(t)if(e){const o=e.querySelector('input[name="room_name"]');o&&(t.textContent=o.value||"...")}else t.textContent="ไปยังห้อง"}function Z(){if(me&&me.disconnect(),!document.getElementById("quickNavBtnText"))return;const t={root:null,rootMargin:"-60px 0px -150px 0px",threshold:0},o=a=>{const s=a.filter(r=>r.isIntersecting).sort((r,u)=>r.target.getBoundingClientRect().top-u.target.getBoundingClientRect().top);s.length>0&&Ce(s[0].target)};me=new IntersectionObserver(o,t),document.querySelectorAll(m.room).forEach(a=>me.observe(a))}function Be(){document.querySelectorAll("[data-favorite-type]").forEach(D)}function we(){const e=document.querySelector('[data-act="edit-selected-fav"]'),t=document.querySelector('[data-act="del-selected-fav"]');if(e&&t){const o=C!==null;e.disabled=!o,t.disabled=!o}}function he(e,t=null){const o=document.getElementById("favManagerBody");if(!o)return;const n=U();let a=[];if(e==="deco"?a=n.deco[t]||[]:a=n[e]||[],o.innerHTML="",a.length===0)o.innerHTML='<p class="empty-state">ไม่มีรายการโปรดที่บันทึกไว้</p>';else{const s=document.getElementById("favManagerItemTpl").innerHTML;a.forEach(r=>{const u=s.replace(/{CODE}/g,r.code).replace(/{PRICE}/g,q(r.price)).replace(/{RAW_PRICE}/g,r.price),i=document.createElement("div");i.innerHTML=u;const p=i.firstElementChild;p.dataset.type=e,t&&(p.dataset.subType=t),o.appendChild(p)})}C=null,we()}async function ot(e,t=null){oe=!1,C=null;const o=document.getElementById("favManagerTitle");if(!o)return;let n="รายการโปรด";e==="deco"?n=`รายการโปรด: ${t||"ของตกแต่ง"}`:n=`รายการโปรด: ${{fabric:"ผ้าทึบ",sheer:"ผ้าโปร่ง",wallpaper:"วอลเปเปอร์"}[e]||e}`,o.textContent=n,o.dataset.type=e,o.dataset.subType=t||"",he(e,t),await W("#favManagerModal"),oe&&(Be(),ae&&Me(ae))}async function nt(){const e=document.querySelector("#favAddModal");if(!e)return null;const t=e.querySelector("#fav_code_add"),o=e.querySelector("#fav_price_add");t.value="",o.value="";const n=await W("#favAddModal");return n&&!n.cancelled?{newCode:t.value.trim(),newPrice:g(o.value)}:null}async function at(e){const t=document.querySelector("#favEditModal");if(!t)return null;const o=t.querySelector("#fav_code_edit"),n=t.querySelector("#fav_price_edit");o.value=e.code,n.value=e.price;const a=await W("#favEditModal");return a&&!a.cancelled?{newCode:o.value.trim(),newPrice:g(n.value)}:null}function se(){document.querySelectorAll(".favorite-chips-container.show").forEach(e=>{e.classList.remove("show")}),document.querySelectorAll(".item-card.overflow-visible").forEach(e=>{e.classList.remove("overflow-visible")}),ae=null}function D(e){var l;if(!e||!e.matches("[data-favorite-type]"))return;const t=e.nextElementSibling;if(!t||!t.matches(".btn-favorite"))return;const o=t.dataset.type,n=e.value;if(!n){t.classList.remove("is-favorite"),t.querySelector("i").className="ph ph-star";return}const a=e.closest(".item-card");if(!a)return;let s=null;o==="deco"&&(s=(l=a.querySelector('[name="deco_type"]'))==null?void 0:l.value);let r,u;o==="fabric"&&(r=a.querySelector('[name="set_price_per_m"]')),o==="sheer"&&(r=a.querySelector('[name="sheer_price_per_m"]')),o==="deco"&&(r=a.querySelector('[name="deco_price_sqyd"]')),o==="wallpaper"&&(r=a.querySelector('[name="wallpaper_price_roll"]')),u=g(r==null?void 0:r.value);const i=qe(o,n,s),p=i&&i.price===u;t.classList.toggle("is-favorite",p),t.querySelector("i").className=p?"ph-fill ph-star":"ph ph-star"}function Me(e){var i,p;se();const t=e.dataset.favoriteType;if(!t)return;let o=null,n=[];const a=U();t==="deco"?(o=(p=(i=e.closest(".item-card"))==null?void 0:i.querySelector('[name="deco_type"]'))==null?void 0:p.value,o&&(n=a.deco[o]||[])):n=a[t]||[];const s=e.closest(".form-group-with-favorites").querySelector(".favorite-chips-container");if(!s)return;s.innerHTML="",n.length>0&&n.forEach(l=>{const y=document.createElement("button");y.type="button",y.className="btn-chip",y.textContent=l.code,y.dataset.act="select-favorite",y.dataset.code=l.code,y.dataset.price=l.price,s.appendChild(y)});const r=document.createElement("button");r.type="button",r.className="btn-manage-favorites",r.dataset.act="manage-favorites",r.dataset.type=t,o&&(r.dataset.subType=o),r.innerHTML='<i class="ph ph-pencil-simple"></i> แก้ไข',s.appendChild(r),s.classList.add("show");const u=e.closest(".item-card");u&&u.classList.add("overflow-visible")}async function Te(e,t=null){const o=document.querySelector("#itemTypeModal");if(!o)return null;o.querySelector("#itemTypeModalTitle").textContent=e;const n=o.querySelector(`input[name="item_type_option"][value="${t||"set"}"]`);n&&(n.checked=!0);const a=await W("#itemTypeModal");if(!a||a.cancelled)return null;const s=o.querySelector('input[name="item_type_option"]:checked');return s?s.value:null}function st(e,t){const n={set:"#setTpl",deco:"#decoTpl",wallpaper:"#wallpaperTpl"}[t];if(!n)return;const r=document.querySelector(n).content.cloneNode(!0).firstElementChild;if(t==="wallpaper"){const u=r.querySelector('[data-act="add-wall"]');u&&Le(u)}e.classList.add("item-removing"),e.addEventListener("animationend",()=>{e.replaceWith(r),r.classList.add("item-created"),r.scrollIntoView({behavior:"smooth",block:"center"});const u=r.querySelector('input:not([type="hidden"]), select, textarea');u&&u.focus(),ie(),R(),A(),S("เปลี่ยนประเภทรายการแล้ว","success")},{once:!0})}function de(e,t,o=!0){se();const n=document.querySelector(e);if(!n||!t)return null;const a=n.content.cloneNode(!0),s=a.firstElementChild;t.appendChild(a),s.querySelectorAll("input[data-favorite-type]").forEach(D),o&&s&&(s.classList.add("item-created"),s.scrollIntoView({behavior:"smooth",block:"center"}));const r=s.querySelector('input:not([type="hidden"]), select, textarea');return r&&r.focus(),ie(),R(),A(),s}function re(){const e=document.querySelector(m.roomsContainer);if(!e)return;const t=document.querySelectorAll(m.roomNameInput);let o=0;t.forEach(s=>{const r=s.value.match(/\d+/g);if(r){const u=parseInt(r[r.length-1],10);u>o&&(o=u)}});const n=o+1,a=de("#roomTpl",e,!0);if(a){a.id=`room-${Date.now()}`;const s=a.querySelector(m.roomNameInput);s&&(s.value=`ห้อง ${n}`),a.open=!0}ue(),G(),Z()}function ct(e){if(!e)return;const t=e.querySelector(m.allItemsContainer);t&&de("#setTpl",t)}function lt(e){if(!e)return;const t=e.querySelector(m.allItemsContainer);t&&de("#decoTpl",t)}function it(e){if(!e)return;const t=e.querySelector(m.allItemsContainer);if(t){const o=de("#wallpaperTpl",t);o&&Le(o.querySelector('[data-act="add-wall"]'))}}function Le(e){var o;const t=(o=e==null?void 0:e.closest(".walls-section"))==null?void 0:o.querySelector(m.wallsContainer);t&&(de("#wallTpl",t,!0),X(e))}function Ae(e){var a,s;if(!e)return;const t=(a=e.querySelector('select[name="fabric_variant"]'))==null?void 0:a.value,o=t&&t.includes("โปร่ง");(s=e.querySelector(m.sheerWrap))==null||s.classList.toggle("hidden",!o);const n=e.querySelector('input[name="sheer_fabric_code"]');if(n){const r=n.closest(".form-group-with-favorites");r&&r.classList.toggle("hidden",!o)}}function ut(e,t,o,n=null){let a=0;document.querySelectorAll(`
        [name="fabric_code"], 
        [name="sheer_fabric_code"], 
        [name="deco_code"], 
        [name="wallpaper_code"]
    `).forEach(r=>{var u;if(r.value.trim()===e){const i=r.closest(".item-card");if(!i)return;const p=r.dataset.favoriteType;let l=null;if(p===o){if(o==="deco"&&((u=i.querySelector('[name="deco_type"]'))==null?void 0:u.value)!==n)return;o==="fabric"&&(l=i.querySelector('[name="set_price_per_m"]')),o==="sheer"&&(l=i.querySelector('[name="sheer_price_per_m"]')),o==="deco"&&(l=i.querySelector('[name="deco_price_sqyd"]')),o==="wallpaper"&&(l=i.querySelector('[name="wallpaper_price_roll"]')),r.value=t.newCode,l&&(l.tagName==="SELECT"?l.value=t.newPrice:l.value=q(g(t.newPrice)),r.classList.add("input-highlight"),l.classList.add("input-highlight"),setTimeout(()=>{r.classList.remove("input-highlight"),l.classList.remove("input-highlight")},1500),l.dispatchEvent(new Event("change",{bubbles:!0}))),a++}}}),a>0&&S(`อัปเดต ${a} รายการที่ใช้รหัสนี้แล้ว`,"success")}function dt(e,t,o=null){document.querySelectorAll(`input[data-favorite-type="${t}"]`).forEach(n=>{var a;if(n.value.trim()===e)if(t==="deco"){const s=n.closest(".item-card");((a=s==null?void 0:s.querySelector('[name="deco_type"]'))==null?void 0:a.value)===o&&D(n)}else D(n)})}const pt=He(e=>{X(e),A()});function mt(e){if(F){S("ฟอร์มถูกล็อค ไม่สามารถแก้ไขได้","warning"),e.preventDefault();return}e.target.matches("input[data-favorite-type]")&&D(e.target),e.target.matches(m.roomNameInput)&&Z(),pt(e.target)}function ft(e){var n;if(F)return;const t=e.target;if(["set_price_per_m","sheer_price_per_m","deco_price_sqyd","wallpaper_price_roll"].includes(t.name)){const a=t.closest(".item-card");if(a){let s;if(t.name==="set_price_per_m"&&(s=a.querySelector('[name="fabric_code"]')),t.name==="sheer_price_per_m"&&(s=a.querySelector('[name="sheer_fabric_code"]')),t.name==="deco_price_sqyd"&&(s=a.querySelector('[name="deco_code"]')),t.name==="wallpaper_price_roll"&&(s=a.querySelector('[name="wallpaper_code"]')),s){const r=s.value;if(r){const u=s.dataset.favoriteType;let i=null;u==="deco"&&(i=(n=a.querySelector('[name="deco_type"]'))==null?void 0:n.value);const p=qe(u,r,i),l=g(t.value);p&&p.price!==l&&(s.value="",s.dispatchEvent(new Event("input",{bubbles:!0})))}D(s)}}}if(t.matches('select[name="fabric_variant"]')&&Ae(t.closest(m.set)),t.matches('select[name="deco_type"]')){const a=t.closest(m.decoItem);if(a){const s=a.querySelector(".item-type-changer .deco-type-display");s&&(s.textContent=t.value||"ตกแต่ง");const r=a.querySelector('input[name="deco_code"]');r&&(r.value="",D(r));const u=a.querySelector('input[name="deco_price_sqyd"]');u&&(u.value="")}}t.matches(m.roomNameInput)&&(ue(),Z()),X(t),A()}function ht(e){const t=e.target,o=t.matches('[name="deco_price_sqyd"], [name="wallpaper_price_roll"], [name="wallpaper_install_cost"], [name="fav_price_edit"], [name="fav_price_add"]'),n=t.matches('input[name="width_m"], input[name="height_m"], input[name="deco_width_m"], input[name="deco_height_m"], input[name="wallpaper_height_m"], input[name="wall_width_m"]');if(o){const a=g(t.value);a>0?t.value=q(a):t.value=""}else n&&(t.value=J(t.value))}function yt(e){const t=e.target;if(t.matches('[name="deco_price_sqyd"], [name="wallpaper_price_roll"], [name="wallpaper_install_cost"], [name="fav_price_edit"], [name="fav_price_add"]')){const n=g(t.value);n>0&&(t.value=n)}t.matches("input[data-favorite-type]")&&(ae=t,Me(t))}function X(e){var a,s,r,u,i,p,l,y,c,d,h,_;if(!e)return;const t=e.closest(m.set);if(t){const f=t.querySelector("[data-set-summary]");if(f){const w={width_m:(a=t.querySelector('input[name="width_m"]'))==null?void 0:a.value,height_m:(s=t.querySelector('input[name="height_m"]'))==null?void 0:s.value,style:(r=t.querySelector('select[name="set_style"]'))==null?void 0:r.value,fabric_variant:(u=t.querySelector('select[name="fabric_variant"]'))==null?void 0:u.value,price_per_m_raw:(i=t.querySelector('select[name="set_price_per_m"]'))==null?void 0:i.value,sheer_price_per_m:(p=t.querySelector('select[name="sheer_price_per_m"]'))==null?void 0:p.value},v=E.calculateSetPrice(w);t.dataset.totalPrice=v.total;let T=`ราคา: <b>${q(v.total)}</b> บ.`;v.opaque>0&&v.sheer>0&&(T+=` <small>(ทึบ: ${q(v.opaque)}, โปร่ง: ${q(v.sheer)})</small>`),f.innerHTML=T}}const o=e.closest(m.decoItem);if(o){const f=o.querySelector("[data-deco-summary]");if(f){const w={width_m:(l=o.querySelector('input[name="deco_width_m"]'))==null?void 0:l.value,height_m:(y=o.querySelector('input[name="deco_height_m"]'))==null?void 0:y.value,price_sqyd:(c=o.querySelector('input[name="deco_price_sqyd"]'))==null?void 0:c.value},v=E.calculateDecoPrice(w);o.dataset.totalPrice=v.total,f.innerHTML=`ราคา: <b>${q(v.total)}</b> บ. &bull; พื้นที่: ${M(v.sqyd,2)} ตร.หลา`}}const n=e.closest(m.wallpaperItem);if(n){const f=n.querySelector("[data-wallpaper-summary]");if(f){const w={height_m:(d=n.querySelector('input[name="wallpaper_height_m"]'))==null?void 0:d.value,price_per_roll:(h=n.querySelector('input[name="wallpaper_price_roll"]'))==null?void 0:h.value,install_cost_per_roll:(_=n.querySelector('input[name="wallpaper_install_cost"]'))==null?void 0:_.value,widths:Array.from(n.querySelectorAll('input[name="wall_width_m"]')).map(P=>P.value)},v=E.calculateWallpaperPrice(w);n.dataset.totalPrice=v.total;let T=`รวม: <b>${q(v.total)}</b> บ. `;(v.material>0||v.install>0)&&(T+=`<small>(วอลล์: ${q(v.material)}, ค่าช่าง: ${q(v.install)})</small>`),T+=` &bull; พื้นที่: ${M(v.sqm,2)} ตร.ม. &bull; ใช้: ${v.rolls} ม้วน`,f.innerHTML=T}}R()}function R(){let e=0,t=0;document.querySelectorAll(m.room).forEach(y=>{let c=0,d=0;const h=y.classList.contains("is-suspended");y.querySelectorAll(".item-card").forEach(f=>{const w=g(f.dataset.totalPrice),v=f.classList.contains("is-suspended");!h&&!v&&(c+=w,w>0&&d++)});const _=y.querySelector("[data-room-brief]");_&&(h?_.textContent="(ระงับชั่วคราว)":d>0?_.innerHTML=`<span>${d}</span> &bull; ${q(c)} บาท`:_.innerHTML="<span>0</span> รายการ"),h||(e+=c,t+=d)});const o=document.querySelector("#discount_type"),n=document.querySelector("#discount_value"),a=o.value,s=g(n.value);let r=0;s>0&&(a==="percent"?r=e*(s/100):r=s);const u=e-r,i=document.querySelector("#grandTotal"),p=document.querySelector("#originalTotal"),l=document.querySelector(m.setCount);i&&(i.textContent=q(u)),l&&(l.textContent=t),p&&(r>0?(p.textContent=q(e),p.dataset.rawTotal=e,p.style.display="block"):(p.style.display="none",p.dataset.rawTotal=""))}function $e(e){if(e&&e.favorites&&(je(e.favorites)?(S("นำเข้ารายการโปรดสำเร็จ","success"),Be()):S("ข้อมูลรายการโปรดในไฟล์ไม่ถูกต้อง","warning")),!e||!e.rooms||!Array.isArray(e.rooms)){e.favorites||S("ไม่พบข้อมูลสำหรับนำเข้าในไฟล์","error");return}const t=document.querySelector(m.roomsContainer);if(!t)return;t.innerHTML="";const o=document.querySelector("#customer_name"),n=document.querySelector("#customer_phone"),a=document.querySelector("#customer_address");if(o&&(o.value=e.customer_name||""),n&&(n.value=e.customer_phone||""),a&&(a.value=e.customer_address||""),e.discount){const r=document.querySelector("#discount_type"),u=document.querySelector("#discount_value");r&&(r.value=e.discount.type||"amount"),u&&(u.value=e.discount.value||0)}const s=document.querySelector("#customerDetailsCard");s&&(s.open=e.customer_card_open??!0),e.rooms.forEach(r=>{!r.items&&(r.sets||r.decorations||r.wallpapers)&&(r.items=[],r.sets&&r.sets.forEach(f=>r.items.push({...f,type:"set"})),r.decorations&&r.decorations.forEach(f=>r.items.push({...f,type:"deco"})),r.wallpapers&&r.wallpapers.forEach(f=>r.items.push({...f,type:"wallpaper"})));const u=document.querySelector("#roomTpl");if(!u)return;const i=u.content.cloneNode(!0),p=i.querySelector(m.room);if(!p)return;p.id=r.id||`room-${Date.now()}`,r.is_suspended&&p.classList.add("is-suspended"),p.open=r.is_open===!0;const l=p.querySelector(m.roomNameInput);l&&(l.value=r.room_name||"ห้อง (ไม่มีชื่อ)");const y=p.querySelector(m.allItemsContainer),c=document.querySelector("#setTpl"),d=document.querySelector("#decoTpl"),h=document.querySelector("#wallpaperTpl"),_=document.querySelector("#wallTpl");y&&r.items&&r.items.forEach(f=>{let w,v;switch(f.type){case"set":if(!c)return;w=c.content.cloneNode(!0),v=w.querySelector(m.set),f.is_suspended&&v.classList.add("is-suspended"),v.querySelector('input[name="width_m"]').value=J(f.width_m),v.querySelector('input[name="height_m"]').value=J(f.height_m),v.querySelector('select[name="set_style"]').value=f.style||"ลอน",v.querySelector('select[name="fabric_variant"]').value=f.fabric_variant||"ทึบ",v.querySelector('select[name="set_price_per_m"]').value=f.price_per_m_raw||"",v.querySelector('select[name="sheer_price_per_m"]').value=f.sheer_price_per_m||"",v.querySelector('select[name="opening_style"]').value=f.opening_style||"แยกกลาง",v.querySelector('select[name="track_color"]').value=f.track_color||"ขาว",v.querySelector('input[name="fabric_code"]').value=f.fabric_code||"",v.querySelector('input[name="sheer_fabric_code"]').value=f.sheer_fabric_code||"",v.querySelector('input[name="notes"]').value=f.notes||"",Ae(v),y.appendChild(w);break;case"deco":if(!d)return;w=d.content.cloneNode(!0),v=w.querySelector(m.decoItem),f.is_suspended&&v.classList.add("is-suspended");const T=v.querySelector('select[name="deco_type"]');T.value=f.deco_type||"",v.querySelector(".deco-type-display").textContent=f.deco_type||"ตกแต่ง",v.querySelector('input[name="deco_width_m"]').value=J(f.width_m),v.querySelector('input[name="deco_height_m"]').value=J(f.height_m),v.querySelector('input[name="deco_price_sqyd"]').value=q(f.price_sqyd)||"",v.querySelector('input[name="deco_code"]').value=f.deco_code||"",v.querySelector('input[name="deco_notes"]').value=f.notes||"",y.appendChild(w);break;case"wallpaper":if(!h)return;w=h.content.cloneNode(!0),v=w.querySelector(m.wallpaperItem),f.is_suspended&&v.classList.add("is-suspended"),v.querySelector('input[name="wallpaper_height_m"]').value=J(f.height_m),v.querySelector('input[name="wallpaper_code"]').value=f.wallpaper_code||"",v.querySelector('input[name="wallpaper_price_roll"]').value=q(f.price_per_roll)||"",v.querySelector('input[name="wallpaper_install_cost"]').value=f.hasOwnProperty("install_cost_per_roll")?q(f.install_cost_per_roll):"300",v.querySelector('input[name="wallpaper_notes"]').value=f.notes||"";const P=v.querySelector(m.wallsContainer);P&&_&&f.widths&&f.widths.forEach(Q=>{const V=_.content.cloneNode(!0);V.querySelector('input[name="wall_width_m"]').value=J(Q),P.appendChild(V)}),y.appendChild(w);break}}),t.appendChild(i)}),document.querySelectorAll("input[data-favorite-type]").forEach(D),document.querySelectorAll(".item-card").forEach(r=>{X(r)}),ie(),R(),ue(),G(),Z(),S("นำเข้าข้อมูลฟอร์มสำเร็จ","success")}function vt(e){if(document.getElementById("loading-overlay"))return;const t=document.createElement("div");t.id="loading-overlay",t.innerHTML=`<div class="loading-spinner"></div><p>${e}</p>`,document.body.appendChild(t),document.body.style.overflow="hidden"}function _t(){const e=document.getElementById("loading-overlay");e&&e.remove(),document.body.style.overflow=""}async function gt(e,t){var n,a;const o=document.querySelector(m.printableContent);if(!o||!e||!e.html){S("ไม่พบข้อมูลสำหรับสร้างเอกสาร","error");return}if(t==="direct"){vt("กำลังสร้าง PDF...");const s=document.createElement("div");s.style.position="fixed",s.style.left="-300mm",s.style.top="0",s.style.width="210mm",s.style.background="#fff",s.innerHTML=e.html,document.body.appendChild(s),await new Promise(r=>setTimeout(r,500));try{const r={margin:0,filename:`${e.fileName}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0,logging:!1,width:((n=s.querySelector(".pdf-page"))==null?void 0:n.scrollWidth)||791.7,windowWidth:((a=s.querySelector(".pdf-page"))==null?void 0:a.scrollWidth)||791.7},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}};await html2pdf().from(s).set(r).save(),S("ดาวน์โหลด PDF สำเร็จ","success")}catch(r){console.error("PDF Generation Error:",r),S("สร้าง PDF ล้มเหลว, โปรดลองวิธีที่ 2 (พิมพ์)","error")}finally{_t(),document.body.removeChild(s)}}t==="print"&&(o.innerHTML=e.html,setTimeout(()=>{window.print(),setTimeout(()=>{o.innerHTML=""},1e3)},Re))}function St(e){if(!e||!e.html){S("ไม่พบข้อมูลสำหรับสร้างไฟล์ HTML","error");return}try{const t=`
            <!DOCTYPE html><html lang="th"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>${e.fileName}</title>
                <link rel="stylesheet" href="https://grobmak.github.io/marnthara-form/src/style.css">
                <style>#printable-content { display: block !important; } .pdf-page { border: 1px solid #eee; box-shadow: 0 0 10px rgba(0,0,0,0.1); margin: 10mm auto; }</style>
            </head>
            <body>${e.html}</body></html>`,o=new Blob([t],{type:"text/html;charset=utf-8"}),n=URL.createObjectURL(o),a=document.createElement("a");a.href=n,a.download=`${e.fileName}.html`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(n),S("ดาวน์โหลดไฟล์ HTML สำเร็จ","success")}catch(t){console.error("HTML Export Error:",t),S("สร้างไฟล์ HTML ล้มเหลว","error")}}const wt=async e=>{var u,i,p;const t=e.target.closest("[data-act]"),o=e.target.closest(".fav-manager-item");if(o&&!t&&o.closest("#favManagerBody")){C===o?(C.classList.remove("is-selected"),C=null):(C&&C.classList.remove("is-selected"),o.classList.add("is-selected"),C=o),we();return}if(!t)return;const n=["select-favorite","manage-favorites","close-modal","add-new-fav-form","edit-selected-fav","del-selected-fav","toggle-more-details","show-discount-modal"];if(F&&!t.closest(".unlockable")&&!n.includes(t.dataset.act))return;const a=t.dataset.act,s=t.closest(m.room),r=(l,y,c)=>{ne(l,y).then(d=>{d&&c()})};switch(a){case"add-room":re();break;case"add-item":{if(ee=t.closest(m.room),ee){const c=await Te("เพิ่มรายการใหม่");c==="set"&&ct(ee),c==="deco"&&lt(ee),c==="wallpaper"&&it(ee)}break}case"change-type":{_e=t.closest(".item-card");const c=t.dataset.currentType;if(_e){const d=await Te("เปลี่ยนประเภทรายการ",c);d&&d!==c&&await ne("ยืนยันการเปลี่ยนแปลง","ข้อมูลทั้งหมดในรายการนี้จะถูกลบและสร้างใหม่ คุณแน่ใจหรือไม่?")&&st(_e,d)}break}case"add-wall":Le(t);break;case"show-discount-modal":tt();break;case"toggle-more-details":{const c=t.closest(".item-card"),d=c==null?void 0:c.querySelector(".item-details-more");if(d){const h=d.classList.toggle("show");t.classList.toggle("expanded",h);const _=t.querySelector("i"),f=t.querySelector("span");_&&(_.className=h?"ph ph-caret-up":"ph ph-caret-down"),f&&(f.textContent=h?"ย่อน้อยลง":"เพิ่มเติม")}break}case"del-room":r("ลบห้อง","ยืนยันการลบห้องนี้?",()=>te(s,"ลบห้องแล้ว"));break;case"del-set":r("ลบรายการ","ยืนยันการลบรายการผ้าม่าน?",()=>te(t.closest(m.set),"ลบรายการผ้าม่านแล้ว"));break;case"del-deco":r("ลบรายการ","ยืนยันการลบรายการตกแต่ง?",()=>te(t.closest(m.decoItem),"ลบรายการตกแต่งแล้ว"));break;case"del-wallpaper":r("ลบรายการ","ยืนยันการลบรายการวอลเปเปอร์?",()=>te(t.closest(m.wallpaperItem),"ลบรายการวอลเปเปอร์แล้ว"));break;case"del-wall":{const c=t.closest(".wall-input-row"),d=t.closest(m.wallpaperItem);r("ลบผนัง","ยืนยันการลบผนังนี้?",()=>{te(c,"ลบผนังแล้ว",()=>{X(d)})});break}case"clear-room":r("ล้างข้อมูลในห้อง","ยืนยันลบทุกรายการในห้องนี้?",()=>{s.querySelector(m.allItemsContainer).innerHTML="",ie(),R(),A(),S("ล้างข้อมูลในห้องแล้ว","success")});break;case"toggle-room-menu":e.preventDefault();const l=t.nextElementSibling;if(!l||!s)return;const y=!l.classList.contains("show");document.querySelectorAll(".room-options-menu.show").forEach(c=>c.classList.remove("show")),document.querySelectorAll(".card.overflow-visible").forEach(c=>c.classList.remove("overflow-visible")),y&&(l.classList.add("show"),s.classList.add("overflow-visible"));break;case"toggle-suspend-room":e.preventDefault(),s==null||s.classList.toggle("is-suspended"),R(),A(),(u=t.closest(".room-options-menu"))==null||u.classList.remove("show"),s==null||s.classList.remove("overflow-visible");break;case"toggle-suspend":e.preventDefault(),(i=t.closest(".item-card"))==null||i.classList.toggle("is-suspended"),X(t),A();break;case"toggle-favorite":{const c=t.dataset.type,d=t.previousElementSibling,h=d==null?void 0:d.value;if(!h||h.trim()===""){S("กรุณากรอกรหัสก่อนบันทึก","warning");return}const _=t.closest(".item-card");if(!_)return;let f=0,w=null,v=null;if(c==="fabric"&&(w=_.querySelector('[name="set_price_per_m"]')),c==="sheer"&&(w=_.querySelector('[name="sheer_price_per_m"]')),c==="wallpaper"&&(w=_.querySelector('[name="wallpaper_price_roll"]')),c==="deco"&&(w=_.querySelector('[name="deco_price_sqyd"]'),v=(p=_.querySelector('[name="deco_type"]'))==null?void 0:p.value,!v)){S("กรุณาเลือกประเภทของตกแต่งก่อนบันทึก","warning");return}if(w&&w.value&&(f=g(w.value)),f<=0){S("กรุณากรอกราคาก่อนบันทึกเป็นรายการโปรด","warning");return}const T=Je(c,h,f,v);D(d),S(T?"บันทึกรหัสโปรดแล้ว":"ลบรหัสโปรดแล้ว","success");break}case"select-favorite":{const c=t.dataset.code,d=t.dataset.price,h=t.closest(".form-group-with-favorites"),_=h?h.querySelector("input[data-favorite-type]"):ae;if(_){_.value=c;const f=t.closest(".item-card");if(f&&d){const w=_.dataset.favoriteType;let v=null;w==="fabric"&&(v=f.querySelector('[name="set_price_per_m"]')),w==="sheer"&&(v=f.querySelector('[name="sheer_price_per_m"]')),w==="deco"&&(v=f.querySelector('[name="deco_price_sqyd"]')),w==="wallpaper"&&(v=f.querySelector('[name="wallpaper_price_roll"]')),v&&(v.tagName==="SELECT"?v.value=d:v.value=q(g(d)),v.classList.add("input-highlight"),setTimeout(()=>v.classList.remove("input-highlight"),1200),v.dispatchEvent(new Event("change",{bubbles:!0})))}_.dispatchEvent(new Event("input",{bubbles:!0})),se(),S(`เลือกโค้ด ${c} แล้ว`,"success")}break}case"manage-favorites":{se();const c=t.dataset.type,d=t.dataset.subType||null;if(c==="deco"&&!d){S("กรุณาเลือกประเภทของตกแต่งก่อน","warning");return}ot(c,d);break}case"del-selected-fav":{if(!C)return;const{type:c,subType:d,code:h}=C.dataset;r("ลบรายการโปรด",`ยืนยันการลบ "${h}"?`,()=>{Ie(c,h,d)&&(oe=!0,C.remove(),C=null,we(),S("ลบรายการโปรดแล้ว","success"),dt(h,c,d),document.querySelector(".fav-manager-item")||he(c,d))});break}case"edit-selected-fav":{if(!C)return;const{type:c,subType:d,code:h,price:_}=C.dataset,f=await at({code:h,price:_});if(f){if(!f.newCode){S("รหัสห้ามว่าง","error");return}Ye(c,h,f.newCode,f.newPrice,d)?(oe=!0,S("อัปเดตรายการแล้ว","success"),he(c,d),ut(h,f,c,d)):S("อัปเดตล้มเหลว รหัสอาจซ้ำซ้อน","error")}break}case"add-new-fav-form":{const{type:c,subType:d}=document.getElementById("favManagerTitle").dataset,h=await nt();if(h){if(!h.newCode){S("กรุณากรอกรหัส","error");return}if(h.newPrice<=0){S("กรุณากรอกราคา","error");return}Ve(c,h.newCode,h.newPrice,d)?(oe=!0,S("เพิ่มรายการใหม่สำเร็จ","success"),he(c,d)):S("เพิ่มล้มเหลว รหัสอาจซ้ำ","error")}break}}};function bt(){F=!F,xe()}function qt(){const e=document.querySelector(m.setTpl);if(!e)return;const t=e.content.querySelector('select[name="set_price_per_m"]'),o=e.content.querySelector('select[name="sheer_price_per_m"]'),n=a=>{let s='<option value="" hidden>เลือกราคา</option>';return a.forEach(r=>{s+=`<option value="${r}">${r.toLocaleString("th-TH")}</option>`}),s};t&&(t.innerHTML=n(ye.fabric)),o&&(o.innerHTML=n(ye.sheer))}function Lt(){qt(),Ee();const e=document.querySelector(m.orderForm),t=document.querySelector(m.fileImporter),o=document.querySelector(m.menuDropdown),n=document.querySelector(m.quickNavDropdown),a=document.querySelector("#pageBreakBuffer"),s=document.querySelector("#pageBreakBufferValue");a&&s&&a.addEventListener("input",()=>{s.textContent=a.value}),e.addEventListener("input",mt),e.addEventListener("change",ft),document.addEventListener("click",wt),e.addEventListener("blur",ht,!0),e.addEventListener("focusin",yt,!0);const r=i=>{const p=i.target.closest(m.room);p&&Ce(p)};e.addEventListener("click",r),e.addEventListener("focusin",r),document.body.addEventListener("click",i=>{i.target.closest("summary")&&setTimeout(()=>{G(),A()},50)}),document.querySelector(m.lockBtn).addEventListener("click",bt),document.querySelector(m.toggleAllRoomsBtn).addEventListener("click",rt),document.querySelector(m.quickNavBtn).addEventListener("click",i=>{var l;i.stopPropagation(),o.classList.remove("show");const p=!n.classList.contains("show");n.classList.toggle("show"),i.currentTarget.setAttribute("aria-expanded",p),p&&((l=document.querySelector(m.menuBtn))==null||l.setAttribute("aria-expanded","false"))}),document.querySelector(m.quickNavRoomList).addEventListener("click",i=>{var l;const p=i.target.closest("a[data-jump-to]");if(p){i.preventDefault();const y=p.dataset.jumpTo,c=document.getElementById(y);c&&(document.body.classList.add("disable-animations"),c.open=!0,c.scrollIntoView({behavior:"auto",block:"start"}),c.classList.add("scrolling-jump"),setTimeout(()=>{c.classList.remove("scrolling-jump"),document.body.classList.remove("disable-animations"),G()},1e3)),n.classList.remove("show"),(l=document.querySelector(m.quickNavBtn))==null||l.setAttribute("aria-expanded","false")}});const u=document.querySelector("#addRoomQuickNavBtn");if(u){const i=We(re,700);u.addEventListener("click",p=>{var l;p.stopPropagation(),i(),n.classList.remove("show"),(l=document.querySelector(m.quickNavBtn))==null||l.setAttribute("aria-expanded","false")})}document.querySelector(m.menuBtn).addEventListener("click",i=>{var l;i.stopPropagation(),n.classList.remove("show");const p=!o.classList.contains("show");o.classList.toggle("show"),i.currentTarget.setAttribute("aria-expanded",p),p&&((l=document.querySelector(m.quickNavBtn))==null||l.setAttribute("aria-expanded","false"))}),document.querySelector("#themeToggleBtn").addEventListener("click",i=>{i.preventDefault(),Ze()}),document.querySelector("#overviewBtn").addEventListener("click",async i=>{var c;i.preventDefault(),o.classList.remove("show"),(c=document.querySelector(m.menuBtn))==null||c.setAttribute("aria-expanded","false");const p=z(),l=ze(p),y=document.querySelector("#overviewModalBody");y&&(y.innerHTML=l,W("#overviewModal",()=>{}))}),document.querySelector(m.exportPdfBtn).addEventListener("click",async i=>{var d;i.preventDefault(),o.classList.remove("show"),(d=document.querySelector(m.menuBtn))==null||d.setAttribute("aria-expanded","false");const p=await et();if(!p)return;const l=z(),y=p.vatOption==="include"?I.baseVatRate:0,c=Xe(l,{vatRate:y,pageBreakBuffer:p.pageBreakBuffer});if(!c){S("ไม่มีรายการที่มีราคาสำหรับสร้างเอกสาร","warning");return}p.exportMethod==="html"?St(c):gt(c,p.exportMethod)}),document.querySelector(m.importBtn).addEventListener("click",i=>{var p;i.preventDefault(),o.classList.remove("show"),(p=document.querySelector(m.menuBtn))==null||p.setAttribute("aria-expanded","false"),t.click()}),t.addEventListener("change",i=>{var y;const p=(y=i.target.files)==null?void 0:y[0];if(!p)return;const l=new FileReader;l.onload=c=>{try{const d=JSON.parse(c.target.result);$e(d)}catch(d){S("ไฟล์ JSON ไม่ถูกต้อง","error"),console.error("JSON Parse Error:",d)}},l.readAsText(p),i.target.value=null}),document.querySelector(m.exportBtn).addEventListener("click",i=>{var p;i.preventDefault(),o.classList.remove("show"),(p=document.querySelector(m.menuBtn))==null||p.setAttribute("aria-expanded","false");try{const l=z(),y=JSON.stringify(l,null,4),c=new Blob([y],{type:"application/json"}),d=URL.createObjectURL(c),h=document.createElement("a"),_=new Date,f=`${_.getFullYear()}${(_.getMonth()+1).toString().padStart(2,"0")}${_.getDate().toString().padStart(2,"0")}`,w=`${_.getHours().toString().padStart(2,"0")}${_.getMinutes().toString().padStart(2,"0")}`,v=ke(l.customer_name||"data");h.href=d,h.download=`MTR-${f}${w}-${v}.json`,h.click(),URL.revokeObjectURL(d),S("Export ข้อมูลสำเร็จ","success")}catch{S("Export ข้อมูลล้มเหลว","error")}}),document.querySelector(m.submitBtn).addEventListener("click",async i=>{var p;if(i.preventDefault(),o.classList.remove("show"),(p=document.querySelector(m.menuBtn))==null||p.setAttribute("aria-expanded","false"),await ne("ส่งข้อมูล","ยืนยันการส่งข้อมูลการประเมินราคา?")){const l=z();if(!l.customer_name&&!l.customer_phone){S("กรุณาระบุชื่อหรือเบอร์โทรลูกค้า","warning");return}S("กำลังส่งข้อมูล...","default");try{const y=await fetch(Fe,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)});y.ok?S("ส่งข้อมูลสำเร็จ!","success"):S(`ส่งข้อมูลล้มเหลว: ${y.status}`,"error")}catch{S("เกิดข้อผิดพลาดในการเชื่อมต่อ","error")}}}),document.querySelector(m.copyTextBtn).addEventListener("click",async i=>{var y;i.preventDefault(),o.classList.remove("show"),(y=document.querySelector(m.menuBtn))==null||y.setAttribute("aria-expanded","false");const p=document.querySelector(m.copyOptionsModal);p.querySelector('input[name="copy_option"][value="customer"]').checked=!0;const l=await W(m.copyOptionsModal);if(l&&!l.cancelled){const c=p.querySelector('input[name="copy_option"]:checked').value,d=Ke(z(),c);try{await navigator.clipboard.writeText(d),S("คัดลอกสรุปสำเร็จ!","success")}catch{S("คัดลอกล้มเหลว","error")}}}),document.querySelector(m.clearItemsBtn).addEventListener("click",async i=>{var p;i.preventDefault(),o.classList.remove("show"),(p=document.querySelector(m.menuBtn))==null||p.setAttribute("aria-expanded","false"),await ne("ล้างทุกรายการ","คุณแน่ใจหรือไม่ว่าต้องการลบรายการสินค้าทั้งหมด (ข้อมูลลูกค้าและห้องจะยังคงอยู่)?")&&(document.querySelectorAll(m.room).forEach(l=>{const y=l.querySelector(m.allItemsContainer);y&&(y.innerHTML="")}),R(),A(),S("ล้างทุกรายการแล้ว","success"))}),document.querySelector(m.clearAllBtn).addEventListener("click",async i=>{var p;if(i.preventDefault(),o.classList.remove("show"),(p=document.querySelector(m.menuBtn))==null||p.setAttribute("aria-expanded","false"),await ne("ลบข้อมูลทั้งหมด",'คำเตือน! การกระทำนี้จะลบข้อมูลลูกค้า, ทุกรายการ, และ "รายการโปรด" ทั้งหมดอย่างถาวร ยืนยันหรือไม่?')){localStorage.removeItem(fe),localStorage.removeItem("marnthara.theme"),Ge();const l=document.querySelector("#customer_name"),y=document.querySelector("#customer_phone"),c=document.querySelector("#customer_address");l&&(l.value=""),y&&(y.value=""),c&&(c.value="");const d=document.querySelector("#discount_type"),h=document.querySelector("#discount_value");d&&(d.value="amount"),h&&(h.value="0");const _=document.querySelector(m.roomsContainer);_&&(_.innerHTML=""),R(),ue(),G(),re();const f=document.querySelector("#customerDetailsCard");f&&(f.open=!0),S("ลบข้อมูลทั้งหมดแล้ว เริ่มต้นใหม่","success")}}),window.addEventListener("click",i=>{var p,l;i.target.closest(".modal-wrapper")||(i.target.closest(".menu-container")||(o.classList.contains("show")&&(o.classList.remove("show"),(p=document.querySelector(m.menuBtn))==null||p.setAttribute("aria-expanded","false")),n.classList.contains("show")&&(n.classList.remove("show"),(l=document.querySelector(m.quickNavBtn))==null||l.setAttribute("aria-expanded","false"))),i.target.closest(".room-options-container")||(document.querySelectorAll(".room-options-menu.show").forEach(y=>y.classList.remove("show")),document.querySelectorAll(".card.overflow-visible").forEach(y=>y.classList.remove("overflow-visible"))),i.target.closest(".form-group-with-favorites")||se())}),window.addEventListener("beforeunload",A);try{const i=localStorage.getItem(fe);if(i&&i.length>2&&i!=="null")$e(JSON.parse(i));else{re();const p=document.querySelector("#customerDetailsCard");p&&(p.open=!0)}}catch(i){console.error("Failed to load data from localStorage:",i),localStorage.removeItem(fe),re()}R(),xe(),G(),Z()}document.addEventListener("DOMContentLoaded",Lt);
