(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))t(o);new MutationObserver(o=>{for(const n of o)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&t(r)}).observe(document,{childList:!0,subtree:!0});function s(o){const n={};return o.integrity&&(n.integrity=o.integrity),o.referrerPolicy&&(n.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?n.credentials="include":o.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function t(o){if(o.ep)return;o.ep=!0;const n=s(o);fetch(o.href,n)}})();const ut="vite-refactor/6.1.0",pt="https://your-make-webhook-url.com/your-unique-path",ge="marnthara.input.v6.1",ft=500,W={name:"ม่านธารา ผ้าม่านและของตกแต่ง",address:"65/8 หมู่ 2 ต.ท่าศาลา อ.เมือง จ.ลพบุรี 15000",phone:"092-985-9395, 082-552-5595",taxId:"1600668000020",logoUrl:"./assets/logo.png",baseVatRate:.07,pdf:{paymentTerms:"ชำระมัดจำ 50%",priceValidity:"30 วัน",notes:["ราคานี้รวมค่าติดตั้งแล้ว","ชำระมัดจำ 50% เพื่อยืนยืนการสั่งผลิตสินค้า","ใบเสนอราคานี้มีอายุ 30 วัน นับจากวันที่เสนอราคา"]}},mt=1.19599,ht={ROLL_WIDTH_M:.53,STRIPS_PER_ROLL_UNDER_2_5M:3},be={fabric:[1e3,1100,1200,1300,1400,1500,1600,1700,1800,1900,2e3,2100,2200,2300,2400,2500,2600,2700,2800,2900,3e3],sheer:[1e3,1100,1200,1300,1400,1500],louis:[2200,2300,2400,2500,2600,2700,2800,2900,3e3,3100,3200,3300,3400,3500],style_surcharge:{ลอน:200,ตาไก่:0,จีบ:0,ม่านพับ:0,ม่านแป๊บ:0,หลุยส์:0},height:[{threshold:3.2,add_per_m:300},{threshold:2.8,add_per_m:200},{threshold:2.5,add_per_m:100}]},R={set:{templateId:"#setTpl",name:"ผ้าม่าน"},wallpaper:{templateId:"#wallpaperTpl",name:"วอลล์เปเปอร์"},wooden_blind:{templateId:"#areaBasedTpl",name:"มู่ลี่ไม้"},roller_blind:{templateId:"#areaBasedTpl",name:"ม่านม้วน"},vertical_blind:{templateId:"#areaBasedTpl",name:"ม่านปรับแสง"},partition:{templateId:"#areaBasedTpl",name:"ฉากกั้นห้อง"},pleated_screen:{templateId:"#areaBasedTpl",name:"มุ้งจีบ"},aluminum_blind:{templateId:"#areaBasedTpl",name:"มู่ลี่อลูมิเนียม"}},m={orderForm:"#orderForm",roomsContainer:"#rooms",toastContainer:"#toast-container",printableContent:"#printable-content",filterStatusBar:"#filterStatusBar",menuBtn:"#menuBtn",menuDropdown:"#menuDropdown",undoBtn:"#undoBtn",themeToggleBtn:"#themeToggleBtn",overviewBtn:"#overviewBtn",copyTextBtn:"#copyTextBtn",visualReportsBtn:"#visualReportsBtn",exportPdfBtn:"#exportPdfBtn",submitBtn:"#submitBtn",importBtn:"#importBtn",exportBtn:"#exportBtn",importFavsBtn:"#importFavsBtn",exportFavsBtn:"#exportFavsBtn",clearItemsBtn:"#clearItemsBtn",clearAllBtn:"#clearAllBtn",lockBtn:"#lockBtn",quickNavBtn:"#quickNavBtn",quickNavDropdown:"#quickNavDropdown",quickNavRoomList:"#quickNavRoomList",quickNavBtnText:"#quickNavBtnText",toggleAllRoomsBtn:"#toggleAllRoomsBtn",suspendedItemsBtn:"#suspendedItemsBtn",suspendedCountBadge:"#suspendedCountBadge",originalTotal:"#originalTotal",grandTotal:"#grandTotal",fileImporter:"#fileImporter",favImporter:"#favImporter",customerCard:"#customerDetailsCard",customerNameInput:"#customer_name",customerPhoneInput:"#customer_phone",customerAddressInput:"#customer_address",room:".room-card",roomTpl:"#roomTpl",roomNameInput:'input[name="room_name"]',roomNameDisplay:"[data-room-name-display]",roomBrief:"[data-room-brief]",allItemsContainer:"[data-all-items]",roomDefaultsBtn:'[data-act="open-room-defaults"]',itemCard:".item-card",itemDetailsMore:".item-details-more",itemGrid:".item-grid",itemTitle:"[data-item-title]",toggleDetailsBtn:'[data-act="toggle-more-details"]',setTpl:"#setTpl",setWidthInput:'input[name="width_m"]',setHeightInput:'input[name="height_m"]',setStyleSelect:'select[name="set_style"]',setFabricVariantSelect:'select[name="fabric_variant"]',setPricePerMSelect:'select[name="set_price_per_m"]',setSheerPricePerMSelect:'select[name="sheer_price_per_m"]',setLouisPricePerMSelect:'select[name="louis_price_per_m"]',setFabricCodeInput:'input[name="fabric_code"]',setSheerCodeInput:'input[name="sheer_fabric_code"]',setOpeningStyleSelect:'select[name="opening_style"]',setAdjustmentSideSelect:'select[name="adjustment_side"]',setTrackColorInput:'input[name="track_color"]',setBracketColorInput:'input[name="bracket_color"]',setFinialColorInput:'input[name="finial_color"]',setGrommetColorInput:'input[name="grommet_color"]',setLouisValanceInput:'input[name="louis_valance"]',setLouisTasselsInput:'input[name="louis_tassels"]',setNotesInput:'input[name="notes"]',wallpaperTpl:"#wallpaperTpl",wallTpl:"#wallTpl",wallHeightInput:'[name="wallpaper_height_m"]',wallCodeInput:'[name="wallpaper_code"]',wallPriceRollInput:'[name="wallpaper_price_roll"]',wallInstallCostInput:'[name="wallpaper_install_cost"]',wallNotesInput:'[name="wallpaper_notes"]',wallWidthInput:'[name="wall_width_m"]',areaBasedTpl:"#areaBasedTpl",areaBasedItem:".area-based-item",areaWidthInput:'[name="area_width_m"]',areaHeightInput:'[name="area_height_m"]',areaPriceSqydInput:'[name="area_price_sqyd"]',areaCodeInput:'[name="area_code"]',areaNotesInput:'[name="area_notes"]',modal:"#confirmationModal",modalTitle:"#modalTitle",modalBody:"#modalBody",discountModal:"#discountModal",discountSubtotal:"#discountSubtotal",discountPercent:"#discountPercent",discountAmount:"#discountAmount",discountFinalTotal:"#discountFinalTotal",discountTypeInput:"#discount_type",discountValueInput:"#discount_value",copyOptionsModal:"#copyOptionsModal",visualReportsModal:"#visualReportsModal",lookbookModal:"#lookbookModal",lookbookModalBody:"#lookbookModalBody",exportOptionsModal:"#exportOptionsModal",pdfOptionsModal:"#pdfOptionsModal",exportPdfWithDetailsBtn:"#exportPdfWithDetailsBtn",exportPdfWithoutDetailsBtn:"#exportPdfWithoutDetailsBtn",itemTypeModal:"#itemTypeModal",itemTypeModalTitle:"#itemTypeModalTitle",hardwareModal:"#hardwareModal",modalTrackColor:'[name="modal_track_color"]',modalBracketColor:'[name="modal_bracket_color"]',modalFinialColor:'[name="modal_finial_color"]',modalGrommetColor:'[name="modal_grommet_color"]',modalLouisValance:'[name="modal_louis_valance"]',modalLouisTassels:'[name="modal_louis_tassels"]',trackColorGroup:"#trackColorGroup",bracketColorGroup:"#bracketColorGroup",finialColorGroup:"#finialColorGroup",grommetColorGroup:"#grommetColorGroup",louisValanceGroup:"#louisValanceGroup",louisTasselGroup:"#louisTasselGroup",hardwareApplyToRoomBtn:"#hardwareApplyToRoom",favoritesConflictModal:"#favoritesConflictModal",favoritesModal:"#favoritesModal",favoritesModalTitle:"#favoritesModalTitle",favoritesModalBody:"#favoritesModalBody",favSearchInput:"#favSearchInput",favSelectorItemTpl:"#favSelectorItemTpl",favInput:"input[data-favorite-type]",favManagerModal:"#favManagerModal",favManagerTitle:"#favManagerTitle",favManagerBody:"#favManagerBody",favManagerItemTpl:"#favManagerItemTpl",favManagerEditBtn:'#favManagerModal [data-act="edit-selected-fav"]',favManagerDelBtn:'#favManagerModal [data-act="del-selected-fav"]',favAddModal:"#favAddModal",favAddCodeInput:'[name="fav_code_add"]',favAddPriceInput:'[name="fav_price_add"]',favEditModal:"#favEditModal",favEditCodeInput:'[name="fav_code_edit"]',favEditPriceInput:'[name="fav_price_edit"]',roomDefaultsModal:"#roomDefaultsModal",roomDefaultsForm:"#roomDefaultsForm",roomDefaultsApplyBtn:"#roomDefaultsApplyBtn",roomDefaultsConfirmBtn:"#roomDefaultsConfirmBtn",roomDefaultsCancelBtn:"#roomDefaultsCancelBtn",overviewModal:"#overviewModal",overviewModalHeader:"#overviewModalHeader",overviewModalBody:"#overviewModalBody"},_=e=>{typeof e=="string"&&(e=e.replace(/,/g,""));const a=parseFloat(e);return Number.isFinite(a)?a:0},K=e=>{const a=_(e);return a>0?a.toFixed(2):""},We=e=>{const a=e.target,s=a.value.trim();if(s===""){a.value="";return}let t=_(s);if(t<=0){a.value="";return}s.includes(".")||(t=t/100),a.value=K(t)},oe=(e,a=2,s=!1)=>Number.isFinite(e)?e.toLocaleString("en-US",{minimumFractionDigits:s?2:a,maximumFractionDigits:s?2:a}):"0",B=(e,a=0)=>Number.isFinite(e)?e.toLocaleString("th-TH",{minimumFractionDigits:a,maximumFractionDigits:a}):"0",qe=(e,a=150)=>{let s;return(...t)=>{clearTimeout(s),s=setTimeout(()=>e(...t),a)}},yt=(e,a=200)=>{let s=0,t;return(...o)=>{const n=new Date().getTime();t&&(clearTimeout(t),t=null),n-s>=a?(s=n,e(...o)):t=setTimeout(()=>{s=new Date().getTime(),e(...o),t=null},a-(n-s))}},L=e=>e?e.replace(/[<>"'&]/g,a=>{switch(a){case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";case"'":return"&#39;";case"&":return"&amp;";default:return a}}):"",ot=e=>e?e.replace(/[<>:"/\\|?*]/g,"").replace(/[\s\n\t]+/g,"_").substring(0,100):"file";function _t(e){if(e=_(e),e===0)return"ศูนย์บาทถ้วน";if(e<0||e>99999999999999e-2)return"N/A";const a=["ศูนย์","หนึ่ง","สอง","สาม","สี่","ห้า","หก","เจ็ด","แปด","เก้า","สิบ"],s=["","สิบ","ร้อย","พัน","หมื่น","แสน","ล้าน"];e=parseFloat(e.toFixed(2));let t=Math.floor(e),o=Math.round((e-t)*100);const n=l=>{if(l===0)return"";let i="";const d=String(l);for(let c=0;c<d.length;c++){const p=d[c],u=d.length-c-1;p!=="0"&&(u===1&&p==="1"?i+=s[u]:u===1&&p==="2"?i+="ยี่"+s[u]:u===0&&p==="1"&&d.length>1?i+="เอ็ด":i+=a[parseInt(p)]+s[u])}return i};let r="";if(t>0){const l=Math.floor(t/1e6),i=t%1e6;l>0&&(r+=n(l)+"ล้าน"),r+=n(i),r+="บาท"}else r="ศูนย์บาท";return o===0?r+="ถ้วน":r+=n(o)+"สตางค์",r}const Ve="marnthara.favorites.v4",Se={fabric:[],sheer:[],wallpaper:[],wooden_blind:[],roller_blind:[],vertical_blind:[],partition:[],pleated_screen:[],aluminum_blind:[]};function ce(){try{const e=localStorage.getItem(Ve);return e?{...Se,...JSON.parse(e)}:Se}catch(e){return console.error("Failed to parse favorites from localStorage",e),Se}}function Ie(e){try{localStorage.setItem(Ve,JSON.stringify(e))}catch(a){console.error("Failed to save favorites to localStorage",a)}}function Ue(e){if(!e||typeof e!="object")return console.error("Invalid favorites data for import."),!1;const a={...Se,...e};return Ie(a),!0}function Oe(e){if(!e||typeof e!="object")return console.error("Invalid favorites data for merge."),0;const a=ce();let s=0;for(const t in e)Object.hasOwnProperty.call(e,t)&&Array.isArray(e[t])&&(a[t]||(a[t]=[]),e[t].forEach(o=>{o&&o.code&&o.hasOwnProperty("price")?a[t].some(r=>r.code===o.code)||(a[t].push({code:o.code,price:o.price}),s++):console.warn(`Skipping invalid favorite item during merge for type ${t}:`,o)}),a[t].sort((o,n)=>o.code.localeCompare(n.code)));return s>0&&Ie(a),s}function Je(e,a,s){const t=ce(),o=a?.trim();if(!o)return console.error(`Attempted to add favorite with empty code for type: ${e}`),!1;if(typeof s!="number"||isNaN(s)||s<0)return console.error(`Attempted to add favorite with invalid price (${s}) for code ${o}`),!1;if(!Object.hasOwnProperty.call(Se,e))return console.error(`Attempted to add favorite to an invalid type: ${e}`),!1;t[e]||(t[e]=[]);const n=t[e],r=n.find(l=>l.code===o);return r?r.price=s:n.push({code:o,price:s}),n.sort((l,i)=>l.code.localeCompare(i.code)),Ie(t),!0}function Ye(e,a){const s=ce(),t=a?.trim();if(!s[e]||!t)return!1;const o=s[e].findIndex(n=>n.code===t);return o>-1?(s[e].splice(o,1),Ie(s),!0):!1}function vt(){localStorage.removeItem(Ve),console.log("All favorites have been cleared.")}function J(){const e=ce(),a={app_version:ut,customer_name:document.querySelector(m.customerNameInput)?.value||"",customer_phone:document.querySelector(m.customerPhoneInput)?.value||"",customer_address:document.querySelector(m.customerAddressInput)?.value||"",customer_card_open:document.querySelector(m.customerCard)?.open,discount:{type:document.querySelector(m.discountTypeInput)?.value||"amount",value:_(document.querySelector(m.discountValueInput)?.value)},rooms:[],favorites:e};return document.querySelectorAll(m.room).forEach(s=>{const t={id:s.id,room_name:s.querySelector(m.roomNameInput)?.value||"",is_suspended:s.classList.contains("is-suspended"),is_open:s.open,room_defaults:JSON.parse(s.dataset.roomDefaults||"{}"),items:[]};s.querySelector(m.allItemsContainer)?.childNodes.forEach(o=>{if(o.nodeType!==1||!o.matches(m.itemCard))return;if(o.classList.contains("placeholder-item")){const l={type:"placeholder",is_suspended:o.classList.contains("is-suspended"),width_m:_(o.dataset.widthM),height_m:_(o.dataset.heightM)};t.items.push(l);return}const n=o.dataset.type;if(!n)return;let r={type:n,is_suspended:o.classList.contains("is-suspended")};if(n==="set")Object.assign(r,{width_m:_(o.querySelector(m.setWidthInput)?.value),height_m:_(o.querySelector(m.setHeightInput)?.value),style:o.querySelector(m.setStyleSelect)?.value||"",fabric_variant:o.querySelector(m.setFabricVariantSelect)?.value||"",price_per_m_raw:_(o.querySelector(m.setPricePerMSelect)?.value),sheer_price_per_m:_(o.querySelector(m.setSheerPricePerMSelect)?.value),louis_price_per_m:_(o.querySelector('select[name="louis_price_per_m"]')?.value),fabric_code:o.querySelector(m.setFabricCodeInput)?.value||"",sheer_fabric_code:o.querySelector(m.setSheerCodeInput)?.value||"",opening_style:o.querySelector(m.setOpeningStyleSelect)?.value||"",adjustment_side:o.querySelector(m.setAdjustmentSideSelect)?.value||"ปรับขวา",track_color:o.querySelector(m.setTrackColorInput)?.value||"ขาว",bracket_color:o.querySelector(m.setBracketColorInput)?.value||"ขาว",finial_color:o.querySelector(m.setFinialColorInput)?.value||"ขาว",grommet_color:o.querySelector(m.setGrommetColorInput)?.value||"เงิน",louis_valance:o.querySelector('input[name="louis_valance"]')?.value||"กล่องหลุยส์",louis_tassels:o.querySelector('input[name="louis_tassels"]')?.value||"สีเข้ากับผ้า",notes:o.querySelector(m.setNotesInput)?.value||""});else if(n==="wallpaper"){const l=o.querySelector(m.wallInstallCostInput),i=l?l.value:"";let d;i==="0"?d=0:_(i)>0?d=_(i):d=void 0,Object.assign(r,{height_m:_(o.querySelector(m.wallHeightInput)?.value),wallpaper_code:o.querySelector(m.wallCodeInput)?.value||"",price_per_roll:_(o.querySelector(m.wallPriceRollInput)?.value),install_cost_per_roll:d,notes:o.querySelector(m.wallNotesInput)?.value||"",widths:Array.from(o.querySelectorAll(m.wallWidthInput)).map(c=>_(c.value))})}else o.matches(m.areaBasedItem)&&(Object.assign(r,{width_m:_(o.querySelector(m.areaWidthInput)?.value),height_m:_(o.querySelector(m.areaHeightInput)?.value),price_sqyd:_(o.querySelector(m.areaPriceSqydInput)?.value),code:o.querySelector(m.areaCodeInput)?.value||"",notes:o.querySelector(m.areaNotesInput)?.value||""}),(n==="partition"||n==="pleated_screen")&&(r.opening_style=o.querySelector('select[name="opening_style"]')?.value||"แยกกลาง"),["wooden_blind","roller_blind","vertical_blind","aluminum_blind"].includes(n)&&(r.adjustment_side=o.querySelector('select[name="adjustment_side"]')?.value||"ปรับขวา"));t.items.push(r)}),a.rooms.push(t)}),a}function z(){try{const e=J();localStorage.setItem(ge,JSON.stringify(e))}catch(e){console.error("Failed to save data to localStorage:",e)}}const me=[],gt=10;function se(e){if(!e){console.warn("Attempted to push invalid state to undo stack.");return}try{const a=JSON.parse(JSON.stringify(e));me.push(a),me.length>gt&&me.shift()}catch(a){console.error("Failed to clone state for undo history:",a)}}function bt(){if(me.length!==0)return me.pop()}function St(){return me.length>0}const D={stylePlus:e=>be.style_surcharge[e]??0,heightPlus:e=>{const a=[...be.height].sort((s,t)=>t.threshold-s.threshold);for(const s of a)if(e>s.threshold)return s.add_per_m;return 0},fabricYardage:(e,a)=>{const s=_(a);if(s<=0)return 0;let t=0;switch(e){case"ลอน":case"ตาไก่":case"จีบ":t=2.5;break;case"ม่านพับ":t=1.2;break;case"หลุยส์":t=2.5;break;case"ม่านแป๊บ":t=0;break}return t>0?s*t*1.09361:0},calculateGrommets:e=>{const a=_(e.width_m);if(a<=0||e.style!=="ตาไก่")return 0;const s=a*2.5;let o=Math.ceil(s*100/12);return o%2!==0&&o++,o=Math.max(o,Math.ceil(a*4)*2),o},_calculateComponentPrice:e=>{const a=_(e.width),s=_(e.height),t=_(e.price_per_m);if(a<=0||s<=0||t<=0)return 0;if(e.style==="ม่านแป๊บ"){const c=a*t;return Math.round(c/10)*10}const o=D.stylePlus(e.style),n=D.heightPlus(s);let r=0;switch(e.style){case"ลอน":case"ตาไก่":case"จีบ":r=2.5;break;case"ม่านพับ":r=1.2;break;case"หลุยส์":r=2.5;break}if(r===0)return 0;const l=t,i=o+n,d=(l+i)*a*r;return Math.round(d/10)*10},calculateSetPrice:function(e){if(!e||e.is_suspended)return{total:0,opaque:0,sheer:0,louis:0};const s=e.fabric_variant||"ทึบ",t=e.style||"ลอน",o=_(e.width_m),n=_(e.height_m);let r=0,l=0,i=0;if(t==="หลุยส์"){const p=_(e.louis_price_per_m);o>0&&p>0&&(i=p*o,i=Math.round(i/10)*10),s.includes("ทึบ")&&(r=this._calculateComponentPrice({style:t,width:o,height:n,price_per_m:e.price_per_m_raw})),s.includes("โปร่ง")&&(l=this._calculateComponentPrice({style:t,width:o,height:n,price_per_m:e.sheer_price_per_m}))}else s.includes("ทึบ")&&(r=this._calculateComponentPrice({style:t,width:o,height:n,price_per_m:e.price_per_m_raw})),s.includes("โปร่ง")&&(l=this._calculateComponentPrice({style:t,width:o,height:n,price_per_m:e.sheer_price_per_m}));const d=r+l+i;let c=d;return d>0&&d<1e3&&(c=1e3),{total:c,opaque:r,sheer:l,louis:i}},wallpaperRolls:(e,a)=>{if(e<=0||a<=0)return 0;const{ROLL_WIDTH_M:s,STRIPS_PER_ROLL_UNDER_2_5M:t}=ht,o=Math.ceil(e/s);let n;return a<=2.5?n=t:a<=3.3?n=2:n=1,Math.ceil(o/n)},calculateAreaBasedPrice:function(e){if(!e||e.is_suspended)return{total:0,sqm:0,sqyd:0};const a=_(e.width_m),s=_(e.height_m),t=_(e.price_sqyd);if(a<=0||s<=0||t<=0)return{total:0,sqm:0,sqyd:0};const o=a*s;let n=o*mt;n<1?n=1:n=Math.ceil(n*2)/2;const r=n*t;return{total:Math.round(r),sqm:o,sqyd:n}},calculateWallpaperPrice:function(e){if(!e||e.is_suspended)return{total:0,material:0,install:0,rolls:0,sqm:0};const a=e.widths?.reduce((i,d)=>i+_(d),0)||0;if(a<=0)return{total:0,material:0,install:0,rolls:0,sqm:0};const s=_(e.height_m),t=this.wallpaperRolls(a,s),o=t*_(e.price_per_roll);let n=300;const r=e.install_cost_per_roll;r===0?n=0:typeof r=="number"&&r>0?n=r:_(r)>0&&(n=_(r));const l=t*n;return{total:Math.round(o+l),material:Math.round(o),install:Math.round(l),rolls:t,sqm:a*s}}},Q=Object.entries(R).reduce((e,[a,s])=>(e[a]=s.name,e),{});Q.set_louis="ม่านหลุยส์";function de(e){const{width:a=0,height:s=0}=e,t=15,o=100-t*2,n=100-t*2,r=a>0&&s>0?Math.min(o/a,n/s):1,l=a*r,i=s*r,d=(100-l)/2,c=(100-i)/2,p=`
        <line x1="${d}" y1="${c+i+5}" x2="${d+l}" y2="${c+i+5}" class="dimension-line" />
        <line x1="${d}" y1="${c+i+3}" x2="${d}" y2="${c+i+7}" class="dimension-tick" />
        <line x1="${d+l}" y1="${c+i+3}" x2="${d+l}" y2="${c+i+7}" class="dimension-tick" />
        <text x="50" y="${c+i+14}" class="dimension-text">${a.toFixed(2)} ม.</text>

        <line x1="${d-5}" y1="${c}" x2="${d-5}" y2="${c+i}" class="dimension-line" />
        <line x1="${d-7}" y1="${c}" x2="${d-3}" y2="${c}" class="dimension-tick" />
        <line x1="${d-7}" y1="${c+i}" x2="${d-3}" y2="${c+i}" class="dimension-tick" />
        <text x="${d-9}" y="50" class="dimension-text" transform="rotate(-90, ${d-9}, 50)">${s.toFixed(2)} ม.</text>
    `;return{x:d,y:c,svgWidth:l,svgHeight:i,lines:p}}function rt(e,{y:a,svgHeight:s}){if(!e.opening_style||e.opening_style==="สไลด์เดี่ยว")return"";const t=e.opening_style==="แยกกลาง"?"< >":"→";return`
        <rect x="40" y="${a+s/2-8}" width="20" height="16" rx="3" class="opening-text-bg" />
        <text x="50" y="${a+s/2+1}" class="opening-text">${t}</text>
    `}function Le(e,{x:a,y:s,svgWidth:t}){if(!e.adjustment_side)return"";const n=e.adjustment_side==="ปรับซ้าย"?a+8:a+t-8;return`
        <g class="adjustment-cord">
            <circle cx="${n}" cy="${s+3}" r="2"/>
            <line x1="${n}" y1="${s+5}" x2="${n}" y2="${s+15}"/>
        </g>
    `}function wt(e){const a=_(e.width_m),s=_(e.height_m);if(a<=0||s<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:t,y:o,svgWidth:n,svgHeight:r,lines:l}=de({width:a,height:s});let i="";const d=e.fabric_variant.includes("โปร่ง"),c=e.fabric_variant.includes("ทึบ"),p=(g,y)=>(e.opening_style||"แยกกลาง")==="แยกกลาง"?`
                <rect x="${t}" y="${o+y}" width="${n/2-1}" height="${r}" class="${g}" />
                <rect x="${t+n/2+1}" y="${o+y}" width="${n/2-1}" height="${r}" class="${g}" />
            `:`<rect x="${t}" y="${o+y}" width="${n}" height="${r}" class="${g}" />`;d&&(i+=p("curtain-panel-sheer",0)),c&&(i+=p("curtain-panel-opaque",d?-2:0));let u="";if(e.style==="ตาไก่"){const g=D.calculateGrommets(e)/((e.opening_style||"แยกกลาง")==="แยกกลาง"?2:1),y=Math.min(Math.floor(g),Math.max(8,Math.floor(n/8)));for(let h=0;h<y;h++){const b=t+n/(y>1?y-1:1)*h;u+=`<circle cx="${b}" cy="${o+2}" r="2" class="style-grommet" />`}}else if(e.style==="ลอน"){const g=Math.max(4,Math.floor(n/10));let y=`M ${t},${o}`;for(let h=0;h<g;h++)y+=" q 5,-4 10,0";u=`<path d="${y}" class="style-ripplefold-path" />`}else e.style==="จีบ"&&(u=`<text x="${t+2}" y="${o+5}" class="style-pleat-text">||| ||| ||| ||| |||</text>`);const f=rt(e,{y:o,svgHeight:r});return`<svg viewBox="0 0 100 100">${i}${u}${f}${l}</svg>`}function qt(e){const a=_(e.width_m),s=_(e.height_m);if(a<=0||s<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:t,y:o,svgWidth:n,svgHeight:r,lines:l}=de({width:a,height:s});let i="";const d=e.fabric_variant.includes("โปร่ง"),c=e.fabric_variant.includes("ทึบ"),p=(h,b)=>`
        <rect x="${t}" y="${o+b}" width="${n/2-1}" height="${r}" class="${h}" />
        <rect x="${t+n/2+1}" y="${o+b}" width="${n/2-1}" height="${r}" class="${h}" />
    `;d&&(i+=p("curtain-panel-sheer",0)),c&&(i+=p("curtain-panel-opaque",d?-2:0));const u=Math.max(3,Math.floor(n/15)),f=n/u;let g="";for(let h=0;h<u;h++){const b=t+h*f;g+=`<path d="M ${b},${o} Q ${b+f/2},${o+10} ${b+f},${o}" class="louis-swag" />`}g+=`
        <polygon points="${t},${o} ${t+8},${o} ${t},${o+15}" class="louis-tail" />
        <polygon points="${t+n},${o} ${t+n-8},${o} ${t+n},${o+15}" class="louis-tail" />
    `;let y="";if(e.louis_tassels&&e.louis_tassels!=="ไม่มี"){y+=`<circle cx="${t+5}" cy="${o+18}" r="2" class="louis-tassel" />`,y+=`<circle cx="${t+n-5}" cy="${o+18}" r="2" class="louis-tassel" />`;for(let h=1;h<u;h++)y+=`<circle cx="${t+h*f}" cy="${o+8}" r="2" class="louis-tassel" />`}return`<svg viewBox="0 0 100 100">${i}${g}${y}${l}</svg>`}function $t(e){const a=_(e.width_m),s=_(e.height_m);if(a<=0||s<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:t,y:o,svgWidth:n,svgHeight:r,lines:l}=de({width:a,height:s});let i=`<rect x="${t}" y="${o}" width="${n}" height="${r}" class="blind-frame" />`;const d=5,c=r/d;for(let u=0;u<d;u++)i+=`<rect x="${t+1}" y="${o+u*c}" width="${n-2}" height="${c-1.5}" class="blind-slat" />`;const p=Le(e,{x:t,y:o,svgWidth:n});return`<svg viewBox="0 0 100 100">${i}${l}${p}</svg>`}function Qe(e,a=!1){const s=_(e.width_m),t=_(e.height_m);if(s<=0||t<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:o,y:n,svgWidth:r,svgHeight:l,lines:i}=de({width:s,height:t});let d=`<rect x="${o}" y="${n}" width="${r}" height="${l}" class="blind-frame" />`;if(a){const p=Math.max(4,Math.floor(r/8)),u=r/p;for(let f=0;f<p;f++)d+=`<rect x="${o+f*u+1}" y="${n}" width="${u-2}" height="${l}" class="blind-slat" />`}else{const p=Math.max(3,Math.floor(l/6)),u=l/p;for(let f=0;f<p;f++)d+=`<rect x="${o+1}" y="${n+f*u+.5}" width="${r-2}" height="${u-1}" class="blind-slat" />`}const c=Le(e,{x:o,y:n,svgWidth:r});return`<svg viewBox="0 0 100 100">${d}${i}${c}</svg>`}function kt(e){const a=_(e.width_m),s=_(e.height_m);if(a<=0||s<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:t,y:o,svgWidth:n,svgHeight:r,lines:l}=de({width:a,height:s});let i=`<rect x="${t}" y="${o}" width="${n}" height="${r}" class="blind-frame" />`;const d=Math.max(3,Math.floor(r/8)),c=r/d;for(let h=0;h<d;h++)i+=`<rect x="${t+1}" y="${o+h*c}" width="${n-2}" height="${c-1.5}" rx="0.5" class="wooden-blind-slat" />`;const p=Math.max(2,n*.05),u=t+n*.25-p/2,f=t+n*.75-p/2,g=`
        <rect x="${u}" y="${o}" width="${p}" height="${r}" class="wooden-blind-strip" />
        <rect x="${f}" y="${o}" width="${p}" height="${r}" class="wooden-blind-strip" />
    `,y=Le(e,{x:t,y:o,svgWidth:n});return`<svg viewBox="0 0 100 100">${i}${g}${l}${y}</svg>`}function xt(e){const a=_(e.width_m),s=_(e.height_m);if(a<=0||s<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:t,y:o,svgWidth:n,svgHeight:r,lines:l}=de({width:a,height:s}),i=`
        <rect x="${t}" y="${o}" width="${n}" height="${r}" class="roller-fabric" />
        <rect x="${t-1}" y="${o-4}" width="${n+2}" height="5" rx="2" class="roller-roll" />
        <line x1="${t}" y1="${o+r}" x2="${t+n}" y2="${o+r}" class="roller-bar" />
    `,d=Le(e,{x:t,y:o-2,svgWidth:n});return`<svg viewBox="0 0 100 100">${i}${l}${d}</svg>`}function Ke(e,a=!1){const s=_(e.width_m),t=_(e.height_m);if(s<=0||t<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:o,y:n,svgWidth:r,svgHeight:l,lines:i}=de({width:s,height:t});let d="";if(a)d=`
            <defs>
                <pattern id="pleated-mesh" width="6" height="6" patternUnits="userSpaceOnUse">
                    <path d="M -1 1 L 1 -1 M 0 6 L 6 0" class="pleated-screen-mesh" />
                </pattern>
            </defs>
            <rect x="${o}" y="${n}" width="${r}" height="${l}" class="blind-frame" />
            <rect x="${o}" y="${n}" width="${r}" height="${l}" fill="url(#pleated-mesh)" />
        `;else{const p=Math.max(4,Math.floor(r/10)),u=r/p;for(let f=0;f<p;f++)d+=`<rect x="${o+f*u}" y="${n}" width="${u}" height="${l}" class="partition-panel" />`,f>0&&(d+=`<line x1="${o+f*u}" y1="${n}" x2="${o+f*u}" y2="${n+l}" class="partition-hinge" />`)}const c=rt(e,{y:n,svgHeight:l});return`<svg viewBox="0 0 100 100">${d}${c}${i}</svg>`}function Mt(e){const a=(e.widths||[]).reduce((u,f)=>u+_(f),0),s=_(e.height_m);if(a<=0||s<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:t,y:o,svgWidth:n,svgHeight:r,lines:l}=de({width:a,height:s});let i="";const d=Math.floor(n/10),c=Math.floor(r/10);for(let u=0;u<c;u++)for(let f=0;f<d;f++)i+=`<circle cx="${t+f*10+5}" cy="${o+u*10+5}" r="1.5" class="wallpaper-pattern" />`;return`<svg viewBox="0 0 100 100">${`<rect x="${t}" y="${o}" width="${n}" height="${r}" class="blind-frame" /> ${i}`}${l}</svg>`}function Tt(e,a,s){let t="",o=Q[e.type]||"ของตกแต่ง";switch(e.type){case"set":e.style==="ม่านพับ"?t=$t(e):e.style==="หลุยส์"?(t=qt(e),o=Q.set_louis||"ม่านหลุยส์"):t=wt(e);break;case"wooden_blind":t=kt(e);break;case"aluminum_blind":t=Qe(e,!1);break;case"vertical_blind":t=Qe(e,!0);break;case"roller_blind":t=xt(e);break;case"partition":t=Ke(e,!1);break;case"pleated_screen":t=Ke(e,!0);break;case"wallpaper":t=Mt(e);break;default:t=`<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">${L(o)}</text></svg>`;break}return`<div class="visual-placeholder is-clickable"
                 data-act="jump-to-item"
                 data-room-id="${a}"
                 data-item-index="${s}"
                 title="คลิกเพื่อไปยังรายการนี้">${t}</div>`}function Xe(e){let a=`
📃 *สรุปรายการสินค้า*
`,s=!1;return e.rooms.forEach(t=>{if(t.is_suspended||!t.items)return;const o=t.items.filter(r=>r.is_suspended?!1:r.type==="wallpaper"?(r.widths||[]).reduce((l,i)=>l+_(i),0)>0:r.type==="set"||R[r.type]?.templateId==="#areaBasedTpl"?_(r.width_m)>0:!0);if(o.length===0)return;s=!0,a+=`
*🚪 ห้อง: ${t.room_name||"ไม่ระบุ"}*
`;let n=0;o.forEach(r=>{n++;let l=Q[r.type]||"สินค้าตกแต่ง";r.type==="set"?r.style==="หลุยส์"?(l=Q.set_louis||"ม่านหลุยส์",a+=` ${n}) ${l} (${r.fabric_variant||""})
`):a+=` ${n}) ${l} ${r.style||""} (${r.fabric_variant||""})
`:a+=` ${n}) ${l}
`})}),s?a+`------------------------------
`:""}function at(e){return e.rooms.reduce((a,s)=>{if(s.is_suspended)return a;const t=s.items?.reduce((o,n)=>{if(n.is_suspended)return o;switch(n.type){case"set":return o+D.calculateSetPrice(n).total;case"wallpaper":return o+D.calculateWallpaperPrice(n).total;default:return R[n.type]?.templateId==="#areaBasedTpl"?o+D.calculateAreaBasedPrice(n).total:o}},0)||0;return a+t},0)}function It(e,a){const s=at(e);let t=0,o="";e.discount&&e.discount.value>0&&(e.discount.type==="percent"?(t=s*(e.discount.value/100),o=`🏷️ ส่วนลด (${e.discount.value}%): -${B(t)} บาท
`):(t=e.discount.value,o=`🏷️ ส่วนลด: -${B(t)} บาท
`));const n=s-t;let r=`🗓️ สรุปข้อมูล (${new Date().toLocaleDateString("th-TH",{day:"numeric",month:"short",year:"2-digit"})})
`;if(r+=`👤 ลูกค้า: ${e.customer_name||"-"}
`,(a==="customer"||a==="owner")&&(r+=`📞 โทร: ${e.customer_phone||"-"}
`,r+=`🏠 ที่อยู่: ${e.customer_address||"-"}
`),r+=`------------------------------
`,a==="customer")return r+=Xe(e),t>0&&(r+=`
ยอดรวม: ${B(s)} บาท
`,r+=o),r+=`
💰 *ยอดสุทธิ: ${B(n)} บาท*
`,r+=`
ขอบคุณที่ใช้บริการค่ะ
${W.name}
โทร: ${W.phone}`,r;if(a==="purchase_order"||a==="owner"){a==="owner"&&(r+=Xe(e));const l={opaqueFabrics:[],sheerFabrics:[],wallpapers:[],allSets:[]};e.rooms.forEach(v=>{v.is_suspended||!v.items||v.items.forEach(S=>{let k=!S.is_suspended;if(S.type==="set"||R[S.type]?.templateId==="#areaBasedTpl")k=k&&_(S.width_m)>0&&_(S.height_m)>0;else if(S.type==="wallpaper"){const M=(S.widths||[]).reduce((q,x)=>q+_(x),0);k=k&&M>0&&_(S.height_m)>0}if(k)switch(S.type){case"set":l.allSets.push(S),S.fabric_variant.includes("ทึบ")&&l.opaqueFabrics.push({code:S.fabric_code||"??",yards:D.fabricYardage(S.style,S.width_m)}),S.fabric_variant.includes("โปร่ง")&&l.sheerFabrics.push({code:S.sheer_fabric_code||"??",yards:D.fabricYardage(S.style,S.width_m)});break;case"wallpaper":const M=(S.widths||[]).reduce((x,$)=>x+_($),0),q=D.wallpaperRolls(M,S.height_m);q>0&&l.wallpapers.push({code:S.wallpaper_code||"xxx",rolls:q});break;default:if(R[S.type]?.templateId==="#areaBasedTpl"){const x=S.type;l[x]||(l[x]=[]),l[x].push({code:S.code||"xxx",width:_(S.width_m),height:_(S.height_m),opening_style:S.opening_style,adjustment_side:S.adjustment_side})}break}})});const i={};if([...l.opaqueFabrics,...l.sheerFabrics].forEach(v=>{v.yards>0&&(i[v.code]=(i[v.code]||0)+v.yards)}),Object.keys(i).length>0){r+=`✂️ *รายการสั่งซื้อ (ผ้า)*
`,r+=`------------------------------
`,l.opaqueFabrics.filter(v=>v.yards>0).forEach(v=>{r+=`- ผ้าทึบ (Curtain)
`,r+=`  รหัส: #${v.code||"??"}
`,r+=`  จำนวน: ${v.yards.toFixed(2)} หลา

`}),l.sheerFabrics.filter(v=>v.yards>0).forEach(v=>{r+=`- ผ้าโปร่ง (Sheer)
`,r+=`  รหัส: #${v.code||"??"}
`,r+=`  จำนวน: ${v.yards.toFixed(2)} หลา

`}),r+=`------------------------------
`,r+=`📊 *สรุปยอดรวมผ้า (ตามรหัส)*
`,r+=`------------------------------
`;for(const[v,S]of Object.entries(i))r+=`  - รหัส #${v}: ${S.toFixed(2)} หลา
`;r+=`
`}const d=l.allSets.filter(v=>v.style==="หลุยส์"),c=l.allSets.filter(v=>v.style==="ม่านพับ"),p=l.allSets.filter(v=>v.style==="ตาไก่"),u=l.allSets.filter(v=>!["ม่านพับ","ตาไก่","หลุยส์"].includes(v.style));if(d.length>0){r+=`------------------------------
`,r+=`👑 *รายการสั่งซื้อ ราง (หลุยส์)*
`,r+=`------------------------------

`;let v=1;d.forEach(q=>{r+=`(${v++}) ราง ${q.style}, สี: ${q.track_color||"ขาว"}
`,r+=`  - รางหลัก (ทึบ/โปร่ง): ${Number(q.width_m).toFixed(2)} ม.
`,r+=`  - หัวหลุยส์: ${q.louis_valance||"กล่องหลุยส์"}
`,r+=`  - พู่: ${q.louis_tassels||"สีเข้ากับผ้า"}
`,q.notes&&a==="owner"&&(r+=`  📝 หมายเหตุ: ${q.notes}
`),r+=`
`});const S=[];d.forEach(q=>{S.push(Number(q.width_m)),q.fabric_variant==="ทึบ&โปร่ง"&&S.push(Number(q.width_m))});const k=S.reduce((q,x)=>{const $=x.toFixed(2);return q[$]=(q[$]||0)+1,q},{}),M=Object.entries(k).sort((q,x)=>parseFloat(x[0])-parseFloat(q[0]));if(M.length>0){r+=`--- สรุปยอดรวมรางหลุยส์ ---
`,r+=`*จำนวนรางที่ต้องตัด (โดยประมาณ):*
`;for(const[q,x]of M)r+=`  - ขนาด ${q} ม. = ${x} เส้น
`;r+=`
`}}if(c.length>0){r+=`------------------------------
`,r+=`📏 *รายการสั่งซื้อ รางม่านพับ*
`,r+=`------------------------------

`;let v=1;c.forEach(M=>{r+=`(${v++}) รางม่านพับ
`,r+=`  - ขนาด: ${Number(M.width_m).toFixed(2)} ม.
`,r+=`  - สีราง: ${M.track_color||"ขาว"}
`,r+=`  - เชือกปรับ: ${M.adjustment_side||"ปรับขวา"}
`,M.notes&&a==="owner"&&(r+=`  📝 หมายเหตุ: ${M.notes}
`),r+=`
`});const S=c.reduce((M,q)=>{const x=Number(q.width_m).toFixed(2);return M[x]=(M[x]||0)+1,M},{}),k=Object.entries(S).sort((M,q)=>parseFloat(q[0])-parseFloat(M[0]));if(k.length>0){r+=`--- สรุปยอดรวมรางม่านพับ ---
`,r+=`*จำนวนรางที่ต้องตัด:*
`;for(const[M,q]of k)r+=`  - ขนาด ${M} ม. = ${q} เส้น
`;r+=`
`}}if(u.length>0){r+=`------------------------------
`,r+=`📏 *รายการสั่งซื้อ ราง (ลอน/จีบ)*
`,r+=`------------------------------

`;let v=1;u.forEach(q=>{r+=`(${v++}) ราง ${q.style}, สี: ${q.track_color||"ขาว"}
`,q.fabric_variant.includes("ทึบ")&&(r+=`  - รางทึบ: ${Number(q.width_m).toFixed(2)} ม.
`),q.fabric_variant.includes("โปร่ง")&&(r+=`  - รางโปร่ง: ${Number(q.width_m).toFixed(2)} ม.
`),q.notes&&a==="owner"&&(r+=`  📝 หมายเหตุ: ${q.notes}
`),r+=`
`});const S=[];u.forEach(q=>{q.fabric_variant.includes("ทึบ")&&S.push(Number(q.width_m)),q.fabric_variant.includes("โปร่ง")&&S.push(Number(q.width_m))});const k=S.reduce((q,x)=>{const $=x.toFixed(2);return q[$]=(q[$]||0)+1,q},{}),M=Object.entries(k).sort((q,x)=>parseFloat(x[0])-parseFloat(q[0]));if(M.length>0){r+=`--- สรุปยอดรวมรางลอน/จีบ ---
`,r+=`*จำนวนรางที่ต้องตัด:*
`;for(const[q,x]of M)r+=`  - ขนาด ${q} ม. = ${x} เส้น
`;r+=`
`}}if(p.length>0){r+=`------------------------------
`,r+=`📏 *รายการสั่งซื้อ ราง (ตาไก่)*
`,r+=`------------------------------

`;let v=1;p.forEach($=>{r+=`(${v++}) ราง ${$.style}, สี: ${$.track_color||"ขาว"}
`,$.fabric_variant.includes("ทึบ")&&(r+=`  - รางทึบ: ${Number($.width_m).toFixed(2)} ม.
`),$.fabric_variant.includes("โปร่ง")&&(r+=`  - รางโปร่ง: ${Number($.width_m).toFixed(2)} ม.
`),$.notes&&a==="owner"&&(r+=`  📝 หมายเหตุ: ${$.notes}
`),r+=`
`}),r+=`--- สรุปยอดรวมรางตาไก่ ---
`;const S=[];p.forEach($=>{$.fabric_variant.includes("ทึบ")&&S.push(Number($.width_m)),$.fabric_variant.includes("โปร่ง")&&S.push(Number($.width_m))});const k=6;S.sort(($,E)=>E-$);const M=[];for(const $ of S){let E=!1;for(let I=0;I<M.length;I++)if(M[I]>=$-.001){M[I]-=$,E=!0;break}E||M.push(k-$)}r+=`ใช้รางเต็ม (6 ม.) ทั้งหมด: *${M.length} เส้น*

`;const q=S.reduce(($,E)=>{const I=E.toFixed(2);return $[I]=($[I]||0)+1,$},{}),x=Object.entries(q).sort(($,E)=>parseFloat(E[0])-parseFloat($[0]));if(x.length>0){r+=`*สรุปจำนวนรางที่ต้องตัด:*
`;for(const[$,E]of x)r+=`  - ขนาด ${$} ม. = ${E} เส้น
`;r+=`
`}}const f={};let g={};l.allSets.forEach(v=>{const S=v.track_color||"ขาว",k=v.style,M=v.fabric_variant==="ทึบ&โปร่ง",q=_(v.width_m)>=1.6?3:2;if(f[S]||(f[S]={brackets:{},finials:0,grommets:{}}),f[S].brackets[k]||(f[S].brackets[k]={single:0,double:0}),k!=="ม่านพับ"&&k!=="หลุยส์"&&(M?f[S].brackets[k].double+=q:f[S].brackets[k].single+=q),k==="ตาไก่"){const x=M?4:2;f[S].finials+=x}if(k==="ตาไก่"){const x=v.grommet_color||"เงิน",$=D.calculateGrommets(v);f[S].grommets[x]||(f[S].grommets[x]=0),f[S].grommets[x]+=$}if(k==="หลุยส์"){const x=v.louis_tassels||"สีเข้ากับผ้า";x!=="ไม่มี"&&(g[x]=(g[x]||0)+2)}});const y=l.allSets.filter(v=>v.style!=="ม่านพับ"&&v.style!=="หลุยส์").length*2,h=Object.values(f).some(v=>Object.values(v.brackets).some(S=>S.single>0||S.double>0)||v.finials>0||Object.values(v.grommets).some(S=>S>0))||y>0,b=Object.keys(g).length>0;if(h||b){r+=`------------------------------
`,r+=`🔩 *รายการสั่งซื้อ อุปกรณ์ (Hardware)*
`,r+=`------------------------------

`;for(const[S,k]of Object.entries(f)){let M=!1,q=`**สี${S}**
`;const x=Object.keys(k.brackets);if(x.length>0){let E="";x.forEach(I=>{!["ม่านพับ","หลุยส์"].includes(I)&&(k.brackets[I].single>0||k.brackets[I].double>0)&&(E+=`    - ${I} (ชั้นเดียว): ${k.brackets[I].single} ตัว
`,E+=`    - ${I} (2ชั้น): ${k.brackets[I].double} ตัว
`)}),E&&(M=!0,q+=`  - ขาจับ:
${E}`)}k.finials>0&&(M=!0,q+=`  - หัวราง (ตาไก่): ${k.finials} ตัว
`);const $=Object.keys(k.grommets);if($.length>0){let E="";$.forEach(I=>{const V=k.grommets[I];V>0&&(E+=`    - สี${I}: ${V} ตัว
`)}),E&&(M=!0,q+=`  - ตาไก่:
${E}`)}M&&(r+=q+`
`)}let v="";if(y>0&&(v+=`  - ตะขอรวบม่าน (มาตรฐาน): ${y} ตัว
`),b){v+=`  - พู่/สายรวบ (หลุยส์):
`;for(const[S,k]of Object.entries(g))v+=`    - ${S}: ${k} ชุด
`}v&&(r+=`**อุปกรณ์รวม**
`+v+`
`)}const T=Object.keys(l).filter(v=>!["opaqueFabrics","sheerFabrics","wallpapers","allSets"].includes(v));T.length>0&&T.sort().forEach(v=>{const S=l[v],k=Q[v]||v;r+=`------------------------------
`,r+=`📦 *รายการสั่งซื้อ ${k}*
`,r+=`------------------------------

`,S.forEach(M=>{r+=`- รหัส: #${M.code||"xxx"}
  ขนาด: ${M.width.toFixed(2)} x ${M.height.toFixed(2)} ม.
`,M.opening_style&&(r+=`  รูปแบบเปิด: ${M.opening_style}
`),M.adjustment_side&&(r+=`  เชือกปรับ: ${M.adjustment_side}
`),r+=`
`})});const C={};if(l.wallpapers.forEach(v=>{C[v.code]=(C[v.code]||0)+v.rolls}),Object.keys(C).length>0){r+=`------------------------------
`,r+=`🎨 *รายการสั่งซื้อ (Wallpaper)*
`,r+=`------------------------------

`;for(const[v,S]of Object.entries(C))r+=`  - รหัส #${v}: ${S} ม้วน
`;r+=`
`}if(a==="purchase_order")return r+=`------------------------------
`,r}if(a==="seamstress"||a==="owner"){r+=`
🧵 *รายละเอียดสำหรับช่างเย็บผ้า*
`;let l=0;if(e.rooms.forEach(i=>{if(i.is_suspended||!i.items)return;const d=i.items.filter(c=>c.type==="set"&&!c.is_suspended&&_(c.width_m)>0&&_(c.height_m)>0);d.length!==0&&(l>0&&(r+=`==============================
`),r+=`
*🚪 ห้อง: ${i.room_name||"ไม่ระบุ"}*

`,d.forEach((c,p)=>{p>0&&(r+=`--------------------
`);const u=c.style==="หลุยส์"?Q.set_louis||"ม่านหลุยส์":c.style;r+=`*ชุดที่ ${p+1}/${d.length}: ${u} ${c.fabric_variant}*
`,c.style==="ม่านพับ"?r+=`  - เชือกปรับ: ${c.adjustment_side||"ปรับขวา"}
`:c.style==="หลุยส์"?(r+=`  - หัวหลุยส์: ${c.louis_valance||"กล่องหลุยส์"}
`,r+=`  - พู่: ${c.louis_tassels||"สีเข้ากับผ้า"}
`):r+=`  - รูปแบบเปิด: ${c.opening_style||"แยกกลาง"}
`,c.style==="หลุยส์"?(c.fabric_variant.includes("ทึบ")&&(r+=`  - ผ้าฐาน (ทึบ): #${c.fabric_code||"-"}
`),c.fabric_variant.includes("โปร่ง")&&(r+=`  - ผ้าฐาน (โปร่ง): #${c.sheer_fabric_code||"-"}
`)):(c.fabric_variant.includes("ทึบ")&&(r+=`  - ผ้าทึบ: #${c.fabric_code||"-"}
`),c.fabric_variant.includes("โปร่ง")&&(r+=`  - ผ้าโปร่ง: #${c.sheer_fabric_code||"-"}
`)),r+=`  - ขนาด: กว้าง ${Number(c.width_m).toFixed(2)} x สูง ${Number(c.height_m).toFixed(2)} ม.
`,c.notes&&a==="owner"&&(r+=`  📝 หมายเหตุ: ${c.notes}
`)}),r+=`
`,l++)}),l>0?r+=`==============================
`:r+=`ไม่มีรายการสำหรับช่าง
------------------------------
`,a==="seamstress")return r}return a==="owner"&&(r+=`
💰 *สรุปยอดรวม: ${B(n)} บาท*
`,t>0&&(r+=`   (ยอดก่อนลด: ${B(s)} บาท ${o.trim()})
`)),r}function Lt(e){if(!e.rooms||e.rooms.length===0)return'<p class="empty-summary">ไม่มีข้อมูลสำหรับแสดงผล</p>';let a="";const s={};let t=0;if(e.rooms.forEach(r=>{r.is_suspended||!r.items||r.items.forEach(l=>{if(l.is_suspended)return;let i=null,d=0;switch(l.type){case"set":d=D.calculateSetPrice(l).total,d>0&&(i=l.style==="หลุยส์"?"set_louis":"set");break;case"wallpaper":d=D.calculateWallpaperPrice(l).total,d>0&&(i=l.type);break;default:R[l.type]?.templateId==="#areaBasedTpl"&&(d=D.calculateAreaBasedPrice(l).total,d>0&&(i=l.type));break}i&&(s[i]=(s[i]||0)+1,t++)})}),t>0){const r=Object.entries(s).map(([l,i])=>{const d=Q[l]||Q[l.split("_")[0]]||"ของตกแต่ง";return`
                <span class="summary-tag" data-filter-type="${L(l)}" title="คลิกเพื่อกรองเฉพาะรายการนี้">
                    ${L(d)} <strong>${i}</strong>
                </span>`}).join("");r&&(a+=`
                <div class="overview-summary-group">
                    <h4><i class="ph ph-stack"></i> สรุปประเภทรายการ</h4>
                    <div class="summary-tags-container">
                        ${r}
                    </div>
                </div>`)}let o="",n=0;return e.rooms.forEach(r=>{if(r.is_suspended||!r.items)return;const l={};let i=0;if(r.items.forEach(d=>{if(d.is_suspended)return;let c=null,p=0;switch(d.type){case"set":p=D.calculateSetPrice(d).total,p>0&&(c=d.style==="หลุยส์"?"set_louis":"set");break;case"wallpaper":p=D.calculateWallpaperPrice(d).total,p>0&&(c=d.type);break;default:R[d.type]?.templateId==="#areaBasedTpl"&&(p=D.calculateAreaBasedPrice(d).total,p>0&&(c=d.type));break}c&&(l[c]=(l[c]||0)+1,i++)}),i>0){n+=i;const d=Object.entries(l).map(([c,p])=>{const u=Q[c]||Q[c.split("_")[0]]||"ของตกแต่ง";return`
                    <div class="overview-item">
                        <span>${L(u)}</span>
                        <span>${p}</span>
                    </div>`}).join("");o+=`
                <details class="overview-room-card">
                    <summary class="overview-room-summary">
                        <span class="room-name">${L(r.room_name)||"ไม่ระบุชื่อห้อง"}</span>
                        <div class="summary-tags">
                            <span class="room-item-count">${i} รายการ</span>
                            <i class="ph ph-caret-down expand-icon"></i>
                        </div>
                    </summary>
                    <div class="overview-room-items">${d}</div>
                </details>`}}),o&&(a+=`
            <div class="overview-breakdown-group">
                <h4><i class="ph ph-map-pin-line"></i> แจกแจงตามห้อง</h4>
                ${o}
            </div>`),t===0&&n===0?'<p class="empty-summary">ไม่มีรายการที่มีราคาสำหรับแสดงผล</p>':a}function Ct(e,a){const{vatRate:s=W.baseVatRate,pageBreakBuffer:t=3,showDetails:o=!0}=a,n=[];e.rooms.forEach($=>{if($.is_suspended||!$.items)return;const E=[];$.items.forEach(I=>{if(I.is_suspended)return;let V="",G=0,te=0,A=0,P=1,N=I.type==="set"&&I.style==="หลุยส์"?Q.set_louis||"ม่านหลุยส์":Q[I.type]||"สินค้าตกแต่ง",X="";switch(I.type){case"set":if(G=D.calculateSetPrice(I).total,G>0){te=_(I.width_m),A=_(I.height_m);const F=I.style==="หลุยส์"?"":` ${L(I.style||"")}`;V=`${N}${F} (${L(I.fabric_variant||"")})`,o&&(X=`<br><small>ขนาด ${te.toFixed(2)} x ${A.toFixed(2)} ม.${I.notes?` - ${L(I.notes)}`:""}</small>`),P=o?1.5:1}break;case"wallpaper":if(G=D.calculateWallpaperPrice(I).total,G>0){const F=(I.widths||[]).reduce((pe,fe)=>pe+_(fe),0),Pe=D.wallpaperRolls(F,I.height_m);A=_(I.height_m),V=`${N}`,o&&(X=`<br><small>รหัส: ${L(I.wallpaper_code)||"-"}, สูง ${A.toFixed(2)} ม. (ใช้ ${Pe} ม้วน)</small>`),P=o?1.5:1}break;default:R[I.type]?.templateId==="#areaBasedTpl"&&(G=D.calculateAreaBasedPrice(I).total,G>0&&(te=_(I.width_m),A=_(I.height_m),V=`${N}`,o&&(X=`<br><small>รหัส: ${L(I.code)||"-"}, ขนาด ${te.toFixed(2)} x ${A.toFixed(2)} ม.</small>`),P=o?1.5:1));break}G>0&&V&&E.push({description:V+X,total:G,units:P})}),E.length>0&&(n.push({isRoomHeader:!0,roomName:L($.room_name)||"ไม่ระบุชื่อห้อง",units:1.2}),n.push(...E))});const r=n.reduce(($,E)=>$+(E.total||0),0);if(r===0)return null;let l=0,i="",d=r;e.discount&&e.discount.value>0&&(e.discount.type==="percent"?(l=r*(e.discount.value/100),i=`<tr><td class="pdf-label">ส่วนลด (${e.discount.value}%)</td><td class="pdf-amount">-${oe(l,2,!0)}</td></tr>`):(l=e.discount.value,i=`<tr><td class="pdf-label">ส่วนลด</td><td class="pdf-amount">-${oe(l,2,!0)}</td></tr>`),d=r-l);const c=d*s,p=d+c,u=o?17:20,f=o?23:28,g=[];let y=[],h=0;n.forEach(($,E)=>{const I=g.length===0?u:f,V=h+$.units>I;let G=!1;if($.isRoomHeader&&E<n.length-1){const A=n[E+1].units||(o?1.5:1);h+$.units+A>I&&h+$.units<=I&&(G=!0)}let te=!1;if(!V&&!G&&E<n.length-1){const A=I-(h+$.units),P=n[E+1].units||(o?1.5:1);A>0&&A<t&&A<P&&!$.isRoomHeader&&(te=!0)}(V||G||te)&&y.length>0&&(g.push(y),y=[],h=0),y.push($),h+=$.units}),y.length>0&&g.push(y);const b=new Date,T=b.toLocaleDateString("th-TH",{year:"numeric",month:"long",day:"numeric"}),C=`QT-${b.getFullYear()}${(b.getMonth()+1).toString().padStart(2,"0")}${b.getDate().toString().padStart(2,"0")}`;let v="";try{v=new URL(W.logoUrl,document.baseURI).href}catch($){console.warn("Could not create absolute logo URL:",$),v=W.logoUrl}let S="",k=0,M=1;g.forEach(($,E)=>{const I=E===0,V=E===g.length-1,G=`
            <div class="pdf-page-header">
                <div class="pdf-header">
                    <div class="pdf-shop-info">
                        ${v?`<img src="${v}" alt="Logo" class="pdf-logo">`:""}
                        <div class="pdf-shop-address">
                            <strong><i class="ph ph-github-logo"></i> ${L(W.name)}</strong><br>
                            ${L(W.address).replace(/\n/g,"<br>")}<br>
                            โทร: ${L(W.phone)} | เลขประจำตัวผู้เสียภาษี: ${L(W.taxId)}
                        </div>
                    </div>
                    <div class="pdf-quote-details">
                        <div class="pdf-title-box"><h1>ใบเสนอราคา ${g.length>1?I?"":"(ต่อ)":""}</h1></div>
                        <table class="pdf-quote-meta">
                            <tr><td>เลขที่:</td><td>${C}</td></tr>
                            <tr><td>วันที่:</td><td>${T}</td></tr>
                        </table>
                    </div>
                </div>
                ${I?`
                <section class="pdf-customer-details">
                    <div class="pdf-customer-info">
                        <strong>ลูกค้า:</strong> ${L(e.customer_name)||"-"}<br>
                        <strong>ที่อยู่:</strong> ${L(e.customer_address||"-").replace(/\n/g,"<br>")}<br>
                        <strong>โทร:</strong> ${L(e.customer_phone)||"-"}
                    </div>
                    <div class="pdf-customer-meta">
                        <strong>เงื่อนไขชำระเงิน:</strong> ${L(W.pdf.paymentTerms)}<br>
                        <strong>ยืนราคา:</strong> ${L(W.pdf.priceValidity)}
                    </div>
                </section>`:""}
            </div>`,te=`
            <div class="pdf-page-footer">
                <div class="pdf-footer-info">
                    <span><i class="ph ph-github-logo"></i> ${L(W.name)} | โทร: ${L(W.phone)}</span>
                    <span>หน้า ${E+1} / ${g.length}</span>
                </div>
            </div>`;let A="";I||(A+=`<tr class="pdf-subtotal-row"><td colspan="4">ยอดยกมา (Brought Forward)</td><td class="pdf-text-right">${oe(k,2,!0)}</td></tr>`),$.forEach(F=>{F.isRoomHeader?A+=`<tr class="pdf-room-header"><td colspan="5">ห้อง: ${F.roomName}</td></tr>`:(A+=`<tr><td class="pdf-text-center">${M++}</td><td>${F.description}</td><td class="pdf-text-center">1</td><td class="pdf-text-right">${oe(F.total,2,!0)}</td><td class="pdf-text-right">${oe(F.total,2,!0)}</td></tr>`,k+=F.total)});let P="";V||(P=`<tfoot><tr class="pdf-subtotal-row"><td colspan="4">ยอดยกไป (Carried Forward)</td><td class="pdf-text-right">${oe(k,2,!0)}</td></tr></tfoot>`);let N="";o&&W.pdf.notes&&W.pdf.notes.length>0&&(N=`
                <strong>หมายเหตุ:</strong>
                <ul>${W.pdf.notes.map(F=>`<li>${L(F)}</li>`).join("")}</ul>
            `);const X=V?`
            <div class="pdf-summary-wrapper">
                <section class="pdf-summary-section">
                    <div class="pdf-amount-in-words">
                        ${N}
                        <div class="pdf-amount-text">( ${_t(p)} )</div>
                    </div>
                    <div class="pdf-totals-block">
                        <table>
                            <tr><td class="pdf-label">รวมเป็นเงิน</td><td class="pdf-amount">${oe(r,2,!0)}</td></tr>
                            ${i}
                            ${s>0?`<tr><td class="pdf-label">ภาษีมูลค่าเพิ่ม ${(s*100).toFixed(0)}%</td><td class="pdf-amount">${oe(c,2,!0)}</td></tr>`:""}
                            <tr class="pdf-grand-total"><td class="pdf-label">ยอดรวมสุทธิ</td><td class="pdf-amount">${oe(p,2,!0)}</td></tr>
                        </table>
                    </div>
                </section>
                <footer class="pdf-footer-section">
                    <div class="pdf-signature-box"><p>.................................................</p><p>ผู้เสนอราคา</p><p>(<i class="ph ph-github-logo"></i> ${L(W.name)})</p><p>วันที่: ${T}</p></div>
                    <div class="pdf-signature-box"><p>.................................................</p><p>ลูกค้า / ผู้มีอำนาจลงนาม</p><p>&nbsp;</p><p>วันที่: ......./......./............</p></div>
                </footer>
            </div>
        `:"";S+=`
            <div class="pdf-page">
                <div class="pdf-page-content">
                    ${G}
                    <div class="pdf-page-body">
                        <table class="pdf-items-table">
                            <thead><tr><th style="width:5%;">ลำดับ</th><th style="width:50%;">รายการ</th><th style="width:10%;">จำนวน</th><th style="width:17.5%;">ราคา/หน่วย</th><th style="width:17.5%;">รวม (บาท)</th></tr></thead>
                            <tbody>${A}</tbody>
                            ${P}
                        </table>
                        ${X}
                    </div>
                    ${te}
                </div>
            </div>`});const q=e.customer_name||"quote",x=ot(q);return{html:`<div id="quotation-template">${S}</div>`,fileName:`${C}_${x}`}}function Bt(e){const a=at(e);let s=0;e.discount?.value>0&&(s=e.discount.type==="percent"?a*(e.discount.value/100):e.discount.value);const t=a-s;let o=!1,n=e.rooms.map(l=>{if(l.is_suspended)return"";const i=l.items.filter(c=>c.is_suspended?!1:c.type==="set"||R[c.type]?.templateId==="#areaBasedTpl"?_(c.width_m)>0&&_(c.height_m)>0:c.type==="wallpaper"?(c.widths||[]).reduce((u,f)=>u+_(f),0)>0&&_(c.height_m)>0:!1);if(i.length===0)return"";const d=i.map((c,p)=>{let u="",f="",g="",y="";switch(c.type==="set"?c.style==="หลุยส์"?(y=Q.set_louis||"ม่านหลุยส์",f=`<h5 class="lookbook-item-title">${L(y)}</h5>`):y=Q.set||"ผ้าม่าน":(y=Q[c.type]||"ของตกแต่ง",f=`<h5 class="lookbook-item-title">${L(y)}</h5>`),c.type){case"set":g=`<tr><td>ขนาด</td><td>${_(c.width_m).toFixed(2)} x ${_(c.height_m).toFixed(2)} ม.</td></tr>`,c.style==="หลุยส์"?u=`
                            <tr><td>แบบ</td><td>${y} (${L(c.fabric_variant||"")})</td></tr>
                            ${c.fabric_variant.includes("ทึบ")?`<tr><td>ผ้าฐาน</td><td>#${L(c.fabric_code)||"-"}</td></tr>`:""}
                            ${c.fabric_variant.includes("โปร่ง")?`<tr><td>ผ้าโปร่ง</td><td>#${L(c.sheer_fabric_code)||"-"}</td></tr>`:""}
                            <tr><td>หัวหลุยส์</td><td>${L(c.louis_valance||"กล่องหลุยส์")}</td></tr>
                            <tr><td>พู่</td><td>${L(c.louis_tassels||"สีเข้ากับผ้า")}</td></tr>
                         `:(u=`
                            <tr><td>แบบ</td><td>${L(c.style||"")} (${L(c.fabric_variant||"")})</td></tr>
                            ${c.fabric_variant.includes("ทึบ")?`<tr><td>ทึบ</td><td>#${L(c.fabric_code)||"-"}</td></tr>`:""}
                            ${c.fabric_variant.includes("โปร่ง")?`<tr><td>โปร่ง</td><td>#${L(c.sheer_fabric_code)||"-"}</td></tr>`:""}
                        `,c.style==="ม่านพับ"?u+=`<tr><td>เชือก</td><td>${L(c.adjustment_side||"ปรับขวา")}</td></tr>`:u+=`<tr><td>เปิด</td><td>${L(c.opening_style||"แยกกลาง")}</td></tr>`);break;case"wallpaper":const h=(c.widths||[]).reduce((T,C)=>T+_(C),0),b=D.wallpaperRolls(h,c.height_m);g=`<tr><td>ขนาด</td><td>รวม ${h.toFixed(2)} ม., สูง ${_(c.height_m).toFixed(2)} ม.</td></tr>`,u=`
                        <tr><td>รหัส</td><td>#${L(c.wallpaper_code)||"-"}</td></tr>
                        <tr><td>ใช้</td><td>${b} ม้วน</td></tr>
                    `;break;default:R[c.type]?.templateId==="#areaBasedTpl"&&(g=`<tr><td>ขนาด</td><td>${_(c.width_m).toFixed(2)} x ${_(c.height_m).toFixed(2)} ม.</td></tr>`,u=`<tr><td>รหัส</td><td>#${L(c.code)||"-"}</td></tr>`,c.opening_style&&(u+=`<tr><td>เปิด</td><td>${L(c.opening_style)}</td></tr>`),c.adjustment_side&&(u+=`<tr><td>เชือก</td><td>${L(c.adjustment_side)}</td></tr>`));break}return u&&(o=!0),`
                 <div class="lookbook-details">
                    ${Tt(c,l.id,p)}
                    <div class="spec-table-wrapper">
                        ${f}
                        <table class="spec-table">
                            ${u}
                            ${g}
                            ${c.notes?`<tr><td>โน้ต</td><td>${L(c.notes)}</td></tr>`:""}
                        </table>
                    </div>
                </div>
            `}).join('<hr class="lookbook-hr">');return d.trim()?`
            <div class="lookbook-room">
                <h4><i class="ph ph-map-pin"></i> ${L(l.room_name)||"ไม่ระบุชื่อห้อง"}</h4>
                ${d}
            </div>
        `:""}).join("");return o?`
        <div class="lookbook-summary">
            <div class="lookbook-customer-info">
                <strong>ลูกค้า:</strong> ${L(e.customer_name)||"-"}<br/>
                <strong>ที่อยู่:</strong> ${L(e.customer_address||"-").replace(/\n/g,"<br/>")}
            </div>
            <div class="lookbook-totals">
                <span>ยอดรวม (ก่อนส่วนลด): ${B(a)} บาท</span>
                ${s>0?`<span>ส่วนลด: -${B(s)} บาท</span>`:""}
                <span class="grand-total">ยอดสุทธิ: ${B(t)} บาท</span>
            </div>
        </div>
    `+n:'<p class="empty-summary">ไม่มีรายการสำหรับสร้างรายงาน</p>'}function nt(e={}){const a=document.querySelector(m.roomTpl);if(!a)return console.error("Room template not found"),null;const t=a.content.cloneNode(!0).firstElementChild;t.id=e.id||`room-${Date.now()}`,t.open=e.is_open!==!1,t.dataset.roomDefaults=JSON.stringify(e.room_defaults||{});const o=t.querySelector(m.roomNameInput),n=t.querySelector("[data-room-name-display]"),r=t.querySelector("[data-room-brief]"),l=t.querySelector(m.allItemsContainer),i=()=>{const p=o.value||"ห้อง (ไม่มีชื่อ)";n&&(n.textContent=p)};o&&o.addEventListener("input",i);const d=t.querySelector("summary");d&&d.addEventListener("click",()=>{});const c=e.room_name||`ห้อง ${document.querySelectorAll(m.room).length+1}`;if(o){o.value=c;const p=`room_name_${t.id}`;o.id=p;const u=o.closest(".form-group")?.querySelector("label");u&&u.setAttribute("for",p)}return n&&(n.textContent=c),e.is_suspended&&t.classList.add("is-suspended"),t.getItemsContainer=()=>l,t.updateBrief=p=>{r&&(r.innerHTML=p)},t}function Ce(e={}){const a=document.querySelector(m.setTpl);if(!a)return console.error("Set template not found"),null;const t=a.content.cloneNode(!0).firstElementChild;t.dataset.type="set";const o=t.querySelector('input[name="width_m"]'),n=t.querySelector('input[name="height_m"]'),r=t.querySelector('select[name="set_style"]'),l=t.querySelector('select[name="fabric_variant"]'),i=t.querySelector('select[name="set_price_per_m"]'),d=t.querySelector('select[name="sheer_price_per_m"]'),c=t.querySelector('select[name="louis_price_per_m"]'),p=t.querySelector('input[name="fabric_code"]'),u=t.querySelector('input[name="sheer_fabric_code"]'),f=t.querySelector('select[name="opening_style"]'),g=t.querySelector('select[name="adjustment_side"]'),y=t.querySelector('input[name="notes"]'),h=t.querySelector('[data-set-control="opening_style_wrap"]'),b=t.querySelector('[data-set-control="adjustment_side_wrap"]'),T=t.querySelector('[data-set-control="louis_price_wrap"]'),C=t.querySelector('[data-set-control="fabric_price_wrap"]'),v=t.querySelector('[data-set-control="fabric_code_wrap"]'),S=t.querySelector("[data-sheer-wrap]"),k=t.querySelector("[data-sheer-code-wrap]"),M=t.querySelector("[data-set-summary]"),q=t.querySelector(".item-details-more"),x=t.querySelector('[data-act="toggle-more-details"]')?.parentElement,$=()=>({width_m:o.value,height_m:n.value,style:r.value,fabric_variant:l.value,price_per_m_raw:i.value,sheer_price_per_m:d.value,louis_price_per_m:c.value,is_suspended:t.classList.contains("is-suspended")}),E=()=>{const A=$(),P=D.calculateSetPrice(A);t.dataset.totalPrice=P.total;let N=`ราคา: <b>${B(P.total)}</b> บ.`;if(A.style==="หลุยส์"){const F=[];P.opaque>0&&F.push(`ทึบ: ${B(P.opaque)}`),P.sheer>0&&F.push(`โปร่ง: ${B(P.sheer)}`),P.louis>0&&F.push(`หลุยส์: ${B(P.louis)}`),F.length>0&&(N+=` <small>(${F.join(", ")})</small>`)}else P.opaque>0&&P.sheer>0&&(N+=` <small>(ทึบ: ${B(P.opaque)}, โปร่ง: ${B(P.sheer)})</small>`);const X=D.fabricYardage(A.style,A.width_m);X>0&&(N+=` &bull; ใช้ผ้า: ${X.toFixed(2)} หลา`),M?M.innerHTML=N:console.warn("Summary element not found for set item.")},I=qe(()=>{E(),t.dispatchEvent(new CustomEvent("item-update",{bubbles:!0}))},200),V=()=>{const A=r.value,P=l.value,N=A==="หลุยส์",X=P.includes("โปร่ง"),F=P==="โปร่ง"&&!N,Pe=P==="ทึบ"&&!N;S?.classList.toggle("hidden",!X||N),k?.classList.toggle("hidden",!X||N);const pe=F||N;i&&(i.disabled=pe,pe&&(i.value="")),p&&(p.disabled=pe,pe&&(p.value=""));const fe=Pe||N;d&&(d.disabled=fe,fe&&(d.value="")),u&&(u.disabled=fe,fe&&(u.value=""))},G=()=>{const A=r.value,P=A==="ม่านพับ",N=A==="หลุยส์",X=P||N||A==="ม่านแป๊บ";h&&h.classList.toggle("hidden",X),b&&b.classList.toggle("hidden",!P),T&&T.classList.toggle("hidden",!N),C&&C.classList.toggle("hidden",N),v&&v.classList.toggle("hidden",N),V()};t.addEventListener("input",A=>{A.target===l&&V(),A.target===r&&G(),I()});const te=A=>{We(A),I()};if(o.addEventListener("blur",te),n.addEventListener("blur",te),q&&x){const A=t.querySelector(".item-grid");A&&A.appendChild(x)}return o.value=K(e.width_m),n.value=K(e.height_m),r.value=e.style||"ลอน",l.value=e.fabric_variant||"ทึบ",i.value=e.price_per_m_raw||"",d.value=e.sheer_price_per_m||"",c.value=e.louis_price_per_m||"",p.value=e.fabric_code||"",u.value=e.sheer_fabric_code||"",f.value=e.opening_style||"แยกกลาง",g.value=e.adjustment_side||"ปรับขวา",y.value=e.notes||"",t.querySelector('input[name="track_color"]').value=e.track_color||"ขาว",t.querySelector('input[name="bracket_color"]').value=e.bracket_color||"ขาว",t.querySelector('input[name="finial_color"]').value=e.finial_color||"ขาว",t.querySelector('input[name="grommet_color"]').value=e.grommet_color||"เงิน",t.querySelector('input[name="louis_valance"]').value=e.louis_valance||"กล่องหลุยส์",t.querySelector('input[name="louis_tassels"]').value=e.louis_tassels||"สีเข้ากับผ้า",e.is_suspended&&t.classList.add("is-suspended"),G(),E(),t}function He(e={}){const a=document.querySelector(m.wallTpl);if(!a)return null;const t=a.content.cloneNode(!0).firstElementChild,o=t.querySelector('input[name="wall_width_m"]');o.value=K(e.width);const n=`wall_width_${Date.now()}_${Math.random().toString(36).substring(2,7)}`;o.id=n;const r=t.querySelector("label");return r&&r.setAttribute("for",n),t}function Be(e={}){const a=document.querySelector(m.wallpaperTpl);if(!a)return console.error("Wallpaper template not found"),null;const t=a.content.cloneNode(!0).firstElementChild;t.dataset.type="wallpaper";const o=t.querySelector('[name="wallpaper_height_m"]'),n=t.querySelector('[name="wallpaper_price_roll"]'),r=t.querySelector('[name="wallpaper_install_cost"]'),l=t.querySelector('[name="wallpaper_code"]'),i=t.querySelector('[name="wallpaper_notes"]'),d=t.querySelector("[data-walls-container]"),c=t.querySelector("[data-wallpaper-summary]"),p=t.querySelector(".item-details-more"),u=t.querySelector('[data-act="toggle-more-details"]')?.parentElement,f=()=>({height_m:o.value,price_per_roll:n.value,install_cost_per_roll:r.value,widths:Array.from(d.querySelectorAll('input[name="wall_width_m"]')).map(b=>b.value),is_suspended:t.classList.contains("is-suspended")}),g=()=>{const b=f(),T=D.calculateWallpaperPrice(b);t.dataset.totalPrice=T.total;let C=`รวม: <b>${B(T.total)}</b> บ. `;(T.material>0||T.install>0)&&(C+=`<small>(วอลล์: ${B(T.material)}, ค่าช่าง: ${B(T.install)})</small>`),T.rolls>0&&(C+=` &bull; พื้นที่: ${oe(T.sqm,2)} ตร.ม. &bull; ใช้: ${T.rolls} ม้วน`),c&&(c.innerHTML=C)},y=qe(()=>{g(),t.dispatchEvent(new CustomEvent("item-update",{bubbles:!0}))},200);t.addEventListener("input",y);const h=b=>{We(b),y()};if(o.addEventListener("blur",h),t.addEventListener("blur",b=>{b.target.name==="wall_width_m"&&h(b)},!0),p&&u){const b=t.querySelector(".item-grid");b&&b.appendChild(u)}if(e.widths&&e.widths.length>0)e.widths.forEach(b=>{const T=He({width:b});T&&d.appendChild(T)});else{const b=He();b&&d.appendChild(b)}return o.value=K(e.height_m),n.value=e.price_per_roll>0?B(e.price_per_roll):"",e.hasOwnProperty("install_cost_per_roll")?r.value=e.install_cost_per_roll===0?"0":e.install_cost_per_roll>0?B(e.install_cost_per_roll):"":r.value=r.value,l.value=e.wallpaper_code||"",i.value=e.notes||"",e.is_suspended&&t.classList.add("is-suspended"),g(),t}function Ee(e,a={}){const s=document.querySelector(m.areaBasedTpl);if(!s)return console.error("AreaBased template not found"),null;const o=s.content.cloneNode(!0).firstElementChild;o.dataset.type=e;const n=R[e]||{name:"ของตกแต่ง"};o.classList.add(`${e.replace(/_/g,"-")}-item`);const r=o.querySelector(".item-type-display"),l=o.querySelector('[name="area_width_m"]'),i=o.querySelector('[name="area_height_m"]'),d=o.querySelector('[name="area_price_sqyd"]'),c=o.querySelector('[name="area_code"]'),p=o.querySelector('[name="area_notes"]'),u=o.querySelector(".btn-favorite"),f=o.querySelector(".btn-show-favs"),g=o.querySelector("[data-area-summary]"),y=o.querySelector(".item-details-more"),h=o.querySelector('[data-act="toggle-more-details"]')?.parentElement,b=y?.querySelector(".item-grid"),T=b?.querySelector('[name="area_price_sqyd"]')?.closest(".form-group");let C,v;if(b&&T){if(e==="partition"||e==="pleated_screen"){const x=document.createElement("div");x.className="form-group",x.innerHTML=`
                <label>รูปแบบเปิด
                    <select name="opening_style">
                        <option value="แยกกลาง">แยกกลาง</option>
                        <option value="เก็บข้างเดียว">เก็บข้างเดียว</option>
                    </select>
                </label>
            `,b.insertBefore(x,T),C=x.querySelector("select")}else if(["wooden_blind","roller_blind","vertical_blind","aluminum_blind"].includes(e)){const x=document.createElement("div");x.className="form-group",x.innerHTML=`
                <label>เชือกปรับ
                    <select name="adjustment_side">
                        <option value="ปรับขวา">ปรับขวา</option>
                        <option value="ปรับซ้าย">ปรับซ้าย</option>
                    </select>
                </label>
            `,b.insertBefore(x,T),v=x.querySelector("select")}(C||v)&&T&&T.classList.remove("full-width-item")}const S=()=>({width_m:l.value,height_m:i.value,price_sqyd:d.value,is_suspended:o.classList.contains("is-suspended")}),k=()=>{const x=S(),$=D.calculateAreaBasedPrice(x);o.dataset.totalPrice=$.total;const E=$.sqyd>0?` &bull; พื้นที่: ${oe($.sqyd,2)} ตร.หลา`:"";g&&(g.innerHTML=`ราคา: <b>${B($.total)}</b> บ.${E}`)},M=qe(()=>{k(),o.dispatchEvent(new CustomEvent("item-update",{bubbles:!0}))},200);o.addEventListener("input",M);const q=x=>{We(x),M()};if(l.addEventListener("blur",q),i.addEventListener("blur",q),y&&h){const x=o.querySelector(".item-grid");x&&x.appendChild(h)}return r&&(r.textContent=n.name),c&&(c.dataset.favoriteType=e),u&&(u.dataset.type=e),f&&(f.dataset.type=e),l.value=K(a.width_m),i.value=K(a.height_m),d.value=a.price_sqyd>0?B(a.price_sqyd):"",c.value=a.code||"",p.value=a.notes||"",C&&(C.value=a.opening_style||"แยกกลาง"),v&&(v.value=a.adjustment_side||"ปรับขวา"),a.is_suspended&&o.classList.add("is-suspended"),k(),o}const j=[];let Z=!1,ke=null,O=null,ye=null,we=!1,U=null,De=!1,ie=null,ue=null,le=[];const ze=document.querySelector("#undoBtn"),je="marnthara.theme",xe={};function Et(e){if(xe[e])return xe[e];const a=new Promise((s,t)=>{const o=document.createElement("script");o.src=e,o.onload=()=>s(),o.onerror=()=>{console.error(`Script load error for ${e}`),delete xe[e],t(new Error(`Script load error for ${e}`))},document.head.appendChild(o)});return xe[e]=a,a}function st(){const e=localStorage.getItem(je),a=document.querySelector("#themeToggleBtn");if(!a)return;const s=a.querySelector("i"),t=a.querySelector("span");switch(document.body.classList.remove("dark-theme","neutral-theme"),e){case"dark":document.body.classList.add("dark-theme"),s&&(s.className="ph-fill ph-sun"),t&&(t.textContent=" สว่าง");break;case"neutral":document.body.classList.add("neutral-theme"),s&&(s.className="ph-fill ph-moon"),t&&(t.textContent=" มืด");break;default:s&&(s.className="ph-fill ph-palette"),t&&(t.textContent=" กลาง");break}}function At(){const e=localStorage.getItem(je);let a="neutral";!e||e==="light"?a="neutral":e==="neutral"?a="dark":a="light",localStorage.setItem(je,a),st()}function ee(){ze&&(ze.disabled=!St())}function Pt(){const e=bt();e&&(Ge(e,!1),w("ยกเลิกการกระทำล่าสุดแล้ว","success")),ee()}function _e(){const e=document.getElementById("suspendedItemsBtn");if(!e)return;if(ye){e.classList.remove("is-visible");return}const a=document.getElementById("suspendedCountBadge"),s=document.querySelectorAll(".item-card.is-suspended:not(.placeholder-item)").length,t=document.querySelectorAll(".room-card.is-suspended");let o=0;t.forEach(r=>{o+=r.querySelectorAll(".item-card:not(.is-suspended):not(.placeholder-item)").length});const n=s+o;a&&(a.textContent=n),e.classList.toggle("is-visible",n>0)}function Ne(){ye="suspended";const e=document.getElementById("filterStatusBar");let a=0;if(document.querySelectorAll(".room-card").forEach(t=>{let o=!1;const n=t.classList.contains("is-suspended");t.querySelectorAll(".item-card").forEach(l=>{const d=l.classList.contains("is-suspended")||n;l.classList.toggle("item-hidden",!d),d&&(o=!0,l.classList.contains("placeholder-item")||a++)});const r=n||o;t.classList.toggle("item-hidden",!r)}),document.querySelectorAll(".item-card.is-suspended:not(.placeholder-item)").length+Array.from(document.querySelectorAll(".room-card.is-suspended .item-card:not(.is-suspended):not(.placeholder-item)")).length===0){lt(),w("ไม่มีรายการที่ถูกระงับแล้ว","success");return}e&&(e.innerHTML=`
            <span><i class="ph ph-warning"></i> รายการที่ถูกระงับ (${a} รายการ)</span>
            <button type="button" class="btn-chip" data-act="clear-filter" title="ยกเลิกการกรอง">
                <i class="ph ph-x"></i>&nbsp;ปิด
            </button>
        `,e.classList.add("is-visible"),e.dataset.filterType="suspended"),ae(),ne(),_e()}function Dt(e,a){if(!e)return;ye=e;const s=document.getElementById("filterStatusBar");let t=0;document.querySelectorAll(m.room).forEach(o=>{let n=0;o.querySelectorAll(".item-card").forEach(r=>{const l=r.dataset.type===e&&!r.classList.contains("placeholder-item");r.classList.toggle("item-hidden",!l),l&&n++}),o.querySelectorAll(".placeholder-item").forEach(r=>r.classList.toggle("item-hidden",n===0)),o.classList.toggle("item-hidden",n===0),n>0&&(t+=n)}),s&&(s.innerHTML=`
            <span>เฉพาะ: <strong>${L(a)}</strong> (${t} รายการ)</span>
            <button type="button" class="btn-chip" data-act="clear-filter" title="ยกเลิกการกรอง">
                <i class="ph ph-x"></i>&nbsp;ปิด
            </button>
        `,s.classList.add("is-visible"),s.dataset.filterType=e),ae(),ne(),_e()}function lt(){ye=null;const e=document.getElementById("filterStatusBar");e&&(e.classList.remove("is-visible"),e.innerHTML="",e.removeAttribute("data-filter-type")),document.querySelectorAll(".item-hidden").forEach(a=>a.classList.remove("item-hidden")),ae(),ne(),_e()}function w(e,a="default"){const s=document.querySelector(m.toastContainer);if(!s)return;const t={success:"ph-bold ph-check-circle",warning:"ph-bold ph-warning",error:"ph-bold ph-x-circle",default:"ph-bold ph-info"},o=document.createElement("div");o.className=`toast toast-${a}`,o.innerHTML=`<i class="${t[a]||t.default}"></i> ${L(e)}`,s.appendChild(o),setTimeout(()=>o.classList.add("show"),10),setTimeout(()=>{o.classList.remove("show"),o.addEventListener("transitionend",()=>o.remove())},3e3)}function H(e,a){return new Promise(s=>{const t=document.querySelector(e);if(!t){console.error("Modal not found:",e),s(null);return}if(j.length>0){const u=j[j.length-1];u&&u.classList.contains("visible")&&u.classList.add("is-underlay")}j.push(t),t.classList.add("visible");const o=t.querySelector('[id$="Confirm"]'),n=t.querySelector('[id$="Cancel"], [data-act="close-modal"], #roomDefaultsCancelBtn, #manageFavsTypeCancel, #forceApplyCancel, #forceApplyTypeCancel, #dimensionEntryCancel'),r=Array.from(t.querySelectorAll('button, [href], input:not([type="hidden"]), select, textarea, [tabindex]:not([tabindex="-1"])')).filter(u=>!u.disabled&&u.offsetParent!==null),l=r[0],i=r[r.length-1];setTimeout(()=>l?.focus(),50);const d=u=>{t.classList.remove("visible"),document.removeEventListener("keydown",c),t.removeEventListener("click",p),o&&(o.onclick=null),n&&(n.onclick=null),t.closeModal===d&&(t.closeModal=null);const f=j.pop();f!==t&&(console.error(`[cleanup] Modal stack mismatch! Expected #${t.id}, but popped #${f?.id}. Resetting stack.`),j.length=0);const g=j.length>0?j[j.length-1]:null;g&&g.classList.contains("visible")&&g.classList.remove("is-underlay"),e==="#roomDefaultsModal"&&(le.forEach(({element:y,event:h,handler:b})=>{y.removeEventListener(h,b)}),le=[],ue=null),e==="#favoritesModal"&&(ie=null),u?.cancelled&&typeof a=="function"&&a(),s(u)};t.closeModal=d;const c=u=>{const f=j.length>0&&j[j.length-1]===t;u.key==="Escape"&&f&&d({cancelled:!0}),u.key==="Tab"&&r.length>1&&(u.shiftKey?document.activeElement===l&&(i.focus(),u.preventDefault()):document.activeElement===i&&(l.focus(),u.preventDefault()))},p=u=>{const f=j.length>0&&j[j.length-1]===t;u.target===t&&f&&(u.stopPropagation(),d({cancelled:!0}))};o&&(o.onclick=()=>d(!0)),n&&(n.onclick=()=>{j.length>0&&j[j.length-1]===t&&d({cancelled:!0})}),document.addEventListener("keydown",c),t.addEventListener("click",p)})}async function re(e,a){const s=document.querySelector(m.modal);return s?(s.querySelector(m.modalTitle).textContent=e,s.querySelector(m.modalBody).textContent=a,await H(m.modal)===!0):!0}async function Nt(){const e=document.querySelector(m.exportOptionsModal);if(!e)return null;const a=e.querySelector("#pageBreakBuffer"),s=e.querySelector("#pageBreakBufferValue");a&&s&&(s.textContent=a.value,a.oninput=()=>{s.textContent=a.value});const t=await H(m.exportOptionsModal);return a&&(a.oninput=null),!t||t.cancelled?null:{vatOption:e.querySelector('input[name="vat_option"]:checked')?.value||"include",showDetails:(e.querySelector('input[name="item_details_option"]:checked')?.value||"show_details")==="show_details",exportMethod:e.querySelector("#exportMethod")?.value||"direct",pageBreakBuffer:parseInt(a?.value,10)||3}}async function Rt(){const e=document.querySelector("#discountModal");if(!e)return Promise.resolve({cancelled:!0});const a=e.querySelector("#discountSubtotal"),s=e.querySelector("#discountPercent"),t=e.querySelector("#discountAmount"),o=e.querySelector("#discountFinalTotal"),n=document.querySelector("#discount_type"),r=document.querySelector("#discount_value"),l=_(document.querySelector("#originalTotal").dataset.rawTotal||document.querySelector("#grandTotal").textContent);a&&(a.textContent=B(l));const i=h=>{if(De)return;De=!0;let b=0;if(h==="percent"){const T=_(s.value);b=l*(Math.max(0,T)/100),t.value=b>0?B(Math.round(b)):""}else b=_(t.value);if(b=Math.max(0,Math.min(b,l)),h!=="percent"){const T=l>0?b/l*100:0;s.value=T>0&&isFinite(T)?oe(T,2):""}o&&(o.textContent=B(l-b)),setTimeout(()=>{De=!1},50)},d=()=>i("percent"),c=()=>i("amount"),p=h=>{_(h.target.value)>0&&(h.target.value=_(h.target.value))},u=h=>{const b=_(h.target.value);h.target.value=b>0?B(b):"",i("amount")};s.addEventListener("input",d),t.addEventListener("input",c),t.addEventListener("focus",p),t.addEventListener("blur",u);const f=n.value,g=_(r.value);s.value="",t.value="",g>0?f==="percent"?(s.value=g,i("percent")):(t.value=g,t.value=B(g),i("amount")):i();const y=await H("#discountModal");if(s.removeEventListener("input",d),t.removeEventListener("input",c),t.removeEventListener("focus",p),t.removeEventListener("blur",u),y&&!y.cancelled){const h=_(s.value),b=_(t.value),T=document.activeElement;h>0&&T===s?(n.value="percent",r.value=h):b>0?(n.value="amount",r.value=b):h>0?(n.value="percent",r.value=h):(n.value="amount",r.value=0),Y()}}async function Ft(){if(!O)return;const e=document.querySelector("#hardwareModal");if(!e)return;const a=O.querySelector('[name="set_style"]'),s=a?a.value:null,t=s==="ตาไก่",o=s==="ม่านพับ",n=s==="หลุยส์",r=e.querySelector("#trackColorGroup"),l=e.querySelector("#bracketColorGroup"),i=e.querySelector("#finialColorGroup"),d=e.querySelector("#grommetColorGroup"),c=e.querySelector("#louisValanceGroup"),p=e.querySelector("#louisTasselGroup"),u=e.querySelector("#hardwareApplyToRoom");e.querySelector('[name="modal_track_color"]').value=O.querySelector('[name="track_color"]')?.value||"ขาว",e.querySelector('[name="modal_bracket_color"]').value=O.querySelector('[name="bracket_color"]')?.value||"ขาว",e.querySelector('[name="modal_finial_color"]').value=O.querySelector('[name="finial_color"]')?.value||"ขาว",e.querySelector('[name="modal_grommet_color"]').value=O.querySelector('[name="grommet_color"]')?.value||"เงิน",e.querySelector('[name="modal_louis_valance"]').value=O.querySelector('[name="louis_valance"]')?.value||"กล่องหลุยส์",e.querySelector('[name="modal_louis_tassels"]').value=O.querySelector('[name="louis_tassels"]')?.value||"สีเข้ากับผ้า",r&&(r.style.display=""),l&&(l.style.display=""),i&&(i.style.display=t?"":"none"),d&&(d.style.display=t?"":"none"),c&&(c.style.display=n?"":"none"),p&&(p.style.display=n?"":"none"),u&&(u.disabled=o||n);const f=await H("#hardwareModal");f&&!f.cancelled&&(O.querySelector('[name="track_color"]').value=e.querySelector('[name="modal_track_color"]').value,O.querySelector('[name="bracket_color"]').value=e.querySelector('[name="modal_bracket_color"]').value,t?(O.querySelector('[name="finial_color"]').value=e.querySelector('[name="modal_finial_color"]').value,O.querySelector('[name="grommet_color"]').value=e.querySelector('[name="modal_grommet_color"]').value):n&&(O.querySelector('[name="louis_valance"]').value=e.querySelector('[name="modal_louis_valance"]').value,O.querySelector('[name="louis_tassels"]').value=e.querySelector('[name="modal_louis_tassels"]').value),z(),w("บันทึกการตั้งค่าอุปกรณ์แล้ว","success")),O=null}async function Ot(e){if(!e)return;ue=e;const a=document.querySelector(m.roomDefaultsModal),s=document.querySelector(m.roomDefaultsForm);if(!a||!s)return;le.forEach(({element:i,event:d,handler:c})=>{i.removeEventListener(d,c)}),le=[];const t=JSON.parse(ue.dataset.roomDefaults||"{}"),o=a.querySelectorAll(".defaults-tab"),n=a.querySelectorAll(".defaults-content"),r=i=>{const d=i.currentTarget,c=d.dataset.target;if(!c)return;o.forEach(u=>u.classList.remove("is-active")),n.forEach(u=>u.classList.remove("is-active")),d.classList.add("is-active");const p=a.querySelector(`.defaults-content[data-type="${c}"]`);p&&p.classList.add("is-active")};o.forEach(i=>{i.addEventListener("click",r),le.push({element:i,event:"click",handler:r})}),o[0]&&o[0].classList.add("is-active"),n[0]&&n[0].classList.add("is-active");const l=i=>{const d=i.target,c=d.closest(".defaults-content");if(!c)return;const p=d.checked,u=c.querySelector(".defaults-inputs-grid");c.classList.toggle("is-enabled-content",p),u&&u.querySelectorAll('input[type="text"], input[type="number"], select, .btn-show-favs').forEach(f=>{f.disabled=!p,f.matches(".btn-show-favs")&&(f.style.opacity=p?"1":"0.5",f.style.pointerEvents=p?"auto":"none")})};n.forEach(i=>{const d=i.querySelector('.defaults-enable-toggle input[type="checkbox"]');if(!d)return;const c=d.name,p=t[c]===!0||t[c]==="1";d.checked=p,l({target:d}),d.addEventListener("change",l),le.push({element:d,event:"change",handler:l});const u=i.querySelector(".defaults-inputs-grid");u&&u.querySelectorAll('input[type="text"], input[type="number"]').forEach(f=>{const g=f.name,y=t[g];f.type==="text"&&f.inputMode==="numeric"?(f.value=y===0?"0":y!=null&&y>0?B(y):"",f.addEventListener("focus",Ze),f.addEventListener("blur",et),le.push({element:f,event:"focus",handler:Ze}),le.push({element:f,event:"blur",handler:et})):f.value=y||""})}),await H(m.roomDefaultsModal)}async function Ht(){const e=document.querySelector("#forceApplyModal");if(!e)return;const a=e.querySelector('[name="force_apply_type_hidden"]'),s=e.querySelector("#forceApplySelectedTypeDisplay"),t=e.querySelector('[name="force_apply_code"]'),o=e.querySelector('[name="force_apply_price"]'),n=t?.closest(".form-group-with-favorites")?.querySelector(".btn-show-favs");a&&(a.value=""),s&&(s.textContent="-- เลือกประเภท --"),t&&(t.value="",t.dataset.favoriteType=""),o&&(o.value=""),n&&(n.disabled=!0),await H("#forceApplyModal")}function Ze(e){e.target.value!=="0"&&_(e.target.value)>0&&(e.target.value=_(e.target.value))}function et(e){const a=_(e.target.value);e.target.value=a===0?"0":a!=null&&a>0?B(a):""}function jt(){if(!ue)return;const e=document.querySelector(m.roomDefaultsForm);if(!e)return;const a={};e.querySelectorAll(".defaults-content").forEach(t=>{const o=t.querySelector('.defaults-enable-toggle input[type="checkbox"]');if(o){const n=o.name,r=o.checked;if(a[n]=r,r){const l=t.querySelector(".defaults-inputs-grid");l&&l.querySelectorAll('input[type="text"], input[type="number"]').forEach(i=>{const d=i.name,c=i.value.trim();let p;i.type==="text"&&i.inputMode==="numeric"?c===""?p=void 0:p=_(c):p=c,(typeof p=="number"&&!isNaN(p)||typeof p=="string"&&p!=="")&&(a[d]=p)})}}}),ue.dataset.roomDefaults=JSON.stringify(a),z();const s=document.querySelector(m.roomDefaultsModal);s&&typeof s.closeModal=="function"?(s.closeModal(!0),setTimeout(()=>w("บันทึกค่าเริ่มต้นห้องแล้ว","success"),50)):console.error("Could not find room defaults modal or its closer function.")}async function Wt(){if(!ue)return;const e=document.querySelector(m.roomDefaultsModal),a=document.querySelector(m.roomDefaultsForm);if(!e||!a)return;const s={};if(a.querySelectorAll(".defaults-content").forEach(n=>{const r=n.querySelector('.defaults-enable-toggle input[type="checkbox"]');if(r&&r.checked){const l=n.querySelector(".defaults-inputs-grid");l&&l.querySelectorAll('input[type="text"], input[type="number"]').forEach(i=>{const d=i.name,c=i.type==="text"&&i.inputMode==="numeric"?_(i.value):i.value.trim();(typeof c=="number"&&!isNaN(c)||typeof c=="string"&&c!=="")&&(s[d]=c)})}}),Object.keys(s).length===0){w("ยังไม่มีการเลือกค่าเริ่มต้นที่จะใช้","warning");return}if(!await re("ใช้ค่าเริ่มต้น","ใช้ค่าเริ่มต้นที่ *เลือกไว้* กับรายการที่ยังไม่มีข้อมูลในห้องนี้?"))return;se(J()),ee();let t=0;ue.getItemsContainer().querySelectorAll(".item-card").forEach(n=>{const r=n.dataset.type;let l=!1;const i=(d,c)=>{const p=s[c],u=n.querySelector(d);if(!u||p==null)return;const f=u.tagName==="SELECT",g=f?u.value:u.value.trim(),y=f?null:_(g);let h=!1;if(f?h=!g:u.matches('input[type="text"][inputmode="numeric"]')?h=!g||y===0:h=!g,h){let b=!1;f?Array.from(u.options).some(T=>T.value==p)&&(u.value=p,b=!0):u.matches('input[type="text"][inputmode="numeric"]')?typeof p=="number"&&!isNaN(p)&&(u.value=p===0?"0":B(p),b=!0):u.matches('input[type="text"]:not([inputmode])')&&(u.value=p,b=!0),b&&(l=!0,u.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0})),u.matches('input[type="text"][inputmode="numeric"]')&&u.dispatchEvent(new Event("blur",{bubbles:!0,cancelable:!0})))}};switch(r){case"set":i(m.setFabricCodeInput,"defaults_fabric_code"),i(m.setPricePerMSelect,"defaults_fabric_price"),i(m.setSheerCodeInput,"defaults_sheer_code"),i(m.setSheerPricePerMSelect,"defaults_sheer_price");break;case"wallpaper":i(m.wallCodeInput,"defaults_wallpaper_code"),i(m.wallPriceRollInput,"defaults_wallpaper_price_roll"),i(m.wallInstallCostInput,"defaults_wallpaper_install_cost");break;case"wooden_blind":i(m.areaCodeInput,"defaults_wooden_blind_code"),i(m.areaPriceSqydInput,"defaults_wooden_blind_price_sqyd");break;case"roller_blind":i(m.areaCodeInput,"defaults_roller_blind_code"),i(m.areaPriceSqydInput,"defaults_roller_blind_price_sqyd");break;case"vertical_blind":i(m.areaCodeInput,"defaults_vertical_blind_code"),i(m.areaPriceSqydInput,"defaults_vertical_blind_price_sqyd");break;case"partition":i(m.areaCodeInput,"defaults_partition_code"),i(m.areaPriceSqydInput,"defaults_partition_price_sqyd");break;case"pleated_screen":i(m.areaCodeInput,"defaults_pleated_screen_code"),i(m.areaPriceSqydInput,"defaults_pleated_screen_price_sqyd");break;case"aluminum_blind":i(m.areaCodeInput,"defaults_aluminum_blind_code"),i(m.areaPriceSqydInput,"defaults_aluminum_blind_price_sqyd");break}l&&t++}),e&&typeof e.closeModal=="function"?e.closeModal({cancelled:!0}):console.error("Could not find room defaults modal or its closer function."),setTimeout(()=>{t>0?(Y(),w(`ใช้ค่าเริ่มต้นกับ ${t} รายการแล้ว`,"success")):w("ไม่มีรายการใดที่ต้องอัปเดต","default")},50)}async function Vt(){const e=document.querySelector("#forceApplyModal");if(!e)return;const a=e.querySelector('[name="force_apply_type_hidden"]'),s=e.querySelector('[name="force_apply_code"]'),t=e.querySelector('[name="force_apply_price"]'),o=a.value,n=s.value.trim(),r=_(t.value);if(!o){w("โปรดเลือกประเภทรายการที่จะบังคับใช้","warning"),e.querySelector("#forceApplySelectTypeBtn")?.focus();return}if(!n){w("โปรดกรอกรหัสที่จะบังคับใช้","warning"),s.focus();return}if(r<0||r<=0&&!["fabric","sheer","wallpaper"].includes(o)){w("โปรดกรอกราคาที่ถูกต้อง (> 0)","warning"),t.focus();return}const l=e.querySelector("#forceApplySelectedTypeDisplay");let i=l?l.textContent:o;const d="ยืนยันการบังคับใช้",c=`⚠️ ยืนยันการเปลี่ยนรหัสเป็น "${n}" และราคาเป็น ${B(r)} บาท สำหรับรายการประเภท "${i}" ***ทุกรายการ*** ในทุกห้องหรือไม่? การกระทำนี้ไม่สามารถยกเลิกได้ง่ายๆ`;if(!await re(d,c))return;se(J()),ee();let p=0;document.querySelectorAll(".item-card").forEach(f=>{if(f.classList.contains("placeholder-item"))return;const g=f.dataset.type;let y=null,h=null;if(o==="fabric"&&g==="set"?(y=f.querySelector('input[name="fabric_code"]'),h=f.querySelector('select[name="set_price_per_m"]')):o==="sheer"&&g==="set"?(y=f.querySelector('input[name="sheer_fabric_code"]'),h=f.querySelector('select[name="sheer_price_per_m"]')):o==="wallpaper"&&g==="wallpaper"?(y=f.querySelector('input[name="wallpaper_code"]'),h=f.querySelector('input[name="wallpaper_price_roll"]')):g===o&&f.matches(".area-based-item")&&(y=f.querySelector('input[name="area_code"]'),h=f.querySelector('input[name="area_price_sqyd"]')),y&&h){if(y.value=n,y.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0})),h.tagName==="SELECT")if(Array.from(h.options).some(T=>T.value==r))h.value=r;else{if(console.warn(`Price ${r} not found in options for`,h,". Forcing new option."),!h.querySelector(`option[value="${r}"][data-forced="true"]`)){const C=document.createElement("option");C.value=r,C.textContent=r===0?"0 บาท":`${B(r)} บาท (บังคับ)`,C.dataset.forced="true",h.appendChild(C)}h.value=r}else{const b=r===0?"0":r!=null&&r>0?B(r):"";h.value=b}h.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0})),h.dispatchEvent(new Event("blur",{bubbles:!0,cancelable:!0})),p++,y.classList.add("input-highlight"),h.classList.add("input-highlight"),setTimeout(()=>{y.classList.remove("input-highlight"),h.classList.remove("input-highlight")},1200)}}),p>0?(Y(),w(`บังคับใช้ค่าใหม่กับ ${p} รายการ (${i}) สำเร็จ`,"success"),e&&typeof e.closeModal=="function"&&e.closeModal({cancelled:!0})):w(`ไม่พบรายการประเภท "${i}" ที่ต้องอัปเดต`,"default")}async function Gt(){const e=document.querySelector("#manageFavsTypeModal"),a=document.querySelector("#manageFavsTypeBody");if(!e||!a)return;const s=Object.keys(ce());let t="",o=null;const n={fabric:"ph-rows",sheer:"ph-waves",wallpaper:"ph-paint-roller",wooden_blind:"ph-table",roller_blind:"ph-scroll",vertical_blind:"ph-sidebar-simple",partition:"ph-columns",pleated_screen:"ph-squares-four",aluminum_blind:"ph-stack-simple"};if(s.includes("fabric")&&(t+=`
             <label data-item-type="fabric">
                 <input type="radio" name="manage_fav_type_option" value="fabric">
                 <span class="radio-card-content">
                     <strong><i class="ph ${n.fabric}"></i> ผ้าทึบ</strong>
                     <small>Fabric Codes</small>
                 </span>
             </label>`,o||(o="fabric")),s.includes("sheer")&&(t+=`
              <label data-item-type="sheer">
                  <input type="radio" name="manage_fav_type_option" value="sheer">
                  <span class="radio-card-content">
                      <strong><i class="ph ${n.sheer}"></i> ผ้าโปร่ง</strong>
                      <small>Sheer Codes</small>
                  </span>
              </label>`,o||(o="sheer")),s.forEach(l=>{if(l==="fabric"||l==="sheer")return;const i=R[l];if(i){const d=i.name,c=n[l]||"ph-star";t+=`
                <label data-item-type="${l}">
                    <input type="radio" name="manage_fav_type_option" value="${l}">
                    <span class="radio-card-content">
                        <strong><i class="ph ${c}"></i> ${L(d)}</strong>
                        <small>${l.replace(/_/g," ").replace(/\b\w/g,p=>p.toUpperCase())} Codes</small>
                    </span>
                </label>`,o||(o=l)}}),a.innerHTML=t,o){const l=a.querySelector(`input[value="${o}"]`);l&&(l.checked=!0)}const r=await H("#manageFavsTypeModal");if(r&&!r.cancelled){const l=a.querySelector('input[name="manage_fav_type_option"]:checked')?.value;l&&await dt(l)}}function Re(e,a){e&&(se(J()),ee(),e.classList.add("item-removing"),e.addEventListener("animationend",()=>{e.remove(),w(a),Ae(),ae(),Y(),$e()},{once:!0}))}function Ut(e){if(!e)return;const a=document.querySelector(".main-header");if(!a){e.scrollIntoView({behavior:"smooth",block:"center"});return}const s=a.offsetHeight,t=16,n=(e.querySelector(".item-header")||e).getBoundingClientRect(),r=s+t,l=n.top-r;Math.abs(l)>5&&window.scrollBy({top:l,behavior:"smooth"})}function ve(e){if(!e)return;const a=document.querySelector(".main-header"),s=document.querySelector(".summary-footer"),t=a?a.offsetHeight+16:80,o=s?s.offsetHeight+16:100;requestAnimationFrame(()=>{const n=e.getBoundingClientRect(),r=window.innerHeight;if(!(n.top>=t&&n.bottom<=r-o)){const i=r-t-o,d=n.height>i?"start":"center";e.scrollIntoView({behavior:"smooth",block:d})}})}function ae(){document.querySelectorAll(m.room).forEach(e=>{const a=e.querySelectorAll(".item-card:not(.item-hidden)");let s=0;const t=Array.from(a).filter(o=>!o.classList.contains("is-suspended")&&!o.classList.contains("placeholder-item")).length;a.forEach(o=>{const n=o.querySelector("[data-item-title]");n&&(o.classList.contains("placeholder-item")?n.textContent="...":o.classList.contains("is-suspended")?n.textContent="-":(s++,n.textContent=`${s}/${t}`))}),e.querySelectorAll(".item-card.item-hidden").forEach(o=>{const n=o.querySelector("[data-item-title]");n&&(n.textContent="-")})})}function it(){const e=document.querySelector(m.orderForm),a=document.querySelector(m.lockBtn);!e||!a||(e.classList.toggle("is-locked",Z),a.classList.toggle("is-locked",Z),a.querySelector("i").className=Z?"ph-bold ph-lock-key":"ph ph-paw-print",e.querySelectorAll('input:not([type="hidden"]), select, textarea, button:not(.unlockable):not([data-act="toggle-more-details"]):not([data-act="collapse-room"])').forEach(s=>{!s.closest(".main-header")&&!s.closest(".summary-footer")&&!s.closest(".modal-wrapper")&&(s.disabled=Z)}),document.querySelectorAll(".unlockable").forEach(s=>s.disabled=!1))}function Jt(){Z=!Z,it(),w(Z?"ฟอร์มถูกล็อค":"ปลดล็อคฟอร์มแล้ว",Z?"warning":"success")}function ne(){const e=document.querySelectorAll(m.room+":not(.item-hidden)");if(e.length===0){const t=document.querySelector(m.toggleAllRoomsBtn);t&&(t.querySelector("i").className="ph ph-caret-down",t.querySelector("span").textContent="ขยายทั้งหมด");return}const a=[...e].some(t=>t.open),s=document.querySelector(m.toggleAllRoomsBtn);s&&(s.querySelector("i").className=a?"ph ph-caret-up":"ph ph-caret-down",s.querySelector("span").textContent=a?"ย่อทั้งหมด":"ขยายทั้งหมด")}function Yt(){const e=document.querySelectorAll(m.room+":not(.item-hidden)");if(e.length===0)return;const a=[...e].some(t=>t.open);e.forEach(t=>{t.open=!a});const s=document.querySelector(m.quickNavDropdown);s&&s.classList.contains("show")&&(s.classList.remove("show"),document.querySelector(m.quickNavBtn)?.setAttribute("aria-expanded","false")),setTimeout(()=>{ne(),z()},50)}function Ae(){const e=document.querySelector(m.quickNavRoomList);e&&(e.innerHTML="",document.querySelectorAll(m.room).forEach(a=>{const s=a.querySelector(m.roomNameInput)?.value||"ห้อง",t=document.createElement("a");t.href=`#${a.id}`,t.dataset.jumpTo=a.id,t.innerHTML=`<i class="ph ph-share-fat"></i> ${L(s)||"ห้อง (ไม่มีชื่อ)"}`,e.appendChild(t)}))}function Fe(e){const a=document.getElementById("quickNavBtnText");a&&(e?a.textContent=e.querySelector('input[name="room_name"]')?.value||"...":a.textContent="ไปยังห้อง")}function $e(){if(ke&&ke.disconnect(),!document.getElementById("quickNavBtnText"))return;const a={root:null,rootMargin:"-60px 0px -150px 0px",threshold:0},s=o=>{const n=o.filter(r=>r.isIntersecting).sort((r,l)=>r.target.getBoundingClientRect().top-l.target.getBoundingClientRect().top);n.length>0&&Fe(n[0].target)};ke=new IntersectionObserver(s,a),document.querySelectorAll(m.room).forEach(o=>ke.observe(o));const t=Array.from(document.querySelectorAll(m.room));if(t.length>0){t.sort((n,r)=>n.getBoundingClientRect().top-r.getBoundingClientRect().top);const o=t.find(n=>n.getBoundingClientRect().bottom>60);Fe(o||t[0])}else Fe(null)}function Me(e,a=null){if(!e||e.classList.contains("placeholder-item"))return;const s=e.querySelector(".item-details-more"),t=e.querySelector('[data-act="toggle-more-details"]'),o=t?.parentElement;if(!s||!t||!o)return;const n=s.classList.contains("show"),r=a!==null?a:!n;if(n===r)return;s.classList.toggle("show",r),t.classList.toggle("expanded",r);const l=t.querySelector("i");l&&(l.className=r?"ph ph-caret-up":"ph ph-caret-down");const i=t.querySelector("span");if(i&&(i.textContent=r?"ย่อน้อยลง":"เพิ่มเติม"),r)s.appendChild(o),setTimeout(()=>Ut(e),100);else{const d=e.querySelector(".item-grid");d&&d.appendChild(o)}}function he(e={}){const a=document.querySelector(m.roomsContainer);if(!a)return null;Object.keys(e).length===0&&(se(J()),ee());const s=nt(e);return s?(a.appendChild(s),Object.keys(e).length===0&&(s.classList.add("item-created"),ve(s),s.querySelector('input[name="room_name"]')?.focus()),Ae(),ne(),$e(),Object.keys(e).length===0&&z(),s):null}async function ct(e,a=null){const s=document.querySelector("#itemTypeModal");if(!s)return null;s.querySelector("#itemTypeModalTitle").textContent=e;let t=a||"set";a&&!R[a]&&(t="set");const o=s.querySelector(`input[name="item_type_option"][value="${t}"]`);if(o)o.checked=!0;else{const l=s.querySelector('input[name="item_type_option"][value="set"]');l&&(l.checked=!0)}const n=await H("#itemTypeModal");if(!n||n.cancelled)return null;const r=s.querySelector('input[name="item_type_option"]:checked');return r?r.value:null}function tt(){const e=document.createElement("div");return e.className="dimension-input-row",e.innerHTML=`
        <div class="form-group">
            <label class="visually-hidden">กว้าง (ม.)</label>
            <input type="number" step="0.01" inputmode="decimal" name="modal_width_m" placeholder="กว้าง">
        </div>
        <div class="form-group">
            <label class="visually-hidden">สูง (ม.)</label>
            <input type="number" step="0.01" inputmode="decimal" name="modal_height_m" placeholder="สูง">
        </div>
        <button type="button" class="btn-icon btn-icon-small danger btn-remove-dimension-row" data-act="remove-dimension-row" title="ลบขนาด" aria-label="ลบขนาดแถวนี้"><i class="ph-bold ph-x"></i></button>
    `,e.querySelectorAll('input[type="number"]').forEach(a=>{a.addEventListener("blur",s=>{s.target.value=K(s.target.value)})}),e}function Qt(e,a){if(!a||!e||e.width_m<=0||e.height_m<=0)return;const s=a.getItemsContainer();if(!s)return;const t=document.querySelector("#placeholderItemTpl");if(!t)return console.error("Placeholder template not found"),null;const n=t.content.cloneNode(!0).firstElementChild;n.dataset.widthM=e.width_m,n.dataset.heightM=e.height_m;const r=n.querySelector("[data-placeholder-width]"),l=n.querySelector("[data-placeholder-height]");return r&&(r.textContent=K(e.width_m)),l&&(l.textContent=K(e.height_m)),s.appendChild(n),n.classList.add("item-created"),n}function Kt(e,a,s){if(!e||!a||!s)return;const t=e.closest(m.room);if(!t)return;se(J()),ee();const o=JSON.parse(t.dataset.roomDefaults||"{}");let n={width_m:s.width_m,height_m:s.height_m};const r=i=>o[`enable_defaults_${i}`]===!0;switch(a){case"set":r("set")&&(n.fabric_code=o.defaults_fabric_code,n.price_per_m_raw=o.defaults_fabric_price,n.sheer_fabric_code=o.defaults_sheer_code,n.sheer_price_per_m=o.defaults_sheer_price);break;case"wallpaper":r("wallpaper")&&(n.wallpaper_code=o.defaults_wallpaper_code,n.price_per_roll=o.defaults_wallpaper_price_roll,n.install_cost_per_roll=o.defaults_wallpaper_install_cost),delete n.width_m;break;case"wooden_blind":r("wooden_blind")&&(n.code=o.defaults_wooden_blind_code,n.price_sqyd=o.defaults_wooden_blind_price_sqyd);break;case"roller_blind":r("roller_blind")&&(n.code=o.defaults_roller_blind_code,n.price_sqyd=o.defaults_roller_blind_price_sqyd);break;case"vertical_blind":r("vertical_blind")&&(n.code=o.defaults_vertical_blind_code,n.price_sqyd=o.defaults_vertical_blind_price_sqyd);break;case"partition":r("partition")&&(n.code=o.defaults_partition_code,n.price_sqyd=o.defaults_partition_price_sqyd);break;case"pleated_screen":r("pleated_screen")&&(n.code=o.defaults_pleated_screen_code,n.price_sqyd=o.defaults_pleated_screen_price_sqyd);break;case"aluminum_blind":r("aluminum_blind")&&(n.code=o.defaults_aluminum_blind_code,n.price_sqyd=o.defaults_aluminum_blind_price_sqyd);break}let l;if(a==="set")l=Ce(n);else if(a==="wallpaper")l=Be(n);else if(R[a]?.templateId==="#areaBasedTpl")l=Ee(a,n);else{w(`ไม่รู้จักประเภทรายการ: ${a}`,"error");return}l&&(e.replaceWith(l),l.classList.add("item-created"),ve(l),l.querySelector('input:not([type="hidden"]), select, textarea')?.focus(),ae(),Y(),w(`เพิ่ม ${R[a]?.name||"รายการ"} แล้ว`,"success"))}async function Xt(e){if(!e||e.classList.contains("placeholder-item"))return;const a=e.dataset.type,s=await ct("เปลี่ยนประเภทรายการ",a);if(!s||s===a||!await re("ยืนยันการเปลี่ยนแปลง","ข้อมูลส่วนใหญ่ในรายการนี้จะถูกล้างและใช้ค่าเริ่มต้น (ถ้ามี) คุณแน่ใจหรือไม่?"))return;se(J()),ee();const t={width_m:_(e.querySelector('input[name$="_width_m"], input[name="width_m"]')?.value),height_m:_(e.querySelector('input[name$="_height_m"], input[name="height_m"]')?.value)};a==="wallpaper"&&(t.height_m=_(e.querySelector(m.wallHeightInput)?.value));const o=e.closest(m.room),n=JSON.parse(o?.dataset.roomDefaults||"{}");let r={width_m:t.width_m>0?t.width_m:void 0,height_m:t.height_m>0?t.height_m:void 0};const l=d=>n[`enable_defaults_${d}`]===!0;switch(s){case"set":l("set")&&(r.fabric_code=n.defaults_fabric_code,r.price_per_m_raw=n.defaults_fabric_price,r.sheer_fabric_code=n.defaults_sheer_code,r.sheer_price_per_m=n.defaults_sheer_price);break;case"wallpaper":l("wallpaper")&&(r.wallpaper_code=n.defaults_wallpaper_code,r.price_per_roll=n.defaults_wallpaper_price_roll,r.install_cost_per_roll=n.defaults_wallpaper_install_cost),delete r.width_m,r.height_m=t.height_m>0?t.height_m:void 0;break;case"wooden_blind":l("wooden_blind")&&(r.code=n.defaults_wooden_blind_code,r.price_sqyd=n.defaults_wooden_blind_price_sqyd);break;case"roller_blind":l("roller_blind")&&(r.code=n.defaults_roller_blind_code,r.price_sqyd=n.defaults_roller_blind_price_sqyd);break;case"vertical_blind":l("vertical_blind")&&(r.code=n.defaults_vertical_blind_code,r.price_sqyd=n.defaults_vertical_blind_price_sqyd);break;case"partition":l("partition")&&(r.code=n.defaults_partition_code,r.price_sqyd=n.defaults_partition_price_sqyd);break;case"pleated_screen":l("pleated_screen")&&(r.code=n.defaults_pleated_screen_code,r.price_sqyd=n.defaults_pleated_screen_price_sqyd);break;case"aluminum_blind":l("aluminum_blind")&&(r.code=n.defaults_aluminum_blind_code,r.price_sqyd=n.defaults_aluminum_blind_price_sqyd);break}let i;if(s==="set")i=Ce(r);else if(s==="wallpaper")i=Be(r);else if(R[s]?.templateId==="#areaBasedTpl")i=Ee(s,r);else return;i&&(e.replaceWith(i),i.classList.add("item-created"),ve(i),i.querySelector('input:not([type="hidden"]), select, textarea')?.focus(),ae(),Y(),w("เปลี่ยนประเภทรายการแล้ว","success"))}const Y=qe(()=>{let e=0;document.querySelectorAll(m.room).forEach(d=>{let c=0,p=0;const u=d.classList.contains("is-suspended");if(u||(d.querySelectorAll(".item-card:not(.is-suspended):not(.placeholder-item)").forEach(f=>{const g=_(f.dataset.totalPrice);g>0&&(c+=g,p++)}),e+=c),typeof d.updateBrief=="function"){const f=d.querySelectorAll(".placeholder-item:not(.is-suspended)").length;if(u)d.updateBrief("(ระงับชั่วคราว)");else if(p>0){let g=`<span>${p}</span> &bull; ${B(c)} บาท`;f>0&&(g+=` (+${f} รอเลือก)`),d.updateBrief(g)}else f>0?d.updateBrief(`<span>${f}</span> รอเลือกประเภท`):d.updateBrief("<span>0</span> รายการ")}});const a=document.querySelector("#discount_type"),s=document.querySelector("#discount_value"),t=a?a.value:"amount",o=s?_(s.value):0;let n=0;o>0&&(n=t==="percent"?e*(o/100):o,n=Math.min(e,n));const r=e-n,l=document.querySelector("#grandTotal"),i=document.querySelector("#originalTotal");l&&(l.textContent=B(r)),i&&(n>0?(i.textContent=B(e),i.dataset.rawTotal=e,i.style.display="block"):(i.style.display="none",i.dataset.rawTotal="")),_e(),z()},200);async function Ge(e,a=!1){if(!e){w("ข้อมูลสำหรับโหลดไม่ถูกต้อง","error");return}if(e.favorites)if(a){const d=document.querySelector("#favoritesConflictModal");if(d){const c=d.querySelector('input[name="fav_conflict_option"][value="merge"]');c&&(c.checked=!0);const p=await H("#favoritesConflictModal");if(!p||p.cancelled){w("ยกเลิกการนำเข้า","warning");return}const u=d.querySelector('input[name="fav_conflict_option"]:checked').value;let f=0;switch(u){case"overwrite":Ue(e.favorites)&&w("เขียนทับรายการโปรดสำเร็จ","success");break;case"merge":f=Oe(e.favorites),w(`รวมข้อมูลสำเร็จ (เพิ่ม ${f} รายการใหม่)`,"success");break;case"skip":w("ข้ามการนำเข้ารายการโปรด","default");break}}else Oe(e.favorites)}else Ue(e.favorites);const s=document.querySelector(m.roomsContainer);if(!s)return;s.innerHTML="";const t=document.querySelector("#customer_name"),o=document.querySelector("#customer_phone"),n=document.querySelector("#customer_address"),r=document.querySelector("#customerDetailsCard");t&&(t.value=e.customer_name||""),o&&(o.value=e.customer_phone||""),n&&(n.value=e.customer_address||""),r&&(r.open=e.customer_card_open??!0);const l=document.querySelector("#discount_type"),i=document.querySelector("#discount_value");if(e.discount&&l&&i?(l.value=e.discount.type||"amount",i.value=e.discount.value||0):l&&i&&(l.value="amount",i.value=0),!Array.isArray(e.rooms)){w("ไม่พบข้อมูลห้องในไฟล์","warning"),s.children.length===0&&he();return}for(const d of e.rooms){const c=nt(d);if(!c)continue;s.appendChild(c);const p=c.getItemsContainer();if(p&&Array.isArray(d.items))for(const u of d.items){let f;if(u.type==="placeholder"){const g=document.querySelector("#placeholderItemTpl");if(g){f=g.content.cloneNode(!0).firstElementChild,f.dataset.widthM=u.width_m||0,f.dataset.heightM=u.height_m||0;const h=f.querySelector("[data-placeholder-width]"),b=f.querySelector("[data-placeholder-height]");h&&(h.textContent=K(u.width_m)),b&&(b.textContent=K(u.height_m)),u.is_suspended&&f.classList.add("is-suspended")}else{console.warn("Placeholder template not found during load.");continue}}else if(u.type==="set")f=Ce(u);else if(u.type==="wallpaper")f=Be(u);else if(R[u.type]?.templateId==="#areaBasedTpl")f=Ee(u.type,u);else continue;f&&p.appendChild(f)}}ae(),Ae(),ne(),$e(),ee(),Y(),a&&w("นำเข้าข้อมูลฟอร์มสำเร็จ","success")}async function zt(e,a){const s=document.querySelector(m.printableContent);if(!s||!e){w("ไม่พบข้อมูลสำหรับสร้างเอกสาร","error");return}const t=document.title;if(a==="direct"){w("กำลังสร้าง PDF...","default");let o;try{typeof window.html2pdf>"u"&&(w("กำลังโหลดไลบรารี PDF...","default"),await Et("https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js")),o=document.createElement("div"),o.style.position="fixed",o.style.left="-300mm",o.style.top="0",o.style.width="210mm",o.style.background="#fff",o.innerHTML=e,document.body.appendChild(o),await new Promise(r=>setTimeout(r,300));const n={margin:0,filename:`${t}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0,logging:!1,width:o.querySelector(".pdf-page")?.scrollWidth||794,windowWidth:o.querySelector(".pdf-page")?.scrollWidth||794},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}};await window.html2pdf().from(o).set(n).save(),w("ดาวน์โหลด PDF สำเร็จ","success")}catch(n){console.error("PDF Generation Error:",n),w("สร้าง PDF ล้มเหลว, โปรดลองวิธีที่ 2 (พิมพ์)","error")}finally{o&&document.body.contains(o)&&document.body.removeChild(o)}}else a==="print"&&(s.innerHTML=e,setTimeout(()=>{window.print(),setTimeout(()=>{s.innerHTML=""},1e3)},ft))}function Zt(e){if(!e||!e.html){w("ไม่พบข้อมูลสำหรับสร้างไฟล์ HTML","error");return}try{const a=`<!DOCTYPE html><html lang="th"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>${e.fileName}</title><link rel="stylesheet" href="./src/styles/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/bold/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/fill/style.css"><style>body { background-color: #eee; } #printable-content { display: block !important; max-width: 210mm; margin: 10mm auto; } .pdf-page { border: 1px solid #ccc; box-shadow: 0 0 10px rgba(0,0,0,0.1); margin-bottom: 10mm; background: #fff; page-break-inside: avoid; } .pdf-page-content { padding: 12mm; } @media print { body { background-color: #fff; } #printable-content { max-width: 100%; margin: 0; } .pdf-page { border: none; box-shadow: none; margin-bottom: 0; page-break-after: always; } .pdf-page:last-child { page-break-after: avoid; } } i.ph { vertical-align: middle; }</style></head><body><div id="printable-content">${e.html}</div></body></html>`,s=new Blob([a],{type:"text/html;charset=utf-8"}),t=URL.createObjectURL(s),o=document.createElement("a");o.href=t,o.download=`${e.fileName}.html`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(t),w("ดาวน์โหลดไฟล์ HTML สำเร็จ","success")}catch(a){console.error("HTML Export Error:",a),w("สร้างไฟล์ HTML ล้มเหลว","error")}}function eo(e){const{roomId:a,itemIndex:s}=e.dataset;if(!a||s===void 0)return;const t=document.getElementById("lookbookModal");t&&typeof t.closeModal=="function"&&t.closeModal({cancelled:!0});const o=document.getElementById(a);if(!o){w("ไม่พบห้องที่ต้องการ","error");return}const r=Array.from(o.querySelectorAll(".item-card:not(.item-hidden)"))[parseInt(s,10)];if(!r){w("ไม่พบรายการที่ต้องการ","error");return}o.open=!0,ne(),setTimeout(()=>{r.scrollIntoView({behavior:"smooth",block:"center"}),r.classList.add("scrolling-jump"),setTimeout(()=>r.classList.remove("scrolling-jump"),2500)},150)}function to(e){if(!ie)return;const a=ie.closest("#roomDefaultsModal"),s=ie.closest(".item-card"),t=ie.closest("#forceApplyModal");let o=ie,n=null;const r=o.dataset.favoriteType,l=e.dataset.code,i=_(e.dataset.price);if(s){let p;r==="fabric"?p="set_price_per_m":r==="sheer"?p="sheer_price_per_m":r==="wallpaper"?p="wallpaper_price_roll":p="area_price_sqyd",n=s.querySelector(`[name="${p}"]`)}else if(a){const p=o.closest(".defaults-inputs-grid");if(p){let u;r==="fabric"?u="defaults_fabric_price":r==="sheer"?u="defaults_sheer_price":r==="wallpaper"?u="defaults_wallpaper_price_roll":r==="wooden_blind"?u="defaults_wooden_blind_price_sqyd":r==="roller_blind"?u="defaults_roller_blind_price_sqyd":r==="vertical_blind"?u="defaults_vertical_blind_price_sqyd":r==="partition"?u="defaults_partition_price_sqyd":r==="pleated_screen"?u="defaults_pleated_screen_price_sqyd":r==="aluminum_blind"&&(u="defaults_aluminum_blind_price_sqyd"),u&&(n=p.querySelector(`[name="${u}"]`))}}else t&&(n=t.querySelector('[name="force_apply_price"]'));const d=n;o.value=l,o.classList.add("input-highlight"),setTimeout(()=>{o&&o.classList.remove("input-highlight")},1200),d&&i>=0&&(d.tagName==="SELECT"?Array.from(d.options).some(p=>_(p.value)===i)?d.value=i:w(`ราคา ${B(i)} ไม่มีในตัวเลือก`,"warning"):d.value=i===0?"0":i>0?B(i):"",d.classList.add("input-highlight"),setTimeout(()=>{d&&d.classList.remove("input-highlight")},1200)),s?((d||o).dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0})),d&&d.matches('input[inputmode="numeric"]')&&d.dispatchEvent(new Event("blur",{bubbles:!0,cancelable:!0}))):(a||t)&&d&&d.matches('input[inputmode="numeric"]')&&d.dispatchEvent(new Event("blur",{bubbles:!0,cancelable:!0}));const c=document.querySelector("#favoritesModal");c&&typeof c.closeModal=="function"&&c.closeModal({cancelled:!1,applied:!0})}async function oo(e){if(!e||!e.dataset.favoriteType){console.warn("showFavoritesModal called without a valid input element or favorite type.");return}ie=e;const a=e.dataset.favoriteType;if(!a){w("โปรดเลือกประเภทรายการก่อน","warning");const g=e.closest("#forceApplyModal");g&&g.querySelector("#forceApplySelectTypeBtn")?.focus(),ie=null;return}const s=document.querySelector("#favoritesModal"),t=s.querySelector("#favoritesModalTitle"),o=s.querySelector("#favoritesModalBody"),n=s.querySelector("#favSearchInput"),r=s.querySelector('[data-act="manage-favorites"]'),l=document.querySelector("#favSelectorItemTpl");if(!s||!t||!o||!n||!r||!l){console.error("Missing elements for favorites modal");return}let i=R[a]?.name||a;a==="fabric"?i="ผ้าทึบ":a==="sheer"&&(i="ผ้าโปร่ง"),t.textContent=`เลือก '${L(i)}'`;const d=()=>{const y=ce()[a]||[];y.length>0?o.innerHTML=y.map(h=>{let b="-";return h.price>=0&&(b=B(h.price)),l.innerHTML.replace(/{CODE}/g,L(h.code)).replace(/{PRICE}/g,b).replace(/{RAW_PRICE}/g,h.price)}).join(""):o.innerHTML='<p class="empty-state">ไม่มีรายการโปรดที่บันทึกไว้</p>',n.value=""};d();const c=()=>{const g=n.value.toLowerCase();o.querySelectorAll(".fav-selector-item").forEach(y=>{const h=y.dataset.code.toLowerCase();y.classList.toggle("is-hidden",!h.includes(g))})},p=g=>{const y=g.target.closest(".fav-selector-item");y&&to(y)},u=async()=>{await dt(a),we&&d()},f=()=>{n.removeEventListener("input",c),o.removeEventListener("click",p),r&&(r.onclick=null)};n.addEventListener("input",c),o.addEventListener("click",p),r.onclick=u,await H("#favoritesModal",f)}function Te(e){const a=document.querySelector("#favManagerBody"),s=document.querySelector("#favManagerItemTpl"),o=ce()[e]||[];if(!a||!s)return;o.length===0?a.innerHTML='<p class="empty-state">ไม่มีรายการโปรดที่บันทึกไว้</p>':a.innerHTML=o.map(l=>{let i="-";return l.price>=0&&(i=B(l.price)),s.innerHTML.replace(/{CODE}/g,L(l.code)).replace(/{PRICE}/g,i).replace(/{RAW_PRICE}/g,l.price)}).join(""),U=null;const n=document.querySelector('#favManagerModal [data-act="edit-selected-fav"]'),r=document.querySelector('#favManagerModal [data-act="del-selected-fav"]');n&&(n.disabled=!0),r&&(r.disabled=!0)}async function dt(e){const a=document.querySelector("#favManagerModal");if(!a||!e)return;let s=R[e]?.name||e;e==="fabric"?s="ผ้าทึบ":e==="sheer"&&(s="ผ้าโปร่ง"),a.dataset.currentType=e,we=!1,U=null,document.querySelector("#favManagerTitle").textContent=`จัดการ '${L(s)}'`,Te(e),await H("#favManagerModal")}function ro(e){if(!e||!e.matches(m.itemCard)||e.classList.contains("placeholder-item"))return null;const a=e.dataset.type;if(!a)return null;let s={type:a,is_suspended:e.classList.contains("is-suspended")};try{if(a==="set")Object.assign(s,{width_m:_(e.querySelector(m.setWidthInput)?.value),height_m:_(e.querySelector(m.setHeightInput)?.value),style:e.querySelector(m.setStyleSelect)?.value||"",fabric_variant:e.querySelector(m.setFabricVariantSelect)?.value||"",price_per_m_raw:_(e.querySelector(m.setPricePerMSelect)?.value),sheer_price_per_m:_(e.querySelector(m.setSheerPricePerMSelect)?.value),louis_price_per_m:_(e.querySelector('select[name="louis_price_per_m"]')?.value),fabric_code:e.querySelector(m.setFabricCodeInput)?.value||"",sheer_fabric_code:e.querySelector(m.setSheerCodeInput)?.value||"",opening_style:e.querySelector(m.setOpeningStyleSelect)?.value||"",adjustment_side:e.querySelector(m.setAdjustmentSideSelect)?.value||"ปรับขวา",track_color:e.querySelector('input[name="track_color"]')?.value||"ขาว",bracket_color:e.querySelector('input[name="bracket_color"]')?.value||"ขาว",finial_color:e.querySelector('input[name="finial_color"]')?.value||"ขาว",grommet_color:e.querySelector('input[name="grommet_color"]')?.value||"เงิน",louis_valance:e.querySelector('input[name="louis_valance"]')?.value||"กล่องหลุยส์",louis_tassels:e.querySelector('input[name="louis_tassels"]')?.value||"สีเข้ากับผ้า",notes:e.querySelector(m.setNotesInput)?.value||""});else if(a==="wallpaper"){const t=e.querySelector(m.wallInstallCostInput),o=t?t.value:"";let n;o==="0"?n=0:_(o)>0?n=_(o):n=void 0,Object.assign(s,{height_m:_(e.querySelector(m.wallHeightInput)?.value),wallpaper_code:e.querySelector(m.wallCodeInput)?.value||"",price_per_roll:_(e.querySelector(m.wallPriceRollInput)?.value),install_cost_per_roll:n,notes:e.querySelector(m.wallNotesInput)?.value||"",widths:Array.from(e.querySelectorAll(m.wallWidthInput)).map(r=>_(r.value))})}else e.matches(m.areaBasedItem)&&(Object.assign(s,{width_m:_(e.querySelector(m.areaWidthInput)?.value),height_m:_(e.querySelector(m.areaHeightInput)?.value),price_sqyd:_(e.querySelector(m.areaPriceSqydInput)?.value),code:e.querySelector(m.areaCodeInput)?.value||"",notes:e.querySelector(m.areaNotesInput)?.value||""}),(a==="partition"||a==="pleated_screen")&&(s.opening_style=e.querySelector('select[name="opening_style"]')?.value||"แยกกลาง"),["wooden_blind","roller_blind","vertical_blind","aluminum_blind"].includes(a)&&(s.adjustment_side=e.querySelector('select[name="adjustment_side"]')?.value||"ปรับขวา"));return s}catch(t){return console.error("Failed to extract item data:",t,e),null}}function ao(e){if(!e)return;const a=e.closest(m.room);if(!a||!a.getItemsContainer())return;se(J()),ee();let t;if(e.classList.contains("placeholder-item")){const o=document.querySelector("#placeholderItemTpl");if(o){t=o.content.cloneNode(!0).firstElementChild,t.dataset.widthM=e.dataset.widthM,t.dataset.heightM=e.dataset.heightM;const r=t.querySelector("[data-placeholder-width]"),l=t.querySelector("[data-placeholder-height]");r&&(r.textContent=K(e.dataset.widthM)),l&&(l.textContent=K(e.dataset.heightM)),e.classList.contains("is-suspended")&&t.classList.add("is-suspended")}else{w("ไม่พบ Template สำหรับ Placeholder","error");return}}else{const o=ro(e);if(!o){w("ไม่สามารถคัดลอกรายการได้","error");return}if(o.type==="set")t=Ce(o);else if(o.type==="wallpaper")t=Be(o);else if(R[o.type]?.templateId==="#areaBasedTpl")t=Ee(o.type,o);else{w("ไม่รู้จักประเภทรายการ","error");return}}if(t){if(e.after(t),t.classList.add("item-created"),!t.classList.contains("placeholder-item")){const o=e.querySelector(m.itemDetailsMore);o&&o.classList.contains("show")&&Me(t,!0)}ve(t),ae(),Y(),w("คัดลอกรายการแล้ว","success")}}function no(){const e=document.querySelector(m.orderForm),a=document.querySelector(m.fileImporter),s=document.querySelector("#favImporter"),t=document.querySelector(m.menuDropdown),o=document.querySelector(m.quickNavDropdown),n=document.querySelector(m.menuBtn),r=document.querySelector(m.quickNavBtn);if(e){if(e.addEventListener("item-update",Y),e.addEventListener("input",l=>{if(Z){l.preventDefault();return}if(l.target.closest("#customerInfo")&&z(),l.target.matches(m.roomNameInput)){const d=l.target.closest(".room-card")?.querySelector("[data-room-name-display]");d&&(d.textContent=l.target.value||"ห้อง"),Ae(),$e(),qe(z,300)()}l.target.matches('input[name$="_m"], input[name$="price_sqyd"], input[name$="price_roll"], input[name$="install_cost"]')&&Y()}),e.addEventListener("change",l=>{if(Z){l.preventDefault();return}l.target.matches("select")&&Y()}),e.addEventListener("blur",l=>{const i=l.target;i.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_install_cost"]')?i.name==="wallpaper_install_cost"&&_(i.value)===0?i.value="0":i.value=_(i.value)>0?B(_(i.value)):"":i.matches('input[name$="_m"], input[name^="wall_width_m"], input[name^="modal_"]')&&(i.value=K(i.value)),!i.closest(".modal-wrapper")&&i.matches('input:not([type="hidden"]), select, textarea')&&z()},!0),e.addEventListener("focusin",l=>{const i=l.target;if(i.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_install_cost"]')&&(i.name==="wallpaper_install_cost"&&i.value==="0"||_(i.value)>0&&(i.value=_(i.value))),i.matches('input:not([type="hidden"]), select, textarea')){const d=document.querySelector(".main-header"),c=document.querySelector(".summary-footer"),p=d?d.offsetHeight+16:80,u=c?c.offsetHeight+16:100,f=window.innerHeight,g=i.getBoundingClientRect();if((g.top<p||g.bottom>f-u)&&!i.closest(".modal-wrapper")){const h=i.closest(".item-card, .room-card");h&&ve(h)}}},!0),e.addEventListener("keydown",l=>{if(Z){l.preventDefault();return}const i=l.target;if(l.key==="Enter"&&i.matches("input, select")&&!i.closest(".modal-wrapper"))l.preventDefault();else if(l.key==="Enter"&&i.closest("#dimensionEntryModal")){const d=i.closest("#dimensionEntryModal"),c=d.querySelectorAll(".dimension-input-row"),u=c[c.length-1].querySelector('input[name="modal_height_m"]');i===u&&(l.preventDefault(),d.querySelector("#dimensionEntryConfirm")?.click())}}),document.addEventListener("click",async l=>{l.target.closest(".menu-container")||(t?.classList.remove("show"),n?.setAttribute("aria-expanded","false"),o?.classList.remove("show"),r?.setAttribute("aria-expanded","false")),l.target.closest(".room-options-container")||document.querySelectorAll(".room-options-menu.show").forEach(p=>p.classList.remove("show"));const i=l.target.closest(".summary-tag[data-filter-type]");if(i&&i.closest("#overviewModal")){const p=i.dataset.filterType,u=i.textContent.trim().replace(/\s*\d+\s*$/,""),f=document.querySelector("#overviewModal");f&&typeof f.closeModal=="function"&&f.closeModal({cancelled:!0}),Dt(p,u);return}const d=l.target.closest(".fav-manager-item");if(d){const p=d.closest("#favManagerModal"),u=p?.querySelector(".fav-manager-item.is-selected");u&&u.classList.remove("is-selected"),u!==d?(d.classList.add("is-selected"),U={code:d.dataset.code,price:_(d.dataset.price)}):U=null,p&&(p.querySelector('[data-act="edit-selected-fav"]').disabled=!U,p.querySelector('[data-act="del-selected-fav"]').disabled=!U);return}const c=l.target.closest("[data-act]");if(c){const p=c.dataset.act,u=c.closest(".item-card"),f=c.closest(".room-card"),g=["toggle-more-details","collapse-room","show-discount-modal","show-suspended-items","clear-filter","close-modal","jump-to-item","manage-favorites","show-favorites"];if(Z&&!c.closest(".unlockable")&&!g.includes(p)){w("ฟอร์มถูกล็อคอยู่","warning");return}switch(["toggle-more-details","close-modal","collapse-room","remove-dimension-row"].includes(p)||l.preventDefault(),p!=="close-modal"&&l.stopPropagation(),p){case"show-discount-modal":Rt();break;case"show-suspended-items":Ne();break;case"clear-filter":lt();break;case"add-room":he();break;case"add-item":if(f){const y=document.querySelector("#dimensionEntryModal");if(y){const h=y.querySelector("#dimensionRowsContainer");h.innerHTML="";const b=tt();h.appendChild(b),b.querySelector('input[name="modal_width_m"]')?.focus();const T=await H("#dimensionEntryModal");if(T&&!T.cancelled){const C=[];if(h.querySelectorAll(".dimension-input-row").forEach(v=>{const S=v.querySelector('input[name="modal_width_m"]'),k=v.querySelector('input[name="modal_height_m"]'),M=_(S.value),q=_(k.value);M>0&&q>0&&C.push({width_m:M,height_m:q})}),C.length>0){se(J()),ee();let v=null;C.forEach(S=>{const k=Qt(S,f);v||(v=k)}),v&&(ae(),z(),ve(v),w(`เพิ่ม ${C.length} รายการ (รอเลือกประเภท)`,"success"))}else w("ไม่มีขนาดที่ถูกต้องระบุ","warning")}}}break;case"add-dimension-row":{const y=document.querySelector("#dimensionRowsContainer");if(y){const h=tt();y.appendChild(h),h.querySelector('input[name="modal_width_m"]')?.focus(),y.scrollTop=y.scrollHeight}break}case"remove-dimension-row":{const y=c.closest(".dimension-input-row"),h=y?.parentElement;y&&h&&h.children.length>1&&y.remove();break}case"select-item-type":if(u&&u.classList.contains("placeholder-item")){const y={width_m:parseFloat(u.dataset.widthM||0),height_m:parseFloat(u.dataset.heightM||0)};if(y.width_m>0&&y.height_m>0){const h=await ct("เลือกประเภทสินค้า");h&&Kt(u,h,y)}else w("ขนาดไม่ถูกต้องบน Placeholder","error")}break;case"collapse-room":f&&(f.open=!1,setTimeout(()=>{ne(),z()},50));break;case"toggle-room-menu":c.nextElementSibling?.classList.toggle("show");break;case"open-room-defaults":f&&(Ot(f),c.closest(".room-options-menu")?.classList.remove("show"));break;case"apply-room-defaults":Wt();break;case"open-force-apply-modal":Ht();break;case"force-apply-defaults":Vt();break;case"toggle-suspend-room":f&&(f.classList.toggle("is-suspended"),c.closest(".room-options-menu")?.classList.remove("show"),Y(),ye==="suspended"?Ne():_e());break;case"clear-room":f&&await re("ล้างข้อมูลในห้อง","?")&&(se(J()),ee(),f.getItemsContainer().innerHTML="",ae(),Y(),w("ล้างแล้ว","success"));break;case"del-room":f&&await re("ลบห้อง","?")&&Re(f,"ลบแล้ว");break;case"del-item":u&&await re("ลบรายการ","?")&&Re(u,"ลบแล้ว");break;case"duplicate-item":u&&ao(u);break;case"toggle-suspend":u&&(u.classList.toggle("is-suspended"),Y(),ye==="suspended"?Ne():_e());break;case"change-type":u&&Xt(u);break;case"toggle-more-details":u&&!u.querySelector(".item-details-more")?.classList.contains("show")&&document.querySelectorAll(".item-details-more.show").forEach(y=>{y.closest(".item-card")!==u&&Me(y.closest(".item-card"),!1)}),Me(u);break;case"open-hardware-modal":O=u,O&&Ft();break;case"apply-hardware-to-room":{const y=c.closest("#hardwareModal"),h=O?.closest(m.room);if(!y||!h||!O)break;const b=O.querySelector('[name="set_style"]');if(b?.value==="ม่านพับ"||b?.value==="หลุยส์"){w("ไม่สามารถใช้กับม่านพับหรือม่านหลุยส์ได้","warning");break}const T=y.querySelector('[name="modal_track_color"]').value,C=y.querySelector('[name="modal_bracket_color"]').value,v=y.querySelector('[name="modal_finial_color"]').value,S=y.querySelector('[name="modal_grommet_color"]').value;h.querySelectorAll('.set-item:not(:has(select[name="set_style"][value="ม่านพับ"])):not(:has(select[name="set_style"][value="หลุยส์"]))').forEach(k=>{k.querySelector('[name="track_color"]').value=T,k.querySelector('[name="bracket_color"]').value=C,k.querySelector('select[name="set_style"]')?.value==="ตาไก่"&&(k.querySelector('[name="finial_color"]').value=v,k.querySelector('[name="grommet_color"]').value=S)}),z(),w("ใช้กับรายการที่เข้ากันได้ในห้องแล้ว","success");break}case"add-wall":{const y=c.closest(".walls-section")?.querySelector("[data-walls-container]");if(y){const h=He();h&&(y.appendChild(h),h.querySelector("input")?.focus(),Y())}break}case"del-wall":{const y=c.closest(".wall-input-row");y&&await re("ลบผนัง","?")&&Re(y,"ลบแล้ว");break}case"show-favorites":{const y=c.previousElementSibling?.matches("input[data-favorite-type]")?c.previousElementSibling:c.closest(".form-group-with-favorites")?.querySelector("input[data-favorite-type]");y?oo(y):console.warn("Could not find associated input for show-favorites button:",c);break}case"add-new-fav-form":{const h=c.closest("#favManagerModal")?.dataset.currentType;if(!h)break;const b=document.querySelector("#favAddModal");if(!b)break;let T=R[h]?.name||h;h==="fabric"?T="ผ้าทึบ":h==="sheer"&&(T="ผ้าโปร่ง"),b.querySelector("h3").textContent=`เพิ่ม '${T}'`;const C=b.querySelector('[name="fav_code_add"]'),v=b.querySelector('[name="fav_price_add"]');C.value="",v.value="";const S=await H("#favAddModal");if(S&&!S.cancelled){const k=C.value.trim(),M=_(v.value);k&&M>=0?Je(h,k,M)?(we=!0,Te(h),w("เพิ่มแล้ว","success")):w("ล้มเหลว","error"):w(k?"ราคาต้องไม่ติดลบ":"ต้องระบุรหัส","warning")}break}case"edit-selected-fav":{if(!U)break;const h=c.closest("#favManagerModal")?.dataset.currentType;if(!h)break;const b=document.querySelector("#favEditModal");if(!b)break;b.querySelector("h3").textContent=`แก้ไข '${U.code}'`;const T=b.querySelector('[name="fav_code_edit"]'),C=b.querySelector('[name="fav_price_edit"]');T.value=U.code,C.value=U.price!==null&&U.price>=0?U.price:"";const v=await H("#favEditModal");if(v&&!v.cancelled){const S=T.value.trim(),k=_(C.value);S&&k>=0?(S!==U.code&&Ye(h,U.code),Je(h,S,k),we=!0,Te(h),w("แก้ไขรายการโปรดแล้ว","success")):w(S?"ราคาต้องไม่ติดลบ":"ต้องระบุรหัส","warning")}break}case"del-selected-fav":{if(!U)break;const h=c.closest("#favManagerModal")?.dataset.currentType;if(!h)break;await re("ลบรายการโปรด",`"${U.code}"?`)&&(Ye(h,U.code)?(we=!0,Te(h),w("ลบแล้ว","success")):w("ล้มเหลว","error"));break}case"manage-favorites-from-defaults":await Gt();break;case"jump-to-item":eo(c);break}}else{const p=l.target.closest("summary");p&&p.closest("details.card")&&setTimeout(()=>{ne(),z()},50)}}),document.querySelector("#undoBtn")?.addEventListener("click",l=>{l.preventDefault(),Pt()}),document.querySelector(m.lockBtn)?.addEventListener("click",l=>{l.preventDefault(),Jt()}),document.querySelector(m.toggleAllRoomsBtn)?.addEventListener("click",l=>{l.preventDefault(),Yt()}),r&&o){r.addEventListener("click",i=>{i.stopPropagation(),t?.classList.remove("show");const d=!o.classList.contains("show");o.classList.toggle("show",d),r.setAttribute("aria-expanded",d),d&&n?.setAttribute("aria-expanded","false")}),document.querySelector(m.quickNavRoomList)?.addEventListener("click",i=>{const d=i.target.closest("a[data-jump-to]");if(d){i.preventDefault();const c=d.dataset.jumpTo,p=document.getElementById(c);p&&(p.open=!0,p.scrollIntoView({behavior:"smooth",block:"center"}),p.classList.add("scrolling-jump"),setTimeout(()=>p.classList.remove("scrolling-jump"),2500),setTimeout(ne,100)),o.classList.remove("show"),r.setAttribute("aria-expanded","false")}});const l=document.querySelector("#addRoomQuickNavBtn");if(l){const i=yt(he,700);l.addEventListener("click",d=>{d.stopPropagation(),i(),o.classList.remove("show"),r.setAttribute("aria-expanded","false")})}}n&&t&&n.addEventListener("click",l=>{l.stopPropagation(),o?.classList.remove("show");const i=!t.classList.contains("show");t.classList.toggle("show",i),n.setAttribute("aria-expanded",i),i&&r?.setAttribute("aria-expanded","false")}),document.querySelector("#themeToggleBtn")?.addEventListener("click",l=>{l.preventDefault(),At(),t?.classList.remove("show"),n?.setAttribute("aria-expanded","false")}),document.querySelector("#overviewBtn")?.addEventListener("click",async l=>{l.preventDefault(),t?.classList.remove("show"),n?.setAttribute("aria-expanded","false");const i=J(),d=document.querySelector("#overviewModalHeader"),c=document.querySelector("#overviewModalBody");if(d&&c){const p=i.rooms.reduce((g,y)=>g+(y.is_suspended?0:(y.items||[]).filter(h=>!h.is_placeholder&&!h.is_suspended&&(D.calculateSetPrice(h)?.total>0||D.calculateWallpaperPrice(h)?.total>0||D.calculateAreaBasedPrice(h)?.total>0)).length),0),u=document.querySelector(m.grandTotal)?.textContent||"0",f=i.rooms.filter(g=>!g.is_suspended&&g.items?.some(y=>!y.is_suspended)).length;d.innerHTML=`<div class="overview-stats-grid"><div class="overview-stat-card"><i class="ph-bold ph-map-pin-line"></i><div class="stat-value">${f}</div><div class="stat-label">ห้อง</div></div><div class="overview-stat-card"><i class="ph-bold ph-stack"></i><div class="stat-value">${p}</div><div class="stat-label">รายการ</div></div><div class="overview-stat-card"><i class="ph-bold ph-coins"></i><div class="stat-value">${u}</div><div class="stat-label">ยอดรวม</div></div></div>`,c.innerHTML=Lt(i),H("#overviewModal")}}),document.querySelector("#copyTextBtn")?.addEventListener("click",async l=>{l.preventDefault(),t?.classList.remove("show"),n?.setAttribute("aria-expanded","false");const i=document.querySelector(m.copyOptionsModal);if(!i)return;i.querySelector('input[name="copy_option"][value="customer"]').checked=!0;const d=await H(m.copyOptionsModal);if(d&&!d.cancelled){const c=i.querySelector('input[name="copy_option"]:checked').value,p=It(J(),c);try{await navigator.clipboard.writeText(p),w("คัดลอกสำเร็จ!","success")}catch{w("คัดลอกล้มเหลว","error")}}}),document.querySelector("#visualReportsBtn")?.addEventListener("click",async l=>{l.preventDefault(),t?.classList.remove("show"),n?.setAttribute("aria-expanded","false");const i=document.querySelector("#visualReportsModal");if(!i)return;i.querySelector('input[name="report_type_option"][value="lookbook"]').checked=!0;const d=await H("#visualReportsModal");if(d&&!d.cancelled){const c=i.querySelector('input[name="report_type_option"]:checked').value;if(c==="lookbook"){const p=J(),u=Bt(p),f=document.querySelector("#lookbookModalBody");u&&f?(f.innerHTML=u,H("#lookbookModal")):w("ไม่มีข้อมูล","warning")}else w(`'${c}' ยังไม่พร้อม`,"default")}}),document.querySelector(m.exportPdfBtn)?.addEventListener("click",async l=>{l.preventDefault(),t?.classList.remove("show"),n?.setAttribute("aria-expanded","false");const i=await Nt();if(!i)return;const d=J(),c=Ct(d,{vatRate:i.vatOption==="include"?W.baseVatRate:0,pageBreakBuffer:i.pageBreakBuffer,showDetails:i.showDetails});if(!c){w("ไม่มีรายการ","warning");return}i.exportMethod==="html"?Zt(c):zt(c.html,i.exportMethod)}),document.querySelector(m.submitBtn)?.addEventListener("click",async l=>{if(l.preventDefault(),t?.classList.remove("show"),n?.setAttribute("aria-expanded","false"),await re("ส่งข้อมูล","?")){const i=J();if(!i.customer_name&&!i.customer_phone){w("ใส่ชื่อ/เบอร์","warning");return}w("กำลังส่ง...","default");try{const d=await fetch(pt,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});d.ok?w("ส่งแล้ว!","success"):w(`ล้มเหลว: ${d.status}`,"error")}catch{w("เชื่อมต่อผิดพลาด","error")}}}),document.querySelector(m.importBtn)?.addEventListener("click",l=>{l.preventDefault(),t?.classList.remove("show"),n?.setAttribute("aria-expanded","false"),a?.click()}),a?.addEventListener("change",l=>{const i=l.target.files?.[0];if(!i)return;const d=new FileReader;d.onload=async c=>{try{const p=JSON.parse(c.target.result);if(p&&typeof p=="object")await Ge(p,!0);else throw new Error("Invalid JSON")}catch(p){w("ไฟล์ JSON ไม่ถูก","error"),console.error(p)}},d.readAsText(i),l.target.value=null}),document.querySelector(m.exportBtn)?.addEventListener("click",l=>{l.preventDefault(),t?.classList.remove("show"),n?.setAttribute("aria-expanded","false");try{const i=J(),d=JSON.stringify(i,null,4),c=new Blob([d],{type:"application/json"}),p=URL.createObjectURL(c),u=document.createElement("a"),f=new Date,g=`${f.getFullYear()}${(f.getMonth()+1).toString().padStart(2,"0")}${f.getDate().toString().padStart(2,"0")}`,y=`${f.getHours().toString().padStart(2,"0")}${f.getMinutes().toString().padStart(2,"0")}`,h=ot(i.customer_name||"data");u.href=p,u.download=`MTR-${g}${y}-${h}.json`,u.click(),URL.revokeObjectURL(p),w("Export สำเร็จ","success")}catch{w("Export ล้มเหลว","error")}}),document.querySelector("#importFavsBtn")?.addEventListener("click",l=>{l.preventDefault(),t?.classList.remove("show"),n?.setAttribute("aria-expanded","false"),s?.click()}),s?.addEventListener("change",l=>{const i=l.target.files?.[0];if(!i)return;const d=new FileReader;d.onload=c=>{try{const p=JSON.parse(c.target.result),u=Oe(p);u>0?w(`เพิ่ม ${u} รายการ`,"success"):w("ไม่พบรายการใหม่","default")}catch{w("ไฟล์ JSON ไม่ถูก","error")}},d.readAsText(i),l.target.value=null}),document.querySelector("#exportFavsBtn")?.addEventListener("click",l=>{l.preventDefault(),t?.classList.remove("show"),n?.setAttribute("aria-expanded","false");try{const i=ce();if(Object.values(i).every(g=>g.length===0)){w("ไม่มีรายการ","warning");return}const d=JSON.stringify(i,null,4),c=new Blob([d],{type:"application/json"}),p=URL.createObjectURL(c),u=document.createElement("a"),f=new Date().toISOString().slice(0,10).replace(/-/g,"");u.href=p,u.download=`MTR-Favorites-${f}.json`,u.click(),URL.revokeObjectURL(p),w("Export สำเร็จ","success")}catch{w("Export ล้มเหลว","error")}}),document.querySelector(m.clearItemsBtn)?.addEventListener("click",async l=>{if(l.preventDefault(),t?.classList.remove("show"),n?.setAttribute("aria-expanded","false"),await re("ล้างทุกรายการ","?")){se(J()),ee(),document.querySelectorAll(m.room).forEach(c=>{c.getItemsContainer().innerHTML=""});const i=document.querySelector("#discount_type"),d=document.querySelector("#discount_value");i&&(i.value="amount"),d&&(d.value="0"),ae(),Y(),w("ล้างแล้ว","success")}}),document.querySelector(m.clearAllBtn)?.addEventListener("click",async l=>{if(l.preventDefault(),t?.classList.remove("show"),n?.setAttribute("aria-expanded","false"),await re("ลบข้อมูลทั้งหมด","คำเตือน! ข้อมูลทั้งหมดรวมถึงรายการโปรดจะถูกลบถาวร ยืนยันหรือไม่?")){const i=document.querySelector(m.roomsContainer);i&&(i.innerHTML=""),localStorage.removeItem(ge),vt(),w("ลบข้อมูลทั้งหมดแล้ว กำลังรีโหลด...","success"),setTimeout(()=>window.location.reload(),500)}}),document.querySelector("#roomDefaultsConfirmBtn")?.addEventListener("click",jt),window.addEventListener("click",l=>{l.target.closest(".menu-container")||(t?.classList.remove("show"),o?.classList.remove("show"),n?.setAttribute("aria-expanded","false"),r?.setAttribute("aria-expanded","false")),l.target.closest(".room-options-container")||document.querySelectorAll(".room-options-menu.show").forEach(d=>d.classList.remove("show"));const i=l.target.closest(".item-card");document.querySelectorAll(".item-details-more.show").forEach(d=>{const c=d.closest(".item-card");c!==i&&Me(c,!1)})}),window.addEventListener("beforeunload",z),document.querySelector("#forceApplySelectTypeBtn")?.addEventListener("click",async l=>{if(l.preventDefault(),Z){w("ฟอร์มถูกล็อคอยู่","warning");return}const i=document.querySelector("#forceApplyTypeModal");if(!i)return;const d=document.querySelector('#forceApplyModal [name="force_apply_type_hidden"]')?.value;let c=i.querySelector(`input[name="force_apply_type_option"][value="${d}"]`);c||(c=i.querySelector('input[name="force_apply_type_option"]')),c&&(c.checked=!0);const p=await H("#forceApplyTypeModal");if(p&&!p.cancelled){const u=i.querySelector('input[name="force_apply_type_option"]:checked');if(u){const f=u.value,g=document.querySelector("#forceApplyModal"),y=g?.querySelector('[name="force_apply_type_hidden"]'),h=g?.querySelector("#forceApplySelectedTypeDisplay"),b=g?.querySelector('[name="force_apply_code"]'),T=b?.closest(".form-group-with-favorites")?.querySelector(".btn-show-favs"),C=u.closest("label")?.querySelector("strong"),v=C?C.textContent.trim():f;y&&(y.value=f),h&&(h.textContent=v),b&&(b.dataset.favoriteType=f,b.focus()),T&&(T.disabled=!1)}}})}}function so(){const e=document.querySelector(m.setTpl);if(!e)return;const a=e.content.querySelector(m.setPricePerMSelect),s=e.content.querySelector(m.setSheerPricePerMSelect),t=e.content.querySelector(m.setLouisPricePerMSelect),o=n=>{let r='<option value="" hidden>เลือกราคา</option>';return Array.isArray(n)?(n.forEach(l=>{r+=`<option value="${l}">${l.toLocaleString("th-TH")}</option>`}),r):(console.error("Price data for dropdown is not available or not an array.",n),r)};a&&(a.innerHTML=o(be.fabric)),s&&(s.innerHTML=o(be.sheer)),t&&(t.innerHTML=o(be.louis))}function lo(){so(),st(),no();try{const e=localStorage.getItem(ge);if(e&&e!=="null"&&e!=="{}"){const a=JSON.parse(e);if(a&&Array.isArray(a.rooms))Ge(a,!1);else{console.warn("Stored data structure seems invalid, starting fresh."),localStorage.removeItem(ge),he();const s=document.querySelector(m.customerCard);s&&(s.open=!0)}}else{he();const a=document.querySelector(m.customerCard);a&&(a.open=!0)}}catch(e){console.error("Failed to load or parse data from localStorage:",e),localStorage.removeItem(ge),he();const a=document.querySelector(m.customerCard);a&&(a.open=!0)}Y(),it(),ne(),$e(),ee(),console.log("Marnthara App Initialized (Vite Refactor)")}document.addEventListener("DOMContentLoaded",lo);
