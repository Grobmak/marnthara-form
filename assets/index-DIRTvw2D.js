(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))r(a);new MutationObserver(a=>{for(const s of a)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&r(o)}).observe(document,{childList:!0,subtree:!0});function n(a){const s={};return a.integrity&&(s.integrity=a.integrity),a.referrerPolicy&&(s.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?s.credentials="include":a.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(a){if(a.ep)return;a.ep=!0;const s=n(a);fetch(a.href,s)}})();const pt="input-ui/5.7.0",ft="https://your-make-webhook-url.com/your-unique-path",ge="marnthara.input.v5",ht=500,P={name:"ม่านธารา ผ้าม่านและของตกแต่ง",address:"65/8 หมู่ 2 ต.ท่าศาลา อ.เมือง จ.ลพบุรี 15000",phone:"092-985-9395, 082-552-5595",taxId:"1234567890123",logoUrl:"./assets/logo.png",baseVatRate:.07,pdf:{paymentTerms:"ชำระมัดจำ 50%",priceValidity:"30 วัน",notes:["ราคานี้รวมค่าติดตั้งแล้ว","ชำระมัดจำ 50% เพื่อยืนยันการสั่งผลิตสินค้า","ใบเสนอราคานี้มีอายุ 30 วัน นับจากวันที่เสนอราคา"]}},yt=1.19599,xe={ROLL_WIDTH_M:.53,ROLL_LENGTH_M:10,STRIPS_PER_ROLL_UNDER_2_5M:3},Se={fabric:[1e3,1100,1200,1300,1400,1500,1600,1700,1800,1900,2e3,2100,2200],sheer:[1e3,1100,1200,1300,1400,1500],style_surcharge:{ลอน:200,ตาไก่:0,จีบ:0},height:[{threshold:3.2,add_per_m:300},{threshold:2.8,add_per_m:200},{threshold:2.5,add_per_m:100}]},b={orderForm:"#orderForm",roomsContainer:"#rooms",setTpl:"#setTpl",wallTpl:"#wallTpl",clearAllBtn:"#clearAllBtn",lockBtn:"#lockBtn",grandTotal:"#grandTotal",modal:"#confirmationModal",modalTitle:"#modalTitle",modalBody:"#modalBody",room:"[data-room]",allItemsContainer:"[data-all-items]",wallsContainer:"[data-walls-container]",sheerWrap:"[data-sheer-wrap]",sheerCodeWrap:"[data-sheer-code-wrap]",roomNameInput:'input[name="room_name"]',toastContainer:"#toast-container",copyTextBtn:"#copyTextBtn",copyOptionsModal:"#copyOptionsModal",menuBtn:"#menuBtn",menuDropdown:"#menuDropdown",importBtn:"#importBtn",exportBtn:"#exportBtn",fileImporter:"#fileImporter",submitBtn:"#submitBtn",clearItemsBtn:"#clearItemsBtn",exportPdfBtn:"#exportPdfBtn",exportOptionsModal:"#exportOptionsModal",printableContent:"#printable-content",quickNavBtn:"#quickNavBtn",quickNavDropdown:"#quickNavDropdown",quickNavRoomList:"#quickNavRoomList",toggleAllRoomsBtn:"#toggleAllRoomsBtn"},g=e=>{typeof e=="string"&&(e=e.replace(/,/g,""));const t=parseFloat(e);return Number.isFinite(t)?t:0},te=e=>{const t=g(e);return t>0?t.toFixed(2):""},U=(e,t=2,n=!1)=>Number.isFinite(e)?e.toLocaleString("en-US",{minimumFractionDigits:n?2:t,maximumFractionDigits:n?2:t}):"0",M=(e,t=0)=>Number.isFinite(e)?e.toLocaleString("th-TH",{minimumFractionDigits:t,maximumFractionDigits:t}):"0",vt=(e,t=150)=>{let n;return(...r)=>{clearTimeout(n),n=setTimeout(()=>e(...r),t)}},gt=(e,t=700)=>{let n=!1;return(...r)=>{if(!n){n=!0;try{return e(...r)}finally{setTimeout(()=>{n=!1},t)}}}},L=e=>typeof e!="string"?"":e.replace(/[&<>"']/g,function(t){switch(t){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";default:return"&#039;"}}),Ze=e=>typeof e!="string"?"":e.replace(/[\\/?%*:|"<>\x00-\x1f]/g,"").trim()||"file";function _t(e){let t=g(e);if(isNaN(t))return"ข้อมูลตัวเลขไม่ถูกต้อง";if(t===0)return"ศูนย์บาทถ้วน";const n=["","หนึ่ง","สอง","สาม","สี่","ห้า","หก","เจ็ด","แปด","เก้า"],r=["","สิบ","ร้อย","พัน","หมื่น","แสน","ล้าน"];let a=Math.floor(t),s=Math.round((t-a)*100);const o=i=>{if(i===0)return"";let d="";const u=String(i);for(let c=0;c<u.length;c++){const f=u[c];u.length-1;const h=u.length-c-1;f!=="0"&&(h===1&&f==="1"?d+=r[h]:h===1&&f==="2"?d+="ยี่"+r[h]:h===0&&f==="1"&&u.length>1?d+="เอ็ด":d+=n[parseInt(f)]+r[h])}return d};let l="";if(a>0){const i=Math.floor(a/1e6),d=a%1e6;i>0&&(l+=o(i)+"ล้าน"),l+=o(d),l+="บาท"}let m="";return s>0?m=o(s)+"สตางค์":l+="ถ้วน",(l+m).trim()}const Fe="marnthara.favorites.v4",_e={fabric:[],sheer:[],wallpaper:[],wooden_blind:[],roller_blind:[],vertical_blind:[],partition:[],pleated_screen:[],aluminum_blind:[]};function Z(){try{const e=localStorage.getItem(Fe);return e?{..._e,...JSON.parse(e)}:_e}catch(e){return console.error("Failed to parse favorites from localStorage",e),_e}}function we(e){try{localStorage.setItem(Fe,JSON.stringify(e))}catch(t){console.error("Failed to save favorites to localStorage",t)}}function Ge(e){if(!e||typeof e!="object")return console.error("Invalid favorites data for import."),!1;const t={..._e,...e};return we(t),!0}function et(e){if(!e||typeof e!="object")return console.error("Invalid favorites data for merge."),0;const t=Z();let n=0;for(const r in e)Object.hasOwnProperty.call(e,r)&&Array.isArray(e[r])&&(t[r]||(t[r]=[]),e[r].forEach(a=>{!t[r].some(o=>o.code===a.code)&&a.code&&(t[r].push(a),n++)}),t[r].sort((a,s)=>a.code.localeCompare(s.code)));return n>0&&we(t),n}function bt(e,t,n){const r=Z();r[e]||(r[e]=[]);const a=r[e],s=a.find(o=>o.code===t);return s?s.price=n:a.push({code:t,price:n}),a.sort((o,l)=>o.code.localeCompare(l.code)),we(r),!0}function Ie(e,t){const n=Z();if(!n[e])return!1;const r=n[e].findIndex(a=>a.code===t);return r>-1?(n[e].splice(r,1),we(n),!0):!1}function tt(e,t){if(!e||!t)return;const n=Z(),r=t.trim();return(n[e]||[]).find(s=>s.code===r)}function rt(e,t){return!!tt(e,t)}function ke(e,t,n){return rt(e,t)?(Ie(e,t),!1):(bt(e,t,n),!0)}function St(){localStorage.removeItem(Fe),console.log("All favorites have been cleared.")}function j(){var n,r,a,s,o,l;const e=Z(),t={app_version:pt,customer_name:((n=document.querySelector('[name="customer_name"]'))==null?void 0:n.value)||"",customer_phone:((r=document.querySelector('[name="customer_phone"]'))==null?void 0:r.value)||"",customer_address:((a=document.querySelector('[name="customer_address"]'))==null?void 0:a.value)||"",customer_card_open:(s=document.querySelector("#customerDetailsCard"))==null?void 0:s.open,discount:{type:((o=document.querySelector("#discount_type"))==null?void 0:o.value)||"amount",value:g((l=document.querySelector("#discount_value"))==null?void 0:l.value)},rooms:[],favorites:e};return document.querySelectorAll(b.room).forEach(m=>{var d,u;const i={id:m.id,room_name:((d=m.querySelector(b.roomNameInput))==null?void 0:d.value)||"",is_suspended:m.classList.contains("is-suspended"),is_open:m.open,items:[]};(u=m.querySelector(b.allItemsContainer))==null||u.childNodes.forEach(c=>{var p,y,_,v,S,w,q,E,$,k,I,T,C,N,R,A,O,J,ae,D,he,He,je,We,De,Ue,Ve;if(c.nodeType!==1||!c.matches(".item-card"))return;const f=c.dataset.type;if(!f)return;let h={type:f,is_suspended:c.classList.contains("is-suspended")};f==="set"?Object.assign(h,{width_m:g((p=c.querySelector('input[name="width_m"]'))==null?void 0:p.value),height_m:g((y=c.querySelector('input[name="height_m"]'))==null?void 0:y.value),style:((_=c.querySelector('select[name="set_style"]'))==null?void 0:_.value)||"",fabric_variant:((v=c.querySelector('select[name="fabric_variant"]'))==null?void 0:v.value)||"",price_per_m_raw:g((S=c.querySelector('select[name="set_price_per_m"]'))==null?void 0:S.value),sheer_price_per_m:g((w=c.querySelector('select[name="sheer_price_per_m"]'))==null?void 0:w.value),fabric_code:((q=c.querySelector('input[name="fabric_code"]'))==null?void 0:q.value)||"",sheer_fabric_code:((E=c.querySelector('input[name="sheer_fabric_code"]'))==null?void 0:E.value)||"",opening_style:(($=c.querySelector('select[name="opening_style"]'))==null?void 0:$.value)||"",adjustment_side:((k=c.querySelector('select[name="adjustment_side"]'))==null?void 0:k.value)||"ปรับขวา",track_color:((I=c.querySelector('input[name="track_color"]'))==null?void 0:I.value)||"ขาว",bracket_color:((T=c.querySelector('input[name="bracket_color"]'))==null?void 0:T.value)||"ขาว",finial_color:((C=c.querySelector('input[name="finial_color"]'))==null?void 0:C.value)||"ขาว",grommet_color:((N=c.querySelector('input[name="grommet_color"]'))==null?void 0:N.value)||"เงิน",notes:((R=c.querySelector('input[name="notes"]'))==null?void 0:R.value)||""}):f==="wallpaper"?Object.assign(h,{height_m:g((A=c.querySelector('[name="wallpaper_height_m"]'))==null?void 0:A.value),wallpaper_code:((O=c.querySelector('[name="wallpaper_code"]'))==null?void 0:O.value)||"",price_per_roll:g((J=c.querySelector('[name="wallpaper_price_roll"]'))==null?void 0:J.value),install_cost_per_roll:g((ae=c.querySelector('[name="wallpaper_install_cost"]'))==null?void 0:ae.value),notes:((D=c.querySelector('[name="wallpaper_notes"]'))==null?void 0:D.value)||"",widths:Array.from(c.querySelectorAll('[name="wall_width_m"]')).map(mt=>g(mt.value))}):c.matches(".area-based-item")&&(Object.assign(h,{width_m:g((he=c.querySelector('[name="area_width_m"]'))==null?void 0:he.value),height_m:g((He=c.querySelector('[name="area_height_m"]'))==null?void 0:He.value),price_sqyd:g((je=c.querySelector('[name="area_price_sqyd"]'))==null?void 0:je.value),code:((We=c.querySelector('[name="area_code"]'))==null?void 0:We.value)||"",notes:((De=c.querySelector('[name="area_notes"]'))==null?void 0:De.value)||""}),(f==="partition"||f==="pleated_screen")&&(h.opening_style=((Ue=c.querySelector('select[name="opening_style"]'))==null?void 0:Ue.value)||"แยกกลาง"),["wooden_blind","roller_blind","vertical_blind","aluminum_blind"].includes(f)&&(h.adjustment_side=((Ve=c.querySelector('select[name="adjustment_side"]'))==null?void 0:Ve.value)||"ปรับขวา")),i.items.push(h)}),t.rooms.push(i)}),t}function F(){try{localStorage.setItem(ge,JSON.stringify(j()))}catch(e){console.error("Failed to save data to localStorage:",e)}}const B={stylePlus:e=>Se.style_surcharge[e]??0,heightPlus:e=>{const t=[...Se.height].sort((n,r)=>r.threshold-n.threshold);for(const n of t)if(e>n.threshold)return n.add_per_m;return 0},fabricYardage:(e,t)=>{const n=g(t);return n<=0||!e?0:e==="ตาไก่"||e==="จีบ"?(n*2+.6)/.9:e==="ลอน"?(n*2.6+.6)/.9:e==="ม่านพับ"?(n+.3)/.9:0},calculateGrommets:function(e){if(!e||e.style!=="ตาไก่"||g(e.width_m)<=0)return 0;const t=g(e.width_m),n=2,r=.05,a=.16;let s;e.opening_style==="แยกกลาง"?s=t/2:s=t;const o=s*n+2*r;let l=Math.round(o/a);return l%2!==0&&(l+=1),l<4&&(l=4),e.opening_style==="แยกกลาง"?l*2:l},wallpaperRolls:(e,t)=>{const n=g(e),r=g(t);if(n<=0||r<=0)return 0;const a=r>2.5?Math.floor(xe.ROLL_LENGTH_M/r):xe.STRIPS_PER_ROLL_UNDER_2_5M;if(a<=0)return 0;const s=Math.ceil(n/xe.ROLL_WIDTH_M);return Math.ceil(s/a)},calculateSetPrice:function(e){var o,l;if(!e||e.is_suspended||g(e.width_m)<=0)return{total:0,opaque:0,sheer:0};const t=this.stylePlus(e.style),n=this.heightPlus(g(e.height_m)),r=g(e.width_m),a=(o=e.fabric_variant)!=null&&o.includes("ทึบ")&&g(e.price_per_m_raw)>0?(g(e.price_per_m_raw)+t+n)*r:0,s=(l=e.fabric_variant)!=null&&l.includes("โปร่ง")&&g(e.sheer_price_per_m)>0?(g(e.sheer_price_per_m)+t+n)*r:0;return{total:Math.round(a+s),opaque:Math.round(a),sheer:Math.round(s)}},calculateDecoPrice:function(e){if(!e||e.is_suspended||g(e.width_m)<=0||g(e.height_m)<=0)return{total:0,sqm:0,sqyd:0};const t=g(e.width_m)*g(e.height_m),n=t*yt,r=n*g(e.price_sqyd);return{total:Math.round(r),sqm:t,sqyd:n}},calculateWallpaperPrice:function(e){var o;if(!e||e.is_suspended)return{total:0,material:0,install:0,rolls:0,sqm:0};const t=((o=e.widths)==null?void 0:o.reduce((l,m)=>l+g(m),0))||0;if(t<=0)return{total:0,material:0,install:0,rolls:0,sqm:0};const n=g(e.height_m),r=this.wallpaperRolls(t,n),a=r*g(e.price_per_roll),s=r*g(e.install_cost_per_roll??300);return{total:Math.round(a+s),material:Math.round(a),install:Math.round(s),rolls:r,sqm:t*n}}},re={set:"ผ้าม่าน",wallpaper:"วอลล์เปเปอร์",wooden_blind:"มู่ลี่ไม้",roller_blind:"ม่านม้วน",vertical_blind:"ม่านปรับแสง",partition:"ฉากกั้นห้อง",pleated_screen:"มุ้งจีบ",aluminum_blind:"มู่ลี่อลูมิเนียม"};function ne(e){const{width:t=0,height:n=0}=e,r=15,a=100-r*2,s=100-r*2,o=t>0&&n>0?Math.min(a/t,s/n):1,l=t*o,m=n*o,i=(100-l)/2,d=(100-m)/2,u=`
        <line x1="${i}" y1="${d+m+5}" x2="${i+l}" y2="${d+m+5}" class="dimension-line" />
        <line x1="${i}" y1="${d+m+3}" x2="${i}" y2="${d+m+7}" class="dimension-tick" />
        <line x1="${i+l}" y1="${d+m+3}" x2="${i+l}" y2="${d+m+7}" class="dimension-tick" />
        <text x="50" y="${d+m+14}" class="dimension-text">${t.toFixed(2)} ม.</text>

        <line x1="${i-5}" y1="${d}" x2="${i-5}" y2="${d+m}" class="dimension-line" />
        <line x1="${i-7}" y1="${d}" x2="${i-3}" y2="${d}" class="dimension-tick" />
        <line x1="${i-7}" y1="${d+m}" x2="${i-3}" y2="${d+m}" class="dimension-tick" />
        <text x="${i-9}" y="50" class="dimension-text" transform="rotate(-90, ${i-9}, 50)">${n.toFixed(2)} ม.</text>
    `;return{x:i,y:d,svgWidth:l,svgHeight:m,lines:u}}function ot(e,{y:t,svgHeight:n}){if(!e.opening_style)return"";const r=e.opening_style==="แยกกลาง"?"< >":"→";return`
        <rect x="40" y="${t+n/2-8}" width="20" height="16" rx="3" class="opening-text-bg" />
        <text x="50" y="${t+n/2+1}" class="opening-text">${r}</text>
    `}function qe(e,{x:t,y:n,svgWidth:r}){if(!e.adjustment_side)return"";const s=e.adjustment_side==="ปรับซ้าย"?t+8:t+r-8;return`
        <g class="adjustment-cord">
            <circle cx="${s}" cy="${n+3}" r="2"/>
            <line x1="${s}" y1="${n+5}" x2="${s}" y2="${n+15}"/>
        </g>
    `}function wt(e){const t=g(e.width_m),n=g(e.height_m);if(t<=0||n<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:r,y:a,svgWidth:s,svgHeight:o,lines:l}=ne({width:t,height:n});let m="";const i=e.fabric_variant.includes("โปร่ง"),d=e.fabric_variant.includes("ทึบ"),u=(h,p)=>(e.opening_style||"แยกกลาง")==="แยกกลาง"?`
                <rect x="${r}" y="${a+p}" width="${s/2-1}" height="${o}" class="${h}" />
                <rect x="${r+s/2+1}" y="${a+p}" width="${s/2-1}" height="${o}" class="${h}" />
            `:`<rect x="${r}" y="${a+p}" width="${s}" height="${o}" class="${h}" />`;i&&(m+=u("curtain-panel-sheer",0)),d&&(m+=u("curtain-panel-opaque",i?-2:0));let c="";if(e.style==="ตาไก่"){const h=Math.max(8,Math.floor(s/8));for(let p=0;p<h;p++){const y=r+s/(h-1)*p;c+=`<circle cx="${y}" cy="${a}" r="2" class="style-grommet" />`}}else if(e.style==="ลอน"){const h=Math.max(4,Math.floor(s/10));let p=`M ${r},${a}`;for(let y=0;y<h;y++)p+=" q 5,-4 10,0";c=`<path d="${p}" class="style-ripplefold-path" />`}else e.style==="จีบ"&&(c=`<text x="${r+2}" y="${a+5}" class="style-pleat-text">||| ||| ||| ||| |||</text>`);const f=ot(e,{y:a,svgHeight:o});return`<svg viewBox="0 0 100 100">${m}${c}${f}${l}</svg>`}function qt(e){const t=g(e.width_m),n=g(e.height_m);if(t<=0||n<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:r,y:a,svgWidth:s,svgHeight:o,lines:l}=ne({width:t,height:n});let m=`<rect x="${r}" y="${a}" width="${s}" height="${o}" class="blind-frame" />`;const i=5,d=o/i;for(let c=0;c<i;c++)m+=`<rect x="${r}" y="${a+c*d}" width="${s}" height="${d-1.5}" class="blind-slat" />`;const u=qe(e,{x:r,y:a,svgWidth:s});return`<svg viewBox="0 0 100 100">${m}${l}${u}</svg>`}function Ye(e,t=!1){const n=g(e.width_m),r=g(e.height_m);if(n<=0||r<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:a,y:s,svgWidth:o,svgHeight:l,lines:m}=ne({width:n,height:r});let i=`<rect x="${a}" y="${s}" width="${o}" height="${l}" class="blind-frame" />`;if(t){const u=Math.max(4,Math.floor(o/8)),c=o/u;for(let f=0;f<u;f++)i+=`<rect x="${a+f*c+1}" y="${s}" width="${c-2}" height="${l}" class="blind-slat" />`}else{const u=Math.max(3,Math.floor(l/10)),c=l/u;for(let f=0;f<u;f++)i+=`<rect x="${a}" y="${s+f*c+.5}" width="${o}" height="${c-1}" class="blind-slat" />`}const d=qe(e,{x:a,y:s,svgWidth:o});return`<svg viewBox="0 0 100 100">${i}${m}${d}</svg>`}function $t(e){const t=g(e.width_m),n=g(e.height_m);if(t<=0||n<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:r,y:a,svgWidth:s,svgHeight:o,lines:l}=ne({width:t,height:n});let m=`<rect x="${r}" y="${a}" width="${s}" height="${o}" class="blind-frame" />`;const i=Math.max(3,Math.floor(o/8)),d=o/i;for(let y=0;y<i;y++)m+=`<rect x="${r+1}" y="${a+y*d}" width="${s-2}" height="${d-1.5}" rx="0.5" class="wooden-blind-slat" />`;const u=Math.max(2,s*.05),c=r+s*.25-u/2,f=r+s*.75-u/2,h=`
        <rect x="${c}" y="${a}" width="${u}" height="${o}" class="wooden-blind-strip" />
        <rect x="${f}" y="${a}" width="${u}" height="${o}" class="wooden-blind-strip" />
    `,p=qe(e,{x:r,y:a,svgWidth:s});return`<svg viewBox="0 0 100 100">${m}${h}${l}${p}</svg>`}function xt(e){const t=g(e.width_m),n=g(e.height_m);if(t<=0||n<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:r,y:a,svgWidth:s,svgHeight:o,lines:l}=ne({width:t,height:n}),m=`
        <rect x="${r}" y="${a}" width="${s}" height="${o}" class="roller-fabric" />
        <rect x="${r-1}" y="${a-4}" width="${s+2}" height="5" rx="2" class="roller-roll" />
        <line x1="${r}" y1="${a+o}" x2="${r+s}" y2="${a+o}" class="roller-bar" />
    `,i=qe(e,{x:r,y:a-2,svgWidth:s});return`<svg viewBox="0 0 100 100">${m}${l}${i}</svg>`}function Je(e,t=!1){const n=g(e.width_m),r=g(e.height_m);if(n<=0||r<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:a,y:s,svgWidth:o,svgHeight:l,lines:m}=ne({width:n,height:r});let i="";if(t)i=`
            <defs>
                <pattern id="pleated-mesh" width="6" height="6" patternUnits="userSpaceOnUse">
                    <path d="M -1 1 L 1 -1 M 0 6 L 6 0" class="pleated-screen-mesh" />
                </pattern>
            </defs>
            <rect x="${a}" y="${s}" width="${o}" height="${l}" class="blind-frame" />
            <rect x="${a}" y="${s}" width="${o}" height="${l}" fill="url(#pleated-mesh)" />
        `;else{const c=o/4;for(let f=0;f<4;f++)i+=`<rect x="${a+f*c}" y="${s}" width="${c}" height="${l}" class="partition-panel" />`,f>0&&(i+=`<line x1="${a+f*c}" y1="${s}" x2="${a+f*c}" y2="${s+l}" class="partition-hinge" />`)}const d=ot(e,{y:s,svgHeight:l});return`<svg viewBox="0 0 100 100">${i}${d}${m}</svg>`}function kt(e){const t=(e.widths||[]).reduce((c,f)=>c+g(f),0),n=g(e.height_m);if(t<=0||n<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:r,y:a,svgWidth:s,svgHeight:o,lines:l}=ne({width:t,height:n});let m="";const i=Math.floor(s/10),d=Math.floor(o/10);for(let c=0;c<d;c++)for(let f=0;f<i;f++)m+=`<circle cx="${r+f*10+5}" cy="${a+c*10+5}" r="1.5" class="wallpaper-pattern" />`;return`<svg viewBox="0 0 100 100">${`<rect x="${r}" y="${a}" width="${s}" height="${o}" class="blind-frame" /> ${m}`}${l}</svg>`}function Lt(e,t,n){let r="";switch(e.type){case"set":e.style==="ม่านพับ"?r=qt(e):r=wt(e);break;case"wooden_blind":r=$t(e);break;case"aluminum_blind":r=Ye(e,!1);break;case"vertical_blind":r=Ye(e,!0);break;case"roller_blind":r=xt(e);break;case"partition":r=Je(e,!1);break;case"pleated_screen":r=Je(e,!0);break;case"wallpaper":r=kt(e);break;default:const a=re[e.type]||"ของตกแต่ง";r=`<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">${L(a)}</text></svg>`;break}return`<div class="visual-placeholder is-clickable" 
                 data-act="jump-to-item" 
                 data-room-id="${t}" 
                 data-item-index="${n}" 
                 title="คลิกเพื่อไปยังรายการนี้">${r}</div>`}function Ke(e){let t=`
📃 *สรุปรายการสินค้า*
`,n=!1;return e.rooms.forEach(r=>{if(r.is_suspended||!r.items)return;const a=r.items.filter(o=>o.is_suspended?!1:o.type==="wallpaper"?(o.widths||[]).reduce((l,m)=>l+g(m),0)>0:g(o.width_m)>0);if(a.length===0)return;n=!0,t+=`
*🚪 ห้อง: ${r.room_name||"ไม่ระบุ"}*
`;let s=0;a.forEach(o=>{s++;const l=re[o.type]||"สินค้าตกแต่ง";o.type==="set"?t+=` ${s}) ${l} ${o.style} (${o.fabric_variant})
`:t+=` ${s}) ${l}
`})}),n?t+`------------------------------
`:""}function nt(e){return e.rooms.reduce((t,n)=>{var a;if(n.is_suspended)return t;const r=((a=n.items)==null?void 0:a.reduce((s,o)=>{if(o.is_suspended)return s;switch(o.type){case"set":return s+B.calculateSetPrice(o).total;case"wallpaper":return s+B.calculateWallpaperPrice(o).total;default:return s+B.calculateDecoPrice(o).total}},0))||0;return t+r},0)}function Tt(e,t){const n=nt(e);let r=0,a="";e.discount&&e.discount.value>0&&(e.discount.type==="percent"?(r=n*(e.discount.value/100),a=`🏷️ ส่วนลด (${e.discount.value}%): -${M(r)} บาท
`):(r=e.discount.value,a=`🏷️ ส่วนลด: -${M(r)} บาท
`));const s=n-r;let o=`🗓️ สรุปข้อมูล (${new Date().toLocaleDateString("th-TH",{day:"numeric",month:"short",year:"2-digit"})})
`;if(o+=`👤 ลูกค้า: ${e.customer_name||"-"}
`,(t==="customer"||t==="owner")&&(o+=`📞 โทร: ${e.customer_phone||"-"}
`,o+=`🏠 ที่อยู่: ${e.customer_address||"-"}
`),o+=`------------------------------
`,t==="customer")return o+=Ke(e),r>0&&(o+=`
ยอดรวม: ${M(n)} บาท
`,o+=a),o+=`
💰 *ยอดสุทธิ: ${M(s)} บาท*
`,o+=`
ขอบคุณที่ใช้บริการค่ะ
${P.name}
โทร: ${P.phone}`,o;if(t==="purchase_order"||t==="owner"){t==="owner"&&(o+=Ke(e));const l={opaqueFabrics:[],sheerFabrics:[],decorations:{},wallpapers:[],allSets:[]};e.rooms.forEach(_=>{_.is_suspended||!_.items||_.items.forEach(v=>{const S=v.type==="set"||v.type.includes("_blind")||v.type==="partition"||v.type==="pleated_screen";if(!(v.is_suspended||S&&g(v.width_m)<=0))switch(v.type){case"set":l.allSets.push(v),v.fabric_variant.includes("ทึบ")&&l.opaqueFabrics.push({code:v.fabric_code||"??",yards:B.fabricYardage(v.style,v.width_m)}),v.fabric_variant.includes("โปร่ง")&&l.sheerFabrics.push({code:v.sheer_fabric_code||"??",yards:B.fabricYardage(v.style,v.width_m)});break;case"wallpaper":const w=(v.widths||[]).reduce((E,$)=>E+g($),0);if(w>0){const E=B.wallpaperRolls(w,v.height_m);E>0&&l.wallpapers.push({code:v.wallpaper_code||"xxx",rolls:E})}break;default:const q=re[v.type]||v.type;l.decorations[q]||(l.decorations[q]=[]),l.decorations[q].push({code:v.code||"xxx",width:v.width_m,height:v.height_m,opening_style:v.opening_style,adjustment_side:v.adjustment_side});break}})});const m={};if([...l.opaqueFabrics,...l.sheerFabrics].forEach(_=>{m[_.code]=(m[_.code]||0)+_.yards}),Object.keys(m).length>0){o+=`✂️ *รายการสั่งซื้อ (ผ้า)*
`,o+=`------------------------------
`,l.opaqueFabrics.length>0&&l.opaqueFabrics.forEach(_=>{o+=`- ผ้าทึบ (Curtain)
`,o+=`  รหัส: #${_.code||"??"}
`,o+=`  จำนวน: ${_.yards.toFixed(2)} หลา

`}),l.sheerFabrics.length>0&&l.sheerFabrics.forEach(_=>{o+=`- ผ้าโปร่ง (Sheer)
`,o+=`  รหัส: #${_.code||"??"}
`,o+=`  จำนวน: ${_.yards.toFixed(2)} หลา

`}),o+=`------------------------------
`,o+=`📊 *สรุปยอดรวมผ้า (ตามรหัส)*
`,o+=`------------------------------
`;for(const[_,v]of Object.entries(m))o+=`  - รหัส #${_}: ${v.toFixed(2)} หลา
`;o+=`
`}const i=l.allSets.filter(_=>_.style==="ม่านพับ"),d=l.allSets.filter(_=>_.style==="ตาไก่"),u=l.allSets.filter(_=>_.style!=="ตาไก่"&&_.style!=="ม่านพับ");if(i.length>0){o+=`------------------------------
`,o+=`📏 *รายการสั่งซื้อ รางม่านพับ*
`,o+=`------------------------------

`;let _=1;i.forEach(v=>{o+=`(${_++}) รางม่านพับ
`,o+=`  - ขนาด: ${Number(v.width_m).toFixed(2)} ม.
`,o+=`  - สีราง: ${v.track_color}
`,o+=`  - เชือกปรับ: ${v.adjustment_side}
`,v.notes&&t==="owner"&&(o+=`  📝 หมายเหตุ: ${v.notes}
`),o+=`
`})}if(u.length>0){o+=`------------------------------
`,o+=`📏 *รายการสั่งซื้อ ราง (ลอน/จีบ)*
`,o+=`------------------------------

`;let _=1;u.forEach(q=>{o+=`(${_++}) ราง ${q.style}, สี: ${q.track_color}
`,q.fabric_variant.includes("ทึบ")&&(o+=`  - รางทึบ: ${Number(q.width_m).toFixed(2)} ม.
`),q.fabric_variant.includes("โปร่ง")&&(o+=`  - รางโปร่ง: ${Number(q.width_m).toFixed(2)} ม.
`),q.notes&&t==="owner"&&(o+=`  📝 หมายเหตุ: ${q.notes}
`),o+=`
`});const v=[];u.forEach(q=>{q.fabric_variant.includes("ทึบ")&&v.push(Number(q.width_m)),q.fabric_variant.includes("โปร่ง")&&v.push(Number(q.width_m))});const S=v.reduce((q,E)=>{const $=E.toFixed(2);return q[$]=(q[$]||0)+1,q},{}),w=Object.entries(S).sort((q,E)=>parseFloat(E[0])-parseFloat(q[0]));if(w.length>0){o+=`--- สรุปยอดรวมรางลอน/จีบ ---
`,o+=`*จำนวนรางที่ต้องตัด:*
`;for(const[q,E]of w)o+=`  - ขนาด ${q} ม. = ${E} เส้น
`;o+=`
`}}if(d.length>0){o+=`------------------------------
`,o+=`📏 *รายการสั่งซื้อ ราง (ตาไก่)*
`,o+=`------------------------------

`;let _=1;d.forEach($=>{o+=`(${_++}) ราง ${$.style}, สี: ${$.track_color}
`,$.fabric_variant.includes("ทึบ")&&(o+=`  - รางทึบ: ${Number($.width_m).toFixed(2)} ม.
`),$.fabric_variant.includes("โปร่ง")&&(o+=`  - รางโปร่ง: ${Number($.width_m).toFixed(2)} ม.
`),$.notes&&t==="owner"&&(o+=`  📝 หมายเหตุ: ${$.notes}
`),o+=`
`}),o+=`--- สรุปยอดรวมรางตาไก่ ---
`;const v=[];d.forEach($=>{$.fabric_variant.includes("ทึบ")&&v.push(Number($.width_m)),$.fabric_variant.includes("โปร่ง")&&v.push(Number($.width_m))});const S=6;v.sort(($,k)=>k-$);const w=[];for(const $ of v){let k=!1;for(let I=0;I<w.length;I++)if(w[I]>=$-.001){w[I]-=$,k=!0;break}k||w.push(S-$)}o+=`ใช้รางเต็ม (6 ม.) ทั้งหมด: *${w.length} เส้น*

`;const q=v.reduce(($,k)=>{const I=k.toFixed(2);return $[I]=($[I]||0)+1,$},{}),E=Object.entries(q).sort(($,k)=>parseFloat(k[0])-parseFloat($[0]));if(E.length>0){o+=`*สรุปจำนวนรางที่ต้องตัด:*
`;for(const[$,k]of E)o+=`  - ขนาด ${$} ม. = ${k} เส้น
`;o+=`
`}}const c={};l.allSets.forEach(_=>{const v=_.track_color||"ไม่ระบุ",S=_.style,w=_.fabric_variant==="ทึบ&โปร่ง",q=g(_.width_m)>=1.6?3:2;if(c[v]||(c[v]={brackets:{},finials:0,grommets:{}}),c[v].brackets[S]||(c[v].brackets[S]={single:0,double:0}),w?c[v].brackets[S].double+=q:c[v].brackets[S].single+=q,S==="ตาไก่"){const E=w?4:2;c[v].finials+=E}if(S==="ตาไก่"){const E=_.grommet_color||"เงิน",$=B.calculateGrommets(_);c[v].grommets[E]||(c[v].grommets[E]=0),c[v].grommets[E]+=$}});const f=l.allSets.filter(_=>_.style!=="ม่านพับ").length*2;if(Object.keys(c).length>0||f>0){o+=`------------------------------
`,o+=`🔩 *รายการสั่งซื้อ อุปกรณ์ (Hardware)*
`,o+=`------------------------------

`;for(const[_,v]of Object.entries(c)){let S=!1,w=`**สี${_}**
`;const q=Object.keys(v.brackets);q.length>0&&q.forEach($=>{const k=v.brackets[$];(k.single>0||k.double>0)&&(S=!0,w+=`  - ขาจับ (${$}):
`,k.single>0&&(w+=`    - ขาชั้นเดียว: ${k.single} ตัว
`),k.double>0&&(w+=`    - ขา2ชั้น: ${k.double} ตัว
`))}),v.finials>0&&(S=!0,w+=`  - หัวราง (ตาไก่): ${v.finials} ตัว
`);const E=Object.keys(v.grommets);E.length>0&&E.forEach($=>{const k=v.grommets[$];k>0&&(S=!0,w+=`  - ตาไก่ (สี${$}): ${k} ตัว
`)}),S&&(o+=w+`
`)}f>0&&(o+=`**อุปกรณ์รวม**
`,o+=`  - ตะขอรวบม่าน: ${f} ตัว

`)}const p=l.decorations;Object.keys(p).length>0&&Object.entries(p).forEach(([_,v])=>{o+=`------------------------------
`,o+=`📦 *รายการสั่งซื้อ ${_}*
`,o+=`------------------------------

`,v.forEach(S=>{o+=`- รหัส: #${S.code||"xxx"}
  ขนาด: ${S.width.toFixed(2)} x ${S.height.toFixed(2)} m.
`,S.opening_style&&(o+=`  รูปแบบเปิด: ${S.opening_style}
`),S.adjustment_side&&(o+=`  เชือกปรับ: ${S.adjustment_side}
`),o+=`
`})});const y={};if(l.wallpapers.forEach(_=>{y[_.code]=(y[_.code]||0)+_.rolls}),Object.keys(y).length>0){o+=`------------------------------
`,o+=`🎨 *รายการสั่งซื้อ (Wallpaper)*
`,o+=`------------------------------

`;for(const[_,v]of Object.entries(y))o+=`  - รหัส #${_}: ${v} ม้วน
`;o+=`
`}if(t==="purchase_order")return o+=`------------------------------
`,o}if(t==="seamstress"||t==="owner"){o+=`
🧵 *รายละเอียดสำหรับช่างเย็บผ้า*
`;let l=0;if(e.rooms.forEach(m=>{if(m.is_suspended||!m.items)return;const i=m.items.filter(d=>d.type==="set"&&!d.is_suspended&&g(d.width_m)>0);i.length!==0&&(l>0&&(o+=`==============================
`),o+=`
*🚪 ห้อง: ${m.room_name||"ไม่ระบุ"}*

`,i.forEach((d,u)=>{u>0&&(o+=`--------------------
`),o+=`*ชุดที่ ${u+1}/${i.length}: ${d.style} ${d.fabric_variant}*
`,d.style==="ม่านพับ"?o+=`  - เชือกปรับ: ${d.adjustment_side}
`:o+=`  - รูปแบบเปิด: ${d.opening_style}
`,d.fabric_variant.includes("ทึบ")&&(o+=`  - ผ้าทึบ: #${d.fabric_code||"-"}
`),d.fabric_variant.includes("โปร่ง")&&(o+=`  - ผ้าโปร่ง: #${d.sheer_fabric_code||"-"}
`),o+=`  - ขนาด: กว้าง ${Number(d.width_m).toFixed(2)} x สูง ${Number(d.height_m).toFixed(2)} ม.
`}),o+=`
`,l++)}),l>0?o+=`==============================
`:o+=`ไม่มีรายการสำหรับช่าง
------------------------------
`,t==="seamstress")return o}return t==="owner"&&(o+=`
💰 *สรุปยอดรวม: ${M(s)} บาท*
`),o}function Mt(e){if(!e.rooms||e.rooms.length===0)return'<p class="empty-summary">ไม่มีข้อมูลสำหรับแสดงผล</p>';let t="";const n={};e.rooms.forEach(o=>{o.is_suspended||!o.items||o.items.forEach(l=>{if(l.is_suspended)return;let m=null,i=0;switch(l.type){case"set":i=B.calculateSetPrice(l).total,i>0&&(m=l.type);break;case"wallpaper":i=B.calculateWallpaperPrice(l).total,i>0&&(m=l.type);break;default:i=B.calculateDecoPrice(l).total,i>0&&(m=l.type);break}m&&(n[m]=(n[m]||0)+1)})});const r=Object.entries(n).map(([o,l])=>{const m=re[o]||"ของตกแต่ง";return`
            <span class="summary-tag" data-filter-type="${L(o)}" title="คลิกเพื่อกรองเฉพาะรายการนี้">
                ${L(m)} <strong>${l}</strong>
            </span>`}).join("");r&&(t+=`
            <div class="overview-summary-group">
                <h4><i class="ph ph-stack"></i> สรุปประเภทรายการ</h4>
                <div class="summary-tags-container">
                    ${r}
                </div>
            </div>`);let a="",s=0;return e.rooms.forEach(o=>{if(o.is_suspended||!o.items)return;const l={};let m=0;if(o.items.forEach(i=>{if(i.is_suspended)return;let d=null,u=0;switch(i.type){case"set":u=B.calculateSetPrice(i).total,u>0&&(d=i.type);break;case"wallpaper":u=B.calculateWallpaperPrice(i).total,u>0&&(d=i.type);break;default:u=B.calculateDecoPrice(i).total,u>0&&(d=i.type);break}d&&(l[d]=(l[d]||0)+1,m++)}),m>0){s+=m;const i=Object.entries(l).map(([d,u])=>`
                    <div class="overview-item">
                        <span>${L(re[d]||"ของตกแต่ง")}</span>
                        <span>${u}</span>
                    </div>`).join("");a+=`
                <details class="overview-room-card">
                    <summary class="overview-room-summary">
                        <span class="room-name">${L(o.room_name)||"ไม่ระบุชื่อห้อง"}</span>
                        <div class="summary-tags">
                            <span class="room-item-count">${m} รายการ</span>
                            <i class="ph ph-caret-down expand-icon"></i>
                        </div>
                    </summary>
                    <div class="overview-room-items">${i}</div>
                </details>`}}),a&&(t+=`
            <div class="overview-breakdown-group">
                <h4><i class="ph ph-map-pin-line"></i> แจกแจงตามห้อง</h4>
                ${a}
            </div>`),s===0?'<p class="empty-summary">ไม่มีข้อมูลสำหรับแสดงผล</p>':t}function Et(e,t){const{vatRate:n,pageBreakBuffer:r=3}=t,a=[];e.rooms.forEach(k=>{if(k.is_suspended||!k.items)return;const I=[];k.items.forEach(T=>{if(T.is_suspended)return;let C,N,R,A;const O=re[T.type]||"สินค้าตกแต่ง";switch(T.type){case"set":N=B.calculateSetPrice(T).total,N>0&&(R=g(T.width_m),A=g(T.height_m),C=`${O} ${L(T.style)} (${L(T.fabric_variant)}) <br><small>ขนาด ${R.toFixed(2)} x ${A.toFixed(2)} ม.${T.notes?` - ${L(T.notes)}`:""}</small>`,I.push({description:C,total:N,units:C.includes("<br>")?1.5:1}));break;case"wallpaper":if(N=B.calculateWallpaperPrice(T).total,N>0){const J=(T.widths||[]).reduce((D,he)=>D+g(he),0),ae=B.wallpaperRolls(J,T.height_m);A=g(T.height_m),C=`${O} <br><small>รหัส: ${L(T.wallpaper_code)||"-"}, สูง ${A.toFixed(2)} ม. (ใช้ ${ae} ม้วน)</small>`,I.push({description:C,total:N,units:C.includes("<br>")?1.5:1})}break;default:N=B.calculateDecoPrice(T).total,N>0&&(R=g(T.width_m),A=g(T.height_m),C=`${O} <br><small>รหัส: ${L(T.code)||"-"}, ขนาด ${R.toFixed(2)} x ${A.toFixed(2)} ม.</small>`,I.push({description:C,total:N,units:C.includes("<br>")?1.5:1}));break}}),I.length>0&&(a.push({isRoomHeader:!0,roomName:L(k.room_name)||"ไม่ระบุชื่อห้อง",units:1.2}),a.push(...I))});const s=a.reduce((k,I)=>k+(I.total||0),0);if(s===0)return null;let o=0,l="",m=s;e.discount&&e.discount.value>0&&(e.discount.type==="percent"?(o=s*(e.discount.value/100),l=`<tr><td class="pdf-label">ส่วนลด (${e.discount.value}%)</td><td class="pdf-amount">-${U(o,2,!0)}</td></tr>`):(o=e.discount.value,l=`<tr><td class="pdf-label">ส่วนลด</td><td class="pdf-amount">-${U(o,2,!0)}</td></tr>`),m=s-o,l+=`<tr><td class="pdf-label">ยอดหลังหักส่วนลด</td><td class="pdf-amount">${U(m,2,!0)}</td></tr>`);const i=m*n,d=m+i,u=17,c=23,f=[];let h=[],p=0;a.forEach((k,I)=>{const T=f.length===0?u:c,C=p+k.units>T;let N=!1;if(!C&&I<a.length-1){const R=T-(p+k.units);R>0&&R<r&&(N=!0)}(C||N)&&h.length>0&&(f.push(h),h=[],p=0),h.push(k),p+=k.units}),h.length>0&&f.push(h);const y=new Date,_=y.toLocaleDateString("th-TH",{year:"numeric",month:"long",day:"numeric"}),v=`QT-${y.getFullYear()}${(y.getMonth()+1).toString().padStart(2,"0")}${y.getDate().toString().padStart(2,"0")}`;let S="",w=0,q=1;f.forEach((k,I)=>{const T=I===0,C=I===f.length-1,N=`
            <div class="pdf-page-header">
                <div class="pdf-header">
                    <div class="pdf-shop-info">
                        ${`<img src="${P.logoUrl}" alt="Logo" class="pdf-logo">`}
                        <div class="pdf-shop-address">
                            <strong><i class="ph ph-github-logo"></i> ${L(P.name)}</strong><br>
                            ${L(P.address).replace(/\n/g,"<br>")}<br>
                            โทร: ${L(P.phone)} | เลขประจำตัวผู้เสียภาษี: ${L(P.taxId)}
                        </div>
                    </div>
                    <div class="pdf-quote-details">
                        <div class="pdf-title-box"><h1>ใบเสนอราคา ${f.length>1?T?"":"(ต่อ)":""}</h1></div>
                        <table class="pdf-quote-meta">
                            <tr><td>เลขที่:</td><td>${v}</td></tr>
                            <tr><td>วันที่:</td><td>${_}</td></tr>
                        </table>
                    </div>
                </div>
                ${T?`
                <section class="pdf-customer-details">
                    <div class="pdf-customer-info">
                        <strong>ลูกค้า:</strong> ${L(e.customer_name)||""}<br>
                        <strong>ที่อยู่:</strong> ${L(e.customer_address).replace(/\n/g,"<br>")||""}<br>
                        <strong>โทร:</strong> ${L(e.customer_phone)||""}
                    </div>
                    <div class="pdf-customer-meta">
                        <strong>เงื่อนไขชำระเงิน:</strong> ${L(P.pdf.paymentTerms)}<br>
                        <strong>ยืนราคา:</strong> ${L(P.pdf.priceValidity)}
                    </div>
                </section>`:""}
            </div>`,R=`
            <div class="pdf-page-footer">
                <div class="pdf-footer-info">
                    <span><i class="ph ph-github-logo"></i> ${L(P.name)} | โทร: ${L(P.phone)}</span>
                    <span>หน้า ${I+1} / ${f.length}</span>
                </div>
            </div>`;let A="";T||(A+=`<tr class="pdf-subtotal-row"><td colspan="4">ยอดยกมา (Brought Forward)</td><td class="pdf-text-right">${U(w,2,!0)}</td></tr>`),k.forEach(D=>{D.isRoomHeader?A+=`<tr class="pdf-room-header"><td colspan="5">ห้อง: ${D.roomName}</td></tr>`:(A+=`<tr><td class="pdf-text-center">${q++}</td><td>${D.description}</td><td class="pdf-text-center">1</td><td class="pdf-text-right">${U(D.total,2,!0)}</td><td class="pdf-text-right">${U(D.total,2,!0)}</td></tr>`,w+=D.total)});let O="";C||(O=`<tfoot><tr class="pdf-subtotal-row"><td colspan="4">ยอดยกไป (Carried Forward)</td><td class="pdf-text-right">${U(w,2,!0)}</td></tr></tfoot>`);let J="";P.pdf.notes&&P.pdf.notes.length>0&&(J=`
                <strong>หมายเหตุ:</strong>
                <ul>${P.pdf.notes.map(D=>`<li>${L(D)}</li>`).join("")}</ul>
            `);const ae=C?`
            <div class="pdf-summary-wrapper">
                <section class="pdf-summary-section">
                    <div class="pdf-amount-in-words">
                        ${J}
                        <div class="pdf-amount-text">( ${_t(d)} )</div>
                    </div>
                    <div class="pdf-totals-block">
                        <table>
                            <tr><td class="pdf-label">รวมเป็นเงิน</td><td class="pdf-amount">${U(s,2,!0)}</td></tr>
                            ${l}
                            ${n>0?`<tr><td class="pdf-label">ภาษีมูลค่าเพิ่ม ${(n*100).toFixed(0)}%</td><td class="pdf-amount">${U(i,2,!0)}</td></tr>`:""}
                            <tr class="pdf-grand-total"><td class="pdf-label">ยอดรวมสุทธิ</td><td class="pdf-amount">${U(d,2,!0)}</td></tr>
                        </table>
                    </div>
                </section>
                <footer class="pdf-footer-section">
                    <div class="pdf-signature-box"><p>.................................................</p><p>ผู้เสนอราคา</p><p>(<i class="ph ph-github-logo"></i> ${L(P.name)})</p><p>วันที่: ${_}</p></div>
                    <div class="pdf-signature-box"><p>.................................................</p><p>ลูกค้า / ผู้มีอำนาจลงนาม</p><p>&nbsp;</p><p>วันที่: ......./......./............</p></div>
                </footer>
            </div>
        `:"";S+=`
            <div class="pdf-page">
                <div class="pdf-page-content">
                    ${N}
                    <div class="pdf-page-body">
                        <table class="pdf-items-table">
                            <thead><tr><th style="width:5%;">ลำดับ</th><th style="width:50%;">รายการ</th><th style="width:10%;">จำนวน</th><th style="width:17.5%;">ราคา/หน่วย</th><th style="width:17.5%;">รวม (บาท)</th></tr></thead>
                            <tbody>${A}</tbody>
                            ${O}
                        </table>
                        ${ae}
                    </div>
                    ${R}
                </div>
            </div>`});const E=e.customer_name||"quote",$=Ze(E);return{html:`<div id="quotation-template">${S}</div>`,fileName:`${v}_${$}`}}function It(e){var l;const t=nt(e);let n=0;((l=e.discount)==null?void 0:l.value)>0&&(n=e.discount.type==="percent"?t*(e.discount.value/100):e.discount.value);const r=t-n;let a=!1,s=e.rooms.map(m=>{if(m.is_suspended)return"";const i=m.items.filter(u=>!u.is_suspended&&(g(u.width_m)>0||u.type==="wallpaper"&&(u.widths||[]).reduce((c,f)=>c+g(f),0)>0));if(i.length===0)return"";const d=i.map((u,c)=>{let f="",h="",p="";if(u.type!=="set"){const y=re[u.type]||"ของตกแต่ง";h=`<h5 class="lookbook-item-title">${L(y)}</h5>`}switch(u.type){case"set":p=`<tr><td>ขนาด</td><td>${g(u.width_m).toFixed(2)} x ${g(u.height_m).toFixed(2)} ม.</td></tr>`,f=`
                        <tr><td>แบบ</td><td>${L(u.style)} (${L(u.fabric_variant)})</td></tr>
                        ${u.fabric_variant.includes("ทึบ")?`<tr><td>ทึบ</td><td>#${L(u.fabric_code)||"-"}</td></tr>`:""}
                        ${u.fabric_variant.includes("โปร่ง")?`<tr><td>โปร่ง</td><td>#${L(u.sheer_fabric_code)||"-"}</td></tr>`:""}
                    `,u.style==="ม่านพับ"&&(f+=`<tr><td>เชือก</td><td>${L(u.adjustment_side)}</td></tr>`);break;case"wallpaper":const y=(u.widths||[]).reduce((v,S)=>v+g(S),0),_=B.wallpaperRolls(y,u.height_m);p=`<tr><td>ขนาด</td><td>รวม ${y.toFixed(2)} ม., สูง ${g(u.height_m).toFixed(2)} ม.</td></tr>`,f=`
                        <tr><td>รหัส</td><td>#${L(u.wallpaper_code)||"-"}</td></tr>
                        <tr><td>ใช้</td><td>${_} ม้วน</td></tr>
                    `;break;default:p=`<tr><td>ขนาด</td><td>${g(u.width_m).toFixed(2)} x ${g(u.height_m).toFixed(2)} ม.</td></tr>`,f=`<tr><td>รหัส</td><td>#${L(u.code)||"-"}</td></tr>`,u.opening_style&&(f+=`<tr><td>เปิด</td><td>${L(u.opening_style)}</td></tr>`),u.adjustment_side&&(f+=`<tr><td>เชือก</td><td>${L(u.adjustment_side)}</td></tr>`);break}return f&&(a=!0),`
                 <div class="lookbook-details">
                    ${Lt(u,m.id,c)}
                    <div class="spec-table-wrapper">
                        ${h}
                        <table class="spec-table">
                            ${f}
                            ${p}
                        </table>
                    </div>
                </div>
            `}).join('<hr class="lookbook-hr">');return d.trim()?`
            <div class="lookbook-room">
                <h4><i class="ph ph-map-pin"></i> ${L(m.room_name)}</h4>
                ${d}
            </div>
        `:""}).join("");return a?`
        <div class="lookbook-summary">
            <div class="lookbook-customer-info">
                <strong>ลูกค้า:</strong> ${L(e.customer_name)||"-"}<br/>
                <strong>ที่อยู่:</strong> ${L(e.customer_address)||"-"}
            </div>
            <div class="lookbook-totals">
                <span>ยอดรวม (ก่อนส่วนลด): ${M(t)} บาท</span>
                ${n>0?`<span>ส่วนลด: -${M(n)} บาท</span>`:""}
                <span class="grand-total">ยอดสุทธิ: ${M(r)} บาท</span>
            </div>
        </div>
    `+s:'<p class="empty-summary">ไม่มีรายการสำหรับสร้างรายงาน</p>'}const de=[],Bt=10;function oe(e){de.push(e),de.length>Bt&&de.shift()}function Ct(){return de.pop()}function Nt(){return de.length>0}let K=!1,X=null,H=null,ye=null,ue=!1,V=null,Le=null,Te=!1,le=null;const Qe=document.querySelector("#undoBtn"),ve={};function At(e){if(ve[e])return ve[e];const t=new Promise((n,r)=>{const a=document.createElement("script");a.src=e,a.onload=()=>{console.log(`${e} loaded successfully.`),n()},a.onerror=()=>{console.error(`Script load error for ${e}`),delete ve[e],r(new Error(`Script load error for ${e}`))},document.head.appendChild(a)});return ve[e]=t,t}const se={set:{templateId:"#setTpl",name:"ผ้าม่าน"},wallpaper:{templateId:"#wallpaperTpl",name:"วอลล์เปเปอร์"},wooden_blind:{templateId:"#areaBasedTpl",name:"มู่ลี่ไม้"},roller_blind:{templateId:"#areaBasedTpl",name:"ม่านม้วน"},vertical_blind:{templateId:"#areaBasedTpl",name:"ม่านปรับแสง"},partition:{templateId:"#areaBasedTpl",name:"ฉากกั้นห้อง"},pleated_screen:{templateId:"#areaBasedTpl",name:"มุ้งจีบ"},aluminum_blind:{templateId:"#areaBasedTpl",name:"มู่ลี่อลูมิเนียม"}},Ft={มู่ลี่ไม้:"wooden_blind",ม่านม้วน:"roller_blind",ม่านปรับแสง:"vertical_blind",ฉากกั้นห้อง:"partition",มุ้งจีบ:"pleated_screen",มู่ลี่อลูมิเนียม:"aluminum_blind"},Be="marnthara.theme";function st(){const e=localStorage.getItem(Be),t=document.querySelector("#themeToggleBtn");if(!t)return;const n=t.querySelector("i"),r=t.querySelector("span");switch(document.body.classList.remove("dark-theme","neutral-theme"),e){case"dark":document.body.classList.add("dark-theme"),n&&(n.className="ph-fill ph-sun"),r&&(r.textContent=" สว่าง");break;case"neutral":document.body.classList.add("neutral-theme"),n&&(n.className="ph-fill ph-moon"),r&&(r.textContent=" มืด");break;default:n&&(n.className="ph-fill ph-palette"),r&&(r.textContent=" กลาง");break}}function Pt(){const e=localStorage.getItem(Be);let t;!e||e==="light"?t="neutral":e==="neutral"?t="dark":t="light",localStorage.setItem(Be,t),st()}function Q(){Qe&&(Qe.disabled=!Nt())}function Rt(){const e=Ct();e&&(Ae(e,!1),x("ยกเลิกการกระทำล่าสุดแล้ว","success")),Q()}function Me(){le="suspended";const e=document.getElementById("filterStatusBar");let t=0;if(document.querySelectorAll(".room-card").forEach(n=>{let r=!1;n.querySelectorAll(".item-card").forEach(a=>{const s=a.classList.contains("is-suspended")||n.classList.contains("is-suspended");a.classList.toggle("item-hidden",!s),s&&(r=!0,t++)}),n.classList.toggle("item-hidden",!r)}),t===0){at(),x("ไม่มีรายการที่ถูกระงับแล้ว","success");return}e&&(e.innerHTML=`
            <span><i class="ph ph-warning"></i> รายการที่ถูกระงับ (${t} รายการ)</span>
            <button type="button" class="btn-chip" data-act="clear-filter" title="ยกเลิกการกรอง">
                <i class="ph ph-x"></i>&nbsp;ปิด
            </button>
        `,e.classList.add("is-visible"),e.dataset.filterType="suspended"),ee(),Y(),$e()}function Ot(e,t){if(!e)return;le=e;const n=document.getElementById("filterStatusBar");let r=0;document.querySelectorAll(b.room).forEach(a=>{let s=0;a.querySelectorAll(".item-card").forEach(o=>{const l=o.dataset.type===e;o.classList.toggle("item-hidden",!l),l&&s++}),a.classList.toggle("item-hidden",s===0),r+=s}),n&&(n.innerHTML=`
            <span>เฉพาะ: <strong>${L(t)}</strong> (${r} รายการ)</span>
            <button type="button" class="btn-chip" data-act="clear-filter" title="ยกเลิกการกรอง">
                <i class="ph ph-x"></i>&nbsp;ปิด
            </button>
        `,n.classList.add("is-visible"),n.dataset.filterType=e),ee(),Y(),$e()}function at(){le=null;const e=document.getElementById("filterStatusBar");e&&(e.classList.remove("is-visible"),e.innerHTML="",e.removeAttribute("data-filter-type")),document.querySelectorAll(".item-hidden").forEach(t=>t.classList.remove("item-hidden")),ee(),Y(),$e()}function Ht(e){const t=e.target.closest(".item-card");document.querySelectorAll(".item-details-more.show").forEach(n=>{const r=n.closest(".item-card");r!==t&&Pe(r,!1)})}function Ce(e){if(!e)return;const t=document.querySelector(".main-header"),n=document.querySelector(".summary-footer"),r=t?t.offsetHeight+16:80,a=n?n.offsetHeight+16:100,s=e.getBoundingClientRect();if(!(s.top>=r&&s.bottom<=window.innerHeight-a)){const l=window.innerHeight-r-a,m=s.height>l?"start":"center";e.scrollIntoView({behavior:"smooth",block:m})}}function jt(e){if(!X)return;const t=X.closest(".item-card");if(!t)return;const n=e.dataset.code,r=g(e.dataset.price);X.value=n,X.classList.add("input-highlight"),setTimeout(()=>X.classList.remove("input-highlight"),1200);const a=X.dataset.favoriteType;let s;a==="fabric"?s="set_price_per_m":a==="sheer"?s="sheer_price_per_m":a==="wallpaper"?s="wallpaper_price_roll":s="area_price_sqyd";const o=t.querySelector(`[name="${s}"]`);o&&r>0&&(o.tagName==="SELECT"?o.value=r:o.value=M(r),o.classList.add("input-highlight"),setTimeout(()=>o.classList.remove("input-highlight"),1200)),z(X),ce(t),F(),document.querySelector("#favoritesModal").classList.remove("visible")}async function lt(e){var f;X=e;const t=e.dataset.favoriteType;if(!t)return;const n=document.querySelector("#favoritesModal"),r=n.querySelector("#favoritesModalTitle"),a=n.querySelector("#favoritesModalBody"),s=n.querySelector("#favSearchInput"),o=n.querySelector("#favoritesModalManageBtn"),l=document.querySelector("#favSelectorItemTpl"),m=((f=se[t])==null?void 0:f.name)||t;r.textContent=`เลือก '${L(m)}'`;const d=Z()[t]||[];d.length>0?a.innerHTML=d.map(h=>l.innerHTML.replace(/{CODE}/g,L(h.code)).replace(/{PRICE}/g,h.price>0?M(h.price):"-").replace(/{RAW_PRICE}/g,h.price)).join(""):a.innerHTML='<p class="empty-state">ไม่มีรายการโปรดที่บันทึกไว้</p>',s.value="";const u=()=>{const h=s.value.toLowerCase();a.querySelectorAll(".fav-selector-item").forEach(p=>{const y=p.dataset.code.toLowerCase();p.classList.toggle("is-hidden",!y.includes(h))})};s.addEventListener("input",u);const c=h=>{const p=h.target.closest(".fav-selector-item");p&&(jt(p),a.removeEventListener("click",c),s.removeEventListener("input",u))};a.addEventListener("click",c),o.onclick=async()=>{n.classList.remove("visible"),await Wt(t),ue&&await lt(e)},await W("#favoritesModal",()=>{s.removeEventListener("input",u),a.removeEventListener("click",c)})}function be(e){const t=document.querySelector("#favManagerBody"),n=document.querySelector("#favManagerItemTpl"),a=Z()[e]||[];!t||!n||(a.length===0?t.innerHTML='<p class="empty-state">ไม่มีรายการโปรดที่บันทึกไว้</p>':t.innerHTML=a.map(s=>n.innerHTML.replace(/{CODE}/g,L(s.code)).replace(/{PRICE}/g,M(s.price)).replace(/{RAW_PRICE}/g,s.price)).join(""),Ne(null))}function Ne(e){const t=document.querySelector('[data-act="edit-selected-fav"]'),n=document.querySelector('[data-act="del-selected-fav"]');!t||!n||(e?(t.disabled=!1,n.disabled=!1,V={code:e.dataset.code,price:g(e.dataset.price)}):(t.disabled=!0,n.disabled=!0,V=null))}async function Wt(e){var r;const t=document.querySelector("#favManagerModal");if(!t||!e)return;const n=((r=se[e])==null?void 0:r.name)||e;t.dataset.currentType=e,ue=!1,V=null,document.querySelector("#favManagerTitle").textContent=`จัดการ '${n}'`,be(e),await W("#favManagerModal")}function x(e,t="default"){const n=document.querySelector(b.toastContainer);if(!n)return;const r={success:"ph-bold ph-check-circle",warning:"ph-bold ph-warning",error:"ph-bold ph-x-circle",default:"ph-bold ph-info"},a=document.createElement("div");a.className=`toast toast-${t}`,a.innerHTML=`<i class="${r[t]||r.default}"></i> ${e}`,n.appendChild(a),setTimeout(()=>a.classList.add("show"),10),setTimeout(()=>{a.classList.remove("show"),a.addEventListener("transitionend",()=>a.remove())},3e3)}function W(e,t){return new Promise(n=>{const r=document.querySelector(e);if(!r){n(null);return}const a=document.querySelector(".modal-wrapper.visible");a&&a.classList.add("is-underlay"),r.classList.add("visible");const s=r.querySelector('[id$="Confirm"]'),o=r.querySelector('[id$="Cancel"], [data-act="close-modal"]'),l=Array.from(r.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])')).filter(c=>!c.disabled&&c.offsetParent!==null),m=l[0],i=l[l.length-1];setTimeout(()=>m==null?void 0:m.focus(),50);const d=c=>{if(c.key==="Escape"&&!r.classList.contains("is-underlay")){u({cancelled:!0});return}if(c.key==="Tab"){if(l.length<=1){c.preventDefault();return}c.shiftKey?document.activeElement===m&&(i.focus(),c.preventDefault()):document.activeElement===i&&(m.focus(),c.preventDefault())}},u=c=>{r.classList.remove("visible"),document.removeEventListener("keydown",d),s&&(s.onclick=null),o&&(o.onclick=null),a&&a.classList.remove("is-underlay"),typeof c=="object"&&c.cancelled&&t&&t(),n(c)};s&&(s.onclick=()=>u(!0)),o&&(o.onclick=()=>{r.classList.contains("is-underlay")||u({cancelled:!0})}),document.addEventListener("keydown",d)})}async function me(e,t){const n=document.querySelector(b.modal);return n?(n.querySelector(b.modalTitle).textContent=e,n.querySelector(b.modalBody).textContent=t,await W(b.modal)===!0):!0}async function Dt(){var n,r,a;const e=document.querySelector(b.exportOptionsModal);if(!e)return null;const t=await W(b.exportOptionsModal);return!t||t.cancelled?null:{vatOption:((n=e.querySelector('input[name="vat_option"]:checked'))==null?void 0:n.value)||"include",exportMethod:((r=e.querySelector("#exportMethod"))==null?void 0:r.value)||"direct",pageBreakBuffer:parseInt((a=e.querySelector("#pageBreakBuffer"))==null?void 0:a.value,10)||3}}async function Ut(){const e=document.querySelector("#discountModal");if(!e)return;const t=e.querySelector("#discountSubtotal"),n=e.querySelector("#discountPercent"),r=e.querySelector("#discountAmount"),a=e.querySelector("#discountFinalTotal"),s=document.querySelector("#discount_type"),o=document.querySelector("#discount_value"),l=g(document.querySelector("#originalTotal").dataset.rawTotal||document.querySelector("#grandTotal").textContent);t.textContent=M(l);const m=c=>{if(Te)return;Te=!0;let f=0;if(c==="percent"){const h=g(n.value);f=l*((h>=0?h:0)/100),r.value=f>0?M(Math.round(f)):""}else f=g(r.value);if(f=f>=0?Math.min(f,l):0,c!=="percent"){const h=l>0?f/l*100:0;n.value=h>0&&isFinite(h)?U(h,2):""}a.textContent=M(l-f),setTimeout(()=>{Te=!1},20)};n.addEventListener("input",()=>m("percent")),r.addEventListener("input",()=>m("amount")),r.addEventListener("focus",c=>{g(c.target.value)>0&&(c.target.value=g(c.target.value))}),r.addEventListener("blur",c=>{g(c.target.value)>0&&(c.target.value=M(g(c.target.value))),m("amount")});const i=s.value,d=g(o.value);n.value="",r.value="",d>0?i==="percent"?(n.value=d,m("percent")):(r.value=M(d),m("amount")):m();const u=await W("#discountModal");if(u&&!u.cancelled){const c=g(n.value),f=g(r.value);document.activeElement===n&&c>0?(s.value="percent",o.value=c):f>0?(s.value="amount",o.value=f):(s.value="amount",o.value=0),G(),F()}}async function Vt(){var r,a,s,o,l;if(!H)return;const e=document.querySelector("#hardwareModal"),t=((r=H.querySelector('[name="set_style"]'))==null?void 0:r.value)==="ตาไก่";e.querySelector('[name="modal_track_color"]').value=((a=H.querySelector('[name="track_color"]'))==null?void 0:a.value)||"ขาว",e.querySelector('[name="modal_bracket_color"]').value=((s=H.querySelector('[name="bracket_color"]'))==null?void 0:s.value)||"ขาว",e.querySelector('[name="modal_finial_color"]').value=((o=H.querySelector('[name="finial_color"]'))==null?void 0:o.value)||"ขาว",e.querySelector('[name="modal_grommet_color"]').value=((l=H.querySelector('[name="grommet_color"]'))==null?void 0:l.value)||"เงิน",e.querySelector("#grommetColorGroup").style.display=t?"":"none";const n=await W("#hardwareModal");n&&!n.cancelled&&(H.querySelector('[name="track_color"]').value=e.querySelector('[name="modal_track_color"]').value,H.querySelector('[name="bracket_color"]').value=e.querySelector('[name="modal_bracket_color"]').value,H.querySelector('[name="finial_color"]').value=e.querySelector('[name="modal_finial_color"]').value,t&&(H.querySelector('[name="grommet_color"]').value=e.querySelector('[name="modal_grommet_color"]').value),F(),x("บันทึกการตั้งค่าอุปกรณ์แล้ว","success")),H=null}function Ee(e,t,n){e&&(oe(j()),Q(),e.classList.add("item-removing"),e.addEventListener("animationend",()=>{e.remove(),t&&x(t),n&&n(),pe(),ee(),G(),F(),fe()},{once:!0}))}function ee(){document.querySelectorAll(b.room).forEach(e=>{const t=e.querySelectorAll(".item-card:not(.is-suspended):not(.item-hidden)"),n=t.length;t.forEach((a,s)=>{const o=a.querySelector("[data-item-title]");o&&(o.textContent=`${s+1}/${n}`)}),e.querySelectorAll(".item-card.is-suspended, .item-card.item-hidden").forEach(a=>{const s=a.querySelector("[data-item-title]");s&&(s.textContent="-")})})}function ct(){const e=document.querySelector(b.orderForm),t=document.querySelector(b.lockBtn);!e||!t||(e.classList.toggle("is-locked",K),t.classList.toggle("is-locked",K),t.querySelector("i").className=K?"ph-bold ph-lock-key":"ph ph-paw-print",e.querySelectorAll("input, select, textarea, button").forEach(n=>{n.closest(".summary-footer")||n.closest(".main-header")||n.closest(".modal-wrapper")||n.dataset.act==="toggle-more-details"||n.dataset.act==="collapse-room"||(n.disabled=K)}),x(K?"ฟอร์มถูกล็อค":"ปลดล็อคฟอร์มแล้ว",K?"warning":"success"))}function Y(){const e=document.querySelectorAll(b.room);if(e.length===0)return;const t=[...e].some(r=>r.open),n=document.querySelector(b.toggleAllRoomsBtn);n&&(n.querySelector("i").className="ph ph-rows",n.querySelector("span").textContent=t?"ย่อทั้งหมด":"ขยายทั้งหมด")}function Gt(){var r;const e=document.querySelectorAll(b.room),t=[...e].some(a=>a.open);e.forEach(a=>{a.open=!t});const n=document.querySelector(b.quickNavDropdown);n&&n.classList.contains("show")&&(n.classList.remove("show"),(r=document.querySelector(b.quickNavBtn))==null||r.setAttribute("aria-expanded","false")),setTimeout(()=>{Y(),F()},50)}function pe(){const e=document.querySelector(b.quickNavRoomList);e&&(e.innerHTML="",document.querySelectorAll(b.room).forEach(t=>{var a;const n=((a=t.querySelector(b.roomNameInput))==null?void 0:a.value)||"ห้อง",r=document.createElement("a");r.href=`#${t.id}`,r.dataset.jumpTo=t.id,r.innerHTML=`<i class="ph ph-share-fat"></i> ${n}`,e.appendChild(r)}))}function it(e){var n;const t=document.getElementById("quickNavBtnText");t&&(e?t.textContent=((n=e.querySelector('input[name="room_name"]'))==null?void 0:n.value)||"...":t.textContent="ไปยังห้อง")}function fe(){if(ye&&ye.disconnect(),!document.getElementById("quickNavBtnText"))return;const e={root:null,rootMargin:"-60px 0px -150px 0px",threshold:0},t=n=>{const r=n.filter(a=>a.isIntersecting).sort((a,s)=>a.target.getBoundingClientRect().top-s.target.getBoundingClientRect().top);r.length>0&&it(r[0].target)};ye=new IntersectionObserver(t,e),document.querySelectorAll(b.room).forEach(n=>ye.observe(n))}function z(e){if(!e)return;const t=e.closest(".form-group-with-favorites").querySelector(".btn-favorite");if(!t)return;const n=e.dataset.favoriteType,r=e.value;t.classList.toggle("is-favorite",rt(n,r))}function Pe(e,t=null){if(!e)return;const n=e.querySelector(".item-details-more"),r=e.querySelector('[data-act="toggle-more-details"]'),a=r==null?void 0:r.parentElement;if(!n||!r||!a)return;const s=n.classList.contains("show"),o=t!==null?t:!s;if(s===o)return;n.classList.toggle("show",o),r.classList.toggle("expanded",o);const l=r.querySelector("i");l&&(l.className=o?"ph ph-caret-up":"ph ph-caret-down");const m=r.querySelector("span");if(m&&(m.textContent=o?"ย่อน้อยลง":"เพิ่มเติม"),o)n.appendChild(a),Ce(e);else{const i=e.querySelector(".item-grid");i&&i.appendChild(a)}}function dt(e,t){if(!e)return;const n=e.querySelector('[data-set-control="opening_style_wrap"]'),r=e.querySelector('[data-set-control="adjustment_side_wrap"]');if(n&&r){const a=t==="ม่านพับ";n.classList.toggle("hidden",a),r.classList.toggle("hidden",!a)}}function Re(e,t){var l;const n=se[e];if(!n)return null;const r=document.querySelector(n.templateId);if(!r||!t)return null;const a=r.content.cloneNode(!0),s=a.firstElementChild;s.dataset.type=e,s.classList.add(`${e.replace(/_/g,"-")}-item`);const o=s.querySelector(".item-type-display");if(o&&(o.textContent=n.name),n.templateId==="#areaBasedTpl"){const m=s.querySelector('input[name="area_code"]'),i=s.querySelector(".btn-favorite"),d=s.querySelector(".btn-show-favs");m&&(m.dataset.favoriteType=e),i&&(i.dataset.type=e),d&&(d.dataset.type=e);const u=s.querySelector(".item-details-more .item-grid"),c=(l=u==null?void 0:u.querySelector('input[name="area_price_sqyd"]'))==null?void 0:l.closest(".form-group");if(u&&c){let f=null;e==="partition"||e==="pleated_screen"?(f=document.createElement("div"),f.className="form-group",f.innerHTML=`
                    <label>รูปแบบเปิด
                        <select name="opening_style">
                            <option value="แยกกลาง">แยกกลาง</option>
                            <option value="เก็บข้างเดียว">เก็บข้างเดียว</option>
                        </select>
                    </label>
                `):["wooden_blind","roller_blind","vertical_blind","aluminum_blind"].includes(e)&&(f=document.createElement("div"),f.className="form-group",f.innerHTML=`
                    <label>เชือกปรับ
                        <select name="adjustment_side">
                            <option value="ปรับขวา">ปรับขวา</option>
                            <option value="ปรับซ้าย">ปรับซ้าย</option>
                        </select>
                    </label>
                `),f&&(c.classList.remove("full-width-item"),c.parentNode.insertBefore(f,c))}}return t.appendChild(a),s}function Yt(e,t){var a;if(!t)return;const n=t.querySelector(b.allItemsContainer);if(!n)return;oe(j()),Q();const r=Re(e,n);if(r){if(e==="wallpaper"){const s=Oe(r.querySelector('[data-act="add-wall"]'));s&&((a=s.querySelector("input"))==null||a.focus())}else{const s=r.querySelector('input:not([type="hidden"]), select, textarea');s&&s.focus()}r.classList.add("item-created"),r.scrollIntoView({behavior:"smooth",block:"center"}),ee(),G(),F()}}async function Xe(e,t=null){const n=document.querySelector("#itemTypeModal");if(!n)return null;n.querySelector("#itemTypeModalTitle").textContent=e;let r=t;t&&!se[t]&&(r="wooden_blind");const a=n.querySelector(`input[name="item_type_option"][value="${r||"set"}"]`);a&&(a.checked=!0);const s=await W("#itemTypeModal");if(!s||s.cancelled)return null;const o=n.querySelector('input[name="item_type_option"]:checked');return o?o.value:null}function Jt(e,t){if(!se[t])return;const r=e.parentElement;r&&(oe(j()),Q(),e.classList.add("item-removing"),e.addEventListener("animationend",()=>{var s;const a=Re(t,r);a&&(e.replaceWith(a),a.classList.add("item-created"),a.scrollIntoView({behavior:"smooth",block:"center"}),(s=a.querySelector('input:not([type="hidden"]), select, textarea'))==null||s.focus(),ee(),G(),F(),x("เปลี่ยนประเภทรายการแล้ว","success"))},{once:!0}))}function ie(){oe(j()),Q();const e=document.querySelector(b.roomsContainer);if(!e)return;const t=document.querySelector("#roomTpl");if(!t)return;const n=Array.from(document.querySelectorAll(b.roomNameInput)).map(m=>parseInt(m.value.replace(/[^0-9]/g,""),10)).filter(m=>!isNaN(m)),s=`ห้อง ${(n.length>0?Math.max(...n):0)+1}`,l=t.content.cloneNode(!0).firstElementChild;if(l){l.id=`room-${Date.now()}`;const m=l.querySelector('input[name="room_name"]'),i=l.querySelector(".room-header-controls .form-group > label");if(m&&i){const u=`room_name_${l.id}`;m.id=u,i.setAttribute("for",u)}m&&(m.value=s);const d=l.querySelector("[data-room-name-display]");d&&(d.textContent=s),l.open=!0,e.appendChild(l),l.classList.add("item-created"),l.scrollIntoView({behavior:"smooth",block:"center"})}pe(),Y(),fe(),F()}function Oe(e){var n;const t=(n=e==null?void 0:e.closest(".walls-section"))==null?void 0:n.querySelector(b.wallsContainer);if(t){const r=document.querySelector(b.wallTpl);if(!r)return null;const a=r.content.cloneNode(!0),s=a.querySelector(".wall-input-row");if(!s)return null;const o=s.querySelector("input"),l=s.querySelector("label");if(o&&l){const m=`wall-input-${Date.now()}-${Math.random().toString(36).substring(2,7)}`;o.id=m,l.setAttribute("for",m)}return t.appendChild(a),requestAnimationFrame(()=>{s.classList.add("item-created")}),ce(e),s}return null}function ce(e){var o,l,m,i,d,u,c,f,h,p,y,_;if(!e)return;const t=e.closest(".item-card");if(!t){G();return}const n=t.dataset.type;let r,a,s;switch(n){case"set":r=t.querySelector("[data-set-summary]"),a={width_m:(o=t.querySelector('input[name="width_m"]'))==null?void 0:o.value,height_m:(l=t.querySelector('input[name="height_m"]'))==null?void 0:l.value,style:(m=t.querySelector('select[name="set_style"]'))==null?void 0:m.value,fabric_variant:(i=t.querySelector('select[name="fabric_variant"]'))==null?void 0:i.value,price_per_m_raw:(d=t.querySelector('select[name="set_price_per_m"]'))==null?void 0:d.value,sheer_price_per_m:(u=t.querySelector('select[name="sheer_price_per_m"]'))==null?void 0:u.value},s=B.calculateSetPrice(a),t.dataset.totalPrice=s.total;let v=`ราคา: <b>${M(s.total)}</b> บ.`;s.opaque>0&&s.sheer>0&&(v+=` <small>(ทึบ: ${M(s.opaque)}, โปร่ง: ${M(s.sheer)})</small>`),r&&(r.innerHTML=v);break;case"wallpaper":r=t.querySelector("[data-wallpaper-summary]"),a={height_m:(c=t.querySelector('input[name="wallpaper_height_m"]'))==null?void 0:c.value,price_per_roll:(f=t.querySelector('input[name="wallpaper_price_roll"]'))==null?void 0:f.value,install_cost_per_roll:(h=t.querySelector('input[name="wallpaper_install_cost"]'))==null?void 0:h.value,widths:Array.from(t.querySelectorAll('input[name="wall_width_m"]')).map(q=>q.value)},s=B.calculateWallpaperPrice(a),t.dataset.totalPrice=s.total;let S=`รวม: <b>${M(s.total)}</b> บ. `;(s.material>0||s.install>0)&&(S+=`<small>(วอลล์: ${M(s.material)}, ค่าช่าง: ${M(s.install)})</small>`),s.rolls>0&&(S+=` &bull; พื้นที่: ${U(s.sqm,2)} ตร.ม. &bull; ใช้: ${s.rolls} ม้วน`),r&&(r.innerHTML=S);break;default:r=t.querySelector("[data-area-summary]"),a={width_m:(p=t.querySelector('input[name="area_width_m"]'))==null?void 0:p.value,height_m:(y=t.querySelector('input[name="area_height_m"]'))==null?void 0:y.value,price_sqyd:(_=t.querySelector('input[name="area_price_sqyd"]'))==null?void 0:_.value},s=B.calculateDecoPrice(a),t.dataset.totalPrice=s.total;let w="";s.sqyd>0&&(w=` &bull; พื้นที่: ${U(s.sqyd,2)} ตร.หลา`),r&&(r.innerHTML=`ราคา: <b>${M(s.total)}</b> บ.${w}`);break}G()}function $e(){const e=document.getElementById("suspendedItemsBtn");if(!e)return;if(le){e.classList.remove("is-visible");return}const t=document.getElementById("suspendedCountBadge"),n=document.querySelectorAll(".item-card.is-suspended").length,r=document.querySelectorAll(".room-card.is-suspended");let a=0;r.forEach(o=>{a+=o.querySelectorAll(".item-card:not(.is-suspended)").length});const s=n+a;s>0?(t&&(t.textContent=s),e.classList.add("is-visible")):e.classList.remove("is-visible")}function G(){let e=0;document.querySelectorAll(b.room).forEach(o=>{let l=0,m=0;const i=o.classList.contains("is-suspended");o.querySelectorAll(".item-card").forEach(u=>{const c=g(u.dataset.totalPrice),f=u.classList.contains("is-suspended");!i&&!f&&(l+=c,c>0&&m++)});const d=o.querySelector("[data-room-brief]");d&&(i?d.textContent="(ระงับชั่วคราว)":m>0?d.innerHTML=`<span>${m}</span> &bull; ${M(l)} บาท`:d.innerHTML="<span>0</span> รายการ"),i||(e+=l)});const t=document.querySelector("#discount_type").value,n=g(document.querySelector("#discount_value").value);let r=0;n>0&&(r=t==="percent"?e*(n/100):n);const a=e-r;document.querySelector("#grandTotal").textContent=M(a);const s=document.querySelector("#originalTotal");r>0?(s.textContent=M(e),s.dataset.rawTotal=e,s.style.display="block"):(s.style.display="none",s.dataset.rawTotal=""),$e()}async function Ae(e,t=!1){if(e!=null&&e.favorites)if(t){const s=document.querySelector("#favoritesConflictModal");if(s){const o=await W("#favoritesConflictModal");if(!o||o.cancelled){x("ยกเลิกการนำเข้า","warning");return}switch(s.querySelector('input[name="fav_conflict_option"]:checked').value){case"overwrite":Ge(e.favorites)&&x("เขียนทับรายการโปรดสำเร็จ","success");break;case"merge":const m=et(e.favorites);x(`รวมข้อมูลสำเร็จ (เพิ่ม ${m} รายการใหม่)`,"success");break}}}else Ge(e.favorites);if(!(e!=null&&e.rooms)||!Array.isArray(e.rooms)){e.favorites||x("ไม่พบข้อมูลสำหรับนำเข้าในไฟล์","error");return}const n=document.querySelector(b.roomsContainer);if(!n)return;n.innerHTML="",document.querySelector("#customer_name").value=e.customer_name||"",document.querySelector("#customer_phone").value=e.customer_phone||"",document.querySelector("#customer_address").value=e.customer_address||"",e.discount&&(document.querySelector("#discount_type").value=e.discount.type||"amount",document.querySelector("#discount_value").value=e.discount.value||0),document.querySelector("#customerDetailsCard").open=e.customer_card_open??!0;let r=0;const a=()=>{if(r>=e.rooms.length){document.querySelectorAll("input[data-favorite-type]").forEach(z),G(),ee(),pe(),Y(),fe(),t&&x("นำเข้าข้อมูลฟอร์มสำเร็จ","success");return}const s=e.rooms[r],o=document.querySelector("#roomTpl");if(!o){console.error("Room template not found.");return}const m=o.content.cloneNode(!0).firstElementChild;if(n.appendChild(m),m){m.id=s.id||`room-${Date.now()}`,s.is_suspended&&m.classList.add("is-suspended"),m.open=s.is_open===!0;const i=s.room_name||"ห้อง (ไม่มีชื่อ)",d=m.querySelector('input[name="room_name"]'),u=m.querySelector(".room-header-controls .form-group > label");if(d&&u){const h=`room_name_${m.id}`;d.id=h,u.setAttribute("for",h)}d&&(d.value=i);const c=m.querySelector("[data-room-name-display]");c&&(c.textContent=i);const f=m.querySelector(b.allItemsContainer);if(f&&s.items){const h=document.createDocumentFragment();s.items.forEach(p=>{var _,v,S;p.type==="deco"&&p.deco_type?(p.type=Ft[p.deco_type]||"wooden_blind",p.code=p.deco_code,p.width_m=p.deco_width_m,p.height_m=p.deco_height_m,p.price_sqyd=p.deco_price_sqyd,p.notes=p.deco_notes):p.type==="deco"&&(p.type="wooden_blind",p.code=p.deco_code);const y=Re(p.type,h);if(y){switch(p.is_suspended&&y.classList.add("is-suspended"),p.type){case"set":y.querySelector('input[name="width_m"]').value=te(p.width_m),y.querySelector('input[name="height_m"]').value=te(p.height_m);const w=y.querySelector('select[name="fabric_variant"]');w.value=p.fabric_variant||"ทึบ",y.querySelector('select[name="set_style"]').value=p.style||p.set_style||"ลอน",y.querySelector('select[name="set_price_per_m"]').value=p.price_per_m_raw||p.set_price_per_m||"",y.querySelector('select[name="sheer_price_per_m"]').value=p.sheer_price_per_m||"",y.querySelector('select[name="opening_style"]').value=p.opening_style||"แยกกลาง",y.querySelector('select[name="adjustment_side"]').value=p.adjustment_side||"ปรับขวา",y.querySelector('input[name="track_color"]').value=p.track_color||"ขาว",y.querySelector('input[name="bracket_color"]').value=p.bracket_color||"ขาว",y.querySelector('input[name="finial_color"]').value=p.finial_color||"ขาว",y.querySelector('input[name="grommet_color"]').value=p.grommet_color||"เงิน",y.querySelector('input[name="fabric_code"]').value=p.fabric_code||"",y.querySelector('input[name="sheer_fabric_code"]').value=p.sheer_fabric_code||"",y.querySelector('input[name="notes"]').value=p.notes||"";const q=w.value,E=q==null?void 0:q.includes("โปร่ง"),$=q==="โปร่ง",k=q==="ทึบ";(_=y.querySelector(b.sheerWrap))==null||_.classList.toggle("hidden",!E),(v=y.querySelector(b.sheerCodeWrap))==null||v.classList.toggle("hidden",!E);const I=y.querySelector('select[name="set_price_per_m"]'),T=y.querySelector('input[name="fabric_code"]'),C=y.querySelector('select[name="sheer_price_per_m"]'),N=y.querySelector('input[name="sheer_fabric_code"]');I&&(I.disabled=$),T&&(T.disabled=$),$&&(I&&(I.value=""),T&&(T.value="",z(T))),C&&(C.disabled=k),N&&(N.disabled=k),k&&(C&&(C.value=""),N&&(N.value="",z(N))),dt(y,y.querySelector('select[name="set_style"]').value);break;case"wallpaper":y.querySelector('input[name="wallpaper_height_m"]').value=te(p.height_m||p.wallpaper_height_m),y.querySelector('input[name="wallpaper_code"]').value=p.wallpaper_code||"";const R=g(p.price_per_roll||p.wallpaper_price_roll);y.querySelector('input[name="wallpaper_price_roll"]').value=R>0?M(R):"",y.querySelector('input[name="wallpaper_install_cost"]').value=p.hasOwnProperty("install_cost_per_roll")?M(p.install_cost_per_roll):p.wallpaper_install_cost?M(p.wallpaper_install_cost):"300",y.querySelector('input[name="wallpaper_notes"]').value=p.notes||p.wallpaper_notes||"",p.widths&&p.widths.forEach(A=>{const O=Oe(y.querySelector('[data-act="add-wall"]'));O&&(O.querySelector('input[name="wall_width_m"]').value=te(A))});break;default:if(((S=se[p.type])==null?void 0:S.templateId)==="#areaBasedTpl"){y.querySelector('input[name="area_width_m"]').value=te(p.width_m),y.querySelector('input[name="area_height_m"]').value=te(p.height_m);const A=g(p.price_sqyd);y.querySelector('input[name="area_price_sqyd"]').value=A>0?M(A):"",y.querySelector('input[name="area_code"]').value=p.code||"",y.querySelector('input[name="area_notes"]').value=p.notes||"";const O=y.querySelector('select[name="opening_style"]');O&&(O.value=p.opening_style||"แยกกลาง");const J=y.querySelector('select[name="adjustment_side"]');J&&(J.value=p.adjustment_side||"ปรับขวา")}break}ce(y)}}),f.appendChild(h)}}r++,requestAnimationFrame(a)};requestAnimationFrame(a)}function Kt(e){if(document.getElementById("loading-overlay"))return;const t=document.createElement("div");t.id="loading-overlay",t.innerHTML=`<div class="loading-spinner"></div><p>${e}</p>`,document.body.appendChild(t),document.body.style.overflow="hidden"}function Qt(){const e=document.getElementById("loading-overlay");e&&e.remove(),document.body.style.overflow=""}async function Xt(e,t){var r,a;const n=document.querySelector(b.printableContent);if(!n||!e||!e.html){x("ไม่พบข้อมูลสำหรับสร้างเอกสาร","error");return}if(t==="direct"){Kt("กำลังสร้าง PDF...");let s;try{typeof html2pdf>"u"&&(x("กำลังโหลดไลบรารี PDF...","default"),await At("https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js")),s=document.createElement("div"),s.style.position="fixed",s.style.left="-300mm",s.style.top="0",s.style.width="210mm",s.style.background="#fff",s.innerHTML=e.html,document.body.appendChild(s),await new Promise(l=>setTimeout(l,500));const o={margin:0,filename:`${e.fileName}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0,logging:!1,width:((r=s.querySelector(".pdf-page"))==null?void 0:r.scrollWidth)||210*3.77,windowWidth:((a=s.querySelector(".pdf-page"))==null?void 0:a.scrollWidth)||210*3.77},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}};await window.html2pdf().from(s).set(o).save(),x("ดาวน์โหลด PDF สำเร็จ","success")}catch(o){console.error("PDF Generation Error:",o),x("สร้าง PDF ล้มเหลว, โปรดลองวิธีที่ 2 (พิมพ์)","error")}finally{Qt(),s&&document.body.contains(s)&&document.body.removeChild(s)}}t==="print"&&(n.innerHTML=e.html,setTimeout(()=>{window.print(),setTimeout(()=>{n.innerHTML=""},1e3)},ht))}function zt(e){if(!e||!e.html){x("ไม่พบข้อมูลสำหรับสร้างไฟล์ HTML","error");return}try{const t=`
            <!DOCTYPE html><html lang="th"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>${e.fileName}</title>
                <link rel="stylesheet" href="https://grobmak.github.io/marnthara-form/src/style.css">
                <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/bold/style.css">
                <style>#printable-content { display: block !important; } .pdf-page { border: 1px solid #eee; box-shadow: 0 0 10px rgba(0,0,0,0.1); margin: 10mm auto; } i.ph { vertical-align: middle; }</style>
            </head>
            <body>${e.html}</body></html>`,n=new Blob([t],{type:"text/html;charset=utf-8"}),r=URL.createObjectURL(n),a=document.createElement("a");a.href=r,a.download=`${e.fileName}.html`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(r),x("ดาวน์โหลดไฟล์ HTML สำเร็จ","success")}catch(t){console.error("HTML Export Error:",t),x("สร้างไฟล์ HTML ล้มเหลว","error")}}function Zt(e){if(!e)return;const t=e.closest(".item-card");if(!t)return;const n=g(e.value);let r,a;const s=e.getAttribute("name");if(s==="set_price_per_m"?(r=t.querySelector('input[name="fabric_code"]'),a="fabric"):s==="sheer_price_per_m"?(r=t.querySelector('input[name="sheer_fabric_code"]'),a="sheer"):s==="wallpaper_price_roll"?(r=t.querySelector('input[name="wallpaper_code"]'),a="wallpaper"):s==="area_price_sqyd"&&(r=t.querySelector('input[name="area_code"]'),r&&(a=r.dataset.favoriteType)),r&&a&&r.value.trim()){const o=tt(a,r.value);o&&o.price!==n&&(r.value="",z(r))}}function ut(e){const{roomId:t,itemIndex:n}=e.dataset;if(!t||n===void 0)return;const r=document.getElementById("lookbookModal");r&&r.classList.remove("visible");const a=document.getElementById(t);if(!a){x("ไม่พบห้องที่ต้องการ","error");return}const o=Array.from(a.querySelectorAll(".item-card:not(.item-hidden)"))[parseInt(n,10)];if(!o){x("ไม่พบรายการที่ต้องการ","error");return}a.open=!0,Y(),setTimeout(()=>{o.scrollIntoView({behavior:"smooth",block:"center"}),o.classList.add("scrolling-jump"),setTimeout(()=>o.classList.remove("scrolling-jump"),2500)},150)}const er=vt(e=>{e.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_price_per_m"]')&&Zt(e),ce(e),F()},200);function ze(e){var n,r;if(K){e.preventDefault();return}const t=e.target;if(t.matches('select[name="fabric_variant"]')){const a=t.closest(".set-item");if(a){const s=t.value,o=s==null?void 0:s.includes("โปร่ง");s==null||s.includes("ทึบ");const l=s==="โปร่ง",m=s==="ทึบ";(n=a.querySelector(b.sheerWrap))==null||n.classList.toggle("hidden",!o),(r=a.querySelector(b.sheerCodeWrap))==null||r.classList.toggle("hidden",!o);const i=a.querySelector('select[name="set_price_per_m"]'),d=a.querySelector('input[name="fabric_code"]'),u=a.querySelector('select[name="sheer_price_per_m"]'),c=a.querySelector('input[name="sheer_fabric_code"]');i&&(i.disabled=l),d&&(d.disabled=l),l&&(i&&(i.value=""),d&&(d.value="",z(d))),u&&(u.disabled=m),c&&(c.disabled=m),m&&(u&&(u.value=""),c&&(c.value="",z(c)))}}if(t.matches('select[name="set_style"]')){const a=t.closest(".set-item");a&&dt(a,t.value)}if(t.matches(b.roomNameInput)){const a=t.closest(".room-card");if(a){const s=a.querySelector("[data-room-name-display]");s&&(s.textContent=t.value||"ห้อง")}pe(),fe()}t.matches("input[data-favorite-type]")&&z(t),er(t)}function tr(e){const t=e.target;t.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_install_cost"]')?t.value=g(t.value)>0?M(g(t.value)):"":t.matches('input[name$="_m"], input[name$="width_m"]')&&(t.value=te(t.value))}function rr(e){const t=e.target;t.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_install_cost"]')&&g(t.value)>0&&(t.value=g(t.value))}const or=async e=>{var i,d,u;const t=e.target.closest(".summary-tag[data-filter-type]");if(t){const c=t.dataset.filterType,f=t.textContent.trim().replace(/\s*\d+\s*$/,""),h=document.querySelector("#overviewModal");h&&h.classList.remove("visible"),Ot(c,f);return}const n=e.target.closest(".fav-manager-item");if(n){const c=n.parentElement.querySelector(".is-selected");c&&c.classList.remove("is-selected"),c!==n?(n.classList.add("is-selected"),Ne(n)):Ne(null);return}const r=e.target.closest("[data-act]");if(!r)return;if(r.dataset.act==="jump-to-item"){ut(r);return}const a=["toggle-more-details","show-discount-modal","collapse-room","show-suspended-items","clear-filter"];if(K&&!r.closest(".unlockable")&&!a.includes(r.dataset.act))return;const s=r.dataset.act,o=r.closest(b.room),l=r.closest(".item-card"),m=(c,f,h)=>me(c,f).then(p=>p&&h());switch(s){case"add-room":ie();break;case"add-item":{if(Le=r.closest(b.room),Le){const h=await Xe("เพิ่มรายการใหม่");h&&Yt(h,Le)}break}case"collapse-room":o&&(e.preventDefault(),o.open=!1);break;case"clear-filter":e.stopPropagation(),at();break;case"show-suspended-items":Me();break;case"change-type":{const h=l==null?void 0:l.dataset.type;if(l&&h){const p=await Xe("เปลี่ยนประเภทรายการ",h);p&&p!==h&&m("ยืนยันการเปลี่ยนแปลง","ข้อมูลทั้งหมดในรายการนี้จะถูกลบและสร้างใหม่ คุณแน่ใจหรือไม่?",()=>Jt(l,p))}break}case"add-wall":{const h=Oe(r);h&&((i=h.querySelector('input[name="wall_width_m"]'))==null||i.focus());break}case"show-discount-modal":Ut();break;case"open-hardware-modal":{H=l,Vt();break}case"apply-hardware-to-room":{const h=r.closest("#hardwareModal"),p=H==null?void 0:H.closest(b.room);if(!h||!p)break;const y=h.querySelector('[name="modal_track_color"]').value,_=h.querySelector('[name="modal_bracket_color"]').value,v=h.querySelector('[name="modal_finial_color"]').value,S=h.querySelector('[name="modal_grommet_color"]').value;p.querySelectorAll(".set-item").forEach(w=>{w.querySelector('[name="track_color"]').value=y,w.querySelector('[name="bracket_color"]').value=_,w.querySelector('[name="finial_color"]').value=v,w.querySelector('[name="grommet_color"]').value=S}),F(),x("ใช้การตั้งค่ากับทุกรายการในห้องแล้ว","success");break}case"toggle-more-details":{Ht(e),Pe(l);break}case"show-favorites":{const h=r.closest(".form-group-with-favorites").querySelector("input[data-favorite-type]");h&&lt(h);break}case"toggle-favorite":{const h=r.closest(".form-group-with-favorites").querySelector("input[data-favorite-type]");if(!h||!l)break;const p=h.dataset.favoriteType,y=h.value;let _;p==="fabric"?_="set_price_per_m":p==="sheer"?_="sheer_price_per_m":p==="wallpaper"?_="wallpaper_price_roll":_="area_price_sqyd";const v=l.querySelector(`[name="${_}"]`),S=g(v==null?void 0:v.value);if(!y.trim()){x("โปรดระบุรหัสก่อนบันทึก","warning");break}if(S<=0&&p!=="fabric"&&p!=="sheer"){x("โปรดระบุราคาก่อนบันทึก","warning");break}const w=ke(p,y,S);r.classList.toggle("is-favorite",w),x(w?"เพิ่มในรายการโปรดแล้ว":"ลบออกจากรายการโปรด","success"),F();break}case"add-new-fav-form":{const p=r.closest("#favManagerModal").dataset.currentType;if(!p)break;const y=document.querySelector("#favAddModal");y.querySelector("h3").textContent=`เพิ่ม '${((d=se[p])==null?void 0:d.name)||p}'`;const _=y.querySelector('[name="fav_code_add"]'),v=y.querySelector('[name="fav_price_add"]');_.value="",v.value="";const S=await W("#favAddModal");if(S&&!S.cancelled){const w=_.value.trim(),q=g(v.value);w&&(ke(p,w,q),ue=!0,be(p),x("เพิ่มรายการโปรดแล้ว","success"))}break}case"edit-selected-fav":{if(!V)break;const p=r.closest("#favManagerModal").dataset.currentType;if(!p)break;const y=document.querySelector("#favEditModal");y.querySelector("h3").textContent=`แก้ไข '${V.code}'`;const _=y.querySelector('[name="fav_code_edit"]'),v=y.querySelector('[name="fav_price_edit"]');_.value=V.code,v.value=V.price>0?V.price:"";const S=await W("#favEditModal");if(S&&!S.cancelled){const w=_.value.trim(),q=g(v.value);w&&(w!==V.code&&Ie(p,V.code),ke(p,w,q),ue=!0,be(p),x("แก้ไขรายการโปรดแล้ว","success"))}break}case"del-selected-fav":{if(!V)break;const p=r.closest("#favManagerModal").dataset.currentType;if(!p)break;await me("ลบรายการโปรด",`ยืนยันการลบรหัส "${V.code}"?`)&&(Ie(p,V.code),ue=!0,be(p),x("ลบรายการโปรดแล้ว","success"));break}case"del-room":m("ลบห้อง","ยืนยันการลบห้องนี้?",()=>Ee(o,"ลบห้องแล้ว"));break;case"del-item":m("ลบรายการ","ยืนยันการลบรายการนี้?",()=>Ee(l,"ลบรายการแล้ว"));break;case"del-wall":m("ลบผนัง","ยืนยันการลบผนังนี้?",()=>Ee(r.closest(".wall-input-row"),"ลบผนังแล้ว",()=>ce(l)));break;case"clear-room":m("ล้างข้อมูลในห้อง","ยืนยันลบทุกรายการในห้องนี้?",()=>{oe(j()),Q(),o.querySelector(b.allItemsContainer).innerHTML="",ee(),G(),F(),x("ล้างข้อมูลในห้องแล้ว","success")});break;case"toggle-room-menu":e.preventDefault();const c=r.nextElementSibling;if(!c||!o)return;const f=!c.classList.contains("show");document.querySelectorAll(".room-options-menu.show").forEach(h=>h.classList.remove("show")),f&&c.classList.add("show");break;case"toggle-suspend-room":e.preventDefault(),o==null||o.classList.toggle("is-suspended"),(u=r.closest(".room-options-menu"))==null||u.classList.remove("show"),G(),F(),le==="suspended"&&Me();break;case"toggle-suspend":e.preventDefault(),l==null||l.classList.toggle("is-suspended"),ce(r),F(),le==="suspended"&&Me();break}};function nr(){K=!K,ct()}function sr(e){if(!e||e.closest(".modal-wrapper"))return;const t=e.getAttribute("name"),n=e.closest(".item-card"),s=(o=>{const l=o[t];if(!l)return null;const m=n||document;let i=null;return typeof l=="string"?i=m.querySelector(`[name="${l}"]:not(:disabled)`):typeof l=="function"&&(i=l(e)),!i&&n&&typeof l=="string"&&(i=document.querySelector(`[name="${l}"]:not(:disabled)`)),i})({customer_name:"customer_phone",customer_phone:"customer_address",customer_address:()=>document.querySelector(".room-name-input"),room_name:o=>{var l;return(l=o.closest(".room-card"))==null?void 0:l.querySelector('[data-act="add-item"]')},width_m:"height_m",height_m:"set_price_per_m",set_price_per_m:o=>{var i;const l=o.closest(".set-item"),m=(i=l==null?void 0:l.querySelector('[name="fabric_variant"]'))==null?void 0:i.value;return m!=null&&m.includes("โปร่ง")?l==null?void 0:l.querySelector('[name="sheer_price_per_m"]'):l==null?void 0:l.querySelector('[data-act="toggle-more-details"]')},sheer_price_per_m:o=>{var l;return(l=o.closest(".item-card"))==null?void 0:l.querySelector('[data-act="toggle-more-details"]')},area_width_m:"area_height_m",area_height_m:"area_price_sqyd",area_price_sqyd:"area_code",wall_width_m:o=>{var m,i;const l=(m=o.closest(".wall-input-row"))==null?void 0:m.nextElementSibling;return l!=null&&l.matches(".wall-input-row")?l.querySelector("input"):(i=o.closest(".item-card"))==null?void 0:i.querySelector('[name="wallpaper_price_roll"]')},wallpaper_price_roll:"wallpaper_height_m",wallpaper_height_m:"wallpaper_code"});s&&(s.focus(),typeof s.select=="function"&&s.select())}function ar(){const e=document.querySelector(b.setTpl);if(!e)return;const t=e.content.querySelector('select[name="set_price_per_m"]'),n=e.content.querySelector('select[name="sheer_price_per_m"]'),r=a=>{let s='<option value="" hidden>เลือกราคา</option>';return Array.isArray(a)?(a.forEach(o=>{s+=`<option value="${o}">${o.toLocaleString("th-TH")}</option>`}),s):(console.error("Price data for dropdown is not available or not an array.",a),s)};t&&(t.innerHTML=r(Se.fabric)),n&&(n.innerHTML=r(Se.sheer))}function lr(){ar(),st();const e=document.querySelector(b.orderForm),t=document.querySelector(b.fileImporter),n=document.querySelector("#favImporter"),r=document.querySelector(b.menuDropdown),a=document.querySelector(b.quickNavDropdown),s=document.querySelector("#pageBreakBuffer"),o=document.querySelector("#pageBreakBufferValue");s&&o&&s.addEventListener("input",()=>{o.textContent=s.value}),e.addEventListener("input",ze),e.addEventListener("change",ze),document.addEventListener("click",or),e.addEventListener("blur",tr,!0),e.addEventListener("focusin",rr,!0),e.addEventListener("focusin",i=>{const d=i.target.closest(".item-card");d&&Ce(d)},!0),e.addEventListener("keydown",i=>{const d=i.target;i.key==="Enter"&&!d.matches("textarea, button, [data-act]")&&(i.preventDefault(),sr(d))});const l=i=>{const d=i.target.closest(b.room);d&&it(d)};e.addEventListener("click",l),e.addEventListener("focusin",l),document.body.addEventListener("click",i=>{const d=i.target.closest("summary");if(d){const c=d.closest("details.card");setTimeout(()=>{Y(),F(),c&&c.open&&Ce(c)},50)}const u=i.target.closest('[data-act="jump-to-item"]');u&&ut(u)}),document.querySelector("#undoBtn").addEventListener("click",i=>{i.preventDefault(),Rt()}),document.querySelector(b.lockBtn).addEventListener("click",nr),document.querySelector(b.toggleAllRoomsBtn).addEventListener("click",Gt),document.querySelector(b.quickNavBtn).addEventListener("click",i=>{var u;i.stopPropagation(),r.classList.remove("show");const d=!a.classList.contains("show");a.classList.toggle("show"),i.currentTarget.setAttribute("aria-expanded",d),d&&((u=document.querySelector(b.menuBtn))==null||u.setAttribute("aria-expanded","false"))}),document.querySelector(b.quickNavRoomList).addEventListener("click",i=>{var u;const d=i.target.closest("a[data-jump-to]");if(d){i.preventDefault();const c=d.dataset.jumpTo,f=document.getElementById(c);f&&(document.body.classList.add("disable-animations"),f.open=!0,f.scrollIntoView({behavior:"auto",block:"start"}),f.classList.add("scrolling-jump"),setTimeout(()=>{f.classList.remove("scrolling-jump"),document.body.classList.remove("disable-animations"),Y()},1e3)),a.classList.remove("show"),(u=document.querySelector(b.quickNavBtn))==null||u.setAttribute("aria-expanded","false")}});const m=document.querySelector("#addRoomQuickNavBtn");if(m){const i=gt(ie,700);m.addEventListener("click",d=>{var u;d.stopPropagation(),i(),a.classList.remove("show"),(u=document.querySelector(b.quickNavBtn))==null||u.setAttribute("aria-expanded","false")})}document.querySelector(b.menuBtn).addEventListener("click",i=>{var u;i.stopPropagation(),a.classList.remove("show");const d=!r.classList.contains("show");r.classList.toggle("show"),i.currentTarget.setAttribute("aria-expanded",d),d&&((u=document.querySelector(b.quickNavBtn))==null||u.setAttribute("aria-expanded","false"))}),document.querySelector("#themeToggleBtn").addEventListener("click",i=>{i.preventDefault(),Pt()}),document.querySelector("#overviewBtn").addEventListener("click",async i=>{var f;i.preventDefault(),r.classList.remove("show"),(f=document.querySelector(b.menuBtn))==null||f.setAttribute("aria-expanded","false");const d=j(),u=document.querySelector("#overviewModalHeader"),c=document.querySelector("#overviewModalBody");if(u&&c){const h=d.rooms.reduce((_,v)=>{if(v.is_suspended)return _;const S=(v.items||[]).filter(w=>{if(w.is_suspended)return!1;let q=0;switch(w.type){case"set":q=B.calculateSetPrice(w).total;break;case"wallpaper":q=B.calculateWallpaperPrice(w).total;break;default:q=B.calculateDecoPrice(w).total;break}return q>0}).length;return _+S},0),p=document.querySelector(b.grandTotal).textContent||"0",y=d.rooms.filter(_=>!_.is_suspended&&_.items&&_.items.some(v=>!v.is_suspended)).length;u.innerHTML=`
                <div class="overview-stats-grid">
                    <div class="overview-stat-card">
                        <i class="ph-bold ph-map-pin-line"></i>
                        <div class="stat-value">${y}</div>
                        <div class="stat-label">ห้อง</div>
                    </div>
                    <div class="overview-stat-card">
                        <i class="ph-bold ph-stack"></i>
                        <div class="stat-value">${h}</div>
                        <div class="stat-label">รายการ</div>
                    </div>
                    <div class="overview-stat-card">
                        <i class="ph-bold ph-coins"></i>
                        <div class="stat-value">${p}</div>
                        <div class="stat-label">ยอดรวม</div>
                    </div>
                </div>
            `,c.innerHTML=Mt(d),W("#overviewModal")}}),document.querySelector(b.exportPdfBtn).addEventListener("click",async i=>{var f;i.preventDefault(),r.classList.remove("show"),(f=document.querySelector(b.menuBtn))==null||f.setAttribute("aria-expanded","false");const d=await Dt();if(!d)return;const u=j(),c=Et(u,{vatRate:d.vatOption==="include"?P.baseVatRate:0,pageBreakBuffer:d.pageBreakBuffer});if(!c){x("ไม่มีรายการที่มีราคาสำหรับสร้างเอกสาร","warning");return}d.exportMethod==="html"?zt(c):Xt(c,d.exportMethod)}),document.querySelector("#visualReportsBtn").addEventListener("click",async i=>{var d;i.preventDefault(),r.classList.remove("show"),(d=document.querySelector(b.menuBtn))==null||d.setAttribute("aria-expanded","false"),W("#visualReportsModal")}),document.querySelector("#visualReportsConfirm").addEventListener("click",async i=>{var c;i.preventDefault();const d=document.querySelector("#visualReportsModal"),u=(c=d.querySelector('input[name="report_type_option"]:checked'))==null?void 0:c.value;if(!u){x("โปรดเลือกประเภทรายงาน","warning");return}if(d.classList.remove("visible"),u==="lookbook"){const f=j(),h=It(f),p=document.querySelector("#lookbookModalBody");h&&p?(p.innerHTML=h,W("#lookbookModal")):x("ไม่มีข้อมูลสำหรับสร้างรายงาน","warning")}else x(`รายงานประเภท '${u}' ยังไม่พร้อมใช้งาน`,"default")}),document.querySelector(b.importBtn).addEventListener("click",i=>{var d;i.preventDefault(),r.classList.remove("show"),(d=document.querySelector(b.menuBtn))==null||d.setAttribute("aria-expanded","false"),t.click()}),t.addEventListener("change",i=>{var c;const d=(c=i.target.files)==null?void 0:c[0];if(!d)return;const u=new FileReader;u.onload=async f=>{try{const h=JSON.parse(f.target.result);await Ae(h,!0)}catch(h){x("ไฟล์ JSON ไม่ถูกต้อง","error"),console.error("JSON Parse Error:",h)}},u.readAsText(d),i.target.value=null}),document.querySelector(b.exportBtn).addEventListener("click",i=>{var d;i.preventDefault(),r.classList.remove("show"),(d=document.querySelector(b.menuBtn))==null||d.setAttribute("aria-expanded","false");try{const u=j(),c=JSON.stringify(u,null,4),f=new Blob([c],{type:"application/json"}),h=URL.createObjectURL(f),p=document.createElement("a"),y=new Date,_=`${y.getFullYear()}${(y.getMonth()+1).toString().padStart(2,"0")}${y.getDate().toString().padStart(2,"0")}`,v=`${y.getHours().toString().padStart(2,"0")}${y.getMinutes().toString().padStart(2,"0")}`,S=Ze(u.customer_name||"data");p.href=h,p.download=`MTR-${_}${v}-${S}.json`,p.click(),URL.revokeObjectURL(h),x("Export ข้อมูลสำเร็จ","success")}catch{x("Export ข้อมูลล้มเหลว","error")}}),document.querySelector("#importFavsBtn").addEventListener("click",i=>{var d;i.preventDefault(),r.classList.remove("show"),(d=document.querySelector(b.menuBtn))==null||d.setAttribute("aria-expanded","false"),n.click()}),n.addEventListener("change",i=>{var c;const d=(c=i.target.files)==null?void 0:c[0];if(!d)return;const u=new FileReader;u.onload=f=>{try{const h=JSON.parse(f.target.result),p=et(h);p>0?x(`เพิ่มรายการโปรดใหม่ ${p} รายการ`,"success"):x("ไม่พบรายการโปรดใหม่ที่จะเพิ่ม","default"),F()}catch(h){x("ไฟล์ JSON ไม่ถูกต้อง","error"),console.error("Favorites JSON Parse Error:",h)}},u.readAsText(d),i.target.value=null}),document.querySelector("#exportFavsBtn").addEventListener("click",i=>{var d;i.preventDefault(),r.classList.remove("show"),(d=document.querySelector(b.menuBtn))==null||d.setAttribute("aria-expanded","false");try{const u=Z(),c=JSON.stringify(u,null,4),f=new Blob([c],{type:"application/json"}),h=URL.createObjectURL(f),p=document.createElement("a"),y=new Date,_=`${y.getFullYear()}${(y.getMonth()+1).toString().padStart(2,"0")}${y.getDate().toString().padStart(2,"0")}`;p.href=h,p.download=`MTR-Favorites-${_}.json`,p.click(),URL.revokeObjectURL(h),x("Export รายการโปรดสำเร็จ","success")}catch{x("Export รายการโปรดล้มเหลว","error")}}),document.querySelector(b.submitBtn).addEventListener("click",async i=>{var d;if(i.preventDefault(),r.classList.remove("show"),(d=document.querySelector(b.menuBtn))==null||d.setAttribute("aria-expanded","false"),await me("ส่งข้อมูล","ยืนยันการส่งข้อมูลการประเมินราคา?")){const u=j();if(!u.customer_name&&!u.customer_phone){x("กรุณาระบุชื่อหรือเบอร์โทรลูกค้า","warning");return}x("กำลังส่งข้อมูล...","default");try{const c=await fetch(ft,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(u)});c.ok?x("ส่งข้อมูลสำเร็จ!","success"):x(`ส่งข้อมูลล้มเหลว: ${c.status}`,"error")}catch{x("เกิดข้อผิดพลาดในการเชื่อมต่อ","error")}}}),document.querySelector(b.copyTextBtn).addEventListener("click",async i=>{var c;i.preventDefault(),r.classList.remove("show"),(c=document.querySelector(b.menuBtn))==null||c.setAttribute("aria-expanded","false");const d=document.querySelector(b.copyOptionsModal);d.querySelector('input[name="copy_option"][value="customer"]').checked=!0;const u=await W(b.copyOptionsModal);if(u&&!u.cancelled){const f=d.querySelector('input[name="copy_option"]:checked').value,h=Tt(j(),f);try{await navigator.clipboard.writeText(h),x("คัดลอกสรุปสำเร็จ!","success")}catch{x("คัดลอกล้มเหลว","error")}}}),document.querySelector(b.clearItemsBtn).addEventListener("click",async i=>{var d;if(i.preventDefault(),r.classList.remove("show"),(d=document.querySelector(b.menuBtn))==null||d.setAttribute("aria-expanded","false"),await me("ล้างทุกรายการ","คุณแน่ใจหรือไม่ว่าต้องการลบรายการสินค้าและส่วนลดทั้งหมด (ข้อมูลลูกค้าและห้องจะยังคงอยู่)?")){oe(j()),Q(),document.querySelectorAll(b.room).forEach(f=>{const h=f.querySelector(b.allItemsContainer);h&&(h.innerHTML="")});const u=document.querySelector("#discount_type"),c=document.querySelector("#discount_value");u&&(u.value="amount"),c&&(c.value="0"),G(),F(),x("ล้างทุกรายการและส่วนลดแล้ว","success")}}),document.querySelector(b.clearAllBtn).addEventListener("click",async i=>{var d;if(i.preventDefault(),r.classList.remove("show"),(d=document.querySelector(b.menuBtn))==null||d.setAttribute("aria-expanded","false"),await me("ลบข้อมูลทั้งหมด",'คำเตือน! การกระทำนี้จะลบข้อมูลลูกค้า, ทุกรายการ, และ "รายการโปรด" ทั้งหมดอย่างถาวร ยืนยันหรือไม่?')){oe(j()),Q(),localStorage.removeItem(ge),St();const u=document.querySelector("#customer_name"),c=document.querySelector("#customer_phone"),f=document.querySelector("#customer_address");u&&(u.value=""),c&&(c.value=""),f&&(f.value="");const h=document.querySelector("#discount_type"),p=document.querySelector("#discount_value");h&&(h.value="amount"),p&&(p.value="0");const y=document.querySelector(b.roomsContainer);y&&(y.innerHTML=""),G(),pe(),Y(),ie();const _=document.querySelector("#customerDetailsCard");_&&(_.open=!0),x("ลบข้อมูลทั้งหมดแล้ว เริ่มต้นใหม่","success")}}),window.addEventListener("click",i=>{var d,u;i.target.closest(".modal-wrapper")||(i.target.closest(".menu-container")||(r.classList.contains("show")&&(r.classList.remove("show"),(d=document.querySelector(b.menuBtn))==null||d.setAttribute("aria-expanded","false")),a.classList.contains("show")&&(a.classList.remove("show"),(u=document.querySelector(b.quickNavBtn))==null||u.setAttribute("aria-expanded","false"))),i.target.closest(".room-options-container")||document.querySelectorAll(".room-options-menu.show").forEach(c=>c.classList.remove("show")),i.target.closest('[data-act="toggle-more-details"]')||document.querySelectorAll(".item-details-more.show").forEach(c=>{const f=c.closest(".item-card");f&&!f.contains(i.target)&&Pe(f,!1)}))}),window.addEventListener("beforeunload",F);try{const i=localStorage.getItem(ge);if(i&&i.length>2&&i!=="null")Ae(JSON.parse(i),!1);else{ie();const d=document.querySelector("#customerDetailsCard");d&&(d.open=!0)}}catch(i){console.error("Failed to load data from localStorage:",i),localStorage.removeItem(ge),ie()}G(),ct(),Y(),fe(),Q()}document.addEventListener("DOMContentLoaded",lr);
