(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))t(r);new MutationObserver(r=>{for(const l of r)if(l.type==="childList")for(const n of l.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&t(n)}).observe(document,{childList:!0,subtree:!0});function a(r){const l={};return r.integrity&&(l.integrity=r.integrity),r.referrerPolicy&&(l.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?l.credentials="include":r.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function t(r){if(r.ep)return;r.ep=!0;const l=a(r);fetch(r.href,l)}})();const ct="vite-refactor/6.0.0",it="https://your-make-webhook-url.com/your-unique-path",de="marnthara.input.v6",dt=500,F={name:"ม่านธารา ผ้าม่านและของตกแต่ง",address:"65/8 หมู่ 2 ต.ท่าศาลา อ.เมือง จ.ลพบุรี 15000",phone:"092-985-9395, 082-552-5595",taxId:"1600668000020",logoUrl:"./assets/logo.png",baseVatRate:.07,pdf:{paymentTerms:"ชำระมัดจำ 50%",priceValidity:"30 วัน",notes:["ราคานี้รวมค่าติดตั้งแล้ว","ชำระมัดจำ 50% เพื่อยืนยันการสั่งผลิตสินค้า","ใบเสนอราคานี้มีอายุ 30 วัน นับจากวันที่เสนอราคา"]}},ut=1.19599,Te={ROLL_WIDTH_M:.53,ROLL_LENGTH_M:10,STRIPS_PER_ROLL_UNDER_2_5M:3},_e={fabric:[1e3,1100,1200,1300,1400,1500,1600,1700,1800,1900,2e3,2100,2200],sheer:[1e3,1100,1200,1300,1400,1500],style_surcharge:{ลอน:200,ตาไก่:0,จีบ:0,ม่านพับ:0},height:[{threshold:3.2,add_per_m:300},{threshold:2.8,add_per_m:200},{threshold:2.5,add_per_m:100}]},N={set:{templateId:"#setTpl",name:"ผ้าม่าน"},wallpaper:{templateId:"#wallpaperTpl",name:"วอลล์เปเปอร์"},wooden_blind:{templateId:"#areaBasedTpl",name:"มู่ลี่ไม้"},roller_blind:{templateId:"#areaBasedTpl",name:"ม่านม้วน"},vertical_blind:{templateId:"#areaBasedTpl",name:"ม่านปรับแสง"},partition:{templateId:"#areaBasedTpl",name:"ฉากกั้นห้อง"},pleated_screen:{templateId:"#areaBasedTpl",name:"มุ้งจีบ"},aluminum_blind:{templateId:"#areaBasedTpl",name:"มู่ลี่อลูมิเนียม"}},v={orderForm:"#orderForm",roomsContainer:"#rooms",toastContainer:"#toast-container",printableContent:"#printable-content",filterStatusBar:"#filterStatusBar",menuBtn:"#menuBtn",menuDropdown:"#menuDropdown",undoBtn:"#undoBtn",themeToggleBtn:"#themeToggleBtn",overviewBtn:"#overviewBtn",copyTextBtn:"#copyTextBtn",visualReportsBtn:"#visualReportsBtn",exportPdfBtn:"#exportPdfBtn",submitBtn:"#submitBtn",importBtn:"#importBtn",exportBtn:"#exportBtn",importFavsBtn:"#importFavsBtn",exportFavsBtn:"#exportFavsBtn",clearItemsBtn:"#clearItemsBtn",clearAllBtn:"#clearAllBtn",lockBtn:"#lockBtn",quickNavBtn:"#quickNavBtn",quickNavDropdown:"#quickNavDropdown",quickNavRoomList:"#quickNavRoomList",quickNavBtnText:"#quickNavBtnText",toggleAllRoomsBtn:"#toggleAllRoomsBtn",suspendedItemsBtn:"#suspendedItemsBtn",suspendedCountBadge:"#suspendedCountBadge",originalTotal:"#originalTotal",grandTotal:"#grandTotal",fileImporter:"#fileImporter",favImporter:"#favImporter",customerCard:"#customerDetailsCard",customerNameInput:"#customer_name",customerPhoneInput:"#customer_phone",customerAddressInput:"#customer_address",room:".room-card",roomTpl:"#roomTpl",roomNameInput:'input[name="room_name"]',roomNameDisplay:"[data-room-name-display]",roomBrief:"[data-room-brief]",allItemsContainer:"[data-all-items]",itemCard:".item-card",itemDetailsMore:".item-details-more",itemGrid:".item-grid",itemTitle:"[data-item-title]",toggleDetailsBtn:'[data-act="toggle-more-details"]',setTpl:"#setTpl",setWidthInput:'input[name="width_m"]',setHeightInput:'input[name="height_m"]',setStyleSelect:'select[name="set_style"]',setFabricVariantSelect:'select[name="fabric_variant"]',setPricePerMSelect:'select[name="set_price_per_m"]',setSheerPricePerMSelect:'select[name="sheer_price_per_m"]',setFabricCodeInput:'input[name="fabric_code"]',setSheerCodeInput:'input[name="sheer_fabric_code"]',setOpeningStyleSelect:'select[name="opening_style"]',setAdjustmentSideSelect:'select[name="adjustment_side"]',setTrackColorInput:'input[name="track_color"]',setBracketColorInput:'input[name="bracket_color"]',setFinialColorInput:'input[name="finial_color"]',setGrommetColorInput:'input[name="grommet_color"]',setNotesInput:'input[name="notes"]',wallpaperTpl:"#wallpaperTpl",wallTpl:"#wallTpl",wallHeightInput:'[name="wallpaper_height_m"]',wallCodeInput:'[name="wallpaper_code"]',wallPriceRollInput:'[name="wallpaper_price_roll"]',wallInstallCostInput:'[name="wallpaper_install_cost"]',wallNotesInput:'[name="wallpaper_notes"]',wallWidthInput:'[name="wall_width_m"]',areaBasedTpl:"#areaBasedTpl",areaBasedItem:".area-based-item",areaWidthInput:'[name="area_width_m"]',areaHeightInput:'[name="area_height_m"]',areaPriceSqydInput:'[name="area_price_sqyd"]',areaCodeInput:'[name="area_code"]',areaNotesInput:'[name="area_notes"]',modal:"#confirmationModal",modalTitle:"#modalTitle",modalBody:"#modalBody",discountModal:"#discountModal",discountSubtotal:"#discountSubtotal",discountPercent:"#discountPercent",discountAmount:"#discountAmount",discountFinalTotal:"#discountFinalTotal",discountTypeInput:"#discount_type",discountValueInput:"#discount_value",copyOptionsModal:"#copyOptionsModal",visualReportsModal:"#visualReportsModal",lookbookModal:"#lookbookModal",lookbookModalBody:"#lookbookModalBody",exportOptionsModal:"#exportOptionsModal",itemTypeModal:"#itemTypeModal",itemTypeModalTitle:"#itemTypeModalTitle",hardwareModal:"#hardwareModal",modalTrackColor:'[name="modal_track_color"]',modalBracketColor:'[name="modal_bracket_color"]',modalFinialColor:'[name="modal_finial_color"]',modalGrommetColor:'[name="modal_grommet_color"]',finialColorGroup:"#finialColorGroup",grommetColorGroup:"#grommetColorGroup",hardwareApplyToRoomBtn:"#hardwareApplyToRoom",favoritesConflictModal:"#favoritesConflictModal",favoritesModal:"#favoritesModal",favoritesModalTitle:"#favoritesModalTitle",favoritesModalBody:"#favoritesModalBody",favSearchInput:"#favSearchInput",favoritesModalManageBtn:"#favoritesModalManageBtn",favSelectorItemTpl:"#favSelectorItemTpl",favInput:"input[data-favorite-type]",favManagerModal:"#favManagerModal",favManagerTitle:"#favManagerTitle",favManagerBody:"#favManagerBody",favManagerItemTpl:"#favManagerItemTpl",favManagerEditBtn:'#favManagerModal [data-act="edit-selected-fav"]',favManagerDelBtn:'#favManagerModal [data-act="del-selected-fav"]',favAddModal:"#favAddModal",favAddCodeInput:'[name="fav_code_add"]',favAddPriceInput:'[name="fav_price_add"]',favEditModal:"#favEditModal",favEditCodeInput:'[name="fav_code_edit"]',favEditPriceInput:'[name="fav_price_edit"]',overviewModal:"#overviewModal",overviewModalHeader:"#overviewModalHeader",overviewModalBody:"#overviewModalBody"},g=e=>{typeof e=="string"&&(e=e.replace(/,/g,""));const o=parseFloat(e);return Number.isFinite(o)?o:0},te=e=>{const o=g(e);return o>0?o.toFixed(2):""},U=(e,o=2,a=!1)=>Number.isFinite(e)?e.toLocaleString("en-US",{minimumFractionDigits:a?2:o,maximumFractionDigits:a?2:o}):"0",B=(e,o=0)=>Number.isFinite(e)?e.toLocaleString("th-TH",{minimumFractionDigits:o,maximumFractionDigits:o}):"0",me=(e,o=150)=>{let a;return(...t)=>{clearTimeout(a),a=setTimeout(()=>e(...t),o)}},pt=(e,o=700)=>{let a=!1;return(...t)=>{if(!a){a=!0;try{return e(...t)}finally{setTimeout(()=>{a=!1},o)}}}},L=e=>typeof e!="string"?"":e.replace(/[&<>"']/g,function(o){switch(o){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";default:return"&#039;"}}),Je=e=>typeof e!="string"?"":e.replace(/[\\/?%*:|"<>\x00-\x1f]/g,"").trim()||"file";function mt(e){let o=g(e);if(isNaN(o))return"ข้อมูลตัวเลขไม่ถูกต้อง";if(o===0)return"ศูนย์บาทถ้วน";const a=["","หนึ่ง","สอง","สาม","สี่","ห้า","หก","เจ็ด","แปด","เก้า"],t=["","สิบ","ร้อย","พัน","หมื่น","แสน","ล้าน"];let r=Math.floor(o),l=Math.round((o-r)*100);const n=d=>{if(d===0)return"";let i="";const m=String(d);for(let u=0;u<m.length;u++){const f=m[u],_=m.length-u-1;f!=="0"&&(_===1&&f==="1"?i+=t[_]:_===1&&f==="2"?i+="ยี่"+t[_]:_===0&&f==="1"&&m.length>1?i+="เอ็ด":i+=a[parseInt(f)]+t[_])}return i};let s="";if(r>0){const d=Math.floor(r/1e6),i=r%1e6;d>0&&(s+=n(d)+"ล้าน"),s+=n(i),s+="บาท"}let c="";return l>0?c=n(l)+"สตางค์":r>0&&(s+="ถ้วน"),(s+c).trim()}const Ne="marnthara.favorites.v4",ue={fabric:[],sheer:[],wallpaper:[],wooden_blind:[],roller_blind:[],vertical_blind:[],partition:[],pleated_screen:[],aluminum_blind:[]};function Z(){try{const e=localStorage.getItem(Ne);return e?{...ue,...JSON.parse(e)}:ue}catch(e){return console.error("Failed to parse favorites from localStorage",e),ue}}function Se(e){try{localStorage.setItem(Ne,JSON.stringify(e))}catch(o){console.error("Failed to save favorites to localStorage",o)}}function je(e){if(!e||typeof e!="object")return console.error("Invalid favorites data for import."),!1;const o={...ue,...e};return Se(o),!0}function Ee(e){if(!e||typeof e!="object")return console.error("Invalid favorites data for merge."),0;const o=Z();let a=0;for(const t in e)Object.hasOwnProperty.call(e,t)&&Array.isArray(e[t])&&(o[t]||(o[t]=[]),e[t].forEach(r=>{!o[t].some(n=>n.code===r.code)&&r.code&&(o[t].push(r),a++)}),o[t].sort((r,l)=>r.code.localeCompare(l.code)));return a>0&&Se(o),a}function ft(e,o,a){const t=Z();if(!t[e]){if(!Object.hasOwnProperty.call(ue,e))return console.error(`Attempted to add favorite to an invalid type: ${e}`),!1;t[e]=[]}const r=t[e],l=r.find(n=>n.code===o);return l?l.price=a:r.push({code:o,price:a}),r.sort((n,s)=>n.code.localeCompare(s.code)),Se(t),!0}function Ae(e,o){const a=Z();if(!a[e])return!1;const t=a[e].findIndex(r=>r.code===o);return t>-1?(a[e].splice(t,1),Se(a),!0):!1}function Ke(e,o){if(!e||!o)return;const a=Z(),t=o.trim();return(a[e]||[]).find(l=>l.code===t)}function Qe(e,o){return!!Ke(e,o)}function ge(e,o,a){return Qe(e,o)?(Ae(e,o),!1):(ft(e,o,a),!0)}function ht(){localStorage.removeItem(Ne),console.log("All favorites have been cleared.")}function V(){const e=Z(),o={app_version:ct,customer_name:document.querySelector(v.customerNameInput)?.value||"",customer_phone:document.querySelector(v.customerPhoneInput)?.value||"",customer_address:document.querySelector(v.customerAddressInput)?.value||"",customer_card_open:document.querySelector(v.customerCard)?.open,discount:{type:document.querySelector(v.discountTypeInput)?.value||"amount",value:g(document.querySelector(v.discountValueInput)?.value)},rooms:[],favorites:e};return document.querySelectorAll(v.room).forEach(a=>{const t={id:a.id,room_name:a.querySelector(v.roomNameInput)?.value||"",is_suspended:a.classList.contains("is-suspended"),is_open:a.open,items:[]};a.querySelector(v.allItemsContainer)?.childNodes.forEach(r=>{if(r.nodeType!==1||!r.matches(v.itemCard))return;const l=r.dataset.type;if(!l)return;let n={type:l,is_suspended:r.classList.contains("is-suspended")};l==="set"?Object.assign(n,{width_m:g(r.querySelector(v.setWidthInput)?.value),height_m:g(r.querySelector(v.setHeightInput)?.value),style:r.querySelector(v.setStyleSelect)?.value||"",fabric_variant:r.querySelector(v.setFabricVariantSelect)?.value||"",price_per_m_raw:g(r.querySelector(v.setPricePerMSelect)?.value),sheer_price_per_m:g(r.querySelector(v.setSheerPricePerMSelect)?.value),fabric_code:r.querySelector(v.setFabricCodeInput)?.value||"",sheer_fabric_code:r.querySelector(v.setSheerCodeInput)?.value||"",opening_style:r.querySelector(v.setOpeningStyleSelect)?.value||"",adjustment_side:r.querySelector(v.setAdjustmentSideSelect)?.value||"ปรับขวา",track_color:r.querySelector(v.setTrackColorInput)?.value||"ขาว",bracket_color:r.querySelector(v.setBracketColorInput)?.value||"ขาว",finial_color:r.querySelector(v.setFinialColorInput)?.value||"ขาว",grommet_color:r.querySelector(v.setGrommetColorInput)?.value||"เงิน",notes:r.querySelector(v.setNotesInput)?.value||""}):l==="wallpaper"?Object.assign(n,{height_m:g(r.querySelector(v.wallHeightInput)?.value),wallpaper_code:r.querySelector(v.wallCodeInput)?.value||"",price_per_roll:g(r.querySelector(v.wallPriceRollInput)?.value),install_cost_per_roll:g(r.querySelector(v.wallInstallCostInput)?.value),notes:r.querySelector(v.wallNotesInput)?.value||"",widths:Array.from(r.querySelectorAll(v.wallWidthInput)).map(s=>g(s.value))}):r.matches(v.areaBasedItem)&&(Object.assign(n,{width_m:g(r.querySelector(v.areaWidthInput)?.value),height_m:g(r.querySelector(v.areaHeightInput)?.value),price_sqyd:g(r.querySelector(v.areaPriceSqydInput)?.value),code:r.querySelector(v.areaCodeInput)?.value||"",notes:r.querySelector(v.areaNotesInput)?.value||""}),(l==="partition"||l==="pleated_screen")&&(n.opening_style=r.querySelector(v.setOpeningStyleSelect)?.value||"แยกกลาง"),["wooden_blind","roller_blind","vertical_blind","aluminum_blind"].includes(l)&&(n.adjustment_side=r.querySelector(v.setAdjustmentSideSelect)?.value||"ปรับขวา")),t.items.push(n)}),o.rooms.push(t)}),o}function j(){try{const e=V();localStorage.setItem(de,JSON.stringify(e))}catch(e){console.error("Failed to save data to localStorage:",e)}}const ae=[],vt=10;function le(e){if(!e){console.warn("Attempted to push invalid state to undo stack.");return}try{const o=JSON.parse(JSON.stringify(e));ae.push(o),ae.length>vt&&ae.shift()}catch(o){console.error("Failed to clone state for undo history:",o)}}function gt(){if(ae.length!==0)return ae.pop()}function yt(){return ae.length>0}const A={stylePlus:e=>_e.style_surcharge[e]??0,heightPlus:e=>{const o=[..._e.height].sort((a,t)=>t.threshold-a.threshold);for(const a of o)if(e>a.threshold)return a.add_per_m;return 0},fabricYardage:(e,o)=>{const a=g(o);return a<=0||!e?0:e==="ตาไก่"||e==="จีบ"?(a*2+.6)/.9:e==="ลอน"?(a*2.6+.6)/.9:e==="ม่านพับ"?(a+.3)/.9:0},calculateGrommets:function(e){if(!e||e.style!=="ตาไก่"||g(e.width_m)<=0)return 0;const o=g(e.width_m),a=2,t=.05,r=.16;let l;e.opening_style==="แยกกลาง"?l=o/2:l=o;const n=l*a+2*t;let s=Math.round(n/r);return s%2!==0&&(s+=1),s<4&&(s=4),e.opening_style==="แยกกลาง"?s*2:s},wallpaperRolls:(e,o)=>{const a=g(e),t=g(o);if(a<=0||t<=0)return 0;const r=t>2.5?Math.floor(Te.ROLL_LENGTH_M/t):Te.STRIPS_PER_ROLL_UNDER_2_5M;if(r<=0)return 0;const l=Math.ceil(a/Te.ROLL_WIDTH_M);return Math.ceil(l/r)},calculateSetPrice:function(e){if(!e||e.is_suspended||g(e.width_m)<=0)return{total:0,opaque:0,sheer:0};const o=this.stylePlus(e.style),a=this.heightPlus(g(e.height_m)),t=g(e.width_m),r=g(e.price_per_m_raw),l=g(e.sheer_price_per_m),n=e.fabric_variant?.includes("ทึบ")&&r>0?(r+o+a)*t:0,s=e.fabric_variant?.includes("โปร่ง")&&l>0?(l+o+a)*t:0;return{total:Math.round(n+s),opaque:Math.round(n),sheer:Math.round(s)}},calculateAreaBasedPrice:function(e){if(!e||e.is_suspended||g(e.width_m)<=0||g(e.height_m)<=0)return{total:0,sqm:0,sqyd:0};const o=g(e.width_m)*g(e.height_m),a=o*ut,t=a*g(e.price_sqyd);return{total:Math.round(t),sqm:o,sqyd:a}},calculateWallpaperPrice:function(e){if(!e||e.is_suspended)return{total:0,material:0,install:0,rolls:0,sqm:0};const o=e.widths?.reduce((s,c)=>s+g(c),0)||0;if(o<=0)return{total:0,material:0,install:0,rolls:0,sqm:0};const a=g(e.height_m),t=this.wallpaperRolls(o,a),r=t*g(e.price_per_roll),l=e.install_cost_per_roll===""||e.install_cost_per_roll===null||e.install_cost_per_roll===void 0?300:g(e.install_cost_per_roll),n=t*l;return{total:Math.round(r+n),material:Math.round(r),install:Math.round(n),rolls:t,sqm:o*a}}},oe=Object.entries(N).reduce((e,[o,a])=>(e[o]=a.name,e),{});function re(e){const{width:o=0,height:a=0}=e,t=15,r=100-t*2,l=100-t*2,n=o>0&&a>0?Math.min(r/o,l/a):1,s=o*n,c=a*n,d=(100-s)/2,i=(100-c)/2,m=`
        <line x1="${d}" y1="${i+c+5}" x2="${d+s}" y2="${i+c+5}" class="dimension-line" />
        <line x1="${d}" y1="${i+c+3}" x2="${d}" y2="${i+c+7}" class="dimension-tick" />
        <line x1="${d+s}" y1="${i+c+3}" x2="${d+s}" y2="${i+c+7}" class="dimension-tick" />
        <text x="50" y="${i+c+14}" class="dimension-text">${o.toFixed(2)} ม.</text>

        <line x1="${d-5}" y1="${i}" x2="${d-5}" y2="${i+c}" class="dimension-line" />
        <line x1="${d-7}" y1="${i}" x2="${d-3}" y2="${i}" class="dimension-tick" />
        <line x1="${d-7}" y1="${i+c}" x2="${d-3}" y2="${i+c}" class="dimension-tick" />
        <text x="${d-9}" y="50" class="dimension-text" transform="rotate(-90, ${d-9}, 50)">${a.toFixed(2)} ม.</text>
    `;return{x:d,y:i,svgWidth:s,svgHeight:c,lines:m}}function Xe(e,{y:o,svgHeight:a}){if(!e.opening_style||e.opening_style==="สไลด์เดี่ยว")return"";const t=e.opening_style==="แยกกลาง"?"< >":"→";return`
        <rect x="40" y="${o+a/2-8}" width="20" height="16" rx="3" class="opening-text-bg" />
        <text x="50" y="${o+a/2+1}" class="opening-text">${t}</text>
    `}function we(e,{x:o,y:a,svgWidth:t}){if(!e.adjustment_side)return"";const l=e.adjustment_side==="ปรับซ้าย"?o+8:o+t-8;return`
        <g class="adjustment-cord">
            <circle cx="${l}" cy="${a+3}" r="2"/>
            <line x1="${l}" y1="${a+5}" x2="${l}" y2="${a+15}"/>
        </g>
    `}function _t(e){const o=g(e.width_m),a=g(e.height_m);if(o<=0||a<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:t,y:r,svgWidth:l,svgHeight:n,lines:s}=re({width:o,height:a});let c="";const d=e.fabric_variant.includes("โปร่ง"),i=e.fabric_variant.includes("ทึบ"),m=(_,T)=>(e.opening_style||"แยกกลาง")==="แยกกลาง"?`
                <rect x="${t}" y="${r+T}" width="${l/2-1}" height="${n}" class="${_}" />
                <rect x="${t+l/2+1}" y="${r+T}" width="${l/2-1}" height="${n}" class="${_}" />
            `:`<rect x="${t}" y="${r+T}" width="${l}" height="${n}" class="${_}" />`;d&&(c+=m("curtain-panel-sheer",0)),i&&(c+=m("curtain-panel-opaque",d?-2:0));let u="";if(e.style==="ตาไก่"){const _=A.calculateGrommets(e)/(e.opening_style==="แยกกลาง"?2:1),T=Math.min(Math.floor(_),Math.max(8,Math.floor(l/8)));for(let y=0;y<T;y++){const p=t+l/(T>1?T-1:1)*y;u+=`<circle cx="${p}" cy="${r+2}" r="2" class="style-grommet" />`}}else if(e.style==="ลอน"){const _=Math.max(4,Math.floor(l/10));let T=`M ${t},${r}`;for(let y=0;y<_;y++)T+=" q 5,-4 10,0";u=`<path d="${T}" class="style-ripplefold-path" />`}else e.style==="จีบ"&&(u=`<text x="${t+2}" y="${r+5}" class="style-pleat-text">||| ||| ||| ||| |||</text>`);const f=Xe(e,{y:r,svgHeight:n});return`<svg viewBox="0 0 100 100">${c}${u}${f}${s}</svg>`}function bt(e){const o=g(e.width_m),a=g(e.height_m);if(o<=0||a<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:t,y:r,svgWidth:l,svgHeight:n,lines:s}=re({width:o,height:a});let c=`<rect x="${t}" y="${r}" width="${l}" height="${n}" class="blind-frame" />`;const d=5,i=n/d;for(let u=0;u<d;u++)c+=`<rect x="${t+1}" y="${r+u*i}" width="${l-2}" height="${i-1.5}" class="blind-slat" />`;const m=we(e,{x:t,y:r,svgWidth:l});return`<svg viewBox="0 0 100 100">${c}${s}${m}</svg>`}function We(e,o=!1){const a=g(e.width_m),t=g(e.height_m);if(a<=0||t<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:r,y:l,svgWidth:n,svgHeight:s,lines:c}=re({width:a,height:t});let d=`<rect x="${r}" y="${l}" width="${n}" height="${s}" class="blind-frame" />`;if(o){const m=Math.max(4,Math.floor(n/8)),u=n/m;for(let f=0;f<m;f++)d+=`<rect x="${r+f*u+1}" y="${l}" width="${u-2}" height="${s}" class="blind-slat" />`}else{const m=Math.max(3,Math.floor(s/6)),u=s/m;for(let f=0;f<m;f++)d+=`<rect x="${r+1}" y="${l+f*u+.5}" width="${n-2}" height="${u-1}" class="blind-slat" />`}const i=we(e,{x:r,y:l,svgWidth:n});return`<svg viewBox="0 0 100 100">${d}${c}${i}</svg>`}function St(e){const o=g(e.width_m),a=g(e.height_m);if(o<=0||a<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:t,y:r,svgWidth:l,svgHeight:n,lines:s}=re({width:o,height:a});let c=`<rect x="${t}" y="${r}" width="${l}" height="${n}" class="blind-frame" />`;const d=Math.max(3,Math.floor(n/8)),i=n/d;for(let y=0;y<d;y++)c+=`<rect x="${t+1}" y="${r+y*i}" width="${l-2}" height="${i-1.5}" rx="0.5" class="wooden-blind-slat" />`;const m=Math.max(2,l*.05),u=t+l*.25-m/2,f=t+l*.75-m/2,_=`
        <rect x="${u}" y="${r}" width="${m}" height="${n}" class="wooden-blind-strip" />
        <rect x="${f}" y="${r}" width="${m}" height="${n}" class="wooden-blind-strip" />
    `,T=we(e,{x:t,y:r,svgWidth:l});return`<svg viewBox="0 0 100 100">${c}${_}${s}${T}</svg>`}function wt(e){const o=g(e.width_m),a=g(e.height_m);if(o<=0||a<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:t,y:r,svgWidth:l,svgHeight:n,lines:s}=re({width:o,height:a}),c=`
        <rect x="${t}" y="${r}" width="${l}" height="${n}" class="roller-fabric" />
        <rect x="${t-1}" y="${r-4}" width="${l+2}" height="5" rx="2" class="roller-roll" />
        <line x1="${t}" y1="${r+n}" x2="${t+l}" y2="${r+n}" class="roller-bar" />
    `,d=we(e,{x:t,y:r-2,svgWidth:l});return`<svg viewBox="0 0 100 100">${c}${s}${d}</svg>`}function Ve(e,o=!1){const a=g(e.width_m),t=g(e.height_m);if(a<=0||t<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:r,y:l,svgWidth:n,svgHeight:s,lines:c}=re({width:a,height:t});let d="";if(o)d=`
            <defs>
                <pattern id="pleated-mesh" width="6" height="6" patternUnits="userSpaceOnUse">
                    <path d="M -1 1 L 1 -1 M 0 6 L 6 0" class="pleated-screen-mesh" />
                </pattern>
            </defs>
            <rect x="${r}" y="${l}" width="${n}" height="${s}" class="blind-frame" />
            <rect x="${r}" y="${l}" width="${n}" height="${s}" fill="url(#pleated-mesh)" />
        `;else{const m=Math.max(4,Math.floor(n/10)),u=n/m;for(let f=0;f<m;f++)d+=`<rect x="${r+f*u}" y="${l}" width="${u}" height="${s}" class="partition-panel" />`,f>0&&(d+=`<line x1="${r+f*u}" y1="${l}" x2="${r+f*u}" y2="${l+s}" class="partition-hinge" />`)}const i=Xe(e,{y:l,svgHeight:s});return`<svg viewBox="0 0 100 100">${d}${i}${c}</svg>`}function $t(e){const o=(e.widths||[]).reduce((u,f)=>u+g(f),0),a=g(e.height_m);if(o<=0||a<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:t,y:r,svgWidth:l,svgHeight:n,lines:s}=re({width:o,height:a});let c="";const d=Math.floor(l/10),i=Math.floor(n/10);for(let u=0;u<i;u++)for(let f=0;f<d;f++)c+=`<circle cx="${t+f*10+5}" cy="${r+u*10+5}" r="1.5" class="wallpaper-pattern" />`;return`<svg viewBox="0 0 100 100">${`<rect x="${t}" y="${r}" width="${l}" height="${n}" class="blind-frame" /> ${c}`}${s}</svg>`}function qt(e,o,a){let t="";switch(e.type){case"set":e.style==="ม่านพับ"?t=bt(e):t=_t(e);break;case"wooden_blind":t=St(e);break;case"aluminum_blind":t=We(e,!1);break;case"vertical_blind":t=We(e,!0);break;case"roller_blind":t=wt(e);break;case"partition":t=Ve(e,!1);break;case"pleated_screen":t=Ve(e,!0);break;case"wallpaper":t=$t(e);break;default:const r=oe[e.type]||"ของตกแต่ง";t=`<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">${L(r)}</text></svg>`;break}return`<div class="visual-placeholder is-clickable"
                 data-act="jump-to-item"
                 data-room-id="${o}"
                 data-item-index="${a}"
                 title="คลิกเพื่อไปยังรายการนี้">${t}</div>`}function Ue(e){let o=`
📃 *สรุปรายการสินค้า*
`,a=!1;return e.rooms.forEach(t=>{if(t.is_suspended||!t.items)return;const r=t.items.filter(n=>n.is_suspended?!1:n.type==="wallpaper"?(n.widths||[]).reduce((s,c)=>s+g(c),0)>0:n.type==="set"||N[n.type]?.templateId==="#areaBasedTpl"?g(n.width_m)>0:!0);if(r.length===0)return;a=!0,o+=`
*🚪 ห้อง: ${t.room_name||"ไม่ระบุ"}*
`;let l=0;r.forEach(n=>{l++;const s=oe[n.type]||"สินค้าตกแต่ง";n.type==="set"?o+=` ${l}) ${s} ${n.style||""} (${n.fabric_variant||""})
`:o+=` ${l}) ${s}
`})}),a?o+`------------------------------
`:""}function ze(e){return e.rooms.reduce((o,a)=>{if(a.is_suspended)return o;const t=a.items?.reduce((r,l)=>{if(l.is_suspended)return r;switch(l.type){case"set":return r+A.calculateSetPrice(l).total;case"wallpaper":return r+A.calculateWallpaperPrice(l).total;default:return N[l.type]?.templateId==="#areaBasedTpl"?r+A.calculateAreaBasedPrice(l).total:r}},0)||0;return o+t},0)}function kt(e,o){const a=ze(e);let t=0,r="";e.discount&&e.discount.value>0&&(e.discount.type==="percent"?(t=a*(e.discount.value/100),r=`🏷️ ส่วนลด (${e.discount.value}%): -${B(t)} บาท
`):(t=e.discount.value,r=`🏷️ ส่วนลด: -${B(t)} บาท
`));const l=a-t;let n=`🗓️ สรุปข้อมูล (${new Date().toLocaleDateString("th-TH",{day:"numeric",month:"short",year:"2-digit"})})
`;if(n+=`👤 ลูกค้า: ${e.customer_name||"-"}
`,(o==="customer"||o==="owner")&&(n+=`📞 โทร: ${e.customer_phone||"-"}
`,n+=`🏠 ที่อยู่: ${e.customer_address||"-"}
`),n+=`------------------------------
`,o==="customer")return n+=Ue(e),t>0&&(n+=`
ยอดรวม: ${B(a)} บาท
`,n+=r),n+=`
💰 *ยอดสุทธิ: ${B(l)} บาท*
`,n+=`
ขอบคุณที่ใช้บริการค่ะ
${F.name}
โทร: ${F.phone}`,n;if(o==="purchase_order"||o==="owner"){o==="owner"&&(n+=Ue(e));const s={opaqueFabrics:[],sheerFabrics:[],wallpapers:[],allSets:[]};e.rooms.forEach(p=>{p.is_suspended||!p.items||p.items.forEach(h=>{let k=!h.is_suspended;if(h.type==="set"||N[h.type]?.templateId==="#areaBasedTpl")k=k&&g(h.width_m)>0&&g(h.height_m)>0;else if(h.type==="wallpaper"){const b=(h.widths||[]).reduce((S,x)=>S+g(x),0);k=k&&b>0&&g(h.height_m)>0}if(k)switch(h.type){case"set":s.allSets.push(h),h.fabric_variant.includes("ทึบ")&&s.opaqueFabrics.push({code:h.fabric_code||"??",yards:A.fabricYardage(h.style,h.width_m)}),h.fabric_variant.includes("โปร่ง")&&s.sheerFabrics.push({code:h.sheer_fabric_code||"??",yards:A.fabricYardage(h.style,h.width_m)});break;case"wallpaper":const b=(h.widths||[]).reduce((x,w)=>x+g(w),0),S=A.wallpaperRolls(b,h.height_m);S>0&&s.wallpapers.push({code:h.wallpaper_code||"xxx",rolls:S});break;default:if(N[h.type]?.templateId==="#areaBasedTpl"){const x=h.type;s[x]||(s[x]=[]),s[x].push({code:h.code||"xxx",width:g(h.width_m),height:g(h.height_m),opening_style:h.opening_style,adjustment_side:h.adjustment_side})}break}})});const c={};if([...s.opaqueFabrics,...s.sheerFabrics].forEach(p=>{p.yards>0&&(c[p.code]=(c[p.code]||0)+p.yards)}),Object.keys(c).length>0){n+=`✂️ *รายการสั่งซื้อ (ผ้า)*
`,n+=`------------------------------
`,s.opaqueFabrics.filter(p=>p.yards>0).forEach(p=>{n+=`- ผ้าทึบ (Curtain)
`,n+=`  รหัส: #${p.code||"??"}
`,n+=`  จำนวน: ${p.yards.toFixed(2)} หลา

`}),s.sheerFabrics.filter(p=>p.yards>0).forEach(p=>{n+=`- ผ้าโปร่ง (Sheer)
`,n+=`  รหัส: #${p.code||"??"}
`,n+=`  จำนวน: ${p.yards.toFixed(2)} หลา

`}),n+=`------------------------------
`,n+=`📊 *สรุปยอดรวมผ้า (ตามรหัส)*
`,n+=`------------------------------
`;for(const[p,h]of Object.entries(c))n+=`  - รหัส #${p}: ${h.toFixed(2)} หลา
`;n+=`
`}const d=s.allSets.filter(p=>p.style==="ม่านพับ"),i=s.allSets.filter(p=>p.style==="ตาไก่"),m=s.allSets.filter(p=>p.style!=="ตาไก่"&&p.style!=="ม่านพับ");if(d.length>0){n+=`------------------------------
`,n+=`📏 *รายการสั่งซื้อ รางม่านพับ*
`,n+=`------------------------------

`;let p=1;d.forEach(b=>{n+=`(${p++}) รางม่านพับ
`,n+=`  - ขนาด: ${Number(b.width_m).toFixed(2)} ม.
`,n+=`  - สีราง: ${b.track_color||"ขาว"}
`,n+=`  - เชือกปรับ: ${b.adjustment_side||"ปรับขวา"}
`,b.notes&&o==="owner"&&(n+=`  📝 หมายเหตุ: ${b.notes}
`),n+=`
`});const h=d.reduce((b,S)=>{const x=Number(S.width_m).toFixed(2);return b[x]=(b[x]||0)+1,b},{}),k=Object.entries(h).sort((b,S)=>parseFloat(S[0])-parseFloat(b[0]));if(k.length>0){n+=`--- สรุปยอดรวมรางม่านพับ ---
`,n+=`*จำนวนรางที่ต้องตัด:*
`;for(const[b,S]of k)n+=`  - ขนาด ${b} ม. = ${S} เส้น
`;n+=`
`}}if(m.length>0){n+=`------------------------------
`,n+=`📏 *รายการสั่งซื้อ ราง (ลอน/จีบ)*
`,n+=`------------------------------

`;let p=1;m.forEach(S=>{n+=`(${p++}) ราง ${S.style}, สี: ${S.track_color||"ขาว"}
`,S.fabric_variant.includes("ทึบ")&&(n+=`  - รางทึบ: ${Number(S.width_m).toFixed(2)} ม.
`),S.fabric_variant.includes("โปร่ง")&&(n+=`  - รางโปร่ง: ${Number(S.width_m).toFixed(2)} ม.
`),S.notes&&o==="owner"&&(n+=`  📝 หมายเหตุ: ${S.notes}
`),n+=`
`});const h=[];m.forEach(S=>{S.fabric_variant.includes("ทึบ")&&h.push(Number(S.width_m)),S.fabric_variant.includes("โปร่ง")&&h.push(Number(S.width_m))});const k=h.reduce((S,x)=>{const w=x.toFixed(2);return S[w]=(S[w]||0)+1,S},{}),b=Object.entries(k).sort((S,x)=>parseFloat(x[0])-parseFloat(S[0]));if(b.length>0){n+=`--- สรุปยอดรวมรางลอน/จีบ ---
`,n+=`*จำนวนรางที่ต้องตัด:*
`;for(const[S,x]of b)n+=`  - ขนาด ${S} ม. = ${x} เส้น
`;n+=`
`}}if(i.length>0){n+=`------------------------------
`,n+=`📏 *รายการสั่งซื้อ ราง (ตาไก่)*
`,n+=`------------------------------

`;let p=1;i.forEach(w=>{n+=`(${p++}) ราง ${w.style}, สี: ${w.track_color||"ขาว"}
`,w.fabric_variant.includes("ทึบ")&&(n+=`  - รางทึบ: ${Number(w.width_m).toFixed(2)} ม.
`),w.fabric_variant.includes("โปร่ง")&&(n+=`  - รางโปร่ง: ${Number(w.width_m).toFixed(2)} ม.
`),w.notes&&o==="owner"&&(n+=`  📝 หมายเหตุ: ${w.notes}
`),n+=`
`}),n+=`--- สรุปยอดรวมรางตาไก่ ---
`;const h=[];i.forEach(w=>{w.fabric_variant.includes("ทึบ")&&h.push(Number(w.width_m)),w.fabric_variant.includes("โปร่ง")&&h.push(Number(w.width_m))});const k=6;h.sort((w,q)=>q-w);const b=[];for(const w of h){let q=!1;for(let M=0;M<b.length;M++)if(b[M]>=w-.001){b[M]-=w,q=!0;break}q||b.push(k-w)}n+=`ใช้รางเต็ม (6 ม.) ทั้งหมด: *${b.length} เส้น*

`;const S=h.reduce((w,q)=>{const M=q.toFixed(2);return w[M]=(w[M]||0)+1,w},{}),x=Object.entries(S).sort((w,q)=>parseFloat(q[0])-parseFloat(w[0]));if(x.length>0){n+=`*สรุปจำนวนรางที่ต้องตัด:*
`;for(const[w,q]of x)n+=`  - ขนาด ${w} ม. = ${q} เส้น
`;n+=`
`}}const u={};s.allSets.forEach(p=>{const h=p.track_color||"ขาว",k=p.style,b=p.fabric_variant==="ทึบ&โปร่ง",S=g(p.width_m)>=1.6?3:2;if(u[h]||(u[h]={brackets:{},finials:0,grommets:{}}),u[h].brackets[k]||(u[h].brackets[k]={single:0,double:0}),k!=="ม่านพับ"&&(b?u[h].brackets[k].double+=S:u[h].brackets[k].single+=S),k==="ตาไก่"){const x=b?4:2;u[h].finials+=x}if(k==="ตาไก่"){const x=p.grommet_color||"เงิน",w=A.calculateGrommets(p);u[h].grommets[x]||(u[h].grommets[x]=0),u[h].grommets[x]+=w}});const f=s.allSets.filter(p=>p.style!=="ม่านพับ").length*2;if(Object.values(u).some(p=>Object.values(p.brackets).some(h=>h.single>0||h.double>0)||p.finials>0||Object.values(p.grommets).some(h=>h>0))||f>0){n+=`------------------------------
`,n+=`🔩 *รายการสั่งซื้อ อุปกรณ์ (Hardware)*
`,n+=`------------------------------

`;for(const[p,h]of Object.entries(u)){let k=!1,b=`**สี${p}**
`;const S=Object.keys(h.brackets);if(S.length>0){let w="";S.forEach(q=>{q!=="ม่านพับ"&&(h.brackets[q].single>0||h.brackets[q].double>0)&&(w+=`    - ${q} (ชั้นเดียว): ${h.brackets[q].single} ตัว
`,w+=`    - ${q} (2ชั้น): ${h.brackets[q].double} ตัว
`)}),w&&(k=!0,b+=`  - ขาจับ:
${w}`)}h.finials>0&&(k=!0,b+=`  - หัวราง (ตาไก่): ${h.finials} ตัว
`);const x=Object.keys(h.grommets);if(x.length>0){let w="";x.forEach(q=>{const M=h.grommets[q];M>0&&(w+=`    - สี${q}: ${M} ตัว
`)}),w&&(k=!0,b+=`  - ตาไก่:
${w}`)}k&&(n+=b+`
`)}f>0&&(n+=`**อุปกรณ์รวม**
`,n+=`  - ตะขอรวบม่าน: ${f} ตัว

`)}const T=Object.keys(s).filter(p=>!["opaqueFabrics","sheerFabrics","wallpapers","allSets"].includes(p));T.length>0&&T.sort().forEach(p=>{const h=s[p],k=oe[p]||p;n+=`------------------------------
`,n+=`📦 *รายการสั่งซื้อ ${k}*
`,n+=`------------------------------

`,h.forEach(b=>{n+=`- รหัส: #${b.code||"xxx"}
  ขนาด: ${b.width.toFixed(2)} x ${b.height.toFixed(2)} ม.
`,b.opening_style&&(n+=`  รูปแบบเปิด: ${b.opening_style}
`),b.adjustment_side&&(n+=`  เชือกปรับ: ${b.adjustment_side}
`),n+=`
`})});const y={};if(s.wallpapers.forEach(p=>{y[p.code]=(y[p.code]||0)+p.rolls}),Object.keys(y).length>0){n+=`------------------------------
`,n+=`🎨 *รายการสั่งซื้อ (Wallpaper)*
`,n+=`------------------------------

`;for(const[p,h]of Object.entries(y))n+=`  - รหัส #${p}: ${h} ม้วน
`;n+=`
`}if(o==="purchase_order")return n+=`------------------------------
`,n}if(o==="seamstress"||o==="owner"){n+=`
🧵 *รายละเอียดสำหรับช่างเย็บผ้า*
`;let s=0;if(e.rooms.forEach(c=>{if(c.is_suspended||!c.items)return;const d=c.items.filter(i=>i.type==="set"&&!i.is_suspended&&g(i.width_m)>0&&g(i.height_m)>0);d.length!==0&&(s>0&&(n+=`==============================
`),n+=`
*🚪 ห้อง: ${c.room_name||"ไม่ระบุ"}*

`,d.forEach((i,m)=>{m>0&&(n+=`--------------------
`),n+=`*ชุดที่ ${m+1}/${d.length}: ${i.style} ${i.fabric_variant}*
`,i.style==="ม่านพับ"?n+=`  - เชือกปรับ: ${i.adjustment_side||"ปรับขวา"}
`:n+=`  - รูปแบบเปิด: ${i.opening_style||"แยกกลาง"}
`,i.fabric_variant.includes("ทึบ")&&(n+=`  - ผ้าทึบ: #${i.fabric_code||"-"}
`),i.fabric_variant.includes("โปร่ง")&&(n+=`  - ผ้าโปร่ง: #${i.sheer_fabric_code||"-"}
`),n+=`  - ขนาด: กว้าง ${Number(i.width_m).toFixed(2)} x สูง ${Number(i.height_m).toFixed(2)} ม.
`,i.notes&&o==="owner"&&(n+=`  📝 หมายเหตุ: ${i.notes}
`)}),n+=`
`,s++)}),s>0?n+=`==============================
`:n+=`ไม่มีรายการสำหรับช่าง
------------------------------
`,o==="seamstress")return n}return o==="owner"&&(n+=`
💰 *สรุปยอดรวม: ${B(l)} บาท*
`,t>0&&(n+=`   (ยอดก่อนลด: ${B(a)} บาท ${r.trim()})
`)),n}function xt(e){if(!e.rooms||e.rooms.length===0)return'<p class="empty-summary">ไม่มีข้อมูลสำหรับแสดงผล</p>';let o="";const a={};let t=0;if(e.rooms.forEach(n=>{n.is_suspended||!n.items||n.items.forEach(s=>{if(s.is_suspended)return;let c=null,d=0;switch(s.type){case"set":d=A.calculateSetPrice(s).total,d>0&&(c=s.type);break;case"wallpaper":d=A.calculateWallpaperPrice(s).total,d>0&&(c=s.type);break;default:N[s.type]?.templateId==="#areaBasedTpl"&&(d=A.calculateAreaBasedPrice(s).total,d>0&&(c=s.type));break}c&&(a[c]=(a[c]||0)+1,t++)})}),t>0){const n=Object.entries(a).map(([s,c])=>{const d=oe[s]||"ของตกแต่ง";return`
                <span class="summary-tag" data-filter-type="${L(s)}" title="คลิกเพื่อกรองเฉพาะรายการนี้">
                    ${L(d)} <strong>${c}</strong>
                </span>`}).join("");n&&(o+=`
                <div class="overview-summary-group">
                    <h4><i class="ph ph-stack"></i> สรุปประเภทรายการ</h4>
                    <div class="summary-tags-container">
                        ${n}
                    </div>
                </div>`)}let r="",l=0;return e.rooms.forEach(n=>{if(n.is_suspended||!n.items)return;const s={};let c=0;if(n.items.forEach(d=>{if(d.is_suspended)return;let i=null,m=0;switch(d.type){case"set":m=A.calculateSetPrice(d).total,m>0&&(i=d.type);break;case"wallpaper":m=A.calculateWallpaperPrice(d).total,m>0&&(i=d.type);break;default:N[d.type]?.templateId==="#areaBasedTpl"&&(m=A.calculateAreaBasedPrice(d).total,m>0&&(i=d.type));break}i&&(s[i]=(s[i]||0)+1,c++)}),c>0){l+=c;const d=Object.entries(s).map(([i,m])=>`
                    <div class="overview-item">
                        <span>${L(oe[i]||"ของตกแต่ง")}</span>
                        <span>${m}</span>
                    </div>`).join("");r+=`
                <details class="overview-room-card">
                    <summary class="overview-room-summary">
                        <span class="room-name">${L(n.room_name)||"ไม่ระบุชื่อห้อง"}</span>
                        <div class="summary-tags">
                            <span class="room-item-count">${c} รายการ</span>
                            <i class="ph ph-caret-down expand-icon"></i>
                        </div>
                    </summary>
                    <div class="overview-room-items">${d}</div>
                </details>`}}),r&&(o+=`
            <div class="overview-breakdown-group">
                <h4><i class="ph ph-map-pin-line"></i> แจกแจงตามห้อง</h4>
                ${r}
            </div>`),t===0&&l===0?'<p class="empty-summary">ไม่มีรายการที่มีราคาสำหรับแสดงผล</p>':o}function Tt(e,o){const{vatRate:a=F.baseVatRate,pageBreakBuffer:t=3}=o,r=[];e.rooms.forEach(q=>{if(q.is_suspended||!q.items)return;const M=[];q.items.forEach(I=>{if(I.is_suspended)return;let C="",E=0,R=0,P=0,ee=1;const ne=oe[I.type]||"สินค้าตกแต่ง";switch(I.type){case"set":E=A.calculateSetPrice(I).total,E>0&&(R=g(I.width_m),P=g(I.height_m),C=`${ne} ${L(I.style||"")} (${L(I.fabric_variant||"")}) <br><small>ขนาด ${R.toFixed(2)} x ${P.toFixed(2)} ม.${I.notes?` - ${L(I.notes)}`:""}</small>`,ee=1.5);break;case"wallpaper":if(E=A.calculateWallpaperPrice(I).total,E>0){const xe=(I.widths||[]).reduce((st,lt)=>st+g(lt),0),J=A.wallpaperRolls(xe,I.height_m);P=g(I.height_m),C=`${ne} <br><small>รหัส: ${L(I.wallpaper_code)||"-"}, สูง ${P.toFixed(2)} ม. (ใช้ ${J} ม้วน)</small>`,ee=1.5}break;default:N[I.type]?.templateId==="#areaBasedTpl"&&(E=A.calculateAreaBasedPrice(I).total,E>0&&(R=g(I.width_m),P=g(I.height_m),C=`${ne} <br><small>รหัส: ${L(I.code)||"-"}, ขนาด ${R.toFixed(2)} x ${P.toFixed(2)} ม.</small>`,ee=1.5));break}E>0&&C&&M.push({description:C,total:E,units:ee})}),M.length>0&&(r.push({isRoomHeader:!0,roomName:L(q.room_name)||"ไม่ระบุชื่อห้อง",units:1.2}),r.push(...M))});const l=r.reduce((q,M)=>q+(M.total||0),0);if(l===0)return null;let n=0,s="",c=l;e.discount&&e.discount.value>0&&(e.discount.type==="percent"?(n=l*(e.discount.value/100),s=`<tr><td class="pdf-label">ส่วนลด (${e.discount.value}%)</td><td class="pdf-amount">-${U(n,2,!0)}</td></tr>`):(n=e.discount.value,s=`<tr><td class="pdf-label">ส่วนลด</td><td class="pdf-amount">-${U(n,2,!0)}</td></tr>`),c=l-n);const d=c*a,i=c+d,m=17,u=23,f=[];let _=[],T=0;r.forEach((q,M)=>{const I=f.length===0?m:u,C=T+q.units>I;let E=!1;if(!C&&M<r.length-1){const R=I-(T+q.units),P=r[M+1].units||1;R>0&&R<t&&R<P&&(q.isRoomHeader&&R<1.5||(E=!0))}(C||E)&&_.length>0&&(f.push(_),_=[],T=0),_.push(q),T+=q.units}),_.length>0&&f.push(_);const y=new Date,p=y.toLocaleDateString("th-TH",{year:"numeric",month:"long",day:"numeric"}),h=`QT-${y.getFullYear()}${(y.getMonth()+1).toString().padStart(2,"0")}${y.getDate().toString().padStart(2,"0")}`;let k="",b=0,S=1;f.forEach((q,M)=>{const I=M===0,C=M===f.length-1,E=`
            <div class="pdf-page-header">
                <div class="pdf-header">
                    <div class="pdf-shop-info">
                        ${`<img src="${F.logoUrl}" alt="Logo" class="pdf-logo">`}
                        <div class="pdf-shop-address">
                            <strong><i class="ph ph-github-logo"></i> ${L(F.name)}</strong><br>
                            ${L(F.address).replace(/\n/g,"<br>")}<br>
                            โทร: ${L(F.phone)} | เลขประจำตัวผู้เสียภาษี: ${L(F.taxId)}
                        </div>
                    </div>
                    <div class="pdf-quote-details">
                        <div class="pdf-title-box"><h1>ใบเสนอราคา ${f.length>1?I?"":"(ต่อ)":""}</h1></div>
                        <table class="pdf-quote-meta">
                            <tr><td>เลขที่:</td><td>${h}</td></tr>
                            <tr><td>วันที่:</td><td>${p}</td></tr>
                        </table>
                    </div>
                </div>
                ${I?`
                <section class="pdf-customer-details">
                    <div class="pdf-customer-info">
                        <strong>ลูกค้า:</strong> ${L(e.customer_name)||"-"}<br>
                        <strong>ที่อยู่:</strong> ${L(e.customer_address||"-").replace(/\n/g,"<br>")}<br>
                        <strong>โทร:</strong> ${L(e.customer_phone)||"-"}
                    </div>
                    <div class="pdf-customer-meta">
                        <strong>เงื่อนไขชำระเงิน:</strong> ${L(F.pdf.paymentTerms)}<br>
                        <strong>ยืนราคา:</strong> ${L(F.pdf.priceValidity)}
                    </div>
                </section>`:""}
            </div>`,R=`
            <div class="pdf-page-footer">
                <div class="pdf-footer-info">
                    <span><i class="ph ph-github-logo"></i> ${L(F.name)} | โทร: ${L(F.phone)}</span>
                    <span>หน้า ${M+1} / ${f.length}</span>
                </div>
            </div>`;let P="";I||(P+=`<tr class="pdf-subtotal-row"><td colspan="4">ยอดยกมา (Brought Forward)</td><td class="pdf-text-right">${U(b,2,!0)}</td></tr>`),q.forEach(J=>{J.isRoomHeader?P+=`<tr class="pdf-room-header"><td colspan="5">ห้อง: ${J.roomName}</td></tr>`:(P+=`<tr><td class="pdf-text-center">${S++}</td><td>${J.description}</td><td class="pdf-text-center">1</td><td class="pdf-text-right">${U(J.total,2,!0)}</td><td class="pdf-text-right">${U(J.total,2,!0)}</td></tr>`,b+=J.total)});let ee="";C||(ee=`<tfoot><tr class="pdf-subtotal-row"><td colspan="4">ยอดยกไป (Carried Forward)</td><td class="pdf-text-right">${U(b,2,!0)}</td></tr></tfoot>`);let ne="";F.pdf.notes&&F.pdf.notes.length>0&&(ne=`
                <strong>หมายเหตุ:</strong>
                <ul>${F.pdf.notes.map(J=>`<li>${L(J)}</li>`).join("")}</ul>
            `);const xe=C?`
            <div class="pdf-summary-wrapper">
                <section class="pdf-summary-section">
                    <div class="pdf-amount-in-words">
                        ${ne}
                        <div class="pdf-amount-text">( ${mt(i)} )</div>
                    </div>
                    <div class="pdf-totals-block">
                        <table>
                            <tr><td class="pdf-label">รวมเป็นเงิน</td><td class="pdf-amount">${U(l,2,!0)}</td></tr>
                            ${s}
                            ${a>0?`<tr><td class="pdf-label">ภาษีมูลค่าเพิ่ม ${(a*100).toFixed(0)}%</td><td class="pdf-amount">${U(d,2,!0)}</td></tr>`:""}
                            <tr class="pdf-grand-total"><td class="pdf-label">ยอดรวมสุทธิ</td><td class="pdf-amount">${U(i,2,!0)}</td></tr>
                        </table>
                    </div>
                </section>
                <footer class="pdf-footer-section">
                    <div class="pdf-signature-box"><p>.................................................</p><p>ผู้เสนอราคา</p><p>(<i class="ph ph-github-logo"></i> ${L(F.name)})</p><p>วันที่: ${p}</p></div>
                    <div class="pdf-signature-box"><p>.................................................</p><p>ลูกค้า / ผู้มีอำนาจลงนาม</p><p>&nbsp;</p><p>วันที่: ......./......./............</p></div>
                </footer>
            </div>
        `:"";k+=`
            <div class="pdf-page">
                <div class="pdf-page-content">
                    ${E}
                    <div class="pdf-page-body">
                        <table class="pdf-items-table">
                            <thead><tr><th style="width:5%;">ลำดับ</th><th style="width:50%;">รายการ</th><th style="width:10%;">จำนวน</th><th style="width:17.5%;">ราคา/หน่วย</th><th style="width:17.5%;">รวม (บาท)</th></tr></thead>
                            <tbody>${P}</tbody>
                            ${ee}
                        </table>
                        ${xe}
                    </div>
                    ${R}
                </div>
            </div>`});const x=e.customer_name||"quote",w=Je(x);return{html:`<div id="quotation-template">${k}</div>`,fileName:`${h}_${w}`}}function Lt(e){const o=ze(e);let a=0;e.discount?.value>0&&(a=e.discount.type==="percent"?o*(e.discount.value/100):e.discount.value);const t=o-a;let r=!1,l=e.rooms.map(s=>{if(s.is_suspended)return"";const c=s.items.filter(i=>i.is_suspended?!1:i.type==="set"||N[i.type]?.templateId==="#areaBasedTpl"?g(i.width_m)>0&&g(i.height_m)>0:i.type==="wallpaper"?(i.widths||[]).reduce((u,f)=>u+g(f),0)>0&&g(i.height_m)>0:!1);if(c.length===0)return"";const d=c.map((i,m)=>{let u="",f="",_="";if(i.type!=="set"){const T=oe[i.type]||"ของตกแต่ง";f=`<h5 class="lookbook-item-title">${L(T)}</h5>`}switch(i.type){case"set":_=`<tr><td>ขนาด</td><td>${g(i.width_m).toFixed(2)} x ${g(i.height_m).toFixed(2)} ม.</td></tr>`,u=`
                        <tr><td>แบบ</td><td>${L(i.style||"")} (${L(i.fabric_variant||"")})</td></tr>
                        ${i.fabric_variant.includes("ทึบ")?`<tr><td>ทึบ</td><td>#${L(i.fabric_code)||"-"}</td></tr>`:""}
                        ${i.fabric_variant.includes("โปร่ง")?`<tr><td>โปร่ง</td><td>#${L(i.sheer_fabric_code)||"-"}</td></tr>`:""}
                    `,i.style==="ม่านพับ"?u+=`<tr><td>เชือก</td><td>${L(i.adjustment_side||"ปรับขวา")}</td></tr>`:u+=`<tr><td>เปิด</td><td>${L(i.opening_style||"แยกกลาง")}</td></tr>`;break;case"wallpaper":const T=(i.widths||[]).reduce((p,h)=>p+g(h),0),y=A.wallpaperRolls(T,i.height_m);_=`<tr><td>ขนาด</td><td>รวม ${T.toFixed(2)} ม., สูง ${g(i.height_m).toFixed(2)} ม.</td></tr>`,u=`
                        <tr><td>รหัส</td><td>#${L(i.wallpaper_code)||"-"}</td></tr>
                        <tr><td>ใช้</td><td>${y} ม้วน</td></tr>
                    `;break;default:N[i.type]?.templateId==="#areaBasedTpl"&&(_=`<tr><td>ขนาด</td><td>${g(i.width_m).toFixed(2)} x ${g(i.height_m).toFixed(2)} ม.</td></tr>`,u=`<tr><td>รหัส</td><td>#${L(i.code)||"-"}</td></tr>`,i.opening_style&&(u+=`<tr><td>เปิด</td><td>${L(i.opening_style)}</td></tr>`),i.adjustment_side&&(u+=`<tr><td>เชือก</td><td>${L(i.adjustment_side)}</td></tr>`));break}return u&&(r=!0),`
                 <div class="lookbook-details">
                    ${qt(i,s.id,m)}
                    <div class="spec-table-wrapper">
                        ${f}
                        <table class="spec-table">
                            ${u}
                            ${_}
                            ${i.notes?`<tr><td>โน้ต</td><td>${L(i.notes)}</td></tr>`:""}
                        </table>
                    </div>
                </div>
            `}).join('<hr class="lookbook-hr">');return d.trim()?`
            <div class="lookbook-room">
                <h4><i class="ph ph-map-pin"></i> ${L(s.room_name)||"ไม่ระบุชื่อห้อง"}</h4>
                ${d}
            </div>
        `:""}).join("");return r?`
        <div class="lookbook-summary">
            <div class="lookbook-customer-info">
                <strong>ลูกค้า:</strong> ${L(e.customer_name)||"-"}<br/>
                <strong>ที่อยู่:</strong> ${L(e.customer_address||"-").replace(/\n/g,"<br/>")}
            </div>
            <div class="lookbook-totals">
                <span>ยอดรวม (ก่อนส่วนลด): ${B(o)} บาท</span>
                ${a>0?`<span>ส่วนลด: -${B(a)} บาท</span>`:""}
                <span class="grand-total">ยอดสุทธิ: ${B(t)} บาท</span>
            </div>
        </div>
    `+l:'<p class="empty-summary">ไม่มีรายการสำหรับสร้างรายงาน</p>'}function Ze(e={}){const o=document.querySelector(v.roomTpl);if(!o)return console.error("Room template not found"),null;const t=o.content.cloneNode(!0).firstElementChild;t.id=e.id||`room-${Date.now()}`,t.open=e.is_open!==!1;const r=t.querySelector(v.roomNameInput),l=t.querySelector("[data-room-name-display]"),n=t.querySelector("[data-room-brief]"),s=t.querySelector(v.allItemsContainer),c=()=>{const m=r.value||"ห้อง (ไม่มีชื่อ)";l&&(l.textContent=m)};r&&r.addEventListener("input",c);const d=t.querySelector("summary");d&&d.addEventListener("click",()=>{});const i=e.room_name||`ห้อง ${document.querySelectorAll(v.room).length+1}`;if(r){r.value=i;const m=`room_name_${t.id}`;r.id=m;const u=r.closest(".form-group")?.querySelector("label");u&&u.setAttribute("for",m)}return l&&(l.textContent=i),e.is_suspended&&t.classList.add("is-suspended"),t.getItemsContainer=()=>s,t.updateBrief=m=>{n&&(n.innerHTML=m)},t}function Fe(e={}){const o=document.querySelector(v.setTpl);if(!o)return console.error("Set template not found"),null;const t=o.content.cloneNode(!0).firstElementChild;t.dataset.type="set";const r=t.querySelector('input[name="width_m"]'),l=t.querySelector('input[name="height_m"]'),n=t.querySelector('select[name="set_style"]'),s=t.querySelector('select[name="fabric_variant"]'),c=t.querySelector('select[name="set_price_per_m"]'),d=t.querySelector('select[name="sheer_price_per_m"]'),i=t.querySelector('input[name="fabric_code"]'),m=t.querySelector('input[name="sheer_fabric_code"]'),u=t.querySelector('select[name="opening_style"]'),f=t.querySelector('select[name="adjustment_side"]'),_=t.querySelector('input[name="notes"]'),T=t.querySelector('[data-set-control="opening_style_wrap"]'),y=t.querySelector('[data-set-control="adjustment_side_wrap"]'),p=t.querySelector("[data-sheer-wrap]"),h=t.querySelector("[data-sheer-code-wrap]"),k=t.querySelector("[data-set-summary]"),b=t.querySelector(".item-details-more"),S=t.querySelector('[data-act="toggle-more-details"]')?.parentElement,x=()=>({width_m:r.value,height_m:l.value,style:n.value,fabric_variant:s.value,price_per_m_raw:c.value,sheer_price_per_m:d.value,is_suspended:t.classList.contains("is-suspended")}),w=()=>{const C=x(),E=A.calculateSetPrice(C);t.dataset.totalPrice=E.total;let R=`ราคา: <b>${B(E.total)}</b> บ.`;E.opaque>0&&E.sheer>0&&(R+=` <small>(ทึบ: ${B(E.opaque)}, โปร่ง: ${B(E.sheer)})</small>`);const P=A.fabricYardage(C.style,C.width_m);P>0&&(R+=` &bull; ใช้ผ้า: ${P.toFixed(2)} หลา`),k?k.innerHTML=R:console.warn("Summary element not found for set item.")},q=me(()=>{w(),t.dispatchEvent(new CustomEvent("item-update",{bubbles:!0}))},200),M=()=>{const C=s.value,E=C.includes("โปร่ง"),R=C==="โปร่ง",P=C==="ทึบ";p?.classList.toggle("hidden",!E),h?.classList.toggle("hidden",!E),c.disabled=R,i.disabled=R,R&&(c.value="",i.value=""),d.disabled=P,m.disabled=P,P&&(d.value="",m.value="")},I=()=>{const E=n.value==="ม่านพับ";T&&T.classList.toggle("hidden",E),y&&y.classList.toggle("hidden",!E)};if(t.addEventListener("input",C=>{C.target===s&&M(),C.target===n&&I(),q()}),b&&S){const C=t.querySelector(".item-grid");C&&C.appendChild(S)}return r.value=te(e.width_m),l.value=te(e.height_m),n.value=e.style||"ลอน",s.value=e.fabric_variant||"ทึบ",c.value=e.price_per_m_raw||"",d.value=e.sheer_price_per_m||"",i.value=e.fabric_code||"",m.value=e.sheer_fabric_code||"",u.value=e.opening_style||"แยกกลาง",f.value=e.adjustment_side||"ปรับขวา",_.value=e.notes||"",t.querySelector('input[name="track_color"]').value=e.track_color||"ขาว",t.querySelector('input[name="bracket_color"]').value=e.bracket_color||"ขาว",t.querySelector('input[name="finial_color"]').value=e.finial_color||"ขาว",t.querySelector('input[name="grommet_color"]').value=e.grommet_color||"เงิน",e.is_suspended&&t.classList.add("is-suspended"),M(),I(),w(),t}function Pe(e={}){const o=document.querySelector(v.wallTpl);if(!o)return null;const t=o.content.cloneNode(!0).firstElementChild,r=t.querySelector('input[name="wall_width_m"]');r.value=te(e.width);const l=`wall_width_${Date.now()}_${Math.random().toString(36).substring(2,7)}`;r.id=l;const n=t.querySelector("label");return n&&n.setAttribute("for",l),t}function He(e={}){const o=document.querySelector(v.wallpaperTpl);if(!o)return console.error("Wallpaper template not found"),null;const t=o.content.cloneNode(!0).firstElementChild;t.dataset.type="wallpaper";const r=t.querySelector('[name="wallpaper_height_m"]'),l=t.querySelector('[name="wallpaper_price_roll"]'),n=t.querySelector('[name="wallpaper_install_cost"]'),s=t.querySelector('[name="wallpaper_code"]'),c=t.querySelector('[name="wallpaper_notes"]'),d=t.querySelector("[data-walls-container]"),i=t.querySelector("[data-wallpaper-summary]"),m=t.querySelector(".item-details-more"),u=t.querySelector('[data-act="toggle-more-details"]')?.parentElement,f=()=>({height_m:r.value,price_per_roll:l.value,install_cost_per_roll:n.value,widths:Array.from(d.querySelectorAll('input[name="wall_width_m"]')).map(y=>y.value),is_suspended:t.classList.contains("is-suspended")}),_=()=>{const y=f(),p=A.calculateWallpaperPrice(y);t.dataset.totalPrice=p.total;let h=`รวม: <b>${B(p.total)}</b> บ. `;(p.material>0||p.install>0)&&(h+=`<small>(วอลล์: ${B(p.material)}, ค่าช่าง: ${B(p.install)})</small>`),p.rolls>0&&(h+=` &bull; พื้นที่: ${U(p.sqm,2)} ตร.ม. &bull; ใช้: ${p.rolls} ม้วน`),i&&(i.innerHTML=h)},T=me(()=>{_(),t.dispatchEvent(new CustomEvent("item-update",{bubbles:!0}))},200);if(t.addEventListener("input",T),m&&u){const y=t.querySelector(".item-grid");y&&y.appendChild(u)}if(e.widths&&e.widths.length>0)e.widths.forEach(y=>{const p=Pe({width:y});p&&d.appendChild(p)});else{const y=Pe();y&&d.appendChild(y)}return r.value=te(e.height_m),l.value=e.price_per_roll>0?B(e.price_per_roll):"",n.value=e.hasOwnProperty("install_cost_per_roll")?e.install_cost_per_roll>0?B(e.install_cost_per_roll):e.install_cost_per_roll===0?"0":"":n.value,s.value=e.wallpaper_code||"",c.value=e.notes||"",e.is_suspended&&t.classList.add("is-suspended"),_(),t}function Oe(e,o={}){const a=document.querySelector(v.areaBasedTpl);if(!a)return console.error("AreaBased template not found"),null;const r=a.content.cloneNode(!0).firstElementChild;r.dataset.type=e;const l=N[e]||{name:"ของตกแต่ง"};r.classList.add(`${e.replace(/_/g,"-")}-item`);const n=r.querySelector(".item-type-display"),s=r.querySelector('[name="area_width_m"]'),c=r.querySelector('[name="area_height_m"]'),d=r.querySelector('[name="area_price_sqyd"]'),i=r.querySelector('[name="area_code"]'),m=r.querySelector('[name="area_notes"]'),u=r.querySelector(".btn-favorite"),f=r.querySelector(".btn-show-favs"),_=r.querySelector("[data-area-summary]"),T=r.querySelector(".item-details-more"),y=r.querySelector('[data-act="toggle-more-details"]')?.parentElement,p=T?.querySelector(".item-grid"),h=p?.querySelector('[name="area_price_sqyd"]')?.closest(".form-group");let k,b;if(p&&h){if(e==="partition"||e==="pleated_screen"){const q=document.createElement("div");q.className="form-group",q.innerHTML=`
                <label>รูปแบบเปิด
                    <select name="opening_style">
                        <option value="แยกกลาง">แยกกลาง</option>
                        <option value="เก็บข้างเดียว">เก็บข้างเดียว</option>
                    </select>
                </label>
            `,p.insertBefore(q,h),k=q.querySelector("select")}else if(["wooden_blind","roller_blind","vertical_blind","aluminum_blind"].includes(e)){const q=document.createElement("div");q.className="form-group",q.innerHTML=`
                <label>เชือกปรับ
                    <select name="adjustment_side">
                        <option value="ปรับขวา">ปรับขวา</option>
                        <option value="ปรับซ้าย">ปรับซ้าย</option>
                    </select>
                </label>
            `,p.insertBefore(q,h),b=q.querySelector("select")}(k||b)&&h&&h.classList.remove("full-width-item")}const S=()=>({width_m:s.value,height_m:c.value,price_sqyd:d.value,is_suspended:r.classList.contains("is-suspended")}),x=()=>{const q=S(),M=A.calculateAreaBasedPrice(q);r.dataset.totalPrice=M.total;const I=M.sqyd>0?` &bull; พื้นที่: ${U(M.sqyd,2)} ตร.หลา`:"";_&&(_.innerHTML=`ราคา: <b>${B(M.total)}</b> บ.${I}`)},w=me(()=>{x(),r.dispatchEvent(new CustomEvent("item-update",{bubbles:!0}))},200);if(r.addEventListener("input",w),T&&y){const q=r.querySelector(".item-grid");q&&q.appendChild(y)}return n&&(n.textContent=l.name),i&&(i.dataset.favoriteType=e),u&&(u.dataset.type=e),f&&(f.dataset.type=e),s.value=te(o.width_m),c.value=te(o.height_m),d.value=o.price_sqyd>0?B(o.price_sqyd):"",i.value=o.code||"",m.value=o.notes||"",k&&(k.value=o.opening_style||"แยกกลาง"),b&&(b.value=o.adjustment_side||"ปรับขวา"),o.is_suspended&&r.classList.add("is-suspended"),x(),r}let G=!1,he=null,O=null,ce=null,pe=!1,H=null,Le=!1,z=null,Ge;const Ye=document.querySelector("#undoBtn"),Re="marnthara.theme",ve={};function It(e){if(ve[e])return ve[e];const o=new Promise((a,t)=>{const r=document.createElement("script");r.src=e,r.onload=()=>a(),r.onerror=()=>{console.error(`Script load error for ${e}`),delete ve[e],t(new Error(`Script load error for ${e}`))},document.head.appendChild(r)});return ve[e]=o,o}function et(){const e=localStorage.getItem(Re),o=document.querySelector("#themeToggleBtn");if(!o)return;const a=o.querySelector("i"),t=o.querySelector("span");switch(document.body.classList.remove("dark-theme","neutral-theme"),e){case"dark":document.body.classList.add("dark-theme"),a&&(a.className="ph-fill ph-sun"),t&&(t.textContent=" สว่าง");break;case"neutral":document.body.classList.add("neutral-theme"),a&&(a.className="ph-fill ph-moon"),t&&(t.textContent=" มืด");break;default:a&&(a.className="ph-fill ph-palette"),t&&(t.textContent=" กลาง");break}}function Mt(){const e=localStorage.getItem(Re);let o="neutral";!e||e==="light"?o="neutral":e==="neutral"?o="dark":o="light",localStorage.setItem(Re,o),et()}function Q(){Ye&&(Ye.disabled=!yt())}function Bt(){const e=gt();e&&(De(e,!1),$("ยกเลิกการกระทำล่าสุดแล้ว","success")),Q()}function $e(){clearTimeout(Ge),document.documentElement.classList.add("scrolling-programmatically"),Ge=setTimeout(()=>{document.documentElement.classList.remove("scrolling-programmatically")},1e3)}function ie(){const e=document.getElementById("suspendedItemsBtn");if(!e)return;if(ce){e.classList.remove("is-visible");return}const o=document.getElementById("suspendedCountBadge"),a=document.querySelectorAll(".item-card.is-suspended").length,t=document.querySelectorAll(".room-card.is-suspended");let r=0;t.forEach(n=>{r+=n.querySelectorAll(".item-card:not(.is-suspended)").length});const l=a+r;o&&(o.textContent=l),e.classList.toggle("is-visible",l>0)}function Ie(){ce="suspended";const e=document.getElementById("filterStatusBar");let o=0;if(document.querySelectorAll(".room-card").forEach(a=>{let t=!1;const r=a.classList.contains("is-suspended");a.querySelectorAll(".item-card").forEach(n=>{const c=n.classList.contains("is-suspended")||r;n.classList.toggle("item-hidden",!c),c&&(t=!0,o++)});const l=r||t;a.classList.toggle("item-hidden",!l)}),o===0){tt(),$("ไม่มีรายการที่ถูกระงับแล้ว","success");return}e&&(e.innerHTML=`
            <span><i class="ph ph-warning"></i> รายการที่ถูกระงับ (${o} รายการ)</span>
            <button type="button" class="btn-chip" data-act="clear-filter" title="ยกเลิกการกรอง">
                <i class="ph ph-x"></i>&nbsp;ปิด
            </button>
        `,e.classList.add("is-visible"),e.dataset.filterType="suspended"),X(),Y(),ie()}function Ct(e,o){if(!e)return;ce=e;const a=document.getElementById("filterStatusBar");let t=0;document.querySelectorAll(v.room).forEach(r=>{let l=0;r.querySelectorAll(".item-card").forEach(n=>{const s=n.dataset.type===e;n.classList.toggle("item-hidden",!s),s&&l++}),r.classList.toggle("item-hidden",l===0),l>0&&(t+=l)}),a&&(a.innerHTML=`
            <span>เฉพาะ: <strong>${L(o)}</strong> (${t} รายการ)</span>
            <button type="button" class="btn-chip" data-act="clear-filter" title="ยกเลิกการกรอง">
                <i class="ph ph-x"></i>&nbsp;ปิด
            </button>
        `,a.classList.add("is-visible"),a.dataset.filterType=e),X(),Y(),ie()}function tt(){ce=null;const e=document.getElementById("filterStatusBar");e&&(e.classList.remove("is-visible"),e.innerHTML="",e.removeAttribute("data-filter-type")),document.querySelectorAll(".item-hidden").forEach(o=>o.classList.remove("item-hidden")),X(),Y(),ie()}function $(e,o="default"){const a=document.querySelector(v.toastContainer);if(!a)return;const t={success:"ph-bold ph-check-circle",warning:"ph-bold ph-warning",error:"ph-bold ph-x-circle",default:"ph-bold ph-info"},r=document.createElement("div");r.className=`toast toast-${o}`,r.innerHTML=`<i class="${t[o]||t.default}"></i> ${L(e)}`,a.appendChild(r),setTimeout(()=>r.classList.add("show"),10),setTimeout(()=>{r.classList.remove("show"),r.addEventListener("transitionend",()=>r.remove())},3e3)}function W(e,o){return new Promise(a=>{const t=document.querySelector(e);if(!t){a(null);return}const r=document.querySelector(".modal-wrapper.visible:not(.is-underlay)");r&&r!==t&&r.classList.add("is-underlay"),t.classList.add("visible");const l=t.querySelector('[id$="Confirm"]'),n=t.querySelector('[id$="Cancel"], [data-act="close-modal"]'),s=Array.from(t.querySelectorAll('button, [href], input:not([type="hidden"]), select, textarea, [tabindex]:not([tabindex="-1"])')).filter(f=>!f.disabled&&f.offsetParent!==null),c=s[0],d=s[s.length-1];setTimeout(()=>c?.focus(),50);const i=f=>{t.classList.remove("visible"),document.removeEventListener("keydown",m),t.removeEventListener("click",u),l&&(l.onclick=null),n&&(n.onclick=null);const _=document.querySelector(".modal-wrapper.visible:not(.is-underlay)");_?_.classList.remove("is-underlay"):r&&r!==t&&r.classList.remove("is-underlay"),f?.cancelled&&typeof o=="function"&&o(),a(f)},m=f=>{f.key==="Escape"&&!t.classList.contains("is-underlay")&&i({cancelled:!0}),f.key==="Tab"&&s.length>1&&(f.shiftKey?document.activeElement===c&&(d.focus(),f.preventDefault()):document.activeElement===d&&(c.focus(),f.preventDefault()))},u=f=>{f.target===t&&!t.classList.contains("is-underlay")&&(f.stopPropagation(),i({cancelled:!0}))};l&&(l.onclick=()=>i(!0)),n&&(n.onclick=()=>{t.classList.contains("is-underlay")||i({cancelled:!0})}),document.addEventListener("keydown",m),t.addEventListener("click",u)})}async function K(e,o){const a=document.querySelector(v.modal);return a?(a.querySelector(v.modalTitle).textContent=e,a.querySelector(v.modalBody).textContent=o,await W(v.modal)===!0):!0}async function Et(){const e=document.querySelector(v.exportOptionsModal);if(!e)return null;const o=e.querySelector("#pageBreakBuffer"),a=e.querySelector("#pageBreakBufferValue");o&&a&&(a.textContent=o.value,o.oninput=()=>{a.textContent=o.value});const t=await W(v.exportOptionsModal);return o&&(o.oninput=null),!t||t.cancelled?null:{vatOption:e.querySelector('input[name="vat_option"]:checked')?.value||"include",exportMethod:e.querySelector("#exportMethod")?.value||"direct",pageBreakBuffer:parseInt(o?.value,10)||3}}async function At(){const e=document.querySelector("#discountModal");if(!e)return;const o=e.querySelector("#discountSubtotal"),a=e.querySelector("#discountPercent"),t=e.querySelector("#discountAmount"),r=e.querySelector("#discountFinalTotal"),l=document.querySelector("#discount_type"),n=document.querySelector("#discount_value"),s=g(document.querySelector("#originalTotal").dataset.rawTotal||document.querySelector("#grandTotal").textContent);o&&(o.textContent=B(s));const c=y=>{if(Le)return;Le=!0;let p=0;if(y==="percent"){const h=g(a.value);p=s*(Math.max(0,h)/100),t.value=p>0?B(Math.round(p)):""}else p=g(t.value);if(p=Math.max(0,Math.min(p,s)),y!=="percent"){const h=s>0?p/s*100:0;a.value=h>0&&isFinite(h)?U(h,2):""}r&&(r.textContent=B(s-p)),setTimeout(()=>{Le=!1},50)},d=()=>c("percent"),i=()=>c("amount"),m=y=>{g(y.target.value)>0&&(y.target.value=g(y.target.value))},u=y=>{const p=g(y.target.value);y.target.value=p>0?B(p):"",c("amount")};a.addEventListener("input",d),t.addEventListener("input",i),t.addEventListener("focus",m),t.addEventListener("blur",u);const f=l.value,_=g(n.value);a.value="",t.value="",_>0?f==="percent"?(a.value=_,c("percent")):(t.value=_,t.value=B(_),c("amount")):c();const T=await W("#discountModal");if(a.removeEventListener("input",d),t.removeEventListener("input",i),t.removeEventListener("focus",m),t.removeEventListener("blur",u),T&&!T.cancelled){const y=g(a.value),p=g(t.value),h=document.activeElement;y>0&&h===a?(l.value="percent",n.value=y):p>0?(l.value="amount",n.value=p):y>0?(l.value="percent",n.value=y):(l.value="amount",n.value=0),D()}}async function Pt(){if(!O)return;const e=document.querySelector("#hardwareModal");if(!e)return;const o=O.querySelector('[name="set_style"]'),a=o?o.value:null,t=a==="ตาไก่",r=a==="ม่านพับ";e.querySelector('[name="modal_track_color"]').value=O.querySelector('[name="track_color"]')?.value||"ขาว",e.querySelector('[name="modal_bracket_color"]').value=O.querySelector('[name="bracket_color"]')?.value||"ขาว",e.querySelector('[name="modal_finial_color"]').value=O.querySelector('[name="finial_color"]')?.value||"ขาว",e.querySelector('[name="modal_grommet_color"]').value=O.querySelector('[name="grommet_color"]')?.value||"เงิน";const l=e.querySelector("#finialColorGroup"),n=e.querySelector("#grommetColorGroup"),s=e.querySelector("#hardwareApplyToRoom");l&&(l.style.display=t?"":"none"),n&&(n.style.display=t?"":"none"),s&&(s.disabled=r);const c=await W("#hardwareModal");c&&!c.cancelled&&(O.querySelector('[name="track_color"]').value=e.querySelector('[name="modal_track_color"]').value,O.querySelector('[name="bracket_color"]').value=e.querySelector('[name="modal_bracket_color"]').value,t&&(O.querySelector('[name="finial_color"]').value=e.querySelector('[name="modal_finial_color"]').value,O.querySelector('[name="grommet_color"]').value=e.querySelector('[name="modal_grommet_color"]').value),j(),$("บันทึกการตั้งค่าอุปกรณ์แล้ว","success")),O=null}function Me(e,o){e&&(le(V()),Q(),e.classList.add("item-removing"),e.addEventListener("animationend",()=>{e.remove(),$(o),ke(),X(),D(),fe()},{once:!0}))}function Rt(e){if(!e)return;const o=document.querySelector(".main-header");if(!o){e.scrollIntoView({behavior:"smooth",block:"center"});return}$e();const a=o.offsetHeight,t=16,l=(e.querySelector(".item-header")||e).getBoundingClientRect(),n=a+t,s=l.top-n;Math.abs(s)>5&&window.scrollBy({top:s,behavior:"smooth"})}function qe(e){if(!e)return;$e();const o=document.querySelector(".main-header"),a=document.querySelector(".summary-footer"),t=o?o.offsetHeight+16:80,r=a?a.offsetHeight+16:100;requestAnimationFrame(()=>{const l=e.getBoundingClientRect(),n=window.innerHeight;if(!(l.top>=t&&l.bottom<=n-r)){const c=n-t-r,d=l.height>c?"start":"center";e.scrollIntoView({behavior:"smooth",block:d})}})}function X(){document.querySelectorAll(v.room).forEach(e=>{const o=e.querySelectorAll(".item-card:not(.item-hidden)");let a=0;const t=Array.from(o).filter(r=>!r.classList.contains("is-suspended")).length;o.forEach(r=>{const l=r.querySelector("[data-item-title]");l&&(r.classList.contains("is-suspended")?l.textContent="-":(a++,l.textContent=`${a}/${t}`))}),e.querySelectorAll(".item-card.item-hidden").forEach(r=>{const l=r.querySelector("[data-item-title]");l&&(l.textContent="-")})})}function ot(){const e=document.querySelector(v.orderForm),o=document.querySelector(v.lockBtn);!e||!o||(e.classList.toggle("is-locked",G),o.classList.toggle("is-locked",G),o.querySelector("i").className=G?"ph-bold ph-lock-key":"ph ph-paw-print",e.querySelectorAll('input:not([type="hidden"]), select, textarea, button:not(.unlockable):not([data-act="toggle-more-details"]):not([data-act="collapse-room"])').forEach(a=>{!a.closest(".main-header")&&!a.closest(".summary-footer")&&!a.closest(".modal-wrapper")&&(a.disabled=G)}),document.querySelectorAll(".unlockable").forEach(a=>a.disabled=!1))}function Nt(){G=!G,ot(),$(G?"ฟอร์มถูกล็อค":"ปลดล็อคฟอร์มแล้ว",G?"warning":"success")}function Y(){const e=document.querySelectorAll(v.room+":not(.item-hidden)");if(e.length===0){const t=document.querySelector(v.toggleAllRoomsBtn);t&&(t.querySelector("i").className="ph ph-caret-down",t.querySelector("span").textContent="ขยายทั้งหมด");return}const o=[...e].some(t=>t.open),a=document.querySelector(v.toggleAllRoomsBtn);a&&(a.querySelector("i").className=o?"ph ph-caret-up":"ph ph-caret-down",a.querySelector("span").textContent=o?"ย่อทั้งหมด":"ขยายทั้งหมด")}function Ft(){const e=document.querySelectorAll(v.room+":not(.item-hidden)");if(e.length===0)return;const o=[...e].some(t=>t.open);e.forEach(t=>{t.open=!o});const a=document.querySelector(v.quickNavDropdown);a&&a.classList.contains("show")&&(a.classList.remove("show"),document.querySelector(v.quickNavBtn)?.setAttribute("aria-expanded","false")),setTimeout(()=>{Y(),j()},50)}function ke(){const e=document.querySelector(v.quickNavRoomList);e&&(e.innerHTML="",document.querySelectorAll(v.room).forEach(o=>{const a=o.querySelector(v.roomNameInput)?.value||"ห้อง",t=document.createElement("a");t.href=`#${o.id}`,t.dataset.jumpTo=o.id,t.innerHTML=`<i class="ph ph-share-fat"></i> ${L(a)||"ห้อง (ไม่มีชื่อ)"}`,e.appendChild(t)}))}function Be(e){const o=document.getElementById("quickNavBtnText");o&&(e?o.textContent=e.querySelector('input[name="room_name"]')?.value||"...":o.textContent="ไปยังห้อง")}function fe(){if(he&&he.disconnect(),!document.getElementById("quickNavBtnText"))return;const o={root:null,rootMargin:"-60px 0px -150px 0px",threshold:0},a=l=>{const n=l.filter(s=>s.isIntersecting).sort((s,c)=>s.target.getBoundingClientRect().top-c.target.getBoundingClientRect().top);n.length>0&&Be(n[0].target)};he=new IntersectionObserver(a,o),document.querySelectorAll(v.room).forEach(l=>he.observe(l));const t=document.querySelectorAll(v.room),r=Array.from(t).filter(l=>l&&typeof l.getBoundingClientRect=="function");if(r.length>0){r.sort((n,s)=>n.getBoundingClientRect().top-s.getBoundingClientRect().top);const l=r.find(n=>n.getBoundingClientRect().bottom>60);Be(l||r[0])}else Be(null)}function be(e){if(!e)return;const o=e.closest(".form-group-with-favorites")?.querySelector(".btn-favorite");if(!o)return;const a=e.dataset.favoriteType,t=e.value;o.classList.toggle("is-favorite",Qe(a,t))}function Ce(e,o=null){if(!e)return;const a=e.querySelector(".item-details-more"),t=e.querySelector('[data-act="toggle-more-details"]'),r=t?.parentElement;if(!a||!t||!r)return;const l=a.classList.contains("show"),n=o!==null?o:!l;if(l===n)return;a.classList.toggle("show",n),t.classList.toggle("expanded",n);const s=t.querySelector("i");s&&(s.className=n?"ph ph-caret-up":"ph ph-caret-down");const c=t.querySelector("span");if(c&&(c.textContent=n?"ย่อน้อยลง":"เพิ่มเติม"),n)a.appendChild(r),setTimeout(()=>Rt(e),100);else{const d=e.querySelector(".item-grid");d&&d.appendChild(r)}}function se(e={}){const o=document.querySelector(v.roomsContainer);if(!o)return null;Object.keys(e).length===0&&(le(V()),Q());const a=Ze(e);return a?(o.appendChild(a),Object.keys(e).length===0&&(a.classList.add("item-created"),qe(a),a.querySelector('input[name="room_name"]')?.focus()),ke(),Y(),fe(),Object.keys(e).length===0&&j(),a):null}async function rt(e,o=null){const a=document.querySelector("#itemTypeModal");if(!a)return null;a.querySelector("#itemTypeModalTitle").textContent=e;let t=o||"set";o&&!N[o]&&(t="set");const r=a.querySelector(`input[name="item_type_option"][value="${t}"]`);if(r)r.checked=!0;else{const s=a.querySelector('input[name="item_type_option"][value="set"]');s&&(s.checked=!0)}const l=await W("#itemTypeModal");if(!l||l.cancelled)return null;const n=a.querySelector('input[name="item_type_option"]:checked');return n?n.value:null}async function Ht(e,o){if(!o||!e||!N[e])return;const a=o.getItemsContainer();if(!a)return;le(V()),Q();let t;if(e==="set")t=Fe();else if(e==="wallpaper")t=He();else if(N[e].templateId==="#areaBasedTpl")t=Oe(e);else return;t&&(a.appendChild(t),t.classList.add("item-created"),qe(t),t.querySelector('input:not([type="hidden"]), select, textarea')?.focus(),X(),D())}async function Ot(e){if(!e)return;const o=e.dataset.type,a=await rt("เปลี่ยนประเภทรายการ",o);if(!a||a===o||!await K("ยืนยันการเปลี่ยนแปลง","ข้อมูลทั้งหมดในรายการนี้จะถูกลบและสร้างใหม่ คุณแน่ใจหรือไม่?"))return;le(V()),Q();let t;if(a==="set")t=Fe();else if(a==="wallpaper")t=He();else if(N[a]?.templateId==="#areaBasedTpl")t=Oe(a);else return;t&&(e.replaceWith(t),t.classList.add("item-created"),qe(t),t.querySelector('input:not([type="hidden"]), select, textarea')?.focus(),X(),D(),$("เปลี่ยนประเภทรายการแล้ว","success"))}const D=me(()=>{let e=0;document.querySelectorAll(v.room).forEach(d=>{let i=0,m=0;const u=d.classList.contains("is-suspended");u||(d.querySelectorAll(".item-card:not(.is-suspended)").forEach(f=>{const _=g(f.dataset.totalPrice);_>0&&(i+=_,m++)}),e+=i),typeof d.updateBrief=="function"&&(u?d.updateBrief("(ระงับชั่วคราว)"):m>0?d.updateBrief(`<span>${m}</span> &bull; ${B(i)} บาท`):d.updateBrief("<span>0</span> รายการ"))});const o=document.querySelector("#discount_type"),a=document.querySelector("#discount_value"),t=o?o.value:"amount",r=a?g(a.value):0;let l=0;r>0&&(l=t==="percent"?e*(r/100):r,l=Math.min(e,l));const n=e-l,s=document.querySelector("#grandTotal"),c=document.querySelector("#originalTotal");s&&(s.textContent=B(n)),c&&(l>0?(c.textContent=B(e),c.dataset.rawTotal=e,c.style.display="block"):(c.style.display="none",c.dataset.rawTotal="")),ie(),j()},200);async function De(e,o=!1){if(!e){$("ข้อมูลสำหรับโหลดไม่ถูกต้อง","error");return}if(e.favorites)if(o){const d=document.querySelector("#favoritesConflictModal");if(d){const i=d.querySelector('input[name="fav_conflict_option"][value="merge"]');i&&(i.checked=!0);const m=await W("#favoritesConflictModal");if(!m||m.cancelled){$("ยกเลิกการนำเข้า","warning");return}const u=d.querySelector('input[name="fav_conflict_option"]:checked').value;let f=0;switch(u){case"overwrite":je(e.favorites)&&$("เขียนทับรายการโปรดสำเร็จ","success");break;case"merge":f=Ee(e.favorites),$(`รวมข้อมูลสำเร็จ (เพิ่ม ${f} รายการใหม่)`,"success");break;case"skip":$("ข้ามการนำเข้ารายการโปรด","default");break}}else Ee(e.favorites)}else je(e.favorites);const a=document.querySelector(v.roomsContainer);if(!a)return;a.innerHTML="";const t=document.querySelector("#customer_name"),r=document.querySelector("#customer_phone"),l=document.querySelector("#customer_address"),n=document.querySelector("#customerDetailsCard");t&&(t.value=e.customer_name||""),r&&(r.value=e.customer_phone||""),l&&(l.value=e.customer_address||""),n&&(n.open=e.customer_card_open??!0);const s=document.querySelector("#discount_type"),c=document.querySelector("#discount_value");if(e.discount&&s&&c?(s.value=e.discount.type||"amount",c.value=e.discount.value||0):s&&c&&(s.value="amount",c.value=0),!Array.isArray(e.rooms)){$("ไม่พบข้อมูลห้องในไฟล์","warning"),a.children.length===0&&se();return}for(const d of e.rooms){const i=Ze(d);if(!i)continue;a.appendChild(i);const m=i.getItemsContainer();if(m&&Array.isArray(d.items))for(const u of d.items){u.type==="deco"&&u.deco_type&&(u.code=u.deco_code,u.width_m=u.deco_width_m,u.height_m=u.deco_height_m,u.price_sqyd=u.deco_price_sqyd,u.notes=u.deco_notes,delete u.deco_type,delete u.deco_code,delete u.deco_width_m,delete u.deco_height_m,delete u.deco_price_sqyd,delete u.deco_notes);let f;if(u.type==="set")f=Fe(u);else if(u.type==="wallpaper")f=He(u);else if(N[u.type]?.templateId==="#areaBasedTpl")f=Oe(u.type,u);else continue;f&&m.appendChild(f)}}document.querySelectorAll("input[data-favorite-type]").forEach(be),X(),ke(),Y(),fe(),Q(),D(),o&&$("นำเข้าข้อมูลฟอร์มสำเร็จ","success")}async function Dt(e,o){const a=document.querySelector(v.printableContent);if(!a||!e){$("ไม่พบข้อมูลสำหรับสร้างเอกสาร","error");return}const t=document.title;if(o==="direct"){$("กำลังสร้าง PDF...","default");let r;try{typeof window.html2pdf>"u"&&($("กำลังโหลดไลบรารี PDF...","default"),await It("https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js")),r=document.createElement("div"),r.style.position="fixed",r.style.left="-300mm",r.style.top="0",r.style.width="210mm",r.style.background="#fff",r.innerHTML=e,document.body.appendChild(r),await new Promise(n=>setTimeout(n,300));const l={margin:0,filename:`${t}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0,logging:!1,width:r.querySelector(".pdf-page")?.scrollWidth||794,windowWidth:r.querySelector(".pdf-page")?.scrollWidth||794},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}};await window.html2pdf().from(r).set(l).save(),$("ดาวน์โหลด PDF สำเร็จ","success")}catch(l){console.error("PDF Generation Error:",l),$("สร้าง PDF ล้มเหลว, โปรดลองวิธีที่ 2 (พิมพ์)","error")}finally{r&&document.body.contains(r)&&document.body.removeChild(r)}}else o==="print"&&(a.innerHTML=e,setTimeout(()=>{window.print(),setTimeout(()=>{a.innerHTML=""},1e3)},dt))}function jt(e){if(!e||!e.html){$("ไม่พบข้อมูลสำหรับสร้างไฟล์ HTML","error");return}try{const o=`<!DOCTYPE html><html lang="th"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>${e.fileName}</title><link rel="stylesheet" href="./src/styles/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/bold/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/fill/style.css"><style>body { background-color: #eee; } #printable-content { display: block !important; max-width: 210mm; margin: 10mm auto; } .pdf-page { border: 1px solid #ccc; box-shadow: 0 0 10px rgba(0,0,0,0.1); margin-bottom: 10mm; background: #fff; page-break-inside: avoid; } .pdf-page-content { padding: 12mm; } @media print { body { background-color: #fff; } #printable-content { max-width: 100%; margin: 0; } .pdf-page { border: none; box-shadow: none; margin-bottom: 0; page-break-after: always; } .pdf-page:last-child { page-break-after: avoid; } } i.ph { vertical-align: middle; }</style></head><body><div id="printable-content">${e.html}</div></body></html>`,a=new Blob([o],{type:"text/html;charset=utf-8"}),t=URL.createObjectURL(a),r=document.createElement("a");r.href=t,r.download=`${e.fileName}.html`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(t),$("ดาวน์โหลดไฟล์ HTML สำเร็จ","success")}catch(o){console.error("HTML Export Error:",o),$("สร้างไฟล์ HTML ล้มเหลว","error")}}function Wt(e){const o=e.closest(".item-card");if(!o)return;const a=g(e.value);let t;const r=e.getAttribute("name");if(r==="set_price_per_m")t=o.querySelector('input[name="fabric_code"]');else if(r==="sheer_price_per_m")t=o.querySelector('input[name="sheer_fabric_code"]');else if(r==="wallpaper_price_roll")t=o.querySelector('input[name="wallpaper_code"]');else if(r==="area_price_sqyd")t=o.querySelector('input[name="area_code"]');else return;if(t&&t.value.trim()){const l=t.dataset.favoriteType,n=t.value.trim(),s=Ke(l,n);if(s&&s.price!==a){const c=t.closest(".form-group-with-favorites")?.querySelector(".btn-favorite");c?.classList.contains("is-favorite")&&(ge(l,n,s.price),c.classList.remove("is-favorite"),$(`ยกเลิก Favorite '${n}' เนื่องจากราคาไม่ตรงกัน`,"warning"),j())}}}function Vt(e){const{roomId:o,itemIndex:a}=e.dataset;if(!o||a===void 0)return;const t=document.getElementById("lookbookModal");t&&t.classList.remove("visible");const r=document.getElementById(o);if(!r){$("ไม่พบห้องที่ต้องการ","error");return}const n=Array.from(r.querySelectorAll(".item-card:not(.item-hidden)"))[parseInt(a,10)];if(!n){$("ไม่พบรายการที่ต้องการ","error");return}r.open=!0,Y(),setTimeout(()=>{$e(),n.scrollIntoView({behavior:"smooth",block:"center"}),n.classList.add("scrolling-jump"),setTimeout(()=>n.classList.remove("scrolling-jump"),2500)},150)}function nt(e){if(!z)return;const o=z.closest(".item-card");if(!o)return;const a=e.dataset.code,t=g(e.dataset.price);z.value=a,z.classList.add("input-highlight"),setTimeout(()=>z.classList.remove("input-highlight"),1200);const r=z.dataset.favoriteType;let l;r==="fabric"?l="set_price_per_m":r==="sheer"?l="sheer_price_per_m":r==="wallpaper"?l="wallpaper_price_roll":l="area_price_sqyd";const n=o.querySelector(`[name="${l}"]`);n&&t>0&&(n.tagName==="SELECT"?n.value=t:n.value=B(t),n.classList.add("input-highlight"),setTimeout(()=>n.classList.remove("input-highlight"),1200)),be(z),D(),j(),document.querySelector("#favoritesModal").classList.remove("visible")}async function at(e){z=e;const o=e.dataset.favoriteType;if(!o)return;const a=document.querySelector("#favoritesModal"),t=a.querySelector("#favoritesModalTitle"),r=a.querySelector("#favoritesModalBody"),l=a.querySelector("#favSearchInput"),n=a.querySelector("#favoritesModalManageBtn"),s=document.querySelector("#favSelectorItemTpl"),c=N[o]?.name||o;t.textContent=`เลือก '${L(c)}'`;const i=Z()[o]||[];i.length>0?r.innerHTML=i.map(f=>s.innerHTML.replace(/{CODE}/g,L(f.code)).replace(/{PRICE}/g,f.price>0?B(f.price):"-").replace(/{RAW_PRICE}/g,f.price)).join(""):r.innerHTML='<p class="empty-state">ไม่มีรายการโปรดที่บันทึกไว้</p>',l.value="";const m=()=>{const f=l.value.toLowerCase();r.querySelectorAll(".fav-selector-item").forEach(_=>{const T=_.dataset.code.toLowerCase();_.classList.toggle("is-hidden",!T.includes(f))})};l.addEventListener("input",m);const u=f=>{const _=f.target.closest(".fav-selector-item");_&&(nt(_),r.removeEventListener("click",u),l.removeEventListener("input",m))};r.addEventListener("click",u),n.onclick=async()=>{a.classList.remove("visible"),await Ut(o),pe&&await at(e)},await W("#favoritesModal",()=>{l.removeEventListener("input",m),r.removeEventListener("click",u)})}function ye(e){const o=document.querySelector("#favManagerBody"),a=document.querySelector("#favManagerItemTpl"),r=Z()[e]||[];if(!o||!a)return;r.length===0?o.innerHTML='<p class="empty-state">ไม่มีรายการโปรดที่บันทึกไว้</p>':o.innerHTML=r.map(s=>a.innerHTML.replace(/{CODE}/g,L(s.code)).replace(/{PRICE}/g,B(s.price)).replace(/{RAW_PRICE}/g,s.price)).join(""),H=null;const l=document.querySelector('#favManagerModal [data-act="edit-selected-fav"]'),n=document.querySelector('#favManagerModal [data-act="del-selected-fav"]');l&&(l.disabled=!0),n&&(n.disabled=!0)}async function Ut(e){const o=document.querySelector("#favManagerModal");if(!o||!e)return;const a=N[e]?.name||e;o.dataset.currentType=e,pe=!1,H=null,document.querySelector("#favManagerTitle").textContent=`จัดการ '${L(a)}'`,ye(e),await W("#favManagerModal")}function Gt(){const e=document.querySelector(v.orderForm),o=document.querySelector(v.fileImporter),a=document.querySelector("#favImporter"),t=document.querySelector(v.menuDropdown),r=document.querySelector(v.quickNavDropdown),l=document.querySelector(v.menuBtn),n=document.querySelector(v.quickNavBtn);if(e.addEventListener("item-update",D),e.addEventListener("input",s=>{if(G){s.preventDefault();return}s.target.closest("#customerInfo")&&j();const c=s.target.closest("input[data-favorite-type]");if(c&&be(c),s.target.matches(v.roomNameInput)){const i=s.target.closest(".room-card")?.querySelector("[data-room-name-display]");i&&(i.textContent=s.target.value||"ห้อง"),ke(),fe(),me(j,300)()}s.target.matches('input[name$="_m"], input[name$="price_sqyd"], input[name$="price_roll"], input[name$="install_cost"]')&&D()}),e.addEventListener("change",s=>{if(G){s.preventDefault();return}s.target.matches("select")&&D()}),e.addEventListener("blur",s=>{const c=s.target;c.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_install_cost"]')?(Wt(c),c.value=g(c.value)>0?B(g(c.value)):""):c.matches('input[name$="_m"], input[name^="wall_width_m"]')&&(c.value=te(c.value)),c.matches('input:not([type="hidden"]), select, textarea')&&j()},!0),e.addEventListener("focusin",s=>{const c=s.target;c.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_install_cost"]')&&g(c.value)>0&&(c.value=g(c.value));const d=c.closest(".item-card, .room-card");d&&qe(d)},!0),e.addEventListener("keydown",s=>{if(G){s.preventDefault();return}const c=s.target;s.key==="Enter"&&c.matches("input, select")&&!c.closest(".modal-wrapper")&&s.preventDefault()}),document.addEventListener("click",async s=>{s.target.closest(".menu-container")||(t?.classList.remove("show"),l?.setAttribute("aria-expanded","false"),r?.classList.remove("show"),n?.setAttribute("aria-expanded","false")),s.target.closest(".room-options-container")||document.querySelectorAll(".room-options-menu.show").forEach(u=>u.classList.remove("show"));const c=s.target.closest(".summary-tag[data-filter-type]");if(c&&c.closest("#overviewModal")){const u=c.dataset.filterType,f=c.textContent.trim().replace(/\s*\d+\s*$/,""),_=document.querySelector("#overviewModal");_&&_.classList.remove("visible"),Ct(u,f);return}const d=s.target.closest(".fav-manager-item");if(d){const u=d.closest("#favManagerModal"),f=u?.querySelector(".fav-manager-item.is-selected");f&&f.classList.remove("is-selected"),f!==d?(d.classList.add("is-selected"),H={code:d.dataset.code,price:g(d.dataset.price)}):H=null,u&&(u.querySelector('[data-act="edit-selected-fav"]').disabled=!H,u.querySelector('[data-act="del-selected-fav"]').disabled=!H);return}const i=s.target.closest(".fav-selector-item");if(i){nt(i);return}const m=s.target.closest("[data-act]");if(m){const u=m.dataset.act,f=m.closest(".item-card"),_=m.closest(".room-card"),T=["toggle-more-details","collapse-room","show-discount-modal","show-suspended-items","clear-filter","close-modal","jump-to-item"];if(G&&!m.closest(".unlockable")&&!T.includes(u)){$("ฟอร์มถูกล็อคอยู่","warning");return}switch(["toggle-more-details","close-modal","collapse-room"].includes(u)||s.preventDefault(),s.stopPropagation(),u){case"show-discount-modal":At();break;case"show-suspended-items":Ie();break;case"clear-filter":tt();break;case"add-room":se();break;case"add-item":if(_){const y=await rt("เพิ่มรายการใหม่");y&&Ht(y,_)}break;case"collapse-room":setTimeout(()=>{Y(),j()},50);break;case"toggle-room-menu":m.nextElementSibling?.classList.toggle("show");break;case"toggle-suspend-room":_&&(_.classList.toggle("is-suspended"),m.closest(".room-options-menu")?.classList.remove("show"),D(),ce==="suspended"?Ie():ie());break;case"clear-room":_&&await K("ล้างข้อมูลในห้อง","?")&&(le(V()),Q(),_.getItemsContainer().innerHTML="",X(),D(),$("ล้างแล้ว","success"));break;case"del-room":_&&await K("ลบห้อง","?")&&Me(_,"ลบแล้ว");break;case"del-item":f&&await K("ลบรายการ","?")&&Me(f,"ลบแล้ว");break;case"toggle-suspend":f&&(f.classList.toggle("is-suspended"),D(),ce==="suspended"?Ie():ie());break;case"change-type":f&&Ot(f);break;case"toggle-more-details":f&&!f.querySelector(".item-details-more")?.classList.contains("show")&&document.querySelectorAll(".item-details-more.show").forEach(y=>{y.closest(".item-card")!==f&&Ce(y.closest(".item-card"),!1)}),Ce(f);break;case"open-hardware-modal":O=f,O&&Pt();break;case"apply-hardware-to-room":{const y=m.closest("#hardwareModal"),p=O?.closest(v.room);if(!y||!p||!O)break;if(O.querySelector('[name="set_style"]')?.value==="ม่านพับ"){$("ไม่สามารถใช้กับม่านพับได้","warning");break}const k=y.querySelector('[name="modal_track_color"]').value,b=y.querySelector('[name="modal_bracket_color"]').value,S=y.querySelector('[name="modal_finial_color"]').value,x=y.querySelector('[name="modal_grommet_color"]').value;p.querySelectorAll('.set-item:not(:has(select[name="set_style"][value="ม่านพับ"]))').forEach(w=>{w.querySelector('[name="track_color"]').value=k,w.querySelector('[name="bracket_color"]').value=b,w.querySelector('select[name="set_style"]')?.value==="ตาไก่"&&(w.querySelector('[name="finial_color"]').value=S,w.querySelector('[name="grommet_color"]').value=x)}),j(),$("ใช้กับรายการที่เข้ากันได้ในห้องแล้ว","success");break}case"add-wall":{const y=m.closest(".walls-section")?.querySelector("[data-walls-container]");if(y){const p=Pe();p&&(y.appendChild(p),p.querySelector("input")?.focus(),D())}break}case"del-wall":{const y=m.closest(".wall-input-row");y&&await K("ลบผนัง","?")&&Me(y,"ลบแล้ว");break}case"show-favorites":{const y=m.closest(".form-group-with-favorites")?.querySelector("input[data-favorite-type]");y&&at(y);break}case"toggle-favorite":{const p=m.closest(".form-group-with-favorites")?.querySelector("input[data-favorite-type]");if(!p||!f)break;const h=p.dataset.favoriteType,k=p.value;let b=0,S;if(p.name==="fabric_code"?S=f.querySelector('[name="set_price_per_m"]'):p.name==="sheer_fabric_code"?S=f.querySelector('[name="sheer_price_per_m"]'):p.name==="wallpaper_code"?S=f.querySelector('[name="wallpaper_price_roll"]'):p.name==="area_code"&&(S=f.querySelector('[name="area_price_sqyd"]')),b=g(S?.value),!k.trim()){$("โปรดระบุรหัส","warning");break}if(!["fabric","sheer"].includes(h)&&b<=0){$("โปรดระบุราคา","warning");break}const x=ge(h,k,b);x!==null&&(m.classList.toggle("is-favorite",x),$(x?"เพิ่มแล้ว":"ลบแล้ว","success"),j());break}case"add-new-fav-form":{const p=m.closest("#favManagerModal")?.dataset.currentType;if(!p)break;const h=document.querySelector("#favAddModal");if(!h)break;h.querySelector("h3").textContent=`เพิ่ม '${N[p]?.name||p}'`;const k=h.querySelector('[name="fav_code_add"]'),b=h.querySelector('[name="fav_price_add"]');k.value="",b.value="";const S=await W("#favAddModal");if(S&&!S.cancelled){const x=k.value.trim(),w=g(b.value);x?ge(p,x,w)!==null?(pe=!0,ye(p),$("เพิ่มแล้ว","success")):$("ล้มเหลว","error"):$("ต้องระบุรหัส","warning")}break}case"edit-selected-fav":{if(!H)break;const p=m.closest("#favManagerModal")?.dataset.currentType;if(!p)break;const h=document.querySelector("#favEditModal");if(!h)break;h.querySelector("h3").textContent=`แก้ไข '${H.code}'`;const k=h.querySelector('[name="fav_code_edit"]'),b=h.querySelector('[name="fav_price_edit"]');k.value=H.code,b.value=H.price>0?H.price:"";const S=await W("#favEditModal");if(S&&!S.cancelled){const x=k.value.trim(),w=g(b.value);x?(x!==H.code&&Ae(p,H.code),ge(p,x,w),pe=!0,ye(p),$("แก้ไขรายการโปรดแล้ว","success")):$("ต้องระบุรหัส","warning")}break}case"del-selected-fav":{if(!H)break;const p=m.closest("#favManagerModal")?.dataset.currentType;if(!p)break;await K("ลบรายการโปรด",`"${H.code}"?`)&&(Ae(p,H.code)?(pe=!0,ye(p),$("ลบแล้ว","success")):$("ล้มเหลว","error"));break}case"jump-to-item":Vt(m);break}}else{const u=s.target.closest("summary");u&&u.closest("details.card")&&setTimeout(()=>{Y(),j()},50)}}),document.querySelector("#undoBtn")?.addEventListener("click",s=>{s.preventDefault(),Bt()}),document.querySelector(v.lockBtn)?.addEventListener("click",s=>{s.preventDefault(),Nt()}),document.querySelector(v.toggleAllRoomsBtn)?.addEventListener("click",s=>{s.preventDefault(),Ft()}),n&&r){n.addEventListener("click",c=>{c.stopPropagation(),t?.classList.remove("show");const d=!r.classList.contains("show");r.classList.toggle("show",d),n.setAttribute("aria-expanded",d),d&&l?.setAttribute("aria-expanded","false")}),document.querySelector(v.quickNavRoomList)?.addEventListener("click",c=>{const d=c.target.closest("a[data-jump-to]");if(d){c.preventDefault();const i=d.dataset.jumpTo,m=document.getElementById(i);m&&(m.open=!0,$e(),m.scrollIntoView({behavior:"smooth",block:"center"}),m.classList.add("scrolling-jump"),setTimeout(()=>m.classList.remove("scrolling-jump"),2500),setTimeout(Y,100)),r.classList.remove("show"),n.setAttribute("aria-expanded","false")}});const s=document.querySelector("#addRoomQuickNavBtn");if(s){const c=pt(se,700);s.addEventListener("click",d=>{d.stopPropagation(),c(),r.classList.remove("show"),n.setAttribute("aria-expanded","false")})}}l&&t&&l.addEventListener("click",s=>{s.stopPropagation(),r?.classList.remove("show");const c=!t.classList.contains("show");t.classList.toggle("show",c),l.setAttribute("aria-expanded",c),c&&n?.setAttribute("aria-expanded","false")}),document.querySelector("#themeToggleBtn")?.addEventListener("click",s=>{s.preventDefault(),Mt(),t?.classList.remove("show"),l?.setAttribute("aria-expanded","false")}),document.querySelector("#overviewBtn")?.addEventListener("click",async s=>{s.preventDefault(),t?.classList.remove("show"),l?.setAttribute("aria-expanded","false");const c=V(),d=document.querySelector("#overviewModalHeader"),i=document.querySelector("#overviewModalBody");if(d&&i){const m=c.rooms.reduce((_,T)=>_+(T.is_suspended?0:(T.items||[]).filter(y=>!y.is_suspended&&(A.calculateSetPrice(y)?.total>0||A.calculateWallpaperPrice(y)?.total>0||A.calculateAreaBasedPrice(y)?.total>0)).length),0),u=document.querySelector(v.grandTotal)?.textContent||"0",f=c.rooms.filter(_=>!_.is_suspended&&_.items?.some(T=>!T.is_suspended)).length;d.innerHTML=`<div class="overview-stats-grid"><div class="overview-stat-card"><i class="ph-bold ph-map-pin-line"></i><div class="stat-value">${f}</div><div class="stat-label">ห้อง</div></div><div class="overview-stat-card"><i class="ph-bold ph-stack"></i><div class="stat-value">${m}</div><div class="stat-label">รายการ</div></div><div class="overview-stat-card"><i class="ph-bold ph-coins"></i><div class="stat-value">${u}</div><div class="stat-label">ยอดรวม</div></div></div>`,i.innerHTML=xt(c),W("#overviewModal")}}),document.querySelector("#copyTextBtn")?.addEventListener("click",async s=>{s.preventDefault(),t?.classList.remove("show"),l?.setAttribute("aria-expanded","false");const c=document.querySelector(v.copyOptionsModal);if(!c)return;c.querySelector('input[name="copy_option"][value="customer"]').checked=!0;const d=await W(v.copyOptionsModal);if(d&&!d.cancelled){const i=c.querySelector('input[name="copy_option"]:checked').value,m=kt(V(),i);try{await navigator.clipboard.writeText(m),$("คัดลอกสำเร็จ!","success")}catch{$("คัดลอกล้มเหลว","error")}}}),document.querySelector("#visualReportsBtn")?.addEventListener("click",async s=>{s.preventDefault(),t?.classList.remove("show"),l?.setAttribute("aria-expanded","false");const c=document.querySelector("#visualReportsModal");if(!c)return;c.querySelector('input[name="report_type_option"][value="lookbook"]').checked=!0;const d=await W("#visualReportsModal");if(d&&!d.cancelled){const i=c.querySelector('input[name="report_type_option"]:checked').value;if(i==="lookbook"){const m=V(),u=Lt(m),f=document.querySelector("#lookbookModalBody");u&&f?(f.innerHTML=u,W("#lookbookModal")):$("ไม่มีข้อมูล","warning")}else $(`'${i}' ยังไม่พร้อม`,"default")}}),document.querySelector(v.exportPdfBtn)?.addEventListener("click",async s=>{s.preventDefault(),t?.classList.remove("show"),l?.setAttribute("aria-expanded","false");const c=await Et();if(!c)return;const d=V(),i=Tt(d,{vatRate:c.vatOption==="include"?F.baseVatRate:0,pageBreakBuffer:c.pageBreakBuffer});if(!i){$("ไม่มีรายการ","warning");return}c.exportMethod==="html"?jt(i):Dt(i.html,c.exportMethod)}),document.querySelector(v.submitBtn)?.addEventListener("click",async s=>{if(s.preventDefault(),t?.classList.remove("show"),l?.setAttribute("aria-expanded","false"),await K("ส่งข้อมูล","?")){const c=V();if(!c.customer_name&&!c.customer_phone){$("ใส่ชื่อ/เบอร์","warning");return}$("กำลังส่ง...","default");try{const d=await fetch(it,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});d.ok?$("ส่งแล้ว!","success"):$(`ล้มเหลว: ${d.status}`,"error")}catch{$("เชื่อมต่อผิดพลาด","error")}}}),document.querySelector(v.importBtn)?.addEventListener("click",s=>{s.preventDefault(),t?.classList.remove("show"),l?.setAttribute("aria-expanded","false"),o?.click()}),o?.addEventListener("change",s=>{const c=s.target.files?.[0];if(!c)return;const d=new FileReader;d.onload=async i=>{try{const m=JSON.parse(i.target.result);if(m&&typeof m=="object")await De(m,!0);else throw new Error("Invalid JSON")}catch(m){$("ไฟล์ JSON ไม่ถูก","error"),console.error(m)}},d.readAsText(c),s.target.value=null}),document.querySelector(v.exportBtn)?.addEventListener("click",s=>{s.preventDefault(),t?.classList.remove("show"),l?.setAttribute("aria-expanded","false");try{const c=V(),d=JSON.stringify(c,null,4),i=new Blob([d],{type:"application/json"}),m=URL.createObjectURL(i),u=document.createElement("a"),f=new Date,_=`${f.getFullYear()}${(f.getMonth()+1).toString().padStart(2,"0")}${f.getDate().toString().padStart(2,"0")}`,T=`${f.getHours().toString().padStart(2,"0")}${f.getMinutes().toString().padStart(2,"0")}`,y=Je(c.customer_name||"data");u.href=m,u.download=`MTR-${_}${T}-${y}.json`,u.click(),URL.revokeObjectURL(m),$("Export สำเร็จ","success")}catch{$("Export ล้มเหลว","error")}}),document.querySelector("#importFavsBtn")?.addEventListener("click",s=>{s.preventDefault(),t?.classList.remove("show"),l?.setAttribute("aria-expanded","false"),a?.click()}),a?.addEventListener("change",s=>{const c=s.target.files?.[0];if(!c)return;const d=new FileReader;d.onload=i=>{try{const m=JSON.parse(i.target.result),u=Ee(m);u>0?$(`เพิ่ม ${u} รายการ`,"success"):$("ไม่พบรายการใหม่","default"),document.querySelectorAll("input[data-favorite-type]").forEach(be)}catch{$("ไฟล์ JSON ไม่ถูก","error")}},d.readAsText(c),s.target.value=null}),document.querySelector("#exportFavsBtn")?.addEventListener("click",s=>{s.preventDefault(),t?.classList.remove("show"),l?.setAttribute("aria-expanded","false");try{const c=Z();if(Object.values(c).every(_=>_.length===0)){$("ไม่มีรายการ","warning");return}const d=JSON.stringify(c,null,4),i=new Blob([d],{type:"application/json"}),m=URL.createObjectURL(i),u=document.createElement("a"),f=new Date().toISOString().slice(0,10).replace(/-/g,"");u.href=m,u.download=`MTR-Favorites-${f}.json`,u.click(),URL.revokeObjectURL(m),$("Export สำเร็จ","success")}catch{$("Export ล้มเหลว","error")}}),document.querySelector(v.clearItemsBtn)?.addEventListener("click",async s=>{if(s.preventDefault(),t?.classList.remove("show"),l?.setAttribute("aria-expanded","false"),await K("ล้างทุกรายการ","?")){le(V()),Q(),document.querySelectorAll(v.room).forEach(i=>{i.getItemsContainer().innerHTML=""});const c=document.querySelector("#discount_type"),d=document.querySelector("#discount_value");c&&(c.value="amount"),d&&(d.value="0"),X(),D(),$("ล้างแล้ว","success")}}),document.querySelector(v.clearAllBtn)?.addEventListener("click",async s=>{s.preventDefault(),t?.classList.remove("show"),l?.setAttribute("aria-expanded","false"),await K("ลบข้อมูลทั้งหมด","คำเตือน! ลบถาวร?")&&(localStorage.removeItem(de),ht(),window.location.reload())}),window.addEventListener("click",s=>{s.target.closest(".menu-container")||(t?.classList.remove("show"),r?.classList.remove("show"),l?.setAttribute("aria-expanded","false"),n?.setAttribute("aria-expanded","false")),s.target.closest(".room-options-container")||document.querySelectorAll(".room-options-menu.show").forEach(d=>d.classList.remove("show"));const c=s.target.closest(".item-card");document.querySelectorAll(".item-details-more.show").forEach(d=>{const i=d.closest(".item-card");i!==c&&Ce(i,!1)})}),window.addEventListener("beforeunload",j)}function Yt(){const e=document.querySelector(v.setTpl);if(!e)return;const o=e.content.querySelector(v.setPricePerMSelect),a=e.content.querySelector(v.setSheerPricePerMSelect),t=r=>{let l='<option value="" hidden>เลือกราคา</option>';return Array.isArray(r)?(r.forEach(n=>{l+=`<option value="${n}">${n.toLocaleString("th-TH")}</option>`}),l):(console.error("Price data for dropdown is not available or not an array.",r),l)};o&&(o.innerHTML=t(_e.fabric)),a&&(a.innerHTML=t(_e.sheer))}function Jt(){Yt(),et(),Gt();try{const e=localStorage.getItem(de);if(e&&e!=="null"&&e!=="{}"){const o=JSON.parse(e);if(o&&Array.isArray(o.rooms))De(o,!1);else{console.warn("Stored data structure seems invalid, starting fresh."),localStorage.removeItem(de),se();const a=document.querySelector(v.customerCard);a&&(a.open=!0)}}else{se();const o=document.querySelector(v.customerCard);o&&(o.open=!0)}}catch(e){console.error("Failed to load or parse data from localStorage:",e),localStorage.removeItem(de),se();const o=document.querySelector(v.customerCard);o&&(o.open=!0)}D(),ot(),Y(),fe(),Q(),console.log("Marnthara App Initialized (Vite Refactor)")}document.addEventListener("DOMContentLoaded",Jt);
