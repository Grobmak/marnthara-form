(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))o(t);new MutationObserver(t=>{for(const n of t)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&o(r)}).observe(document,{childList:!0,subtree:!0});function l(t){const n={};return t.integrity&&(n.integrity=t.integrity),t.referrerPolicy&&(n.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?n.credentials="include":t.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function o(t){if(t.ep)return;t.ep=!0;const n=l(t);fetch(t.href,n)}})();const ut="vite-refactor/6.1.0",pt="https://your-make-webhook-url.com/your-unique-path",ge="marnthara.input.v6.1",ft=500,j={name:"ม่านธารา ผ้าม่านและของตกแต่ง",address:"65/8 หมู่ 2 ต.ท่าศาลา อ.เมือง จ.ลพบุรี 15000",phone:"092-985-9395, 082-552-5595",taxId:"1600668000020",logoUrl:"./assets/logo.png",baseVatRate:.07,pdf:{paymentTerms:"ชำระมัดจำ 50%",priceValidity:"30 วัน",notes:["ราคานี้รวมค่าติดตั้งแล้ว","ชำระมัดจำ 50% เพื่อยืนยันการสั่งผลิตสินค้า","ใบเสนอราคานี้มีอายุ 30 วัน นับจากวันที่เสนอราคา"]}},mt=1.19599,Pe={ROLL_WIDTH_M:.53,ROLL_LENGTH_M:10,STRIPS_PER_ROLL_UNDER_2_5M:3},be={fabric:[1e3,1100,1200,1300,1400,1500,1600,1700,1800,1900,2e3,2100,2200,2300,2400,2500,2600,2700,2800,2900,3e3],sheer:[1e3,1100,1200,1300,1400,1500],louis:[2200,2300,2400,2500,2600,2700,2800,2900,3e3,3100,3200,3300,3400,3500],style_surcharge:{ลอน:200,ตาไก่:0,จีบ:0,ม่านพับ:0,หลุยส์:0},height:[{threshold:3.2,add_per_m:300},{threshold:2.8,add_per_m:200},{threshold:2.5,add_per_m:100}]},F={set:{templateId:"#setTpl",name:"ผ้าม่าน"},wallpaper:{templateId:"#wallpaperTpl",name:"วอลล์เปเปอร์"},wooden_blind:{templateId:"#areaBasedTpl",name:"มู่ลี่ไม้"},roller_blind:{templateId:"#areaBasedTpl",name:"ม่านม้วน"},vertical_blind:{templateId:"#areaBasedTpl",name:"ม่านปรับแสง"},partition:{templateId:"#areaBasedTpl",name:"ฉากกั้นห้อง"},pleated_screen:{templateId:"#areaBasedTpl",name:"มุ้งจีบ"},aluminum_blind:{templateId:"#areaBasedTpl",name:"มู่ลี่อลูมิเนียม"}},m={orderForm:"#orderForm",roomsContainer:"#rooms",toastContainer:"#toast-container",printableContent:"#printable-content",filterStatusBar:"#filterStatusBar",menuBtn:"#menuBtn",menuDropdown:"#menuDropdown",undoBtn:"#undoBtn",themeToggleBtn:"#themeToggleBtn",overviewBtn:"#overviewBtn",copyTextBtn:"#copyTextBtn",visualReportsBtn:"#visualReportsBtn",exportPdfBtn:"#exportPdfBtn",submitBtn:"#submitBtn",importBtn:"#importBtn",exportBtn:"#exportBtn",importFavsBtn:"#importFavsBtn",exportFavsBtn:"#exportFavsBtn",clearItemsBtn:"#clearItemsBtn",clearAllBtn:"#clearAllBtn",lockBtn:"#lockBtn",quickNavBtn:"#quickNavBtn",quickNavDropdown:"#quickNavDropdown",quickNavRoomList:"#quickNavRoomList",quickNavBtnText:"#quickNavBtnText",toggleAllRoomsBtn:"#toggleAllRoomsBtn",suspendedItemsBtn:"#suspendedItemsBtn",suspendedCountBadge:"#suspendedCountBadge",originalTotal:"#originalTotal",grandTotal:"#grandTotal",fileImporter:"#fileImporter",favImporter:"#favImporter",customerCard:"#customerDetailsCard",customerNameInput:"#customer_name",customerPhoneInput:"#customer_phone",customerAddressInput:"#customer_address",room:".room-card",roomTpl:"#roomTpl",roomNameInput:'input[name="room_name"]',roomNameDisplay:"[data-room-name-display]",roomBrief:"[data-room-brief]",allItemsContainer:"[data-all-items]",roomDefaultsBtn:'[data-act="open-room-defaults"]',itemCard:".item-card",itemDetailsMore:".item-details-more",itemGrid:".item-grid",itemTitle:"[data-item-title]",toggleDetailsBtn:'[data-act="toggle-more-details"]',setTpl:"#setTpl",setWidthInput:'input[name="width_m"]',setHeightInput:'input[name="height_m"]',setStyleSelect:'select[name="set_style"]',setFabricVariantSelect:'select[name="fabric_variant"]',setPricePerMSelect:'select[name="set_price_per_m"]',setSheerPricePerMSelect:'select[name="sheer_price_per_m"]',setLouisPricePerMSelect:'select[name="louis_price_per_m"]',setFabricCodeInput:'input[name="fabric_code"]',setSheerCodeInput:'input[name="sheer_fabric_code"]',setOpeningStyleSelect:'select[name="opening_style"]',setAdjustmentSideSelect:'select[name="adjustment_side"]',setTrackColorInput:'input[name="track_color"]',setBracketColorInput:'input[name="bracket_color"]',setFinialColorInput:'input[name="finial_color"]',setGrommetColorInput:'input[name="grommet_color"]',setLouisValanceInput:'input[name="louis_valance"]',setLouisTasselsInput:'input[name="louis_tassels"]',setNotesInput:'input[name="notes"]',wallpaperTpl:"#wallpaperTpl",wallTpl:"#wallTpl",wallHeightInput:'[name="wallpaper_height_m"]',wallCodeInput:'[name="wallpaper_code"]',wallPriceRollInput:'[name="wallpaper_price_roll"]',wallInstallCostInput:'[name="wallpaper_install_cost"]',wallNotesInput:'[name="wallpaper_notes"]',wallWidthInput:'[name="wall_width_m"]',areaBasedTpl:"#areaBasedTpl",areaBasedItem:".area-based-item",areaWidthInput:'[name="area_width_m"]',areaHeightInput:'[name="area_height_m"]',areaPriceSqydInput:'[name="area_price_sqyd"]',areaCodeInput:'[name="area_code"]',areaNotesInput:'[name="area_notes"]',modal:"#confirmationModal",modalTitle:"#modalTitle",modalBody:"#modalBody",discountModal:"#discountModal",discountSubtotal:"#discountSubtotal",discountPercent:"#discountPercent",discountAmount:"#discountAmount",discountFinalTotal:"#discountFinalTotal",discountTypeInput:"#discount_type",discountValueInput:"#discount_value",copyOptionsModal:"#copyOptionsModal",visualReportsModal:"#visualReportsModal",lookbookModal:"#lookbookModal",lookbookModalBody:"#lookbookModalBody",exportOptionsModal:"#exportOptionsModal",pdfOptionsModal:"#pdfOptionsModal",exportPdfWithDetailsBtn:"#exportPdfWithDetailsBtn",exportPdfWithoutDetailsBtn:"#exportPdfWithoutDetailsBtn",itemTypeModal:"#itemTypeModal",itemTypeModalTitle:"#itemTypeModalTitle",hardwareModal:"#hardwareModal",modalTrackColor:'[name="modal_track_color"]',modalBracketColor:'[name="modal_bracket_color"]',modalFinialColor:'[name="modal_finial_color"]',modalGrommetColor:'[name="modal_grommet_color"]',modalLouisValance:'[name="modal_louis_valance"]',modalLouisTassels:'[name="modal_louis_tassels"]',trackColorGroup:"#trackColorGroup",bracketColorGroup:"#bracketColorGroup",finialColorGroup:"#finialColorGroup",grommetColorGroup:"#grommetColorGroup",louisValanceGroup:"#louisValanceGroup",louisTasselGroup:"#louisTasselGroup",hardwareApplyToRoomBtn:"#hardwareApplyToRoom",favoritesConflictModal:"#favoritesConflictModal",favoritesModal:"#favoritesModal",favoritesModalTitle:"#favoritesModalTitle",favoritesModalBody:"#favoritesModalBody",favSearchInput:"#favSearchInput",favSelectorItemTpl:"#favSelectorItemTpl",favInput:"input[data-favorite-type]",favManagerModal:"#favManagerModal",favManagerTitle:"#favManagerTitle",favManagerBody:"#favManagerBody",favManagerItemTpl:"#favManagerItemTpl",favManagerEditBtn:'#favManagerModal [data-act="edit-selected-fav"]',favManagerDelBtn:'#favManagerModal [data-act="del-selected-fav"]',favAddModal:"#favAddModal",favAddCodeInput:'[name="fav_code_add"]',favAddPriceInput:'[name="fav_price_add"]',favEditModal:"#favEditModal",favEditCodeInput:'[name="fav_code_edit"]',favEditPriceInput:'[name="fav_price_edit"]',roomDefaultsModal:"#roomDefaultsModal",roomDefaultsForm:"#roomDefaultsForm",roomDefaultsApplyBtn:"#roomDefaultsApplyBtn",roomDefaultsConfirmBtn:"#roomDefaultsConfirmBtn",roomDefaultsCancelBtn:"#roomDefaultsCancelBtn",overviewModal:"#overviewModal",overviewModalHeader:"#overviewModalHeader",overviewModalBody:"#overviewModalBody"},y=e=>{typeof e=="string"&&(e=e.replace(/,/g,""));const a=parseFloat(e);return Number.isFinite(a)?a:0},X=e=>{const a=y(e);return a>0?a.toFixed(2):""},oe=(e,a=2,l=!1)=>Number.isFinite(e)?e.toLocaleString("en-US",{minimumFractionDigits:l?2:a,maximumFractionDigits:l?2:a}):"0",C=(e,a=0)=>Number.isFinite(e)?e.toLocaleString("th-TH",{minimumFractionDigits:a,maximumFractionDigits:a}):"0",qe=(e,a=150)=>{let l;return(...o)=>{clearTimeout(l),l=setTimeout(()=>e(...o),a)}},ht=(e,a=700)=>{let l=!1;return(...o)=>{if(!l){l=!0;try{return e(...o)}finally{setTimeout(()=>{l=!1},a)}}}},T=e=>typeof e!="string"?"":e.replace(/[&<>"']/g,function(a){switch(a){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";default:return"&#039;"}}),tt=e=>typeof e!="string"?"":e.replace(/[\\/?%*:|"<>\x00-\x1f]/g,"").trim()||"file";function yt(e){let a=y(e);if(isNaN(a))return"ข้อมูลตัวเลขไม่ถูกต้อง";if(a===0)return"ศูนย์บาทถ้วน";const l=["","หนึ่ง","สอง","สาม","สี่","ห้า","หก","เจ็ด","แปด","เก้า"],o=["","สิบ","ร้อย","พัน","หมื่น","แสน","ล้าน"];let t=Math.floor(a),n=Math.round((a-t)*100);const r=d=>{if(d===0)return"";let c="";const p=String(d);for(let u=0;u<p.length;u++){const f=p[u],v=p.length-u-1;f!=="0"&&(v===1&&f==="1"?c+=o[v]:v===1&&f==="2"?c+="ยี่"+o[v]:v===0&&f==="1"&&p.length>1?c+="เอ็ด":c+=l[parseInt(f)]+o[v])}return c};let s="";if(t>0){const d=Math.floor(t/1e6),c=t%1e6;d>0&&(s+=r(d)+"ล้าน"),s+=r(c),s+="บาท"}let i="";return n>0?i=r(n)+"สตางค์":t>0&&(s+="ถ้วน"),(s+i).trim()}const We="marnthara.favorites.v4",Se={fabric:[],sheer:[],wallpaper:[],wooden_blind:[],roller_blind:[],vertical_blind:[],partition:[],pleated_screen:[],aluminum_blind:[]};function ce(){try{const e=localStorage.getItem(We);return e?{...Se,...JSON.parse(e)}:Se}catch(e){return console.error("Failed to parse favorites from localStorage",e),Se}}function Ie(e){try{localStorage.setItem(We,JSON.stringify(e))}catch(a){console.error("Failed to save favorites to localStorage",a)}}function Ge(e){if(!e||typeof e!="object")return console.error("Invalid favorites data for import."),!1;const a={...Se,...e};return Ie(a),!0}function He(e){if(!e||typeof e!="object")return console.error("Invalid favorites data for merge."),0;const a=ce();let l=0;for(const o in e)Object.hasOwnProperty.call(e,o)&&Array.isArray(e[o])&&(a[o]||(a[o]=[]),e[o].forEach(t=>{t&&t.code&&t.hasOwnProperty("price")?a[o].some(r=>r.code===t.code)||(a[o].push({code:t.code,price:t.price}),l++):console.warn(`Skipping invalid favorite item during merge for type ${o}:`,t)}),a[o].sort((t,n)=>t.code.localeCompare(n.code)));return l>0&&Ie(a),l}function Ue(e,a,l){const o=ce(),t=a?.trim();if(!t)return console.error(`Attempted to add favorite with empty code for type: ${e}`),!1;if(typeof l!="number"||isNaN(l)||l<0)return console.error(`Attempted to add favorite with invalid price (${l}) for code ${t}`),!1;if(!Object.hasOwnProperty.call(Se,e))return console.error(`Attempted to add favorite to an invalid type: ${e}`),!1;o[e]||(o[e]=[]);const n=o[e],r=n.find(s=>s.code===t);return r?r.price=l:n.push({code:t,price:l}),n.sort((s,i)=>s.code.localeCompare(i.code)),Ie(o),!0}function Je(e,a){const l=ce(),o=a?.trim();if(!l[e]||!o)return!1;const t=l[e].findIndex(n=>n.code===o);return t>-1?(l[e].splice(t,1),Ie(l),!0):!1}function _t(){localStorage.removeItem(We),console.log("All favorites have been cleared.")}function U(){const e=ce(),a={app_version:ut,customer_name:document.querySelector(m.customerNameInput)?.value||"",customer_phone:document.querySelector(m.customerPhoneInput)?.value||"",customer_address:document.querySelector(m.customerAddressInput)?.value||"",customer_card_open:document.querySelector(m.customerCard)?.open,discount:{type:document.querySelector(m.discountTypeInput)?.value||"amount",value:y(document.querySelector(m.discountValueInput)?.value)},rooms:[],favorites:e};return document.querySelectorAll(m.room).forEach(l=>{const o={id:l.id,room_name:l.querySelector(m.roomNameInput)?.value||"",is_suspended:l.classList.contains("is-suspended"),is_open:l.open,room_defaults:JSON.parse(l.dataset.roomDefaults||"{}"),items:[]};l.querySelector(m.allItemsContainer)?.childNodes.forEach(t=>{if(t.nodeType!==1||!t.matches(m.itemCard))return;if(t.classList.contains("placeholder-item")){const s={type:"placeholder",is_suspended:t.classList.contains("is-suspended"),width_m:y(t.dataset.widthM),height_m:y(t.dataset.heightM)};o.items.push(s);return}const n=t.dataset.type;if(!n)return;let r={type:n,is_suspended:t.classList.contains("is-suspended")};if(n==="set")Object.assign(r,{width_m:y(t.querySelector(m.setWidthInput)?.value),height_m:y(t.querySelector(m.setHeightInput)?.value),style:t.querySelector(m.setStyleSelect)?.value||"",fabric_variant:t.querySelector(m.setFabricVariantSelect)?.value||"",price_per_m_raw:y(t.querySelector(m.setPricePerMSelect)?.value),sheer_price_per_m:y(t.querySelector(m.setSheerPricePerMSelect)?.value),louis_price_per_m:y(t.querySelector('select[name="louis_price_per_m"]')?.value),fabric_code:t.querySelector(m.setFabricCodeInput)?.value||"",sheer_fabric_code:t.querySelector(m.setSheerCodeInput)?.value||"",opening_style:t.querySelector(m.setOpeningStyleSelect)?.value||"",adjustment_side:t.querySelector(m.setAdjustmentSideSelect)?.value||"ปรับขวา",track_color:t.querySelector(m.setTrackColorInput)?.value||"ขาว",bracket_color:t.querySelector(m.setBracketColorInput)?.value||"ขาว",finial_color:t.querySelector(m.setFinialColorInput)?.value||"ขาว",grommet_color:t.querySelector(m.setGrommetColorInput)?.value||"เงิน",louis_valance:t.querySelector('input[name="louis_valance"]')?.value||"กล่องหลุยส์",louis_tassels:t.querySelector('input[name="louis_tassels"]')?.value||"สีเข้ากับผ้า",notes:t.querySelector(m.setNotesInput)?.value||""});else if(n==="wallpaper"){const s=t.querySelector(m.wallInstallCostInput),i=s?s.value:"";let d;i==="0"?d=0:y(i)>0?d=y(i):d=void 0,Object.assign(r,{height_m:y(t.querySelector(m.wallHeightInput)?.value),wallpaper_code:t.querySelector(m.wallCodeInput)?.value||"",price_per_roll:y(t.querySelector(m.wallPriceRollInput)?.value),install_cost_per_roll:d,notes:t.querySelector(m.wallNotesInput)?.value||"",widths:Array.from(t.querySelectorAll(m.wallWidthInput)).map(c=>y(c.value))})}else t.matches(m.areaBasedItem)&&(Object.assign(r,{width_m:y(t.querySelector(m.areaWidthInput)?.value),height_m:y(t.querySelector(m.areaHeightInput)?.value),price_sqyd:y(t.querySelector(m.areaPriceSqydInput)?.value),code:t.querySelector(m.areaCodeInput)?.value||"",notes:t.querySelector(m.areaNotesInput)?.value||""}),(n==="partition"||n==="pleated_screen")&&(r.opening_style=t.querySelector('select[name="opening_style"]')?.value||"แยกกลาง"),["wooden_blind","roller_blind","vertical_blind","aluminum_blind"].includes(n)&&(r.adjustment_side=t.querySelector('select[name="adjustment_side"]')?.value||"ปรับขวา"));o.items.push(r)}),a.rooms.push(o)}),a}function z(){try{const e=U();localStorage.setItem(ge,JSON.stringify(e))}catch(e){console.error("Failed to save data to localStorage:",e)}}const me=[],vt=10;function se(e){if(!e){console.warn("Attempted to push invalid state to undo stack.");return}try{const a=JSON.parse(JSON.stringify(e));me.push(a),me.length>vt&&me.shift()}catch(a){console.error("Failed to clone state for undo history:",a)}}function gt(){if(me.length!==0)return me.pop()}function bt(){return me.length>0}const D={stylePlus:e=>be.style_surcharge[e]??0,heightPlus:e=>{const a=[...be.height].sort((l,o)=>o.threshold-l.threshold);for(const l of a)if(e>l.threshold)return l.add_per_m;return 0},fabricYardage:(e,a)=>{const l=y(a);if(l<=0||!e)return 0;if(e==="ตาไก่"||e==="จีบ")return(l*2+.6)/.9;if(e==="ลอน")return(l*2.6+.6)/.9;if(e==="ม่านพับ")return(l+.3)/.9;if(e==="หลุยส์"){const t=Math.max(3,Math.ceil(l/.8))*1.5,n=2.5*2;return(l*2+.6+t+n)/.9}return 0},calculateGrommets:function(e){if(!e||e.style!=="ตาไก่"||y(e.width_m)<=0)return 0;const a=y(e.width_m),l=2,o=.05,t=.16;let n;e.opening_style==="แยกกลาง"?n=a/2:n=a;const r=n*l+2*o;let s=Math.round(r/t);return s%2!==0&&(s+=1),s<4&&(s=4),e.opening_style==="แยกกลาง"?s*2:s},wallpaperRolls:(e,a)=>{const l=y(e),o=y(a);if(l<=0||o<=0)return 0;const t=o>2.5?Math.floor(Pe.ROLL_LENGTH_M/o):Pe.STRIPS_PER_ROLL_UNDER_2_5M;if(t<=0)return 0;const n=Math.ceil(l/Pe.ROLL_WIDTH_M);return Math.ceil(n/t)},calculateSetPrice:function(e){if(!e||e.is_suspended||y(e.width_m)<=0)return{total:0,opaque:0,sheer:0,louis:0};const a=this.stylePlus(e.style),l=this.heightPlus(y(e.height_m)),o=y(e.width_m),t=y(e.price_per_m_raw),n=y(e.sheer_price_per_m),r=y(e.louis_price_per_m);let s=0,i=0,d=0;return e.style==="หลุยส์"?(e.fabric_variant?.includes("ทึบ")&&t>0&&(s=(t+a+l)*o),e.fabric_variant?.includes("โปร่ง")&&n>0&&(i=(n+a+l)*o),r>0&&(d=(r+l)*o)):(e.fabric_variant?.includes("ทึบ")&&t>0&&(s=(t+a+l)*o),e.fabric_variant?.includes("โปร่ง")&&n>0&&(i=(n+a+l)*o)),{total:Math.round(s+i+d),opaque:Math.round(s),sheer:Math.round(i),louis:Math.round(d)}},calculateAreaBasedPrice:function(e){if(!e||e.is_suspended||y(e.width_m)<=0||y(e.height_m)<=0)return{total:0,sqm:0,sqyd:0};const a=y(e.width_m)*y(e.height_m),l=a*mt,o=l*y(e.price_sqyd);return{total:Math.round(o),sqm:a,sqyd:l}},calculateWallpaperPrice:function(e){if(!e||e.is_suspended)return{total:0,material:0,install:0,rolls:0,sqm:0};const a=e.widths?.reduce((s,i)=>s+y(i),0)||0;if(a<=0)return{total:0,material:0,install:0,rolls:0,sqm:0};const l=y(e.height_m),o=this.wallpaperRolls(a,l),t=o*y(e.price_per_roll),n=e.install_cost_per_roll===""||e.install_cost_per_roll===null||e.install_cost_per_roll===void 0?300:y(e.install_cost_per_roll),r=o*n;return{total:Math.round(t+r),material:Math.round(t),install:Math.round(r),rolls:o,sqm:a*l}}},Y=Object.entries(F).reduce((e,[a,l])=>(e[a]=l.name,e),{});Y.set_louis="ม่านหลุยส์";function de(e){const{width:a=0,height:l=0}=e,o=15,t=100-o*2,n=100-o*2,r=a>0&&l>0?Math.min(t/a,n/l):1,s=a*r,i=l*r,d=(100-s)/2,c=(100-i)/2,p=`
        <line x1="${d}" y1="${c+i+5}" x2="${d+s}" y2="${c+i+5}" class="dimension-line" />
        <line x1="${d}" y1="${c+i+3}" x2="${d}" y2="${c+i+7}" class="dimension-tick" />
        <line x1="${d+s}" y1="${c+i+3}" x2="${d+s}" y2="${c+i+7}" class="dimension-tick" />
        <text x="50" y="${c+i+14}" class="dimension-text">${a.toFixed(2)} ม.</text>

        <line x1="${d-5}" y1="${c}" x2="${d-5}" y2="${c+i}" class="dimension-line" />
        <line x1="${d-7}" y1="${c}" x2="${d-3}" y2="${c}" class="dimension-tick" />
        <line x1="${d-7}" y1="${c+i}" x2="${d-3}" y2="${c+i}" class="dimension-tick" />
        <text x="${d-9}" y="50" class="dimension-text" transform="rotate(-90, ${d-9}, 50)">${l.toFixed(2)} ม.</text>
    `;return{x:d,y:c,svgWidth:s,svgHeight:i,lines:p}}function ot(e,{y:a,svgHeight:l}){if(!e.opening_style||e.opening_style==="สไลด์เดี่ยว")return"";const o=e.opening_style==="แยกกลาง"?"< >":"→";return`
        <rect x="40" y="${a+l/2-8}" width="20" height="16" rx="3" class="opening-text-bg" />
        <text x="50" y="${a+l/2+1}" class="opening-text">${o}</text>
    `}function Le(e,{x:a,y:l,svgWidth:o}){if(!e.adjustment_side)return"";const n=e.adjustment_side==="ปรับซ้าย"?a+8:a+o-8;return`
        <g class="adjustment-cord">
            <circle cx="${n}" cy="${l+3}" r="2"/>
            <line x1="${n}" y1="${l+5}" x2="${n}" y2="${l+15}"/>
        </g>
    `}function St(e){const a=y(e.width_m),l=y(e.height_m);if(a<=0||l<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:o,y:t,svgWidth:n,svgHeight:r,lines:s}=de({width:a,height:l});let i="";const d=e.fabric_variant.includes("โปร่ง"),c=e.fabric_variant.includes("ทึบ"),p=(v,_)=>(e.opening_style||"แยกกลาง")==="แยกกลาง"?`
                <rect x="${o}" y="${t+_}" width="${n/2-1}" height="${r}" class="${v}" />
                <rect x="${o+n/2+1}" y="${t+_}" width="${n/2-1}" height="${r}" class="${v}" />
            `:`<rect x="${o}" y="${t+_}" width="${n}" height="${r}" class="${v}" />`;d&&(i+=p("curtain-panel-sheer",0)),c&&(i+=p("curtain-panel-opaque",d?-2:0));let u="";if(e.style==="ตาไก่"){const v=D.calculateGrommets(e)/((e.opening_style||"แยกกลาง")==="แยกกลาง"?2:1),_=Math.min(Math.floor(v),Math.max(8,Math.floor(n/8)));for(let h=0;h<_;h++){const b=o+n/(_>1?_-1:1)*h;u+=`<circle cx="${b}" cy="${t+2}" r="2" class="style-grommet" />`}}else if(e.style==="ลอน"){const v=Math.max(4,Math.floor(n/10));let _=`M ${o},${t}`;for(let h=0;h<v;h++)_+=" q 5,-4 10,0";u=`<path d="${_}" class="style-ripplefold-path" />`}else e.style==="จีบ"&&(u=`<text x="${o+2}" y="${t+5}" class="style-pleat-text">||| ||| ||| ||| |||</text>`);const f=ot(e,{y:t,svgHeight:r});return`<svg viewBox="0 0 100 100">${i}${u}${f}${s}</svg>`}function wt(e){const a=y(e.width_m),l=y(e.height_m);if(a<=0||l<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:o,y:t,svgWidth:n,svgHeight:r,lines:s}=de({width:a,height:l});let i="";const d=e.fabric_variant.includes("โปร่ง"),c=e.fabric_variant.includes("ทึบ"),p=(h,b)=>`
        <rect x="${o}" y="${t+b}" width="${n/2-1}" height="${r}" class="${h}" />
        <rect x="${o+n/2+1}" y="${t+b}" width="${n/2-1}" height="${r}" class="${h}" />
    `;d&&(i+=p("curtain-panel-sheer",0)),c&&(i+=p("curtain-panel-opaque",d?-2:0));const u=Math.max(3,Math.floor(n/15)),f=n/u;let v="";for(let h=0;h<u;h++){const b=o+h*f;v+=`<path d="M ${b},${t} Q ${b+f/2},${t+10} ${b+f},${t}" class="louis-swag" />`}v+=`
        <polygon points="${o},${t} ${o+8},${t} ${o},${t+15}" class="louis-tail" />
        <polygon points="${o+n},${t} ${o+n-8},${t} ${o+n},${t+15}" class="louis-tail" />
    `;let _="";if(e.louis_tassels&&e.louis_tassels!=="ไม่มี"){_+=`<circle cx="${o+5}" cy="${t+18}" r="2" class="louis-tassel" />`,_+=`<circle cx="${o+n-5}" cy="${t+18}" r="2" class="louis-tassel" />`;for(let h=1;h<u;h++)_+=`<circle cx="${o+h*f}" cy="${t+8}" r="2" class="louis-tassel" />`}return`<svg viewBox="0 0 100 100">${i}${v}${_}${s}</svg>`}function qt(e){const a=y(e.width_m),l=y(e.height_m);if(a<=0||l<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:o,y:t,svgWidth:n,svgHeight:r,lines:s}=de({width:a,height:l});let i=`<rect x="${o}" y="${t}" width="${n}" height="${r}" class="blind-frame" />`;const d=5,c=r/d;for(let u=0;u<d;u++)i+=`<rect x="${o+1}" y="${t+u*c}" width="${n-2}" height="${c-1.5}" class="blind-slat" />`;const p=Le(e,{x:o,y:t,svgWidth:n});return`<svg viewBox="0 0 100 100">${i}${s}${p}</svg>`}function Ye(e,a=!1){const l=y(e.width_m),o=y(e.height_m);if(l<=0||o<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:t,y:n,svgWidth:r,svgHeight:s,lines:i}=de({width:l,height:o});let d=`<rect x="${t}" y="${n}" width="${r}" height="${s}" class="blind-frame" />`;if(a){const p=Math.max(4,Math.floor(r/8)),u=r/p;for(let f=0;f<p;f++)d+=`<rect x="${t+f*u+1}" y="${n}" width="${u-2}" height="${s}" class="blind-slat" />`}else{const p=Math.max(3,Math.floor(s/6)),u=s/p;for(let f=0;f<p;f++)d+=`<rect x="${t+1}" y="${n+f*u+.5}" width="${r-2}" height="${u-1}" class="blind-slat" />`}const c=Le(e,{x:t,y:n,svgWidth:r});return`<svg viewBox="0 0 100 100">${d}${i}${c}</svg>`}function $t(e){const a=y(e.width_m),l=y(e.height_m);if(a<=0||l<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:o,y:t,svgWidth:n,svgHeight:r,lines:s}=de({width:a,height:l});let i=`<rect x="${o}" y="${t}" width="${n}" height="${r}" class="blind-frame" />`;const d=Math.max(3,Math.floor(r/8)),c=r/d;for(let h=0;h<d;h++)i+=`<rect x="${o+1}" y="${t+h*c}" width="${n-2}" height="${c-1.5}" rx="0.5" class="wooden-blind-slat" />`;const p=Math.max(2,n*.05),u=o+n*.25-p/2,f=o+n*.75-p/2,v=`
        <rect x="${u}" y="${t}" width="${p}" height="${r}" class="wooden-blind-strip" />
        <rect x="${f}" y="${t}" width="${p}" height="${r}" class="wooden-blind-strip" />
    `,_=Le(e,{x:o,y:t,svgWidth:n});return`<svg viewBox="0 0 100 100">${i}${v}${s}${_}</svg>`}function kt(e){const a=y(e.width_m),l=y(e.height_m);if(a<=0||l<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:o,y:t,svgWidth:n,svgHeight:r,lines:s}=de({width:a,height:l}),i=`
        <rect x="${o}" y="${t}" width="${n}" height="${r}" class="roller-fabric" />
        <rect x="${o-1}" y="${t-4}" width="${n+2}" height="5" rx="2" class="roller-roll" />
        <line x1="${o}" y1="${t+r}" x2="${o+n}" y2="${t+r}" class="roller-bar" />
    `,d=Le(e,{x:o,y:t-2,svgWidth:n});return`<svg viewBox="0 0 100 100">${i}${s}${d}</svg>`}function Qe(e,a=!1){const l=y(e.width_m),o=y(e.height_m);if(l<=0||o<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:t,y:n,svgWidth:r,svgHeight:s,lines:i}=de({width:l,height:o});let d="";if(a)d=`
            <defs>
                <pattern id="pleated-mesh" width="6" height="6" patternUnits="userSpaceOnUse">
                    <path d="M -1 1 L 1 -1 M 0 6 L 6 0" class="pleated-screen-mesh" />
                </pattern>
            </defs>
            <rect x="${t}" y="${n}" width="${r}" height="${s}" class="blind-frame" />
            <rect x="${t}" y="${n}" width="${r}" height="${s}" fill="url(#pleated-mesh)" />
        `;else{const p=Math.max(4,Math.floor(r/10)),u=r/p;for(let f=0;f<p;f++)d+=`<rect x="${t+f*u}" y="${n}" width="${u}" height="${s}" class="partition-panel" />`,f>0&&(d+=`<line x1="${t+f*u}" y1="${n}" x2="${t+f*u}" y2="${n+s}" class="partition-hinge" />`)}const c=ot(e,{y:n,svgHeight:s});return`<svg viewBox="0 0 100 100">${d}${c}${i}</svg>`}function xt(e){const a=(e.widths||[]).reduce((u,f)=>u+y(f),0),l=y(e.height_m);if(a<=0||l<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:o,y:t,svgWidth:n,svgHeight:r,lines:s}=de({width:a,height:l});let i="";const d=Math.floor(n/10),c=Math.floor(r/10);for(let u=0;u<c;u++)for(let f=0;f<d;f++)i+=`<circle cx="${o+f*10+5}" cy="${t+u*10+5}" r="1.5" class="wallpaper-pattern" />`;return`<svg viewBox="0 0 100 100">${`<rect x="${o}" y="${t}" width="${n}" height="${r}" class="blind-frame" /> ${i}`}${s}</svg>`}function Mt(e,a,l){let o="",t=Y[e.type]||"ของตกแต่ง";switch(e.type){case"set":e.style==="ม่านพับ"?o=qt(e):e.style==="หลุยส์"?(o=wt(e),t=Y.set_louis||"ม่านหลุยส์"):o=St(e);break;case"wooden_blind":o=$t(e);break;case"aluminum_blind":o=Ye(e,!1);break;case"vertical_blind":o=Ye(e,!0);break;case"roller_blind":o=kt(e);break;case"partition":o=Qe(e,!1);break;case"pleated_screen":o=Qe(e,!0);break;case"wallpaper":o=xt(e);break;default:o=`<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">${T(t)}</text></svg>`;break}return`<div class="visual-placeholder is-clickable"
                 data-act="jump-to-item"
                 data-room-id="${a}"
                 data-item-index="${l}"
                 title="คลิกเพื่อไปยังรายการนี้">${o}</div>`}function Ke(e){let a=`
📃 *สรุปรายการสินค้า*
`,l=!1;return e.rooms.forEach(o=>{if(o.is_suspended||!o.items)return;const t=o.items.filter(r=>r.is_suspended?!1:r.type==="wallpaper"?(r.widths||[]).reduce((s,i)=>s+y(i),0)>0:r.type==="set"||F[r.type]?.templateId==="#areaBasedTpl"?y(r.width_m)>0:!0);if(t.length===0)return;l=!0,a+=`
*🚪 ห้อง: ${o.room_name||"ไม่ระบุ"}*
`;let n=0;t.forEach(r=>{n++;let s=Y[r.type]||"สินค้าตกแต่ง";r.type==="set"?r.style==="หลุยส์"?(s=Y.set_louis||"ม่านหลุยส์",a+=` ${n}) ${s} (${r.fabric_variant||""})
`):a+=` ${n}) ${s} ${r.style||""} (${r.fabric_variant||""})
`:a+=` ${n}) ${s}
`})}),l?a+`------------------------------
`:""}function rt(e){return e.rooms.reduce((a,l)=>{if(l.is_suspended)return a;const o=l.items?.reduce((t,n)=>{if(n.is_suspended)return t;switch(n.type){case"set":return t+D.calculateSetPrice(n).total;case"wallpaper":return t+D.calculateWallpaperPrice(n).total;default:return F[n.type]?.templateId==="#areaBasedTpl"?t+D.calculateAreaBasedPrice(n).total:t}},0)||0;return a+o},0)}function Tt(e,a){const l=rt(e);let o=0,t="";e.discount&&e.discount.value>0&&(e.discount.type==="percent"?(o=l*(e.discount.value/100),t=`🏷️ ส่วนลด (${e.discount.value}%): -${C(o)} บาท
`):(o=e.discount.value,t=`🏷️ ส่วนลด: -${C(o)} บาท
`));const n=l-o;let r=`🗓️ สรุปข้อมูล (${new Date().toLocaleDateString("th-TH",{day:"numeric",month:"short",year:"2-digit"})})
`;if(r+=`👤 ลูกค้า: ${e.customer_name||"-"}
`,(a==="customer"||a==="owner")&&(r+=`📞 โทร: ${e.customer_phone||"-"}
`,r+=`🏠 ที่อยู่: ${e.customer_address||"-"}
`),r+=`------------------------------
`,a==="customer")return r+=Ke(e),o>0&&(r+=`
ยอดรวม: ${C(l)} บาท
`,r+=t),r+=`
💰 *ยอดสุทธิ: ${C(n)} บาท*
`,r+=`
ขอบคุณที่ใช้บริการค่ะ
${j.name}
โทร: ${j.phone}`,r;if(a==="purchase_order"||a==="owner"){a==="owner"&&(r+=Ke(e));const s={opaqueFabrics:[],sheerFabrics:[],wallpapers:[],allSets:[]};e.rooms.forEach(g=>{g.is_suspended||!g.items||g.items.forEach(S=>{let $=!S.is_suspended;if(S.type==="set"||F[S.type]?.templateId==="#areaBasedTpl")$=$&&y(S.width_m)>0&&y(S.height_m)>0;else if(S.type==="wallpaper"){const x=(S.widths||[]).reduce((w,L)=>w+y(L),0);$=$&&x>0&&y(S.height_m)>0}if($)switch(S.type){case"set":s.allSets.push(S),S.fabric_variant.includes("ทึบ")&&s.opaqueFabrics.push({code:S.fabric_code||"??",yards:D.fabricYardage(S.style,S.width_m)}),S.fabric_variant.includes("โปร่ง")&&s.sheerFabrics.push({code:S.sheer_fabric_code||"??",yards:D.fabricYardage(S.style,S.width_m)});break;case"wallpaper":const x=(S.widths||[]).reduce((L,k)=>L+y(k),0),w=D.wallpaperRolls(x,S.height_m);w>0&&s.wallpapers.push({code:S.wallpaper_code||"xxx",rolls:w});break;default:if(F[S.type]?.templateId==="#areaBasedTpl"){const L=S.type;s[L]||(s[L]=[]),s[L].push({code:S.code||"xxx",width:y(S.width_m),height:y(S.height_m),opening_style:S.opening_style,adjustment_side:S.adjustment_side})}break}})});const i={};if([...s.opaqueFabrics,...s.sheerFabrics].forEach(g=>{g.yards>0&&(i[g.code]=(i[g.code]||0)+g.yards)}),Object.keys(i).length>0){r+=`✂️ *รายการสั่งซื้อ (ผ้า)*
`,r+=`------------------------------
`,s.opaqueFabrics.filter(g=>g.yards>0).forEach(g=>{r+=`- ผ้าทึบ (Curtain)
`,r+=`  รหัส: #${g.code||"??"}
`,r+=`  จำนวน: ${g.yards.toFixed(2)} หลา

`}),s.sheerFabrics.filter(g=>g.yards>0).forEach(g=>{r+=`- ผ้าโปร่ง (Sheer)
`,r+=`  รหัส: #${g.code||"??"}
`,r+=`  จำนวน: ${g.yards.toFixed(2)} หลา

`}),r+=`------------------------------
`,r+=`📊 *สรุปยอดรวมผ้า (ตามรหัส)*
`,r+=`------------------------------
`;for(const[g,S]of Object.entries(i))r+=`  - รหัส #${g}: ${S.toFixed(2)} หลา
`;r+=`
`}const d=s.allSets.filter(g=>g.style==="หลุยส์"),c=s.allSets.filter(g=>g.style==="ม่านพับ"),p=s.allSets.filter(g=>g.style==="ตาไก่"),u=s.allSets.filter(g=>!["ม่านพับ","ตาไก่","หลุยส์"].includes(g.style));if(d.length>0){r+=`------------------------------
`,r+=`👑 *รายการสั่งซื้อ ราง (หลุยส์)*
`,r+=`------------------------------

`;let g=1;d.forEach(w=>{r+=`(${g++}) ราง ${w.style}, สี: ${w.track_color||"ขาว"}
`,r+=`  - รางหลัก (ทึบ/โปร่ง): ${Number(w.width_m).toFixed(2)} ม.
`,r+=`  - หัวหลุยส์: ${w.louis_valance||"กล่องหลุยส์"}
`,r+=`  - พู่: ${w.louis_tassels||"สีเข้ากับผ้า"}
`,w.notes&&a==="owner"&&(r+=`  📝 หมายเหตุ: ${w.notes}
`),r+=`
`});const S=[];d.forEach(w=>{S.push(Number(w.width_m)),w.fabric_variant==="ทึบ&โปร่ง"&&S.push(Number(w.width_m))});const $=S.reduce((w,L)=>{const k=L.toFixed(2);return w[k]=(w[k]||0)+1,w},{}),x=Object.entries($).sort((w,L)=>parseFloat(L[0])-parseFloat(w[0]));if(x.length>0){r+=`--- สรุปยอดรวมรางหลุยส์ ---
`,r+=`*จำนวนรางที่ต้องตัด (โดยประมาณ):*
`;for(const[w,L]of x)r+=`  - ขนาด ${w} ม. = ${L} เส้น
`;r+=`
`}}if(c.length>0){r+=`------------------------------
`,r+=`📏 *รายการสั่งซื้อ รางม่านพับ*
`,r+=`------------------------------

`;let g=1;c.forEach(x=>{r+=`(${g++}) รางม่านพับ
`,r+=`  - ขนาด: ${Number(x.width_m).toFixed(2)} ม.
`,r+=`  - สีราง: ${x.track_color||"ขาว"}
`,r+=`  - เชือกปรับ: ${x.adjustment_side||"ปรับขวา"}
`,x.notes&&a==="owner"&&(r+=`  📝 หมายเหตุ: ${x.notes}
`),r+=`
`});const S=c.reduce((x,w)=>{const L=Number(w.width_m).toFixed(2);return x[L]=(x[L]||0)+1,x},{}),$=Object.entries(S).sort((x,w)=>parseFloat(w[0])-parseFloat(x[0]));if($.length>0){r+=`--- สรุปยอดรวมรางม่านพับ ---
`,r+=`*จำนวนรางที่ต้องตัด:*
`;for(const[x,w]of $)r+=`  - ขนาด ${x} ม. = ${w} เส้น
`;r+=`
`}}if(u.length>0){r+=`------------------------------
`,r+=`📏 *รายการสั่งซื้อ ราง (ลอน/จีบ)*
`,r+=`------------------------------

`;let g=1;u.forEach(w=>{r+=`(${g++}) ราง ${w.style}, สี: ${w.track_color||"ขาว"}
`,w.fabric_variant.includes("ทึบ")&&(r+=`  - รางทึบ: ${Number(w.width_m).toFixed(2)} ม.
`),w.fabric_variant.includes("โปร่ง")&&(r+=`  - รางโปร่ง: ${Number(w.width_m).toFixed(2)} ม.
`),w.notes&&a==="owner"&&(r+=`  📝 หมายเหตุ: ${w.notes}
`),r+=`
`});const S=[];u.forEach(w=>{w.fabric_variant.includes("ทึบ")&&S.push(Number(w.width_m)),w.fabric_variant.includes("โปร่ง")&&S.push(Number(w.width_m))});const $=S.reduce((w,L)=>{const k=L.toFixed(2);return w[k]=(w[k]||0)+1,w},{}),x=Object.entries($).sort((w,L)=>parseFloat(L[0])-parseFloat(w[0]));if(x.length>0){r+=`--- สรุปยอดรวมรางลอน/จีบ ---
`,r+=`*จำนวนรางที่ต้องตัด:*
`;for(const[w,L]of x)r+=`  - ขนาด ${w} ม. = ${L} เส้น
`;r+=`
`}}if(p.length>0){r+=`------------------------------
`,r+=`📏 *รายการสั่งซื้อ ราง (ตาไก่)*
`,r+=`------------------------------

`;let g=1;p.forEach(k=>{r+=`(${g++}) ราง ${k.style}, สี: ${k.track_color||"ขาว"}
`,k.fabric_variant.includes("ทึบ")&&(r+=`  - รางทึบ: ${Number(k.width_m).toFixed(2)} ม.
`),k.fabric_variant.includes("โปร่ง")&&(r+=`  - รางโปร่ง: ${Number(k.width_m).toFixed(2)} ม.
`),k.notes&&a==="owner"&&(r+=`  📝 หมายเหตุ: ${k.notes}
`),r+=`
`}),r+=`--- สรุปยอดรวมรางตาไก่ ---
`;const S=[];p.forEach(k=>{k.fabric_variant.includes("ทึบ")&&S.push(Number(k.width_m)),k.fabric_variant.includes("โปร่ง")&&S.push(Number(k.width_m))});const $=6;S.sort((k,A)=>A-k);const x=[];for(const k of S){let A=!1;for(let M=0;M<x.length;M++)if(x[M]>=k-.001){x[M]-=k,A=!0;break}A||x.push($-k)}r+=`ใช้รางเต็ม (6 ม.) ทั้งหมด: *${x.length} เส้น*

`;const w=S.reduce((k,A)=>{const M=A.toFixed(2);return k[M]=(k[M]||0)+1,k},{}),L=Object.entries(w).sort((k,A)=>parseFloat(A[0])-parseFloat(k[0]));if(L.length>0){r+=`*สรุปจำนวนรางที่ต้องตัด:*
`;for(const[k,A]of L)r+=`  - ขนาด ${k} ม. = ${A} เส้น
`;r+=`
`}}const f={};let v={};s.allSets.forEach(g=>{const S=g.track_color||"ขาว",$=g.style,x=g.fabric_variant==="ทึบ&โปร่ง",w=y(g.width_m)>=1.6?3:2;if(f[S]||(f[S]={brackets:{},finials:0,grommets:{}}),f[S].brackets[$]||(f[S].brackets[$]={single:0,double:0}),$!=="ม่านพับ"&&$!=="หลุยส์"&&(x?f[S].brackets[$].double+=w:f[S].brackets[$].single+=w),$==="ตาไก่"){const L=x?4:2;f[S].finials+=L}if($==="ตาไก่"){const L=g.grommet_color||"เงิน",k=D.calculateGrommets(g);f[S].grommets[L]||(f[S].grommets[L]=0),f[S].grommets[L]+=k}if($==="หลุยส์"){const L=g.louis_tassels||"สีเข้ากับผ้า";L!=="ไม่มี"&&(v[L]=(v[L]||0)+2)}});const _=s.allSets.filter(g=>g.style!=="ม่านพับ"&&g.style!=="หลุยส์").length*2,h=Object.values(f).some(g=>Object.values(g.brackets).some(S=>S.single>0||S.double>0)||g.finials>0||Object.values(g.grommets).some(S=>S>0))||_>0,b=Object.keys(v).length>0;if(h||b){r+=`------------------------------
`,r+=`🔩 *รายการสั่งซื้อ อุปกรณ์ (Hardware)*
`,r+=`------------------------------

`;for(const[S,$]of Object.entries(f)){let x=!1,w=`**สี${S}**
`;const L=Object.keys($.brackets);if(L.length>0){let A="";L.forEach(M=>{!["ม่านพับ","หลุยส์"].includes(M)&&($.brackets[M].single>0||$.brackets[M].double>0)&&(A+=`    - ${M} (ชั้นเดียว): ${$.brackets[M].single} ตัว
`,A+=`    - ${M} (2ชั้น): ${$.brackets[M].double} ตัว
`)}),A&&(x=!0,w+=`  - ขาจับ:
${A}`)}$.finials>0&&(x=!0,w+=`  - หัวราง (ตาไก่): ${$.finials} ตัว
`);const k=Object.keys($.grommets);if(k.length>0){let A="";k.forEach(M=>{const W=$.grommets[M];W>0&&(A+=`    - สี${M}: ${W} ตัว
`)}),A&&(x=!0,w+=`  - ตาไก่:
${A}`)}x&&(r+=w+`
`)}let g="";if(_>0&&(g+=`  - ตะขอรวบม่าน (มาตรฐาน): ${_} ตัว
`),b){g+=`  - พู่/สายรวบ (หลุยส์):
`;for(const[S,$]of Object.entries(v))g+=`    - ${S}: ${$} ชุด
`}g&&(r+=`**อุปกรณ์รวม**
`+g+`
`)}const I=Object.keys(s).filter(g=>!["opaqueFabrics","sheerFabrics","wallpapers","allSets"].includes(g));I.length>0&&I.sort().forEach(g=>{const S=s[g],$=Y[g]||g;r+=`------------------------------
`,r+=`📦 *รายการสั่งซื้อ ${$}*
`,r+=`------------------------------

`,S.forEach(x=>{r+=`- รหัส: #${x.code||"xxx"}
  ขนาด: ${x.width.toFixed(2)} x ${x.height.toFixed(2)} ม.
`,x.opening_style&&(r+=`  รูปแบบเปิด: ${x.opening_style}
`),x.adjustment_side&&(r+=`  เชือกปรับ: ${x.adjustment_side}
`),r+=`
`})});const B={};if(s.wallpapers.forEach(g=>{B[g.code]=(B[g.code]||0)+g.rolls}),Object.keys(B).length>0){r+=`------------------------------
`,r+=`🎨 *รายการสั่งซื้อ (Wallpaper)*
`,r+=`------------------------------

`;for(const[g,S]of Object.entries(B))r+=`  - รหัส #${g}: ${S} ม้วน
`;r+=`
`}if(a==="purchase_order")return r+=`------------------------------
`,r}if(a==="seamstress"||a==="owner"){r+=`
🧵 *รายละเอียดสำหรับช่างเย็บผ้า*
`;let s=0;if(e.rooms.forEach(i=>{if(i.is_suspended||!i.items)return;const d=i.items.filter(c=>c.type==="set"&&!c.is_suspended&&y(c.width_m)>0&&y(c.height_m)>0);d.length!==0&&(s>0&&(r+=`==============================
`),r+=`
*🚪 ห้อง: ${i.room_name||"ไม่ระบุ"}*

`,d.forEach((c,p)=>{p>0&&(r+=`--------------------
`);const u=c.style==="หลุยส์"?Y.set_louis||"ม่านหลุยส์":c.style;r+=`*ชุดที่ ${p+1}/${d.length}: ${u} ${c.fabric_variant}*
`,c.style==="ม่านพับ"?r+=`  - เชือกปรับ: ${c.adjustment_side||"ปรับขวา"}
`:c.style==="หลุยส์"?(r+=`  - หัวหลุยส์: ${c.louis_valance||"กล่องหลุยส์"}
`,r+=`  - พู่: ${c.louis_tassels||"สีเข้ากับผ้า"}
`):r+=`  - รูปแบบเปิด: ${c.opening_style||"แยกกลาง"}
`,c.style==="หลุยส์"?(c.fabric_variant.includes("ทึบ")&&(r+=`  - ผ้าฐาน (ทึบ): #${c.fabric_code||"-"}
`),c.fabric_variant.includes("โปร่ง")&&(r+=`  - ผ้าฐาน (โปร่ง): #${c.sheer_fabric_code||"-"}
`)):(c.fabric_variant.includes("ทึบ")&&(r+=`  - ผ้าทึบ: #${c.fabric_code||"-"}
`),c.fabric_variant.includes("โปร่ง")&&(r+=`  - ผ้าโปร่ง: #${c.sheer_fabric_code||"-"}
`)),r+=`  - ขนาด: กว้าง ${Number(c.width_m).toFixed(2)} x สูง ${Number(c.height_m).toFixed(2)} ม.
`,c.notes&&a==="owner"&&(r+=`  📝 หมายเหตุ: ${c.notes}
`)}),r+=`
`,s++)}),s>0?r+=`==============================
`:r+=`ไม่มีรายการสำหรับช่าง
------------------------------
`,a==="seamstress")return r}return a==="owner"&&(r+=`
💰 *สรุปยอดรวม: ${C(n)} บาท*
`,o>0&&(r+=`   (ยอดก่อนลด: ${C(l)} บาท ${t.trim()})
`)),r}function It(e){if(!e.rooms||e.rooms.length===0)return'<p class="empty-summary">ไม่มีข้อมูลสำหรับแสดงผล</p>';let a="";const l={};let o=0;if(e.rooms.forEach(r=>{r.is_suspended||!r.items||r.items.forEach(s=>{if(s.is_suspended)return;let i=null,d=0;switch(s.type){case"set":d=D.calculateSetPrice(s).total,d>0&&(i=s.style==="หลุยส์"?"set_louis":"set");break;case"wallpaper":d=D.calculateWallpaperPrice(s).total,d>0&&(i=s.type);break;default:F[s.type]?.templateId==="#areaBasedTpl"&&(d=D.calculateAreaBasedPrice(s).total,d>0&&(i=s.type));break}i&&(l[i]=(l[i]||0)+1,o++)})}),o>0){const r=Object.entries(l).map(([s,i])=>{const d=Y[s]||Y[s.split("_")[0]]||"ของตกแต่ง";return`
                <span class="summary-tag" data-filter-type="${T(s)}" title="คลิกเพื่อกรองเฉพาะรายการนี้">
                    ${T(d)} <strong>${i}</strong>
                </span>`}).join("");r&&(a+=`
                <div class="overview-summary-group">
                    <h4><i class="ph ph-stack"></i> สรุปประเภทรายการ</h4>
                    <div class="summary-tags-container">
                        ${r}
                    </div>
                </div>`)}let t="",n=0;return e.rooms.forEach(r=>{if(r.is_suspended||!r.items)return;const s={};let i=0;if(r.items.forEach(d=>{if(d.is_suspended)return;let c=null,p=0;switch(d.type){case"set":p=D.calculateSetPrice(d).total,p>0&&(c=d.style==="หลุยส์"?"set_louis":"set");break;case"wallpaper":p=D.calculateWallpaperPrice(d).total,p>0&&(c=d.type);break;default:F[d.type]?.templateId==="#areaBasedTpl"&&(p=D.calculateAreaBasedPrice(d).total,p>0&&(c=d.type));break}c&&(s[c]=(s[c]||0)+1,i++)}),i>0){n+=i;const d=Object.entries(s).map(([c,p])=>{const u=Y[c]||Y[c.split("_")[0]]||"ของตกแต่ง";return`
                    <div class="overview-item">
                        <span>${T(u)}</span>
                        <span>${p}</span>
                    </div>`}).join("");t+=`
                <details class="overview-room-card">
                    <summary class="overview-room-summary">
                        <span class="room-name">${T(r.room_name)||"ไม่ระบุชื่อห้อง"}</span>
                        <div class="summary-tags">
                            <span class="room-item-count">${i} รายการ</span>
                            <i class="ph ph-caret-down expand-icon"></i>
                        </div>
                    </summary>
                    <div class="overview-room-items">${d}</div>
                </details>`}}),t&&(a+=`
            <div class="overview-breakdown-group">
                <h4><i class="ph ph-map-pin-line"></i> แจกแจงตามห้อง</h4>
                ${t}
            </div>`),o===0&&n===0?'<p class="empty-summary">ไม่มีรายการที่มีราคาสำหรับแสดงผล</p>':a}function Lt(e,a){const{vatRate:l=j.baseVatRate,pageBreakBuffer:o=3,showDetails:t=!0}=a,n=[];e.rooms.forEach(k=>{if(k.is_suspended||!k.items)return;const A=[];k.items.forEach(M=>{if(M.is_suspended)return;let W="",V=0,N=0,E=0,P=1,te=M.type==="set"&&M.style==="หลุยส์"?Y.set_louis||"ม่านหลุยส์":Y[M.type]||"สินค้าตกแต่ง",Q="";switch(M.type){case"set":if(V=D.calculateSetPrice(M).total,V>0){N=y(M.width_m),E=y(M.height_m);const K=M.style==="หลุยส์"?"":` ${T(M.style||"")}`;W=`${te}${K} (${T(M.fabric_variant||"")})`,t&&(Q=`<br><small>ขนาด ${N.toFixed(2)} x ${E.toFixed(2)} ม.${M.notes?` - ${T(M.notes)}`:""}</small>`),P=t?1.5:1}break;case"wallpaper":if(V=D.calculateWallpaperPrice(M).total,V>0){const K=(M.widths||[]).reduce((fe,dt)=>fe+y(dt),0),pe=D.wallpaperRolls(K,M.height_m);E=y(M.height_m),W=`${te}`,t&&(Q=`<br><small>รหัส: ${T(M.wallpaper_code)||"-"}, สูง ${E.toFixed(2)} ม. (ใช้ ${pe} ม้วน)</small>`),P=t?1.5:1}break;default:F[M.type]?.templateId==="#areaBasedTpl"&&(V=D.calculateAreaBasedPrice(M).total,V>0&&(N=y(M.width_m),E=y(M.height_m),W=`${te}`,t&&(Q=`<br><small>รหัส: ${T(M.code)||"-"}, ขนาด ${N.toFixed(2)} x ${E.toFixed(2)} ม.</small>`),P=t?1.5:1));break}V>0&&W&&A.push({description:W+Q,total:V,units:P})}),A.length>0&&(n.push({isRoomHeader:!0,roomName:T(k.room_name)||"ไม่ระบุชื่อห้อง",units:1.2}),n.push(...A))});const r=n.reduce((k,A)=>k+(A.total||0),0);if(r===0)return null;let s=0,i="",d=r;e.discount&&e.discount.value>0&&(e.discount.type==="percent"?(s=r*(e.discount.value/100),i=`<tr><td class="pdf-label">ส่วนลด (${e.discount.value}%)</td><td class="pdf-amount">-${oe(s,2,!0)}</td></tr>`):(s=e.discount.value,i=`<tr><td class="pdf-label">ส่วนลด</td><td class="pdf-amount">-${oe(s,2,!0)}</td></tr>`),d=r-s);const c=d*l,p=d+c,u=t?17:20,f=t?23:28,v=[];let _=[],h=0;n.forEach((k,A)=>{const M=v.length===0?u:f,W=h+k.units>M;let V=!1;if(k.isRoomHeader&&A<n.length-1){const E=n[A+1].units||(t?1.5:1);h+k.units+E>M&&h+k.units<=M&&(V=!0)}let N=!1;if(!W&&!V&&A<n.length-1){const E=M-(h+k.units),P=n[A+1].units||(t?1.5:1);E>0&&E<o&&E<P&&!k.isRoomHeader&&(N=!0)}(W||V||N)&&_.length>0&&(v.push(_),_=[],h=0),_.push(k),h+=k.units}),_.length>0&&v.push(_);const b=new Date,I=b.toLocaleDateString("th-TH",{year:"numeric",month:"long",day:"numeric"}),B=`QT-${b.getFullYear()}${(b.getMonth()+1).toString().padStart(2,"0")}${b.getDate().toString().padStart(2,"0")}`;let g="";try{g=new URL(j.logoUrl,document.baseURI).href}catch(k){console.warn("Could not create absolute logo URL:",k),g=j.logoUrl}let S="",$=0,x=1;v.forEach((k,A)=>{const M=A===0,W=A===v.length-1,V=`
            <div class="pdf-page-header">
                <div class="pdf-header">
                    <div class="pdf-shop-info">
                        ${g?`<img src="${g}" alt="Logo" class="pdf-logo">`:""}
                        <div class="pdf-shop-address">
                            <strong><i class="ph ph-github-logo"></i> ${T(j.name)}</strong><br>
                            ${T(j.address).replace(/\n/g,"<br>")}<br>
                            โทร: ${T(j.phone)} | เลขประจำตัวผู้เสียภาษี: ${T(j.taxId)}
                        </div>
                    </div>
                    <div class="pdf-quote-details">
                        <div class="pdf-title-box"><h1>ใบเสนอราคา ${v.length>1?M?"":"(ต่อ)":""}</h1></div>
                        <table class="pdf-quote-meta">
                            <tr><td>เลขที่:</td><td>${B}</td></tr>
                            <tr><td>วันที่:</td><td>${I}</td></tr>
                        </table>
                    </div>
                </div>
                ${M?`
                <section class="pdf-customer-details">
                    <div class="pdf-customer-info">
                        <strong>ลูกค้า:</strong> ${T(e.customer_name)||"-"}<br>
                        <strong>ที่อยู่:</strong> ${T(e.customer_address||"-").replace(/\n/g,"<br>")}<br>
                        <strong>โทร:</strong> ${T(e.customer_phone)||"-"}
                    </div>
                    <div class="pdf-customer-meta">
                        <strong>เงื่อนไขชำระเงิน:</strong> ${T(j.pdf.paymentTerms)}<br>
                        <strong>ยืนราคา:</strong> ${T(j.pdf.priceValidity)}
                    </div>
                </section>`:""}
            </div>`,N=`
            <div class="pdf-page-footer">
                <div class="pdf-footer-info">
                    <span><i class="ph ph-github-logo"></i> ${T(j.name)} | โทร: ${T(j.phone)}</span>
                    <span>หน้า ${A+1} / ${v.length}</span>
                </div>
            </div>`;let E="";M||(E+=`<tr class="pdf-subtotal-row"><td colspan="4">ยอดยกมา (Brought Forward)</td><td class="pdf-text-right">${oe($,2,!0)}</td></tr>`),k.forEach(K=>{K.isRoomHeader?E+=`<tr class="pdf-room-header"><td colspan="5">ห้อง: ${K.roomName}</td></tr>`:(E+=`<tr><td class="pdf-text-center">${x++}</td><td>${K.description}</td><td class="pdf-text-center">1</td><td class="pdf-text-right">${oe(K.total,2,!0)}</td><td class="pdf-text-right">${oe(K.total,2,!0)}</td></tr>`,$+=K.total)});let P="";W||(P=`<tfoot><tr class="pdf-subtotal-row"><td colspan="4">ยอดยกไป (Carried Forward)</td><td class="pdf-text-right">${oe($,2,!0)}</td></tr></tfoot>`);let te="";t&&j.pdf.notes&&j.pdf.notes.length>0&&(te=`
                <strong>หมายเหตุ:</strong>
                <ul>${j.pdf.notes.map(K=>`<li>${T(K)}</li>`).join("")}</ul>
            `);const Q=W?`
            <div class="pdf-summary-wrapper">
                <section class="pdf-summary-section">
                    <div class="pdf-amount-in-words">
                        ${te}
                        <div class="pdf-amount-text">( ${yt(p)} )</div>
                    </div>
                    <div class="pdf-totals-block">
                        <table>
                            <tr><td class="pdf-label">รวมเป็นเงิน</td><td class="pdf-amount">${oe(r,2,!0)}</td></tr>
                            ${i}
                            ${l>0?`<tr><td class="pdf-label">ภาษีมูลค่าเพิ่ม ${(l*100).toFixed(0)}%</td><td class="pdf-amount">${oe(c,2,!0)}</td></tr>`:""}
                            <tr class="pdf-grand-total"><td class="pdf-label">ยอดรวมสุทธิ</td><td class="pdf-amount">${oe(p,2,!0)}</td></tr>
                        </table>
                    </div>
                </section>
                <footer class="pdf-footer-section">
                    <div class="pdf-signature-box"><p>.................................................</p><p>ผู้เสนอราคา</p><p>(<i class="ph ph-github-logo"></i> ${T(j.name)})</p><p>วันที่: ${I}</p></div>
                    <div class="pdf-signature-box"><p>.................................................</p><p>ลูกค้า / ผู้มีอำนาจลงนาม</p><p>&nbsp;</p><p>วันที่: ......./......./............</p></div>
                </footer>
            </div>
        `:"";S+=`
            <div class="pdf-page">
                <div class="pdf-page-content">
                    ${V}
                    <div class="pdf-page-body">
                        <table class="pdf-items-table">
                            <thead><tr><th style="width:5%;">ลำดับ</th><th style="width:50%;">รายการ</th><th style="width:10%;">จำนวน</th><th style="width:17.5%;">ราคา/หน่วย</th><th style="width:17.5%;">รวม (บาท)</th></tr></thead>
                            <tbody>${E}</tbody>
                            ${P}
                        </table>
                        ${Q}
                    </div>
                    ${N}
                </div>
            </div>`});const w=e.customer_name||"quote",L=tt(w);return{html:`<div id="quotation-template">${S}</div>`,fileName:`${B}_${L}`}}function Ct(e){const a=rt(e);let l=0;e.discount?.value>0&&(l=e.discount.type==="percent"?a*(e.discount.value/100):e.discount.value);const o=a-l;let t=!1,n=e.rooms.map(s=>{if(s.is_suspended)return"";const i=s.items.filter(c=>c.is_suspended?!1:c.type==="set"||F[c.type]?.templateId==="#areaBasedTpl"?y(c.width_m)>0&&y(c.height_m)>0:c.type==="wallpaper"?(c.widths||[]).reduce((u,f)=>u+y(f),0)>0&&y(c.height_m)>0:!1);if(i.length===0)return"";const d=i.map((c,p)=>{let u="",f="",v="",_="";switch(c.type==="set"?c.style==="หลุยส์"?(_=Y.set_louis||"ม่านหลุยส์",f=`<h5 class="lookbook-item-title">${T(_)}</h5>`):_=Y.set||"ผ้าม่าน":(_=Y[c.type]||"ของตกแต่ง",f=`<h5 class="lookbook-item-title">${T(_)}</h5>`),c.type){case"set":v=`<tr><td>ขนาด</td><td>${y(c.width_m).toFixed(2)} x ${y(c.height_m).toFixed(2)} ม.</td></tr>`,c.style==="หลุยส์"?u=`
                            <tr><td>แบบ</td><td>${_} (${T(c.fabric_variant||"")})</td></tr>
                            ${c.fabric_variant.includes("ทึบ")?`<tr><td>ผ้าฐาน</td><td>#${T(c.fabric_code)||"-"}</td></tr>`:""}
                            ${c.fabric_variant.includes("โปร่ง")?`<tr><td>ผ้าโปร่ง</td><td>#${T(c.sheer_fabric_code)||"-"}</td></tr>`:""}
                            <tr><td>หัวหลุยส์</td><td>${T(c.louis_valance||"กล่องหลุยส์")}</td></tr>
                            <tr><td>พู่</td><td>${T(c.louis_tassels||"สีเข้ากับผ้า")}</td></tr>
                         `:(u=`
                            <tr><td>แบบ</td><td>${T(c.style||"")} (${T(c.fabric_variant||"")})</td></tr>
                            ${c.fabric_variant.includes("ทึบ")?`<tr><td>ทึบ</td><td>#${T(c.fabric_code)||"-"}</td></tr>`:""}
                            ${c.fabric_variant.includes("โปร่ง")?`<tr><td>โปร่ง</td><td>#${T(c.sheer_fabric_code)||"-"}</td></tr>`:""}
                        `,c.style==="ม่านพับ"?u+=`<tr><td>เชือก</td><td>${T(c.adjustment_side||"ปรับขวา")}</td></tr>`:u+=`<tr><td>เปิด</td><td>${T(c.opening_style||"แยกกลาง")}</td></tr>`);break;case"wallpaper":const h=(c.widths||[]).reduce((I,B)=>I+y(B),0),b=D.wallpaperRolls(h,c.height_m);v=`<tr><td>ขนาด</td><td>รวม ${h.toFixed(2)} ม., สูง ${y(c.height_m).toFixed(2)} ม.</td></tr>`,u=`
                        <tr><td>รหัส</td><td>#${T(c.wallpaper_code)||"-"}</td></tr>
                        <tr><td>ใช้</td><td>${b} ม้วน</td></tr>
                    `;break;default:F[c.type]?.templateId==="#areaBasedTpl"&&(v=`<tr><td>ขนาด</td><td>${y(c.width_m).toFixed(2)} x ${y(c.height_m).toFixed(2)} ม.</td></tr>`,u=`<tr><td>รหัส</td><td>#${T(c.code)||"-"}</td></tr>`,c.opening_style&&(u+=`<tr><td>เปิด</td><td>${T(c.opening_style)}</td></tr>`),c.adjustment_side&&(u+=`<tr><td>เชือก</td><td>${T(c.adjustment_side)}</td></tr>`));break}return u&&(t=!0),`
                 <div class="lookbook-details">
                    ${Mt(c,s.id,p)}
                    <div class="spec-table-wrapper">
                        ${f}
                        <table class="spec-table">
                            ${u}
                            ${v}
                            ${c.notes?`<tr><td>โน้ต</td><td>${T(c.notes)}</td></tr>`:""}
                        </table>
                    </div>
                </div>
            `}).join('<hr class="lookbook-hr">');return d.trim()?`
            <div class="lookbook-room">
                <h4><i class="ph ph-map-pin"></i> ${T(s.room_name)||"ไม่ระบุชื่อห้อง"}</h4>
                ${d}
            </div>
        `:""}).join("");return t?`
        <div class="lookbook-summary">
            <div class="lookbook-customer-info">
                <strong>ลูกค้า:</strong> ${T(e.customer_name)||"-"}<br/>
                <strong>ที่อยู่:</strong> ${T(e.customer_address||"-").replace(/\n/g,"<br/>")}
            </div>
            <div class="lookbook-totals">
                <span>ยอดรวม (ก่อนส่วนลด): ${C(a)} บาท</span>
                ${l>0?`<span>ส่วนลด: -${C(l)} บาท</span>`:""}
                <span class="grand-total">ยอดสุทธิ: ${C(o)} บาท</span>
            </div>
        </div>
    `+n:'<p class="empty-summary">ไม่มีรายการสำหรับสร้างรายงาน</p>'}function at(e={}){const a=document.querySelector(m.roomTpl);if(!a)return console.error("Room template not found"),null;const o=a.content.cloneNode(!0).firstElementChild;o.id=e.id||`room-${Date.now()}`,o.open=e.is_open!==!1,o.dataset.roomDefaults=JSON.stringify(e.room_defaults||{});const t=o.querySelector(m.roomNameInput),n=o.querySelector("[data-room-name-display]"),r=o.querySelector("[data-room-brief]"),s=o.querySelector(m.allItemsContainer),i=()=>{const p=t.value||"ห้อง (ไม่มีชื่อ)";n&&(n.textContent=p)};t&&t.addEventListener("input",i);const d=o.querySelector("summary");d&&d.addEventListener("click",()=>{});const c=e.room_name||`ห้อง ${document.querySelectorAll(m.room).length+1}`;if(t){t.value=c;const p=`room_name_${o.id}`;t.id=p;const u=t.closest(".form-group")?.querySelector("label");u&&u.setAttribute("for",p)}return n&&(n.textContent=c),e.is_suspended&&o.classList.add("is-suspended"),o.getItemsContainer=()=>s,o.updateBrief=p=>{r&&(r.innerHTML=p)},o}function Ce(e={}){const a=document.querySelector(m.setTpl);if(!a)return console.error("Set template not found"),null;const o=a.content.cloneNode(!0).firstElementChild;o.dataset.type="set";const t=o.querySelector('input[name="width_m"]'),n=o.querySelector('input[name="height_m"]'),r=o.querySelector('select[name="set_style"]'),s=o.querySelector('select[name="fabric_variant"]'),i=o.querySelector('select[name="set_price_per_m"]'),d=o.querySelector('select[name="sheer_price_per_m"]'),c=o.querySelector('select[name="louis_price_per_m"]'),p=o.querySelector('input[name="fabric_code"]'),u=o.querySelector('input[name="sheer_fabric_code"]'),f=o.querySelector('select[name="opening_style"]'),v=o.querySelector('select[name="adjustment_side"]'),_=o.querySelector('input[name="notes"]'),h=o.querySelector('[data-set-control="opening_style_wrap"]'),b=o.querySelector('[data-set-control="adjustment_side_wrap"]'),I=o.querySelector('[data-set-control="louis_price_wrap"]'),B=o.querySelector('[data-set-control="fabric_price_wrap"]'),g=o.querySelector('[data-set-control="fabric_code_wrap"]'),S=o.querySelector("[data-sheer-wrap]"),$=o.querySelector("[data-sheer-code-wrap]"),x=o.querySelector("[data-set-summary]"),w=o.querySelector(".item-details-more"),L=o.querySelector('[data-act="toggle-more-details"]')?.parentElement,k=()=>({width_m:t.value,height_m:n.value,style:r.value,fabric_variant:s.value,price_per_m_raw:i.value,sheer_price_per_m:d.value,louis_price_per_m:c.value,is_suspended:o.classList.contains("is-suspended")}),A=()=>{const N=k(),E=D.calculateSetPrice(N);o.dataset.totalPrice=E.total;let P=`ราคา: <b>${C(E.total)}</b> บ.`;if(N.style==="หลุยส์"){const Q=[];E.opaque>0&&Q.push(`ทึบ: ${C(E.opaque)}`),E.sheer>0&&Q.push(`โปร่ง: ${C(E.sheer)}`),E.louis>0&&Q.push(`หลุยส์: ${C(E.louis)}`),Q.length>0&&(P+=` <small>(${Q.join(", ")})</small>`)}else E.opaque>0&&E.sheer>0&&(P+=` <small>(ทึบ: ${C(E.opaque)}, โปร่ง: ${C(E.sheer)})</small>`);const te=D.fabricYardage(N.style,N.width_m);te>0&&(P+=` &bull; ใช้ผ้า: ${te.toFixed(2)} หลา`),x?x.innerHTML=P:console.warn("Summary element not found for set item.")},M=qe(()=>{A(),o.dispatchEvent(new CustomEvent("item-update",{bubbles:!0}))},200),W=()=>{const N=r.value,E=s.value,P=N==="หลุยส์",te=E.includes("โปร่ง"),Q=E==="โปร่ง"&&!P,K=E==="ทึบ"&&!P;S?.classList.toggle("hidden",!te||P),$?.classList.toggle("hidden",!te||P);const pe=Q||P;i&&(i.disabled=pe,pe&&(i.value="")),p&&(p.disabled=pe,pe&&(p.value=""));const fe=K||P;d&&(d.disabled=fe,fe&&(d.value="")),u&&(u.disabled=fe,fe&&(u.value=""))},V=()=>{const N=r.value,E=N==="ม่านพับ",P=N==="หลุยส์";h&&h.classList.toggle("hidden",E||P),b&&b.classList.toggle("hidden",!E),I&&I.classList.toggle("hidden",!P),B&&B.classList.toggle("hidden",P),g&&g.classList.toggle("hidden",P),W()};if(o.addEventListener("input",N=>{N.target===s&&W(),N.target===r&&V(),M()}),w&&L){const N=o.querySelector(".item-grid");N&&N.appendChild(L)}return t.value=X(e.width_m),n.value=X(e.height_m),r.value=e.style||"ลอน",s.value=e.fabric_variant||"ทึบ",i.value=e.price_per_m_raw||"",d.value=e.sheer_price_per_m||"",c.value=e.louis_price_per_m||"",p.value=e.fabric_code||"",u.value=e.sheer_fabric_code||"",f.value=e.opening_style||"แยกกลาง",v.value=e.adjustment_side||"ปรับขวา",_.value=e.notes||"",o.querySelector('input[name="track_color"]').value=e.track_color||"ขาว",o.querySelector('input[name="bracket_color"]').value=e.bracket_color||"ขาว",o.querySelector('input[name="finial_color"]').value=e.finial_color||"ขาว",o.querySelector('input[name="grommet_color"]').value=e.grommet_color||"เงิน",o.querySelector('input[name="louis_valance"]').value=e.louis_valance||"กล่องหลุยส์",o.querySelector('input[name="louis_tassels"]').value=e.louis_tassels||"สีเข้ากับผ้า",e.is_suspended&&o.classList.add("is-suspended"),V(),A(),o}function Oe(e={}){const a=document.querySelector(m.wallTpl);if(!a)return null;const o=a.content.cloneNode(!0).firstElementChild,t=o.querySelector('input[name="wall_width_m"]');t.value=X(e.width);const n=`wall_width_${Date.now()}_${Math.random().toString(36).substring(2,7)}`;t.id=n;const r=o.querySelector("label");return r&&r.setAttribute("for",n),o}function Be(e={}){const a=document.querySelector(m.wallpaperTpl);if(!a)return console.error("Wallpaper template not found"),null;const o=a.content.cloneNode(!0).firstElementChild;o.dataset.type="wallpaper";const t=o.querySelector('[name="wallpaper_height_m"]'),n=o.querySelector('[name="wallpaper_price_roll"]'),r=o.querySelector('[name="wallpaper_install_cost"]'),s=o.querySelector('[name="wallpaper_code"]'),i=o.querySelector('[name="wallpaper_notes"]'),d=o.querySelector("[data-walls-container]"),c=o.querySelector("[data-wallpaper-summary]"),p=o.querySelector(".item-details-more"),u=o.querySelector('[data-act="toggle-more-details"]')?.parentElement,f=()=>({height_m:t.value,price_per_roll:n.value,install_cost_per_roll:r.value,widths:Array.from(d.querySelectorAll('input[name="wall_width_m"]')).map(h=>h.value),is_suspended:o.classList.contains("is-suspended")}),v=()=>{const h=f(),b=D.calculateWallpaperPrice(h);o.dataset.totalPrice=b.total;let I=`รวม: <b>${C(b.total)}</b> บ. `;(b.material>0||b.install>0)&&(I+=`<small>(วอลล์: ${C(b.material)}, ค่าช่าง: ${C(b.install)})</small>`),b.rolls>0&&(I+=` &bull; พื้นที่: ${oe(b.sqm,2)} ตร.ม. &bull; ใช้: ${b.rolls} ม้วน`),c&&(c.innerHTML=I)},_=qe(()=>{v(),o.dispatchEvent(new CustomEvent("item-update",{bubbles:!0}))},200);if(o.addEventListener("input",_),p&&u){const h=o.querySelector(".item-grid");h&&h.appendChild(u)}if(e.widths&&e.widths.length>0)e.widths.forEach(h=>{const b=Oe({width:h});b&&d.appendChild(b)});else{const h=Oe();h&&d.appendChild(h)}return t.value=X(e.height_m),n.value=e.price_per_roll>0?C(e.price_per_roll):"",e.hasOwnProperty("install_cost_per_roll")?r.value=e.install_cost_per_roll===0?"0":e.install_cost_per_roll>0?C(e.install_cost_per_roll):"":r.value=r.value,s.value=e.wallpaper_code||"",i.value=e.notes||"",e.is_suspended&&o.classList.add("is-suspended"),v(),o}function Ae(e,a={}){const l=document.querySelector(m.areaBasedTpl);if(!l)return console.error("AreaBased template not found"),null;const t=l.content.cloneNode(!0).firstElementChild;t.dataset.type=e;const n=F[e]||{name:"ของตกแต่ง"};t.classList.add(`${e.replace(/_/g,"-")}-item`);const r=t.querySelector(".item-type-display"),s=t.querySelector('[name="area_width_m"]'),i=t.querySelector('[name="area_height_m"]'),d=t.querySelector('[name="area_price_sqyd"]'),c=t.querySelector('[name="area_code"]'),p=t.querySelector('[name="area_notes"]'),u=t.querySelector(".btn-favorite"),f=t.querySelector(".btn-show-favs"),v=t.querySelector("[data-area-summary]"),_=t.querySelector(".item-details-more"),h=t.querySelector('[data-act="toggle-more-details"]')?.parentElement,b=_?.querySelector(".item-grid"),I=b?.querySelector('[name="area_price_sqyd"]')?.closest(".form-group");let B,g;if(b&&I){if(e==="partition"||e==="pleated_screen"){const w=document.createElement("div");w.className="form-group",w.innerHTML=`
                <label>รูปแบบเปิด
                    <select name="opening_style">
                        <option value="แยกกลาง">แยกกลาง</option>
                        <option value="เก็บข้างเดียว">เก็บข้างเดียว</option>
                    </select>
                </label>
            `,b.insertBefore(w,I),B=w.querySelector("select")}else if(["wooden_blind","roller_blind","vertical_blind","aluminum_blind"].includes(e)){const w=document.createElement("div");w.className="form-group",w.innerHTML=`
                <label>เชือกปรับ
                    <select name="adjustment_side">
                        <option value="ปรับขวา">ปรับขวา</option>
                        <option value="ปรับซ้าย">ปรับซ้าย</option>
                    </select>
                </label>
            `,b.insertBefore(w,I),g=w.querySelector("select")}(B||g)&&I&&I.classList.remove("full-width-item")}const S=()=>({width_m:s.value,height_m:i.value,price_sqyd:d.value,is_suspended:t.classList.contains("is-suspended")}),$=()=>{const w=S(),L=D.calculateAreaBasedPrice(w);t.dataset.totalPrice=L.total;const k=L.sqyd>0?` &bull; พื้นที่: ${oe(L.sqyd,2)} ตร.หลา`:"";v&&(v.innerHTML=`ราคา: <b>${C(L.total)}</b> บ.${k}`)},x=qe(()=>{$(),t.dispatchEvent(new CustomEvent("item-update",{bubbles:!0}))},200);if(t.addEventListener("input",x),_&&h){const w=t.querySelector(".item-grid");w&&w.appendChild(h)}return r&&(r.textContent=n.name),c&&(c.dataset.favoriteType=e),u&&(u.dataset.type=e),f&&(f.dataset.type=e),s.value=X(a.width_m),i.value=X(a.height_m),d.value=a.price_sqyd>0?C(a.price_sqyd):"",c.value=a.code||"",p.value=a.notes||"",B&&(B.value=a.opening_style||"แยกกลาง"),g&&(g.value=a.adjustment_side||"ปรับขวา"),a.is_suspended&&t.classList.add("is-suspended"),$(),t}const O=[];let Z=!1,ke=null,R=null,ye=null,we=!1,G=null,De=!1,ie=null,ue=null,le=[];const Xe=document.querySelector("#undoBtn"),je="marnthara.theme",xe={};function Bt(e){if(xe[e])return xe[e];const a=new Promise((l,o)=>{const t=document.createElement("script");t.src=e,t.onload=()=>l(),t.onerror=()=>{console.error(`Script load error for ${e}`),delete xe[e],o(new Error(`Script load error for ${e}`))},document.head.appendChild(t)});return xe[e]=a,a}function nt(){const e=localStorage.getItem(je),a=document.querySelector("#themeToggleBtn");if(!a)return;const l=a.querySelector("i"),o=a.querySelector("span");switch(document.body.classList.remove("dark-theme","neutral-theme"),e){case"dark":document.body.classList.add("dark-theme"),l&&(l.className="ph-fill ph-sun"),o&&(o.textContent=" สว่าง");break;case"neutral":document.body.classList.add("neutral-theme"),l&&(l.className="ph-fill ph-moon"),o&&(o.textContent=" มืด");break;default:l&&(l.className="ph-fill ph-palette"),o&&(o.textContent=" กลาง");break}}function At(){const e=localStorage.getItem(je);let a="neutral";!e||e==="light"?a="neutral":e==="neutral"?a="dark":a="light",localStorage.setItem(je,a),nt()}function ee(){Xe&&(Xe.disabled=!bt())}function Et(){const e=gt();e&&(Ve(e,!1),q("ยกเลิกการกระทำล่าสุดแล้ว","success")),ee()}function _e(){const e=document.getElementById("suspendedItemsBtn");if(!e)return;if(ye){e.classList.remove("is-visible");return}const a=document.getElementById("suspendedCountBadge"),l=document.querySelectorAll(".item-card.is-suspended:not(.placeholder-item)").length,o=document.querySelectorAll(".room-card.is-suspended");let t=0;o.forEach(r=>{t+=r.querySelectorAll(".item-card:not(.is-suspended):not(.placeholder-item)").length});const n=l+t;a&&(a.textContent=n),e.classList.toggle("is-visible",n>0)}function Ne(){ye="suspended";const e=document.getElementById("filterStatusBar");let a=0;if(document.querySelectorAll(".room-card").forEach(o=>{let t=!1;const n=o.classList.contains("is-suspended");o.querySelectorAll(".item-card").forEach(s=>{const d=s.classList.contains("is-suspended")||n;s.classList.toggle("item-hidden",!d),d&&(t=!0,s.classList.contains("placeholder-item")||a++)});const r=n||t;o.classList.toggle("item-hidden",!r)}),document.querySelectorAll(".item-card.is-suspended:not(.placeholder-item)").length+Array.from(document.querySelectorAll(".room-card.is-suspended .item-card:not(.is-suspended):not(.placeholder-item)")).length===0){st(),q("ไม่มีรายการที่ถูกระงับแล้ว","success");return}e&&(e.innerHTML=`
            <span><i class="ph ph-warning"></i> รายการที่ถูกระงับ (${a} รายการ)</span>
            <button type="button" class="btn-chip" data-act="clear-filter" title="ยกเลิกการกรอง">
                <i class="ph ph-x"></i>&nbsp;ปิด
            </button>
        `,e.classList.add("is-visible"),e.dataset.filterType="suspended"),ae(),ne(),_e()}function Pt(e,a){if(!e)return;ye=e;const l=document.getElementById("filterStatusBar");let o=0;document.querySelectorAll(m.room).forEach(t=>{let n=0;t.querySelectorAll(".item-card").forEach(r=>{const s=r.dataset.type===e&&!r.classList.contains("placeholder-item");r.classList.toggle("item-hidden",!s),s&&n++}),t.querySelectorAll(".placeholder-item").forEach(r=>r.classList.toggle("item-hidden",n===0)),t.classList.toggle("item-hidden",n===0),n>0&&(o+=n)}),l&&(l.innerHTML=`
            <span>เฉพาะ: <strong>${T(a)}</strong> (${o} รายการ)</span>
            <button type="button" class="btn-chip" data-act="clear-filter" title="ยกเลิกการกรอง">
                <i class="ph ph-x"></i>&nbsp;ปิด
            </button>
        `,l.classList.add("is-visible"),l.dataset.filterType=e),ae(),ne(),_e()}function st(){ye=null;const e=document.getElementById("filterStatusBar");e&&(e.classList.remove("is-visible"),e.innerHTML="",e.removeAttribute("data-filter-type")),document.querySelectorAll(".item-hidden").forEach(a=>a.classList.remove("item-hidden")),ae(),ne(),_e()}function q(e,a="default"){const l=document.querySelector(m.toastContainer);if(!l)return;const o={success:"ph-bold ph-check-circle",warning:"ph-bold ph-warning",error:"ph-bold ph-x-circle",default:"ph-bold ph-info"},t=document.createElement("div");t.className=`toast toast-${a}`,t.innerHTML=`<i class="${o[a]||o.default}"></i> ${T(e)}`,l.appendChild(t),setTimeout(()=>t.classList.add("show"),10),setTimeout(()=>{t.classList.remove("show"),t.addEventListener("transitionend",()=>t.remove())},3e3)}function H(e,a){return new Promise(l=>{const o=document.querySelector(e);if(!o){console.error("Modal not found:",e),l(null);return}if(O.length>0){const u=O[O.length-1];u&&u.classList.contains("visible")&&u.classList.add("is-underlay")}O.push(o),o.classList.add("visible");const t=o.querySelector('[id$="Confirm"]'),n=o.querySelector('[id$="Cancel"], [data-act="close-modal"], #roomDefaultsCancelBtn, #manageFavsTypeCancel, #forceApplyCancel, #forceApplyTypeCancel, #dimensionEntryCancel'),r=Array.from(o.querySelectorAll('button, [href], input:not([type="hidden"]), select, textarea, [tabindex]:not([tabindex="-1"])')).filter(u=>!u.disabled&&u.offsetParent!==null),s=r[0],i=r[r.length-1];setTimeout(()=>s?.focus(),50);const d=u=>{o.classList.remove("visible"),document.removeEventListener("keydown",c),o.removeEventListener("click",p),t&&(t.onclick=null),n&&(n.onclick=null),o.closeModal===d&&(o.closeModal=null);const f=O.pop();f!==o&&(console.error(`[cleanup] Modal stack mismatch! Expected #${o.id}, but popped #${f?.id}. Resetting stack.`),O.length=0);const v=O.length>0?O[O.length-1]:null;v&&v.classList.contains("visible")&&v.classList.remove("is-underlay"),e==="#roomDefaultsModal"&&(le.forEach(({element:_,event:h,handler:b})=>{_.removeEventListener(h,b)}),le=[],ue=null),e==="#favoritesModal"&&(ie=null),u?.cancelled&&typeof a=="function"&&a(),l(u)};o.closeModal=d;const c=u=>{const f=O.length>0&&O[O.length-1]===o;u.key==="Escape"&&f&&d({cancelled:!0}),u.key==="Tab"&&r.length>1&&(u.shiftKey?document.activeElement===s&&(i.focus(),u.preventDefault()):document.activeElement===i&&(s.focus(),u.preventDefault()))},p=u=>{const f=O.length>0&&O[O.length-1]===o;u.target===o&&f&&(u.stopPropagation(),d({cancelled:!0}))};t&&(t.onclick=()=>d(!0)),n&&(n.onclick=()=>{O.length>0&&O[O.length-1]===o&&d({cancelled:!0})}),document.addEventListener("keydown",c),o.addEventListener("click",p)})}async function re(e,a){const l=document.querySelector(m.modal);return l?(l.querySelector(m.modalTitle).textContent=e,l.querySelector(m.modalBody).textContent=a,await H(m.modal)===!0):!0}async function Dt(){const e=document.querySelector(m.exportOptionsModal);if(!e)return null;const a=e.querySelector("#pageBreakBuffer"),l=e.querySelector("#pageBreakBufferValue");a&&l&&(l.textContent=a.value,a.oninput=()=>{l.textContent=a.value});const o=await H(m.exportOptionsModal);return a&&(a.oninput=null),!o||o.cancelled?null:{vatOption:e.querySelector('input[name="vat_option"]:checked')?.value||"include",showDetails:(e.querySelector('input[name="item_details_option"]:checked')?.value||"show_details")==="show_details",exportMethod:e.querySelector("#exportMethod")?.value||"direct",pageBreakBuffer:parseInt(a?.value,10)||3}}async function Nt(){const e=document.querySelector("#discountModal");if(!e)return Promise.resolve({cancelled:!0});const a=e.querySelector("#discountSubtotal"),l=e.querySelector("#discountPercent"),o=e.querySelector("#discountAmount"),t=e.querySelector("#discountFinalTotal"),n=document.querySelector("#discount_type"),r=document.querySelector("#discount_value"),s=y(document.querySelector("#originalTotal").dataset.rawTotal||document.querySelector("#grandTotal").textContent);a&&(a.textContent=C(s));const i=h=>{if(De)return;De=!0;let b=0;if(h==="percent"){const I=y(l.value);b=s*(Math.max(0,I)/100),o.value=b>0?C(Math.round(b)):""}else b=y(o.value);if(b=Math.max(0,Math.min(b,s)),h!=="percent"){const I=s>0?b/s*100:0;l.value=I>0&&isFinite(I)?oe(I,2):""}t&&(t.textContent=C(s-b)),setTimeout(()=>{De=!1},50)},d=()=>i("percent"),c=()=>i("amount"),p=h=>{y(h.target.value)>0&&(h.target.value=y(h.target.value))},u=h=>{const b=y(h.target.value);h.target.value=b>0?C(b):"",i("amount")};l.addEventListener("input",d),o.addEventListener("input",c),o.addEventListener("focus",p),o.addEventListener("blur",u);const f=n.value,v=y(r.value);l.value="",o.value="",v>0?f==="percent"?(l.value=v,i("percent")):(o.value=v,o.value=C(v),i("amount")):i();const _=await H("#discountModal");if(l.removeEventListener("input",d),o.removeEventListener("input",c),o.removeEventListener("focus",p),o.removeEventListener("blur",u),_&&!_.cancelled){const h=y(l.value),b=y(o.value),I=document.activeElement;h>0&&I===l?(n.value="percent",r.value=h):b>0?(n.value="amount",r.value=b):h>0?(n.value="percent",r.value=h):(n.value="amount",r.value=0),J()}}async function Ft(){if(!R)return;const e=document.querySelector("#hardwareModal");if(!e)return;const a=R.querySelector('[name="set_style"]'),l=a?a.value:null,o=l==="ตาไก่",t=l==="ม่านพับ",n=l==="หลุยส์",r=e.querySelector("#trackColorGroup"),s=e.querySelector("#bracketColorGroup"),i=e.querySelector("#finialColorGroup"),d=e.querySelector("#grommetColorGroup"),c=e.querySelector("#louisValanceGroup"),p=e.querySelector("#louisTasselGroup"),u=e.querySelector("#hardwareApplyToRoom");e.querySelector('[name="modal_track_color"]').value=R.querySelector('[name="track_color"]')?.value||"ขาว",e.querySelector('[name="modal_bracket_color"]').value=R.querySelector('[name="bracket_color"]')?.value||"ขาว",e.querySelector('[name="modal_finial_color"]').value=R.querySelector('[name="finial_color"]')?.value||"ขาว",e.querySelector('[name="modal_grommet_color"]').value=R.querySelector('[name="grommet_color"]')?.value||"เงิน",e.querySelector('[name="modal_louis_valance"]').value=R.querySelector('[name="louis_valance"]')?.value||"กล่องหลุยส์",e.querySelector('[name="modal_louis_tassels"]').value=R.querySelector('[name="louis_tassels"]')?.value||"สีเข้ากับผ้า",r&&(r.style.display=""),s&&(s.style.display=""),i&&(i.style.display=o?"":"none"),d&&(d.style.display=o?"":"none"),c&&(c.style.display=n?"":"none"),p&&(p.style.display=n?"":"none"),u&&(u.disabled=t||n);const f=await H("#hardwareModal");f&&!f.cancelled&&(R.querySelector('[name="track_color"]').value=e.querySelector('[name="modal_track_color"]').value,R.querySelector('[name="bracket_color"]').value=e.querySelector('[name="modal_bracket_color"]').value,o?(R.querySelector('[name="finial_color"]').value=e.querySelector('[name="modal_finial_color"]').value,R.querySelector('[name="grommet_color"]').value=e.querySelector('[name="modal_grommet_color"]').value):n&&(R.querySelector('[name="louis_valance"]').value=e.querySelector('[name="modal_louis_valance"]').value,R.querySelector('[name="louis_tassels"]').value=e.querySelector('[name="modal_louis_tassels"]').value),z(),q("บันทึกการตั้งค่าอุปกรณ์แล้ว","success")),R=null}async function Rt(e){if(!e)return;ue=e;const a=document.querySelector(m.roomDefaultsModal),l=document.querySelector(m.roomDefaultsForm);if(!a||!l)return;le.forEach(({element:i,event:d,handler:c})=>{i.removeEventListener(d,c)}),le=[];const o=JSON.parse(ue.dataset.roomDefaults||"{}"),t=a.querySelectorAll(".defaults-tab"),n=a.querySelectorAll(".defaults-content"),r=i=>{const d=i.currentTarget,c=d.dataset.target;if(!c)return;t.forEach(u=>u.classList.remove("is-active")),n.forEach(u=>u.classList.remove("is-active")),d.classList.add("is-active");const p=a.querySelector(`.defaults-content[data-type="${c}"]`);p&&p.classList.add("is-active")};t.forEach(i=>{i.addEventListener("click",r),le.push({element:i,event:"click",handler:r})}),t[0]&&t[0].classList.add("is-active"),n[0]&&n[0].classList.add("is-active");const s=i=>{const d=i.target,c=d.closest(".defaults-content");if(!c)return;const p=d.checked,u=c.querySelector(".defaults-inputs-grid");c.classList.toggle("is-enabled-content",p),u&&u.querySelectorAll('input[type="text"], input[type="number"], select, .btn-show-favs').forEach(f=>{f.disabled=!p,f.matches(".btn-show-favs")&&(f.style.opacity=p?"1":"0.5",f.style.pointerEvents=p?"auto":"none")})};n.forEach(i=>{const d=i.querySelector('.defaults-enable-toggle input[type="checkbox"]');if(!d)return;const c=d.name,p=o[c]===!0||o[c]==="1";d.checked=p,s({target:d}),d.addEventListener("change",s),le.push({element:d,event:"change",handler:s});const u=i.querySelector(".defaults-inputs-grid");u&&u.querySelectorAll('input[type="text"], input[type="number"]').forEach(f=>{const v=f.name,_=o[v];f.type==="text"&&f.inputMode==="numeric"?(f.value=_===0?"0":_!=null&&_>0?C(_):"",f.addEventListener("focus",ze),f.addEventListener("blur",Ze),le.push({element:f,event:"focus",handler:ze}),le.push({element:f,event:"blur",handler:Ze})):f.value=_||""})}),await H(m.roomDefaultsModal)}async function Ht(){const e=document.querySelector("#forceApplyModal");if(!e)return;const a=e.querySelector('[name="force_apply_type_hidden"]'),l=e.querySelector("#forceApplySelectedTypeDisplay"),o=e.querySelector('[name="force_apply_code"]'),t=e.querySelector('[name="force_apply_price"]'),n=o?.closest(".form-group-with-favorites")?.querySelector(".btn-show-favs");a&&(a.value=""),l&&(l.textContent="-- เลือกประเภท --"),o&&(o.value="",o.dataset.favoriteType=""),t&&(t.value=""),n&&(n.disabled=!0),await H("#forceApplyModal")}function ze(e){e.target.value!=="0"&&y(e.target.value)>0&&(e.target.value=y(e.target.value))}function Ze(e){const a=y(e.target.value);e.target.value=a===0?"0":a!=null&&a>0?C(a):""}function Ot(){if(!ue)return;const e=document.querySelector(m.roomDefaultsForm);if(!e)return;const a={};e.querySelectorAll(".defaults-content").forEach(o=>{const t=o.querySelector('.defaults-enable-toggle input[type="checkbox"]');if(t){const n=t.name,r=t.checked;if(a[n]=r,r){const s=o.querySelector(".defaults-inputs-grid");s&&s.querySelectorAll('input[type="text"], input[type="number"]').forEach(i=>{const d=i.name,c=i.value.trim();let p;i.type==="text"&&i.inputMode==="numeric"?c===""?p=void 0:p=y(c):p=c,(typeof p=="number"&&!isNaN(p)||typeof p=="string"&&p!=="")&&(a[d]=p)})}}}),ue.dataset.roomDefaults=JSON.stringify(a),z();const l=document.querySelector(m.roomDefaultsModal);l&&typeof l.closeModal=="function"?(l.closeModal(!0),setTimeout(()=>q("บันทึกค่าเริ่มต้นห้องแล้ว","success"),50)):console.error("Could not find room defaults modal or its closer function.")}async function jt(){if(!ue)return;const e=document.querySelector(m.roomDefaultsModal),a=document.querySelector(m.roomDefaultsForm);if(!e||!a)return;const l={};if(a.querySelectorAll(".defaults-content").forEach(n=>{const r=n.querySelector('.defaults-enable-toggle input[type="checkbox"]');if(r&&r.checked){const s=n.querySelector(".defaults-inputs-grid");s&&s.querySelectorAll('input[type="text"], input[type="number"]').forEach(i=>{const d=i.name,c=i.type==="text"&&i.inputMode==="numeric"?y(i.value):i.value.trim();(typeof c=="number"&&!isNaN(c)||typeof c=="string"&&c!=="")&&(l[d]=c)})}}),Object.keys(l).length===0){q("ยังไม่มีการเลือกค่าเริ่มต้นที่จะใช้","warning");return}if(!await re("ใช้ค่าเริ่มต้น","ใช้ค่าเริ่มต้นที่ *เลือกไว้* กับรายการที่ยังไม่มีข้อมูลในห้องนี้?"))return;se(U()),ee();let o=0;ue.getItemsContainer().querySelectorAll(".item-card").forEach(n=>{const r=n.dataset.type;let s=!1;const i=(d,c)=>{const p=l[c],u=n.querySelector(d);if(!u||p==null)return;const f=u.tagName==="SELECT",v=f?u.value:u.value.trim(),_=f?null:y(v);let h=!1;if(f?h=!v:u.matches('input[type="text"][inputmode="numeric"]')?h=!v||_===0:h=!v,h){let b=!1;f?Array.from(u.options).some(I=>I.value==p)&&(u.value=p,b=!0):u.matches('input[type="text"][inputmode="numeric"]')?typeof p=="number"&&!isNaN(p)&&(u.value=p===0?"0":C(p),b=!0):u.matches('input[type="text"]:not([inputmode])')&&(u.value=p,b=!0),b&&(s=!0,u.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0})),u.matches('input[type="text"][inputmode="numeric"]')&&u.dispatchEvent(new Event("blur",{bubbles:!0,cancelable:!0})))}};switch(r){case"set":i(m.setFabricCodeInput,"defaults_fabric_code"),i(m.setPricePerMSelect,"defaults_fabric_price"),i(m.setSheerCodeInput,"defaults_sheer_code"),i(m.setSheerPricePerMSelect,"defaults_sheer_price");break;case"wallpaper":i(m.wallCodeInput,"defaults_wallpaper_code"),i(m.wallPriceRollInput,"defaults_wallpaper_price_roll"),i(m.wallInstallCostInput,"defaults_wallpaper_install_cost");break;case"wooden_blind":i(m.areaCodeInput,"defaults_wooden_blind_code"),i(m.areaPriceSqydInput,"defaults_wooden_blind_price_sqyd");break;case"roller_blind":i(m.areaCodeInput,"defaults_roller_blind_code"),i(m.areaPriceSqydInput,"defaults_roller_blind_price_sqyd");break;case"vertical_blind":i(m.areaCodeInput,"defaults_vertical_blind_code"),i(m.areaPriceSqydInput,"defaults_vertical_blind_price_sqyd");break;case"partition":i(m.areaCodeInput,"defaults_partition_code"),i(m.areaPriceSqydInput,"defaults_partition_price_sqyd");break;case"pleated_screen":i(m.areaCodeInput,"defaults_pleated_screen_code"),i(m.areaPriceSqydInput,"defaults_pleated_screen_price_sqyd");break;case"aluminum_blind":i(m.areaCodeInput,"defaults_aluminum_blind_code"),i(m.areaPriceSqydInput,"defaults_aluminum_blind_price_sqyd");break}s&&o++}),e&&typeof e.closeModal=="function"?e.closeModal({cancelled:!0}):console.error("Could not find room defaults modal or its closer function."),setTimeout(()=>{o>0?(J(),q(`ใช้ค่าเริ่มต้นกับ ${o} รายการแล้ว`,"success")):q("ไม่มีรายการใดที่ต้องอัปเดต","default")},50)}async function Wt(){const e=document.querySelector("#forceApplyModal");if(!e)return;const a=e.querySelector('[name="force_apply_type_hidden"]'),l=e.querySelector('[name="force_apply_code"]'),o=e.querySelector('[name="force_apply_price"]'),t=a.value,n=l.value.trim(),r=y(o.value);if(!t){q("โปรดเลือกประเภทรายการที่จะบังคับใช้","warning"),e.querySelector("#forceApplySelectTypeBtn")?.focus();return}if(!n){q("โปรดกรอกรหัสที่จะบังคับใช้","warning"),l.focus();return}if(r<0||r<=0&&!["fabric","sheer","wallpaper"].includes(t)){q("โปรดกรอกราคาที่ถูกต้อง (> 0)","warning"),o.focus();return}const s=e.querySelector("#forceApplySelectedTypeDisplay");let i=s?s.textContent:t;const d="ยืนยันการบังคับใช้",c=`⚠️ ยืนยันการเปลี่ยนรหัสเป็น "${n}" และราคาเป็น ${C(r)} บาท สำหรับรายการประเภท "${i}" ***ทุกรายการ*** ในทุกห้องหรือไม่? การกระทำนี้ไม่สามารถยกเลิกได้ง่ายๆ`;if(!await re(d,c))return;se(U()),ee();let p=0;document.querySelectorAll(".item-card").forEach(f=>{if(f.classList.contains("placeholder-item"))return;const v=f.dataset.type;let _=null,h=null;if(t==="fabric"&&v==="set"?(_=f.querySelector('input[name="fabric_code"]'),h=f.querySelector('select[name="set_price_per_m"]')):t==="sheer"&&v==="set"?(_=f.querySelector('input[name="sheer_fabric_code"]'),h=f.querySelector('select[name="sheer_price_per_m"]')):t==="wallpaper"&&v==="wallpaper"?(_=f.querySelector('input[name="wallpaper_code"]'),h=f.querySelector('input[name="wallpaper_price_roll"]')):v===t&&f.matches(".area-based-item")&&(_=f.querySelector('input[name="area_code"]'),h=f.querySelector('input[name="area_price_sqyd"]')),_&&h){if(_.value=n,_.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0})),h.tagName==="SELECT")if(Array.from(h.options).some(I=>I.value==r))h.value=r;else{if(console.warn(`Price ${r} not found in options for`,h,". Forcing new option."),!h.querySelector(`option[value="${r}"][data-forced="true"]`)){const B=document.createElement("option");B.value=r,B.textContent=r===0?"0 บาท":`${C(r)} บาท (บังคับ)`,B.dataset.forced="true",h.appendChild(B)}h.value=r}else{const b=r===0?"0":r!=null&&r>0?C(r):"";h.value=b}h.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0})),h.dispatchEvent(new Event("blur",{bubbles:!0,cancelable:!0})),p++,_.classList.add("input-highlight"),h.classList.add("input-highlight"),setTimeout(()=>{_.classList.remove("input-highlight"),h.classList.remove("input-highlight")},1200)}}),p>0?(J(),q(`บังคับใช้ค่าใหม่กับ ${p} รายการ (${i}) สำเร็จ`,"success"),e&&typeof e.closeModal=="function"&&e.closeModal({cancelled:!0})):q(`ไม่พบรายการประเภท "${i}" ที่ต้องอัปเดต`,"default")}async function Vt(){const e=document.querySelector("#manageFavsTypeModal"),a=document.querySelector("#manageFavsTypeBody");if(!e||!a)return;const l=Object.keys(ce());let o="",t=null;const n={fabric:"ph-rows",sheer:"ph-waves",wallpaper:"ph-paint-roller",wooden_blind:"ph-table",roller_blind:"ph-scroll",vertical_blind:"ph-sidebar-simple",partition:"ph-columns",pleated_screen:"ph-squares-four",aluminum_blind:"ph-stack-simple"};if(l.includes("fabric")&&(o+=`
             <label data-item-type="fabric">
                 <input type="radio" name="manage_fav_type_option" value="fabric">
                 <span class="radio-card-content">
                     <strong><i class="ph ${n.fabric}"></i> ผ้าทึบ</strong>
                     <small>Fabric Codes</small>
                 </span>
             </label>`,t||(t="fabric")),l.includes("sheer")&&(o+=`
              <label data-item-type="sheer">
                  <input type="radio" name="manage_fav_type_option" value="sheer">
                  <span class="radio-card-content">
                      <strong><i class="ph ${n.sheer}"></i> ผ้าโปร่ง</strong>
                      <small>Sheer Codes</small>
                  </span>
              </label>`,t||(t="sheer")),l.forEach(s=>{if(s==="fabric"||s==="sheer")return;const i=F[s];if(i){const d=i.name,c=n[s]||"ph-star";o+=`
                <label data-item-type="${s}">
                    <input type="radio" name="manage_fav_type_option" value="${s}">
                    <span class="radio-card-content">
                        <strong><i class="ph ${c}"></i> ${T(d)}</strong>
                        <small>${s.replace(/_/g," ").replace(/\b\w/g,p=>p.toUpperCase())} Codes</small>
                    </span>
                </label>`,t||(t=s)}}),a.innerHTML=o,t){const s=a.querySelector(`input[value="${t}"]`);s&&(s.checked=!0)}const r=await H("#manageFavsTypeModal");if(r&&!r.cancelled){const s=a.querySelector('input[name="manage_fav_type_option"]:checked')?.value;s&&await ct(s)}}function Fe(e,a){e&&(se(U()),ee(),e.classList.add("item-removing"),e.addEventListener("animationend",()=>{e.remove(),q(a),Ee(),ae(),J(),$e()},{once:!0}))}function Gt(e){if(!e)return;const a=document.querySelector(".main-header");if(!a){e.scrollIntoView({behavior:"smooth",block:"center"});return}const l=a.offsetHeight,o=16,n=(e.querySelector(".item-header")||e).getBoundingClientRect(),r=l+o,s=n.top-r;Math.abs(s)>5&&window.scrollBy({top:s,behavior:"smooth"})}function ve(e){if(!e)return;const a=document.querySelector(".main-header"),l=document.querySelector(".summary-footer"),o=a?a.offsetHeight+16:80,t=l?l.offsetHeight+16:100;requestAnimationFrame(()=>{const n=e.getBoundingClientRect(),r=window.innerHeight;if(!(n.top>=o&&n.bottom<=r-t)){const i=r-o-t,d=n.height>i?"start":"center";e.scrollIntoView({behavior:"smooth",block:d})}})}function ae(){document.querySelectorAll(m.room).forEach(e=>{const a=e.querySelectorAll(".item-card:not(.item-hidden)");let l=0;const o=Array.from(a).filter(t=>!t.classList.contains("is-suspended")&&!t.classList.contains("placeholder-item")).length;a.forEach(t=>{const n=t.querySelector("[data-item-title]");n&&(t.classList.contains("placeholder-item")?n.textContent="...":t.classList.contains("is-suspended")?n.textContent="-":(l++,n.textContent=`${l}/${o}`))}),e.querySelectorAll(".item-card.item-hidden").forEach(t=>{const n=t.querySelector("[data-item-title]");n&&(n.textContent="-")})})}function lt(){const e=document.querySelector(m.orderForm),a=document.querySelector(m.lockBtn);!e||!a||(e.classList.toggle("is-locked",Z),a.classList.toggle("is-locked",Z),a.querySelector("i").className=Z?"ph-bold ph-lock-key":"ph ph-paw-print",e.querySelectorAll('input:not([type="hidden"]), select, textarea, button:not(.unlockable):not([data-act="toggle-more-details"]):not([data-act="collapse-room"])').forEach(l=>{!l.closest(".main-header")&&!l.closest(".summary-footer")&&!l.closest(".modal-wrapper")&&(l.disabled=Z)}),document.querySelectorAll(".unlockable").forEach(l=>l.disabled=!1))}function Ut(){Z=!Z,lt(),q(Z?"ฟอร์มถูกล็อค":"ปลดล็อคฟอร์มแล้ว",Z?"warning":"success")}function ne(){const e=document.querySelectorAll(m.room+":not(.item-hidden)");if(e.length===0){const o=document.querySelector(m.toggleAllRoomsBtn);o&&(o.querySelector("i").className="ph ph-caret-down",o.querySelector("span").textContent="ขยายทั้งหมด");return}const a=[...e].some(o=>o.open),l=document.querySelector(m.toggleAllRoomsBtn);l&&(l.querySelector("i").className=a?"ph ph-caret-up":"ph ph-caret-down",l.querySelector("span").textContent=a?"ย่อทั้งหมด":"ขยายทั้งหมด")}function Jt(){const e=document.querySelectorAll(m.room+":not(.item-hidden)");if(e.length===0)return;const a=[...e].some(o=>o.open);e.forEach(o=>{o.open=!a});const l=document.querySelector(m.quickNavDropdown);l&&l.classList.contains("show")&&(l.classList.remove("show"),document.querySelector(m.quickNavBtn)?.setAttribute("aria-expanded","false")),setTimeout(()=>{ne(),z()},50)}function Ee(){const e=document.querySelector(m.quickNavRoomList);e&&(e.innerHTML="",document.querySelectorAll(m.room).forEach(a=>{const l=a.querySelector(m.roomNameInput)?.value||"ห้อง",o=document.createElement("a");o.href=`#${a.id}`,o.dataset.jumpTo=a.id,o.innerHTML=`<i class="ph ph-share-fat"></i> ${T(l)||"ห้อง (ไม่มีชื่อ)"}`,e.appendChild(o)}))}function Re(e){const a=document.getElementById("quickNavBtnText");a&&(e?a.textContent=e.querySelector('input[name="room_name"]')?.value||"...":a.textContent="ไปยังห้อง")}function $e(){if(ke&&ke.disconnect(),!document.getElementById("quickNavBtnText"))return;const a={root:null,rootMargin:"-60px 0px -150px 0px",threshold:0},l=t=>{const n=t.filter(r=>r.isIntersecting).sort((r,s)=>r.target.getBoundingClientRect().top-s.target.getBoundingClientRect().top);n.length>0&&Re(n[0].target)};ke=new IntersectionObserver(l,a),document.querySelectorAll(m.room).forEach(t=>ke.observe(t));const o=Array.from(document.querySelectorAll(m.room));if(o.length>0){o.sort((n,r)=>n.getBoundingClientRect().top-r.getBoundingClientRect().top);const t=o.find(n=>n.getBoundingClientRect().bottom>60);Re(t||o[0])}else Re(null)}function Me(e,a=null){if(!e||e.classList.contains("placeholder-item"))return;const l=e.querySelector(".item-details-more"),o=e.querySelector('[data-act="toggle-more-details"]'),t=o?.parentElement;if(!l||!o||!t)return;const n=l.classList.contains("show"),r=a!==null?a:!n;if(n===r)return;l.classList.toggle("show",r),o.classList.toggle("expanded",r);const s=o.querySelector("i");s&&(s.className=r?"ph ph-caret-up":"ph ph-caret-down");const i=o.querySelector("span");if(i&&(i.textContent=r?"ย่อน้อยลง":"เพิ่มเติม"),r)l.appendChild(t),setTimeout(()=>Gt(e),100);else{const d=e.querySelector(".item-grid");d&&d.appendChild(t)}}function he(e={}){const a=document.querySelector(m.roomsContainer);if(!a)return null;Object.keys(e).length===0&&(se(U()),ee());const l=at(e);return l?(a.appendChild(l),Object.keys(e).length===0&&(l.classList.add("item-created"),ve(l),l.querySelector('input[name="room_name"]')?.focus()),Ee(),ne(),$e(),Object.keys(e).length===0&&z(),l):null}async function it(e,a=null){const l=document.querySelector("#itemTypeModal");if(!l)return null;l.querySelector("#itemTypeModalTitle").textContent=e;let o=a||"set";a&&!F[a]&&(o="set");const t=l.querySelector(`input[name="item_type_option"][value="${o}"]`);if(t)t.checked=!0;else{const s=l.querySelector('input[name="item_type_option"][value="set"]');s&&(s.checked=!0)}const n=await H("#itemTypeModal");if(!n||n.cancelled)return null;const r=l.querySelector('input[name="item_type_option"]:checked');return r?r.value:null}function et(){const e=document.createElement("div");return e.className="dimension-input-row",e.innerHTML=`
        <div class="form-group">
            <label class="visually-hidden">กว้าง (ม.)</label>
            <input type="number" step="0.01" inputmode="decimal" name="modal_width_m" placeholder="กว้าง">
        </div>
        <div class="form-group">
            <label class="visually-hidden">สูง (ม.)</label>
            <input type="number" step="0.01" inputmode="decimal" name="modal_height_m" placeholder="สูง">
        </div>
        <button type="button" class="btn-icon btn-icon-small danger btn-remove-dimension-row" data-act="remove-dimension-row" title="ลบขนาด" aria-label="ลบขนาดแถวนี้"><i class="ph-bold ph-x"></i></button>
    `,e.querySelectorAll('input[type="number"]').forEach(a=>{a.addEventListener("blur",l=>{l.target.value=X(l.target.value)})}),e}function Yt(e,a){if(!a||!e||e.width_m<=0||e.height_m<=0)return;const l=a.getItemsContainer();if(!l)return;const o=document.querySelector("#placeholderItemTpl");if(!o)return console.error("Placeholder template not found"),null;const n=o.content.cloneNode(!0).firstElementChild;n.dataset.widthM=e.width_m,n.dataset.heightM=e.height_m;const r=n.querySelector("[data-placeholder-width]"),s=n.querySelector("[data-placeholder-height]");return r&&(r.textContent=X(e.width_m)),s&&(s.textContent=X(e.height_m)),l.appendChild(n),n.classList.add("item-created"),n}function Qt(e,a,l){if(!e||!a||!l)return;const o=e.closest(m.room);if(!o)return;se(U()),ee();const t=JSON.parse(o.dataset.roomDefaults||"{}");let n={width_m:l.width_m,height_m:l.height_m};const r=i=>t[`enable_defaults_${i}`]===!0;switch(a){case"set":r("set")&&(n.fabric_code=t.defaults_fabric_code,n.price_per_m_raw=t.defaults_fabric_price,n.sheer_fabric_code=t.defaults_sheer_code,n.sheer_price_per_m=t.defaults_sheer_price);break;case"wallpaper":r("wallpaper")&&(n.wallpaper_code=t.defaults_wallpaper_code,n.price_per_roll=t.defaults_wallpaper_price_roll,n.install_cost_per_roll=t.defaults_wallpaper_install_cost),delete n.width_m;break;case"wooden_blind":r("wooden_blind")&&(n.code=t.defaults_wooden_blind_code,n.price_sqyd=t.defaults_wooden_blind_price_sqyd);break;case"roller_blind":r("roller_blind")&&(n.code=t.defaults_roller_blind_code,n.price_sqyd=t.defaults_roller_blind_price_sqyd);break;case"vertical_blind":r("vertical_blind")&&(n.code=t.defaults_vertical_blind_code,n.price_sqyd=t.defaults_vertical_blind_price_sqyd);break;case"partition":r("partition")&&(n.code=t.defaults_partition_code,n.price_sqyd=t.defaults_partition_price_sqyd);break;case"pleated_screen":r("pleated_screen")&&(n.code=t.defaults_pleated_screen_code,n.price_sqyd=t.defaults_pleated_screen_price_sqyd);break;case"aluminum_blind":r("aluminum_blind")&&(n.code=t.defaults_aluminum_blind_code,n.price_sqyd=t.defaults_aluminum_blind_price_sqyd);break}let s;if(a==="set")s=Ce(n);else if(a==="wallpaper")s=Be(n);else if(F[a]?.templateId==="#areaBasedTpl")s=Ae(a,n);else{q(`ไม่รู้จักประเภทรายการ: ${a}`,"error");return}s&&(e.replaceWith(s),s.classList.add("item-created"),ve(s),s.querySelector('input:not([type="hidden"]), select, textarea')?.focus(),ae(),J(),q(`เพิ่ม ${F[a]?.name||"รายการ"} แล้ว`,"success"))}async function Kt(e){if(!e||e.classList.contains("placeholder-item"))return;const a=e.dataset.type,l=await it("เปลี่ยนประเภทรายการ",a);if(!l||l===a||!await re("ยืนยันการเปลี่ยนแปลง","ข้อมูลส่วนใหญ่ในรายการนี้จะถูกล้างและใช้ค่าเริ่มต้น (ถ้ามี) คุณแน่ใจหรือไม่?"))return;se(U()),ee();const o={width_m:y(e.querySelector('input[name$="_width_m"], input[name="width_m"]')?.value),height_m:y(e.querySelector('input[name$="_height_m"], input[name="height_m"]')?.value)};a==="wallpaper"&&(o.height_m=y(e.querySelector(m.wallHeightInput)?.value));const t=e.closest(m.room),n=JSON.parse(t?.dataset.roomDefaults||"{}");let r={width_m:o.width_m>0?o.width_m:void 0,height_m:o.height_m>0?o.height_m:void 0};const s=d=>n[`enable_defaults_${d}`]===!0;switch(l){case"set":s("set")&&(r.fabric_code=n.defaults_fabric_code,r.price_per_m_raw=n.defaults_fabric_price,r.sheer_fabric_code=n.defaults_sheer_code,r.sheer_price_per_m=n.defaults_sheer_price);break;case"wallpaper":s("wallpaper")&&(r.wallpaper_code=n.defaults_wallpaper_code,r.price_per_roll=n.defaults_wallpaper_price_roll,r.install_cost_per_roll=n.defaults_wallpaper_install_cost),delete r.width_m,r.height_m=o.height_m>0?o.height_m:void 0;break;case"wooden_blind":s("wooden_blind")&&(r.code=n.defaults_wooden_blind_code,r.price_sqyd=n.defaults_wooden_blind_price_sqyd);break;case"roller_blind":s("roller_blind")&&(r.code=n.defaults_roller_blind_code,r.price_sqyd=n.defaults_roller_blind_price_sqyd);break;case"vertical_blind":s("vertical_blind")&&(r.code=n.defaults_vertical_blind_code,r.price_sqyd=n.defaults_vertical_blind_price_sqyd);break;case"partition":s("partition")&&(r.code=n.defaults_partition_code,r.price_sqyd=n.defaults_partition_price_sqyd);break;case"pleated_screen":s("pleated_screen")&&(r.code=n.defaults_pleated_screen_code,r.price_sqyd=n.defaults_pleated_screen_price_sqyd);break;case"aluminum_blind":s("aluminum_blind")&&(r.code=n.defaults_aluminum_blind_code,r.price_sqyd=n.defaults_aluminum_blind_price_sqyd);break}let i;if(l==="set")i=Ce(r);else if(l==="wallpaper")i=Be(r);else if(F[l]?.templateId==="#areaBasedTpl")i=Ae(l,r);else return;i&&(e.replaceWith(i),i.classList.add("item-created"),ve(i),i.querySelector('input:not([type="hidden"]), select, textarea')?.focus(),ae(),J(),q("เปลี่ยนประเภทรายการแล้ว","success"))}const J=qe(()=>{let e=0;document.querySelectorAll(m.room).forEach(d=>{let c=0,p=0;const u=d.classList.contains("is-suspended");if(u||(d.querySelectorAll(".item-card:not(.is-suspended):not(.placeholder-item)").forEach(f=>{const v=y(f.dataset.totalPrice);v>0&&(c+=v,p++)}),e+=c),typeof d.updateBrief=="function"){const f=d.querySelectorAll(".placeholder-item:not(.is-suspended)").length;if(u)d.updateBrief("(ระงับชั่วคราว)");else if(p>0){let v=`<span>${p}</span> &bull; ${C(c)} บาท`;f>0&&(v+=` (+${f} รอเลือก)`),d.updateBrief(v)}else f>0?d.updateBrief(`<span>${f}</span> รอเลือกประเภท`):d.updateBrief("<span>0</span> รายการ")}});const a=document.querySelector("#discount_type"),l=document.querySelector("#discount_value"),o=a?a.value:"amount",t=l?y(l.value):0;let n=0;t>0&&(n=o==="percent"?e*(t/100):t,n=Math.min(e,n));const r=e-n,s=document.querySelector("#grandTotal"),i=document.querySelector("#originalTotal");s&&(s.textContent=C(r)),i&&(n>0?(i.textContent=C(e),i.dataset.rawTotal=e,i.style.display="block"):(i.style.display="none",i.dataset.rawTotal="")),_e(),z()},200);async function Ve(e,a=!1){if(!e){q("ข้อมูลสำหรับโหลดไม่ถูกต้อง","error");return}if(e.favorites)if(a){const d=document.querySelector("#favoritesConflictModal");if(d){const c=d.querySelector('input[name="fav_conflict_option"][value="merge"]');c&&(c.checked=!0);const p=await H("#favoritesConflictModal");if(!p||p.cancelled){q("ยกเลิกการนำเข้า","warning");return}const u=d.querySelector('input[name="fav_conflict_option"]:checked').value;let f=0;switch(u){case"overwrite":Ge(e.favorites)&&q("เขียนทับรายการโปรดสำเร็จ","success");break;case"merge":f=He(e.favorites),q(`รวมข้อมูลสำเร็จ (เพิ่ม ${f} รายการใหม่)`,"success");break;case"skip":q("ข้ามการนำเข้ารายการโปรด","default");break}}else He(e.favorites)}else Ge(e.favorites);const l=document.querySelector(m.roomsContainer);if(!l)return;l.innerHTML="";const o=document.querySelector("#customer_name"),t=document.querySelector("#customer_phone"),n=document.querySelector("#customer_address"),r=document.querySelector("#customerDetailsCard");o&&(o.value=e.customer_name||""),t&&(t.value=e.customer_phone||""),n&&(n.value=e.customer_address||""),r&&(r.open=e.customer_card_open??!0);const s=document.querySelector("#discount_type"),i=document.querySelector("#discount_value");if(e.discount&&s&&i?(s.value=e.discount.type||"amount",i.value=e.discount.value||0):s&&i&&(s.value="amount",i.value=0),!Array.isArray(e.rooms)){q("ไม่พบข้อมูลห้องในไฟล์","warning"),l.children.length===0&&he();return}for(const d of e.rooms){const c=at(d);if(!c)continue;l.appendChild(c);const p=c.getItemsContainer();if(p&&Array.isArray(d.items))for(const u of d.items){let f;if(u.type==="placeholder"){const v=document.querySelector("#placeholderItemTpl");if(v){f=v.content.cloneNode(!0).firstElementChild,f.dataset.widthM=u.width_m||0,f.dataset.heightM=u.height_m||0;const h=f.querySelector("[data-placeholder-width]"),b=f.querySelector("[data-placeholder-height]");h&&(h.textContent=X(u.width_m)),b&&(b.textContent=X(u.height_m)),u.is_suspended&&f.classList.add("is-suspended")}else{console.warn("Placeholder template not found during load.");continue}}else if(u.type==="set")f=Ce(u);else if(u.type==="wallpaper")f=Be(u);else if(F[u.type]?.templateId==="#areaBasedTpl")f=Ae(u.type,u);else continue;f&&p.appendChild(f)}}ae(),Ee(),ne(),$e(),ee(),J(),a&&q("นำเข้าข้อมูลฟอร์มสำเร็จ","success")}async function Xt(e,a){const l=document.querySelector(m.printableContent);if(!l||!e){q("ไม่พบข้อมูลสำหรับสร้างเอกสาร","error");return}const o=document.title;if(a==="direct"){q("กำลังสร้าง PDF...","default");let t;try{typeof window.html2pdf>"u"&&(q("กำลังโหลดไลบรารี PDF...","default"),await Bt("https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js")),t=document.createElement("div"),t.style.position="fixed",t.style.left="-300mm",t.style.top="0",t.style.width="210mm",t.style.background="#fff",t.innerHTML=e,document.body.appendChild(t),await new Promise(r=>setTimeout(r,300));const n={margin:0,filename:`${o}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0,logging:!1,width:t.querySelector(".pdf-page")?.scrollWidth||794,windowWidth:t.querySelector(".pdf-page")?.scrollWidth||794},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}};await window.html2pdf().from(t).set(n).save(),q("ดาวน์โหลด PDF สำเร็จ","success")}catch(n){console.error("PDF Generation Error:",n),q("สร้าง PDF ล้มเหลว, โปรดลองวิธีที่ 2 (พิมพ์)","error")}finally{t&&document.body.contains(t)&&document.body.removeChild(t)}}else a==="print"&&(l.innerHTML=e,setTimeout(()=>{window.print(),setTimeout(()=>{l.innerHTML=""},1e3)},ft))}function zt(e){if(!e||!e.html){q("ไม่พบข้อมูลสำหรับสร้างไฟล์ HTML","error");return}try{const a=`<!DOCTYPE html><html lang="th"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>${e.fileName}</title><link rel="stylesheet" href="./src/styles/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/bold/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/fill/style.css"><style>body { background-color: #eee; } #printable-content { display: block !important; max-width: 210mm; margin: 10mm auto; } .pdf-page { border: 1px solid #ccc; box-shadow: 0 0 10px rgba(0,0,0,0.1); margin-bottom: 10mm; background: #fff; page-break-inside: avoid; } .pdf-page-content { padding: 12mm; } @media print { body { background-color: #fff; } #printable-content { max-width: 100%; margin: 0; } .pdf-page { border: none; box-shadow: none; margin-bottom: 0; page-break-after: always; } .pdf-page:last-child { page-break-after: avoid; } } i.ph { vertical-align: middle; }</style></head><body><div id="printable-content">${e.html}</div></body></html>`,l=new Blob([a],{type:"text/html;charset=utf-8"}),o=URL.createObjectURL(l),t=document.createElement("a");t.href=o,t.download=`${e.fileName}.html`,document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(o),q("ดาวน์โหลดไฟล์ HTML สำเร็จ","success")}catch(a){console.error("HTML Export Error:",a),q("สร้างไฟล์ HTML ล้มเหลว","error")}}function Zt(e){const{roomId:a,itemIndex:l}=e.dataset;if(!a||l===void 0)return;const o=document.getElementById("lookbookModal");o&&typeof o.closeModal=="function"&&o.closeModal({cancelled:!0});const t=document.getElementById(a);if(!t){q("ไม่พบห้องที่ต้องการ","error");return}const r=Array.from(t.querySelectorAll(".item-card:not(.item-hidden)"))[parseInt(l,10)];if(!r){q("ไม่พบรายการที่ต้องการ","error");return}t.open=!0,ne(),setTimeout(()=>{r.scrollIntoView({behavior:"smooth",block:"center"}),r.classList.add("scrolling-jump"),setTimeout(()=>r.classList.remove("scrolling-jump"),2500)},150)}function eo(e){if(!ie)return;const a=ie.closest("#roomDefaultsModal"),l=ie.closest(".item-card"),o=ie.closest("#forceApplyModal");let t=ie,n=null;const r=t.dataset.favoriteType,s=e.dataset.code,i=y(e.dataset.price);if(l){let p;r==="fabric"?p="set_price_per_m":r==="sheer"?p="sheer_price_per_m":r==="wallpaper"?p="wallpaper_price_roll":p="area_price_sqyd",n=l.querySelector(`[name="${p}"]`)}else if(a){const p=t.closest(".defaults-inputs-grid");if(p){let u;r==="fabric"?u="defaults_fabric_price":r==="sheer"?u="defaults_sheer_price":r==="wallpaper"?u="defaults_wallpaper_price_roll":r==="wooden_blind"?u="defaults_wooden_blind_price_sqyd":r==="roller_blind"?u="defaults_roller_blind_price_sqyd":r==="vertical_blind"?u="defaults_vertical_blind_price_sqyd":r==="partition"?u="defaults_partition_price_sqyd":r==="pleated_screen"?u="defaults_pleated_screen_price_sqyd":r==="aluminum_blind"&&(u="defaults_aluminum_blind_price_sqyd"),u&&(n=p.querySelector(`[name="${u}"]`))}}else o&&(n=o.querySelector('[name="force_apply_price"]'));const d=n;t.value=s,t.classList.add("input-highlight"),setTimeout(()=>{t&&t.classList.remove("input-highlight")},1200),d&&i>=0&&(d.tagName==="SELECT"?Array.from(d.options).some(p=>y(p.value)===i)?d.value=i:q(`ราคา ${C(i)} ไม่มีในตัวเลือก`,"warning"):d.value=i===0?"0":i>0?C(i):"",d.classList.add("input-highlight"),setTimeout(()=>{d&&d.classList.remove("input-highlight")},1200)),l?((d||t).dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0})),d&&d.matches('input[inputmode="numeric"]')&&d.dispatchEvent(new Event("blur",{bubbles:!0,cancelable:!0}))):(a||o)&&d&&d.matches('input[inputmode="numeric"]')&&d.dispatchEvent(new Event("blur",{bubbles:!0,cancelable:!0}));const c=document.querySelector("#favoritesModal");c&&typeof c.closeModal=="function"&&c.closeModal({cancelled:!1,applied:!0})}async function to(e){if(!e||!e.dataset.favoriteType){console.warn("showFavoritesModal called without a valid input element or favorite type.");return}ie=e;const a=e.dataset.favoriteType;if(!a){q("โปรดเลือกประเภทรายการก่อน","warning");const v=e.closest("#forceApplyModal");v&&v.querySelector("#forceApplySelectTypeBtn")?.focus(),ie=null;return}const l=document.querySelector("#favoritesModal"),o=l.querySelector("#favoritesModalTitle"),t=l.querySelector("#favoritesModalBody"),n=l.querySelector("#favSearchInput"),r=l.querySelector('[data-act="manage-favorites"]'),s=document.querySelector("#favSelectorItemTpl");if(!l||!o||!t||!n||!r||!s){console.error("Missing elements for favorites modal");return}let i=F[a]?.name||a;a==="fabric"?i="ผ้าทึบ":a==="sheer"&&(i="ผ้าโปร่ง"),o.textContent=`เลือก '${T(i)}'`;const d=()=>{const _=ce()[a]||[];_.length>0?t.innerHTML=_.map(h=>{let b="-";return h.price>=0&&(b=C(h.price)),s.innerHTML.replace(/{CODE}/g,T(h.code)).replace(/{PRICE}/g,b).replace(/{RAW_PRICE}/g,h.price)}).join(""):t.innerHTML='<p class="empty-state">ไม่มีรายการโปรดที่บันทึกไว้</p>',n.value=""};d();const c=()=>{const v=n.value.toLowerCase();t.querySelectorAll(".fav-selector-item").forEach(_=>{const h=_.dataset.code.toLowerCase();_.classList.toggle("is-hidden",!h.includes(v))})},p=v=>{const _=v.target.closest(".fav-selector-item");_&&eo(_)},u=async()=>{await ct(a),we&&d()},f=()=>{n.removeEventListener("input",c),t.removeEventListener("click",p),r&&(r.onclick=null)};n.addEventListener("input",c),t.addEventListener("click",p),r.onclick=u,await H("#favoritesModal",f)}function Te(e){const a=document.querySelector("#favManagerBody"),l=document.querySelector("#favManagerItemTpl"),t=ce()[e]||[];if(!a||!l)return;t.length===0?a.innerHTML='<p class="empty-state">ไม่มีรายการโปรดที่บันทึกไว้</p>':a.innerHTML=t.map(s=>{let i="-";return s.price>=0&&(i=C(s.price)),l.innerHTML.replace(/{CODE}/g,T(s.code)).replace(/{PRICE}/g,i).replace(/{RAW_PRICE}/g,s.price)}).join(""),G=null;const n=document.querySelector('#favManagerModal [data-act="edit-selected-fav"]'),r=document.querySelector('#favManagerModal [data-act="del-selected-fav"]');n&&(n.disabled=!0),r&&(r.disabled=!0)}async function ct(e){const a=document.querySelector("#favManagerModal");if(!a||!e)return;let l=F[e]?.name||e;e==="fabric"?l="ผ้าทึบ":e==="sheer"&&(l="ผ้าโปร่ง"),a.dataset.currentType=e,we=!1,G=null,document.querySelector("#favManagerTitle").textContent=`จัดการ '${T(l)}'`,Te(e),await H("#favManagerModal")}function oo(e){if(!e||!e.matches(m.itemCard)||e.classList.contains("placeholder-item"))return null;const a=e.dataset.type;if(!a)return null;let l={type:a,is_suspended:e.classList.contains("is-suspended")};try{if(a==="set")Object.assign(l,{width_m:y(e.querySelector(m.setWidthInput)?.value),height_m:y(e.querySelector(m.setHeightInput)?.value),style:e.querySelector(m.setStyleSelect)?.value||"",fabric_variant:e.querySelector(m.setFabricVariantSelect)?.value||"",price_per_m_raw:y(e.querySelector(m.setPricePerMSelect)?.value),sheer_price_per_m:y(e.querySelector(m.setSheerPricePerMSelect)?.value),louis_price_per_m:y(e.querySelector('select[name="louis_price_per_m"]')?.value),fabric_code:e.querySelector(m.setFabricCodeInput)?.value||"",sheer_fabric_code:e.querySelector(m.setSheerCodeInput)?.value||"",opening_style:e.querySelector(m.setOpeningStyleSelect)?.value||"",adjustment_side:e.querySelector(m.setAdjustmentSideSelect)?.value||"ปรับขวา",track_color:e.querySelector('input[name="track_color"]')?.value||"ขาว",bracket_color:e.querySelector('input[name="bracket_color"]')?.value||"ขาว",finial_color:e.querySelector('input[name="finial_color"]')?.value||"ขาว",grommet_color:e.querySelector('input[name="grommet_color"]')?.value||"เงิน",louis_valance:e.querySelector('input[name="louis_valance"]')?.value||"กล่องหลุยส์",louis_tassels:e.querySelector('input[name="louis_tassels"]')?.value||"สีเข้ากับผ้า",notes:e.querySelector(m.setNotesInput)?.value||""});else if(a==="wallpaper"){const o=e.querySelector(m.wallInstallCostInput),t=o?o.value:"";let n;t==="0"?n=0:y(t)>0?n=y(t):n=void 0,Object.assign(l,{height_m:y(e.querySelector(m.wallHeightInput)?.value),wallpaper_code:e.querySelector(m.wallCodeInput)?.value||"",price_per_roll:y(e.querySelector(m.wallPriceRollInput)?.value),install_cost_per_roll:n,notes:e.querySelector(m.wallNotesInput)?.value||"",widths:Array.from(e.querySelectorAll(m.wallWidthInput)).map(r=>y(r.value))})}else e.matches(m.areaBasedItem)&&(Object.assign(l,{width_m:y(e.querySelector(m.areaWidthInput)?.value),height_m:y(e.querySelector(m.areaHeightInput)?.value),price_sqyd:y(e.querySelector(m.areaPriceSqydInput)?.value),code:e.querySelector(m.areaCodeInput)?.value||"",notes:e.querySelector(m.areaNotesInput)?.value||""}),(a==="partition"||a==="pleated_screen")&&(l.opening_style=e.querySelector('select[name="opening_style"]')?.value||"แยกกลาง"),["wooden_blind","roller_blind","vertical_blind","aluminum_blind"].includes(a)&&(l.adjustment_side=e.querySelector('select[name="adjustment_side"]')?.value||"ปรับขวา"));return l}catch(o){return console.error("Failed to extract item data:",o,e),null}}function ro(e){if(!e)return;const a=e.closest(m.room);if(!a||!a.getItemsContainer())return;se(U()),ee();let o;if(e.classList.contains("placeholder-item")){const t=document.querySelector("#placeholderItemTpl");if(t){o=t.content.cloneNode(!0).firstElementChild,o.dataset.widthM=e.dataset.widthM,o.dataset.heightM=e.dataset.heightM;const r=o.querySelector("[data-placeholder-width]"),s=o.querySelector("[data-placeholder-height]");r&&(r.textContent=X(e.dataset.widthM)),s&&(s.textContent=X(e.dataset.heightM)),e.classList.contains("is-suspended")&&o.classList.add("is-suspended")}else{q("ไม่พบ Template สำหรับ Placeholder","error");return}}else{const t=oo(e);if(!t){q("ไม่สามารถคัดลอกรายการได้","error");return}if(t.type==="set")o=Ce(t);else if(t.type==="wallpaper")o=Be(t);else if(F[t.type]?.templateId==="#areaBasedTpl")o=Ae(t.type,t);else{q("ไม่รู้จักประเภทรายการ","error");return}}if(o){if(e.after(o),o.classList.add("item-created"),!o.classList.contains("placeholder-item")){const t=e.querySelector(m.itemDetailsMore);t&&t.classList.contains("show")&&Me(o,!0)}ve(o),ae(),J(),q("คัดลอกรายการแล้ว","success")}}function ao(){const e=document.querySelector(m.orderForm),a=document.querySelector(m.fileImporter),l=document.querySelector("#favImporter"),o=document.querySelector(m.menuDropdown),t=document.querySelector(m.quickNavDropdown),n=document.querySelector(m.menuBtn),r=document.querySelector(m.quickNavBtn);if(e){if(e.addEventListener("item-update",J),e.addEventListener("input",s=>{if(Z){s.preventDefault();return}if(s.target.closest("#customerInfo")&&z(),s.target.matches(m.roomNameInput)){const d=s.target.closest(".room-card")?.querySelector("[data-room-name-display]");d&&(d.textContent=s.target.value||"ห้อง"),Ee(),$e(),qe(z,300)()}s.target.matches('input[name$="_m"], input[name$="price_sqyd"], input[name$="price_roll"], input[name$="install_cost"]')&&J()}),e.addEventListener("change",s=>{if(Z){s.preventDefault();return}s.target.matches("select")&&J()}),e.addEventListener("blur",s=>{const i=s.target;i.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_install_cost"]')?i.name==="wallpaper_install_cost"&&y(i.value)===0?i.value="0":i.value=y(i.value)>0?C(y(i.value)):"":i.matches('input[name$="_m"], input[name^="wall_width_m"], input[name^="modal_"]')&&(i.value=X(i.value)),!i.closest(".modal-wrapper")&&i.matches('input:not([type="hidden"]), select, textarea')&&z()},!0),e.addEventListener("focusin",s=>{const i=s.target;if(i.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_install_cost"]')&&(i.name==="wallpaper_install_cost"&&i.value==="0"||y(i.value)>0&&(i.value=y(i.value))),i.matches('input:not([type="hidden"]), select, textarea')){const d=document.querySelector(".main-header"),c=document.querySelector(".summary-footer"),p=d?d.offsetHeight+16:80,u=c?c.offsetHeight+16:100,f=window.innerHeight,v=i.getBoundingClientRect();if((v.top<p||v.bottom>f-u)&&!i.closest(".modal-wrapper")){const h=i.closest(".item-card, .room-card");h&&ve(h)}}},!0),e.addEventListener("keydown",s=>{if(Z){s.preventDefault();return}const i=s.target;if(s.key==="Enter"&&i.matches("input, select")&&!i.closest(".modal-wrapper"))s.preventDefault();else if(s.key==="Enter"&&i.closest("#dimensionEntryModal")){const d=i.closest("#dimensionEntryModal"),c=d.querySelectorAll(".dimension-input-row"),u=c[c.length-1].querySelector('input[name="modal_height_m"]');i===u&&(s.preventDefault(),d.querySelector("#dimensionEntryConfirm")?.click())}}),document.addEventListener("click",async s=>{s.target.closest(".menu-container")||(o?.classList.remove("show"),n?.setAttribute("aria-expanded","false"),t?.classList.remove("show"),r?.setAttribute("aria-expanded","false")),s.target.closest(".room-options-container")||document.querySelectorAll(".room-options-menu.show").forEach(p=>p.classList.remove("show"));const i=s.target.closest(".summary-tag[data-filter-type]");if(i&&i.closest("#overviewModal")){const p=i.dataset.filterType,u=i.textContent.trim().replace(/\s*\d+\s*$/,""),f=document.querySelector("#overviewModal");f&&typeof f.closeModal=="function"&&f.closeModal({cancelled:!0}),Pt(p,u);return}const d=s.target.closest(".fav-manager-item");if(d){const p=d.closest("#favManagerModal"),u=p?.querySelector(".fav-manager-item.is-selected");u&&u.classList.remove("is-selected"),u!==d?(d.classList.add("is-selected"),G={code:d.dataset.code,price:y(d.dataset.price)}):G=null,p&&(p.querySelector('[data-act="edit-selected-fav"]').disabled=!G,p.querySelector('[data-act="del-selected-fav"]').disabled=!G);return}const c=s.target.closest("[data-act]");if(c){const p=c.dataset.act,u=c.closest(".item-card"),f=c.closest(".room-card"),v=["toggle-more-details","collapse-room","show-discount-modal","show-suspended-items","clear-filter","close-modal","jump-to-item","manage-favorites","show-favorites"];if(Z&&!c.closest(".unlockable")&&!v.includes(p)){q("ฟอร์มถูกล็อคอยู่","warning");return}switch(["toggle-more-details","close-modal","collapse-room","remove-dimension-row"].includes(p)||s.preventDefault(),p!=="close-modal"&&s.stopPropagation(),p){case"show-discount-modal":Nt();break;case"show-suspended-items":Ne();break;case"clear-filter":st();break;case"add-room":he();break;case"add-item":if(f){const _=document.querySelector("#dimensionEntryModal");if(_){const h=_.querySelector("#dimensionRowsContainer");h.innerHTML="";const b=et();h.appendChild(b),b.querySelector('input[name="modal_width_m"]')?.focus();const I=await H("#dimensionEntryModal");if(I&&!I.cancelled){const B=[];if(h.querySelectorAll(".dimension-input-row").forEach(g=>{const S=g.querySelector('input[name="modal_width_m"]'),$=g.querySelector('input[name="modal_height_m"]'),x=y(S.value),w=y($.value);x>0&&w>0&&B.push({width_m:x,height_m:w})}),B.length>0){se(U()),ee();let g=null;B.forEach(S=>{const $=Yt(S,f);g||(g=$)}),g&&(ae(),z(),ve(g),q(`เพิ่ม ${B.length} รายการ (รอเลือกประเภท)`,"success"))}else q("ไม่มีขนาดที่ถูกต้องระบุ","warning")}}}break;case"add-dimension-row":{const _=document.querySelector("#dimensionRowsContainer");if(_){const h=et();_.appendChild(h),h.querySelector('input[name="modal_width_m"]')?.focus(),_.scrollTop=_.scrollHeight}break}case"remove-dimension-row":{const _=c.closest(".dimension-input-row"),h=_?.parentElement;_&&h&&h.children.length>1&&_.remove();break}case"select-item-type":if(u&&u.classList.contains("placeholder-item")){const _={width_m:parseFloat(u.dataset.widthM||0),height_m:parseFloat(u.dataset.heightM||0)};if(_.width_m>0&&_.height_m>0){const h=await it("เลือกประเภทสินค้า");h&&Qt(u,h,_)}else q("ขนาดไม่ถูกต้องบน Placeholder","error")}break;case"collapse-room":f&&(f.open=!1,setTimeout(()=>{ne(),z()},50));break;case"toggle-room-menu":c.nextElementSibling?.classList.toggle("show");break;case"open-room-defaults":f&&(Rt(f),c.closest(".room-options-menu")?.classList.remove("show"));break;case"apply-room-defaults":jt();break;case"open-force-apply-modal":Ht();break;case"force-apply-defaults":Wt();break;case"toggle-suspend-room":f&&(f.classList.toggle("is-suspended"),c.closest(".room-options-menu")?.classList.remove("show"),J(),ye==="suspended"?Ne():_e());break;case"clear-room":f&&await re("ล้างข้อมูลในห้อง","?")&&(se(U()),ee(),f.getItemsContainer().innerHTML="",ae(),J(),q("ล้างแล้ว","success"));break;case"del-room":f&&await re("ลบห้อง","?")&&Fe(f,"ลบแล้ว");break;case"del-item":u&&await re("ลบรายการ","?")&&Fe(u,"ลบแล้ว");break;case"duplicate-item":u&&ro(u);break;case"toggle-suspend":u&&(u.classList.toggle("is-suspended"),J(),ye==="suspended"?Ne():_e());break;case"change-type":u&&Kt(u);break;case"toggle-more-details":u&&!u.querySelector(".item-details-more")?.classList.contains("show")&&document.querySelectorAll(".item-details-more.show").forEach(_=>{_.closest(".item-card")!==u&&Me(_.closest(".item-card"),!1)}),Me(u);break;case"open-hardware-modal":R=u,R&&Ft();break;case"apply-hardware-to-room":{const _=c.closest("#hardwareModal"),h=R?.closest(m.room);if(!_||!h||!R)break;const b=R.querySelector('[name="set_style"]');if(b?.value==="ม่านพับ"||b?.value==="หลุยส์"){q("ไม่สามารถใช้กับม่านพับหรือม่านหลุยส์ได้","warning");break}const I=_.querySelector('[name="modal_track_color"]').value,B=_.querySelector('[name="modal_bracket_color"]').value,g=_.querySelector('[name="modal_finial_color"]').value,S=_.querySelector('[name="modal_grommet_color"]').value;h.querySelectorAll('.set-item:not(:has(select[name="set_style"][value="ม่านพับ"])):not(:has(select[name="set_style"][value="หลุยส์"]))').forEach($=>{$.querySelector('[name="track_color"]').value=I,$.querySelector('[name="bracket_color"]').value=B,$.querySelector('select[name="set_style"]')?.value==="ตาไก่"&&($.querySelector('[name="finial_color"]').value=g,$.querySelector('[name="grommet_color"]').value=S)}),z(),q("ใช้กับรายการที่เข้ากันได้ในห้องแล้ว","success");break}case"add-wall":{const _=c.closest(".walls-section")?.querySelector("[data-walls-container]");if(_){const h=Oe();h&&(_.appendChild(h),h.querySelector("input")?.focus(),J())}break}case"del-wall":{const _=c.closest(".wall-input-row");_&&await re("ลบผนัง","?")&&Fe(_,"ลบแล้ว");break}case"show-favorites":{const _=c.previousElementSibling?.matches("input[data-favorite-type]")?c.previousElementSibling:c.closest(".form-group-with-favorites")?.querySelector("input[data-favorite-type]");_?to(_):console.warn("Could not find associated input for show-favorites button:",c);break}case"add-new-fav-form":{const h=c.closest("#favManagerModal")?.dataset.currentType;if(!h)break;const b=document.querySelector("#favAddModal");if(!b)break;let I=F[h]?.name||h;h==="fabric"?I="ผ้าทึบ":h==="sheer"&&(I="ผ้าโปร่ง"),b.querySelector("h3").textContent=`เพิ่ม '${I}'`;const B=b.querySelector('[name="fav_code_add"]'),g=b.querySelector('[name="fav_price_add"]');B.value="",g.value="";const S=await H("#favAddModal");if(S&&!S.cancelled){const $=B.value.trim(),x=y(g.value);$&&x>=0?Ue(h,$,x)?(we=!0,Te(h),q("เพิ่มแล้ว","success")):q("ล้มเหลว","error"):q($?"ราคาต้องไม่ติดลบ":"ต้องระบุรหัส","warning")}break}case"edit-selected-fav":{if(!G)break;const h=c.closest("#favManagerModal")?.dataset.currentType;if(!h)break;const b=document.querySelector("#favEditModal");if(!b)break;b.querySelector("h3").textContent=`แก้ไข '${G.code}'`;const I=b.querySelector('[name="fav_code_edit"]'),B=b.querySelector('[name="fav_price_edit"]');I.value=G.code,B.value=G.price!==null&&G.price>=0?G.price:"";const g=await H("#favEditModal");if(g&&!g.cancelled){const S=I.value.trim(),$=y(B.value);S&&$>=0?(S!==G.code&&Je(h,G.code),Ue(h,S,$),we=!0,Te(h),q("แก้ไขรายการโปรดแล้ว","success")):q(S?"ราคาต้องไม่ติดลบ":"ต้องระบุรหัส","warning")}break}case"del-selected-fav":{if(!G)break;const h=c.closest("#favManagerModal")?.dataset.currentType;if(!h)break;await re("ลบรายการโปรด",`"${G.code}"?`)&&(Je(h,G.code)?(we=!0,Te(h),q("ลบแล้ว","success")):q("ล้มเหลว","error"));break}case"manage-favorites-from-defaults":await Vt();break;case"jump-to-item":Zt(c);break}}else{const p=s.target.closest("summary");p&&p.closest("details.card")&&setTimeout(()=>{ne(),z()},50)}}),document.querySelector("#undoBtn")?.addEventListener("click",s=>{s.preventDefault(),Et()}),document.querySelector(m.lockBtn)?.addEventListener("click",s=>{s.preventDefault(),Ut()}),document.querySelector(m.toggleAllRoomsBtn)?.addEventListener("click",s=>{s.preventDefault(),Jt()}),r&&t){r.addEventListener("click",i=>{i.stopPropagation(),o?.classList.remove("show");const d=!t.classList.contains("show");t.classList.toggle("show",d),r.setAttribute("aria-expanded",d),d&&n?.setAttribute("aria-expanded","false")}),document.querySelector(m.quickNavRoomList)?.addEventListener("click",i=>{const d=i.target.closest("a[data-jump-to]");if(d){i.preventDefault();const c=d.dataset.jumpTo,p=document.getElementById(c);p&&(p.open=!0,p.scrollIntoView({behavior:"smooth",block:"center"}),p.classList.add("scrolling-jump"),setTimeout(()=>p.classList.remove("scrolling-jump"),2500),setTimeout(ne,100)),t.classList.remove("show"),r.setAttribute("aria-expanded","false")}});const s=document.querySelector("#addRoomQuickNavBtn");if(s){const i=ht(he,700);s.addEventListener("click",d=>{d.stopPropagation(),i(),t.classList.remove("show"),r.setAttribute("aria-expanded","false")})}}n&&o&&n.addEventListener("click",s=>{s.stopPropagation(),t?.classList.remove("show");const i=!o.classList.contains("show");o.classList.toggle("show",i),n.setAttribute("aria-expanded",i),i&&r?.setAttribute("aria-expanded","false")}),document.querySelector("#themeToggleBtn")?.addEventListener("click",s=>{s.preventDefault(),At(),o?.classList.remove("show"),n?.setAttribute("aria-expanded","false")}),document.querySelector("#overviewBtn")?.addEventListener("click",async s=>{s.preventDefault(),o?.classList.remove("show"),n?.setAttribute("aria-expanded","false");const i=U(),d=document.querySelector("#overviewModalHeader"),c=document.querySelector("#overviewModalBody");if(d&&c){const p=i.rooms.reduce((v,_)=>v+(_.is_suspended?0:(_.items||[]).filter(h=>!h.is_placeholder&&!h.is_suspended&&(D.calculateSetPrice(h)?.total>0||D.calculateWallpaperPrice(h)?.total>0||D.calculateAreaBasedPrice(h)?.total>0)).length),0),u=document.querySelector(m.grandTotal)?.textContent||"0",f=i.rooms.filter(v=>!v.is_suspended&&v.items?.some(_=>!_.is_suspended)).length;d.innerHTML=`<div class="overview-stats-grid"><div class="overview-stat-card"><i class="ph-bold ph-map-pin-line"></i><div class="stat-value">${f}</div><div class="stat-label">ห้อง</div></div><div class="overview-stat-card"><i class="ph-bold ph-stack"></i><div class="stat-value">${p}</div><div class="stat-label">รายการ</div></div><div class="overview-stat-card"><i class="ph-bold ph-coins"></i><div class="stat-value">${u}</div><div class="stat-label">ยอดรวม</div></div></div>`,c.innerHTML=It(i),H("#overviewModal")}}),document.querySelector("#copyTextBtn")?.addEventListener("click",async s=>{s.preventDefault(),o?.classList.remove("show"),n?.setAttribute("aria-expanded","false");const i=document.querySelector(m.copyOptionsModal);if(!i)return;i.querySelector('input[name="copy_option"][value="customer"]').checked=!0;const d=await H(m.copyOptionsModal);if(d&&!d.cancelled){const c=i.querySelector('input[name="copy_option"]:checked').value,p=Tt(U(),c);try{await navigator.clipboard.writeText(p),q("คัดลอกสำเร็จ!","success")}catch{q("คัดลอกล้มเหลว","error")}}}),document.querySelector("#visualReportsBtn")?.addEventListener("click",async s=>{s.preventDefault(),o?.classList.remove("show"),n?.setAttribute("aria-expanded","false");const i=document.querySelector("#visualReportsModal");if(!i)return;i.querySelector('input[name="report_type_option"][value="lookbook"]').checked=!0;const d=await H("#visualReportsModal");if(d&&!d.cancelled){const c=i.querySelector('input[name="report_type_option"]:checked').value;if(c==="lookbook"){const p=U(),u=Ct(p),f=document.querySelector("#lookbookModalBody");u&&f?(f.innerHTML=u,H("#lookbookModal")):q("ไม่มีข้อมูล","warning")}else q(`'${c}' ยังไม่พร้อม`,"default")}}),document.querySelector(m.exportPdfBtn)?.addEventListener("click",async s=>{s.preventDefault(),o?.classList.remove("show"),n?.setAttribute("aria-expanded","false");const i=await Dt();if(!i)return;const d=U(),c=Lt(d,{vatRate:i.vatOption==="include"?j.baseVatRate:0,pageBreakBuffer:i.pageBreakBuffer,showDetails:i.showDetails});if(!c){q("ไม่มีรายการ","warning");return}i.exportMethod==="html"?zt(c):Xt(c.html,i.exportMethod)}),document.querySelector(m.submitBtn)?.addEventListener("click",async s=>{if(s.preventDefault(),o?.classList.remove("show"),n?.setAttribute("aria-expanded","false"),await re("ส่งข้อมูล","?")){const i=U();if(!i.customer_name&&!i.customer_phone){q("ใส่ชื่อ/เบอร์","warning");return}q("กำลังส่ง...","default");try{const d=await fetch(pt,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});d.ok?q("ส่งแล้ว!","success"):q(`ล้มเหลว: ${d.status}`,"error")}catch{q("เชื่อมต่อผิดพลาด","error")}}}),document.querySelector(m.importBtn)?.addEventListener("click",s=>{s.preventDefault(),o?.classList.remove("show"),n?.setAttribute("aria-expanded","false"),a?.click()}),a?.addEventListener("change",s=>{const i=s.target.files?.[0];if(!i)return;const d=new FileReader;d.onload=async c=>{try{const p=JSON.parse(c.target.result);if(p&&typeof p=="object")await Ve(p,!0);else throw new Error("Invalid JSON")}catch(p){q("ไฟล์ JSON ไม่ถูก","error"),console.error(p)}},d.readAsText(i),s.target.value=null}),document.querySelector(m.exportBtn)?.addEventListener("click",s=>{s.preventDefault(),o?.classList.remove("show"),n?.setAttribute("aria-expanded","false");try{const i=U(),d=JSON.stringify(i,null,4),c=new Blob([d],{type:"application/json"}),p=URL.createObjectURL(c),u=document.createElement("a"),f=new Date,v=`${f.getFullYear()}${(f.getMonth()+1).toString().padStart(2,"0")}${f.getDate().toString().padStart(2,"0")}`,_=`${f.getHours().toString().padStart(2,"0")}${f.getMinutes().toString().padStart(2,"0")}`,h=tt(i.customer_name||"data");u.href=p,u.download=`MTR-${v}${_}-${h}.json`,u.click(),URL.revokeObjectURL(p),q("Export สำเร็จ","success")}catch{q("Export ล้มเหลว","error")}}),document.querySelector("#importFavsBtn")?.addEventListener("click",s=>{s.preventDefault(),o?.classList.remove("show"),n?.setAttribute("aria-expanded","false"),l?.click()}),l?.addEventListener("change",s=>{const i=s.target.files?.[0];if(!i)return;const d=new FileReader;d.onload=c=>{try{const p=JSON.parse(c.target.result),u=He(p);u>0?q(`เพิ่ม ${u} รายการ`,"success"):q("ไม่พบรายการใหม่","default")}catch{q("ไฟล์ JSON ไม่ถูก","error")}},d.readAsText(i),s.target.value=null}),document.querySelector("#exportFavsBtn")?.addEventListener("click",s=>{s.preventDefault(),o?.classList.remove("show"),n?.setAttribute("aria-expanded","false");try{const i=ce();if(Object.values(i).every(v=>v.length===0)){q("ไม่มีรายการ","warning");return}const d=JSON.stringify(i,null,4),c=new Blob([d],{type:"application/json"}),p=URL.createObjectURL(c),u=document.createElement("a"),f=new Date().toISOString().slice(0,10).replace(/-/g,"");u.href=p,u.download=`MTR-Favorites-${f}.json`,u.click(),URL.revokeObjectURL(p),q("Export สำเร็จ","success")}catch{q("Export ล้มเหลว","error")}}),document.querySelector(m.clearItemsBtn)?.addEventListener("click",async s=>{if(s.preventDefault(),o?.classList.remove("show"),n?.setAttribute("aria-expanded","false"),await re("ล้างทุกรายการ","?")){se(U()),ee(),document.querySelectorAll(m.room).forEach(c=>{c.getItemsContainer().innerHTML=""});const i=document.querySelector("#discount_type"),d=document.querySelector("#discount_value");i&&(i.value="amount"),d&&(d.value="0"),ae(),J(),q("ล้างแล้ว","success")}}),document.querySelector(m.clearAllBtn)?.addEventListener("click",async s=>{if(s.preventDefault(),o?.classList.remove("show"),n?.setAttribute("aria-expanded","false"),await re("ลบข้อมูลทั้งหมด","คำเตือน! ข้อมูลทั้งหมดรวมถึงรายการโปรดจะถูกลบถาวร ยืนยันหรือไม่?")){const i=document.querySelector(m.roomsContainer);i&&(i.innerHTML=""),localStorage.removeItem(ge),_t(),q("ลบข้อมูลทั้งหมดแล้ว กำลังรีโหลด...","success"),setTimeout(()=>window.location.reload(),500)}}),document.querySelector("#roomDefaultsConfirmBtn")?.addEventListener("click",Ot),window.addEventListener("click",s=>{s.target.closest(".menu-container")||(o?.classList.remove("show"),t?.classList.remove("show"),n?.setAttribute("aria-expanded","false"),r?.setAttribute("aria-expanded","false")),s.target.closest(".room-options-container")||document.querySelectorAll(".room-options-menu.show").forEach(d=>d.classList.remove("show"));const i=s.target.closest(".item-card");document.querySelectorAll(".item-details-more.show").forEach(d=>{const c=d.closest(".item-card");c!==i&&Me(c,!1)})}),window.addEventListener("beforeunload",z),document.querySelector("#forceApplySelectTypeBtn")?.addEventListener("click",async s=>{if(s.preventDefault(),Z){q("ฟอร์มถูกล็อคอยู่","warning");return}const i=document.querySelector("#forceApplyTypeModal");if(!i)return;const d=document.querySelector('#forceApplyModal [name="force_apply_type_hidden"]')?.value;let c=i.querySelector(`input[name="force_apply_type_option"][value="${d}"]`);c||(c=i.querySelector('input[name="force_apply_type_option"]')),c&&(c.checked=!0);const p=await H("#forceApplyTypeModal");if(p&&!p.cancelled){const u=i.querySelector('input[name="force_apply_type_option"]:checked');if(u){const f=u.value,v=document.querySelector("#forceApplyModal"),_=v?.querySelector('[name="force_apply_type_hidden"]'),h=v?.querySelector("#forceApplySelectedTypeDisplay"),b=v?.querySelector('[name="force_apply_code"]'),I=b?.closest(".form-group-with-favorites")?.querySelector(".btn-show-favs"),B=u.closest("label")?.querySelector("strong"),g=B?B.textContent.trim():f;_&&(_.value=f),h&&(h.textContent=g),b&&(b.dataset.favoriteType=f,b.focus()),I&&(I.disabled=!1)}}})}}function no(){const e=document.querySelector(m.setTpl);if(!e)return;const a=e.content.querySelector(m.setPricePerMSelect),l=e.content.querySelector(m.setSheerPricePerMSelect),o=e.content.querySelector(m.setLouisPricePerMSelect),t=n=>{let r='<option value="" hidden>เลือกราคา</option>';return Array.isArray(n)?(n.forEach(s=>{r+=`<option value="${s}">${s.toLocaleString("th-TH")}</option>`}),r):(console.error("Price data for dropdown is not available or not an array.",n),r)};a&&(a.innerHTML=t(be.fabric)),l&&(l.innerHTML=t(be.sheer)),o&&(o.innerHTML=t(be.louis))}function so(){no(),nt(),ao();try{const e=localStorage.getItem(ge);if(e&&e!=="null"&&e!=="{}"){const a=JSON.parse(e);if(a&&Array.isArray(a.rooms))Ve(a,!1);else{console.warn("Stored data structure seems invalid, starting fresh."),localStorage.removeItem(ge),he();const l=document.querySelector(m.customerCard);l&&(l.open=!0)}}else{he();const a=document.querySelector(m.customerCard);a&&(a.open=!0)}}catch(e){console.error("Failed to load or parse data from localStorage:",e),localStorage.removeItem(ge),he();const a=document.querySelector(m.customerCard);a&&(a.open=!0)}J(),lt(),ne(),$e(),ee(),console.log("Marnthara App Initialized (Vite Refactor)")}document.addEventListener("DOMContentLoaded",so);
