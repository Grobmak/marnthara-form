(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function o(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(n){if(n.ep)return;n.ep=!0;const a=o(n);fetch(n.href,a)}})();const Le="input-ui/5.6.0-final",Te="https://your-make-webhook-url.com/your-unique-path",ee="marnthara.input.v4",$e=500,C={name:"ม่านธารา ผ้าม่านและของตกแต่ง",address:"65/8 หมู่ 2 ต.ท่าศาลา อ.เมือง จ.ลพบุรี 15000",phone:"092-985-9395, 082-552-5595",taxId:"1234567890123",logoUrl:"https://i.imgur.com/l7y85nI.png",baseVatRate:.07,pdf:{paymentTerms:"ชำระมัดจำ 50%",priceValidity:"30 วัน",notes:["ราคานี้รวมค่าติดตั้งแล้ว","ชำระมัดจำ 50% เพื่อยืนยันการสั่งผลิตสินค้า","ใบเสนอราคานี้มีอายุ 30 วัน นับจากวันที่เสนอราคา"]}},Ee=1.19599,ie={ROLL_WIDTH_M:.53,ROLL_LENGTH_M:10,STRIPS_PER_ROLL_UNDER_2_5M:3},ne={fabric:[1e3,1100,1200,1300,1400,1500,1600,1700,1800,1900,2e3,2100,2200],sheer:[1e3,1100,1200,1300,1400,1500],style_surcharge:{ลอน:200,ตาไก่:0,จีบ:0},height:[{threshold:3.2,add_per_m:300},{threshold:2.8,add_per_m:200},{threshold:2.5,add_per_m:100}]},d={orderForm:"#orderForm",roomsContainer:"#rooms",setTpl:"#setTpl",clearAllBtn:"#clearAllBtn",lockBtn:"#lockBtn",grandTotal:"#grandTotal",setCount:"#setCount",modal:"#confirmationModal",modalTitle:"#modalTitle",modalBody:"#modalBody",room:"[data-room]",set:"[data-set]",setsContainer:"[data-sets]",decorationsContainer:"[data-decorations]",decoItem:"[data-deco-item]",wallpapersContainer:"[data-wallpapers]",wallpaperItem:"[data-wallpaper-item]",wallsContainer:"[data-walls-container]",sheerWrap:"[data-sheer-wrap]",roomNameInput:'input[name="room_name"]',toastContainer:"#toast-container",copyTextBtn:"#copyTextBtn",copyOptionsModal:"#copyOptionsModal",menuBtn:"#menuBtn",menuDropdown:"#menuDropdown",importBtn:"#importBtn",exportBtn:"#exportBtn",fileImporter:"#fileImporter",submitBtn:"#submitBtn",clearItemsBtn:"#clearItemsBtn",exportPdfBtn:"#exportPdfBtn",exportOptionsModal:"#exportOptionsModal",printableContent:"#printable-content",quickNavBtn:"#quickNavBtn",quickNavDropdown:"#quickNavDropdown",quickNavRoomList:"#quickNavRoomList",toggleAllRoomsBtn:"#toggleAllRoomsBtn",allDetailsCards:'.card[id="customerDetailsCard"], .room-card'},w=e=>{typeof e=="string"&&(e=e.replace(/,/g,""));const t=parseFloat(e);return Number.isFinite(t)?t:0},A=e=>{const t=w(e);return t>0?t.toFixed(2):""},B=(e,t=2,o=!1)=>Number.isFinite(e)?e.toLocaleString("en-US",{minimumFractionDigits:o?2:t,maximumFractionDigits:o?2:t}):"0",T=(e,t=0)=>Number.isFinite(e)?e.toLocaleString("th-TH",{minimumFractionDigits:t,maximumFractionDigits:t}):"0",ke=(e,t=150)=>{let o;return(...r)=>{clearTimeout(o),o=setTimeout(()=>e(...r),t)}},Ce=(e,t=700)=>{let o=!1;return(...r)=>{if(!o){o=!0;try{return e(...r)}finally{setTimeout(()=>{o=!1},t)}}}};function Ie(e){let t=w(e);if(isNaN(t))return"ข้อมูลตัวเลขไม่ถูกต้อง";if(t===0)return"ศูนย์บาทถ้วน";const o=["","หนึ่ง","สอง","สาม","สี่","ห้า","หก","เจ็ด","แปด","เก้า"],r=["","สิบ","ร้อย","พัน","หมื่น","แสน","ล้าน"];let n=Math.floor(t),a=Math.round((t-n)*100);const s=l=>{if(l===0)return"";let u="";const h=String(l);for(let m=0;m<h.length;m++){const p=h[m];h.length-1;const _=h.length-m-1;p!=="0"&&(_===1&&p==="1"?u+=r[_]:_===1&&p==="2"?u+="ยี่"+r[_]:_===0&&p==="1"&&h.length>1?u+="เอ็ด":u+=o[parseInt(p)]+r[_])}return u};let i="";if(n>0){const l=Math.floor(n/1e6),u=n%1e6;l>0&&(i+=s(l)+"ล้าน"),i+=s(u),i+="บาท"}let c="";return a>0?c=s(a)+"สตางค์":i+="ถ้วน",(i+c).trim()}function H(){var t,o,r,n;const e={app_version:Le,customer_name:((t=document.querySelector('[name="customer_name"]'))==null?void 0:t.value)||"",customer_phone:((o=document.querySelector('[name="customer_phone"]'))==null?void 0:o.value)||"",customer_address:((r=document.querySelector('[name="customer_address"]'))==null?void 0:r.value)||"",customer_card_open:(n=document.querySelector("#customerDetailsCard"))==null?void 0:n.open,rooms:[]};return document.querySelectorAll(d.room).forEach(a=>{var i;const s={id:a.id,room_name:((i=a.querySelector(d.roomNameInput))==null?void 0:i.value)||"",is_suspended:a.classList.contains("is-suspended"),sets:[],decorations:[],wallpapers:[]};a.querySelectorAll(d.set).forEach(c=>{var l,u,h,m,p,_,g,S,f,y,v;s.sets.push({width_m:w((l=c.querySelector('input[name="width_m"]'))==null?void 0:l.value),height_m:w((u=c.querySelector('input[name="height_m"]'))==null?void 0:u.value),style:((h=c.querySelector('select[name="set_style"]'))==null?void 0:h.value)||"",fabric_variant:((m=c.querySelector('select[name="fabric_variant"]'))==null?void 0:m.value)||"",price_per_m_raw:w((p=c.querySelector('select[name="set_price_per_m"]'))==null?void 0:p.value),sheer_price_per_m:w((_=c.querySelector('select[name="sheer_price_per_m"]'))==null?void 0:_.value),fabric_code:((g=c.querySelector('input[name="fabric_code"]'))==null?void 0:g.value)||"",sheer_fabric_code:((S=c.querySelector('input[name="sheer_fabric_code"]'))==null?void 0:S.value)||"",opening_style:((f=c.querySelector('select[name="opening_style"]'))==null?void 0:f.value)||"",track_color:((y=c.querySelector('select[name="track_color"]'))==null?void 0:y.value)||"",notes:((v=c.querySelector('input[name="notes"]'))==null?void 0:v.value)||"",is_suspended:c.classList.contains("is-suspended")})}),a.querySelectorAll(d.decoItem).forEach(c=>{var l,u,h,m,p,_;s.decorations.push({type:((l=c.querySelector('[name="deco_type"]'))==null?void 0:l.value)||"",width_m:w((u=c.querySelector('[name="deco_width_m"]'))==null?void 0:u.value),height_m:w((h=c.querySelector('[name="deco_height_m"]'))==null?void 0:h.value),price_sqyd:w((m=c.querySelector('[name="deco_price_sqyd"]'))==null?void 0:m.value),deco_code:((p=c.querySelector('[name="deco_code"]'))==null?void 0:p.value)||"",notes:((_=c.querySelector('[name="deco_notes"]'))==null?void 0:_.value)||"",is_suspended:c.classList.contains("is-suspended")})}),a.querySelectorAll(d.wallpaperItem).forEach(c=>{var l,u,h,m,p;s.wallpapers.push({height_m:w((l=c.querySelector('[name="wallpaper_height_m"]'))==null?void 0:l.value),wallpaper_code:((u=c.querySelector('[name="wallpaper_code"]'))==null?void 0:u.value)||"",price_per_roll:w((h=c.querySelector('[name="wallpaper_price_roll"]'))==null?void 0:h.value),install_cost_per_roll:w((m=c.querySelector('[name="wallpaper_install_cost"]'))==null?void 0:m.value),notes:((p=c.querySelector('[name="wallpaper_notes"]'))==null?void 0:p.value)||"",widths:Array.from(c.querySelectorAll('[name="wall_width_m"]')).map(_=>w(_.value)),is_suspended:c.classList.contains("is-suspended")})}),e.rooms.push(s)}),e}function F(){localStorage.setItem(ee,JSON.stringify(H()))}const L={stylePlus:e=>ne.style_surcharge[e]??0,heightPlus:e=>{const t=[...ne.height].sort((o,r)=>r.threshold-o.threshold);for(const o of t)if(e>o.threshold)return o.add_per_m;return 0},fabricYardage:(e,t)=>{const o=w(t);return o<=0||!e?0:e==="ตาไก่"||e==="จีบ"?(o*2+.6)/.9:e==="ลอน"?(o*2.6+.6)/.9:0},wallpaperRolls:(e,t)=>{const o=w(e),r=w(t);if(o<=0||r<=0)return 0;const n=r>2.5?Math.floor(ie.ROLL_LENGTH_M/r):ie.STRIPS_PER_ROLL_UNDER_2_5M;if(n<=0)return 0;const a=Math.ceil(o/ie.ROLL_WIDTH_M);return Math.ceil(a/n)},calculateSetPrice:function(e){var s,i;if(!e||e.is_suspended||w(e.width_m)<=0)return{total:0,opaque:0,sheer:0};const t=this.stylePlus(e.style),o=this.heightPlus(w(e.height_m)),r=w(e.width_m),n=(s=e.fabric_variant)!=null&&s.includes("ทึบ")&&w(e.price_per_m_raw)>0?(w(e.price_per_m_raw)+t+o)*r:0,a=(i=e.fabric_variant)!=null&&i.includes("โปร่ง")&&w(e.sheer_price_per_m)>0?(w(e.sheer_price_per_m)+t+o)*r:0;return{total:Math.round(n+a),opaque:Math.round(n),sheer:Math.round(a)}},calculateDecoPrice:function(e){if(!e||e.is_suspended||w(e.width_m)<=0)return{total:0,sqm:0,sqyd:0};const t=w(e.width_m)*w(e.height_m),o=t*Ee,r=o*w(e.price_sqyd);return{total:Math.round(r),sqm:t,sqyd:o}},calculateWallpaperPrice:function(e){var s;if(!e||e.is_suspended)return{total:0,material:0,install:0,rolls:0,sqm:0};const t=((s=e.widths)==null?void 0:s.reduce((i,c)=>i+w(c),0))||0;if(t<=0)return{total:0,material:0,install:0,rolls:0,sqm:0};const o=w(e.height_m),r=this.wallpaperRolls(t,o),n=r*w(e.price_per_roll),a=r*w(e.install_cost_per_roll??300);return{total:Math.round(n+a),material:Math.round(n),install:Math.round(a),rolls:r,sqm:t*o}}};function xe(e){return e.rooms.reduce((t,o)=>{if(o.is_suspended)return t;const r=o.sets.reduce((s,i)=>s+L.calculateSetPrice(i).total,0),n=o.decorations.reduce((s,i)=>s+L.calculateDecoPrice(i).total,0),a=o.wallpapers.reduce((s,i)=>s+L.calculateWallpaperPrice(i).total,0);return t+r+n+a},0)}function Be(e,t){const o=xe(e);let r=`สรุปข้อมูล (${new Date().toLocaleDateString("th-TH",{day:"numeric",month:"numeric",year:"numeric"})})
`;if(r+=`ลูกค้า: ${e.customer_name||"-"}
`,(t==="customer"||t==="owner")&&(r+=`เบอร์โทร: ${e.customer_phone||"-"}
`,r+=`ที่อยู่: ${e.customer_address||"-"}
`),r+=`------------------------------
`,t==="customer")return r+=`
สรุปรายการ
`,e.rooms.forEach(n=>{if(n.is_suspended||[...n.sets,...n.decorations,...n.wallpapers].filter(i=>i.is_suspended?!1:i.widths?i.widths.reduce((c,l)=>c+l,0)>0:i.width_m>0).length===0)return;r+=`
*ห้อง: ${n.room_name||"ไม่ระบุ"}*
`;let s=0;n.sets.forEach(i=>{i.is_suspended||i.width_m<=0||(s++,r+=` ${s}) ผ้าม่าน ${i.style} (${i.fabric_variant})
`)}),n.decorations.forEach(i=>{i.is_suspended||i.width_m<=0||(s++,r+=` ${s}) ${i.type||"ของตกแต่ง"}
`)}),n.wallpapers.forEach(i=>{i.is_suspended||i.widths.reduce((c,l)=>c+l,0)<=0||(s++,r+=` ${s}) วอลเปเปอร์
`)})}),r+=`------------------------------
`,r+=`
สรุปยอดรวม: ${T(o)} บาท
`,r+=`
ขอบคุณที่ใช้บริการ
${C.name}
โทร: ${C.phone}`,r;if(t==="purchase_order"||t==="owner"){const n={opaqueFabrics:[],sheerFabrics:[],decorations:[],wallpapers:[],allSets:[]};if(e.rooms.forEach(a=>{a.is_suspended||(a.sets.forEach(s=>{s.is_suspended||s.width_m<=0||(n.allSets.push(s),s.fabric_variant.includes("ทึบ")&&n.opaqueFabrics.push({code:s.fabric_code||"??",yards:L.fabricYardage(s.style,s.width_m)}),s.fabric_variant.includes("โปร่ง")&&n.sheerFabrics.push({code:s.sheer_fabric_code||"??",yards:L.fabricYardage(s.style,s.width_m)}))}),a.decorations.forEach(s=>{s.is_suspended||!s.type||s.width_m<=0||n.decorations.push({type:s.type,code:s.deco_code||"xxx",width:s.width_m,height:s.height_m})}),a.wallpapers.forEach(s=>{if(s.is_suspended)return;const i=s.widths.reduce((c,l)=>c+l,0);if(i>0){const c=L.wallpaperRolls(i,s.height_m);c>0&&n.wallpapers.push({code:s.wallpaper_code||"xxx",rolls:c})}}))}),r+=`📋 *สรุปวัสดุสำหรับสั่งซื้อผ้า*
`,r+=`------------------------------
`,n.opaqueFabrics.length>0&&n.opaqueFabrics.forEach(a=>{r+=`- ผ้าทึบ (Curtain Fabric)
`,r+=`รหัส: #${a.code||"??"}
`,r+=`จำนวน: ${a.yards.toFixed(2)} หลา

`}),n.sheerFabrics.length>0&&n.sheerFabrics.forEach(a=>{r+=`- ผ้าโปร่ง (Sheer Fabric)
`,r+=`รหัส: #${a.code||"??"}
`,r+=`จำนวน: ${a.yards.toFixed(2)} หลา

`}),r+=`------------------------------
`,r+=`📋 *สำหรับสั่งซื้อ ราง*
`,r+=`------------------------------

`,n.allSets.length>0){let a=1;n.allSets.forEach(s=>{r+=`(${a++}) รางม่าน: ${s.style}, สี: ${s.track_color}
`,s.fabric_variant.includes("ทึบ")&&(r+=`  - รางทึบ: ${s.width_m.toFixed(2)} ม. (1 เส้น)
`),s.fabric_variant.includes("โปร่ง")&&(r+=`  - รางโปร่ง: ${s.width_m.toFixed(2)} ม. (1 เส้น)
`),s.fabric_variant==="ทึบ&โปร่ง"&&(r+=`  (❗️ต้องใช้ขาสองชั้น)
`),r+=`
`})}if(r+=`------------------------------
`,r+=`📋 *สำหรับสั่งซื้อ Blind*
`,r+=`------------------------------

`,n.decorations.length>0){const a={มู่ลี่ไม้:"Wooden Blind",ม่านม้วน:"Roller Blind",ปรับแสง:"Vertical Blind",ฉากกั้นห้อง:"Partition",มุ้งจีบ:"Pleated Insect Screen",มู่ลี่มิเนียม:"Aluminium Blind"};n.decorations.forEach(s=>{const i=a[s.type]?` (${a[s.type]})`:"";r+=`- ${s.type}${i}
`,r+=`รหัส: #${s.code||"xxx"}
`,r+=`ขนาด: ${s.width.toFixed(2)} x ${s.height.toFixed(2)} m.
`,r+=`จำนวน: 1 ชุด

`})}if(r+=`------------------------------
`,r+=`📋 *สำหรับสั่งซื้อ Wallpaper*
`,r+=`------------------------------

`,n.wallpapers.length>0&&n.wallpapers.forEach(a=>{r+=`- วอลเปเปอร์ -
`,r+=`รหัส: #${a.code||"xxx"}
`,r+=`จำนวน: ${a.rolls} ม้วน

`}),r+=`------------------------------
`,t==="purchase_order")return r}return(t==="seamstress"||t==="owner")&&(r+=`
🧵 *รายละเอียดสำหรับช่าง*
`,e.rooms.forEach(n=>{if(n.is_suspended||n.sets.filter(i=>!i.is_suspended&&i.width_m>0).length===0)return;r+=`
*ห้อง: ${n.room_name||"ไม่ระบุ"}*
`;let s=1;n.sets.forEach(i=>{i.is_suspended||i.width_m<=0||(r+=`${s++}) *ผ้าม่าน ${i.style} ${i.fabric_variant}*
`,r+=`  กว้าง ${i.width_m} x สูง ${i.height_m} ม.
`,r+=`  รูปแบบเปิด: ${i.opening_style}
`,i.fabric_variant.includes("ทึบ")&&(r+=`  ผ้าทึบ: รหัส ${i.fabric_code||"-"}
`),i.fabric_variant.includes("โปร่ง")&&(r+=`  ผ้าโปร่ง: รหัส ${i.sheer_fabric_code||"-"}
`))})}),r+=`------------------------------
`,t==="seamstress")||t==="owner"&&(r+=`
💰 *สรุปยอดรวม: ${T(o)} บาท*
`),r}function Me(e){if(!e.rooms||e.rooms.length===0)return'<p class="empty-summary">ไม่มีข้อมูลสำหรับแสดงผล</p>';const t={};let o=0,r="";if(e.rooms.forEach(s=>{if(s.is_suspended)return;const i={};s.sets.forEach(l=>{if(L.calculateSetPrice(l).total>0){const u="ผ้าม่าน";i[u]=(i[u]||0)+1,t[u]=(t[u]||0)+1}}),s.decorations.forEach(l=>{if(l.type&&L.calculateDecoPrice(l).total>0){const u=l.type;i[u]=(i[u]||0)+1,t[u]=(t[u]||0)+1}}),s.wallpapers.forEach(l=>{if(L.calculateWallpaperPrice(l).total>0){const u="วอลเปเปอร์";i[u]=(i[u]||0)+1,t[u]=(t[u]||0)+1}});const c=Object.entries(i);c.length>0&&(r+=`<tr class="room-header-row"><td colspan="3">${s.room_name||"ไม่ระบุชื่อห้อง"}</td></tr>`,c.forEach(([l,u])=>{r+=`<tr><td></td><td class="item-type-cell">${l}</td><td class="pdf-text-center">${u}</td></tr>`,o+=u}))}),o===0)return'<p class="empty-summary">ไม่มีรายการที่มีราคาสำหรับแสดงผล</p>';let a=`<div id="detailed-material-summary">
        <h4><i class="ph ph-stack"></i> ยอดรวมทุกประเภท</h4>
        <ul><li class="summary-note">${Object.entries(t).map(([s,i])=>`${s}: ${i}`).join(" , ")}</li></ul>
    </div>`;return a+=`<table>
        <thead><tr><th>ห้อง</th><th>รายการ</th><th class="pdf-text-center">จำนวน</th></tr></thead>
        <tbody>${r}</tbody>
    </table>`,a}function Ne(e,t){const{vatRate:o,pageBreakBuffer:r=3}=t,n=[];e.rooms.forEach($=>{if($.is_suspended)return;const E=[];$.sets.forEach(b=>{const k=L.calculateSetPrice(b).total;if(k>0){let I=`ผ้าม่าน ${b.style} (${b.fabric_variant}) <br><small>ขนาด ${b.width_m.toFixed(2)} x ${b.height_m.toFixed(2)} ม.${b.notes?` - ${b.notes}`:""}</small>`;E.push({description:I,total:k,units:I.includes("<br>")?1.5:1})}}),$.decorations.forEach(b=>{const k=L.calculateDecoPrice(b).total;if(k>0){let I=`${b.type||"งานตกแต่ง"} <br><small>รหัส: ${b.deco_code||"-"}, ขนาด ${b.width_m.toFixed(2)} x ${b.height_m.toFixed(2)} ม.</small>`;E.push({description:I,total:k,units:I.includes("<br>")?1.5:1})}}),$.wallpapers.forEach(b=>{const k=L.calculateWallpaperPrice(b).total;if(k>0){const I=b.widths.reduce((z,le)=>z+le,0),O=L.wallpaperRolls(I,b.height_m);let R=`วอลเปเปอร์ <br><small>รหัส: ${b.wallpaper_code||"-"}, สูง ${b.height_m.toFixed(2)} ม. (ใช้ ${O} ม้วน)</small>`;E.push({description:R,total:k,units:R.includes("<br>")?1.5:1})}}),E.length>0&&(n.push({isRoomHeader:!0,roomName:$.room_name||"ไม่ระบุชื่อห้อง",units:1.2}),n.push(...E))});const a=n.reduce(($,E)=>$+(E.total||0),0);if(a===0)return null;const s=a*o,i=a+s,c=17,l=23,u=[];let h=[],m=0;n.forEach(($,E)=>{const b=u.length===0?c:l,k=m+$.units>b;let I=!1;if(!k&&E<n.length-1){const O=b-(m+$.units);O>0&&O<r&&(I=!0)}(k||I)&&h.length>0&&(u.push(h),h=[],m=0),h.push($),m+=$.units}),h.length>0&&u.push(h);const p=new Date,_=p.toLocaleDateString("th-TH",{year:"numeric",month:"long",day:"numeric"}),g=`QT-${p.getFullYear()}${(p.getMonth()+1).toString().padStart(2,"0")}${p.getDate().toString().padStart(2,"0")}`;let S="",f=0,y=1;u.forEach(($,E)=>{const b=E===0,k=E===u.length-1,I=`
            <div class="pdf-page-header">
                <div class="pdf-header">
                    <div class="pdf-shop-info">
                        ${`<img src="${C.logoUrl}" alt="Logo" class="pdf-logo">`}
                        <div class="pdf-shop-address">
                            <strong>${C.name}</strong><br>
                            ${C.address.replace(/\n/g,"<br>")}<br>
                            โทร: ${C.phone} | เลขประจำตัวผู้เสียภาษี: ${C.taxId}
                        </div>
                    </div>
                    <div class="pdf-quote-details">
                        <div class="pdf-title-box"><h1>ใบเสนอราคา ${u.length>1?b?"":"(ต่อ)":""}</h1></div>
                        <table class="pdf-quote-meta">
                            <tr><td>เลขที่:</td><td>${g}</td></tr>
                            <tr><td>วันที่:</td><td>${_}</td></tr>
                        </table>
                    </div>
                </div>
                ${b?`
                <section class="pdf-customer-details">
                    <div class="pdf-customer-info">
                        <strong>ลูกค้า:</strong> ${e.customer_name||""}<br>
                        <strong>ที่อยู่:</strong> ${e.customer_address.replace(/\n/g,"<br>")||""}<br>
                        <strong>โทร:</strong> ${e.customer_phone||""}
                    </div>
                    <div class="pdf-customer-meta">
                        <strong>เงื่อนไขชำระเงิน:</strong> ${C.pdf.paymentTerms}<br>
                        <strong>ยืนราคา:</strong> ${C.pdf.priceValidity}
                    </div>
                </section>`:""}
            </div>`,O=`
            <div class="pdf-page-footer">
                <div class="pdf-footer-info">
                    <span>${C.name} | โทร: ${C.phone}</span>
                    <span>หน้า ${E+1} / ${u.length}</span>
                </div>
            </div>`;let R="";b||(R+=`<tr class="pdf-subtotal-row"><td colspan="4">ยอดยกมา (Brought Forward)</td><td class="pdf-text-right">${B(f,2,!0)}</td></tr>`),$.forEach(N=>{N.isRoomHeader?R+=`<tr class="pdf-room-header"><td colspan="5">ห้อง: ${N.roomName}</td></tr>`:(R+=`<tr><td class="pdf-text-center">${y++}</td><td>${N.description}</td><td class="pdf-text-center">1</td><td class="pdf-text-right">${B(N.total,2,!0)}</td><td class="pdf-text-right">${B(N.total,2,!0)}</td></tr>`,f+=N.total)});let z="";k||(z=`<tfoot><tr class="pdf-subtotal-row"><td colspan="4">ยอดยกไป (Carried Forward)</td><td class="pdf-text-right">${B(f,2,!0)}</td></tr></tfoot>`);const le=k?`
            <div class="pdf-summary-wrapper">
                <section class="pdf-summary-section">
                    <div class="pdf-amount-in-words">
                        <strong>หมายเหตุ:</strong>
                        <ul>${C.pdf.notes.map(N=>`<li>${N}</li>`).join("")}</ul>
                        <div class="pdf-amount-text">( ${Ie(i)} )</div>
                    </div>
                    <div class="pdf-totals-block">
                        <table>
                            <tr><td colspan="2" class="pdf-label">รวมเป็นเงิน</td><td class="pdf-amount">${B(a,2,!0)}</td></tr>
                            ${o>0?`<tr><td colspan="2" class="pdf-label">ภาษีมูลค่าเพิ่ม ${(o*100).toFixed(0)}%</td><td class="pdf-amount">${B(s,2,!0)}</td></tr>`:""}
                            <tr class="pdf-grand-total"><td colspan="2" class="pdf-label">ยอดรวมสุทธิ</td><td class="pdf-amount">${B(i,2,!0)}</td></tr>
                        </table>
                    </div>
                </section>
                <footer class="pdf-footer-section">
                    <div class="pdf-signature-box"><p>.................................................</p><p>ผู้เสนอราคา</p><p>(${C.name})</p><p>วันที่: ${_}</p></div>
                    <div class="pdf-signature-box"><p>.................................................</p><p>ลูกค้า / ผู้มีอำนาจลงนาม</p><p>&nbsp;</p><p>วันที่: ......./......./............</p></div>
                </footer>
            </div>
        `:"";S+=`
            <div class="pdf-page">
                <div class="pdf-page-content">
                    ${I}
                    <div class="pdf-page-body">
                        <table class="pdf-items-table">
                            <thead><tr><th style="width:5%;">ลำดับ</th><th style="width:50%;">รายการ</th><th style="width:10%;">จำนวน</th><th style="width:17.5%;">ราคา/หน่วย</th><th style="width:17.5%;">รวม (บาท)</th></tr></thead>
                            <tbody>${R}</tbody>
                            ${z}
                        </table>
                        ${le}
                    </div>
                    ${O}
                </div>
            </div>`});const M=(e.customer_name||"quote").trim().replace(/\s+/g,"-");return{html:`<div id="quotation-template">${S}</div>`,fileName:`${g}_${M}`}}const ue="marnthara.favorites.v3";function j(){try{const e=localStorage.getItem(ue),t={fabric:[],sheer:[],deco:{},wallpaper:[]};return e?{...t,...JSON.parse(e)}:t}catch(e){return console.error("Failed to parse favorites from localStorage",e),{fabric:[],sheer:[],deco:{},wallpaper:[]}}}function de(e){try{localStorage.setItem(ue,JSON.stringify(e))}catch(t){console.error("Failed to save favorites to localStorage",t)}}function ae(e,t,o){return t==="deco"?o?(e.deco[o]||(e.deco[o]=[]),e.deco[o]):null:(e[t]||(e[t]=[]),e[t])}function pe(e,t,o,r=null){const n=j(),a=ae(n,e,r);return!a||a.some(s=>s.code===t)?!1:(a.push({code:t,price:o}),a.sort((s,i)=>s.code.localeCompare(i.code)),de(n),!0)}function Fe(e,t,o,r,n=null){const a=j(),s=ae(a,e,n);if(!s)return!1;const i=s.find(c=>c.code===t);return i?(i.code=o,i.price=r,s.sort((c,l)=>c.code.localeCompare(l.code)),de(a),!0):!1}function fe(e,t,o=null){const r=j(),n=ae(r,e,o);if(!n)return!1;const a=n.findIndex(s=>s.code===t);return a>-1?(n.splice(a,1),de(r),!0):!1}function he(e,t,o=null){if(!e||!t)return;const r=j(),n=t.trim(),a=ae(r,e,o);return a==null?void 0:a.find(s=>s.code===n)}function _e(e,t,o=null){return!!he(e,t,o)}function Pe(e,t,o,r=null){return _e(e,t,r)?(fe(e,t,r),!1):(pe(e,t,o,r),!0)}function Re(){localStorage.removeItem(ue),console.log("All favorites have been cleared.")}let x=!1,J=null,Z=null,G=!1;const ye="marnthara.theme";function ve(){const e=localStorage.getItem(ye),t=document.querySelector("#themeToggleBtn");if(!t)return;const o=t.querySelector("i"),r=t.querySelector("span");e==="dark"?(document.body.classList.add("dark-theme"),o&&(o.className="ph-fill ph-sun"),r&&(r.textContent=" Light Mode")):(document.body.classList.remove("dark-theme"),o&&(o.className="ph-fill ph-moon"),r&&(r.textContent=" Dark Mode"))}function Ae(){document.body.classList.toggle("dark-theme");const e=document.body.classList.contains("dark-theme");localStorage.setItem(ye,e?"dark":"light"),ve()}function q(e,t="default"){const o=document.querySelector(d.toastContainer);if(!o)return;const r={success:"ph-bold ph-check-circle",warning:"ph-bold ph-warning",error:"ph-bold ph-x-circle",default:"ph-bold ph-info"},n=document.createElement("div");n.className=`toast toast-${t}`,n.innerHTML=`<i class="${r[t]||r.default}"></i> ${e}`,o.appendChild(n),setTimeout(()=>n.classList.add("show"),10),setTimeout(()=>{n.classList.remove("show"),n.addEventListener("transitionend",()=>n.remove())},3e3)}function U(e,t){return new Promise(o=>{const r=document.querySelector(e);if(!r){o(null);return}const n=document.querySelector(".modal-wrapper.visible");n&&n.classList.add("is-underlay"),r.classList.add("visible");const a=r.querySelector('[id$="Confirm"]'),s=r.querySelector('[id$="Cancel"], [data-act="close-modal"]'),i=u=>{r.classList.remove("visible"),a&&(a.onclick=null),s&&(s.onclick=null),document.removeEventListener("keydown",c),n&&n.classList.remove("is-underlay"),typeof u=="object"&&u.cancelled&&t&&t(),o(u)},c=u=>{u.key==="Escape"&&!r.classList.contains("is-underlay")&&i({cancelled:!0})},l=()=>{r.classList.contains("is-underlay")||i({cancelled:!0})};a&&(a.onclick=()=>i(!0)),s&&(s.onclick=l),document.addEventListener("keydown",c)})}async function te(e,t){const o=document.querySelector(d.modal);if(!o)return!0;const r=o.querySelector(d.modalTitle),n=o.querySelector(d.modalBody);return r&&(r.textContent=e),n&&(n.textContent=t),await U(d.modal)}async function De(){const e=document.querySelector(d.exportOptionsModal);if(!e||!await U(d.exportOptionsModal))return null;const o=e.querySelector('input[name="vat_option"]:checked'),r=e.querySelector("#exportMethod"),n=e.querySelector("#pageBreakBuffer");return{vatOption:o?o.value:"include",exportMethod:r?r.value:"direct",pageBreakBuffer:n?parseInt(n.value,10):3}}function Y(e,t){e&&(e.classList.add("item-removing"),e.addEventListener("animationend",()=>{e.remove(),t&&q(t),ce(),se(),P(),F(),V()},{once:!0}))}function se(){document.querySelectorAll(d.room).forEach(e=>{const t=e.querySelectorAll(".item-card"),o=t.length;t.forEach((r,n)=>{const a=r.querySelector("[data-item-title]");a&&(a.textContent=`${n+1}/${o}`)})})}function ge(){const e=document.querySelector(d.orderForm),t=document.querySelector(d.lockBtn);if(!e||!t)return;const o=e.querySelectorAll("input, select, textarea, button");e.classList.toggle("is-locked",x),t.classList.toggle("is-locked",x);const r=t.querySelector("i");r&&(r.className=x?"ph-bold ph-lock-key":"ph-bold ph-lock-key-open"),o.forEach(n=>{n.closest(".summary-footer")||n.closest(".main-header")||n.closest(".modal-wrapper")||(n.disabled=x)}),q(x?"ฟอร์มถูกล็อค":"ปลดล็อคฟอร์มแล้ว",x?"warning":"success")}function W(){const e=document.querySelectorAll(d.allDetailsCards);if(e.length===0)return;const t=[...e].some(r=>r.open),o=document.querySelector(d.toggleAllRoomsBtn);if(o){const r=o.querySelector("i"),n=o.querySelector("span");r&&(r.className=t?"ph ph-rows-slash":"ph ph-rows"),n&&(n.textContent=t?"ย่อทั้งหมด":"ขยายทั้งหมด")}}function Oe(){const e=document.querySelectorAll(d.allDetailsCards),t=[...e].some(o=>o.open);e.forEach(o=>{o.open=!t}),setTimeout(W,50)}function ce(){const e=document.querySelector(d.quickNavRoomList);if(!e)return;e.innerHTML="",document.querySelectorAll(d.room).forEach(o=>{const r=o.querySelector(d.roomNameInput),n=r?r.value:"ห้อง",a=document.createElement("a");a.href=`#${o.id}`,a.dataset.jumpTo=o.id,a.innerHTML=`<i class="ph ph-arrow-bend-left-up"></i> ${n||"ห้อง (ไม่มีชื่อ)"}`,e.appendChild(a)})}function Se(e){const t=document.getElementById("quickNavBtnText");if(t)if(e){const o=e.querySelector('input[name="room_name"]');o&&(t.textContent=o.value||"...")}else t.textContent="ไปยังห้อง"}function V(){if(Z&&Z.disconnect(),!document.getElementById("quickNavBtnText"))return;const t={root:null,rootMargin:"-60px 0px -150px 0px",threshold:0},o=n=>{const a=n.filter(s=>s.isIntersecting).sort((s,i)=>s.target.getBoundingClientRect().top-i.target.getBoundingClientRect().top);a.length>0&&Se(a[0].target)};Z=new IntersectionObserver(o,t),document.querySelectorAll(d.room).forEach(n=>Z.observe(n))}function He(){document.querySelectorAll("[data-favorite-type]").forEach(D)}function re(e,t=null){const o=document.getElementById("favManagerBody");if(!o)return;const r=j();let n=[];if(e==="deco"?n=r.deco[t]||[]:n=r[e]||[],o.innerHTML="",n.length===0)o.innerHTML='<p class="empty-state">ไม่มีรายการโปรดที่บันทึกไว้</p>';else{const a=document.getElementById("favManagerItemTpl").innerHTML;n.forEach(s=>{const i=a.replace(/{CODE}/g,s.code).replace(/{PRICE}/g,T(s.price)).replace(/{RAW_PRICE}/g,s.price),c=document.createElement("div");c.innerHTML=i;const l=c.firstElementChild;l.dataset.type=e,t&&(l.dataset.subType=t),o.appendChild(l)})}}async function We(e,t=null){G=!1;const o=document.getElementById("favManagerTitle");if(!o)return;let r="รายการโปรด";e==="deco"?r=`รายการโปรด: ${t||"ของตกแต่ง"}`:r=`รายการโปรด: ${{fabric:"ผ้าทึบ",sheer:"ผ้าโปร่ง",wallpaper:"วอลเปเปอร์"}[e]||e}`,o.textContent=r,o.dataset.type=e,o.dataset.subType=t||"",re(e,t),await U("#favManagerModal"),G&&(He(),J&&we(J))}async function Ue(e){const t=document.querySelector("#favEditModal");if(!t)return null;const o=t.querySelector("#fav_code_edit"),r=t.querySelector("#fav_price_edit");o.value=e.code,r.value=e.price;const n=await U("#favEditModal");return n&&!n.cancelled?{newCode:o.value.trim(),newPrice:w(r.value)}:null}function Q(){document.querySelectorAll(".favorite-chips-container.show").forEach(e=>{e.classList.remove("show")}),J=null}function D(e){var a,s;if(!e)return;const t=e.nextElementSibling;if(!t||!t.matches(".btn-favorite"))return;const o=t.dataset.type;let r=null;o==="deco"&&(r=(s=(a=e.closest(".item-card"))==null?void 0:a.querySelector('[name="deco_type"]'))==null?void 0:s.value);const n=_e(o,e.value,r);t.classList.toggle("is-favorite",n),t.querySelector("i").className=n?"ph-fill ph-star":"ph ph-star"}function we(e){var i,c;Q();const t=e.dataset.favoriteType;if(!t)return;let o=null,r=[];const n=j();t==="deco"?(o=(c=(i=e.closest(".item-card"))==null?void 0:i.querySelector('[name="deco_type"]'))==null?void 0:c.value,o&&(r=n.deco[o]||[])):r=n[t]||[];const a=e.closest(".form-group-with-favorites").querySelector(".favorite-chips-container");if(!a)return;a.innerHTML="",r.length>0&&r.forEach(l=>{const u=document.createElement("button");u.type="button",u.className="btn-chip",u.textContent=l.code,u.dataset.act="select-favorite",u.dataset.code=l.code,u.dataset.price=l.price,a.appendChild(u)});const s=document.createElement("button");s.type="button",s.className="btn-manage-favorites",s.dataset.act="manage-favorites",s.dataset.type=t,o&&(s.dataset.subType=o),s.innerHTML='<i class="ph ph-pencil-simple"></i> แก้ไขรายการโปรด',a.appendChild(s),a.classList.add("show")}function K(e,t,o=!0){Q();const r=document.querySelector(e);if(!r||!t)return null;const n=r.content.cloneNode(!0),a=n.firstElementChild;t.appendChild(n),a.querySelectorAll("input[data-favorite-type]").forEach(D),o&&a&&(a.classList.add("item-created"),a.scrollIntoView({behavior:"smooth",block:"center"}));const s=a.querySelector('input:not([type="hidden"]), select, textarea');return s&&s.focus(),se(),P(),F(),a}function oe(){const e=document.querySelector(d.roomsContainer);if(!e)return;const t=document.querySelectorAll(d.roomNameInput);let o=0;t.forEach(a=>{const s=a.value.match(/\d+/g);if(s){const i=parseInt(s[s.length-1],10);i>o&&(o=i)}});const r=o+1,n=K("#roomTpl",e,!0);if(n){n.id=`room-${Date.now()}`;const a=n.querySelector(d.roomNameInput);a&&(a.value=`ห้อง ${r}`),n.open=!0}ce(),W(),V()}function je(e){if(!e)return;const t=e.querySelector(d.setsContainer);t&&K("#setTpl",t)}function Ve(e){if(!e)return;const t=e.querySelector(d.decorationsContainer);t&&K("#decoTpl",t)}function Ye(e){if(!e)return;const t=e.querySelector(d.wallpapersContainer);if(t){const o=K("#wallpaperTpl",t);o&&qe(o.querySelector('[data-act="add-wall"]'))}}function qe(e){var o;const t=(o=e==null?void 0:e.closest(".walls-section"))==null?void 0:o.querySelector(d.wallsContainer);t&&(K("#wallTpl",t,!0),X(e))}function be(e){var n,a;if(!e)return;const t=(n=e.querySelector('select[name="fabric_variant"]'))==null?void 0:n.value,o=t&&t.includes("โปร่ง");(a=e.querySelector(d.sheerWrap))==null||a.classList.toggle("hidden",!o);const r=e.querySelector('input[name="sheer_fabric_code"]');if(r){const s=r.closest(".form-group-with-favorites");s&&s.classList.toggle("hidden",!o)}}const Ge=ke(e=>{X(e),F()});function Je(e){if(x){q("ฟอร์มถูกล็อค ไม่สามารถแก้ไขได้","warning"),e.preventDefault();return}e.target.matches("input[data-favorite-type]")&&D(e.target),e.target.matches(d.roomNameInput)&&V(),Ge(e.target)}function Qe(e){var r;if(x)return;const t=e.target;if(t.matches('select[name="fabric_variant"]')&&be(t.closest(d.set)),t.matches('select[name="deco_type"]')){const n=t.closest(d.decoItem);if(n){const a=n.querySelector(".deco-type-display");a&&(a.textContent=t.value||"ตกแต่ง");const s=n.querySelector('input[name="deco_code"]');s&&D(s)}}if(t.matches(d.roomNameInput)&&(ce(),V()),["set_price_per_m","sheer_price_per_m","deco_price_sqyd","wallpaper_price_roll"].includes(t.name)){const n=t.closest(".item-card");if(n){let a;if(t.name==="set_price_per_m"&&(a=n.querySelector('[name="fabric_code"]')),t.name==="sheer_price_per_m"&&(a=n.querySelector('[name="sheer_fabric_code"]')),t.name==="deco_price_sqyd"&&(a=n.querySelector('[name="deco_code"]')),t.name==="wallpaper_price_roll"&&(a=n.querySelector('[name="wallpaper_code"]')),a&&a.value){const s=a.dataset.favoriteType;let i=null;s==="deco"&&(i=(r=n.querySelector('[name="deco_type"]'))==null?void 0:r.value);const c=he(s,a.value,i);c&&w(t.value)!==c.price&&(a.value="",D(a),q("ล้างรหัสเนื่องจากราคาไม่ตรงกับ Favorite","warning"))}}}X(t),F()}function Ke(e){const t=e.target,o=t.matches('[name="deco_price_sqyd"], [name="wallpaper_price_roll"], [name="wallpaper_install_cost"], [name="fav_price_edit"], [name="fav_price_new"]'),r=t.matches('input[name="width_m"], input[name="height_m"], input[name="deco_width_m"], input[name="deco_height_m"], input[name="wallpaper_height_m"], input[name="wall_width_m"]');if(o){const n=w(t.value);n>0?t.value=T(n):t.value=""}else r&&(t.value=A(t.value))}function Xe(e){const t=e.target;t.matches("input[data-favorite-type]")&&(J=t,we(t))}function X(e){var n,a,s,i,c,l,u,h,m,p,_,g;if(!e)return;const t=e.closest(d.set);if(t){const S=t.querySelector("[data-set-summary]");if(S){const f={width_m:(n=t.querySelector('input[name="width_m"]'))==null?void 0:n.value,height_m:(a=t.querySelector('input[name="height_m"]'))==null?void 0:a.value,style:(s=t.querySelector('select[name="set_style"]'))==null?void 0:s.value,fabric_variant:(i=t.querySelector('select[name="fabric_variant"]'))==null?void 0:i.value,price_per_m_raw:(c=t.querySelector('select[name="set_price_per_m"]'))==null?void 0:c.value,sheer_price_per_m:(l=t.querySelector('select[name="sheer_price_per_m"]'))==null?void 0:l.value},y=L.calculateSetPrice(f);let v=`ราคา: <b>${T(y.total)}</b> บ.`;y.opaque>0&&y.sheer>0&&(v+=` <small>(ทึบ: ${T(y.opaque)}, โปร่ง: ${T(y.sheer)})</small>`),S.innerHTML=v}}const o=e.closest(d.decoItem);if(o){const S=o.querySelector("[data-deco-summary]");if(S){const f={width_m:(u=o.querySelector('input[name="deco_width_m"]'))==null?void 0:u.value,height_m:(h=o.querySelector('input[name="deco_height_m"]'))==null?void 0:h.value,price_sqyd:(m=o.querySelector('input[name="deco_price_sqyd"]'))==null?void 0:m.value},y=L.calculateDecoPrice(f);S.innerHTML=`ราคา: <b>${T(y.total)}</b> บ. &bull; พื้นที่: ${B(y.sqyd,2)} ตร.หลา`}}const r=e.closest(d.wallpaperItem);if(r){const S=r.querySelector("[data-wallpaper-summary]");if(S){const f={height_m:(p=r.querySelector('input[name="wallpaper_height_m"]'))==null?void 0:p.value,price_per_roll:(_=r.querySelector('input[name="wallpaper_price_roll"]'))==null?void 0:_.value,install_cost_per_roll:(g=r.querySelector('input[name="wallpaper_install_cost"]'))==null?void 0:g.value,widths:Array.from(r.querySelectorAll('input[name="wall_width_m"]')).map(M=>M.value)},y=L.calculateWallpaperPrice(f);let v=`รวม: <b>${T(y.total)}</b> บ. `;(y.material>0||y.install>0)&&(v+=`<small>(วอลล์: ${T(y.material)}, ค่าช่าง: ${T(y.install)})</small>`),v+=` &bull; พื้นที่: ${B(y.sqm,2)} ตร.ม. &bull; ใช้: ${y.rolls} ม้วน`,S.innerHTML=v}}P()}function P(){let e=0,t=0;document.querySelectorAll(d.room).forEach(n=>{let a=0,s=0;const i=n.classList.contains("is-suspended");n.querySelectorAll(d.set).forEach(l=>{var h,m,p,_,g,S;const u=L.calculateSetPrice({is_suspended:i||l.classList.contains("is-suspended"),width_m:(h=l.querySelector('input[name="width_m"]'))==null?void 0:h.value,height_m:(m=l.querySelector('input[name="height_m"]'))==null?void 0:m.value,style:(p=l.querySelector('select[name="set_style"]'))==null?void 0:p.value,fabric_variant:(_=l.querySelector('select[name="fabric_variant"]'))==null?void 0:_.value,price_per_m_raw:(g=l.querySelector('select[name="set_price_per_m"]'))==null?void 0:g.value,sheer_price_per_m:(S=l.querySelector('select[name="sheer_price_per_m"]'))==null?void 0:S.value}).total;a+=u,u>0&&(t++,s++)}),n.querySelectorAll(d.decoItem).forEach(l=>{var h,m,p;const u=L.calculateDecoPrice({is_suspended:i||l.classList.contains("is-suspended"),width_m:(h=l.querySelector('input[name="deco_width_m"]'))==null?void 0:h.value,height_m:(m=l.querySelector('input[name="deco_height_m"]'))==null?void 0:m.value,price_sqyd:(p=l.querySelector('input[name="deco_price_sqyd"]'))==null?void 0:p.value}).total;a+=u,u>0&&(t++,s++)}),n.querySelectorAll(d.wallpaperItem).forEach(l=>{var h,m,p;const u=L.calculateWallpaperPrice({is_suspended:i||l.classList.contains("is-suspended"),height_m:(h=l.querySelector('input[name="wallpaper_height_m"]'))==null?void 0:h.value,price_per_roll:(m=l.querySelector('input[name="wallpaper_price_roll"]'))==null?void 0:m.value,install_cost_per_roll:(p=l.querySelector('input[name="wallpaper_install_cost"]'))==null?void 0:p.value,widths:Array.from(l.querySelectorAll('input[name="wall_width_m"]')).map(_=>_.value)}).total;a+=u,u>0&&(t++,s++)});const c=n.querySelector("[data-room-brief]");c&&(i?c.textContent="(ระงับชั่วคราว)":s>0?c.innerHTML=`<span>${s}</span> &bull; ${T(a)} บาท`:c.textContent=""),e+=i?0:a});const o=document.querySelector(d.grandTotal),r=document.querySelector(d.setCount);o&&(o.textContent=T(e)),r&&(r.textContent=t)}function me(e){if(!e||!e.rooms)return;const t=document.querySelector(d.roomsContainer);if(!t)return;t.innerHTML="";const o=document.querySelector("#customer_name"),r=document.querySelector("#customer_phone"),n=document.querySelector("#customer_address");o&&(o.value=e.customer_name||""),r&&(r.value=e.customer_phone||""),n&&(n.value=e.customer_address||""),e.rooms.forEach(a=>{const s=document.querySelector("#roomTpl");if(!s)return;const i=s.content.cloneNode(!0),c=i.querySelector(d.room);if(!c)return;c.id=a.id||`room-${Date.now()}`,a.is_suspended&&c.classList.add("is-suspended");const l=c.querySelector(d.roomNameInput);l&&(l.value=a.room_name||"ห้อง (ไม่มีชื่อ)");const u=c.querySelector(d.setsContainer),h=c.querySelector(d.decorationsContainer),m=c.querySelector(d.wallpapersContainer),p=document.querySelector("#setTpl"),_=document.querySelector("#decoTpl"),g=document.querySelector("#wallpaperTpl"),S=document.querySelector("#wallTpl");u&&p&&a.sets&&a.sets.forEach(f=>{const y=p.content.cloneNode(!0),v=y.querySelector(d.set);f.is_suspended&&v.classList.add("is-suspended"),v.querySelector('input[name="width_m"]').value=A(f.width_m),v.querySelector('input[name="height_m"]').value=A(f.height_m),v.querySelector('select[name="set_style"]').value=f.style||"ลอน",v.querySelector('select[name="fabric_variant"]').value=f.fabric_variant||"ทึบ",v.querySelector('select[name="set_price_per_m"]').value=f.price_per_m_raw||"",v.querySelector('select[name="sheer_price_per_m"]').value=f.sheer_price_per_m||"",v.querySelector('select[name="opening_style"]').value=f.opening_style||"แยกกลาง",v.querySelector('select[name="track_color"]').value=f.track_color||"ขาว",v.querySelector('input[name="fabric_code"]').value=f.fabric_code||"",v.querySelector('input[name="sheer_fabric_code"]').value=f.sheer_fabric_code||"",v.querySelector('input[name="notes"]').value=f.notes||"",be(v),u.appendChild(y)}),h&&_&&a.decorations&&a.decorations.forEach(f=>{const y=_.content.cloneNode(!0),v=y.querySelector(d.decoItem);f.is_suspended&&v.classList.add("is-suspended");const M=v.querySelector('select[name="deco_type"]');M.value=f.type||"",v.querySelector(".deco-type-display").textContent=f.type||"ตกแต่ง",v.querySelector('input[name="deco_width_m"]').value=A(f.width_m),v.querySelector('input[name="deco_height_m"]').value=A(f.height_m),v.querySelector('input[name="deco_price_sqyd"]').value=T(f.price_sqyd)||"",v.querySelector('input[name="deco_code"]').value=f.deco_code||"",v.querySelector('input[name="deco_notes"]').value=f.notes||"",h.appendChild(y)}),m&&g&&a.wallpapers&&a.wallpapers.forEach(f=>{const y=g.content.cloneNode(!0),v=y.querySelector(d.wallpaperItem);f.is_suspended&&v.classList.add("is-suspended"),v.querySelector('input[name="wallpaper_height_m"]').value=A(f.height_m),v.querySelector('input[name="wallpaper_code"]').value=f.wallpaper_code||"",v.querySelector('input[name="wallpaper_price_roll"]').value=T(f.price_per_roll)||"",v.querySelector('input[name="wallpaper_install_cost"]').value=f.hasOwnProperty("install_cost_per_roll")?T(f.install_cost_per_roll):"300",v.querySelector('input[name="wallpaper_notes"]').value=f.notes||"";const M=v.querySelector(d.wallsContainer);M&&S&&f.widths&&f.widths.forEach($=>{const E=S.content.cloneNode(!0);E.querySelector('input[name="wall_width_m"]').value=A($),M.appendChild(E)}),m.appendChild(y)}),t.appendChild(i)}),document.querySelectorAll("input[data-favorite-type]").forEach(D),document.querySelectorAll(".item-card").forEach(a=>{X(a)}),se(),P(),ce(),W(),V(),q("นำเข้าข้อมูลสำเร็จ","success")}function ze(e,t){const o=document.querySelector(d.printableContent);!o||!e||!e.html||(o.innerHTML=e.html,setTimeout(()=>{if(t==="direct"){const r=document.getElementById("quotation-template");r&&html2pdf().from(r).set({margin:[15,12,10,12],filename:`${e.fileName}.pdf`,pagebreak:{mode:["css","legacy"]},html2canvas:{scale:2,useCORS:!0},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}}).save().then(()=>{o.innerHTML=""})}else t==="print"&&(window.print(),o.innerHTML="")},$e))}function Ze(e){if(!e||!e.html)return;const t=new Blob([e.html],{type:"text/html;charset=utf-8"}),o=URL.createObjectURL(t),r=document.createElement("a");r.href=o,r.download=`${e.fileName}.html`,r.click(),URL.revokeObjectURL(o),q("Export ไฟล์ HTML สำเร็จ","success")}const et=async e=>{var a,s,i,c,l;const t=e.target.closest("[data-act]");if(!t||x&&!t.closest(".unlockable")&&!["select-favorite","manage-favorites","del-fav","edit-fav","close-modal","add-new-fav-form","save-new-fav","cancel-new-fav"].includes(t.dataset.act))return;const o=t.dataset.act,r=t.closest(d.room),n=(u,h,m)=>{te(u,h).then(p=>{p&&m()})};switch(o){case"add-room":oe();break;case"add-set":je(r);break;case"add-deco":Ve(r);break;case"add-wallpaper":Ye(r);break;case"add-wall":qe(t);break;case"del-room":n("ลบห้อง","ยืนยันการลบห้องนี้?",()=>Y(r,"ลบห้องแล้ว"));break;case"del-set":n("ลบรายการ","ยืนยันการลบรายการผ้าม่าน?",()=>Y(t.closest(d.set),"ลบรายการผ้าม่านแล้ว"));break;case"del-deco":n("ลบรายการ","ยืนยันการลบรายการตกแต่ง?",()=>Y(t.closest(d.decoItem),"ลบรายการตกแต่งแล้ว"));break;case"del-wallpaper":n("ลบรายการ","ยืนยันการลบรายการวอลเปเปอร์?",()=>Y(t.closest(d.wallpaperItem),"ลบรายการวอลเปเปอร์แล้ว"));break;case"del-wall":n("ลบผนัง","ยืนยันการลบผนังนี้?",()=>Y(t.closest(".wall-input-row"),"ลบผนังแล้ว"));break;case"clear-room":n("ล้างข้อมูลในห้อง","ยืนยันลบทุกรายการในห้องนี้?",()=>{r.querySelector(d.setsContainer).innerHTML="",r.querySelector(d.decorationsContainer).innerHTML="",r.querySelector(d.wallpapersContainer).innerHTML="",se(),P(),F(),q("ล้างข้อมูลในห้องแล้ว","success")});break;case"toggle-room-menu":e.preventDefault();const u=t.nextElementSibling;if(!u||!r)return;const h=!u.classList.contains("show");document.querySelectorAll(".room-options-menu.show").forEach(m=>m.classList.remove("show")),document.querySelectorAll(".card.overflow-visible").forEach(m=>m.classList.remove("overflow-visible")),h&&(u.classList.add("show"),r.classList.add("overflow-visible"));break;case"toggle-suspend-room":e.preventDefault(),r==null||r.classList.toggle("is-suspended"),P(),F(),(a=t.closest(".room-options-menu"))==null||a.classList.remove("show"),r==null||r.classList.remove("overflow-visible");break;case"toggle-suspend":e.preventDefault(),(s=t.closest(".item-card"))==null||s.classList.toggle("is-suspended"),X(t),F();break;case"toggle-favorite":{const m=t.dataset.type,p=t.previousElementSibling,_=p==null?void 0:p.value;if(!_||_.trim()===""){q("กรุณากรอกรหัสก่อนบันทึก","warning");return}const g=t.closest(".item-card");if(!g)return;let S=0,f=null,y=null;if(m==="fabric"&&(f=g.querySelector('[name="set_price_per_m"]')),m==="sheer"&&(f=g.querySelector('[name="sheer_price_per_m"]')),m==="wallpaper"&&(f=g.querySelector('[name="wallpaper_price_roll"]')),m==="deco"&&(f=g.querySelector('[name="deco_price_sqyd"]'),y=(i=g.querySelector('[name="deco_type"]'))==null?void 0:i.value,!y)){q("กรุณาเลือกประเภทของตกแต่งก่อนบันทึก","warning");return}if(f&&f.value&&(S=w(f.value)),S<=0){q("กรุณากรอกราคาก่อนบันทึกเป็นรายการโปรด","warning");return}const v=Pe(m,_,S,y);D(p),q(v?"บันทึกรหัสโปรดแล้ว":"ลบรหัสโปรดแล้ว","success");break}case"select-favorite":{const m=t.dataset.code,p=t.dataset.price,_=t.closest(".form-group-with-favorites"),g=_?_.querySelector("input[data-favorite-type]"):J;if(g){g.value=m;const S=t.closest(".item-card");if(S&&p){const f=g.dataset.favoriteType;let y=null;f==="fabric"&&(y=S.querySelector('[name="set_price_per_m"]')),f==="sheer"&&(y=S.querySelector('[name="sheer_price_per_m"]')),f==="deco"&&(y=S.querySelector('[name="deco_price_sqyd"]')),f==="wallpaper"&&(y=S.querySelector('[name="wallpaper_price_roll"]')),y&&(y.tagName==="SELECT"?y.value=p:y.value=T(w(p)),y.classList.add("input-highlight"),setTimeout(()=>y.classList.remove("input-highlight"),1200),y.dispatchEvent(new Event("change",{bubbles:!0})))}g.dispatchEvent(new Event("input",{bubbles:!0})),Q(),q(`เลือกโค้ด ${m} แล้ว`,"success")}break}case"manage-favorites":{Q();const m=t.dataset.type,p=t.dataset.subType||null;if(m==="deco"&&!p){q("กรุณาเลือกประเภทของตกแต่งก่อน","warning");return}We(m,p);break}case"del-fav":{const m=t.closest(".fav-manager-item"),{type:p,subType:_,code:g}=m.dataset;n("ลบรายการโปรด",`ยืนยันการลบ "${g}"?`,()=>{fe(p,g,_)&&(G=!0,m.remove(),q("ลบรายการโปรดแล้ว","success"),document.querySelector(".fav-manager-item")||re(p,_))});break}case"edit-fav":{const m=t.closest(".fav-manager-item"),{type:p,subType:_,code:g,price:S}=m.dataset,f=await Ue({code:g,price:S});if(f){if(!f.newCode){q("รหัสห้ามว่าง","error");return}Fe(p,g,f.newCode,f.newPrice,_)?(G=!0,q("อัปเดตรายการแล้ว","success"),re(p,_)):q("อัปเดตล้มเหลว รหัสอาจซ้ำซ้อน","error")}break}case"add-new-fav-form":{const m=document.getElementById("favManagerFooter"),p=document.getElementById("favManagerBody");if(document.getElementById("newFavForm"))return;const _=document.getElementById("favManagerNewFormTpl").innerHTML;p.insertAdjacentHTML("beforeend",_),m.style.display="none",(c=p.querySelector('[name="fav_code_new"]'))==null||c.focus();break}case"cancel-new-fav":{(l=document.getElementById("newFavForm"))==null||l.remove(),document.getElementById("favManagerFooter").style.display="block";break}case"save-new-fav":{const m=document.getElementById("newFavForm"),p=m.querySelector('[name="fav_code_new"]'),_=m.querySelector('[name="fav_price_new"]'),g=p.value.trim(),S=w(_.value),{type:f,subType:y}=document.getElementById("favManagerTitle").dataset;if(!g){q("กรุณากรอกรหัส","error");return}if(S<=0){q("กรุณากรอกราคา","error");return}pe(f,g,S,y)?(G=!0,q("เพิ่มรายการใหม่สำเร็จ","success"),re(f,y),document.getElementById("favManagerFooter").style.display="block"):q("เพิ่มล้มเหลว รหัสอาจซ้ำ","error");break}}};function tt(){x=!x,ge()}function rt(){const e=document.querySelector(d.setTpl);if(!e)return;const t=e.content.querySelector('select[name="set_price_per_m"]'),o=e.content.querySelector('select[name="sheer_price_per_m"]'),r=n=>{let a='<option value="" hidden>เลือกราคา</option>';return n.forEach(s=>{a+=`<option value="${s}">${s.toLocaleString("th-TH")}</option>`}),a};t&&(t.innerHTML=r(ne.fabric)),o&&(o.innerHTML=r(ne.sheer))}function ot(){rt(),ve();const e=document.querySelector(d.orderForm),t=document.querySelector(d.fileImporter),o=document.querySelector(d.menuDropdown),r=document.querySelector(d.quickNavDropdown),n=document.querySelector("#pageBreakBuffer"),a=document.querySelector("#pageBreakBufferValue");n&&a&&n.addEventListener("input",()=>{a.textContent=n.value}),e.addEventListener("input",Je),e.addEventListener("change",Qe),e.addEventListener("click",et),e.addEventListener("blur",Ke,!0),e.addEventListener("focusin",Xe);const s=c=>{const l=c.target.closest(d.room);l&&Se(l)};e.addEventListener("click",s),e.addEventListener("focusin",s),document.body.addEventListener("click",c=>{c.target.closest("summary")&&setTimeout(W,50)}),document.querySelector(d.lockBtn).addEventListener("click",tt),document.querySelector(d.toggleAllRoomsBtn).addEventListener("click",Oe),document.querySelector(d.quickNavBtn).addEventListener("click",c=>{c.stopPropagation(),o.classList.remove("show"),r.classList.toggle("show")}),document.querySelector(d.quickNavRoomList).addEventListener("click",c=>{const l=c.target.closest("a[data-jump-to]");if(l){c.preventDefault();const u=l.dataset.jumpTo,h=document.getElementById(u);h&&(document.body.classList.add("disable-animations"),h.open=!0,h.scrollIntoView({behavior:"auto",block:"start"}),h.classList.add("scrolling-jump"),setTimeout(()=>{h.classList.remove("scrolling-jump"),document.body.classList.remove("disable-animations"),W()},1e3)),r.classList.remove("show")}});const i=document.querySelector("#addRoomQuickNavBtn");if(i){const c=Ce(oe,700);i.addEventListener("click",l=>{l.stopPropagation(),c(),r.classList.remove("show")})}document.querySelector(d.menuBtn).addEventListener("click",c=>{c.stopPropagation(),r.classList.remove("show"),o.classList.toggle("show")}),document.querySelector("#themeToggleBtn").addEventListener("click",c=>{c.preventDefault(),Ae()}),document.querySelector("#overviewBtn").addEventListener("click",async c=>{c.preventDefault(),o.classList.remove("show");const l=H(),u=Me(l),h=document.querySelector("#overviewModalBody");h&&(h.innerHTML=u,U("#overviewModal",()=>{}))}),document.querySelector(d.exportPdfBtn).addEventListener("click",async c=>{c.preventDefault(),o.classList.remove("show");const l=await De();if(!l)return;const u=H(),h=l.vatOption==="include"?C.baseVatRate:0,m=Ne(u,{vatRate:h,pageBreakBuffer:l.pageBreakBuffer});if(!m){q("ไม่มีรายการที่มีราคาสำหรับสร้างเอกสาร","warning");return}l.exportMethod==="html"?Ze(m):ze(m,l.exportMethod)}),document.querySelector(d.importBtn).addEventListener("click",c=>{c.preventDefault(),o.classList.remove("show"),t.click()}),t.addEventListener("change",c=>{var h;const l=(h=c.target.files)==null?void 0:h[0];if(!l)return;const u=new FileReader;u.onload=m=>{try{const p=JSON.parse(m.target.result);me(p)}catch{q("ไฟล์ JSON ไม่ถูกต้อง","error")}},u.readAsText(l),c.target.value=null}),document.querySelector(d.exportBtn).addEventListener("click",c=>{c.preventDefault(),o.classList.remove("show");try{const l=H(),u=JSON.stringify(l,null,4),h=new Blob([u],{type:"application/json"}),m=URL.createObjectURL(h),p=document.createElement("a"),_=new Date,g=`${_.getFullYear()}${(_.getMonth()+1).toString().padStart(2,"0")}${_.getDate().toString().padStart(2,"0")}`,S=(l.customer_name||"data").trim().replace(/\s+/g,"-");p.href=m,p.download=`MTR-${S}-${g}.json`,p.click(),URL.revokeObjectURL(m),q("Export ข้อมูลสำเร็จ","success")}catch{q("Export ข้อมูลล้มเหลว","error")}}),document.querySelector(d.submitBtn).addEventListener("click",async c=>{if(c.preventDefault(),o.classList.remove("show"),await te("ส่งข้อมูล","ยืนยันการส่งข้อมูลการประเมินราคา?")){const l=H();if(!l.customer_name&&!l.customer_phone){q("กรุณาระบุชื่อหรือเบอร์โทรลูกค้า","warning");return}q("กำลังส่งข้อมูล...","default");try{const u=await fetch(Te,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)});u.ok?q("ส่งข้อมูลสำเร็จ!","success"):q(`ส่งข้อมูลล้มเหลว: ${u.status}`,"error")}catch{q("เกิดข้อผิดพลาดในการเชื่อมต่อ","error")}}}),document.querySelector(d.copyTextBtn).addEventListener("click",async c=>{c.preventDefault(),o.classList.remove("show");const l=document.querySelector(d.copyOptionsModal);if(l.querySelector('input[name="copy_option"][value="customer"]').checked=!0,await U(d.copyOptionsModal)){const u=l.querySelector('input[name="copy_option"]:checked').value,h=Be(H(),u);try{await navigator.clipboard.writeText(h),q("คัดลอกสรุปสำเร็จ!","success")}catch{q("คัดลอกล้มเหลว","error")}}}),document.querySelector(d.clearItemsBtn).addEventListener("click",async c=>{c.preventDefault(),o.classList.remove("show"),await te("ล้างทุกรายการ","คุณแน่ใจหรือไม่ว่าต้องการลบรายการสินค้าทั้งหมด (ข้อมูลลูกค้าและห้องจะยังคงอยู่)?")&&(document.querySelectorAll(d.room).forEach(l=>{l.querySelector(d.setsContainer).innerHTML="",l.querySelector(d.decorationsContainer).innerHTML="",l.querySelector(d.wallpapersContainer).innerHTML=""}),P(),F(),q("ล้างทุกรายการแล้ว","success"))}),document.querySelector(d.clearAllBtn).addEventListener("click",async c=>{c.preventDefault(),o.classList.remove("show"),await te("ลบข้อมูลทั้งหมด","คุณแน่ใจหรือไม่ว่าต้องการลบข้อมูลทั้งหมดในฟอร์มนี้? การกระทำนี้ไม่สามารถย้อนกลับได้")&&(localStorage.removeItem(ee),localStorage.removeItem("marnthara.theme"),Re(),window.location.reload())}),window.addEventListener("click",c=>{c.target.closest(".menu-container")||(o.classList.remove("show"),r.classList.remove("show")),c.target.closest(".room-options-container")||(document.querySelectorAll(".room-options-menu.show").forEach(l=>l.classList.remove("show")),document.querySelectorAll(".card.overflow-visible").forEach(l=>l.classList.remove("overflow-visible"))),c.target.closest(".form-group-with-favorites")||Q()});try{const c=localStorage.getItem(ee);if(c)me(JSON.parse(c));else{oe();const l=document.querySelector("#customerDetailsCard");l&&(l.open=!0)}}catch{localStorage.removeItem(ee),oe()}P(),ge(),W(),V()}document.addEventListener("DOMContentLoaded",ot);
