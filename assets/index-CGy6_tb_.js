(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&r(c)}).observe(document,{childList:!0,subtree:!0});function o(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(n){if(n.ep)return;n.ep=!0;const s=o(n);fetch(n.href,s)}})();const Me="input-ui/5.6.0-final",Ne="https://your-make-webhook-url.com/your-unique-path",ue="marnthara.input.v4",Pe=500,k={name:"ม่านธารา ผ้าม่านและของตกแต่ง",address:"65/8 หมู่ 2 ต.ท่าศาลา อ.เมือง จ.ลพบุรี 15000",phone:"092-985-9395, 082-552-5595",taxId:"1234567890123",logoUrl:"https://i.imgur.com/l7y85nI.png",baseVatRate:.07,pdf:{paymentTerms:"ชำระมัดจำ 50%",priceValidity:"30 วัน",notes:["ราคานี้รวมค่าติดตั้งแล้ว","ชำระมัดจำ 50% เพื่อยืนยันการสั่งผลิตสินค้า","ใบเสนอราคานี้มีอายุ 30 วัน นับจากวันที่เสนอราคา"]}},Ae=1.19599,fe={ROLL_WIDTH_M:.53,ROLL_LENGTH_M:10,STRIPS_PER_ROLL_UNDER_2_5M:3},me={fabric:[1e3,1100,1200,1300,1400,1500,1600,1700,1800,1900,2e3,2100,2200],sheer:[1e3,1100,1200,1300,1400,1500],style_surcharge:{ลอน:200,ตาไก่:0,จีบ:0},height:[{threshold:3.2,add_per_m:300},{threshold:2.8,add_per_m:200},{threshold:2.5,add_per_m:100}]},p={orderForm:"#orderForm",roomsContainer:"#rooms",setTpl:"#setTpl",clearAllBtn:"#clearAllBtn",lockBtn:"#lockBtn",grandTotal:"#grandTotal",setCount:"#setCount",modal:"#confirmationModal",modalTitle:"#modalTitle",modalBody:"#modalBody",room:"[data-room]",set:"[data-set]",decoItem:"[data-deco-item]",wallpaperItem:"[data-wallpaper-item]",allItemsContainer:"[data-all-items]",wallsContainer:"[data-walls-container]",sheerWrap:"[data-sheer-wrap]",roomNameInput:'input[name="room_name"]',toastContainer:"#toast-container",copyTextBtn:"#copyTextBtn",copyOptionsModal:"#copyOptionsModal",menuBtn:"#menuBtn",menuDropdown:"#menuDropdown",importBtn:"#importBtn",exportBtn:"#exportBtn",fileImporter:"#fileImporter",submitBtn:"#submitBtn",clearItemsBtn:"#clearItemsBtn",exportPdfBtn:"#exportPdfBtn",exportOptionsModal:"#exportOptionsModal",printableContent:"#printable-content",quickNavBtn:"#quickNavBtn",quickNavDropdown:"#quickNavDropdown",quickNavRoomList:"#quickNavRoomList",toggleAllRoomsBtn:"#toggleAllRoomsBtn"},g=t=>{typeof t=="string"&&(t=t.replace(/,/g,""));const e=parseFloat(t);return Number.isFinite(e)?e:0},Y=t=>{const e=g(t);return e>0?e.toFixed(2):""},H=(t,e=2,o=!1)=>Number.isFinite(t)?t.toLocaleString("en-US",{minimumFractionDigits:o?2:e,maximumFractionDigits:o?2:e}):"0",$=(t,e=0)=>Number.isFinite(t)?t.toLocaleString("th-TH",{minimumFractionDigits:e,maximumFractionDigits:e}):"0",Fe=(t,e=150)=>{let o;return(...r)=>{clearTimeout(o),o=setTimeout(()=>t(...r),e)}},Re=(t,e=700)=>{let o=!1;return(...r)=>{if(!o){o=!0;try{return t(...r)}finally{setTimeout(()=>{o=!1},e)}}}},q=t=>typeof t!="string"?"":t.replace(/[&<>"']/g,function(e){switch(e){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";default:return"&#039;"}}),Le=t=>typeof t!="string"?"":t.replace(/[\\/?%*:|"<>\x00-\x1f]/g,"").trim()||"file";function Oe(t){let e=g(t);if(isNaN(e))return"ข้อมูลตัวเลขไม่ถูกต้อง";if(e===0)return"ศูนย์บาทถ้วน";const o=["","หนึ่ง","สอง","สาม","สี่","ห้า","หก","เจ็ด","แปด","เก้า"],r=["","สิบ","ร้อย","พัน","หมื่น","แสน","ล้าน"];let n=Math.floor(e),s=Math.round((e-n)*100);const c=l=>{if(l===0)return"";let a="";const m=String(l);for(let u=0;u<m.length;u++){const h=m[u];m.length-1;const v=m.length-u-1;h!=="0"&&(v===1&&h==="1"?a+=r[v]:v===1&&h==="2"?a+="ยี่"+r[v]:v===0&&h==="1"&&m.length>1?a+="เอ็ด":a+=o[parseInt(h)]+r[v])}return a};let i="";if(n>0){const l=Math.floor(n/1e6),a=n%1e6;l>0&&(i+=c(l)+"ล้าน"),i+=c(a),i+="บาท"}let d="";return s>0?d=c(s)+"สตางค์":i+="ถ้วน",(i+d).trim()}const _e="marnthara.favorites.v3";function U(){try{const t=localStorage.getItem(_e),e={fabric:[],sheer:[],deco:{},wallpaper:[]};return t?{...e,...JSON.parse(t)}:e}catch(t){return console.error("Failed to parse favorites from localStorage",t),{fabric:[],sheer:[],deco:{},wallpaper:[]}}}function ae(t){try{localStorage.setItem(_e,JSON.stringify(t))}catch(e){console.error("Failed to save favorites to localStorage",e)}}function He(t){if(!t||typeof t!="object")return console.error("Invalid favorites data for import."),!1;const o={...{fabric:[],sheer:[],deco:{},wallpaper:[]},...t};return ae(o),!0}function se(t,e,o){return e==="deco"?o?(t.deco[o]||(t.deco[o]=[]),t.deco[o]):null:(t[e]||(t[e]=[]),t[e])}function We(t,e,o,r=null){const n=U(),s=se(n,t,r);if(!s)return!1;const c=s.find(i=>i.code===e);return c?c.price=o:s.push({code:e,price:o}),s.sort((i,d)=>i.code.localeCompare(d.code)),ae(n),!0}function je(t,e,o,r=null){const n=U(),s=se(n,t,r);return!s||s.some(c=>c.code===e)?!1:(s.push({code:e,price:o}),s.sort((c,i)=>c.code.localeCompare(i.code)),ae(n),!0)}function De(t,e,o,r,n=null){const s=U(),c=se(s,t,n);if(!c||e!==o&&c.some(d=>d.code===o))return!1;const i=c.find(d=>d.code===e);return i?(i.code=o,i.price=r,c.sort((d,l)=>d.code.localeCompare(l.code)),ae(s),!0):!1}function Te(t,e,o=null){const r=U(),n=se(r,t,o);if(!n)return!1;const s=n.findIndex(c=>c.code===e);return s>-1?(n.splice(s,1),ae(r),!0):!1}function ge(t,e,o=null){if(!t||!e)return;const r=U(),n=e.trim(),s=se(r,t,o);return s==null?void 0:s.find(c=>c.code===n)}function Ue(t,e,o,r=null){const n=ge(t,e,r);return n&&n.price===o?(Te(t,e,r),!1):(We(t,e,o,r),!0)}function Ve(){localStorage.removeItem(_e),console.log("All favorites have been cleared.")}function Q(){var o,r,n,s;const t=U(),e={app_version:Me,customer_name:((o=document.querySelector('[name="customer_name"]'))==null?void 0:o.value)||"",customer_phone:((r=document.querySelector('[name="customer_phone"]'))==null?void 0:r.value)||"",customer_address:((n=document.querySelector('[name="customer_address"]'))==null?void 0:n.value)||"",customer_card_open:(s=document.querySelector("#customerDetailsCard"))==null?void 0:s.open,rooms:[],favorites:t};return document.querySelectorAll(p.room).forEach(c=>{var d,l;const i={id:c.id,room_name:((d=c.querySelector(p.roomNameInput))==null?void 0:d.value)||"",is_suspended:c.classList.contains("is-suspended"),is_open:c.open,items:[]};(l=c.querySelector(p.allItemsContainer))==null||l.childNodes.forEach(a=>{var m,u,h,v,w,y,S,f,x,O,T,L,b,N,A,F,E,V,j,J,B,we;a.nodeType===1&&(a.matches(p.set)?i.items.push({type:"set",width_m:g((m=a.querySelector('input[name="width_m"]'))==null?void 0:m.value),height_m:g((u=a.querySelector('input[name="height_m"]'))==null?void 0:u.value),style:((h=a.querySelector('select[name="set_style"]'))==null?void 0:h.value)||"",fabric_variant:((v=a.querySelector('select[name="fabric_variant"]'))==null?void 0:v.value)||"",price_per_m_raw:g((w=a.querySelector('select[name="set_price_per_m"]'))==null?void 0:w.value),sheer_price_per_m:g((y=a.querySelector('select[name="sheer_price_per_m"]'))==null?void 0:y.value),fabric_code:((S=a.querySelector('input[name="fabric_code"]'))==null?void 0:S.value)||"",sheer_fabric_code:((f=a.querySelector('input[name="sheer_fabric_code"]'))==null?void 0:f.value)||"",opening_style:((x=a.querySelector('select[name="opening_style"]'))==null?void 0:x.value)||"",track_color:((O=a.querySelector('select[name="track_color"]'))==null?void 0:O.value)||"",notes:((T=a.querySelector('input[name="notes"]'))==null?void 0:T.value)||"",is_suspended:a.classList.contains("is-suspended")}):a.matches(p.decoItem)?i.items.push({type:"deco",deco_type:((L=a.querySelector('[name="deco_type"]'))==null?void 0:L.value)||"",width_m:g((b=a.querySelector('[name="deco_width_m"]'))==null?void 0:b.value),height_m:g((N=a.querySelector('[name="deco_height_m"]'))==null?void 0:N.value),price_sqyd:g((A=a.querySelector('[name="deco_price_sqyd"]'))==null?void 0:A.value),deco_code:((F=a.querySelector('[name="deco_code"]'))==null?void 0:F.value)||"",notes:((E=a.querySelector('[name="deco_notes"]'))==null?void 0:E.value)||"",is_suspended:a.classList.contains("is-suspended")}):a.matches(p.wallpaperItem)&&i.items.push({type:"wallpaper",height_m:g((V=a.querySelector('[name="wallpaper_height_m"]'))==null?void 0:V.value),wallpaper_code:((j=a.querySelector('[name="wallpaper_code"]'))==null?void 0:j.value)||"",price_per_roll:g((J=a.querySelector('[name="wallpaper_price_roll"]'))==null?void 0:J.value),install_cost_per_roll:g((B=a.querySelector('[name="wallpaper_install_cost"]'))==null?void 0:B.value),notes:((we=a.querySelector('[name="wallpaper_notes"]'))==null?void 0:we.value)||"",widths:Array.from(a.querySelectorAll('[name="wall_width_m"]')).map(Be=>g(Be.value)),is_suspended:a.classList.contains("is-suspended")}))}),e.rooms.push(i)}),e}function M(){localStorage.setItem(ue,JSON.stringify(Q()))}const I={stylePlus:t=>me.style_surcharge[t]??0,heightPlus:t=>{const e=[...me.height].sort((o,r)=>r.threshold-o.threshold);for(const o of e)if(t>o.threshold)return o.add_per_m;return 0},fabricYardage:(t,e)=>{const o=g(e);return o<=0||!t?0:t==="ตาไก่"||t==="จีบ"?(o*2+.6)/.9:t==="ลอน"?(o*2.6+.6)/.9:0},wallpaperRolls:(t,e)=>{const o=g(t),r=g(e);if(o<=0||r<=0)return 0;const n=r>2.5?Math.floor(fe.ROLL_LENGTH_M/r):fe.STRIPS_PER_ROLL_UNDER_2_5M;if(n<=0)return 0;const s=Math.ceil(o/fe.ROLL_WIDTH_M);return Math.ceil(s/n)},calculateSetPrice:function(t){var c,i;if(!t||t.is_suspended||g(t.width_m)<=0)return{total:0,opaque:0,sheer:0};const e=this.stylePlus(t.style),o=this.heightPlus(g(t.height_m)),r=g(t.width_m),n=(c=t.fabric_variant)!=null&&c.includes("ทึบ")&&g(t.price_per_m_raw)>0?(g(t.price_per_m_raw)+e+o)*r:0,s=(i=t.fabric_variant)!=null&&i.includes("โปร่ง")&&g(t.sheer_price_per_m)>0?(g(t.sheer_price_per_m)+e+o)*r:0;return{total:Math.round(n+s),opaque:Math.round(n),sheer:Math.round(s)}},calculateDecoPrice:function(t){if(!t||t.is_suspended||g(t.width_m)<=0)return{total:0,sqm:0,sqyd:0};const e=g(t.width_m)*g(t.height_m),o=e*Ae,r=o*g(t.price_sqyd);return{total:Math.round(r),sqm:e,sqyd:o}},calculateWallpaperPrice:function(t){var c;if(!t||t.is_suspended)return{total:0,material:0,install:0,rolls:0,sqm:0};const e=((c=t.widths)==null?void 0:c.reduce((i,d)=>i+g(d),0))||0;if(e<=0)return{total:0,material:0,install:0,rolls:0,sqm:0};const o=g(t.height_m),r=this.wallpaperRolls(e,o),n=r*g(t.price_per_roll),s=r*g(t.install_cost_per_roll??300);return{total:Math.round(n+s),material:Math.round(n),install:Math.round(s),rolls:r,sqm:e*o}}};function Ye(t){return t.rooms.reduce((e,o)=>{var n;if(o.is_suspended)return e;const r=((n=o.items)==null?void 0:n.reduce((s,c)=>{if(c.is_suspended)return s;switch(c.type){case"set":return s+I.calculateSetPrice(c).total;case"deco":return s+I.calculateDecoPrice(c).total;case"wallpaper":return s+I.calculateWallpaperPrice(c).total;default:return s}},0))||0;return e+r},0)}function Ge(t,e){const o=Ye(t);let r=`สรุปข้อมูล (${new Date().toLocaleDateString("th-TH",{day:"numeric",month:"numeric",year:"numeric"})})
`;if(r+=`ลูกค้า: ${t.customer_name||"-"}
`,(e==="customer"||e==="owner")&&(r+=`เบอร์โทร: ${t.customer_phone||"-"}
`,r+=`ที่อยู่: ${t.customer_address||"-"}
`),r+=`------------------------------
`,e==="customer")return r+=`
สรุปรายการ
`,t.rooms.forEach(n=>{if(n.is_suspended||!n.items)return;const s=n.items.filter(i=>i.is_suspended?!1:i.type==="wallpaper"?(i.widths||[]).reduce((d,l)=>d+l,0)>0:i.width_m>0);if(s.length===0)return;r+=`
*ห้อง: ${n.room_name||"ไม่ระบุ"}*
`;let c=0;s.forEach(i=>{switch(c++,i.type){case"set":r+=` ${c}) ผ้าม่าน ${i.style} (${i.fabric_variant})
`;break;case"deco":r+=` ${c}) ${i.deco_type||"ของตกแต่ง"}
`;break;case"wallpaper":r+=` ${c}) วอลเปเปอร์
`;break}})}),r+=`------------------------------
`,r+=`
สรุปยอดรวม: ${$(o)} บาท
`,r+=`
ขอบคุณที่ใช้บริการ
${k.name}
โทร: ${k.phone}`,r;if(e==="purchase_order"||e==="owner"){const n={opaqueFabrics:[],sheerFabrics:[],decorations:{},wallpapers:[],allSets:[]};t.rooms.forEach(l=>{l.is_suspended||!l.items||l.items.forEach(a=>{if(!a.is_suspended)switch(a.type){case"set":if(a.width_m<=0)return;n.allSets.push(a),a.fabric_variant.includes("ทึบ")&&n.opaqueFabrics.push({code:a.fabric_code||"??",yards:I.fabricYardage(a.style,a.width_m)}),a.fabric_variant.includes("โปร่ง")&&n.sheerFabrics.push({code:a.sheer_fabric_code||"??",yards:I.fabricYardage(a.style,a.width_m)});break;case"deco":if(!a.deco_type||a.width_m<=0)return;const m=a.deco_type;n.decorations[m]||(n.decorations[m]=[]),n.decorations[m].push({code:a.deco_code||"xxx",width:a.width_m,height:a.height_m});break;case"wallpaper":const u=(a.widths||[]).reduce((h,v)=>h+v,0);if(u>0){const h=I.wallpaperRolls(u,a.height_m);h>0&&n.wallpapers.push({code:a.wallpaper_code||"xxx",rolls:h})}break}})}),r+=`📋 *แจกแจงรายการสั่งซื้อ (ผ้า)*
`,r+=`------------------------------
`,n.opaqueFabrics.length>0&&n.opaqueFabrics.forEach(l=>{r+=`- ผ้าทึบ (Curtain Fabric)
`,r+=`  รหัส: #${l.code||"??"}
`,r+=`  จำนวน: ${l.yards.toFixed(2)} หลา

`}),n.sheerFabrics.length>0&&n.sheerFabrics.forEach(l=>{r+=`- ผ้าโปร่ง (Sheer Fabric)
`,r+=`  รหัส: #${l.code||"??"}
`,r+=`  จำนวน: ${l.yards.toFixed(2)} หลา

`});const s={};if([...n.opaqueFabrics,...n.sheerFabrics].forEach(l=>{s[l.code]=(s[l.code]||0)+l.yards}),Object.keys(s).length>0){r+=`------------------------------
`,r+=`📊 *สรุปยอดรวมผ้า (ตามรหัส)*
`,r+=`------------------------------
`;for(const[l,a]of Object.entries(s))r+=`  - รหัส #${l}: รวมทั้งหมด ${a.toFixed(2)} หลา
`;r+=`
`}if(r+=`------------------------------
`,r+=`📋 *สำหรับสั่งซื้อ ราง*
`,r+=`------------------------------

`,n.allSets.length>0){let l=1;n.allSets.forEach(a=>{r+=`(${l++}) รางม่าน: ${a.style}, สี: ${a.track_color}
`,a.fabric_variant.includes("ทึบ")&&(r+=`  - รางทึบ: ${Number(a.width_m).toFixed(2)} ม. (1 เส้น)
`),a.fabric_variant.includes("โปร่ง")&&(r+=`  - รางโปร่ง: ${Number(a.width_m).toFixed(2)} ม. (1 เส้น)
`),a.fabric_variant==="ทึบ&โปร่ง"&&(r+=`  (❗️ต้องใช้ขาสองชั้น)
`),r+=`
`})}const c={มู่ลี่ไม้:"Wooden Blind",ม่านม้วน:"Roller Blind",ม่านปรับแสง:"Vertical Blind",ฉากกั้นห้อง:"Partition",มุ้งจีบ:"Pleated Insect Screen",มู่ลี่อลูมิเนียม:"Aluminium Blind"},i=n.decorations;Object.keys(i).length>0&&Object.entries(i).forEach(([l,a])=>{const m=c[l]?` (${c[l]})`:"";r+=`------------------------------
`,r+=`📋 *สำหรับสั่งซื้อ ${l}${m}*
`,r+=`------------------------------

`,a.forEach(u=>{r+=`รหัส: #${u.code||"xxx"}
`,r+=`ขนาด: ${u.width.toFixed(2)} x ${u.height.toFixed(2)} m.
`,r+=`จำนวน: 1 ชุด

`})}),r+=`------------------------------
`,r+=`📋 *แจกแจงรายการสั่งซื้อ (Wallpaper)*
`,r+=`------------------------------

`,n.wallpapers.length>0&&n.wallpapers.forEach(l=>{r+=`- วอลเปเปอร์ -
`,r+=`  รหัส: #${l.code||"xxx"}
`,r+=`  จำนวน: ${l.rolls} ม้วน

`});const d={};if(n.wallpapers.forEach(l=>{d[l.code]=(d[l.code]||0)+l.rolls}),Object.keys(d).length>0){r+=`------------------------------
`,r+=`📊 *สรุปยอดรวมวอลเปเปอร์ (ตามรหัส)*
`,r+=`------------------------------
`;for(const[l,a]of Object.entries(d))r+=`  - รหัส #${l}: รวมทั้งหมด ${a} ม้วน
`;r+=`
`}if(r+=`------------------------------
`,e==="purchase_order")return r}return(e==="seamstress"||e==="owner")&&(r+=`
🧵 *รายละเอียดสำหรับช่าง*
`,t.rooms.forEach(n=>{if(n.is_suspended||!n.items)return;const s=n.items.filter(i=>i.type==="set"&&!i.is_suspended&&i.width_m>0);if(s.length===0)return;r+=`
*ห้อง: ${n.room_name||"ไม่ระบุ"}*
`;let c=1;s.forEach(i=>{r+=`${c++}) *ผ้าม่าน ${i.style} ${i.fabric_variant}*
`,r+=`  กว้าง ${Number(i.width_m).toFixed(2)} x สูง ${Number(i.height_m).toFixed(2)} ม.
`,r+=`  รูปแบบเปิด: ${i.opening_style}
`,i.fabric_variant.includes("ทึบ")&&(r+=`  ผ้าทึบ: รหัส ${i.fabric_code||"-"}
`),i.fabric_variant.includes("โปร่ง")&&(r+=`  ผ้าโปร่ง: รหัส ${i.sheer_fabric_code||"-"}
`)})}),r+=`------------------------------
`,e==="seamstress")||e==="owner"&&(r+=`
💰 *สรุปยอดรวม: ${$(o)} บาท*
`),r}function Je(t){if(!t.rooms||t.rooms.length===0)return'<p class="empty-summary">ไม่มีข้อมูลสำหรับแสดงผล</p>';const e={};let o=0,r="";if(t.rooms.forEach(c=>{if(c.is_suspended)return;const i={};c.items&&Array.isArray(c.items)&&c.items.forEach(l=>{if(!l.is_suspended)switch(l.type){case"set":if(I.calculateSetPrice(l).total>0){const a="ผ้าม่าน";i[a]=(i[a]||0)+1,e[a]=(e[a]||0)+1}break;case"deco":if(I.calculateDecoPrice(l).total>0){const a=l.deco_type||"ของตกแต่ง (ไม่ระบุประเภท)";i[a]=(i[a]||0)+1,e[a]=(e[a]||0)+1}break;case"wallpaper":if(I.calculateWallpaperPrice(l).total>0){const a="วอลเปเปอร์";i[a]=(i[a]||0)+1,e[a]=(e[a]||0)+1}break}});const d=Object.entries(i);d.length>0&&(r+=`<tr class="room-header-row"><td colspan="3">${q(c.room_name)||"ไม่ระบุชื่อห้อง"}</td></tr>`,d.forEach(([l,a])=>{r+=`<tr><td></td><td class="item-type-cell">${q(l)}</td><td class="pdf-text-center">${a}</td></tr>`,o+=a}))}),o===0)return'<p class="empty-summary">ไม่มีรายการที่มีราคาสำหรับแสดงผล</p>';let s=`<div id="detailed-material-summary">
        <h4><i class="ph ph-stack"></i> ยอดรวมทุกประเภท</h4>
        <ul>${Object.entries(e).map(([c,i])=>`<li><b>${q(c)}</b> <span>${i} รายการ</span></li>`).join("")}</ul>
    </div>`;return s+=`<table>
        <thead><tr><th>ห้อง</th><th>รายการ</th><th class="pdf-text-center">จำนวน</th></tr></thead>
        <tbody>${r}</tbody>
    </table>`,s}function Qe(t,e){const{vatRate:o,pageBreakBuffer:r=3}=e,n=[];t.rooms.forEach(T=>{if(T.is_suspended||!T.items)return;const L=[];T.items.forEach(b=>{if(!b.is_suspended)switch(b.type){case"set":const N=I.calculateSetPrice(b).total;if(N>0){let E=`ผ้าม่าน ${q(b.style)} (${q(b.fabric_variant)}) <br><small>ขนาด ${b.width_m.toFixed(2)} x ${b.height_m.toFixed(2)} ม.${b.notes?` - ${q(b.notes)}`:""}</small>`;L.push({description:E,total:N,units:E.includes("<br>")?1.5:1})}break;case"deco":const A=I.calculateDecoPrice(b).total;if(A>0){let E=`${q(b.deco_type)||"งานตกแต่ง"} <br><small>รหัส: ${q(b.deco_code)||"-"}, ขนาด ${b.width_m.toFixed(2)} x ${b.height_m.toFixed(2)} ม.</small>`;L.push({description:E,total:A,units:E.includes("<br>")?1.5:1})}break;case"wallpaper":const F=I.calculateWallpaperPrice(b).total;if(F>0){const E=(b.widths||[]).reduce((J,B)=>J+B,0),V=I.wallpaperRolls(E,b.height_m);let j=`วอลเปเปอร์ <br><small>รหัส: ${q(b.wallpaper_code)||"-"}, สูง ${b.height_m.toFixed(2)} ม. (ใช้ ${V} ม้วน)</small>`;L.push({description:j,total:F,units:j.includes("<br>")?1.5:1})}break}}),L.length>0&&(n.push({isRoomHeader:!0,roomName:q(T.room_name)||"ไม่ระบุชื่อห้อง",units:1.2}),n.push(...L))});const s=n.reduce((T,L)=>T+(L.total||0),0);if(s===0)return null;const c=s*o,i=s+c,d=17,l=23,a=[];let m=[],u=0;n.forEach((T,L)=>{const b=a.length===0?d:l,N=u+T.units>b;let A=!1;if(!N&&L<n.length-1){const F=b-(u+T.units);F>0&&F<r&&(A=!0)}(N||A)&&m.length>0&&(a.push(m),m=[],u=0),m.push(T),u+=T.units}),m.length>0&&a.push(m);const h=new Date,v=h.toLocaleDateString("th-TH",{year:"numeric",month:"long",day:"numeric"}),w=`QT-${h.getFullYear()}${(h.getMonth()+1).toString().padStart(2,"0")}${h.getDate().toString().padStart(2,"0")}`;let y="",S=0,f=1;a.forEach((T,L)=>{const b=L===0,N=L===a.length-1,A=`
            <div class="pdf-page-header">
                <div class="pdf-header">
                    <div class="pdf-shop-info">
                        ${`<img src="${k.logoUrl}" alt="Logo" class="pdf-logo">`}
                        <div class="pdf-shop-address">
                            <strong>${q(k.name)}</strong><br>
                            ${q(k.address).replace(/\n/g,"<br>")}<br>
                            โทร: ${q(k.phone)} | เลขประจำตัวผู้เสียภาษี: ${q(k.taxId)}
                        </div>
                    </div>
                    <div class="pdf-quote-details">
                        <div class="pdf-title-box"><h1>ใบเสนอราคา ${a.length>1?b?"":"(ต่อ)":""}</h1></div>
                        <table class="pdf-quote-meta">
                            <tr><td>เลขที่:</td><td>${w}</td></tr>
                            <tr><td>วันที่:</td><td>${v}</td></tr>
                        </table>
                    </div>
                </div>
                ${b?`
                <section class="pdf-customer-details">
                    <div class="pdf-customer-info">
                        <strong>ลูกค้า:</strong> ${q(t.customer_name)||""}<br>
                        <strong>ที่อยู่:</strong> ${q(t.customer_address).replace(/\n/g,"<br>")||""}<br>
                        <strong>โทร:</strong> ${q(t.customer_phone)||""}
                    </div>
                    <div class="pdf-customer-meta">
                        <strong>เงื่อนไขชำระเงิน:</strong> ${q(k.pdf.paymentTerms)}<br>
                        <strong>ยืนราคา:</strong> ${q(k.pdf.priceValidity)}
                    </div>
                </section>`:""}
            </div>`,F=`
            <div class="pdf-page-footer">
                <div class="pdf-footer-info">
                    <span>${q(k.name)} | โทร: ${q(k.phone)}</span>
                    <span>หน้า ${L+1} / ${a.length}</span>
                </div>
            </div>`;let E="";b||(E+=`<tr class="pdf-subtotal-row"><td colspan="4">ยอดยกมา (Brought Forward)</td><td class="pdf-text-right">${H(S,2,!0)}</td></tr>`),T.forEach(B=>{B.isRoomHeader?E+=`<tr class="pdf-room-header"><td colspan="5">ห้อง: ${B.roomName}</td></tr>`:(E+=`<tr><td class="pdf-text-center">${f++}</td><td>${B.description}</td><td class="pdf-text-center">1</td><td class="pdf-text-right">${H(B.total,2,!0)}</td><td class="pdf-text-right">${H(B.total,2,!0)}</td></tr>`,S+=B.total)});let V="";N||(V=`<tfoot><tr class="pdf-subtotal-row"><td colspan="4">ยอดยกไป (Carried Forward)</td><td class="pdf-text-right">${H(S,2,!0)}</td></tr></tfoot>`);let j="";k.pdf.notes&&k.pdf.notes.length>0&&(j=`
                <strong>หมายเหตุ:</strong>
                <ul>${k.pdf.notes.map(B=>`<li>${q(B)}</li>`).join("")}</ul>
            `);const J=N?`
            <div class="pdf-summary-wrapper">
                <section class="pdf-summary-section">
                    <div class="pdf-amount-in-words">
                        ${j}
                        <div class="pdf-amount-text">( ${Oe(i)} )</div>
                    </div>
                    <div class="pdf-totals-block">
                        <table>
                            <tr><td class="pdf-label">รวมเป็นเงิน</td><td class="pdf-amount">${H(s,2,!0)}</td></tr>
                            ${o>0?`<tr><td class="pdf-label">ภาษีมูลค่าเพิ่ม ${(o*100).toFixed(0)}%</td><td class="pdf-amount">${H(c,2,!0)}</td></tr>`:""}
                            <tr class="pdf-grand-total"><td class="pdf-label">ยอดรวมสุทธิ</td><td class="pdf-amount">${H(i,2,!0)}</td></tr>
                        </table>
                    </div>
                </section>
                <footer class="pdf-footer-section">
                    <div class="pdf-signature-box"><p>.................................................</p><p>ผู้เสนอราคา</p><p>(${q(k.name)})</p><p>วันที่: ${v}</p></div>
                    <div class="pdf-signature-box"><p>.................................................</p><p>ลูกค้า / ผู้มีอำนาจลงนาม</p><p>&nbsp;</p><p>วันที่: ......./......./............</p></div>
                </footer>
            </div>
        `:"";y+=`
            <div class="pdf-page">
                <div class="pdf-page-content">
                    ${A}
                    <div class="pdf-page-body">
                        <table class="pdf-items-table">
                            <thead><tr><th style="width:5%;">ลำดับ</th><th style="width:50%;">รายการ</th><th style="width:10%;">จำนวน</th><th style="width:17.5%;">ราคา/หน่วย</th><th style="width:17.5%;">รวม (บาท)</th></tr></thead>
                            <tbody>${E}</tbody>
                            ${V}
                        </table>
                        ${J}
                    </div>
                    ${F}
                </div>
            </div>`});const x=t.customer_name||"quote",O=Le(x);return{html:`<div id="quotation-template">${y}</div>`,fileName:`${w}_${O}`}}let P=!1,oe=null,de=null,te=!1,C=null,X=null,he=null;const ye="marnthara.theme";function $e(){const t=localStorage.getItem(ye),e=document.querySelector("#themeToggleBtn");if(!e)return;const o=e.querySelector("i"),r=e.querySelector("span");switch(document.body.classList.remove("dark-theme","neutral-theme"),t){case"dark":document.body.classList.add("dark-theme"),o&&(o.className="ph-fill ph-sun"),r&&(r.textContent=" สว่าง");break;case"neutral":document.body.classList.add("neutral-theme"),o&&(o.className="ph-fill ph-moon"),r&&(r.textContent=" มืด");break;default:o&&(o.className="ph-fill ph-palette"),r&&(r.textContent=" กลาง");break}}function Ke(){const t=localStorage.getItem(ye);let e;!t||t==="light"?e="neutral":t==="neutral"?e="dark":e="light",localStorage.setItem(ye,e),$e()}function _(t,e="default"){const o=document.querySelector(p.toastContainer);if(!o)return;const r={success:"ph-bold ph-check-circle",warning:"ph-bold ph-warning",error:"ph-bold ph-x-circle",default:"ph-bold ph-info"},n=document.createElement("div");n.className=`toast toast-${e}`,n.innerHTML=`<i class="${r[e]||r.default}"></i> ${t}`,o.appendChild(n),setTimeout(()=>n.classList.add("show"),10),setTimeout(()=>{n.classList.remove("show"),n.addEventListener("transitionend",()=>n.remove())},3e3)}function D(t,e){return new Promise(o=>{const r=document.querySelector(t);if(!r){o(null);return}const n=document.querySelector(".modal-wrapper.visible");n&&n.classList.add("is-underlay"),r.classList.add("visible");const s=r.querySelector('[id$="Confirm"]'),c=r.querySelector('[id$="Cancel"], [data-act="close-modal"]'),i=Array.from(r.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])')).filter(u=>!u.disabled&&u.offsetParent!==null),d=i[0],l=i[i.length-1];setTimeout(()=>d==null?void 0:d.focus(),50);const a=u=>{if(u.key==="Escape"&&!r.classList.contains("is-underlay")){m({cancelled:!0});return}if(u.key==="Tab"){if(i.length<=1){u.preventDefault();return}u.shiftKey?document.activeElement===d&&(l.focus(),u.preventDefault()):document.activeElement===l&&(d.focus(),u.preventDefault())}},m=u=>{r.classList.remove("visible"),document.removeEventListener("keydown",a),s&&(s.onclick=null),c&&(c.onclick=null),n&&n.classList.remove("is-underlay"),typeof u=="object"&&u.cancelled&&e&&e(),o(u)};s&&(s.onclick=()=>m(!0)),c&&(c.onclick=()=>{r.classList.contains("is-underlay")||m({cancelled:!0})}),document.addEventListener("keydown",a)})}async function re(t,e){const o=document.querySelector(p.modal);if(!o)return!0;const r=o.querySelector(p.modalTitle),n=o.querySelector(p.modalBody);return r&&(r.textContent=t),n&&(n.textContent=e),await D(p.modal)===!0}async function ze(){const t=document.querySelector(p.exportOptionsModal);if(!t)return null;const e=await D(p.exportOptionsModal);if(!e||e.cancelled)return null;const o=t.querySelector('input[name="vat_option"]:checked'),r=t.querySelector("#exportMethod"),n=t.querySelector("#pageBreakBuffer");return{vatOption:o?o.value:"include",exportMethod:r?r.value:"direct",pageBreakBuffer:n?parseInt(n.value,10):3}}function Z(t,e,o){t&&(t.classList.add("item-removing"),t.addEventListener("animationend",()=>{t.remove(),e&&_(e),o&&o(),le(),ce(),R(),M(),z()},{once:!0}))}function ce(){document.querySelectorAll(p.room).forEach(t=>{const e=t.querySelectorAll(".item-card:not(.is-suspended)"),o=e.length;e.forEach((r,n)=>{const s=r.querySelector("[data-item-title]");s&&(s.textContent=`${n+1}/${o}`)})})}function ke(){const t=document.querySelector(p.orderForm),e=document.querySelector(p.lockBtn);if(!t||!e)return;const o=t.querySelectorAll("input, select, textarea, button");t.classList.toggle("is-locked",P),e.classList.toggle("is-locked",P);const r=e.querySelector("i");r&&(r.className=P?"ph-bold ph-lock-key":"ph-bold ph-lock-key-open"),o.forEach(n=>{n.closest(".summary-footer")||n.closest(".main-header")||n.closest(".modal-wrapper")||n.dataset.act==="toggle-more-details"||(n.disabled=P)}),_(P?"ฟอร์มถูกล็อค":"ปลดล็อคฟอร์มแล้ว",P?"warning":"success")}function G(){const t=document.querySelectorAll(p.room);if(t.length===0)return;const e=[...t].some(r=>r.open),o=document.querySelector(p.toggleAllRoomsBtn);if(o){const r=o.querySelector("i"),n=o.querySelector("span");r&&(r.className="ph ph-rows"),n&&(n.textContent=e?"ย่อ":"ขยาย")}}function Xe(){const t=document.querySelectorAll(p.room),e=[...t].some(o=>o.open);t.forEach(o=>{o.open=!e}),setTimeout(()=>{G(),M()},50)}function le(){const t=document.querySelector(p.quickNavRoomList);if(!t)return;t.innerHTML="",document.querySelectorAll(p.room).forEach(o=>{const r=o.querySelector(p.roomNameInput),n=r?r.value:"ห้อง",s=document.createElement("a");s.href=`#${o.id}`,s.dataset.jumpTo=o.id,s.innerHTML=`<i class="ph ph-arrow-bend-left-up"></i> ${n||"ห้อง (ไม่มีชื่อ)"}`,t.appendChild(s)})}function Ie(t){const e=document.getElementById("quickNavBtnText");if(e)if(t){const o=t.querySelector('input[name="room_name"]');o&&(e.textContent=o.value||"...")}else e.textContent="ไปยังห้อง"}function z(){if(de&&de.disconnect(),!document.getElementById("quickNavBtnText"))return;const e={root:null,rootMargin:"-60px 0px -150px 0px",threshold:0},o=n=>{const s=n.filter(c=>c.isIntersecting).sort((c,i)=>c.target.getBoundingClientRect().top-i.target.getBoundingClientRect().top);s.length>0&&Ie(s[0].target)};de=new IntersectionObserver(o,e),document.querySelectorAll(p.room).forEach(n=>de.observe(n))}function xe(){document.querySelectorAll("[data-favorite-type]").forEach(W)}function ve(){const t=document.querySelector('[data-act="edit-selected-fav"]'),e=document.querySelector('[data-act="del-selected-fav"]');if(t&&e){const o=C!==null;t.disabled=!o,e.disabled=!o}}function pe(t,e=null){const o=document.getElementById("favManagerBody");if(!o)return;const r=U();let n=[];if(t==="deco"?n=r.deco[e]||[]:n=r[t]||[],o.innerHTML="",n.length===0)o.innerHTML='<p class="empty-state">ไม่มีรายการโปรดที่บันทึกไว้</p>';else{const s=document.getElementById("favManagerItemTpl").innerHTML;n.forEach(c=>{const i=s.replace(/{CODE}/g,c.code).replace(/{PRICE}/g,$(c.price)).replace(/{RAW_PRICE}/g,c.price),d=document.createElement("div");d.innerHTML=i;const l=d.firstElementChild;l.dataset.type=t,e&&(l.dataset.subType=e),o.appendChild(l)})}C=null,ve()}async function Ze(t,e=null){te=!1,C=null;const o=document.getElementById("favManagerTitle");if(!o)return;let r="รายการโปรด";t==="deco"?r=`รายการโปรด: ${e||"ของตกแต่ง"}`:r=`รายการโปรด: ${{fabric:"ผ้าทึบ",sheer:"ผ้าโปร่ง",wallpaper:"วอลเปเปอร์"}[t]||t}`,o.textContent=r,o.dataset.type=t,o.dataset.subType=e||"",pe(t,e),await D("#favManagerModal"),te&&(xe(),oe&&Ee(oe))}async function et(){const t=document.querySelector("#favAddModal");if(!t)return null;const e=t.querySelector("#fav_code_add"),o=t.querySelector("#fav_price_add");e.value="",o.value="";const r=await D("#favAddModal");return r&&!r.cancelled?{newCode:e.value.trim(),newPrice:g(o.value)}:null}async function tt(t){const e=document.querySelector("#favEditModal");if(!e)return null;const o=e.querySelector("#fav_code_edit"),r=e.querySelector("#fav_price_edit");o.value=t.code,r.value=t.price;const n=await D("#favEditModal");return n&&!n.cancelled?{newCode:o.value.trim(),newPrice:g(r.value)}:null}function ne(){document.querySelectorAll(".favorite-chips-container.show").forEach(t=>{t.classList.remove("show")}),document.querySelectorAll(".item-card.overflow-visible").forEach(t=>{t.classList.remove("overflow-visible")}),oe=null}function W(t){var a;if(!t||!t.matches("[data-favorite-type]"))return;const e=t.nextElementSibling;if(!e||!e.matches(".btn-favorite"))return;const o=e.dataset.type,r=t.value;if(!r){e.classList.remove("is-favorite"),e.querySelector("i").className="ph ph-star";return}const n=t.closest(".item-card");if(!n)return;let s=null;o==="deco"&&(s=(a=n.querySelector('[name="deco_type"]'))==null?void 0:a.value);let c,i;o==="fabric"&&(c=n.querySelector('[name="set_price_per_m"]')),o==="sheer"&&(c=n.querySelector('[name="sheer_price_per_m"]')),o==="deco"&&(c=n.querySelector('[name="deco_price_sqyd"]')),o==="wallpaper"&&(c=n.querySelector('[name="wallpaper_price_roll"]')),i=g(c==null?void 0:c.value);const d=ge(o,r,s),l=d&&d.price===i;e.classList.toggle("is-favorite",l),e.querySelector("i").className=l?"ph-fill ph-star":"ph ph-star"}function Ee(t){var d,l;ne();const e=t.dataset.favoriteType;if(!e)return;let o=null,r=[];const n=U();e==="deco"?(o=(l=(d=t.closest(".item-card"))==null?void 0:d.querySelector('[name="deco_type"]'))==null?void 0:l.value,o&&(r=n.deco[o]||[])):r=n[e]||[];const s=t.closest(".form-group-with-favorites").querySelector(".favorite-chips-container");if(!s)return;s.innerHTML="",r.length>0&&r.forEach(a=>{const m=document.createElement("button");m.type="button",m.className="btn-chip",m.textContent=a.code,m.dataset.act="select-favorite",m.dataset.code=a.code,m.dataset.price=a.price,s.appendChild(m)});const c=document.createElement("button");c.type="button",c.className="btn-manage-favorites",c.dataset.act="manage-favorites",c.dataset.type=e,o&&(c.dataset.subType=o),c.innerHTML='<i class="ph ph-pencil-simple"></i> แก้ไข',s.appendChild(c),s.classList.add("show");const i=t.closest(".item-card");i&&i.classList.add("overflow-visible")}async function be(t,e=null){const o=document.querySelector("#itemTypeModal");if(!o)return null;o.querySelector("#itemTypeModalTitle").textContent=t;const r=o.querySelector(`input[name="item_type_option"][value="${e||"set"}"]`);r&&(r.checked=!0);const n=await D("#itemTypeModal");if(!n||n.cancelled)return null;const s=o.querySelector('input[name="item_type_option"]:checked');return s?s.value:null}function rt(t,e){const r={set:"#setTpl",deco:"#decoTpl",wallpaper:"#wallpaperTpl"}[e];if(!r)return;const c=document.querySelector(r).content.cloneNode(!0).firstElementChild;if(e==="wallpaper"){const i=c.querySelector('[data-act="add-wall"]');i&&Se(i)}t.classList.add("item-removing"),t.addEventListener("animationend",()=>{t.replaceWith(c),c.classList.add("item-created"),c.scrollIntoView({behavior:"smooth",block:"center"});const i=c.querySelector('input:not([type="hidden"]), select, textarea');i&&i.focus(),ce(),R(),M(),_("เปลี่ยนประเภทรายการแล้ว","success")},{once:!0})}function ie(t,e,o=!0){ne();const r=document.querySelector(t);if(!r||!e)return null;const n=r.content.cloneNode(!0),s=n.firstElementChild;e.appendChild(n),s.querySelectorAll("input[data-favorite-type]").forEach(W),o&&s&&(s.classList.add("item-created"),s.scrollIntoView({behavior:"smooth",block:"center"}));const c=s.querySelector('input:not([type="hidden"]), select, textarea');return c&&c.focus(),ce(),R(),M(),s}function ee(){const t=document.querySelector(p.roomsContainer);if(!t)return;const e=document.querySelectorAll(p.roomNameInput);let o=0;e.forEach(s=>{const c=s.value.match(/\d+/g);if(c){const i=parseInt(c[c.length-1],10);i>o&&(o=i)}});const r=o+1,n=ie("#roomTpl",t,!0);if(n){n.id=`room-${Date.now()}`;const s=n.querySelector(p.roomNameInput);s&&(s.value=`ห้อง ${r}`),n.open=!0}le(),G(),z()}function ot(t){if(!t)return;const e=t.querySelector(p.allItemsContainer);e&&ie("#setTpl",e)}function nt(t){if(!t)return;const e=t.querySelector(p.allItemsContainer);e&&ie("#decoTpl",e)}function at(t){if(!t)return;const e=t.querySelector(p.allItemsContainer);if(e){const o=ie("#wallpaperTpl",e);o&&Se(o.querySelector('[data-act="add-wall"]'))}}function Se(t){var o;const e=(o=t==null?void 0:t.closest(".walls-section"))==null?void 0:o.querySelector(p.wallsContainer);e&&(ie("#wallTpl",e,!0),K(t))}function Ce(t){var n,s;if(!t)return;const e=(n=t.querySelector('select[name="fabric_variant"]'))==null?void 0:n.value,o=e&&e.includes("โปร่ง");(s=t.querySelector(p.sheerWrap))==null||s.classList.toggle("hidden",!o);const r=t.querySelector('input[name="sheer_fabric_code"]');if(r){const c=r.closest(".form-group-with-favorites");c&&c.classList.toggle("hidden",!o)}}function st(t,e,o,r=null){let n=0;document.querySelectorAll(`
        [name="fabric_code"], 
        [name="sheer_fabric_code"], 
        [name="deco_code"], 
        [name="wallpaper_code"]
    `).forEach(c=>{var i;if(c.value.trim()===t){const d=c.closest(".item-card");if(!d)return;const l=c.dataset.favoriteType;let a=null;if(l===o){if(o==="deco"&&((i=d.querySelector('[name="deco_type"]'))==null?void 0:i.value)!==r)return;o==="fabric"&&(a=d.querySelector('[name="set_price_per_m"]')),o==="sheer"&&(a=d.querySelector('[name="sheer_price_per_m"]')),o==="deco"&&(a=d.querySelector('[name="deco_price_sqyd"]')),o==="wallpaper"&&(a=d.querySelector('[name="wallpaper_price_roll"]')),c.value=e.newCode,a&&(a.tagName==="SELECT"?a.value=e.newPrice:a.value=$(g(e.newPrice)),c.classList.add("input-highlight"),a.classList.add("input-highlight"),setTimeout(()=>{c.classList.remove("input-highlight"),a.classList.remove("input-highlight")},1500),a.dispatchEvent(new Event("change",{bubbles:!0}))),n++}}}),n>0&&_(`อัปเดต ${n} รายการที่ใช้รหัสนี้แล้ว`,"success")}function ct(t,e,o=null){document.querySelectorAll(`input[data-favorite-type="${e}"]`).forEach(r=>{var n;if(r.value.trim()===t)if(e==="deco"){const s=r.closest(".item-card");((n=s==null?void 0:s.querySelector('[name="deco_type"]'))==null?void 0:n.value)===o&&W(r)}else W(r)})}const lt=Fe(t=>{K(t),M()});function it(t){if(P){_("ฟอร์มถูกล็อค ไม่สามารถแก้ไขได้","warning"),t.preventDefault();return}t.target.matches("input[data-favorite-type]")&&W(t.target),t.target.matches(p.roomNameInput)&&z(),lt(t.target)}function dt(t){var r;if(P)return;const e=t.target;if(["set_price_per_m","sheer_price_per_m","deco_price_sqyd","wallpaper_price_roll"].includes(e.name)){const n=e.closest(".item-card");if(n){let s;if(e.name==="set_price_per_m"&&(s=n.querySelector('[name="fabric_code"]')),e.name==="sheer_price_per_m"&&(s=n.querySelector('[name="sheer_fabric_code"]')),e.name==="deco_price_sqyd"&&(s=n.querySelector('[name="deco_code"]')),e.name==="wallpaper_price_roll"&&(s=n.querySelector('[name="wallpaper_code"]')),s){const c=s.value;if(c){const i=s.dataset.favoriteType;let d=null;i==="deco"&&(d=(r=n.querySelector('[name="deco_type"]'))==null?void 0:r.value);const l=ge(i,c,d),a=g(e.value);l&&l.price!==a&&(s.value="",s.dispatchEvent(new Event("input",{bubbles:!0})))}W(s)}}}if(e.matches('select[name="fabric_variant"]')&&Ce(e.closest(p.set)),e.matches('select[name="deco_type"]')){const n=e.closest(p.decoItem);if(n){const s=n.querySelector(".item-type-changer .deco-type-display");s&&(s.textContent=e.value||"ตกแต่ง");const c=n.querySelector('input[name="deco_code"]');c&&(c.value="",W(c));const i=n.querySelector('input[name="deco_price_sqyd"]');i&&(i.value="")}}e.matches(p.roomNameInput)&&(le(),z()),K(e),M()}function ut(t){const e=t.target,o=e.matches('[name="deco_price_sqyd"], [name="wallpaper_price_roll"], [name="wallpaper_install_cost"], [name="fav_price_edit"], [name="fav_price_add"]'),r=e.matches('input[name="width_m"], input[name="height_m"], input[name="deco_width_m"], input[name="deco_height_m"], input[name="wallpaper_height_m"], input[name="wall_width_m"]');if(o){const n=g(e.value);n>0?e.value=$(n):e.value=""}else r&&(e.value=Y(e.value))}function pt(t){const e=t.target;if(e.matches('[name="deco_price_sqyd"], [name="wallpaper_price_roll"], [name="wallpaper_install_cost"], [name="fav_price_edit"], [name="fav_price_add"]')){const r=g(e.value);r>0&&(e.value=r)}e.matches("input[data-favorite-type]")&&(oe=e,Ee(e))}function K(t){var n,s,c,i,d,l,a,m,u,h,v,w;if(!t)return;const e=t.closest(p.set);if(e){const y=e.querySelector("[data-set-summary]");if(y){const S={width_m:(n=e.querySelector('input[name="width_m"]'))==null?void 0:n.value,height_m:(s=e.querySelector('input[name="height_m"]'))==null?void 0:s.value,style:(c=e.querySelector('select[name="set_style"]'))==null?void 0:c.value,fabric_variant:(i=e.querySelector('select[name="fabric_variant"]'))==null?void 0:i.value,price_per_m_raw:(d=e.querySelector('select[name="set_price_per_m"]'))==null?void 0:d.value,sheer_price_per_m:(l=e.querySelector('select[name="sheer_price_per_m"]'))==null?void 0:l.value},f=I.calculateSetPrice(S);e.dataset.totalPrice=f.total;let x=`ราคา: <b>${$(f.total)}</b> บ.`;f.opaque>0&&f.sheer>0&&(x+=` <small>(ทึบ: ${$(f.opaque)}, โปร่ง: ${$(f.sheer)})</small>`),y.innerHTML=x}}const o=t.closest(p.decoItem);if(o){const y=o.querySelector("[data-deco-summary]");if(y){const S={width_m:(a=o.querySelector('input[name="deco_width_m"]'))==null?void 0:a.value,height_m:(m=o.querySelector('input[name="deco_height_m"]'))==null?void 0:m.value,price_sqyd:(u=o.querySelector('input[name="deco_price_sqyd"]'))==null?void 0:u.value},f=I.calculateDecoPrice(S);o.dataset.totalPrice=f.total,y.innerHTML=`ราคา: <b>${$(f.total)}</b> บ. &bull; พื้นที่: ${H(f.sqyd,2)} ตร.หลา`}}const r=t.closest(p.wallpaperItem);if(r){const y=r.querySelector("[data-wallpaper-summary]");if(y){const S={height_m:(h=r.querySelector('input[name="wallpaper_height_m"]'))==null?void 0:h.value,price_per_roll:(v=r.querySelector('input[name="wallpaper_price_roll"]'))==null?void 0:v.value,install_cost_per_roll:(w=r.querySelector('input[name="wallpaper_install_cost"]'))==null?void 0:w.value,widths:Array.from(r.querySelectorAll('input[name="wall_width_m"]')).map(O=>O.value)},f=I.calculateWallpaperPrice(S);r.dataset.totalPrice=f.total;let x=`รวม: <b>${$(f.total)}</b> บ. `;(f.material>0||f.install>0)&&(x+=`<small>(วอลล์: ${$(f.material)}, ค่าช่าง: ${$(f.install)})</small>`),x+=` &bull; พื้นที่: ${H(f.sqm,2)} ตร.ม. &bull; ใช้: ${f.rolls} ม้วน`,y.innerHTML=x}}R()}function R(){let t=0,e=0;document.querySelectorAll(p.room).forEach(n=>{let s=0,c=0;const i=n.classList.contains("is-suspended");n.querySelectorAll(".item-card").forEach(l=>{const a=g(l.dataset.totalPrice),m=l.classList.contains("is-suspended");!i&&!m&&(s+=a,a>0&&c++)});const d=n.querySelector("[data-room-brief]");d&&(i?d.textContent="(ระงับชั่วคราว)":c>0?d.innerHTML=`<span>${c}</span> &bull; ${$(s)} บาท`:d.innerHTML="<span>0</span> รายการ"),i||(t+=s,e+=c)});const o=document.querySelector(p.grandTotal),r=document.querySelector(p.setCount);o&&(o.textContent=$(t)),r&&(r.textContent=e)}function qe(t){if(t&&t.favorites&&(He(t.favorites)?(_("นำเข้ารายการโปรดสำเร็จ","success"),xe()):_("ข้อมูลรายการโปรดในไฟล์ไม่ถูกต้อง","warning")),!t||!t.rooms||!Array.isArray(t.rooms)){t.favorites||_("ไม่พบข้อมูลสำหรับนำเข้าในไฟล์","error");return}const e=document.querySelector(p.roomsContainer);if(!e)return;e.innerHTML="";const o=document.querySelector("#customer_name"),r=document.querySelector("#customer_phone"),n=document.querySelector("#customer_address");o&&(o.value=t.customer_name||""),r&&(r.value=t.customer_phone||""),n&&(n.value=t.customer_address||"");const s=document.querySelector("#customerDetailsCard");s&&(s.open=t.customer_card_open??!0),t.rooms.forEach(c=>{!c.items&&(c.sets||c.decorations||c.wallpapers)&&(c.items=[],c.sets&&c.sets.forEach(y=>c.items.push({...y,type:"set"})),c.decorations&&c.decorations.forEach(y=>c.items.push({...y,type:"deco"})),c.wallpapers&&c.wallpapers.forEach(y=>c.items.push({...y,type:"wallpaper"})));const i=document.querySelector("#roomTpl");if(!i)return;const d=i.content.cloneNode(!0),l=d.querySelector(p.room);if(!l)return;l.id=c.id||`room-${Date.now()}`,c.is_suspended&&l.classList.add("is-suspended"),l.open=c.is_open===!0;const a=l.querySelector(p.roomNameInput);a&&(a.value=c.room_name||"ห้อง (ไม่มีชื่อ)");const m=l.querySelector(p.allItemsContainer),u=document.querySelector("#setTpl"),h=document.querySelector("#decoTpl"),v=document.querySelector("#wallpaperTpl"),w=document.querySelector("#wallTpl");m&&c.items&&c.items.forEach(y=>{let S,f;switch(y.type){case"set":if(!u)return;S=u.content.cloneNode(!0),f=S.querySelector(p.set),y.is_suspended&&f.classList.add("is-suspended"),f.querySelector('input[name="width_m"]').value=Y(y.width_m),f.querySelector('input[name="height_m"]').value=Y(y.height_m),f.querySelector('select[name="set_style"]').value=y.style||"ลอน",f.querySelector('select[name="fabric_variant"]').value=y.fabric_variant||"ทึบ",f.querySelector('select[name="set_price_per_m"]').value=y.price_per_m_raw||"",f.querySelector('select[name="sheer_price_per_m"]').value=y.sheer_price_per_m||"",f.querySelector('select[name="opening_style"]').value=y.opening_style||"แยกกลาง",f.querySelector('select[name="track_color"]').value=y.track_color||"ขาว",f.querySelector('input[name="fabric_code"]').value=y.fabric_code||"",f.querySelector('input[name="sheer_fabric_code"]').value=y.sheer_fabric_code||"",f.querySelector('input[name="notes"]').value=y.notes||"",Ce(f),m.appendChild(S);break;case"deco":if(!h)return;S=h.content.cloneNode(!0),f=S.querySelector(p.decoItem),y.is_suspended&&f.classList.add("is-suspended");const x=f.querySelector('select[name="deco_type"]');x.value=y.deco_type||"",f.querySelector(".deco-type-display").textContent=y.deco_type||"ตกแต่ง",f.querySelector('input[name="deco_width_m"]').value=Y(y.width_m),f.querySelector('input[name="deco_height_m"]').value=Y(y.height_m),f.querySelector('input[name="deco_price_sqyd"]').value=$(y.price_sqyd)||"",f.querySelector('input[name="deco_code"]').value=y.deco_code||"",f.querySelector('input[name="deco_notes"]').value=y.notes||"",m.appendChild(S);break;case"wallpaper":if(!v)return;S=v.content.cloneNode(!0),f=S.querySelector(p.wallpaperItem),y.is_suspended&&f.classList.add("is-suspended"),f.querySelector('input[name="wallpaper_height_m"]').value=Y(y.height_m),f.querySelector('input[name="wallpaper_code"]').value=y.wallpaper_code||"",f.querySelector('input[name="wallpaper_price_roll"]').value=$(y.price_per_roll)||"",f.querySelector('input[name="wallpaper_install_cost"]').value=y.hasOwnProperty("install_cost_per_roll")?$(y.install_cost_per_roll):"300",f.querySelector('input[name="wallpaper_notes"]').value=y.notes||"";const O=f.querySelector(p.wallsContainer);O&&w&&y.widths&&y.widths.forEach(T=>{const L=w.content.cloneNode(!0);L.querySelector('input[name="wall_width_m"]').value=Y(T),O.appendChild(L)}),m.appendChild(S);break}}),e.appendChild(d)}),document.querySelectorAll("input[data-favorite-type]").forEach(W),document.querySelectorAll(".item-card").forEach(c=>{K(c)}),ce(),R(),le(),G(),z(),_("นำเข้าข้อมูลฟอร์มสำเร็จ","success")}function mt(t){if(document.getElementById("loading-overlay"))return;const e=document.createElement("div");e.id="loading-overlay",e.innerHTML=`<div class="loading-spinner"></div><p>${t}</p>`,document.body.appendChild(e),document.body.style.overflow="hidden"}function ft(){const t=document.getElementById("loading-overlay");t&&t.remove(),document.body.style.overflow=""}async function ht(t,e){var r,n;const o=document.querySelector(p.printableContent);if(!o||!t||!t.html){_("ไม่พบข้อมูลสำหรับสร้างเอกสาร","error");return}if(e==="direct"){mt("กำลังสร้าง PDF...");const s=document.createElement("div");s.style.position="fixed",s.style.left="-300mm",s.style.top="0",s.style.width="210mm",s.style.background="#fff",s.innerHTML=t.html,document.body.appendChild(s),await new Promise(c=>setTimeout(c,500));try{const c={margin:0,filename:`${t.fileName}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0,logging:!1,width:((r=s.querySelector(".pdf-page"))==null?void 0:r.scrollWidth)||791.7,windowWidth:((n=s.querySelector(".pdf-page"))==null?void 0:n.scrollWidth)||791.7},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}};await html2pdf().from(s).set(c).save(),_("ดาวน์โหลด PDF สำเร็จ","success")}catch(c){console.error("PDF Generation Error:",c),_("สร้าง PDF ล้มเหลว, โปรดลองวิธีที่ 2 (พิมพ์)","error")}finally{ft(),document.body.removeChild(s)}}e==="print"&&(o.innerHTML=t.html,setTimeout(()=>{window.print(),setTimeout(()=>{o.innerHTML=""},1e3)},Pe))}function yt(t){if(!t||!t.html){_("ไม่พบข้อมูลสำหรับสร้างไฟล์ HTML","error");return}try{const e=`
            <!DOCTYPE html><html lang="th"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>${t.fileName}</title>
                <link rel="stylesheet" href="https://grobmak.github.io/marnthara-form/src/style.css">
                <style>#printable-content { display: block !important; } .pdf-page { border: 1px solid #eee; box-shadow: 0 0 10px rgba(0,0,0,0.1); margin: 10mm auto; }</style>
            </head>
            <body>${t.html}</body></html>`,o=new Blob([e],{type:"text/html;charset=utf-8"}),r=URL.createObjectURL(o),n=document.createElement("a");n.href=r,n.download=`${t.fileName}.html`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(r),_("ดาวน์โหลดไฟล์ HTML สำเร็จ","success")}catch(e){console.error("HTML Export Error:",e),_("สร้างไฟล์ HTML ล้มเหลว","error")}}const vt=async t=>{var i,d,l;const e=t.target.closest("[data-act]"),o=t.target.closest(".fav-manager-item");if(o&&!e&&o.closest("#favManagerBody")){C===o?(C.classList.remove("is-selected"),C=null):(C&&C.classList.remove("is-selected"),o.classList.add("is-selected"),C=o),ve();return}if(!e)return;const r=["select-favorite","manage-favorites","close-modal","add-new-fav-form","edit-selected-fav","del-selected-fav","toggle-more-details"];if(P&&!e.closest(".unlockable")&&!r.includes(e.dataset.act))return;const n=e.dataset.act,s=e.closest(p.room),c=(a,m,u)=>{re(a,m).then(h=>{h&&u()})};switch(n){case"add-room":ee();break;case"add-item":{if(X=e.closest(p.room),X){const u=await be("เพิ่มรายการใหม่");u==="set"&&ot(X),u==="deco"&&nt(X),u==="wallpaper"&&at(X)}break}case"change-type":{he=e.closest(".item-card");const u=e.dataset.currentType;if(he){const h=await be("เปลี่ยนประเภทรายการ",u);h&&h!==u&&await re("ยืนยันการเปลี่ยนแปลง","ข้อมูลทั้งหมดในรายการนี้จะถูกลบและสร้างใหม่ คุณแน่ใจหรือไม่?")&&rt(he,h)}break}case"add-wall":Se(e);break;case"toggle-more-details":{const u=e.closest(".item-card"),h=u==null?void 0:u.querySelector(".item-details-more");if(h){const v=h.classList.toggle("show");e.classList.toggle("expanded",v);const w=e.querySelector("i"),y=e.querySelector("span");w&&(w.className=v?"ph ph-caret-up":"ph ph-caret-down"),y&&(y.textContent=v?"ย่อน้อยลง":"เพิ่มเติม")}break}case"del-room":c("ลบห้อง","ยืนยันการลบห้องนี้?",()=>Z(s,"ลบห้องแล้ว"));break;case"del-set":c("ลบรายการ","ยืนยันการลบรายการผ้าม่าน?",()=>Z(e.closest(p.set),"ลบรายการผ้าม่านแล้ว"));break;case"del-deco":c("ลบรายการ","ยืนยันการลบรายการตกแต่ง?",()=>Z(e.closest(p.decoItem),"ลบรายการตกแต่งแล้ว"));break;case"del-wallpaper":c("ลบรายการ","ยืนยันการลบรายการวอลเปเปอร์?",()=>Z(e.closest(p.wallpaperItem),"ลบรายการวอลเปเปอร์แล้ว"));break;case"del-wall":{const u=e.closest(".wall-input-row"),h=e.closest(p.wallpaperItem);c("ลบผนัง","ยืนยันการลบผนังนี้?",()=>{Z(u,"ลบผนังแล้ว",()=>{K(h)})});break}case"clear-room":c("ล้างข้อมูลในห้อง","ยืนยันลบทุกรายการในห้องนี้?",()=>{s.querySelector(p.allItemsContainer).innerHTML="",ce(),R(),M(),_("ล้างข้อมูลในห้องแล้ว","success")});break;case"toggle-room-menu":t.preventDefault();const a=e.nextElementSibling;if(!a||!s)return;const m=!a.classList.contains("show");document.querySelectorAll(".room-options-menu.show").forEach(u=>u.classList.remove("show")),document.querySelectorAll(".card.overflow-visible").forEach(u=>u.classList.remove("overflow-visible")),m&&(a.classList.add("show"),s.classList.add("overflow-visible"));break;case"toggle-suspend-room":t.preventDefault(),s==null||s.classList.toggle("is-suspended"),R(),M(),(i=e.closest(".room-options-menu"))==null||i.classList.remove("show"),s==null||s.classList.remove("overflow-visible");break;case"toggle-suspend":t.preventDefault(),(d=e.closest(".item-card"))==null||d.classList.toggle("is-suspended"),K(e),M();break;case"toggle-favorite":{const u=e.dataset.type,h=e.previousElementSibling,v=h==null?void 0:h.value;if(!v||v.trim()===""){_("กรุณากรอกรหัสก่อนบันทึก","warning");return}const w=e.closest(".item-card");if(!w)return;let y=0,S=null,f=null;if(u==="fabric"&&(S=w.querySelector('[name="set_price_per_m"]')),u==="sheer"&&(S=w.querySelector('[name="sheer_price_per_m"]')),u==="wallpaper"&&(S=w.querySelector('[name="wallpaper_price_roll"]')),u==="deco"&&(S=w.querySelector('[name="deco_price_sqyd"]'),f=(l=w.querySelector('[name="deco_type"]'))==null?void 0:l.value,!f)){_("กรุณาเลือกประเภทของตกแต่งก่อนบันทึก","warning");return}if(S&&S.value&&(y=g(S.value)),y<=0){_("กรุณากรอกราคาก่อนบันทึกเป็นรายการโปรด","warning");return}const x=Ue(u,v,y,f);W(h),_(x?"บันทึกรหัสโปรดแล้ว":"ลบรหัสโปรดแล้ว","success");break}case"select-favorite":{const u=e.dataset.code,h=e.dataset.price,v=e.closest(".form-group-with-favorites"),w=v?v.querySelector("input[data-favorite-type]"):oe;if(w){w.value=u;const y=e.closest(".item-card");if(y&&h){const S=w.dataset.favoriteType;let f=null;S==="fabric"&&(f=y.querySelector('[name="set_price_per_m"]')),S==="sheer"&&(f=y.querySelector('[name="sheer_price_per_m"]')),S==="deco"&&(f=y.querySelector('[name="deco_price_sqyd"]')),S==="wallpaper"&&(f=y.querySelector('[name="wallpaper_price_roll"]')),f&&(f.tagName==="SELECT"?f.value=h:f.value=$(g(h)),f.classList.add("input-highlight"),setTimeout(()=>f.classList.remove("input-highlight"),1200),f.dispatchEvent(new Event("change",{bubbles:!0})))}w.dispatchEvent(new Event("input",{bubbles:!0})),ne(),_(`เลือกโค้ด ${u} แล้ว`,"success")}break}case"manage-favorites":{ne();const u=e.dataset.type,h=e.dataset.subType||null;if(u==="deco"&&!h){_("กรุณาเลือกประเภทของตกแต่งก่อน","warning");return}Ze(u,h);break}case"del-selected-fav":{if(!C)return;const{type:u,subType:h,code:v}=C.dataset;c("ลบรายการโปรด",`ยืนยันการลบ "${v}"?`,()=>{Te(u,v,h)&&(te=!0,C.remove(),C=null,ve(),_("ลบรายการโปรดแล้ว","success"),ct(v,u,h),document.querySelector(".fav-manager-item")||pe(u,h))});break}case"edit-selected-fav":{if(!C)return;const{type:u,subType:h,code:v,price:w}=C.dataset,y=await tt({code:v,price:w});if(y){if(!y.newCode){_("รหัสห้ามว่าง","error");return}De(u,v,y.newCode,y.newPrice,h)?(te=!0,_("อัปเดตรายการแล้ว","success"),pe(u,h),st(v,y,u,h)):_("อัปเดตล้มเหลว รหัสอาจซ้ำซ้อน","error")}break}case"add-new-fav-form":{const{type:u,subType:h}=document.getElementById("favManagerTitle").dataset,v=await et();if(v){if(!v.newCode){_("กรุณากรอกรหัส","error");return}if(v.newPrice<=0){_("กรุณากรอกราคา","error");return}je(u,v.newCode,v.newPrice,h)?(te=!0,_("เพิ่มรายการใหม่สำเร็จ","success"),pe(u,h)):_("เพิ่มล้มเหลว รหัสอาจซ้ำ","error")}break}}};function _t(){P=!P,ke()}function gt(){const t=document.querySelector(p.setTpl);if(!t)return;const e=t.content.querySelector('select[name="set_price_per_m"]'),o=t.content.querySelector('select[name="sheer_price_per_m"]'),r=n=>{let s='<option value="" hidden>เลือกราคา</option>';return n.forEach(c=>{s+=`<option value="${c}">${c.toLocaleString("th-TH")}</option>`}),s};e&&(e.innerHTML=r(me.fabric)),o&&(o.innerHTML=r(me.sheer))}function St(){gt(),$e();const t=document.querySelector(p.orderForm),e=document.querySelector(p.fileImporter),o=document.querySelector(p.menuDropdown),r=document.querySelector(p.quickNavDropdown),n=document.querySelector("#pageBreakBuffer"),s=document.querySelector("#pageBreakBufferValue");n&&s&&n.addEventListener("input",()=>{s.textContent=n.value}),t.addEventListener("input",it),t.addEventListener("change",dt),document.addEventListener("click",vt),t.addEventListener("blur",ut,!0),t.addEventListener("focusin",pt,!0);const c=d=>{const l=d.target.closest(p.room);l&&Ie(l)};t.addEventListener("click",c),t.addEventListener("focusin",c),document.body.addEventListener("click",d=>{d.target.closest("summary")&&setTimeout(()=>{G(),M()},50)}),document.querySelector(p.lockBtn).addEventListener("click",_t),document.querySelector(p.toggleAllRoomsBtn).addEventListener("click",Xe),document.querySelector(p.quickNavBtn).addEventListener("click",d=>{var a;d.stopPropagation(),o.classList.remove("show");const l=!r.classList.contains("show");r.classList.toggle("show"),d.currentTarget.setAttribute("aria-expanded",l),l&&((a=document.querySelector(p.menuBtn))==null||a.setAttribute("aria-expanded","false"))}),document.querySelector(p.quickNavRoomList).addEventListener("click",d=>{var a;const l=d.target.closest("a[data-jump-to]");if(l){d.preventDefault();const m=l.dataset.jumpTo,u=document.getElementById(m);u&&(document.body.classList.add("disable-animations"),u.open=!0,u.scrollIntoView({behavior:"auto",block:"start"}),u.classList.add("scrolling-jump"),setTimeout(()=>{u.classList.remove("scrolling-jump"),document.body.classList.remove("disable-animations"),G()},1e3)),r.classList.remove("show"),(a=document.querySelector(p.quickNavBtn))==null||a.setAttribute("aria-expanded","false")}});const i=document.querySelector("#addRoomQuickNavBtn");if(i){const d=Re(ee,700);i.addEventListener("click",l=>{var a;l.stopPropagation(),d(),r.classList.remove("show"),(a=document.querySelector(p.quickNavBtn))==null||a.setAttribute("aria-expanded","false")})}document.querySelector(p.menuBtn).addEventListener("click",d=>{var a;d.stopPropagation(),r.classList.remove("show");const l=!o.classList.contains("show");o.classList.toggle("show"),d.currentTarget.setAttribute("aria-expanded",l),l&&((a=document.querySelector(p.quickNavBtn))==null||a.setAttribute("aria-expanded","false"))}),document.querySelector("#themeToggleBtn").addEventListener("click",d=>{d.preventDefault(),Ke()}),document.querySelector("#overviewBtn").addEventListener("click",async d=>{var u;d.preventDefault(),o.classList.remove("show"),(u=document.querySelector(p.menuBtn))==null||u.setAttribute("aria-expanded","false");const l=Q(),a=Je(l),m=document.querySelector("#overviewModalBody");m&&(m.innerHTML=a,D("#overviewModal",()=>{}))}),document.querySelector(p.exportPdfBtn).addEventListener("click",async d=>{var h;d.preventDefault(),o.classList.remove("show"),(h=document.querySelector(p.menuBtn))==null||h.setAttribute("aria-expanded","false");const l=await ze();if(!l)return;const a=Q(),m=l.vatOption==="include"?k.baseVatRate:0,u=Qe(a,{vatRate:m,pageBreakBuffer:l.pageBreakBuffer});if(!u){_("ไม่มีรายการที่มีราคาสำหรับสร้างเอกสาร","warning");return}l.exportMethod==="html"?yt(u):ht(u,l.exportMethod)}),document.querySelector(p.importBtn).addEventListener("click",d=>{var l;d.preventDefault(),o.classList.remove("show"),(l=document.querySelector(p.menuBtn))==null||l.setAttribute("aria-expanded","false"),e.click()}),e.addEventListener("change",d=>{var m;const l=(m=d.target.files)==null?void 0:m[0];if(!l)return;const a=new FileReader;a.onload=u=>{try{const h=JSON.parse(u.target.result);qe(h)}catch(h){_("ไฟล์ JSON ไม่ถูกต้อง","error"),console.error("JSON Parse Error:",h)}},a.readAsText(l),d.target.value=null}),document.querySelector(p.exportBtn).addEventListener("click",d=>{var l;d.preventDefault(),o.classList.remove("show"),(l=document.querySelector(p.menuBtn))==null||l.setAttribute("aria-expanded","false");try{const a=Q(),m=JSON.stringify(a,null,4),u=new Blob([m],{type:"application/json"}),h=URL.createObjectURL(u),v=document.createElement("a"),w=new Date,y=`${w.getFullYear()}${(w.getMonth()+1).toString().padStart(2,"0")}${w.getDate().toString().padStart(2,"0")}`,S=`${w.getHours().toString().padStart(2,"0")}${w.getMinutes().toString().padStart(2,"0")}`,f=Le(a.customer_name||"data");v.href=h,v.download=`MTR-${y}${S}-${f}.json`,v.click(),URL.revokeObjectURL(h),_("Export ข้อมูลสำเร็จ","success")}catch{_("Export ข้อมูลล้มเหลว","error")}}),document.querySelector(p.submitBtn).addEventListener("click",async d=>{var l;if(d.preventDefault(),o.classList.remove("show"),(l=document.querySelector(p.menuBtn))==null||l.setAttribute("aria-expanded","false"),await re("ส่งข้อมูล","ยืนยันการส่งข้อมูลการประเมินราคา?")){const a=Q();if(!a.customer_name&&!a.customer_phone){_("กรุณาระบุชื่อหรือเบอร์โทรลูกค้า","warning");return}_("กำลังส่งข้อมูล...","default");try{const m=await fetch(Ne,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});m.ok?_("ส่งข้อมูลสำเร็จ!","success"):_(`ส่งข้อมูลล้มเหลว: ${m.status}`,"error")}catch{_("เกิดข้อผิดพลาดในการเชื่อมต่อ","error")}}}),document.querySelector(p.copyTextBtn).addEventListener("click",async d=>{var m;d.preventDefault(),o.classList.remove("show"),(m=document.querySelector(p.menuBtn))==null||m.setAttribute("aria-expanded","false");const l=document.querySelector(p.copyOptionsModal);l.querySelector('input[name="copy_option"][value="customer"]').checked=!0;const a=await D(p.copyOptionsModal);if(a&&!a.cancelled){const u=l.querySelector('input[name="copy_option"]:checked').value,h=Ge(Q(),u);try{await navigator.clipboard.writeText(h),_("คัดลอกสรุปสำเร็จ!","success")}catch{_("คัดลอกล้มเหลว","error")}}}),document.querySelector(p.clearItemsBtn).addEventListener("click",async d=>{var l;d.preventDefault(),o.classList.remove("show"),(l=document.querySelector(p.menuBtn))==null||l.setAttribute("aria-expanded","false"),await re("ล้างทุกรายการ","คุณแน่ใจหรือไม่ว่าต้องการลบรายการสินค้าทั้งหมด (ข้อมูลลูกค้าและห้องจะยังคงอยู่)?")&&(document.querySelectorAll(p.room).forEach(a=>{const m=a.querySelector(p.allItemsContainer);m&&(m.innerHTML="")}),R(),M(),_("ล้างทุกรายการแล้ว","success"))}),document.querySelector(p.clearAllBtn).addEventListener("click",async d=>{var l;if(d.preventDefault(),o.classList.remove("show"),(l=document.querySelector(p.menuBtn))==null||l.setAttribute("aria-expanded","false"),await re("ลบข้อมูลทั้งหมด",'คำเตือน! การกระทำนี้จะลบข้อมูลลูกค้า, ทุกรายการ, และ "รายการโปรด" ทั้งหมดอย่างถาวร ยืนยันหรือไม่?')){localStorage.removeItem(ue),localStorage.removeItem("marnthara.theme"),Ve();const a=document.querySelector("#customer_name"),m=document.querySelector("#customer_phone"),u=document.querySelector("#customer_address");a&&(a.value=""),m&&(m.value=""),u&&(u.value="");const h=document.querySelector(p.roomsContainer);h&&(h.innerHTML=""),R(),le(),G(),ee();const v=document.querySelector("#customerDetailsCard");v&&(v.open=!0),_("ลบข้อมูลทั้งหมดแล้ว เริ่มต้นใหม่","success")}}),window.addEventListener("click",d=>{var l,a;d.target.closest(".modal-wrapper")||(d.target.closest(".menu-container")||(o.classList.contains("show")&&(o.classList.remove("show"),(l=document.querySelector(p.menuBtn))==null||l.setAttribute("aria-expanded","false")),r.classList.contains("show")&&(r.classList.remove("show"),(a=document.querySelector(p.quickNavBtn))==null||a.setAttribute("aria-expanded","false"))),d.target.closest(".room-options-container")||(document.querySelectorAll(".room-options-menu.show").forEach(m=>m.classList.remove("show")),document.querySelectorAll(".card.overflow-visible").forEach(m=>m.classList.remove("overflow-visible"))),d.target.closest(".form-group-with-favorites")||ne())}),window.addEventListener("beforeunload",M);try{const d=localStorage.getItem(ue);if(d&&d.length>2&&d!=="null")qe(JSON.parse(d));else{ee();const l=document.querySelector("#customerDetailsCard");l&&(l.open=!0)}}catch(d){console.error("Failed to load data from localStorage:",d),localStorage.removeItem(ue),ee()}R(),ke(),G(),z()}document.addEventListener("DOMContentLoaded",St);
