(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))a(s);new MutationObserver(s=>{for(const c of s)if(c.type==="childList")for(const n of c.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&a(n)}).observe(document,{childList:!0,subtree:!0});function r(s){const c={};return s.integrity&&(c.integrity=s.integrity),s.referrerPolicy&&(c.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?c.credentials="include":s.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function a(s){if(s.ep)return;s.ep=!0;const c=r(s);fetch(s.href,c)}})();const De="input-ui/5.6.3",Ue="https://your-make-webhook-url.com/your-unique-path",pe="marnthara.input.v5",Ve=500,C={name:"ม่านธารา ผ้าม่านและของตกแต่ง",address:"65/8 หมู่ 2 ต.ท่าศาลา อ.เมือง จ.ลพบุรี 15000",phone:"092-985-9395, 082-552-5595",taxId:"1234567890123",logoUrl:"./assets/logo.png",baseVatRate:.07,pdf:{paymentTerms:"ชำระมัดจำ 50%",priceValidity:"30 วัน",notes:["ราคานี้รวมค่าติดตั้งแล้ว","ชำระมัดจำ 50% เพื่อยืนยันการสั่งผลิตสินค้า","ใบเสนอราคานี้มีอายุ 30 วัน นับจากวันที่เสนอราคา"]}},Ye=1.19599,Se={ROLL_WIDTH_M:.53,ROLL_LENGTH_M:10,STRIPS_PER_ROLL_UNDER_2_5M:3},he={fabric:[1e3,1100,1200,1300,1400,1500,1600,1700,1800,1900,2e3,2100,2200],sheer:[1e3,1100,1200,1300,1400,1500],style_surcharge:{ลอน:200,ตาไก่:0,จีบ:0},height:[{threshold:3.2,add_per_m:300},{threshold:2.8,add_per_m:200},{threshold:2.5,add_per_m:100}]},m={orderForm:"#orderForm",roomsContainer:"#rooms",setTpl:"#setTpl",clearAllBtn:"#clearAllBtn",lockBtn:"#lockBtn",grandTotal:"#grandTotal",modal:"#confirmationModal",modalTitle:"#modalTitle",modalBody:"#modalBody",room:"[data-room]",allItemsContainer:"[data-all-items]",wallsContainer:"[data-walls-container]",sheerWrap:"[data-sheer-wrap]",sheerCodeWrap:"[data-sheer-code-wrap]",roomNameInput:'input[name="room_name"]',toastContainer:"#toast-container",copyTextBtn:"#copyTextBtn",copyOptionsModal:"#copyOptionsModal",menuBtn:"#menuBtn",menuDropdown:"#menuDropdown",importBtn:"#importBtn",exportBtn:"#exportBtn",fileImporter:"#fileImporter",submitBtn:"#submitBtn",clearItemsBtn:"#clearItemsBtn",exportPdfBtn:"#exportPdfBtn",exportOptionsModal:"#exportOptionsModal",printableContent:"#printable-content",quickNavBtn:"#quickNavBtn",quickNavDropdown:"#quickNavDropdown",quickNavRoomList:"#quickNavRoomList",toggleAllRoomsBtn:"#toggleAllRoomsBtn"},y=e=>{typeof e=="string"&&(e=e.replace(/,/g,""));const t=parseFloat(e);return Number.isFinite(t)?t:0},J=e=>{const t=y(e);return t>0?t.toFixed(2):""},F=(e,t=2,r=!1)=>Number.isFinite(e)?e.toLocaleString("en-US",{minimumFractionDigits:r?2:t,maximumFractionDigits:r?2:t}):"0",w=(e,t=0)=>Number.isFinite(e)?e.toLocaleString("th-TH",{minimumFractionDigits:t,maximumFractionDigits:t}):"0",Ge=(e,t=150)=>{let r;return(...a)=>{clearTimeout(r),r=setTimeout(()=>e(...a),t)}},Je=(e,t=700)=>{let r=!1;return(...a)=>{if(!r){r=!0;try{return e(...a)}finally{setTimeout(()=>{r=!1},t)}}}},b=e=>typeof e!="string"?"":e.replace(/[&<>"']/g,function(t){switch(t){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";default:return"&#039;"}}),Pe=e=>typeof e!="string"?"":e.replace(/[\\/?%*:|"<>\x00-\x1f]/g,"").trim()||"file";function Qe(e){let t=y(e);if(isNaN(t))return"ข้อมูลตัวเลขไม่ถูกต้อง";if(t===0)return"ศูนย์บาทถ้วน";const r=["","หนึ่ง","สอง","สาม","สี่","ห้า","หก","เจ็ด","แปด","เก้า"],a=["","สิบ","ร้อย","พัน","หมื่น","แสน","ล้าน"];let s=Math.floor(t),c=Math.round((t-s)*100);const n=i=>{if(i===0)return"";let d="";const p=String(i);for(let u=0;u<p.length;u++){const f=p[u];p.length-1;const _=p.length-u-1;f!=="0"&&(_===1&&f==="1"?d+=a[_]:_===1&&f==="2"?d+="ยี่"+a[_]:_===0&&f==="1"&&p.length>1?d+="เอ็ด":d+=r[parseInt(f)]+a[_])}return d};let o="";if(s>0){const i=Math.floor(s/1e6),d=s%1e6;i>0&&(o+=n(i)+"ล้าน"),o+=n(d),o+="บาท"}let l="";return c>0?l=n(c)+"สตางค์":o+="ถ้วน",(o+l).trim()}const Ie="marnthara.favorites.v4",me={fabric:[],sheer:[],wallpaper:[],wooden_blind:[],roller_blind:[],vertical_blind:[],partition:[],pleated_screen:[],aluminum_blind:[]};function Z(){try{const e=localStorage.getItem(Ie);return e?{...me,...JSON.parse(e)}:me}catch(e){return console.error("Failed to parse favorites from localStorage",e),me}}function Ee(e){try{localStorage.setItem(Ie,JSON.stringify(e))}catch(t){console.error("Failed to save favorites to localStorage",t)}}function Ke(e){if(!e||typeof e!="object")return console.error("Invalid favorites data for import."),!1;const t={...me,...e};return Ee(t),!0}function ze(e,t,r){const a=Z();a[e]||(a[e]=[]);const s=a[e],c=s.find(n=>n.code===t);return c?c.price=r:s.push({code:t,price:r}),s.sort((n,o)=>n.code.localeCompare(o.code)),Ee(a),!0}function Te(e,t){const r=Z();if(!r[e])return!1;const a=r[e].findIndex(s=>s.code===t);return a>-1?(r[e].splice(a,1),Ee(r),!0):!1}function Me(e,t){if(!e||!t)return;const r=Z(),a=t.trim();return(r[e]||[]).find(c=>c.code===a)}function Xe(e,t){return!!Me(e,t)}function be(e,t,r){const a=Me(e,t);return a&&a.price===r?(Te(e,t),!1):(ze(e,t,r),!0)}function Ze(){localStorage.removeItem(Ie),console.log("All favorites have been cleared.")}function W(){var r,a,s,c,n,o;const e=Z(),t={app_version:De,customer_name:((r=document.querySelector('[name="customer_name"]'))==null?void 0:r.value)||"",customer_phone:((a=document.querySelector('[name="customer_phone"]'))==null?void 0:a.value)||"",customer_address:((s=document.querySelector('[name="customer_address"]'))==null?void 0:s.value)||"",customer_card_open:(c=document.querySelector("#customerDetailsCard"))==null?void 0:c.open,discount:{type:((n=document.querySelector("#discount_type"))==null?void 0:n.value)||"amount",value:y((o=document.querySelector("#discount_value"))==null?void 0:o.value)},rooms:[],favorites:e};return document.querySelectorAll(m.room).forEach(l=>{var d,p;const i={id:l.id,room_name:((d=l.querySelector(m.roomNameInput))==null?void 0:d.value)||"",is_suspended:l.classList.contains("is-suspended"),is_open:l.open,items:[]};(p=l.querySelector(m.allItemsContainer))==null||p.childNodes.forEach(u=>{var h,v,q,T,L,$,E,Y,ce,M,B,S,x,I,R,N,D,G,z,P,ie;if(u.nodeType!==1||!u.matches(".item-card"))return;const f=u.dataset.type;if(!f)return;let _={type:f,is_suspended:u.classList.contains("is-suspended")};f==="set"?Object.assign(_,{width_m:y((h=u.querySelector('input[name="width_m"]'))==null?void 0:h.value),height_m:y((v=u.querySelector('input[name="height_m"]'))==null?void 0:v.value),style:((q=u.querySelector('select[name="set_style"]'))==null?void 0:q.value)||"",fabric_variant:((T=u.querySelector('select[name="fabric_variant"]'))==null?void 0:T.value)||"",price_per_m_raw:y((L=u.querySelector('select[name="set_price_per_m"]'))==null?void 0:L.value),sheer_price_per_m:y(($=u.querySelector('select[name="sheer_price_per_m"]'))==null?void 0:$.value),fabric_code:((E=u.querySelector('input[name="fabric_code"]'))==null?void 0:E.value)||"",sheer_fabric_code:((Y=u.querySelector('input[name="sheer_fabric_code"]'))==null?void 0:Y.value)||"",opening_style:((ce=u.querySelector('select[name="opening_style"]'))==null?void 0:ce.value)||"",track_color:((M=u.querySelector('select[name="track_color"]'))==null?void 0:M.value)||"",notes:((B=u.querySelector('input[name="notes"]'))==null?void 0:B.value)||""}):f==="wallpaper"?Object.assign(_,{height_m:y((S=u.querySelector('[name="wallpaper_height_m"]'))==null?void 0:S.value),wallpaper_code:((x=u.querySelector('[name="wallpaper_code"]'))==null?void 0:x.value)||"",price_per_roll:y((I=u.querySelector('[name="wallpaper_price_roll"]'))==null?void 0:I.value),install_cost_per_roll:y((R=u.querySelector('[name="wallpaper_install_cost"]'))==null?void 0:R.value),notes:((N=u.querySelector('[name="wallpaper_notes"]'))==null?void 0:N.value)||"",widths:Array.from(u.querySelectorAll('[name="wall_width_m"]')).map(We=>y(We.value))}):u.matches(".area-based-item")&&Object.assign(_,{width_m:y((D=u.querySelector('[name="area_width_m"]'))==null?void 0:D.value),height_m:y((G=u.querySelector('[name="area_height_m"]'))==null?void 0:G.value),price_sqyd:y((z=u.querySelector('[name="area_price_sqyd"]'))==null?void 0:z.value),code:((P=u.querySelector('[name="area_code"]'))==null?void 0:P.value)||"",notes:((ie=u.querySelector('[name="area_notes"]'))==null?void 0:ie.value)||""}),i.items.push(_)}),t.rooms.push(i)}),t}function A(){try{localStorage.setItem(pe,JSON.stringify(W()))}catch(e){console.error("Failed to save data to localStorage:",e)}}const k={stylePlus:e=>he.style_surcharge[e]??0,heightPlus:e=>{const t=[...he.height].sort((r,a)=>a.threshold-r.threshold);for(const r of t)if(e>r.threshold)return r.add_per_m;return 0},fabricYardage:(e,t)=>{const r=y(t);return r<=0||!e?0:e==="ตาไก่"||e==="จีบ"?(r*2+.6)/.9:e==="ลอน"?(r*2.6+.6)/.9:0},wallpaperRolls:(e,t)=>{const r=y(e),a=y(t);if(r<=0||a<=0)return 0;const s=a>2.5?Math.floor(Se.ROLL_LENGTH_M/a):Se.STRIPS_PER_ROLL_UNDER_2_5M;if(s<=0)return 0;const c=Math.ceil(r/Se.ROLL_WIDTH_M);return Math.ceil(c/s)},calculateSetPrice:function(e){var n,o;if(!e||e.is_suspended||y(e.width_m)<=0)return{total:0,opaque:0,sheer:0};const t=this.stylePlus(e.style),r=this.heightPlus(y(e.height_m)),a=y(e.width_m),s=(n=e.fabric_variant)!=null&&n.includes("ทึบ")&&y(e.price_per_m_raw)>0?(y(e.price_per_m_raw)+t+r)*a:0,c=(o=e.fabric_variant)!=null&&o.includes("โปร่ง")&&y(e.sheer_price_per_m)>0?(y(e.sheer_price_per_m)+t+r)*a:0;return{total:Math.round(s+c),opaque:Math.round(s),sheer:Math.round(c)}},calculateDecoPrice:function(e){if(!e||e.is_suspended||y(e.width_m)<=0||y(e.height_m)<=0)return{total:0,sqm:0,sqyd:0};const t=y(e.width_m)*y(e.height_m),r=t*Ye,a=r*y(e.price_sqyd);return{total:Math.round(a),sqm:t,sqyd:r}},calculateWallpaperPrice:function(e){var n;if(!e||e.is_suspended)return{total:0,material:0,install:0,rolls:0,sqm:0};const t=((n=e.widths)==null?void 0:n.reduce((o,l)=>o+y(l),0))||0;if(t<=0)return{total:0,material:0,install:0,rolls:0,sqm:0};const r=y(e.height_m),a=this.wallpaperRolls(t,r),s=a*y(e.price_per_roll),c=a*y(e.install_cost_per_roll??300);return{total:Math.round(s+c),material:Math.round(s),install:Math.round(c),rolls:a,sqm:t*r}}},ae={set:"ผ้าม่าน",wallpaper:"วอลล์เปเปอร์",wooden_blind:"มู่ลี่ไม้",roller_blind:"ม่านม้วน",vertical_blind:"ม่านปรับแสง",partition:"ฉากกั้นห้อง",pleated_screen:"มุ้งจีบ",aluminum_blind:"มู่ลี่อลูมิเนียม"};function et(e){return e.rooms.reduce((t,r)=>{var s;if(r.is_suspended)return t;const a=((s=r.items)==null?void 0:s.reduce((c,n)=>{if(n.is_suspended)return c;switch(n.type){case"set":return c+k.calculateSetPrice(n).total;case"wallpaper":return c+k.calculateWallpaperPrice(n).total;default:return c+k.calculateDecoPrice(n).total}},0))||0;return t+a},0)}function tt(e,t){const r=et(e);let a=0,s="";e.discount&&e.discount.value>0&&(e.discount.type==="percent"?(a=r*(e.discount.value/100),s=`ส่วนลด (${e.discount.value}%): -${w(a)} บาท
`):(a=e.discount.value,s=`ส่วนลด: -${w(a)} บาท
`));const c=r-a;let n=`สรุปข้อมูล (${new Date().toLocaleDateString("th-TH",{day:"numeric",month:"numeric",year:"numeric"})})
`;if(n+=`ลูกค้า: ${e.customer_name||"-"}
`,(t==="customer"||t==="owner")&&(n+=`เบอร์โทร: ${e.customer_phone||"-"}
`,n+=`ที่อยู่: ${e.customer_address||"-"}
`),n+=`------------------------------
`,t==="customer")return n+=`
สรุปรายการ
`,e.rooms.forEach(o=>{if(o.is_suspended||!o.items)return;const l=o.items.filter(d=>d.is_suspended?!1:d.type==="wallpaper"?(d.widths||[]).reduce((p,u)=>p+u,0)>0:d.width_m>0);if(l.length===0)return;n+=`
*ห้อง: ${o.room_name||"ไม่ระบุ"}*
`;let i=0;l.forEach(d=>{i++;const p=ae[d.type]||"สินค้าตกแต่ง";d.type==="set"?n+=` ${i}) ${p} ${d.style} (${d.fabric_variant})
`:n+=` ${i}) ${p}
`})}),n+=`------------------------------
`,a>0&&(n+=`
ยอดรวม: ${w(r)} บาท
`,n+=s),n+=`
สรุปยอดสุทธิ: ${w(c)} บาท
`,n+=`
ขอบคุณที่ใช้บริการ
${C.name}
โทร: ${C.phone}`,n;if(t==="purchase_order"||t==="owner"){const o={opaqueFabrics:[],sheerFabrics:[],decorations:{},wallpapers:[],allSets:[]};e.rooms.forEach(p=>{p.is_suspended||!p.items||p.items.forEach(u=>{if(!(u.is_suspended||u.width_m<=0))switch(u.type){case"set":o.allSets.push(u),u.fabric_variant.includes("ทึบ")&&o.opaqueFabrics.push({code:u.fabric_code||"??",yards:k.fabricYardage(u.style,u.width_m)}),u.fabric_variant.includes("โปร่ง")&&o.sheerFabrics.push({code:u.sheer_fabric_code||"??",yards:k.fabricYardage(u.style,u.width_m)});break;case"wallpaper":const f=(u.widths||[]).reduce((h,v)=>h+v,0);if(f>0){const h=k.wallpaperRolls(f,u.height_m);h>0&&o.wallpapers.push({code:u.wallpaper_code||"xxx",rolls:h})}break;default:const _=ae[u.type]||u.type;o.decorations[_]||(o.decorations[_]=[]),o.decorations[_].push({code:u.code||"xxx",width:u.width_m,height:u.height_m});break}})}),n+=`📋 *แจกแจงรายการสั่งซื้อ (ผ้า)*
`,n+=`------------------------------
`,o.opaqueFabrics.length>0&&o.opaqueFabrics.forEach(p=>{n+=`- ผ้าทึบ (Curtain Fabric)
`,n+=`  รหัส: #${p.code||"??"}
`,n+=`  จำนวน: ${p.yards.toFixed(2)} หลา

`}),o.sheerFabrics.length>0&&o.sheerFabrics.forEach(p=>{n+=`- ผ้าโปร่ง (Sheer Fabric)
`,n+=`  รหัส: #${p.code||"??"}
`,n+=`  จำนวน: ${p.yards.toFixed(2)} หลา

`});const l={};if([...o.opaqueFabrics,...o.sheerFabrics].forEach(p=>{l[p.code]=(l[p.code]||0)+p.yards}),Object.keys(l).length>0){n+=`------------------------------
`,n+=`📊 *สรุปยอดรวมผ้า (ตามรหัส)*
`,n+=`------------------------------
`;for(const[p,u]of Object.entries(l))n+=`  - รหัส #${p}: รวมทั้งหมด ${u.toFixed(2)} หลา
`;n+=`
`}if(n+=`------------------------------
`,n+=`📋 *สำหรับสั่งซื้อ ราง*
`,n+=`------------------------------

`,o.allSets.length>0){let p=1;o.allSets.forEach(u=>{n+=`(${p++}) รางม่าน: ${u.style}, สี: ${u.track_color}
`,u.fabric_variant.includes("ทึบ")&&(n+=`  - รางทึบ: ${Number(u.width_m).toFixed(2)} ม. (1 เส้น)
`),u.fabric_variant.includes("โปร่ง")&&(n+=`  - รางโปร่ง: ${Number(u.width_m).toFixed(2)} ม. (1 เส้น)
`),u.fabric_variant==="ทึบ&โปร่ง"&&(n+=`  (❗️ต้องใช้ขาสองชั้น)
`),n+=`
`})}const i=o.decorations;Object.keys(i).length>0&&Object.entries(i).forEach(([p,u])=>{n+=`------------------------------
`,n+=`📋 *สำหรับสั่งซื้อ ${p}*
`,n+=`------------------------------

`,u.forEach(f=>{n+=`รหัส: #${f.code||"xxx"}
`,n+=`ขนาด: ${f.width.toFixed(2)} x ${f.height.toFixed(2)} m.
`,n+=`จำนวน: 1 ชุด

`})}),n+=`------------------------------
`,n+=`📋 *แจกแจงรายการสั่งซื้อ (Wallpaper)*
`,n+=`------------------------------

`,o.wallpapers.length>0&&o.wallpapers.forEach(p=>{n+=`- วอลเปเปอร์ -
`,n+=`  รหัส: #${p.code||"xxx"}
`,n+=`  จำนวน: ${p.rolls} ม้วน

`});const d={};if(o.wallpapers.forEach(p=>{d[p.code]=(d[p.code]||0)+p.rolls}),Object.keys(d).length>0){n+=`------------------------------
`,n+=`📊 *สรุปยอดรวมวอลเปเปอร์ (ตามรหัส)*
`,n+=`------------------------------
`;for(const[p,u]of Object.entries(d))n+=`  - รหัส #${p}: รวมทั้งหมด ${u} ม้วน
`;n+=`
`}if(n+=`------------------------------
`,t==="purchase_order")return n}return(t==="seamstress"||t==="owner")&&(n+=`
🧵 *รายละเอียดสำหรับช่าง*
`,e.rooms.forEach(o=>{if(o.is_suspended||!o.items)return;const l=o.items.filter(d=>d.type==="set"&&!d.is_suspended&&d.width_m>0);if(l.length===0)return;n+=`
*ห้อง: ${o.room_name||"ไม่ระบุ"}*
`;let i=1;l.forEach(d=>{n+=`${i++}) *ผ้าม่าน ${d.style} ${d.fabric_variant}*
`,n+=`  กว้าง ${Number(d.width_m).toFixed(2)} x สูง ${Number(d.height_m).toFixed(2)} ม.
`,n+=`  รูปแบบเปิด: ${d.opening_style}
`,d.fabric_variant.includes("ทึบ")&&(n+=`  ผ้าทึบ: รหัส ${d.fabric_code||"-"}
`),d.fabric_variant.includes("โปร่ง")&&(n+=`  ผ้าโปร่ง: รหัส ${d.sheer_fabric_code||"-"}
`)})}),n+=`------------------------------
`,t==="seamstress")||t==="owner"&&(n+=`
💰 *สรุปยอดรวม: ${w(c)} บาท*
`),n}function rt(e){if(!e.rooms||e.rooms.length===0)return'<p class="empty-summary">ไม่มีข้อมูลสำหรับแสดงผล</p>';let t="";const r={};e.rooms.forEach(n=>{n.is_suspended||!n.items||n.items.forEach(o=>{if(o.is_suspended)return;let l=null,i=0;switch(o.type){case"set":i=k.calculateSetPrice(o).total,i>0&&(l=o.type);break;case"wallpaper":i=k.calculateWallpaperPrice(o).total,i>0&&(l=o.type);break;default:i=k.calculateDecoPrice(o).total,i>0&&(l=o.type);break}l&&(r[l]=(r[l]||0)+1)})});const a=Object.entries(r).map(([n,o])=>{const l=ae[n]||"ของตกแต่ง";return`
            <span class="summary-tag" data-filter-type="${b(n)}" title="คลิกเพื่อกรองเฉพาะรายการนี้">
                ${b(l)} <strong>${o}</strong>
            </span>`}).join("");a&&(t+=`
            <div class="overview-summary-group">
                <h4><i class="ph ph-stack"></i> สรุปประเภทรายการ</h4>
                <div class="summary-tags-container">
                    ${a}
                </div>
            </div>`);let s="",c=0;return e.rooms.forEach(n=>{if(n.is_suspended||!n.items)return;const o={};let l=0;if(n.items.forEach(i=>{if(i.is_suspended)return;let d=null,p=0;switch(i.type){case"set":p=k.calculateSetPrice(i).total,p>0&&(d=i.type);break;case"wallpaper":p=k.calculateWallpaperPrice(i).total,p>0&&(d=i.type);break;default:p=k.calculateDecoPrice(i).total,p>0&&(d=i.type);break}d&&(o[d]=(o[d]||0)+1,l++)}),l>0){c+=l;const i=Object.entries(o).map(([d,p])=>`
                    <div class="overview-item">
                        <span>${b(ae[d]||"ของตกแต่ง")}</span>
                        <span>${p}</span>
                    </div>`).join("");s+=`
                <details class="overview-room-card">
                    <summary class="overview-room-summary">
                        <span class="room-name">${b(n.room_name)||"ไม่ระบุชื่อห้อง"}</span>
                        <div class="summary-tags">
                            <span class="room-item-count">${l} รายการ</span>
                            <i class="ph ph-caret-down expand-icon"></i>
                        </div>
                    </summary>
                    <div class="overview-room-items">${i}</div>
                </details>`}}),s&&(t+=`
            <div class="overview-breakdown-group">
                <h4><i class="ph ph-map-pin-line"></i> แจกแจงตามห้อง</h4>
                ${s}
            </div>`),c===0?'<p class="empty-summary">ไม่มีรายการสำหรับแสดงผล</p>':t}function ot(e,t){const{vatRate:r,pageBreakBuffer:a=3}=t,s=[];e.rooms.forEach(M=>{if(M.is_suspended||!M.items)return;const B=[];M.items.forEach(S=>{if(S.is_suspended)return;let x,I,R,N;const D=ae[S.type]||"สินค้าตกแต่ง";switch(S.type){case"set":I=k.calculateSetPrice(S).total,I>0&&(R=S.width_m||0,N=S.height_m||0,x=`${D} ${b(S.style)} (${b(S.fabric_variant)}) <br><small>ขนาด ${R.toFixed(2)} x ${N.toFixed(2)} ม.${S.notes?` - ${b(S.notes)}`:""}</small>`,B.push({description:x,total:I,units:x.includes("<br>")?1.5:1}));break;case"wallpaper":if(I=k.calculateWallpaperPrice(S).total,I>0){const G=(S.widths||[]).reduce((P,ie)=>P+ie,0),z=k.wallpaperRolls(G,S.height_m);N=S.height_m||0,x=`${D} <br><small>รหัส: ${b(S.wallpaper_code)||"-"}, สูง ${N.toFixed(2)} ม. (ใช้ ${z} ม้วน)</small>`,B.push({description:x,total:I,units:x.includes("<br>")?1.5:1})}break;default:I=k.calculateDecoPrice(S).total,I>0&&(R=S.width_m||0,N=S.height_m||0,x=`${D} <br><small>รหัส: ${b(S.code)||"-"}, ขนาด ${R.toFixed(2)} x ${N.toFixed(2)} ม.</small>`,B.push({description:x,total:I,units:x.includes("<br>")?1.5:1}));break}}),B.length>0&&(s.push({isRoomHeader:!0,roomName:b(M.room_name)||"ไม่ระบุชื่อห้อง",units:1.2}),s.push(...B))});const c=s.reduce((M,B)=>M+(B.total||0),0);if(c===0)return null;let n=0,o="",l=c;e.discount&&e.discount.value>0&&(e.discount.type==="percent"?(n=c*(e.discount.value/100),o=`<tr><td class="pdf-label">ส่วนลด (${e.discount.value}%)</td><td class="pdf-amount">-${F(n,2,!0)}</td></tr>`):(n=e.discount.value,o=`<tr><td class="pdf-label">ส่วนลด</td><td class="pdf-amount">-${F(n,2,!0)}</td></tr>`),l=c-n,o+=`<tr><td class="pdf-label">ยอดหลังหักส่วนลด</td><td class="pdf-amount">${F(l,2,!0)}</td></tr>`);const i=l*r,d=l+i,p=17,u=23,f=[];let _=[],h=0;s.forEach((M,B)=>{const S=f.length===0?p:u,x=h+M.units>S;let I=!1;if(!x&&B<s.length-1){const R=S-(h+M.units);R>0&&R<a&&(I=!0)}(x||I)&&_.length>0&&(f.push(_),_=[],h=0),_.push(M),h+=M.units}),_.length>0&&f.push(_);const v=new Date,q=v.toLocaleDateString("th-TH",{year:"numeric",month:"long",day:"numeric"}),T=`QT-${v.getFullYear()}${(v.getMonth()+1).toString().padStart(2,"0")}${v.getDate().toString().padStart(2,"0")}`;let L="",$=0,E=1;f.forEach((M,B)=>{const S=B===0,x=B===f.length-1,I=`
            <div class="pdf-page-header">
                <div class="pdf-header">
                    <div class="pdf-shop-info">
                        ${`<img src="${C.logoUrl}" alt="Logo" class="pdf-logo">`}
                        <div class="pdf-shop-address">
                            <strong>${b(C.name)}</strong><br>
                            ${b(C.address).replace(/\n/g,"<br>")}<br>
                            โทร: ${b(C.phone)} | เลขประจำตัวผู้เสียภาษี: ${b(C.taxId)}
                        </div>
                    </div>
                    <div class="pdf-quote-details">
                        <div class="pdf-title-box"><h1>ใบเสนอราคา ${f.length>1?S?"":"(ต่อ)":""}</h1></div>
                        <table class="pdf-quote-meta">
                            <tr><td>เลขที่:</td><td>${T}</td></tr>
                            <tr><td>วันที่:</td><td>${q}</td></tr>
                        </table>
                    </div>
                </div>
                ${S?`
                <section class="pdf-customer-details">
                    <div class="pdf-customer-info">
                        <strong>ลูกค้า:</strong> ${b(e.customer_name)||""}<br>
                        <strong>ที่อยู่:</strong> ${b(e.customer_address).replace(/\n/g,"<br>")||""}<br>
                        <strong>โทร:</strong> ${b(e.customer_phone)||""}
                    </div>
                    <div class="pdf-customer-meta">
                        <strong>เงื่อนไขชำระเงิน:</strong> ${b(C.pdf.paymentTerms)}<br>
                        <strong>ยืนราคา:</strong> ${b(C.pdf.priceValidity)}
                    </div>
                </section>`:""}
            </div>`,R=`
            <div class="pdf-page-footer">
                <div class="pdf-footer-info">
                    <span>${b(C.name)} | โทร: ${b(C.phone)}</span>
                    <span>หน้า ${B+1} / ${f.length}</span>
                </div>
            </div>`;let N="";S||(N+=`<tr class="pdf-subtotal-row"><td colspan="4">ยอดยกมา (Brought Forward)</td><td class="pdf-text-right">${F($,2,!0)}</td></tr>`),M.forEach(P=>{P.isRoomHeader?N+=`<tr class="pdf-room-header"><td colspan="5">ห้อง: ${P.roomName}</td></tr>`:(N+=`<tr><td class="pdf-text-center">${E++}</td><td>${P.description}</td><td class="pdf-text-center">1</td><td class="pdf-text-right">${F(P.total,2,!0)}</td><td class="pdf-text-right">${F(P.total,2,!0)}</td></tr>`,$+=P.total)});let D="";x||(D=`<tfoot><tr class="pdf-subtotal-row"><td colspan="4">ยอดยกไป (Carried Forward)</td><td class="pdf-text-right">${F($,2,!0)}</td></tr></tfoot>`);let G="";C.pdf.notes&&C.pdf.notes.length>0&&(G=`
                <strong>หมายเหตุ:</strong>
                <ul>${C.pdf.notes.map(P=>`<li>${b(P)}</li>`).join("")}</ul>
            `);const z=x?`
            <div class="pdf-summary-wrapper">
                <section class="pdf-summary-section">
                    <div class="pdf-amount-in-words">
                        ${G}
                        <div class="pdf-amount-text">( ${Qe(d)} )</div>
                    </div>
                    <div class="pdf-totals-block">
                        <table>
                            <tr><td class="pdf-label">รวมเป็นเงิน</td><td class="pdf-amount">${F(c,2,!0)}</td></tr>
                            ${o}
                            ${r>0?`<tr><td class="pdf-label">ภาษีมูลค่าเพิ่ม ${(r*100).toFixed(0)}%</td><td class="pdf-amount">${F(i,2,!0)}</td></tr>`:""}
                            <tr class="pdf-grand-total"><td class="pdf-label">ยอดรวมสุทธิ</td><td class="pdf-amount">${F(d,2,!0)}</td></tr>
                        </table>
                    </div>
                </section>
                <footer class="pdf-footer-section">
                    <div class="pdf-signature-box"><p>.................................................</p><p>ผู้เสนอราคา</p><p>(${b(C.name)})</p><p>วันที่: ${q}</p></div>
                    <div class="pdf-signature-box"><p>.................................................</p><p>ลูกค้า / ผู้มีอำนาจลงนาม</p><p>&nbsp;</p><p>วันที่: ......./......./............</p></div>
                </footer>
            </div>
        `:"";L+=`
            <div class="pdf-page">
                <div class="pdf-page-content">
                    ${I}
                    <div class="pdf-page-body">
                        <table class="pdf-items-table">
                            <thead><tr><th style="width:5%;">ลำดับ</th><th style="width:50%;">รายการ</th><th style="width:10%;">จำนวน</th><th style="width:17.5%;">ราคา/หน่วย</th><th style="width:17.5%;">รวม (บาท)</th></tr></thead>
                            <tbody>${N}</tbody>
                            ${D}
                        </table>
                        ${z}
                    </div>
                    ${R}
                </div>
            </div>`});const Y=e.customer_name||"quote",ce=Pe(Y);return{html:`<div id="quotation-template">${L}</div>`,fileName:`${T}_${ce}`}}const re=[],nt=10;function ve(e){re.push(e),re.length>nt&&re.shift()}function at(){return re.pop()}function st(){return re.length>0}let j=!1,ye=null,ue=null,oe=!1,O=null,we=null,qe=!1;const Ae=document.querySelector("#undoBtn"),de={};function lt(e){if(de[e])return de[e];const t=new Promise((r,a)=>{const s=document.createElement("script");s.src=e,s.onload=()=>{console.log(`${e} loaded successfully.`),r()},s.onerror=()=>{console.error(`Script load error for ${e}`),delete de[e],a(new Error(`Script load error for ${e}`))},document.head.appendChild(s)});return de[e]=t,t}const se={set:{templateId:"#setTpl",name:"ผ้าม่าน"},wallpaper:{templateId:"#wallpaperTpl",name:"วอลล์เปเปอร์"},wooden_blind:{templateId:"#areaBasedTpl",name:"มู่ลี่ไม้"},roller_blind:{templateId:"#areaBasedTpl",name:"ม่านม้วน"},vertical_blind:{templateId:"#areaBasedTpl",name:"ม่านปรับแสง"},partition:{templateId:"#areaBasedTpl",name:"ฉากกั้นห้อง"},pleated_screen:{templateId:"#areaBasedTpl",name:"มุ้งจีบ"},aluminum_blind:{templateId:"#areaBasedTpl",name:"มู่ลี่อลูมิเนียม"}},ct={มู่ลี่ไม้:"wooden_blind",ม่านม้วน:"roller_blind",ม่านปรับแสง:"vertical_blind",ฉากกั้นห้อง:"partition",มุ้งจีบ:"pleated_screen",มู่ลี่อลูมิเนียม:"aluminum_blind"},$e="marnthara.theme";function Fe(){const e=localStorage.getItem($e),t=document.querySelector("#themeToggleBtn");if(!t)return;const r=t.querySelector("i"),a=t.querySelector("span");switch(document.body.classList.remove("dark-theme","neutral-theme"),e){case"dark":document.body.classList.add("dark-theme"),r&&(r.className="ph-fill ph-sun"),a&&(a.textContent=" สว่าง");break;case"neutral":document.body.classList.add("neutral-theme"),r&&(r.className="ph-fill ph-moon"),a&&(a.textContent=" มืด");break;default:r&&(r.className="ph-fill ph-palette"),a&&(a.textContent=" กลาง");break}}function it(){const e=localStorage.getItem($e);let t;!e||e==="light"?t="neutral":e==="neutral"?t="dark":t="light",localStorage.setItem($e,t),Fe()}function X(){Ae&&(Ae.disabled=!st())}function ut(){const e=at();e&&(xe(e),g("ยกเลิกการกระทำล่าสุดแล้ว","success")),X()}function dt(e,t){if(!e)return;const r=document.getElementById("filterStatusBar");r&&(r.innerHTML=`
            <span>แสดงผลเฉพาะ: <strong>${b(t)}</strong></span>
            <button type="button" class="btn-chip" data-act="clear-filter" title="ยกเลิกการกรอง">
                <i class="ph ph-x"></i>&nbsp;ปิด
            </button>
        `,r.classList.add("is-visible"),r.dataset.filterType=e),document.querySelectorAll(m.room).forEach(a=>{let s=0;a.querySelectorAll(".item-card").forEach(c=>{const n=c.dataset.type===e;c.classList.toggle("item-hidden",!n),n&&s++}),a.classList.toggle("item-hidden",s===0)}),K(),U()}function pt(){const e=document.getElementById("filterStatusBar");e&&(e.classList.remove("is-visible"),e.innerHTML="",e.removeAttribute("data-filter-type")),document.querySelectorAll(".item-hidden").forEach(t=>t.classList.remove("item-hidden")),K(),U()}function _e(){document.querySelectorAll(".favorite-chips-container.show").forEach(e=>{e.classList.remove("show")})}function Oe(e){var o;const t=e.dataset.favoriteType,r=(o=e.closest(".form-group-with-favorites"))==null?void 0:o.querySelector(".favorite-chips-container");if(!t||!r)return;_e();const s=Z()[t]||[];let n=Array.from(s.reduce((l,i)=>{const d=i.code.trim();return d&&!l.has(d.toLowerCase())&&l.set(d.toLowerCase(),i),l},new Map).values()).map(l=>`<button type="button" class="btn-chip" data-code="${b(l.code)}" data-price="${l.price}">${b(l.code)}</button>`).join("");n+=`<button type="button" class="btn-manage-favorites" data-act="manage-favorites" data-type="${t}"><i class="ph ph-pencil-simple"></i> จัดการรายการโปรด</button>`,r.innerHTML=n,r.classList.add("show")}function mt(e){const t=e.closest(".favorite-chips-container"),r=e.closest(".form-group-with-favorites"),a=e.closest(".item-card");if(!t||!r||!a)return;const s=e.dataset.code,c=y(e.dataset.price),n=r.querySelector("input[data-favorite-type]");n&&(n.value=s,n.classList.add("input-highlight"),setTimeout(()=>n.classList.remove("input-highlight"),1200));const o=n.dataset.favoriteType;let l;o==="fabric"?l="set_price_per_m":o==="sheer"?l="sheer_price_per_m":o==="wallpaper"?l="wallpaper_price_roll":l="area_price_sqyd";const i=a.querySelector(`[name="${l}"]`);i&&c>0&&(i.tagName==="SELECT"?i.value=c:(i.value=w(c),i.classList.add("input-highlight"),setTimeout(()=>i.classList.remove("input-highlight"),1200))),ge(n),Q(a),A(),_e()}function fe(e){const t=document.querySelector("#favManagerBody"),r=document.querySelector("#favManagerItemTpl"),s=Z()[e]||[];!t||!r||(s.length===0?t.innerHTML='<p class="empty-state" style="text-align: center; padding: 2rem; color: var(--on-surface-variant);">ไม่มีรายการโปรดที่บันทึกไว้</p>':t.innerHTML=s.map(c=>r.innerHTML.replace(/{CODE}/g,b(c.code)).replace(/{PRICE}/g,w(c.price)).replace(/{RAW_PRICE}/g,c.price)).join(""),ke(null))}function ke(e){const t=document.querySelector('[data-act="edit-selected-fav"]'),r=document.querySelector('[data-act="del-selected-fav"]');!t||!r||(e?(t.disabled=!1,r.disabled=!1,O={code:e.dataset.code,price:y(e.dataset.price)}):(t.disabled=!0,r.disabled=!0,O=null))}async function ft(e){const t=document.querySelector("#favManagerModal");if(!t||!e)return;const r={fabric:"ผ้าทึบ",sheer:"ผ้าโปร่ง",wallpaper:"วอลล์เปเปอร์",wooden_blind:"มู่ลี่ไม้",roller_blind:"ม่านม้วน",vertical_blind:"ม่านปรับแสง",partition:"ฉากกั้นห้อง",pleated_screen:"มุ้งจีบ",aluminum_blind:"มู่ลี่อลูมิเนียม",deco:"ของตกแต่ง"};t.dataset.currentType=e,oe=!1,O=null,document.querySelector("#favManagerTitle").textContent=`จัดการ '${r[e]||e}'`,fe(e),await V("#favManagerModal",()=>{oe&&ye&&Oe(ye)})}function g(e,t="default"){const r=document.querySelector(m.toastContainer);if(!r)return;const a={success:"ph-bold ph-check-circle",warning:"ph-bold ph-warning",error:"ph-bold ph-x-circle",default:"ph-bold ph-info"},s=document.createElement("div");s.className=`toast toast-${t}`,s.innerHTML=`<i class="${a[t]||a.default}"></i> ${e}`,r.appendChild(s),setTimeout(()=>s.classList.add("show"),10),setTimeout(()=>{s.classList.remove("show"),s.addEventListener("transitionend",()=>s.remove())},3e3)}function V(e,t){return new Promise(r=>{const a=document.querySelector(e);if(!a){r(null);return}const s=document.querySelector(".modal-wrapper.visible");s&&s.classList.add("is-underlay"),a.classList.add("visible");const c=a.querySelector('[id$="Confirm"]'),n=a.querySelector('[id$="Cancel"], [data-act="close-modal"]'),o=Array.from(a.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])')).filter(u=>!u.disabled&&u.offsetParent!==null),l=o[0],i=o[o.length-1];setTimeout(()=>l==null?void 0:l.focus(),50);const d=u=>{if(u.key==="Escape"&&!a.classList.contains("is-underlay")){p({cancelled:!0});return}if(u.key==="Tab"){if(o.length<=1){u.preventDefault();return}u.shiftKey?document.activeElement===l&&(i.focus(),u.preventDefault()):document.activeElement===i&&(l.focus(),u.preventDefault())}},p=u=>{a.classList.remove("visible"),document.removeEventListener("keydown",d),c&&(c.onclick=null),n&&(n.onclick=null),s&&s.classList.remove("is-underlay"),typeof u=="object"&&u.cancelled&&t&&t(),r(u)};c&&(c.onclick=()=>p(!0)),n&&(n.onclick=()=>{a.classList.contains("is-underlay")||p({cancelled:!0})}),document.addEventListener("keydown",d)})}async function ne(e,t){const r=document.querySelector(m.modal);return r?(r.querySelector(m.modalTitle).textContent=e,r.querySelector(m.modalBody).textContent=t,await V(m.modal)===!0):!0}async function ht(){var r,a,s;const e=document.querySelector(m.exportOptionsModal);if(!e)return null;const t=await V(m.exportOptionsModal);return!t||t.cancelled?null:{vatOption:((r=e.querySelector('input[name="vat_option"]:checked'))==null?void 0:r.value)||"include",exportMethod:((a=e.querySelector("#exportMethod"))==null?void 0:a.value)||"direct",pageBreakBuffer:parseInt((s=e.querySelector("#pageBreakBuffer"))==null?void 0:s.value,10)||3}}async function vt(){const e=document.querySelector("#discountModal");if(!e)return;const t=e.querySelector("#discountSubtotal"),r=e.querySelector("#discountPercent"),a=e.querySelector("#discountAmount"),s=e.querySelector("#discountFinalTotal"),c=document.querySelector("#discount_type"),n=document.querySelector("#discount_value"),o=y(document.querySelector("#originalTotal").dataset.rawTotal||document.querySelector("#grandTotal").textContent);t.textContent=w(o);const l=u=>{if(qe)return;qe=!0;let f=0;if(u==="percent"){const _=y(r.value);f=o*((_>=0?_:0)/100),a.value=f>0?w(Math.round(f)):""}else f=y(a.value);if(f=f>=0?Math.min(f,o):0,u!=="percent"){const _=o>0?f/o*100:0;r.value=_>0&&isFinite(_)?F(_,2):""}s.textContent=w(o-f),setTimeout(()=>{qe=!1},20)};r.addEventListener("input",()=>l("percent")),a.addEventListener("input",()=>l("amount")),a.addEventListener("focus",u=>{y(u.target.value)>0&&(u.target.value=y(u.target.value))}),a.addEventListener("blur",u=>{y(u.target.value)>0&&(u.target.value=w(y(u.target.value))),l("amount")});const i=c.value,d=y(n.value);r.value="",a.value="",d>0?i==="percent"?(r.value=d,l("percent")):(a.value=w(d),l("amount")):l();const p=await V("#discountModal");if(p&&!p.cancelled){const u=y(r.value),f=y(a.value);document.activeElement===r&&u>0?(c.value="percent",n.value=u):f>0?(c.value="amount",n.value=f):(c.value="amount",n.value=0),H(),A()}}function Le(e,t,r){e&&(ve(W()),X(),e.classList.add("item-removing"),e.addEventListener("animationend",()=>{e.remove(),t&&g(t),r&&r(),le(),K(),H(),A(),ee()},{once:!0}))}function K(){document.querySelectorAll(m.room).forEach(e=>{const t=e.querySelectorAll(".item-card:not(.is-suspended):not(.item-hidden)"),r=t.length;t.forEach((s,c)=>{const n=s.querySelector("[data-item-title]");n&&(n.textContent=`${c+1}/${r}`)}),e.querySelectorAll(".item-card.is-suspended, .item-card.item-hidden").forEach(s=>{const c=s.querySelector("[data-item-title]");c&&(c.textContent="-")})})}function Re(){const e=document.querySelector(m.orderForm),t=document.querySelector(m.lockBtn);!e||!t||(e.classList.toggle("is-locked",j),t.classList.toggle("is-locked",j),t.querySelector("i").className=j?"ph-bold ph-lock-key":"ph-bold ph-lock-key-open",e.querySelectorAll("input, select, textarea, button").forEach(r=>{r.closest(".summary-footer")||r.closest(".main-header")||r.closest(".modal-wrapper")||r.dataset.act==="toggle-more-details"||(r.disabled=j)}),g(j?"ฟอร์มถูกล็อค":"ปลดล็อคฟอร์มแล้ว",j?"warning":"success"))}function U(){const e=document.querySelectorAll(m.room);if(e.length===0)return;const t=[...e].some(a=>a.open),r=document.querySelector(m.toggleAllRoomsBtn);r&&(r.querySelector("i").className="ph ph-rows",r.querySelector("span").textContent=t?"ย่อ":"ขยาย")}function yt(){const e=document.querySelectorAll(m.room),t=[...e].some(r=>r.open);e.forEach(r=>{r.open=!t}),setTimeout(()=>{U(),A()},50)}function le(){const e=document.querySelector(m.quickNavRoomList);e&&(e.innerHTML="",document.querySelectorAll(m.room).forEach(t=>{var s;const r=((s=t.querySelector(m.roomNameInput))==null?void 0:s.value)||"ห้อง",a=document.createElement("a");a.href=`#${t.id}`,a.dataset.jumpTo=t.id,a.innerHTML=`<i class="ph ph-arrow-bend-left-up"></i> ${r}`,e.appendChild(a)}))}function He(e){var r;const t=document.getElementById("quickNavBtnText");t&&(e?t.textContent=((r=e.querySelector('input[name="room_name"]'))==null?void 0:r.value)||"...":t.textContent="ไปยังห้อง")}function ee(){if(ue&&ue.disconnect(),!document.getElementById("quickNavBtnText"))return;const e={root:null,rootMargin:"-60px 0px -150px 0px",threshold:0},t=r=>{const a=r.filter(s=>s.isIntersecting).sort((s,c)=>s.target.getBoundingClientRect().top-c.target.getBoundingClientRect().top);a.length>0&&He(a[0].target)};ue=new IntersectionObserver(t,e),document.querySelectorAll(m.room).forEach(r=>ue.observe(r))}function ge(e){if(!e)return;const t=e.nextElementSibling;if(!t||!t.matches(".btn-favorite")||!e.closest(".item-card"))return;const a=e.dataset.favoriteType,s=e.value;t.classList.toggle("is-favorite",Xe(a,s))}function Be(e,t){const r=se[e];if(!r)return null;const a=document.querySelector(r.templateId);if(!a||!t)return null;const s=a.content.cloneNode(!0),c=s.firstElementChild;c.dataset.type=e,c.classList.add(`${e.replace(/_/g,"-")}-item`);const n=c.querySelector(".item-type-display");if(n&&(n.textContent=r.name),r.templateId==="#areaBasedTpl"){const o=c.querySelector("input[data-favorite-type]");o&&(o.dataset.favoriteType=e)}return t.appendChild(s),c}function _t(e,t){var s;if(!t)return;const r=t.querySelector(m.allItemsContainer);if(!r)return;_e();const a=Be(e,r);if(a){if(e==="wallpaper"){const c=Ce(a.querySelector('[data-act="add-wall"]'));c&&((s=c.querySelector("input"))==null||s.focus())}else{const c=a.querySelector('input:not([type="hidden"]), select, textarea');c&&c.focus()}a.classList.add("item-created"),a.scrollIntoView({behavior:"smooth",block:"center"}),K(),H(),A()}}async function Ne(e,t=null){const r=document.querySelector("#itemTypeModal");if(!r)return null;r.querySelector("#itemTypeModalTitle").textContent=e;let a=t;t&&!se[t]&&(a="wooden_blind");const s=r.querySelector(`input[name="item_type_option"][value="${a||"set"}"]`);s&&(s.checked=!0);const c=await V("#itemTypeModal");if(!c||c.cancelled)return null;const n=r.querySelector('input[name="item_type_option"]:checked');return n?n.value:null}function gt(e,t){if(!se[t])return;const a=e.parentElement;a&&(e.classList.add("item-removing"),e.addEventListener("animationend",()=>{var c;const s=Be(t,a);s&&(e.replaceWith(s),s.classList.add("item-created"),s.scrollIntoView({behavior:"smooth",block:"center"}),(c=s.querySelector('input:not([type="hidden"]), select, textarea'))==null||c.focus(),K(),H(),A(),g("เปลี่ยนประเภทรายการแล้ว","success"))},{once:!0}))}function te(){const e=document.querySelector(m.roomsContainer);if(!e)return;const t=document.querySelector("#roomTpl");if(!t)return;const r=Array.from(document.querySelectorAll(m.roomNameInput)).map(o=>parseInt(o.value.replace(/[^0-9]/g,""),10)).filter(o=>!isNaN(o)),s=(r.length>0?Math.max(...r):0)+1,n=t.content.cloneNode(!0).firstElementChild;e.appendChild(n),n&&(n.id=`room-${Date.now()}`,n.querySelector(m.roomNameInput).value=`ห้อง ${s}`,n.open=!0,n.classList.add("item-created"),n.scrollIntoView({behavior:"smooth",block:"center"})),le(),U(),ee()}function Ce(e){var r;const t=(r=e==null?void 0:e.closest(".walls-section"))==null?void 0:r.querySelector(m.wallsContainer);if(t){const s=document.querySelector("#wallTpl").content.cloneNode(!0),c=s.firstElementChild;return t.appendChild(s),c.classList.add("item-created"),Q(e),c}return null}function Q(e){var n,o,l,i,d,p,u,f,_,h,v,q;if(!e)return;const t=e.closest(".item-card");if(!t){H();return}const r=t.dataset.type;let a,s,c;switch(r){case"set":a=t.querySelector("[data-set-summary]"),s={width_m:(n=t.querySelector('input[name="width_m"]'))==null?void 0:n.value,height_m:(o=t.querySelector('input[name="height_m"]'))==null?void 0:o.value,style:(l=t.querySelector('select[name="set_style"]'))==null?void 0:l.value,fabric_variant:(i=t.querySelector('select[name="fabric_variant"]'))==null?void 0:i.value,price_per_m_raw:(d=t.querySelector('select[name="set_price_per_m"]'))==null?void 0:d.value,sheer_price_per_m:(p=t.querySelector('select[name="sheer_price_per_m"]'))==null?void 0:p.value},c=k.calculateSetPrice(s),t.dataset.totalPrice=c.total;let T=`ราคา: <b>${w(c.total)}</b> บ.`;c.opaque>0&&c.sheer>0&&(T+=` <small>(ทึบ: ${w(c.opaque)}, โปร่ง: ${w(c.sheer)})</small>`),a&&(a.innerHTML=T);break;case"wallpaper":a=t.querySelector("[data-wallpaper-summary]"),s={height_m:(u=t.querySelector('input[name="wallpaper_height_m"]'))==null?void 0:u.value,price_per_roll:(f=t.querySelector('input[name="wallpaper_price_roll"]'))==null?void 0:f.value,install_cost_per_roll:(_=t.querySelector('input[name="wallpaper_install_cost"]'))==null?void 0:_.value,widths:Array.from(t.querySelectorAll('input[name="wall_width_m"]')).map(E=>E.value)},c=k.calculateWallpaperPrice(s),t.dataset.totalPrice=c.total;let L=`รวม: <b>${w(c.total)}</b> บ. `;(c.material>0||c.install>0)&&(L+=`<small>(วอลล์: ${w(c.material)}, ค่าช่าง: ${w(c.install)})</small>`),c.rolls>0&&(L+=` &bull; พื้นที่: ${F(c.sqm,2)} ตร.ม. &bull; ใช้: ${c.rolls} ม้วน`),a&&(a.innerHTML=L);break;default:a=t.querySelector("[data-area-summary]"),s={width_m:(h=t.querySelector('input[name="area_width_m"]'))==null?void 0:h.value,height_m:(v=t.querySelector('input[name="area_height_m"]'))==null?void 0:v.value,price_sqyd:(q=t.querySelector('input[name="area_price_sqyd"]'))==null?void 0:q.value},c=k.calculateDecoPrice(s),t.dataset.totalPrice=c.total;let $="";c.sqyd>0&&($=` &bull; พื้นที่: ${F(c.sqyd,2)} ตร.หลา`),a&&(a.innerHTML=`ราคา: <b>${w(c.total)}</b> บ.${$}`);break}H()}function H(){let e=0;document.querySelectorAll(m.room).forEach(n=>{let o=0,l=0;const i=n.classList.contains("is-suspended");n.querySelectorAll(".item-card").forEach(p=>{const u=y(p.dataset.totalPrice),f=p.classList.contains("is-suspended");!i&&!f&&(o+=u,u>0&&l++)});const d=n.querySelector("[data-room-brief]");d&&(i?d.textContent="(ระงับชั่วคราว)":l>0?d.innerHTML=`<span>${l}</span> &bull; ${w(o)} บาท`:d.innerHTML="<span>0</span> รายการ"),i||(e+=o)});const t=document.querySelector("#discount_type").value,r=y(document.querySelector("#discount_value").value);let a=0;r>0&&(a=t==="percent"?e*(r/100):r);const s=e-a;document.querySelector("#grandTotal").textContent=w(s);const c=document.querySelector("#originalTotal");a>0?(c.textContent=w(e),c.dataset.rawTotal=e,c.style.display="block"):(c.style.display="none",c.dataset.rawTotal="")}function xe(e){if(e!=null&&e.favorites&&(Ke(e.favorites)?g("นำเข้ารายการโปรดสำเร็จ","success"):g("ข้อมูลรายการโปรดในไฟล์ไม่ถูกต้อง","warning")),!(e!=null&&e.rooms)||!Array.isArray(e.rooms)){e.favorites||g("ไม่พบข้อมูลสำหรับนำเข้าในไฟล์","error");return}const t=document.querySelector(m.roomsContainer);t&&(t.innerHTML="",document.querySelector("#customer_name").value=e.customer_name||"",document.querySelector("#customer_phone").value=e.customer_phone||"",document.querySelector("#customer_address").value=e.customer_address||"",e.discount&&(document.querySelector("#discount_type").value=e.discount.type||"amount",document.querySelector("#discount_value").value=e.discount.value||0),document.querySelector("#customerDetailsCard").open=e.customer_card_open??!0,e.rooms.forEach(r=>{const a=document.querySelector("#roomTpl");if(!a)return;const c=a.content.cloneNode(!0).firstElementChild;if(t.appendChild(c),!c)return;c.id=r.id||`room-${Date.now()}`,r.is_suspended&&c.classList.add("is-suspended"),c.open=r.is_open===!0,c.querySelector(m.roomNameInput).value=r.room_name||"ห้อง (ไม่มีชื่อ)";const n=c.querySelector(m.allItemsContainer);!n||!r.items||r.items.forEach(o=>{var i,d,p;o.type==="deco"&&o.deco_type?(o.type=ct[o.deco_type]||"wooden_blind",o.code=o.deco_code,o.width_m=o.deco_width_m,o.height_m=o.deco_height_m,o.price_sqyd=o.deco_price_sqyd,o.notes=o.deco_notes):o.type==="deco"&&(o.type="wooden_blind",o.code=o.deco_code);const l=Be(o.type,n);if(l)switch(o.is_suspended&&l.classList.add("is-suspended"),o.type){case"set":l.querySelector('input[name="width_m"]').value=J(o.width_m),l.querySelector('input[name="height_m"]').value=J(o.height_m),l.querySelector('select[name="set_style"]').value=o.style||o.set_style||"ลอน",l.querySelector('select[name="fabric_variant"]').value=o.fabric_variant||"ทึบ",l.querySelector('select[name="set_price_per_m"]').value=o.price_per_m_raw||o.set_price_per_m||"",l.querySelector('select[name="sheer_price_per_m"]').value=o.sheer_price_per_m||"",l.querySelector('select[name="opening_style"]').value=o.opening_style||"แยกกลาง",l.querySelector('select[name="track_color"]').value=o.track_color||"ขาว",l.querySelector('input[name="fabric_code"]').value=o.fabric_code||"",l.querySelector('input[name="sheer_fabric_code"]').value=o.sheer_fabric_code||"",l.querySelector('input[name="notes"]').value=o.notes||"";const u=(o.fabric_variant||"").includes("โปร่ง");(i=l.querySelector(m.sheerWrap))==null||i.classList.toggle("hidden",!u),(d=l.querySelector(m.sheerCodeWrap))==null||d.classList.toggle("hidden",!u);break;case"wallpaper":l.querySelector('input[name="wallpaper_height_m"]').value=J(o.height_m||o.wallpaper_height_m),l.querySelector('input[name="wallpaper_code"]').value=o.wallpaper_code||"";const f=y(o.price_per_roll||o.wallpaper_price_roll);l.querySelector('input[name="wallpaper_price_roll"]').value=f>0?w(f):"",l.querySelector('input[name="wallpaper_install_cost"]').value=o.hasOwnProperty("install_cost_per_roll")?w(o.install_cost_per_roll):o.wallpaper_install_cost?w(o.wallpaper_install_cost):"300",l.querySelector('input[name="wallpaper_notes"]').value=o.notes||o.wallpaper_notes||"",l.querySelector(m.wallsContainer)&&o.widths&&o.widths.forEach(h=>{const v=Ce(l.querySelector('[data-act="add-wall"]'));v&&(v.querySelector('input[name="wall_width_m"]').value=J(h))});break;default:if(((p=se[o.type])==null?void 0:p.templateId)==="#areaBasedTpl"){l.querySelector('input[name="area_width_m"]').value=J(o.width_m),l.querySelector('input[name="area_height_m"]').value=J(o.height_m);const h=y(o.price_sqyd);l.querySelector('input[name="area_price_sqyd"]').value=h>0?w(h):"",l.querySelector('input[name="area_code"]').value=o.code||"",l.querySelector('input[name="area_notes"]').value=o.notes||""}break}})}),document.querySelectorAll("input[data-favorite-type]").forEach(ge),document.querySelectorAll(".item-card").forEach(r=>Q(r)),K(),H(),le(),U(),ee(),g("นำเข้าข้อมูลฟอร์มสำเร็จ","success"))}function St(e){if(document.getElementById("loading-overlay"))return;const t=document.createElement("div");t.id="loading-overlay",t.innerHTML=`<div class="loading-spinner"></div><p>${e}</p>`,document.body.appendChild(t),document.body.style.overflow="hidden"}function bt(){const e=document.getElementById("loading-overlay");e&&e.remove(),document.body.style.overflow=""}async function wt(e,t){var a,s;const r=document.querySelector(m.printableContent);if(!r||!e||!e.html){g("ไม่พบข้อมูลสำหรับสร้างเอกสาร","error");return}if(t==="direct"){St("กำลังสร้าง PDF...");try{typeof html2pdf>"u"&&(g("กำลังโหลดไลบรารี PDF...","default"),await lt("https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"));const c=document.createElement("div");c.style.position="fixed",c.style.left="-300mm",c.style.top="0",c.style.width="210mm",c.style.background="#fff",c.innerHTML=e.html,document.body.appendChild(c),await new Promise(o=>setTimeout(o,500));const n={margin:0,filename:`${e.fileName}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0,logging:!1,width:((a=c.querySelector(".pdf-page"))==null?void 0:a.scrollWidth)||210*3.77,windowWidth:((s=c.querySelector(".pdf-page"))==null?void 0:s.scrollWidth)||210*3.77},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}};await window.html2pdf().from(c).set(n).save(),g("ดาวน์โหลด PDF สำเร็จ","success"),document.body.contains(c)&&document.body.removeChild(c)}catch(c){console.error("PDF Generation Error:",c),g("สร้าง PDF ล้มเหลว, โปรดลองวิธีที่ 2 (พิมพ์)","error")}finally{bt()}}t==="print"&&(r.innerHTML=e.html,setTimeout(()=>{window.print(),setTimeout(()=>{r.innerHTML=""},1e3)},Ve))}function qt(e){if(!e||!e.html){g("ไม่พบข้อมูลสำหรับสร้างไฟล์ HTML","error");return}try{const t=`
            <!DOCTYPE html><html lang="th"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>${e.fileName}</title>
                <link rel="stylesheet" href="https://grobmak.github.io/marnthara-form/src/style.css">
                <style>#printable-content { display: block !important; } .pdf-page { border: 1px solid #eee; box-shadow: 0 0 10px rgba(0,0,0,0.1); margin: 10mm auto; }</style>
            </head>
            <body>${e.html}</body></html>`,r=new Blob([t],{type:"text/html;charset=utf-8"}),a=URL.createObjectURL(r),s=document.createElement("a");s.href=a,s.download=`${e.fileName}.html`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(a),g("ดาวน์โหลดไฟล์ HTML สำเร็จ","success")}catch(t){console.error("HTML Export Error:",t),g("สร้างไฟล์ HTML ล้มเหลว","error")}}function je(e){if(!e)return;const t=e.closest(".item-card");if(!t)return;const r=y(e.value);let a,s;const c=e.getAttribute("name");if(c==="set_price_per_m"?(a=t.querySelector('input[name="fabric_code"]'),s="fabric"):c==="sheer_price_per_m"?(a=t.querySelector('input[name="sheer_fabric_code"]'),s="sheer"):c==="wallpaper_price_roll"?(a=t.querySelector('input[name="wallpaper_code"]'),s="wallpaper"):c==="area_price_sqyd"&&(a=t.querySelector('input[name="area_code"]'),a&&(s=a.dataset.favoriteType)),a&&s&&a.value.trim()){const n=Me(s,a.value);n&&n.price!==r&&(a.value="",ge(a))}}const Lt=Ge(e=>{e.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_price_per_m"]')&&je(e),Q(e),A()},200);function Tt(e){if(j){e.preventDefault();return}e.target.matches(m.roomNameInput)&&ee(),e.target.matches("input[data-favorite-type]")&&ge(e.target),Lt(e.target)}function $t(e){var a,s,c;if(j)return;const t=e.target;if(t.matches('select[name="fabric_variant"]')){const n=t.closest(".set-item");if(n){const o=(a=t.value)==null?void 0:a.includes("โปร่ง");(s=n.querySelector(m.sheerWrap))==null||s.classList.toggle("hidden",!o),(c=n.querySelector(m.sheerCodeWrap))==null||c.classList.toggle("hidden",!o)}}t.matches(m.roomNameInput)&&(le(),ee()),t.matches('[name="set_price_per_m"], [name="sheer_price_per_m"]')&&je(t),Q(t),A()}function kt(e){const t=e.target;t.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_install_cost"]')?t.value=y(t.value)>0?w(y(t.value)):"":t.matches('input[name$="_m"], input[name$="width_m"]')&&(t.value=J(t.value))}function xt(e){const t=e.target;t.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_install_cost"]')&&y(t.value)>0&&(t.value=y(t.value)),t.matches("input[data-favorite-type]")&&(ye=t,Oe(t))}const It=async e=>{var d,p,u;const t=e.target.closest(".summary-tag[data-filter-type]");if(t){const f=t.dataset.filterType,_=t.textContent.trim().replace(/\s*\d+\s*$/,""),h=document.querySelector("#overviewModal");h&&h.classList.remove("visible"),dt(f,_);return}const r=e.target.closest(".favorite-chips-container .btn-chip");if(r){mt(r);return}const a=e.target.closest(".fav-manager-item");if(a){const f=a.parentElement.querySelector(".is-selected");f&&f.classList.remove("is-selected"),f!==a?(a.classList.add("is-selected"),ke(a)):ke(null);return}const s=e.target.closest("[data-act]");if(!s)return;const c=["toggle-more-details","show-discount-modal"];if(j&&!s.closest(".unlockable")&&!c.includes(s.dataset.act))return;const n=s.dataset.act,o=s.closest(m.room),l=s.closest(".item-card"),i=(f,_,h)=>ne(f,_).then(v=>v&&h());switch(n){case"add-room":te();break;case"add-item":{if(we=s.closest(m.room),we){const h=await Ne("เพิ่มรายการใหม่");h&&_t(h,we)}break}case"clear-filter":pt();break;case"change-type":{const h=l==null?void 0:l.dataset.type;if(l&&h){const v=await Ne("เปลี่ยนประเภทรายการ",h);v&&v!==h&&i("ยืนยันการเปลี่ยนแปลง","ข้อมูลทั้งหมดในรายการนี้จะถูกลบและสร้างใหม่ คุณแน่ใจหรือไม่?",()=>gt(l,v))}break}case"add-wall":{const h=Ce(s);h&&((d=h.querySelector('input[name="wall_width_m"]'))==null||d.focus());break}case"show-discount-modal":vt();break;case"toggle-more-details":{const h=l==null?void 0:l.querySelector(".item-details-more");if(h){const v=h.classList.toggle("show");s.classList.toggle("expanded",v),s.querySelector("i").className=v?"ph ph-caret-up":"ph ph-caret-down",s.querySelector("span").textContent=v?"ย่อน้อยลง":"เพิ่มเติม"}break}case"toggle-favorite":{const h=s.previousElementSibling;if(!h||!l)break;const v=h.dataset.favoriteType,q=h.value;let T;v==="fabric"?T="set_price_per_m":v==="sheer"?T="sheer_price_per_m":v==="wallpaper"?T="wallpaper_price_roll":T="area_price_sqyd";const L=l.querySelector(`[name="${T}"]`),$=y(L==null?void 0:L.value);if(!q.trim()){g("โปรดระบุรหัสก่อนบันทึก","warning");break}if($<=0&&v!=="fabric"&&v!=="sheer"){g("โปรดระบุราคาก่อนบันทึก","warning");break}const E=be(v,q,$);s.classList.toggle("is-favorite",E),g(E?"เพิ่มในรายการโปรดแล้ว":"ลบออกจากรายการโปรด","success"),A();break}case"manage-favorites":{const h=s.dataset.type;ye=s.closest(".form-group-with-favorites").querySelector("input[data-favorite-type]"),ft(h);break}case"add-new-fav-form":{const v=s.closest("#favManagerModal").dataset.currentType;if(!v)break;const q=document.querySelector("#favAddModal");q.querySelector("h3").textContent=`เพิ่ม '${((p=se[v])==null?void 0:p.name)||v}'`;const T=q.querySelector("#fav_code_add"),L=q.querySelector("#fav_price_add");T.value="",L.value="";const $=await V("#favAddModal");if($&&!$.cancelled){const E=T.value.trim(),Y=y(L.value);E&&(be(v,E,Y),oe=!0,fe(v),g("เพิ่มรายการโปรดแล้ว","success"))}break}case"edit-selected-fav":{if(!O)break;const v=s.closest("#favManagerModal").dataset.currentType;if(!v)break;const q=document.querySelector("#favEditModal");q.querySelector("h3").textContent=`แก้ไข '${O.code}'`;const T=q.querySelector("#fav_code_edit"),L=q.querySelector("#fav_price_edit");T.value=O.code,L.value=O.price>0?O.price:"";const $=await V("#favEditModal");if($&&!$.cancelled){const E=T.value.trim(),Y=y(L.value);E&&(E!==O.code&&Te(v,O.code),be(v,E,Y),oe=!0,fe(v),g("แก้ไขรายการโปรดแล้ว","success"))}break}case"del-selected-fav":{if(!O)break;const v=s.closest("#favManagerModal").dataset.currentType;if(!v)break;await ne("ลบรายการโปรด",`ยืนยันการลบรหัส "${O.code}"?`)&&(Te(v,O.code),oe=!0,fe(v),g("ลบรายการโปรดแล้ว","success"));break}case"del-room":i("ลบห้อง","ยืนยันการลบห้องนี้?",()=>Le(o,"ลบห้องแล้ว"));break;case"del-item":i("ลบรายการ","ยืนยันการลบรายการนี้?",()=>Le(l,"ลบรายการแล้ว"));break;case"del-wall":i("ลบผนัง","ยืนยันการลบผนังนี้?",()=>Le(s.closest(".wall-input-row"),"ลบผนังแล้ว",()=>Q(l)));break;case"clear-room":i("ล้างข้อมูลในห้อง","ยืนยันลบทุกรายการในห้องนี้?",()=>{ve(W()),X(),o.querySelector(m.allItemsContainer).innerHTML="",K(),H(),A(),g("ล้างข้อมูลในห้องแล้ว","success")});break;case"toggle-room-menu":e.preventDefault();const f=s.nextElementSibling;if(!f||!o)return;const _=!f.classList.contains("show");document.querySelectorAll(".room-options-menu.show").forEach(h=>h.classList.remove("show")),document.querySelectorAll(".card.overflow-visible").forEach(h=>h.classList.remove("overflow-visible")),_&&(f.classList.add("show"),o.classList.add("overflow-visible"));break;case"toggle-suspend-room":e.preventDefault(),o==null||o.classList.toggle("is-suspended"),H(),A(),(u=s.closest(".room-options-menu"))==null||u.classList.remove("show"),o==null||o.classList.remove("overflow-visible");break;case"toggle-suspend":e.preventDefault(),l==null||l.classList.toggle("is-suspended"),Q(s),A();break}};function Et(){j=!j,Re()}function Mt(e){if(!e||e.closest(".modal-wrapper"))return;const t=e.getAttribute("name"),r=e.closest(".item-card"),c=(n=>{const o=n[t];if(!o)return null;const l=r||document;let i=null;return typeof o=="string"?i=l.querySelector(`[name="${o}"]:not(:disabled)`):typeof o=="function"&&(i=o(e)),!i&&r&&typeof o=="string"&&(i=document.querySelector(`[name="${o}"]:not(:disabled)`)),i})({customer_name:"customer_phone",customer_phone:"customer_address",customer_address:()=>document.querySelector(".room-name-input"),room_name:n=>{var o;return(o=n.closest(".room-card"))==null?void 0:o.querySelector('[data-act="add-item"]')},width_m:"height_m",height_m:"set_price_per_m",set_price_per_m:n=>{var i;const o=n.closest(".set-item"),l=(i=o==null?void 0:o.querySelector('[name="fabric_variant"]'))==null?void 0:i.value;return l!=null&&l.includes("โปร่ง")?o==null?void 0:o.querySelector('[name="sheer_price_per_m"]'):o==null?void 0:o.querySelector('[data-act="toggle-more-details"]')},sheer_price_per_m:n=>{var o;return(o=n.closest(".item-card"))==null?void 0:o.querySelector('[data-act="toggle-more-details"]')},area_width_m:"area_height_m",area_height_m:"area_price_sqyd",area_price_sqyd:"area_code",wall_width_m:n=>{var l,i;const o=(l=n.closest(".wall-input-row"))==null?void 0:l.nextElementSibling;return o!=null&&o.matches(".wall-input-row")?o.querySelector("input"):(i=n.closest(".item-card"))==null?void 0:i.querySelector('[name="wallpaper_price_roll"]')},wallpaper_price_roll:"wallpaper_height_m",wallpaper_height_m:"wallpaper_code"});c&&(c.focus(),typeof c.select=="function"&&c.select())}function Bt(){const e=document.querySelector(m.setTpl);if(!e)return;const t=e.content.querySelector('select[name="set_price_per_m"]'),r=e.content.querySelector('select[name="sheer_price_per_m"]'),a=s=>{let c='<option value="" hidden>เลือกราคา</option>';return Array.isArray(s)?(s.forEach(n=>{c+=`<option value="${n}">${n.toLocaleString("th-TH")}</option>`}),c):(console.error("Price data for dropdown is not available or not an array.",s),c)};t&&(t.innerHTML=a(he.fabric)),r&&(r.innerHTML=a(he.sheer))}function Ct(){Bt(),Fe();const e=document.querySelector(m.orderForm),t=document.querySelector(m.fileImporter),r=document.querySelector(m.menuDropdown),a=document.querySelector(m.quickNavDropdown),s=document.querySelector("#pageBreakBuffer"),c=document.querySelector("#pageBreakBufferValue");s&&c&&s.addEventListener("input",()=>{c.textContent=s.value}),e.addEventListener("input",Tt),e.addEventListener("change",$t),document.addEventListener("click",It),e.addEventListener("blur",kt,!0),e.addEventListener("focusin",xt,!0),e.addEventListener("keydown",l=>{const i=l.target;l.key==="Enter"&&!i.matches("textarea, button, [data-act]")&&(l.preventDefault(),Mt(i))});const n=l=>{const i=l.target.closest(m.room);i&&He(i)};e.addEventListener("click",n),e.addEventListener("focusin",n),document.body.addEventListener("click",l=>{l.target.closest("summary")&&setTimeout(()=>{U(),A()},50)}),document.querySelector("#undoBtn").addEventListener("click",l=>{l.preventDefault(),ut()}),document.querySelector(m.lockBtn).addEventListener("click",Et),document.querySelector(m.toggleAllRoomsBtn).addEventListener("click",yt),document.querySelector(m.quickNavBtn).addEventListener("click",l=>{var d;l.stopPropagation(),r.classList.remove("show");const i=!a.classList.contains("show");a.classList.toggle("show"),l.currentTarget.setAttribute("aria-expanded",i),i&&((d=document.querySelector(m.menuBtn))==null||d.setAttribute("aria-expanded","false"))}),document.querySelector(m.quickNavRoomList).addEventListener("click",l=>{var d;const i=l.target.closest("a[data-jump-to]");if(i){l.preventDefault();const p=i.dataset.jumpTo,u=document.getElementById(p);u&&(document.body.classList.add("disable-animations"),u.open=!0,u.scrollIntoView({behavior:"auto",block:"start"}),u.classList.add("scrolling-jump"),setTimeout(()=>{u.classList.remove("scrolling-jump"),document.body.classList.remove("disable-animations"),U()},1e3)),a.classList.remove("show"),(d=document.querySelector(m.quickNavBtn))==null||d.setAttribute("aria-expanded","false")}});const o=document.querySelector("#addRoomQuickNavBtn");if(o){const l=Je(te,700);o.addEventListener("click",i=>{var d;i.stopPropagation(),l(),a.classList.remove("show"),(d=document.querySelector(m.quickNavBtn))==null||d.setAttribute("aria-expanded","false")})}document.querySelector(m.menuBtn).addEventListener("click",l=>{var d;l.stopPropagation(),a.classList.remove("show");const i=!r.classList.contains("show");r.classList.toggle("show"),l.currentTarget.setAttribute("aria-expanded",i),i&&((d=document.querySelector(m.quickNavBtn))==null||d.setAttribute("aria-expanded","false"))}),document.querySelector("#themeToggleBtn").addEventListener("click",l=>{l.preventDefault(),it()}),document.querySelector("#overviewBtn").addEventListener("click",async l=>{var u;l.preventDefault(),r.classList.remove("show"),(u=document.querySelector(m.menuBtn))==null||u.setAttribute("aria-expanded","false");const i=W(),d=document.querySelector("#overviewModalHeader"),p=document.querySelector("#overviewModalBody");if(d&&p){const f=i.rooms.reduce((v,q)=>{if(q.is_suspended)return v;const T=(q.items||[]).filter(L=>{if(L.is_suspended)return!1;let $=0;switch(L.type){case"set":$=k.calculateSetPrice(L).total;break;case"wallpaper":$=k.calculateWallpaperPrice(L).total;break;default:$=k.calculateDecoPrice(L).total;break}return $>0}).length;return v+T},0),_=document.querySelector(m.grandTotal).textContent||"0",h=i.rooms.filter(v=>!v.is_suspended&&v.items&&v.items.some(q=>!q.is_suspended)).length;d.innerHTML=`
                <div class="overview-stats-grid">
                    <div class="overview-stat-card">
                        <i class="ph-bold ph-map-pin-line"></i>
                        <div class="stat-value">${h}</div>
                        <div class="stat-label">ห้อง</div>
                    </div>
                    <div class="overview-stat-card">
                        <i class="ph-bold ph-stack"></i>
                        <div class="stat-value">${f}</div>
                        <div class="stat-label">รายการ</div>
                    </div>
                    <div class="overview-stat-card">
                        <i class="ph-bold ph-coins"></i>
                        <div class="stat-value">${_}</div>
                        <div class="stat-label">ยอดรวม</div>
                    </div>
                </div>
            `,p.innerHTML=rt(i),V("#overviewModal")}}),document.querySelector(m.exportPdfBtn).addEventListener("click",async l=>{var u;l.preventDefault(),r.classList.remove("show"),(u=document.querySelector(m.menuBtn))==null||u.setAttribute("aria-expanded","false");const i=await ht();if(!i)return;const d=W(),p=ot(d,{vatRate:i.vatOption==="include"?C.baseVatRate:0,pageBreakBuffer:i.pageBreakBuffer});if(!p){g("ไม่มีรายการที่มีราคาสำหรับสร้างเอกสาร","warning");return}i.exportMethod==="html"?qt(p):wt(p,i.exportMethod)}),document.querySelector(m.importBtn).addEventListener("click",l=>{var i;l.preventDefault(),r.classList.remove("show"),(i=document.querySelector(m.menuBtn))==null||i.setAttribute("aria-expanded","false"),t.click()}),t.addEventListener("change",l=>{var p;const i=(p=l.target.files)==null?void 0:p[0];if(!i)return;const d=new FileReader;d.onload=u=>{try{const f=JSON.parse(u.target.result);xe(f)}catch(f){g("ไฟล์ JSON ไม่ถูกต้อง","error"),console.error("JSON Parse Error:",f)}},d.readAsText(i),l.target.value=null}),document.querySelector(m.exportBtn).addEventListener("click",l=>{var i;l.preventDefault(),r.classList.remove("show"),(i=document.querySelector(m.menuBtn))==null||i.setAttribute("aria-expanded","false");try{const d=W(),p=JSON.stringify(d,null,4),u=new Blob([p],{type:"application/json"}),f=URL.createObjectURL(u),_=document.createElement("a"),h=new Date,v=`${h.getFullYear()}${(h.getMonth()+1).toString().padStart(2,"0")}${h.getDate().toString().padStart(2,"0")}`,q=`${h.getHours().toString().padStart(2,"0")}${h.getMinutes().toString().padStart(2,"0")}`,T=Pe(d.customer_name||"data");_.href=f,_.download=`MTR-${v}${q}-${T}.json`,_.click(),URL.revokeObjectURL(f),g("Export ข้อมูลสำเร็จ","success")}catch{g("Export ข้อมูลล้มเหลว","error")}}),document.querySelector(m.submitBtn).addEventListener("click",async l=>{var i;if(l.preventDefault(),r.classList.remove("show"),(i=document.querySelector(m.menuBtn))==null||i.setAttribute("aria-expanded","false"),await ne("ส่งข้อมูล","ยืนยันการส่งข้อมูลการประเมินราคา?")){const d=W();if(!d.customer_name&&!d.customer_phone){g("กรุณาระบุชื่อหรือเบอร์โทรลูกค้า","warning");return}g("กำลังส่งข้อมูล...","default");try{const p=await fetch(Ue,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)});p.ok?g("ส่งข้อมูลสำเร็จ!","success"):g(`ส่งข้อมูลล้มเหลว: ${p.status}`,"error")}catch{g("เกิดข้อผิดพลาดในการเชื่อมต่อ","error")}}}),document.querySelector(m.copyTextBtn).addEventListener("click",async l=>{var p;l.preventDefault(),r.classList.remove("show"),(p=document.querySelector(m.menuBtn))==null||p.setAttribute("aria-expanded","false");const i=document.querySelector(m.copyOptionsModal);i.querySelector('input[name="copy_option"][value="customer"]').checked=!0;const d=await V(m.copyOptionsModal);if(d&&!d.cancelled){const u=i.querySelector('input[name="copy_option"]:checked').value,f=tt(W(),u);try{await navigator.clipboard.writeText(f),g("คัดลอกสรุปสำเร็จ!","success")}catch{g("คัดลอกล้มเหลว","error")}}}),document.querySelector(m.clearItemsBtn).addEventListener("click",async l=>{var i;l.preventDefault(),r.classList.remove("show"),(i=document.querySelector(m.menuBtn))==null||i.setAttribute("aria-expanded","false"),await ne("ล้างทุกรายการ","คุณแน่ใจหรือไม่ว่าต้องการลบรายการสินค้าทั้งหมด (ข้อมูลลูกค้าและห้องจะยังคงอยู่)?")&&(ve(W()),X(),document.querySelectorAll(m.room).forEach(d=>{const p=d.querySelector(m.allItemsContainer);p&&(p.innerHTML="")}),H(),A(),g("ล้างทุกรายการแล้ว","success"))}),document.querySelector(m.clearAllBtn).addEventListener("click",async l=>{var i;if(l.preventDefault(),r.classList.remove("show"),(i=document.querySelector(m.menuBtn))==null||i.setAttribute("aria-expanded","false"),await ne("ลบข้อมูลทั้งหมด",'คำเตือน! การกระทำนี้จะลบข้อมูลลูกค้า, ทุกรายการ, และ "รายการโปรด" ทั้งหมดอย่างถาวร ยืนยันหรือไม่?')){ve(W()),X(),localStorage.removeItem(pe),Ze();const d=document.querySelector("#customer_name"),p=document.querySelector("#customer_phone"),u=document.querySelector("#customer_address");d&&(d.value=""),p&&(p.value=""),u&&(u.value="");const f=document.querySelector("#discount_type"),_=document.querySelector("#discount_value");f&&(f.value="amount"),_&&(_.value="0");const h=document.querySelector(m.roomsContainer);h&&(h.innerHTML=""),H(),le(),U(),te();const v=document.querySelector("#customerDetailsCard");v&&(v.open=!0),g("ลบข้อมูลทั้งหมดแล้ว เริ่มต้นใหม่","success")}}),window.addEventListener("click",l=>{var i,d;l.target.closest(".modal-wrapper")||(l.target.closest(".menu-container")||(r.classList.contains("show")&&(r.classList.remove("show"),(i=document.querySelector(m.menuBtn))==null||i.setAttribute("aria-expanded","false")),a.classList.contains("show")&&(a.classList.remove("show"),(d=document.querySelector(m.quickNavBtn))==null||d.setAttribute("aria-expanded","false"))),l.target.closest(".room-options-container")||(document.querySelectorAll(".room-options-menu.show").forEach(p=>p.classList.remove("show")),document.querySelectorAll(".card.overflow-visible").forEach(p=>p.classList.remove("overflow-visible"))),l.target.closest(".form-group-with-favorites")||_e())}),window.addEventListener("beforeunload",A);try{const l=localStorage.getItem(pe);if(l&&l.length>2&&l!=="null")xe(JSON.parse(l));else{te();const i=document.querySelector("#customerDetailsCard");i&&(i.open=!0)}}catch(l){console.error("Failed to load data from localStorage:",l),localStorage.removeItem(pe),te()}H(),Re(),U(),ee(),X()}document.addEventListener("DOMContentLoaded",Ct);
