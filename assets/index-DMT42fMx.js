(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const s of a)if(s.type==="childList")for(const n of s.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&o(n)}).observe(document,{childList:!0,subtree:!0});function r(a){const s={};return a.integrity&&(s.integrity=a.integrity),a.referrerPolicy&&(s.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?s.credentials="include":a.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(a){if(a.ep)return;a.ep=!0;const s=r(a);fetch(a.href,s)}})();const Xe="input-ui/5.7.0",ze="https://your-make-webhook-url.com/your-unique-path",fe="marnthara.input.v5",Ze=500,P={name:"ม่านธารา ผ้าม่านและของตกแต่ง",address:"65/8 หมู่ 2 ต.ท่าศาลา อ.เมือง จ.ลพบุรี 15000",phone:"092-985-9395, 082-552-5595",taxId:"1234567890123",logoUrl:"./assets/logo.png",baseVatRate:.07,pdf:{paymentTerms:"ชำระมัดจำ 50%",priceValidity:"30 วัน",notes:["ราคานี้รวมค่าติดตั้งแล้ว","ชำระมัดจำ 50% เพื่อยืนยันการสั่งผลิตสินค้า","ใบเสนอราคานี้มีอายุ 30 วัน นับจากวันที่เสนอราคา"]}},et=1.19599,we={ROLL_WIDTH_M:.53,ROLL_LENGTH_M:10,STRIPS_PER_ROLL_UNDER_2_5M:3},ye={fabric:[1e3,1100,1200,1300,1400,1500,1600,1700,1800,1900,2e3,2100,2200],sheer:[1e3,1100,1200,1300,1400,1500],style_surcharge:{ลอน:200,ตาไก่:0,จีบ:0},height:[{threshold:3.2,add_per_m:300},{threshold:2.8,add_per_m:200},{threshold:2.5,add_per_m:100}]},v={orderForm:"#orderForm",roomsContainer:"#rooms",setTpl:"#setTpl",wallTpl:"#wallTpl",clearAllBtn:"#clearAllBtn",lockBtn:"#lockBtn",grandTotal:"#grandTotal",modal:"#confirmationModal",modalTitle:"#modalTitle",modalBody:"#modalBody",room:"[data-room]",allItemsContainer:"[data-all-items]",wallsContainer:"[data-walls-container]",sheerWrap:"[data-sheer-wrap]",sheerCodeWrap:"[data-sheer-code-wrap]",roomNameInput:'input[name="room_name"]',toastContainer:"#toast-container",copyTextBtn:"#copyTextBtn",copyOptionsModal:"#copyOptionsModal",menuBtn:"#menuBtn",menuDropdown:"#menuDropdown",importBtn:"#importBtn",exportBtn:"#exportBtn",fileImporter:"#fileImporter",submitBtn:"#submitBtn",clearItemsBtn:"#clearItemsBtn",exportPdfBtn:"#exportPdfBtn",exportOptionsModal:"#exportOptionsModal",printableContent:"#printable-content",quickNavBtn:"#quickNavBtn",quickNavDropdown:"#quickNavDropdown",quickNavRoomList:"#quickNavRoomList",toggleAllRoomsBtn:"#toggleAllRoomsBtn"},g=e=>{typeof e=="string"&&(e=e.replace(/,/g,""));const t=parseFloat(e);return Number.isFinite(t)?t:0},z=e=>{const t=g(e);return t>0?t.toFixed(2):""},j=(e,t=2,r=!1)=>Number.isFinite(e)?e.toLocaleString("en-US",{minimumFractionDigits:r?2:t,maximumFractionDigits:r?2:t}):"0",x=(e,t=0)=>Number.isFinite(e)?e.toLocaleString("th-TH",{minimumFractionDigits:t,maximumFractionDigits:t}):"0",tt=(e,t=150)=>{let r;return(...o)=>{clearTimeout(r),r=setTimeout(()=>e(...o),t)}},rt=(e,t=700)=>{let r=!1;return(...o)=>{if(!r){r=!0;try{return e(...o)}finally{setTimeout(()=>{r=!1},t)}}}},k=e=>typeof e!="string"?"":e.replace(/[&<>"']/g,function(t){switch(t){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";default:return"&#039;"}}),We=e=>typeof e!="string"?"":e.replace(/[\\/?%*:|"<>\x00-\x1f]/g,"").trim()||"file";function ot(e){let t=g(e);if(isNaN(t))return"ข้อมูลตัวเลขไม่ถูกต้อง";if(t===0)return"ศูนย์บาทถ้วน";const r=["","หนึ่ง","สอง","สาม","สี่","ห้า","หก","เจ็ด","แปด","เก้า"],o=["","สิบ","ร้อย","พัน","หมื่น","แสน","ล้าน"];let a=Math.floor(t),s=Math.round((t-a)*100);const n=c=>{if(c===0)return"";let i="";const f=String(c);for(let p=0;p<f.length;p++){const y=f[p];f.length-1;const h=f.length-p-1;y!=="0"&&(h===1&&y==="1"?i+=o[h]:h===1&&y==="2"?i+="ยี่"+o[h]:h===0&&y==="1"&&f.length>1?i+="เอ็ด":i+=r[parseInt(y)]+o[h])}return i};let l="";if(a>0){const c=Math.floor(a/1e6),i=a%1e6;c>0&&(l+=n(c)+"ล้าน"),l+=n(i),l+="บาท"}let u="";return s>0?u=n(s)+"สตางค์":l+="ถ้วน",(l+u).trim()}const Ce="marnthara.favorites.v4",he={fabric:[],sheer:[],wallpaper:[],wooden_blind:[],roller_blind:[],vertical_blind:[],partition:[],pleated_screen:[],aluminum_blind:[]};function Q(){try{const e=localStorage.getItem(Ce);return e?{...he,...JSON.parse(e)}:he}catch(e){return console.error("Failed to parse favorites from localStorage",e),he}}function ge(e){try{localStorage.setItem(Ce,JSON.stringify(e))}catch(t){console.error("Failed to save favorites to localStorage",t)}}function Re(e){if(!e||typeof e!="object")return console.error("Invalid favorites data for import."),!1;const t={...he,...e};return ge(t),!0}function Ue(e){if(!e||typeof e!="object")return console.error("Invalid favorites data for merge."),0;const t=Q();let r=0;for(const o in e)Object.hasOwnProperty.call(e,o)&&Array.isArray(e[o])&&(t[o]||(t[o]=[]),e[o].forEach(a=>{!t[o].some(n=>n.code===a.code)&&a.code&&(t[o].push(a),r++)}),t[o].sort((a,s)=>a.code.localeCompare(s.code)));return r>0&&ge(t),r}function nt(e,t,r){const o=Q();o[e]||(o[e]=[]);const a=o[e],s=a.find(n=>n.code===t);return s?s.price=r:a.push({code:t,price:r}),a.sort((n,l)=>n.code.localeCompare(l.code)),ge(o),!0}function xe(e,t){const r=Q();if(!r[e])return!1;const o=r[e].findIndex(a=>a.code===t);return o>-1?(r[e].splice(o,1),ge(r),!0):!1}function Ie(e,t){if(!e||!t)return;const r=Q(),o=t.trim();return(r[e]||[]).find(s=>s.code===o)}function at(e,t){return!!Ie(e,t)}function qe(e,t,r){const o=Ie(e,t);return o&&o.price===r?(xe(e,t),!1):(nt(e,t,r),!0)}function st(){localStorage.removeItem(Ce),console.log("All favorites have been cleared.")}function O(){var r,o,a,s,n,l;const e=Q(),t={app_version:Xe,customer_name:((r=document.querySelector('[name="customer_name"]'))==null?void 0:r.value)||"",customer_phone:((o=document.querySelector('[name="customer_phone"]'))==null?void 0:o.value)||"",customer_address:((a=document.querySelector('[name="customer_address"]'))==null?void 0:a.value)||"",customer_card_open:(s=document.querySelector("#customerDetailsCard"))==null?void 0:s.open,discount:{type:((n=document.querySelector("#discount_type"))==null?void 0:n.value)||"amount",value:g((l=document.querySelector("#discount_value"))==null?void 0:l.value)},rooms:[],favorites:e};return document.querySelectorAll(v.room).forEach(u=>{var i,f;const c={id:u.id,room_name:((i=u.querySelector(v.roomNameInput))==null?void 0:i.value)||"",is_suspended:u.classList.contains("is-suspended"),is_open:u.open,items:[]};(f=u.querySelector(v.allItemsContainer))==null||f.childNodes.forEach(p=>{var d,m,_,b,w,$,S,L,E,A,N,T,C,B,U,R,Y,X,te,H,de,Ne,Pe,Fe;if(p.nodeType!==1||!p.matches(".item-card"))return;const y=p.dataset.type;if(!y)return;let h={type:y,is_suspended:p.classList.contains("is-suspended")};y==="set"?Object.assign(h,{width_m:g((d=p.querySelector('input[name="width_m"]'))==null?void 0:d.value),height_m:g((m=p.querySelector('input[name="height_m"]'))==null?void 0:m.value),style:((_=p.querySelector('select[name="set_style"]'))==null?void 0:_.value)||"",fabric_variant:((b=p.querySelector('select[name="fabric_variant"]'))==null?void 0:b.value)||"",price_per_m_raw:g((w=p.querySelector('select[name="set_price_per_m"]'))==null?void 0:w.value),sheer_price_per_m:g(($=p.querySelector('select[name="sheer_price_per_m"]'))==null?void 0:$.value),fabric_code:((S=p.querySelector('input[name="fabric_code"]'))==null?void 0:S.value)||"",sheer_fabric_code:((L=p.querySelector('input[name="sheer_fabric_code"]'))==null?void 0:L.value)||"",opening_style:((E=p.querySelector('select[name="opening_style"]'))==null?void 0:E.value)||"",track_color:((A=p.querySelector('input[name="track_color"]'))==null?void 0:A.value)||"ขาว",bracket_color:((N=p.querySelector('input[name="bracket_color"]'))==null?void 0:N.value)||"ขาว",finial_color:((T=p.querySelector('input[name="finial_color"]'))==null?void 0:T.value)||"ขาว",grommet_color:((C=p.querySelector('input[name="grommet_color"]'))==null?void 0:C.value)||"เงิน",notes:((B=p.querySelector('input[name="notes"]'))==null?void 0:B.value)||""}):y==="wallpaper"?Object.assign(h,{height_m:g((U=p.querySelector('[name="wallpaper_height_m"]'))==null?void 0:U.value),wallpaper_code:((R=p.querySelector('[name="wallpaper_code"]'))==null?void 0:R.value)||"",price_per_roll:g((Y=p.querySelector('[name="wallpaper_price_roll"]'))==null?void 0:Y.value),install_cost_per_roll:g((X=p.querySelector('[name="wallpaper_install_cost"]'))==null?void 0:X.value),notes:((te=p.querySelector('[name="wallpaper_notes"]'))==null?void 0:te.value)||"",widths:Array.from(p.querySelectorAll('[name="wall_width_m"]')).map(Qe=>g(Qe.value))}):p.matches(".area-based-item")&&Object.assign(h,{width_m:g((H=p.querySelector('[name="area_width_m"]'))==null?void 0:H.value),height_m:g((de=p.querySelector('[name="area_height_m"]'))==null?void 0:de.value),price_sqyd:g((Ne=p.querySelector('[name="area_price_sqyd"]'))==null?void 0:Ne.value),code:((Pe=p.querySelector('[name="area_code"]'))==null?void 0:Pe.value)||"",notes:((Fe=p.querySelector('[name="area_notes"]'))==null?void 0:Fe.value)||""}),c.items.push(h)}),t.rooms.push(c)}),t}function I(){try{localStorage.setItem(fe,JSON.stringify(O()))}catch(e){console.error("Failed to save data to localStorage:",e)}}const M={stylePlus:e=>ye.style_surcharge[e]??0,heightPlus:e=>{const t=[...ye.height].sort((r,o)=>o.threshold-r.threshold);for(const r of t)if(e>r.threshold)return r.add_per_m;return 0},fabricYardage:(e,t)=>{const r=g(t);return r<=0||!e?0:e==="ตาไก่"||e==="จีบ"?(r*2+.6)/.9:e==="ลอน"?(r*2.6+.6)/.9:0},calculateGrommets:e=>{const t=g(e);if(t<=0)return 0;const a=Math.ceil(t/.3)*.3/.15;return Math.round(a)},wallpaperRolls:(e,t)=>{const r=g(e),o=g(t);if(r<=0||o<=0)return 0;const a=o>2.5?Math.floor(we.ROLL_LENGTH_M/o):we.STRIPS_PER_ROLL_UNDER_2_5M;if(a<=0)return 0;const s=Math.ceil(r/we.ROLL_WIDTH_M);return Math.ceil(s/a)},calculateSetPrice:function(e){var n,l;if(!e||e.is_suspended||g(e.width_m)<=0)return{total:0,opaque:0,sheer:0};const t=this.stylePlus(e.style),r=this.heightPlus(g(e.height_m)),o=g(e.width_m),a=(n=e.fabric_variant)!=null&&n.includes("ทึบ")&&g(e.price_per_m_raw)>0?(g(e.price_per_m_raw)+t+r)*o:0,s=(l=e.fabric_variant)!=null&&l.includes("โปร่ง")&&g(e.sheer_price_per_m)>0?(g(e.sheer_price_per_m)+t+r)*o:0;return{total:Math.round(a+s),opaque:Math.round(a),sheer:Math.round(s)}},calculateDecoPrice:function(e){if(!e||e.is_suspended||g(e.width_m)<=0||g(e.height_m)<=0)return{total:0,sqm:0,sqyd:0};const t=g(e.width_m)*g(e.height_m),r=t*et,o=r*g(e.price_sqyd);return{total:Math.round(o),sqm:t,sqyd:r}},calculateWallpaperPrice:function(e){var n;if(!e||e.is_suspended)return{total:0,material:0,install:0,rolls:0,sqm:0};const t=((n=e.widths)==null?void 0:n.reduce((l,u)=>l+g(u),0))||0;if(t<=0)return{total:0,material:0,install:0,rolls:0,sqm:0};const r=g(e.height_m),o=this.wallpaperRolls(t,r),a=o*g(e.price_per_roll),s=o*g(e.install_cost_per_roll??300);return{total:Math.round(a+s),material:Math.round(a),install:Math.round(s),rolls:o,sqm:t*r}}},re={set:"ผ้าม่าน",wallpaper:"วอลล์เปเปอร์",wooden_blind:"มู่ลี่ไม้",roller_blind:"ม่านม้วน",vertical_blind:"ม่านปรับแสง",partition:"ฉากกั้นห้อง",pleated_screen:"มุ้งจีบ",aluminum_blind:"มู่ลี่อลูมิเนียม"};function lt(e){const t=e.width_m||0,r=e.height_m||0;if(t<=0||r<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const o=15,a=100-o*2,s=100-o*2,n=Math.min(a/t,s/r),l=t*n,u=r*n,c=(100-l)/2,i=(100-u)/2;let f="";const p=e.fabric_variant.includes("โปร่ง"),y=e.fabric_variant.includes("ทึบ"),h=(b,w)=>e.opening_style==="แยกกลาง"?`
                <rect x="${c}" y="${i+w}" width="${l/2-1}" height="${u}" class="${b}" />
                <rect x="${c+l/2+1}" y="${i+w}" width="${l/2-1}" height="${u}" class="${b}" />
            `:`<rect x="${c}" y="${i+w}" width="${l}" height="${u}" class="${b}" />`;p&&(f+=h("curtain-panel-sheer",0)),y&&(f+=h("curtain-panel-opaque",p?-2:0));let d="";if(e.style==="ตาไก่"){const b=Math.max(8,Math.floor(l/8));for(let w=0;w<b;w++){const $=c+l/(b-1)*w;d+=`<circle cx="${$}" cy="${i}" r="2" class="style-grommet" />`}}else if(e.style==="ลอน"){const b=Math.max(4,Math.floor(l/10));let w=`M ${c},${i}`;for(let $=0;$<b;$++)w+=" q 5,-4 10,0";d=`<path d="${w}" class="style-ripplefold-path" />`}else e.style==="จีบ"&&(d=`<text x="${c+2}" y="${i+5}" class="style-pleat-text">||| ||| ||| ||| |||</text>`);const m=e.opening_style==="แยกกลาง"?"< >":t>r?" >":"v",_=e.opening_style==="แยกกลาง"?`<text x="50" y="${i+u/2}" class="opening-text">${m}</text>`:`<text x="${c+l/2}" y="${i+u+8}" class="opening-text">${m}</text>`;return`
        <svg viewBox="0 0 100 100">
            ${f}
            ${d}
            ${_}
            
            <line x1="${c}" y1="${i+u+5}" x2="${c+l}" y2="${i+u+5}" class="dimension-line" />
            <line x1="${c}" y1="${i+u+3}" x2="${c}" y2="${i+u+7}" class="dimension-tick" />
            <line x1="${c+l}" y1="${i+u+3}" x2="${c+l}" y2="${i+u+7}" class="dimension-tick" />
            <text x="50" y="${i+u+14}" class="dimension-text">${t.toFixed(2)} ม.</text>

            <line x1="${c-5}" y1="${i}" x2="${c-5}" y2="${i+u}" class="dimension-line" />
            <line x1="${c-7}" y1="${i}" x2="${c-3}" y2="${i}" class="dimension-tick" />
            <line x1="${c-7}" y1="${i+u}" x2="${c-3}" y2="${i+u}" class="dimension-tick" />
            <text x="${c-9}" y="50" class="dimension-text" transform="rotate(-90, ${c-9}, 50)">${r.toFixed(2)} ม.</text>
        </svg>
    `}function ct(e){if(e.type==="set")return lt(e);const t=re[e.type]||"ของตกแต่ง";return`<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">${k(t)}</text></svg>`}function Oe(e){let t=`
📃 *สรุปรายการสินค้า*
`,r=!1;return e.rooms.forEach(o=>{if(o.is_suspended||!o.items)return;const a=o.items.filter(n=>n.is_suspended?!1:n.type==="wallpaper"?(n.widths||[]).reduce((l,u)=>l+u,0)>0:n.width_m>0);if(a.length===0)return;r=!0,t+=`
*🚪 ห้อง: ${o.room_name||"ไม่ระบุ"}*
`;let s=0;a.forEach(n=>{s++;const l=re[n.type]||"สินค้าตกแต่ง";n.type==="set"?t+=` ${s}) ${l} ${n.style} (${n.fabric_variant})
`:t+=` ${s}) ${l}
`})}),r?t+`------------------------------
`:""}function Ge(e){return e.rooms.reduce((t,r)=>{var a;if(r.is_suspended)return t;const o=((a=r.items)==null?void 0:a.reduce((s,n)=>{if(n.is_suspended)return s;switch(n.type){case"set":return s+M.calculateSetPrice(n).total;case"wallpaper":return s+M.calculateWallpaperPrice(n).total;default:return s+M.calculateDecoPrice(n).total}},0))||0;return t+o},0)}function it(e,t){const r=Ge(e);let o=0,a="";e.discount&&e.discount.value>0&&(e.discount.type==="percent"?(o=r*(e.discount.value/100),a=`🏷️ ส่วนลด (${e.discount.value}%): -${x(o)} บาท
`):(o=e.discount.value,a=`🏷️ ส่วนลด: -${x(o)} บาท
`));const s=r-o;let n=`🗓️ สรุปข้อมูล (${new Date().toLocaleDateString("th-TH",{day:"numeric",month:"short",year:"2-digit"})})
`;if(n+=`👤 ลูกค้า: ${e.customer_name||"-"}
`,(t==="customer"||t==="owner")&&(n+=`📞 โทร: ${e.customer_phone||"-"}
`,n+=`🏠 ที่อยู่: ${e.customer_address||"-"}
`),n+=`------------------------------
`,t==="customer")return n+=Oe(e),o>0&&(n+=`
ยอดรวม: ${x(r)} บาท
`,n+=a),n+=`
💰 *ยอดสุทธิ: ${x(s)} บาท*
`,n+=`
ขอบคุณที่ใช้บริการค่ะ
${P.name}
โทร: ${P.phone}`,n;if(t==="purchase_order"||t==="owner"){t==="owner"&&(n+=Oe(e));const l={opaqueFabrics:[],sheerFabrics:[],decorations:{},wallpapers:[],allSets:[]};e.rooms.forEach(d=>{d.is_suspended||!d.items||d.items.forEach(m=>{const _=m.type==="set"||m.type.includes("_blind")||m.type==="partition"||m.type==="pleated_screen";if(!(m.is_suspended||_&&m.width_m<=0))switch(m.type){case"set":l.allSets.push(m),m.fabric_variant.includes("ทึบ")&&l.opaqueFabrics.push({code:m.fabric_code||"??",yards:M.fabricYardage(m.style,m.width_m)}),m.fabric_variant.includes("โปร่ง")&&l.sheerFabrics.push({code:m.sheer_fabric_code||"??",yards:M.fabricYardage(m.style,m.width_m)});break;case"wallpaper":const b=(m.widths||[]).reduce(($,S)=>$+S,0);if(b>0){const $=M.wallpaperRolls(b,m.height_m);$>0&&l.wallpapers.push({code:m.wallpaper_code||"xxx",rolls:$})}break;default:const w=re[m.type]||m.type;l.decorations[w]||(l.decorations[w]=[]),l.decorations[w].push({code:m.code||"xxx",width:m.width_m,height:m.height_m});break}})});const u={};if([...l.opaqueFabrics,...l.sheerFabrics].forEach(d=>{u[d.code]=(u[d.code]||0)+d.yards}),Object.keys(u).length>0){n+=`✂️ *รายการสั่งซื้อ (ผ้า)*
`,n+=`------------------------------
`,l.opaqueFabrics.length>0&&l.opaqueFabrics.forEach(d=>{n+=`- ผ้าทึบ (Curtain)
`,n+=`  รหัส: #${d.code||"??"}
`,n+=`  จำนวน: ${d.yards.toFixed(2)} หลา

`}),l.sheerFabrics.length>0&&l.sheerFabrics.forEach(d=>{n+=`- ผ้าโปร่ง (Sheer)
`,n+=`  รหัส: #${d.code||"??"}
`,n+=`  จำนวน: ${d.yards.toFixed(2)} หลา

`}),n+=`------------------------------
`,n+=`📊 *สรุปยอดรวมผ้า (ตามรหัส)*
`,n+=`------------------------------
`;for(const[d,m]of Object.entries(u))n+=`  - รหัส #${d}: ${m.toFixed(2)} หลา
`;n+=`
`}const c=l.allSets.filter(d=>d.style==="ตาไก่"),i=l.allSets.filter(d=>d.style!=="ตาไก่");if(i.length>0){n+=`------------------------------
`,n+=`📏 *รายการสั่งซื้อ ราง (ลอน/จีบ)*
`,n+=`------------------------------

`;let d=1;i.forEach(m=>{n+=`(${d++}) ราง ${m.style}, สี: ${m.track_color}
`,m.fabric_variant.includes("ทึบ")&&(n+=`  - รางทึบ: ${Number(m.width_m).toFixed(2)} ม.
`),m.fabric_variant.includes("โปร่ง")&&(n+=`  - รางโปร่ง: ${Number(m.width_m).toFixed(2)} ม.
`),m.fabric_variant==="ทึบ&โปร่ง"&&(n+=`  (❗️ใช้ขาสองชั้น)
`),m.notes&&t==="owner"&&(n+=`  📝 หมายเหตุ: ${m.notes}
`),n+=`
`})}if(c.length>0){n+=`------------------------------
`,n+=`📏 *รายการสั่งซื้อ ราง (ตาไก่)*
`,n+=`------------------------------

`;let d=1;c.forEach(S=>{n+=`(${d++}) ราง ${S.style}, สี: ${S.track_color}
`,S.fabric_variant.includes("ทึบ")&&(n+=`  - รางทึบ: ${Number(S.width_m).toFixed(2)} ม.
`),S.fabric_variant.includes("โปร่ง")&&(n+=`  - รางโปร่ง: ${Number(S.width_m).toFixed(2)} ม.
`),S.notes&&t==="owner"&&(n+=`  📝 หมายเหตุ: ${S.notes}
`),n+=`
`}),n+=`--- สรุปยอดรวมรางตาไก่ ---
`;const m=[];c.forEach(S=>{S.fabric_variant.includes("ทึบ")&&m.push(Number(S.width_m)),S.fabric_variant.includes("โปร่ง")&&m.push(Number(S.width_m))});const _=6;m.sort((S,L)=>L-S);const b=[];for(const S of m){let L=!1;for(let E=0;E<b.length;E++)if(b[E]>=S-.001){b[E]-=S,L=!0;break}L||b.push(_-S)}n+=`ต้องใช้รางเต็ม (6 ม.) ทั้งหมด: *${b.length} เส้น*

`;const w=m.reduce((S,L)=>{const E=L.toFixed(2);return S[E]=(S[E]||0)+1,S},{}),$=Object.entries(w).sort((S,L)=>parseFloat(L[0])-parseFloat(S[0]));if($.length>0){n+=`*สรุปจำนวนรางที่ต้องตัด:*
`;for(const[S,L]of $)n+=`  - ขนาด ${S} ม. = ${L} เส้น
`;n+=`
`}}const f={};c.forEach(d=>{const m=d.track_color||"ไม่ระบุ",_=d.grommet_color||"เงิน",b=`${m}|${_}`;f[b]||(f[b]={trackColor:m,grommetColor:_,grommets:0,brackets:0,finials:0}),f[b].grommets+=M.calculateGrommets(d.width_m),f[b].brackets+=d.width_m>=1.6?3:2,f[b].finials+=d.fabric_variant==="ทึบ&โปร่ง"?4:2});const p=l.allSets.length*2;(Object.keys(f).length>0||p>0)&&(n+=`------------------------------
`,n+=`🔩 *รายการสั่งซื้อ อุปกรณ์ (Hardware)*
`,n+=`------------------------------

`,Object.values(f).forEach(d=>{d.grommets>0&&(n+=`  - ตาไก่ (สี${d.grommetColor}): ${d.grommets} ตัว
`),d.brackets>0&&(n+=`  - ขาจับ (สี${d.trackColor}): ${d.brackets} ตัว
`),d.finials>0&&(n+=`  - หัวราง (สี${d.trackColor}): ${d.finials} ตัว
`)}),p>0&&(n+=`  - ตะขอรวบม่าน: ${p} ตัว
`),n+=`
`);const y=l.decorations;Object.keys(y).length>0&&Object.entries(y).forEach(([d,m])=>{n+=`------------------------------
`,n+=`📦 *รายการสั่งซื้อ ${d}*
`,n+=`------------------------------

`,m.forEach(_=>{n+=`- รหัส: #${_.code||"xxx"}
  ขนาด: ${_.width.toFixed(2)} x ${_.height.toFixed(2)} m.

`})});const h={};if(l.wallpapers.forEach(d=>{h[d.code]=(h[d.code]||0)+d.rolls}),Object.keys(h).length>0){n+=`------------------------------
`,n+=`🎨 *รายการสั่งซื้อ (Wallpaper)*
`,n+=`------------------------------

`;for(const[d,m]of Object.entries(h))n+=`  - รหัส #${d}: ${m} ม้วน
`;n+=`
`}if(t==="purchase_order")return n+=`------------------------------
`,n}if(t==="seamstress"||t==="owner"){n+=`
🧵 *รายละเอียดสำหรับช่างเย็บผ้า*
`;let l=0;if(e.rooms.forEach(u=>{if(u.is_suspended||!u.items)return;const c=u.items.filter(i=>i.type==="set"&&!i.is_suspended&&i.width_m>0);c.length!==0&&(l>0&&(n+=`==============================
`),n+=`
*🚪 ห้อง: ${u.room_name||"ไม่ระบุ"}*

`,c.forEach((i,f)=>{f>0&&(n+=`--------------------
`),n+=`*ชุดที่ ${f+1}/${c.length}: ${i.style} ${i.fabric_variant}*
`,n+=`  - ขนาด: กว้าง ${Number(i.width_m).toFixed(2)} x สูง ${Number(i.height_m).toFixed(2)} ม.
`,n+=`  - รูปแบบเปิด: ${i.opening_style}
`,i.fabric_variant.includes("ทึบ")&&(n+=`  - ผ้าทึบ: #${i.fabric_code||"-"}
`),i.fabric_variant.includes("โปร่ง")&&(n+=`  - ผ้าโปร่ง: #${i.sheer_fabric_code||"-"}
`)}),n+=`
`,l++)}),l>0?n+=`==============================
`:n+=`ไม่มีรายการสำหรับช่าง
------------------------------
`,t==="seamstress")return n}return t==="owner"&&(n+=`
💰 *สรุปยอดรวม: ${x(s)} บาท*
`),n}function ut(e){if(!e.rooms||e.rooms.length===0)return'<p class="empty-summary">ไม่มีข้อมูลสำหรับแสดงผล</p>';let t="";const r={};e.rooms.forEach(n=>{n.is_suspended||!n.items||n.items.forEach(l=>{if(l.is_suspended)return;let u=null,c=0;switch(l.type){case"set":c=M.calculateSetPrice(l).total,c>0&&(u=l.type);break;case"wallpaper":c=M.calculateWallpaperPrice(l).total,c>0&&(u=l.type);break;default:c=M.calculateDecoPrice(l).total,c>0&&(u=l.type);break}u&&(r[u]=(r[u]||0)+1)})});const o=Object.entries(r).map(([n,l])=>{const u=re[n]||"ของตกแต่ง";return`
            <span class="summary-tag" data-filter-type="${k(n)}" title="คลิกเพื่อกรองเฉพาะรายการนี้">
                ${k(u)} <strong>${l}</strong>
            </span>`}).join("");o&&(t+=`
            <div class="overview-summary-group">
                <h4><i class="ph ph-stack"></i> สรุปประเภทรายการ</h4>
                <div class="summary-tags-container">
                    ${o}
                </div>
            </div>`);let a="",s=0;return e.rooms.forEach(n=>{if(n.is_suspended||!n.items)return;const l={};let u=0;if(n.items.forEach(c=>{if(c.is_suspended)return;let i=null,f=0;switch(c.type){case"set":f=M.calculateSetPrice(c).total,f>0&&(i=c.type);break;case"wallpaper":f=M.calculateWallpaperPrice(c).total,f>0&&(i=c.type);break;default:f=M.calculateDecoPrice(c).total,f>0&&(i=c.type);break}i&&(l[i]=(l[i]||0)+1,u++)}),u>0){s+=u;const c=Object.entries(l).map(([i,f])=>`
                    <div class="overview-item">
                        <span>${k(re[i]||"ของตกแต่ง")}</span>
                        <span>${f}</span>
                    </div>`).join("");a+=`
                <details class="overview-room-card">
                    <summary class="overview-room-summary">
                        <span class="room-name">${k(n.room_name)||"ไม่ระบุชื่อห้อง"}</span>
                        <div class="summary-tags">
                            <span class="room-item-count">${u} รายการ</span>
                            <i class="ph ph-caret-down expand-icon"></i>
                        </div>
                    </summary>
                    <div class="overview-room-items">${c}</div>
                </details>`}}),a&&(t+=`
            <div class="overview-breakdown-group">
                <h4><i class="ph ph-map-pin-line"></i> แจกแจงตามห้อง</h4>
                ${a}
            </div>`),s===0?'<p class="empty-summary">ไม่มีข้อมูลสำหรับแสดงผล</p>':t}function dt(e,t){const{vatRate:r,pageBreakBuffer:o=3}=t,a=[];e.rooms.forEach(A=>{if(A.is_suspended||!A.items)return;const N=[];A.items.forEach(T=>{if(T.is_suspended)return;let C,B,U,R;const Y=re[T.type]||"สินค้าตกแต่ง";switch(T.type){case"set":B=M.calculateSetPrice(T).total,B>0&&(U=T.width_m||0,R=T.height_m||0,C=`${Y} ${k(T.style)} (${k(T.fabric_variant)}) <br><small>ขนาด ${U.toFixed(2)} x ${R.toFixed(2)} ม.${T.notes?` - ${k(T.notes)}`:""}</small>`,N.push({description:C,total:B,units:C.includes("<br>")?1.5:1}));break;case"wallpaper":if(B=M.calculateWallpaperPrice(T).total,B>0){const X=(T.widths||[]).reduce((H,de)=>H+de,0),te=M.wallpaperRolls(X,T.height_m);R=T.height_m||0,C=`${Y} <br><small>รหัส: ${k(T.wallpaper_code)||"-"}, สูง ${R.toFixed(2)} ม. (ใช้ ${te} ม้วน)</small>`,N.push({description:C,total:B,units:C.includes("<br>")?1.5:1})}break;default:B=M.calculateDecoPrice(T).total,B>0&&(U=T.width_m||0,R=T.height_m||0,C=`${Y} <br><small>รหัส: ${k(T.code)||"-"}, ขนาด ${U.toFixed(2)} x ${R.toFixed(2)} ม.</small>`,N.push({description:C,total:B,units:C.includes("<br>")?1.5:1}));break}}),N.length>0&&(a.push({isRoomHeader:!0,roomName:k(A.room_name)||"ไม่ระบุชื่อห้อง",units:1.2}),a.push(...N))});const s=a.reduce((A,N)=>A+(N.total||0),0);if(s===0)return null;let n=0,l="",u=s;e.discount&&e.discount.value>0&&(e.discount.type==="percent"?(n=s*(e.discount.value/100),l=`<tr><td class="pdf-label">ส่วนลด (${e.discount.value}%)</td><td class="pdf-amount">-${j(n,2,!0)}</td></tr>`):(n=e.discount.value,l=`<tr><td class="pdf-label">ส่วนลด</td><td class="pdf-amount">-${j(n,2,!0)}</td></tr>`),u=s-n,l+=`<tr><td class="pdf-label">ยอดหลังหักส่วนลด</td><td class="pdf-amount">${j(u,2,!0)}</td></tr>`);const c=u*r,i=u+c,f=17,p=23,y=[];let h=[],d=0;a.forEach((A,N)=>{const T=y.length===0?f:p,C=d+A.units>T;let B=!1;if(!C&&N<a.length-1){const U=T-(d+A.units);U>0&&U<o&&(B=!0)}(C||B)&&h.length>0&&(y.push(h),h=[],d=0),h.push(A),d+=A.units}),h.length>0&&y.push(h);const m=new Date,_=m.toLocaleDateString("th-TH",{year:"numeric",month:"long",day:"numeric"}),b=`QT-${m.getFullYear()}${(m.getMonth()+1).toString().padStart(2,"0")}${m.getDate().toString().padStart(2,"0")}`;let w="",$=0,S=1;y.forEach((A,N)=>{const T=N===0,C=N===y.length-1,B=`
            <div class="pdf-page-header">
                <div class="pdf-header">
                    <div class="pdf-shop-info">
                        ${`<img src="${P.logoUrl}" alt="Logo" class="pdf-logo">`}
                        <div class="pdf-shop-address">
                            <strong><i class="ph ph-github-logo"></i> ${k(P.name)}</strong><br>
                            ${k(P.address).replace(/\n/g,"<br>")}<br>
                            โทร: ${k(P.phone)} | เลขประจำตัวผู้เสียภาษี: ${k(P.taxId)}
                        </div>
                    </div>
                    <div class="pdf-quote-details">
                        <div class="pdf-title-box"><h1>ใบเสนอราคา ${y.length>1?T?"":"(ต่อ)":""}</h1></div>
                        <table class="pdf-quote-meta">
                            <tr><td>เลขที่:</td><td>${b}</td></tr>
                            <tr><td>วันที่:</td><td>${_}</td></tr>
                        </table>
                    </div>
                </div>
                ${T?`
                <section class="pdf-customer-details">
                    <div class="pdf-customer-info">
                        <strong>ลูกค้า:</strong> ${k(e.customer_name)||""}<br>
                        <strong>ที่อยู่:</strong> ${k(e.customer_address).replace(/\n/g,"<br>")||""}<br>
                        <strong>โทร:</strong> ${k(e.customer_phone)||""}
                    </div>
                    <div class="pdf-customer-meta">
                        <strong>เงื่อนไขชำระเงิน:</strong> ${k(P.pdf.paymentTerms)}<br>
                        <strong>ยืนราคา:</strong> ${k(P.pdf.priceValidity)}
                    </div>
                </section>`:""}
            </div>`,U=`
            <div class="pdf-page-footer">
                <div class="pdf-footer-info">
                    <span><i class="ph ph-github-logo"></i> ${k(P.name)} | โทร: ${k(P.phone)}</span>
                    <span>หน้า ${N+1} / ${y.length}</span>
                </div>
            </div>`;let R="";T||(R+=`<tr class="pdf-subtotal-row"><td colspan="4">ยอดยกมา (Brought Forward)</td><td class="pdf-text-right">${j($,2,!0)}</td></tr>`),A.forEach(H=>{H.isRoomHeader?R+=`<tr class="pdf-room-header"><td colspan="5">ห้อง: ${H.roomName}</td></tr>`:(R+=`<tr><td class="pdf-text-center">${S++}</td><td>${H.description}</td><td class="pdf-text-center">1</td><td class="pdf-text-right">${j(H.total,2,!0)}</td><td class="pdf-text-right">${j(H.total,2,!0)}</td></tr>`,$+=H.total)});let Y="";C||(Y=`<tfoot><tr class="pdf-subtotal-row"><td colspan="4">ยอดยกไป (Carried Forward)</td><td class="pdf-text-right">${j($,2,!0)}</td></tr></tfoot>`);let X="";P.pdf.notes&&P.pdf.notes.length>0&&(X=`
                <strong>หมายเหตุ:</strong>
                <ul>${P.pdf.notes.map(H=>`<li>${k(H)}</li>`).join("")}</ul>
            `);const te=C?`
            <div class="pdf-summary-wrapper">
                <section class="pdf-summary-section">
                    <div class="pdf-amount-in-words">
                        ${X}
                        <div class="pdf-amount-text">( ${ot(i)} )</div>
                    </div>
                    <div class="pdf-totals-block">
                        <table>
                            <tr><td class="pdf-label">รวมเป็นเงิน</td><td class="pdf-amount">${j(s,2,!0)}</td></tr>
                            ${l}
                            ${r>0?`<tr><td class="pdf-label">ภาษีมูลค่าเพิ่ม ${(r*100).toFixed(0)}%</td><td class="pdf-amount">${j(c,2,!0)}</td></tr>`:""}
                            <tr class="pdf-grand-total"><td class="pdf-label">ยอดรวมสุทธิ</td><td class="pdf-amount">${j(i,2,!0)}</td></tr>
                        </table>
                    </div>
                </section>
                <footer class="pdf-footer-section">
                    <div class="pdf-signature-box"><p>.................................................</p><p>ผู้เสนอราคา</p><p>(<i class="ph ph-github-logo"></i> ${k(P.name)})</p><p>วันที่: ${_}</p></div>
                    <div class="pdf-signature-box"><p>.................................................</p><p>ลูกค้า / ผู้มีอำนาจลงนาม</p><p>&nbsp;</p><p>วันที่: ......./......./............</p></div>
                </footer>
            </div>
        `:"";w+=`
            <div class="pdf-page">
                <div class="pdf-page-content">
                    ${B}
                    <div class="pdf-page-body">
                        <table class="pdf-items-table">
                            <thead><tr><th style="width:5%;">ลำดับ</th><th style="width:50%;">รายการ</th><th style="width:10%;">จำนวน</th><th style="width:17.5%;">ราคา/หน่วย</th><th style="width:17.5%;">รวม (บาท)</th></tr></thead>
                            <tbody>${R}</tbody>
                            ${Y}
                        </table>
                        ${te}
                    </div>
                    ${U}
                </div>
            </div>`});const L=e.customer_name||"quote",E=We(L);return{html:`<div id="quotation-template">${w}</div>`,fileName:`${b}_${E}`}}function mt(e){var l;const t=Ge(e);let r=0;((l=e.discount)==null?void 0:l.value)>0&&(r=e.discount.type==="percent"?t*(e.discount.value/100):e.discount.value);const o=t-r;let a=!1,s=e.rooms.map(u=>{if(u.is_suspended)return"";const c=u.items.filter(f=>!f.is_suspended&&(f.width_m>0||f.type==="wallpaper"&&(f.widths||[]).reduce((p,y)=>p+y,0)>0));if(c.length===0)return"";const i=c.map(f=>{let p="";switch(f.type){case"set":p=`
                        <tr><td>รูปแบบ</td><td>${k(f.style)} (${k(f.fabric_variant)})</td></tr>
                        ${f.fabric_variant.includes("ทึบ")?`<tr><td>ผ้าทึบ</td><td>#${k(f.fabric_code)||"-"}</td></tr>`:""}
                        ${f.fabric_variant.includes("โปร่ง")?`<tr><td>ผ้าโปร่ง</td><td>#${k(f.sheer_fabric_code)||"-"}</td></tr>`:""}
                        <tr><td>รูปแบบเปิด</td><td>${k(f.opening_style)}</td></tr>
                    `;break;case"wallpaper":const y=(f.widths||[]).reduce((d,m)=>d+m,0),h=M.wallpaperRolls(y,f.height_m);p=`
                        <tr><td>รหัส</td><td>#${k(f.wallpaper_code)||"-"}</td></tr>
                        <tr><td>สูง</td><td>${(f.height_m||0).toFixed(2)} ม.</td></tr>
                        <tr><td>จำนวน</td><td>${h} ม้วน</td></tr>
                    `;break;default:p=`
                        <tr><td>รหัส</td><td>#${k(f.code)||"-"}</td></tr>
                        <tr><td>ขนาด</td><td>${(f.width_m||0).toFixed(2)} x ${(f.height_m||0).toFixed(2)} ม.</td></tr>
                    `;break}return p&&(a=!0),`
                 <div class="lookbook-details">
                    <div class="visual-placeholder">
                        ${ct(f)}
                    </div>
                    <table class="spec-table">
                        ${p}
                    </table>
                </div>
            `}).join('<hr class="lookbook-hr">');return i.trim()?`
            <div class="lookbook-room">
                <h4><i class="ph ph-map-pin"></i> ${k(u.room_name)}</h4>
                ${i}
            </div>
        `:""}).join("");return a?`
        <div class="lookbook-summary">
            <div class="lookbook-customer-info">
                <strong>ลูกค้า:</strong> ${k(e.customer_name)||"-"}<br/>
                <strong>ที่อยู่:</strong> ${k(e.customer_address)||"-"}
            </div>
            <div class="lookbook-totals">
                <span>ยอดรวม (ก่อนส่วนลด): ${x(t)} บาท</span>
                ${r>0?`<span>ส่วนลด: -${x(r)} บาท</span>`:""}
                <span class="grand-total">ยอดสุทธิ: ${x(o)} บาท</span>
            </div>
        </div>
    `+s:'<p class="empty-summary">ไม่มีรายการสำหรับสร้างรายงาน</p>'}const ae=[],pt=10;function Z(e){ae.push(e),ae.length>pt&&ae.shift()}function ft(){return ae.pop()}function ht(){return ae.length>0}let V=!1,_e=null,F=null,me=null,se=!1,D=null,$e=null,ke=!1;const He=document.querySelector("#undoBtn"),pe={};function vt(e){if(pe[e])return pe[e];const t=new Promise((r,o)=>{const a=document.createElement("script");a.src=e,a.onload=()=>{console.log(`${e} loaded successfully.`),r()},a.onerror=()=>{console.error(`Script load error for ${e}`),delete pe[e],o(new Error(`Script load error for ${e}`))},document.head.appendChild(a)});return pe[e]=t,t}const ce={set:{templateId:"#setTpl",name:"ผ้าม่าน"},wallpaper:{templateId:"#wallpaperTpl",name:"วอลล์เปเปอร์"},wooden_blind:{templateId:"#areaBasedTpl",name:"มู่ลี่ไม้"},roller_blind:{templateId:"#areaBasedTpl",name:"ม่านม้วน"},vertical_blind:{templateId:"#areaBasedTpl",name:"ม่านปรับแสง"},partition:{templateId:"#areaBasedTpl",name:"ฉากกั้นห้อง"},pleated_screen:{templateId:"#areaBasedTpl",name:"มุ้งจีบ"},aluminum_blind:{templateId:"#areaBasedTpl",name:"มู่ลี่อลูมิเนียม"}},yt={มู่ลี่ไม้:"wooden_blind",ม่านม้วน:"roller_blind",ม่านปรับแสง:"vertical_blind",ฉากกั้นห้อง:"partition",มุ้งจีบ:"pleated_screen",มู่ลี่อลูมิเนียม:"aluminum_blind"},Te="marnthara.theme";function Ve(){const e=localStorage.getItem(Te),t=document.querySelector("#themeToggleBtn");if(!t)return;const r=t.querySelector("i"),o=t.querySelector("span");switch(document.body.classList.remove("dark-theme","neutral-theme"),e){case"dark":document.body.classList.add("dark-theme"),r&&(r.className="ph-fill ph-sun"),o&&(o.textContent=" สว่าง");break;case"neutral":document.body.classList.add("neutral-theme"),r&&(r.className="ph-fill ph-moon"),o&&(o.textContent=" มืด");break;default:r&&(r.className="ph-fill ph-palette"),o&&(o.textContent=" กลาง");break}}function _t(){const e=localStorage.getItem(Te);let t;!e||e==="light"?t="neutral":e==="neutral"?t="dark":t="light",localStorage.setItem(Te,t),Ve()}function K(){He&&(He.disabled=!ht())}function gt(){const e=ft();e&&(Ee(e,!1),q("ยกเลิกการกระทำล่าสุดแล้ว","success")),K()}function bt(e,t){if(!e)return;const r=document.getElementById("filterStatusBar");r&&(r.innerHTML=`
            <span>แสดงผลเฉพาะ: <strong>${k(t)}</strong></span>
            <button type="button" class="btn-chip" data-act="clear-filter" title="ยกเลิกการกรอง">
                <i class="ph ph-x"></i>&nbsp;ปิด
            </button>
        `,r.classList.add("is-visible"),r.dataset.filterType=e),document.querySelectorAll(v.room).forEach(o=>{let a=0;o.querySelectorAll(".item-card").forEach(s=>{const n=s.dataset.type===e;s.classList.toggle("item-hidden",!n),n&&a++}),o.classList.toggle("item-hidden",a===0)}),ee(),J()}function St(){const e=document.getElementById("filterStatusBar");e&&(e.classList.remove("is-visible"),e.innerHTML="",e.removeAttribute("data-filter-type")),document.querySelectorAll(".item-hidden").forEach(t=>t.classList.remove("item-hidden")),ee(),J()}function be(){document.querySelectorAll(".favorite-chips-container.show").forEach(e=>{e.classList.remove("show")}),document.querySelectorAll(".item-card.overflow-visible").forEach(e=>{e.classList.remove("overflow-visible")})}function Ye(e){var u;const t=e.dataset.favoriteType,r=(u=e.closest(".form-group-with-favorites"))==null?void 0:u.querySelector(".favorite-chips-container");if(!t||!r)return;be();const o=e.closest(".item-card"),s=Q()[t]||[];let l=Array.from(s.reduce((c,i)=>{const f=i.code.trim();return f&&!c.has(f.toLowerCase())&&c.set(f.toLowerCase(),i),c},new Map).values()).map(c=>`<button type="button" class="btn-chip" data-code="${k(c.code)}" data-price="${c.price}">${k(c.code)}</button>`).join("");l+=`<button type="button" class="btn-manage-favorites" data-act="manage-favorites" data-type="${t}"><i class="ph ph-pencil-simple"></i> จัดการรายการโปรด</button>`,r.innerHTML=l,r.classList.add("show"),o&&o.classList.add("overflow-visible")}function wt(e){const t=e.closest(".form-group-with-favorites"),r=e.closest(".item-card");if(!t||!r)return;const o=e.dataset.code,a=g(e.dataset.price),s=t.querySelector("input[data-favorite-type]");s&&(s.value=o,s.classList.add("input-highlight"),setTimeout(()=>s.classList.remove("input-highlight"),1200));const n=s.dataset.favoriteType;let l;n==="fabric"?l="set_price_per_m":n==="sheer"?l="sheer_price_per_m":n==="wallpaper"?l="wallpaper_price_roll":l="area_price_sqyd";const u=r.querySelector(`[name="${l}"]`);u&&a>0&&(u.tagName==="SELECT"?u.value=a:u.value=x(a),u.classList.add("input-highlight"),setTimeout(()=>u.classList.remove("input-highlight"),1200)),Se(s),oe(r),I(),be()}function ve(e){const t=document.querySelector("#favManagerBody"),r=document.querySelector("#favManagerItemTpl"),a=Q()[e]||[];!t||!r||(a.length===0?t.innerHTML='<p class="empty-state">ไม่มีรายการโปรดที่บันทึกไว้</p>':t.innerHTML=a.map(s=>r.innerHTML.replace(/{CODE}/g,k(s.code)).replace(/{PRICE}/g,x(s.price)).replace(/{RAW_PRICE}/g,s.price)).join(""),Me(null))}function Me(e){const t=document.querySelector('[data-act="edit-selected-fav"]'),r=document.querySelector('[data-act="del-selected-fav"]');!t||!r||(e?(t.disabled=!1,r.disabled=!1,D={code:e.dataset.code,price:g(e.dataset.price)}):(t.disabled=!0,r.disabled=!0,D=null))}async function qt(e){const t=document.querySelector("#favManagerModal");if(!t||!e)return;const r={fabric:"ผ้าทึบ",sheer:"ผ้าโปร่ง",wallpaper:"วอลล์เปเปอร์",wooden_blind:"มู่ลี่ไม้",roller_blind:"ม่านม้วน",vertical_blind:"ม่านปรับแสง",partition:"ฉากกั้นห้อง",pleated_screen:"มุ้งจีบ",aluminum_blind:"มู่ลี่อลูมิเนียม",deco:"ของตกแต่ง"};t.dataset.currentType=e,se=!1,D=null,document.querySelector("#favManagerTitle").textContent=`จัดการ '${r[e]||e}'`,ve(e),await W("#favManagerModal",()=>{se&&_e&&Ye(_e)})}function q(e,t="default"){const r=document.querySelector(v.toastContainer);if(!r)return;const o={success:"ph-bold ph-check-circle",warning:"ph-bold ph-warning",error:"ph-bold ph-x-circle",default:"ph-bold ph-info"},a=document.createElement("div");a.className=`toast toast-${t}`,a.innerHTML=`<i class="${o[t]||o.default}"></i> ${e}`,r.appendChild(a),setTimeout(()=>a.classList.add("show"),10),setTimeout(()=>{a.classList.remove("show"),a.addEventListener("transitionend",()=>a.remove())},3e3)}function W(e,t){return new Promise(r=>{const o=document.querySelector(e);if(!o){r(null);return}const a=document.querySelector(".modal-wrapper.visible");a&&a.classList.add("is-underlay"),o.classList.add("visible");const s=o.querySelector('[id$="Confirm"]'),n=o.querySelector('[id$="Cancel"], [data-act="close-modal"]'),l=Array.from(o.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])')).filter(p=>!p.disabled&&p.offsetParent!==null),u=l[0],c=l[l.length-1];setTimeout(()=>u==null?void 0:u.focus(),50);const i=p=>{if(p.key==="Escape"&&!o.classList.contains("is-underlay")){f({cancelled:!0});return}if(p.key==="Tab"){if(l.length<=1){p.preventDefault();return}p.shiftKey?document.activeElement===u&&(c.focus(),p.preventDefault()):document.activeElement===c&&(u.focus(),p.preventDefault())}},f=p=>{o.classList.remove("visible"),document.removeEventListener("keydown",i),s&&(s.onclick=null),n&&(n.onclick=null),a&&a.classList.remove("is-underlay"),typeof p=="object"&&p.cancelled&&t&&t(),r(p)};s&&(s.onclick=()=>f(!0)),n&&(n.onclick=()=>{o.classList.contains("is-underlay")||f({cancelled:!0})}),document.addEventListener("keydown",i)})}async function le(e,t){const r=document.querySelector(v.modal);return r?(r.querySelector(v.modalTitle).textContent=e,r.querySelector(v.modalBody).textContent=t,await W(v.modal)===!0):!0}async function $t(){var r,o,a;const e=document.querySelector(v.exportOptionsModal);if(!e)return null;const t=await W(v.exportOptionsModal);return!t||t.cancelled?null:{vatOption:((r=e.querySelector('input[name="vat_option"]:checked'))==null?void 0:r.value)||"include",exportMethod:((o=e.querySelector("#exportMethod"))==null?void 0:o.value)||"direct",pageBreakBuffer:parseInt((a=e.querySelector("#pageBreakBuffer"))==null?void 0:a.value,10)||3}}async function kt(){const e=document.querySelector("#discountModal");if(!e)return;const t=e.querySelector("#discountSubtotal"),r=e.querySelector("#discountPercent"),o=e.querySelector("#discountAmount"),a=e.querySelector("#discountFinalTotal"),s=document.querySelector("#discount_type"),n=document.querySelector("#discount_value"),l=g(document.querySelector("#originalTotal").dataset.rawTotal||document.querySelector("#grandTotal").textContent);t.textContent=x(l);const u=p=>{if(ke)return;ke=!0;let y=0;if(p==="percent"){const h=g(r.value);y=l*((h>=0?h:0)/100),o.value=y>0?x(Math.round(y)):""}else y=g(o.value);if(y=y>=0?Math.min(y,l):0,p!=="percent"){const h=l>0?y/l*100:0;r.value=h>0&&isFinite(h)?j(h,2):""}a.textContent=x(l-y),setTimeout(()=>{ke=!1},20)};r.addEventListener("input",()=>u("percent")),o.addEventListener("input",()=>u("amount")),o.addEventListener("focus",p=>{g(p.target.value)>0&&(p.target.value=g(p.target.value))}),o.addEventListener("blur",p=>{g(p.target.value)>0&&(p.target.value=x(g(p.target.value))),u("amount")});const c=s.value,i=g(n.value);r.value="",o.value="",i>0?c==="percent"?(r.value=i,u("percent")):(o.value=x(i),u("amount")):u();const f=await W("#discountModal");if(f&&!f.cancelled){const p=g(r.value),y=g(o.value);document.activeElement===r&&p>0?(s.value="percent",n.value=p):y>0?(s.value="amount",n.value=y):(s.value="amount",n.value=0),G(),I()}}async function Lt(){var o,a,s,n,l;if(!F)return;const e=document.querySelector("#hardwareModal"),t=((o=F.querySelector('[name="set_style"]'))==null?void 0:o.value)==="ตาไก่";e.querySelector('[name="modal_track_color"]').value=((a=F.querySelector('[name="track_color"]'))==null?void 0:a.value)||"ขาว",e.querySelector('[name="modal_bracket_color"]').value=((s=F.querySelector('[name="bracket_color"]'))==null?void 0:s.value)||"ขาว",e.querySelector('[name="modal_finial_color"]').value=((n=F.querySelector('[name="finial_color"]'))==null?void 0:n.value)||"ขาว",e.querySelector('[name="modal_grommet_color"]').value=((l=F.querySelector('[name="grommet_color"]'))==null?void 0:l.value)||"เงิน",e.querySelector("#grommetColorGroup").style.display=t?"":"none";const r=await W("#hardwareModal");r&&!r.cancelled&&(F.querySelector('[name="track_color"]').value=e.querySelector('[name="modal_track_color"]').value,F.querySelector('[name="bracket_color"]').value=e.querySelector('[name="modal_bracket_color"]').value,F.querySelector('[name="finial_color"]').value=e.querySelector('[name="modal_finial_color"]').value,t&&(F.querySelector('[name="grommet_color"]').value=e.querySelector('[name="modal_grommet_color"]').value),I(),q("บันทึกการตั้งค่าอุปกรณ์แล้ว","success")),F=null}function Le(e,t,r){e&&(Z(O()),K(),e.classList.add("item-removing"),e.addEventListener("animationend",()=>{e.remove(),t&&q(t),r&&r(),ie(),ee(),G(),I(),ue()},{once:!0}))}function ee(){document.querySelectorAll(v.room).forEach(e=>{const t=e.querySelectorAll(".item-card:not(.is-suspended):not(.item-hidden)"),r=t.length;t.forEach((a,s)=>{const n=a.querySelector("[data-item-title]");n&&(n.textContent=`${s+1}/${r}`)}),e.querySelectorAll(".item-card.is-suspended, .item-card.item-hidden").forEach(a=>{const s=a.querySelector("[data-item-title]");s&&(s.textContent="-")})})}function Je(){const e=document.querySelector(v.orderForm),t=document.querySelector(v.lockBtn);!e||!t||(e.classList.toggle("is-locked",V),t.classList.toggle("is-locked",V),t.querySelector("i").className=V?"ph-bold ph-lock-key":"ph ph-paw-print",e.querySelectorAll("input, select, textarea, button").forEach(r=>{r.closest(".summary-footer")||r.closest(".main-header")||r.closest(".modal-wrapper")||r.dataset.act==="toggle-more-details"||r.dataset.act==="collapse-room"||(r.disabled=V)}),q(V?"ฟอร์มถูกล็อค":"ปลดล็อคฟอร์มแล้ว",V?"warning":"success"))}function J(){const e=document.querySelectorAll(v.room);if(e.length===0)return;const t=[...e].some(o=>o.open),r=document.querySelector(v.toggleAllRoomsBtn);r&&(r.querySelector("i").className="ph ph-rows",r.querySelector("span").textContent=t?"ย่อทั้งหมด":"ขยายทั้งหมด")}function xt(){const e=document.querySelectorAll(v.room),t=[...e].some(r=>r.open);e.forEach(r=>{r.open=!t}),setTimeout(()=>{J(),I()},50)}function ie(){const e=document.querySelector(v.quickNavRoomList);e&&(e.innerHTML="",document.querySelectorAll(v.room).forEach(t=>{var a;const r=((a=t.querySelector(v.roomNameInput))==null?void 0:a.value)||"ห้อง",o=document.createElement("a");o.href=`#${t.id}`,o.dataset.jumpTo=t.id,o.innerHTML=`<i class="ph ph-share-fat"></i> ${r}`,e.appendChild(o)}))}function Ke(e){var r;const t=document.getElementById("quickNavBtnText");t&&(e?t.textContent=((r=e.querySelector('input[name="room_name"]'))==null?void 0:r.value)||"...":t.textContent="ไปยังห้อง")}function ue(){if(me&&me.disconnect(),!document.getElementById("quickNavBtnText"))return;const e={root:null,rootMargin:"-60px 0px -150px 0px",threshold:0},t=r=>{const o=r.filter(a=>a.isIntersecting).sort((a,s)=>a.target.getBoundingClientRect().top-s.target.getBoundingClientRect().top);o.length>0&&Ke(o[0].target)};me=new IntersectionObserver(t,e),document.querySelectorAll(v.room).forEach(r=>me.observe(r))}function Se(e){if(!e)return;const t=e.closest(".form-group-with-favorites").querySelector(".btn-favorite");if(!t)return;const r=e.dataset.favoriteType,o=e.value;t.classList.toggle("is-favorite",at(r,o))}function Be(e,t){const r=ce[e];if(!r)return null;const o=document.querySelector(r.templateId);if(!o||!t)return null;const a=o.content.cloneNode(!0),s=a.firstElementChild;s.dataset.type=e,s.classList.add(`${e.replace(/_/g,"-")}-item`);const n=s.querySelector(".item-type-display");if(n&&(n.textContent=r.name),r.templateId==="#areaBasedTpl"){const l=s.querySelector("input[data-favorite-type]"),u=s.querySelector(".btn-favorite");l&&(l.dataset.favoriteType=e),u&&(u.dataset.type=e)}return t.appendChild(a),s}function Tt(e,t){var a;if(!t)return;const r=t.querySelector(v.allItemsContainer);if(!r)return;Z(O()),K(),be();const o=Be(e,r);if(o){if(e==="wallpaper"){const s=Ae(o.querySelector('[data-act="add-wall"]'));s&&((a=s.querySelector("input"))==null||a.focus())}else{const s=o.querySelector('input:not([type="hidden"]), select, textarea');s&&s.focus()}o.classList.add("item-created"),o.scrollIntoView({behavior:"smooth",block:"center"}),ee(),G(),I()}}async function je(e,t=null){const r=document.querySelector("#itemTypeModal");if(!r)return null;r.querySelector("#itemTypeModalTitle").textContent=e;let o=t;t&&!ce[t]&&(o="wooden_blind");const a=r.querySelector(`input[name="item_type_option"][value="${o||"set"}"]`);a&&(a.checked=!0);const s=await W("#itemTypeModal");if(!s||s.cancelled)return null;const n=r.querySelector('input[name="item_type_option"]:checked');return n?n.value:null}function Mt(e,t){if(!ce[t])return;const o=e.parentElement;o&&(Z(O()),K(),e.classList.add("item-removing"),e.addEventListener("animationend",()=>{var s;const a=Be(t,o);a&&(e.replaceWith(a),a.classList.add("item-created"),a.scrollIntoView({behavior:"smooth",block:"center"}),(s=a.querySelector('input:not([type="hidden"]), select, textarea'))==null||s.focus(),ee(),G(),I(),q("เปลี่ยนประเภทรายการแล้ว","success"))},{once:!0}))}function ne(){Z(O()),K();const e=document.querySelector(v.roomsContainer);if(!e)return;const t=document.querySelector("#roomTpl");if(!t)return;const r=Array.from(document.querySelectorAll(v.roomNameInput)).map(u=>parseInt(u.value.replace(/[^0-9]/g,""),10)).filter(u=>!isNaN(u)),s=`ห้อง ${(r.length>0?Math.max(...r):0)+1}`,l=t.content.cloneNode(!0).firstElementChild;if(l){l.id=`room-${Date.now()}`;const u=l.querySelector('input[name="room_name"]'),c=l.querySelector(".room-header-controls .form-group > label");if(u&&c){const f=`room_name_${l.id}`;u.id=f,c.setAttribute("for",f)}u&&(u.value=s);const i=l.querySelector("[data-room-name-display]");i&&(i.textContent=s),l.open=!0,e.appendChild(l),l.classList.add("item-created"),l.scrollIntoView({behavior:"smooth",block:"center"})}ie(),J(),ue(),I()}function Ae(e){var r;const t=(r=e==null?void 0:e.closest(".walls-section"))==null?void 0:r.querySelector(v.wallsContainer);if(t){const o=document.querySelector(v.wallTpl);if(!o)return null;const a=o.content.cloneNode(!0),s=a.querySelector(".wall-input-row");if(!s)return null;const n=s.querySelector("input"),l=s.querySelector("label");if(n&&l){const u=`wall-input-${Date.now()}-${Math.random().toString(36).substring(2,7)}`;n.id=u,l.setAttribute("for",u)}return t.appendChild(a),requestAnimationFrame(()=>{s.classList.add("item-created")}),oe(e),s}return null}function oe(e){var n,l,u,c,i,f,p,y,h,d,m,_;if(!e)return;const t=e.closest(".item-card");if(!t){G();return}const r=t.dataset.type;let o,a,s;switch(r){case"set":o=t.querySelector("[data-set-summary]"),a={width_m:(n=t.querySelector('input[name="width_m"]'))==null?void 0:n.value,height_m:(l=t.querySelector('input[name="height_m"]'))==null?void 0:l.value,style:(u=t.querySelector('select[name="set_style"]'))==null?void 0:u.value,fabric_variant:(c=t.querySelector('select[name="fabric_variant"]'))==null?void 0:c.value,price_per_m_raw:(i=t.querySelector('select[name="set_price_per_m"]'))==null?void 0:i.value,sheer_price_per_m:(f=t.querySelector('select[name="sheer_price_per_m"]'))==null?void 0:f.value},s=M.calculateSetPrice(a),t.dataset.totalPrice=s.total;let b=`ราคา: <b>${x(s.total)}</b> บ.`;s.opaque>0&&s.sheer>0&&(b+=` <small>(ทึบ: ${x(s.opaque)}, โปร่ง: ${x(s.sheer)})</small>`),o&&(o.innerHTML=b);break;case"wallpaper":o=t.querySelector("[data-wallpaper-summary]"),a={height_m:(p=t.querySelector('input[name="wallpaper_height_m"]'))==null?void 0:p.value,price_per_roll:(y=t.querySelector('input[name="wallpaper_price_roll"]'))==null?void 0:y.value,install_cost_per_roll:(h=t.querySelector('input[name="wallpaper_install_cost"]'))==null?void 0:h.value,widths:Array.from(t.querySelectorAll('input[name="wall_width_m"]')).map(S=>S.value)},s=M.calculateWallpaperPrice(a),t.dataset.totalPrice=s.total;let w=`รวม: <b>${x(s.total)}</b> บ. `;(s.material>0||s.install>0)&&(w+=`<small>(วอลล์: ${x(s.material)}, ค่าช่าง: ${x(s.install)})</small>`),s.rolls>0&&(w+=` &bull; พื้นที่: ${j(s.sqm,2)} ตร.ม. &bull; ใช้: ${s.rolls} ม้วน`),o&&(o.innerHTML=w);break;default:o=t.querySelector("[data-area-summary]"),a={width_m:(d=t.querySelector('input[name="area_width_m"]'))==null?void 0:d.value,height_m:(m=t.querySelector('input[name="area_height_m"]'))==null?void 0:m.value,price_sqyd:(_=t.querySelector('input[name="area_price_sqyd"]'))==null?void 0:_.value},s=M.calculateDecoPrice(a),t.dataset.totalPrice=s.total;let $="";s.sqyd>0&&($=` &bull; พื้นที่: ${j(s.sqyd,2)} ตร.หลา`),o&&(o.innerHTML=`ราคา: <b>${x(s.total)}</b> บ.${$}`);break}G()}function G(){let e=0;document.querySelectorAll(v.room).forEach(n=>{let l=0,u=0;const c=n.classList.contains("is-suspended");n.querySelectorAll(".item-card").forEach(f=>{const p=g(f.dataset.totalPrice),y=f.classList.contains("is-suspended");!c&&!y&&(l+=p,p>0&&u++)});const i=n.querySelector("[data-room-brief]");i&&(c?i.textContent="(ระงับชั่วคราว)":u>0?i.innerHTML=`<span>${u}</span> &bull; ${x(l)} บาท`:i.innerHTML="<span>0</span> รายการ"),c||(e+=l)});const t=document.querySelector("#discount_type").value,r=g(document.querySelector("#discount_value").value);let o=0;r>0&&(o=t==="percent"?e*(r/100):r);const a=e-o;document.querySelector("#grandTotal").textContent=x(a);const s=document.querySelector("#originalTotal");o>0?(s.textContent=x(e),s.dataset.rawTotal=e,s.style.display="block"):(s.style.display="none",s.dataset.rawTotal="")}async function Ee(e,t=!1){if(e!=null&&e.favorites)if(t){const s=document.querySelector("#favoritesConflictModal");if(s){const n=await W("#favoritesConflictModal");if(!n||n.cancelled){q("ยกเลิกการนำเข้า","warning");return}switch(s.querySelector('input[name="fav_conflict_option"]:checked').value){case"overwrite":Re(e.favorites)&&q("เขียนทับรายการโปรดสำเร็จ","success");break;case"merge":const u=Ue(e.favorites);q(`รวมข้อมูลสำเร็จ (เพิ่ม ${u} รายการใหม่)`,"success");break}}}else Re(e.favorites);if(!(e!=null&&e.rooms)||!Array.isArray(e.rooms)){e.favorites||q("ไม่พบข้อมูลสำหรับนำเข้าในไฟล์","error");return}const r=document.querySelector(v.roomsContainer);if(!r)return;r.innerHTML="",document.querySelector("#customer_name").value=e.customer_name||"",document.querySelector("#customer_phone").value=e.customer_phone||"",document.querySelector("#customer_address").value=e.customer_address||"",e.discount&&(document.querySelector("#discount_type").value=e.discount.type||"amount",document.querySelector("#discount_value").value=e.discount.value||0),document.querySelector("#customerDetailsCard").open=e.customer_card_open??!0;let o=0;const a=()=>{if(o>=e.rooms.length){document.querySelectorAll("input[data-favorite-type]").forEach(Se),G(),ee(),ie(),J(),ue(),t&&q("นำเข้าข้อมูลฟอร์มสำเร็จ","success");return}const s=e.rooms[o],n=document.querySelector("#roomTpl");if(!n){console.error("Room template not found.");return}const u=n.content.cloneNode(!0).firstElementChild;if(r.appendChild(u),u){u.id=s.id||`room-${Date.now()}`,s.is_suspended&&u.classList.add("is-suspended"),u.open=s.is_open===!0;const c=s.room_name||"ห้อง (ไม่มีชื่อ)",i=u.querySelector('input[name="room_name"]'),f=u.querySelector(".room-header-controls .form-group > label");if(i&&f){const h=`room_name_${u.id}`;i.id=h,f.setAttribute("for",h)}i&&(i.value=c);const p=u.querySelector("[data-room-name-display]");p&&(p.textContent=c);const y=u.querySelector(v.allItemsContainer);if(y&&s.items){const h=document.createDocumentFragment();s.items.forEach(d=>{var _,b,w;d.type==="deco"&&d.deco_type?(d.type=yt[d.deco_type]||"wooden_blind",d.code=d.deco_code,d.width_m=d.deco_width_m,d.height_m=d.deco_height_m,d.price_sqyd=d.deco_price_sqyd,d.notes=d.deco_notes):d.type==="deco"&&(d.type="wooden_blind",d.code=d.deco_code);const m=Be(d.type,h);if(m){switch(d.is_suspended&&m.classList.add("is-suspended"),d.type){case"set":m.querySelector('input[name="width_m"]').value=z(d.width_m),m.querySelector('input[name="height_m"]').value=z(d.height_m),m.querySelector('select[name="set_style"]').value=d.style||d.set_style||"ลอน",m.querySelector('select[name="fabric_variant"]').value=d.fabric_variant||"ทึบ",m.querySelector('select[name="set_price_per_m"]').value=d.price_per_m_raw||d.set_price_per_m||"",m.querySelector('select[name="sheer_price_per_m"]').value=d.sheer_price_per_m||"",m.querySelector('select[name="opening_style"]').value=d.opening_style||"แยกกลาง",m.querySelector('input[name="track_color"]').value=d.track_color||"ขาว",m.querySelector('input[name="bracket_color"]').value=d.bracket_color||"ขาว",m.querySelector('input[name="finial_color"]').value=d.finial_color||"ขาว",m.querySelector('input[name="grommet_color"]').value=d.grommet_color||"เงิน",m.querySelector('input[name="fabric_code"]').value=d.fabric_code||"",m.querySelector('input[name="sheer_fabric_code"]').value=d.sheer_fabric_code||"",m.querySelector('input[name="notes"]').value=d.notes||"";const $=(d.fabric_variant||"").includes("โปร่ง");(_=m.querySelector(v.sheerWrap))==null||_.classList.toggle("hidden",!$),(b=m.querySelector(v.sheerCodeWrap))==null||b.classList.toggle("hidden",!$);break;case"wallpaper":m.querySelector('input[name="wallpaper_height_m"]').value=z(d.height_m||d.wallpaper_height_m),m.querySelector('input[name="wallpaper_code"]').value=d.wallpaper_code||"";const S=g(d.price_per_roll||d.wallpaper_price_roll);m.querySelector('input[name="wallpaper_price_roll"]').value=S>0?x(S):"",m.querySelector('input[name="wallpaper_install_cost"]').value=d.hasOwnProperty("install_cost_per_roll")?x(d.install_cost_per_roll):d.wallpaper_install_cost?x(d.wallpaper_install_cost):"300",m.querySelector('input[name="wallpaper_notes"]').value=d.notes||d.wallpaper_notes||"",d.widths&&d.widths.forEach(L=>{const E=Ae(m.querySelector('[data-act="add-wall"]'));E&&(E.querySelector('input[name="wall_width_m"]').value=z(L))});break;default:if(((w=ce[d.type])==null?void 0:w.templateId)==="#areaBasedTpl"){m.querySelector('input[name="area_width_m"]').value=z(d.width_m),m.querySelector('input[name="area_height_m"]').value=z(d.height_m);const L=g(d.price_sqyd);m.querySelector('input[name="area_price_sqyd"]').value=L>0?x(L):"",m.querySelector('input[name="area_code"]').value=d.code||"",m.querySelector('input[name="area_notes"]').value=d.notes||""}break}oe(m)}}),y.appendChild(h)}}o++,requestAnimationFrame(a)};requestAnimationFrame(a)}function Et(e){if(document.getElementById("loading-overlay"))return;const t=document.createElement("div");t.id="loading-overlay",t.innerHTML=`<div class="loading-spinner"></div><p>${e}</p>`,document.body.appendChild(t),document.body.style.overflow="hidden"}function Ct(){const e=document.getElementById("loading-overlay");e&&e.remove(),document.body.style.overflow=""}async function It(e,t){var o,a;const r=document.querySelector(v.printableContent);if(!r||!e||!e.html){q("ไม่พบข้อมูลสำหรับสร้างเอกสาร","error");return}if(t==="direct"){Et("กำลังสร้าง PDF...");try{typeof html2pdf>"u"&&(q("กำลังโหลดไลบรารี PDF...","default"),await vt("https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"));const s=document.createElement("div");s.style.position="fixed",s.style.left="-300mm",s.style.top="0",s.style.width="210mm",s.style.background="#fff",s.innerHTML=e.html,document.body.appendChild(s),await new Promise(l=>setTimeout(l,500));const n={margin:0,filename:`${e.fileName}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0,logging:!1,width:((o=s.querySelector(".pdf-page"))==null?void 0:o.scrollWidth)||210*3.77,windowWidth:((a=s.querySelector(".pdf-page"))==null?void 0:a.scrollWidth)||210*3.77},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}};await window.html2pdf().from(s).set(n).save(),q("ดาวน์โหลด PDF สำเร็จ","success"),document.body.contains(s)&&document.body.removeChild(s)}catch(s){console.error("PDF Generation Error:",s),q("สร้าง PDF ล้มเหลว, โปรดลองวิธีที่ 2 (พิมพ์)","error")}finally{Ct()}}t==="print"&&(r.innerHTML=e.html,setTimeout(()=>{window.print(),setTimeout(()=>{r.innerHTML=""},1e3)},Ze))}function Bt(e){if(!e||!e.html){q("ไม่พบข้อมูลสำหรับสร้างไฟล์ HTML","error");return}try{const t=`
            <!DOCTYPE html><html lang="th"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>${e.fileName}</title>
                <link rel="stylesheet" href="https://grobmak.github.io/marnthara-form/src/style.css">
                <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/bold/style.css">
                <style>#printable-content { display: block !important; } .pdf-page { border: 1px solid #eee; box-shadow: 0 0 10px rgba(0,0,0,0.1); margin: 10mm auto; } i.ph { vertical-align: middle; }</style>
            </head>
            <body>${e.html}</body></html>`,r=new Blob([t],{type:"text/html;charset=utf-8"}),o=URL.createObjectURL(r),a=document.createElement("a");a.href=o,a.download=`${e.fileName}.html`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(o),q("ดาวน์โหลดไฟล์ HTML สำเร็จ","success")}catch(t){console.error("HTML Export Error:",t),q("สร้างไฟล์ HTML ล้มเหลว","error")}}function At(e){if(!e)return;const t=e.closest(".item-card");if(!t)return;const r=g(e.value);let o,a;const s=e.getAttribute("name");if(s==="set_price_per_m"?(o=t.querySelector('input[name="fabric_code"]'),a="fabric"):s==="sheer_price_per_m"?(o=t.querySelector('input[name="sheer_fabric_code"]'),a="sheer"):s==="wallpaper_price_roll"?(o=t.querySelector('input[name="wallpaper_code"]'),a="wallpaper"):s==="area_price_sqyd"&&(o=t.querySelector('input[name="area_code"]'),o&&(a=o.dataset.favoriteType)),o&&a&&o.value.trim()){const n=Ie(a,o.value);n&&n.price!==r&&(o.value="",Se(o))}}const Nt=tt(e=>{e.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_price_per_m"]')&&At(e),oe(e),I()},200);function De(e){var r,o,a;if(V){e.preventDefault();return}const t=e.target;if(t.matches('select[name="fabric_variant"]')){const s=t.closest(".set-item");if(s){const n=(r=t.value)==null?void 0:r.includes("โปร่ง");(o=s.querySelector(v.sheerWrap))==null||o.classList.toggle("hidden",!n),(a=s.querySelector(v.sheerCodeWrap))==null||a.classList.toggle("hidden",!n)}}if(t.matches(v.roomNameInput)){const s=t.closest(".room-card");if(s){const n=s.querySelector("[data-room-name-display]");n&&(n.textContent=t.value||"ห้อง")}ie(),ue()}t.matches("input[data-favorite-type]")&&Se(t),Nt(t)}function Pt(e){const t=e.target;t.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_install_cost"]')?t.value=g(t.value)>0?x(g(t.value)):"":t.matches('input[name$="_m"], input[name$="width_m"]')&&(t.value=z(t.value))}function Ft(e){const t=e.target;t.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_install_cost"]')&&g(t.value)>0&&(t.value=g(t.value)),t.matches("input[data-favorite-type]")&&(_e=t,Ye(t))}const Rt=async e=>{var i,f,p,y;const t=e.target.closest(".summary-tag[data-filter-type]");if(t){const h=t.dataset.filterType,d=t.textContent.trim().replace(/\s*\d+\s*$/,""),m=document.querySelector("#overviewModal");m&&m.classList.remove("visible"),bt(h,d);return}const r=e.target.closest(".favorite-chips-container .btn-chip");if(r){wt(r);return}const o=e.target.closest(".fav-manager-item");if(o){const h=o.parentElement.querySelector(".is-selected");h&&h.classList.remove("is-selected"),h!==o?(o.classList.add("is-selected"),Me(o)):Me(null);return}const a=e.target.closest("[data-act]");if(!a)return;const s=["toggle-more-details","show-discount-modal","collapse-room"];if(V&&!a.closest(".unlockable")&&!s.includes(a.dataset.act))return;const n=a.dataset.act,l=a.closest(v.room),u=a.closest(".item-card"),c=(h,d,m)=>le(h,d).then(_=>_&&m());switch(n){case"add-room":ne();break;case"add-item":{if($e=a.closest(v.room),$e){const m=await je("เพิ่มรายการใหม่");m&&Tt(m,$e)}break}case"collapse-room":l&&(e.preventDefault(),l.open=!1,(i=l.querySelector("summary"))==null||i.scrollIntoView({behavior:"smooth",block:"center"}));break;case"clear-filter":St();break;case"change-type":{const m=u==null?void 0:u.dataset.type;if(u&&m){const _=await je("เปลี่ยนประเภทรายการ",m);_&&_!==m&&c("ยืนยันการเปลี่ยนแปลง","ข้อมูลทั้งหมดในรายการนี้จะถูกลบและสร้างใหม่ คุณแน่ใจหรือไม่?",()=>Mt(u,_))}break}case"add-wall":{const m=Ae(a);m&&((f=m.querySelector('input[name="wall_width_m"]'))==null||f.focus());break}case"show-discount-modal":kt();break;case"open-hardware-modal":{F=u,Lt();break}case"apply-hardware-to-room":{const m=a.closest("#hardwareModal"),_=F==null?void 0:F.closest(v.room);if(!m||!_)break;const b=m.querySelector('[name="modal_track_color"]').value,w=m.querySelector('[name="modal_bracket_color"]').value,$=m.querySelector('[name="modal_finial_color"]').value,S=m.querySelector('[name="modal_grommet_color"]').value;_.querySelectorAll(".set-item").forEach(L=>{L.querySelector('[name="track_color"]').value=b,L.querySelector('[name="bracket_color"]').value=w,L.querySelector('[name="finial_color"]').value=$,L.querySelector('[name="grommet_color"]').value=S}),I(),q("ใช้การตั้งค่ากับทุกรายการในห้องแล้ว","success");break}case"toggle-more-details":{const m=u==null?void 0:u.querySelector(".item-details-more");if(m){const _=m.classList.toggle("show");a.classList.toggle("expanded",_),a.querySelector("i").className=_?"ph ph-caret-up":"ph ph-caret-down",a.querySelector("span").textContent=_?"ย่อน้อยลง":"เพิ่มเติม"}break}case"toggle-favorite":{const m=a.closest(".form-group-with-favorites").querySelector("input[data-favorite-type]");if(!m||!u)break;const _=m.dataset.favoriteType,b=m.value;let w;_==="fabric"?w="set_price_per_m":_==="sheer"?w="sheer_price_per_m":_==="wallpaper"?w="wallpaper_price_roll":w="area_price_sqyd";const $=u.querySelector(`[name="${w}"]`),S=g($==null?void 0:$.value);if(!b.trim()){q("โปรดระบุรหัสก่อนบันทึก","warning");break}if(S<=0&&_!=="fabric"&&_!=="sheer"){q("โปรดระบุราคาก่อนบันทึก","warning");break}const L=qe(_,b,S);a.classList.toggle("is-favorite",L),q(L?"เพิ่มในรายการโปรดแล้ว":"ลบออกจากรายการโปรด","success"),I();break}case"manage-favorites":{const m=a.dataset.type;_e=a.closest(".form-group-with-favorites").querySelector("input[data-favorite-type]"),qt(m);break}case"add-new-fav-form":{const _=a.closest("#favManagerModal").dataset.currentType;if(!_)break;const b=document.querySelector("#favAddModal");b.querySelector("h3").textContent=`เพิ่ม '${((p=ce[_])==null?void 0:p.name)||_}'`;const w=b.querySelector('[name="fav_code_add"]'),$=b.querySelector('[name="fav_price_add"]');w.value="",$.value="";const S=await W("#favAddModal");if(S&&!S.cancelled){const L=w.value.trim(),E=g($.value);L&&(qe(_,L,E),se=!0,ve(_),q("เพิ่มรายการโปรดแล้ว","success"))}break}case"edit-selected-fav":{if(!D)break;const _=a.closest("#favManagerModal").dataset.currentType;if(!_)break;const b=document.querySelector("#favEditModal");b.querySelector("h3").textContent=`แก้ไข '${D.code}'`;const w=b.querySelector('[name="fav_code_edit"]'),$=b.querySelector('[name="fav_price_edit"]');w.value=D.code,$.value=D.price>0?D.price:"";const S=await W("#favEditModal");if(S&&!S.cancelled){const L=w.value.trim(),E=g($.value);L&&(L!==D.code&&xe(_,D.code),qe(_,L,E),se=!0,ve(_),q("แก้ไขรายการโปรดแล้ว","success"))}break}case"del-selected-fav":{if(!D)break;const _=a.closest("#favManagerModal").dataset.currentType;if(!_)break;await le("ลบรายการโปรด",`ยืนยันการลบรหัส "${D.code}"?`)&&(xe(_,D.code),se=!0,ve(_),q("ลบรายการโปรดแล้ว","success"));break}case"del-room":c("ลบห้อง","ยืนยันการลบห้องนี้?",()=>Le(l,"ลบห้องแล้ว"));break;case"del-item":c("ลบรายการ","ยืนยันการลบรายการนี้?",()=>Le(u,"ลบรายการแล้ว"));break;case"del-wall":c("ลบผนัง","ยืนยันการลบผนังนี้?",()=>Le(a.closest(".wall-input-row"),"ลบผนังแล้ว",()=>oe(u)));break;case"clear-room":c("ล้างข้อมูลในห้อง","ยืนยันลบทุกรายการในห้องนี้?",()=>{Z(O()),K(),l.querySelector(v.allItemsContainer).innerHTML="",ee(),G(),I(),q("ล้างข้อมูลในห้องแล้ว","success")});break;case"toggle-room-menu":e.preventDefault();const h=a.nextElementSibling;if(!h||!l)return;const d=!h.classList.contains("show");document.querySelectorAll(".room-options-menu.show").forEach(m=>m.classList.remove("show")),document.querySelectorAll(".card.overflow-visible").forEach(m=>m.classList.remove("overflow-visible")),d&&(h.classList.add("show"),l.classList.add("overflow-visible"));break;case"toggle-suspend-room":e.preventDefault(),l==null||l.classList.toggle("is-suspended"),G(),I(),(y=a.closest(".room-options-menu"))==null||y.classList.remove("show"),l==null||l.classList.remove("overflow-visible");break;case"toggle-suspend":e.preventDefault(),u==null||u.classList.toggle("is-suspended"),oe(a),I();break}};function Ot(){V=!V,Je()}function Ht(e){if(!e||e.closest(".modal-wrapper"))return;const t=e.getAttribute("name"),r=e.closest(".item-card"),s=(n=>{const l=n[t];if(!l)return null;const u=r||document;let c=null;return typeof l=="string"?c=u.querySelector(`[name="${l}"]:not(:disabled)`):typeof l=="function"&&(c=l(e)),!c&&r&&typeof l=="string"&&(c=document.querySelector(`[name="${l}"]:not(:disabled)`)),c})({customer_name:"customer_phone",customer_phone:"customer_address",customer_address:()=>document.querySelector(".room-name-input"),room_name:n=>{var l;return(l=n.closest(".room-card"))==null?void 0:l.querySelector('[data-act="add-item"]')},width_m:"height_m",height_m:"set_price_per_m",set_price_per_m:n=>{var c;const l=n.closest(".set-item"),u=(c=l==null?void 0:l.querySelector('[name="fabric_variant"]'))==null?void 0:c.value;return u!=null&&u.includes("โปร่ง")?l==null?void 0:l.querySelector('[name="sheer_price_per_m"]'):l==null?void 0:l.querySelector('[data-act="toggle-more-details"]')},sheer_price_per_m:n=>{var l;return(l=n.closest(".item-card"))==null?void 0:l.querySelector('[data-act="toggle-more-details"]')},area_width_m:"area_height_m",area_height_m:"area_price_sqyd",area_price_sqyd:"area_code",wall_width_m:n=>{var u,c;const l=(u=n.closest(".wall-input-row"))==null?void 0:u.nextElementSibling;return l!=null&&l.matches(".wall-input-row")?l.querySelector("input"):(c=n.closest(".item-card"))==null?void 0:c.querySelector('[name="wallpaper_price_roll"]')},wallpaper_price_roll:"wallpaper_height_m",wallpaper_height_m:"wallpaper_code"});s&&(s.focus(),typeof s.select=="function"&&s.select())}function jt(){const e=document.querySelector(v.setTpl);if(!e)return;const t=e.content.querySelector('select[name="set_price_per_m"]'),r=e.content.querySelector('select[name="sheer_price_per_m"]'),o=a=>{let s='<option value="" hidden>เลือกราคา</option>';return Array.isArray(a)?(a.forEach(n=>{s+=`<option value="${n}">${n.toLocaleString("th-TH")}</option>`}),s):(console.error("Price data for dropdown is not available or not an array.",a),s)};t&&(t.innerHTML=o(ye.fabric)),r&&(r.innerHTML=o(ye.sheer))}function Dt(){jt(),Ve();const e=document.querySelector(v.orderForm),t=document.querySelector(v.fileImporter),r=document.querySelector("#favImporter"),o=document.querySelector(v.menuDropdown),a=document.querySelector(v.quickNavDropdown),s=document.querySelector("#pageBreakBuffer"),n=document.querySelector("#pageBreakBufferValue");s&&n&&s.addEventListener("input",()=>{n.textContent=s.value}),e.addEventListener("input",De),e.addEventListener("change",De),document.addEventListener("click",Rt),e.addEventListener("blur",Pt,!0),e.addEventListener("focusin",Ft,!0),e.addEventListener("keydown",c=>{const i=c.target;c.key==="Enter"&&!i.matches("textarea, button, [data-act]")&&(c.preventDefault(),Ht(i))});const l=c=>{const i=c.target.closest(v.room);i&&Ke(i)};e.addEventListener("click",l),e.addEventListener("focusin",l),document.body.addEventListener("click",c=>{c.target.closest("summary")&&setTimeout(()=>{J(),I()},50)}),document.querySelector("#undoBtn").addEventListener("click",c=>{c.preventDefault(),gt()}),document.querySelector(v.lockBtn).addEventListener("click",Ot),document.querySelector(v.toggleAllRoomsBtn).addEventListener("click",xt),document.querySelector(v.quickNavBtn).addEventListener("click",c=>{var f;c.stopPropagation(),o.classList.remove("show");const i=!a.classList.contains("show");a.classList.toggle("show"),c.currentTarget.setAttribute("aria-expanded",i),i&&((f=document.querySelector(v.menuBtn))==null||f.setAttribute("aria-expanded","false"))}),document.querySelector(v.quickNavRoomList).addEventListener("click",c=>{var f;const i=c.target.closest("a[data-jump-to]");if(i){c.preventDefault();const p=i.dataset.jumpTo,y=document.getElementById(p);y&&(document.body.classList.add("disable-animations"),y.open=!0,y.scrollIntoView({behavior:"auto",block:"start"}),y.classList.add("scrolling-jump"),setTimeout(()=>{y.classList.remove("scrolling-jump"),document.body.classList.remove("disable-animations"),J()},1e3)),a.classList.remove("show"),(f=document.querySelector(v.quickNavBtn))==null||f.setAttribute("aria-expanded","false")}});const u=document.querySelector("#addRoomQuickNavBtn");if(u){const c=rt(ne,700);u.addEventListener("click",i=>{var f;i.stopPropagation(),c(),a.classList.remove("show"),(f=document.querySelector(v.quickNavBtn))==null||f.setAttribute("aria-expanded","false")})}document.querySelector(v.menuBtn).addEventListener("click",c=>{var f;c.stopPropagation(),a.classList.remove("show");const i=!o.classList.contains("show");o.classList.toggle("show"),c.currentTarget.setAttribute("aria-expanded",i),i&&((f=document.querySelector(v.quickNavBtn))==null||f.setAttribute("aria-expanded","false"))}),document.querySelector("#themeToggleBtn").addEventListener("click",c=>{c.preventDefault(),_t()}),document.querySelector("#overviewBtn").addEventListener("click",async c=>{var y;c.preventDefault(),o.classList.remove("show"),(y=document.querySelector(v.menuBtn))==null||y.setAttribute("aria-expanded","false");const i=O(),f=document.querySelector("#overviewModalHeader"),p=document.querySelector("#overviewModalBody");if(f&&p){const h=i.rooms.reduce((_,b)=>{if(b.is_suspended)return _;const w=(b.items||[]).filter($=>{if($.is_suspended)return!1;let S=0;switch($.type){case"set":S=M.calculateSetPrice($).total;break;case"wallpaper":S=M.calculateWallpaperPrice($).total;break;default:S=M.calculateDecoPrice($).total;break}return S>0}).length;return _+w},0),d=document.querySelector(v.grandTotal).textContent||"0",m=i.rooms.filter(_=>!_.is_suspended&&_.items&&_.items.some(b=>!b.is_suspended)).length;f.innerHTML=`
                <div class="overview-stats-grid">
                    <div class="overview-stat-card">
                        <i class="ph-bold ph-map-pin-line"></i>
                        <div class="stat-value">${m}</div>
                        <div class="stat-label">ห้อง</div>
                    </div>
                    <div class="overview-stat-card">
                        <i class="ph-bold ph-stack"></i>
                        <div class="stat-value">${h}</div>
                        <div class="stat-label">รายการ</div>
                    </div>
                    <div class="overview-stat-card">
                        <i class="ph-bold ph-coins"></i>
                        <div class="stat-value">${d}</div>
                        <div class="stat-label">ยอดรวม</div>
                    </div>
                </div>
            `,p.innerHTML=ut(i),W("#overviewModal")}}),document.querySelector(v.exportPdfBtn).addEventListener("click",async c=>{var y;c.preventDefault(),o.classList.remove("show"),(y=document.querySelector(v.menuBtn))==null||y.setAttribute("aria-expanded","false");const i=await $t();if(!i)return;const f=O(),p=dt(f,{vatRate:i.vatOption==="include"?P.baseVatRate:0,pageBreakBuffer:i.pageBreakBuffer});if(!p){q("ไม่มีรายการที่มีราคาสำหรับสร้างเอกสาร","warning");return}i.exportMethod==="html"?Bt(p):It(p,i.exportMethod)}),document.querySelector("#visualReportsBtn").addEventListener("click",async c=>{var i;c.preventDefault(),o.classList.remove("show"),(i=document.querySelector(v.menuBtn))==null||i.setAttribute("aria-expanded","false"),W("#visualReportsModal")}),document.querySelector("#visualReportsConfirm").addEventListener("click",async c=>{var p;c.preventDefault();const i=document.querySelector("#visualReportsModal"),f=(p=i.querySelector('input[name="report_type_option"]:checked'))==null?void 0:p.value;if(!f){q("โปรดเลือกประเภทรายงาน","warning");return}if(i.classList.remove("visible"),f==="lookbook"){const y=O(),h=mt(y),d=document.querySelector("#lookbookModalBody");h&&d?(d.innerHTML=h,W("#lookbookModal")):q("ไม่มีข้อมูลสำหรับสร้างรายงาน","warning")}else q(`รายงานประเภท '${f}' ยังไม่พร้อมใช้งาน`,"default")}),document.querySelector(v.importBtn).addEventListener("click",c=>{var i;c.preventDefault(),o.classList.remove("show"),(i=document.querySelector(v.menuBtn))==null||i.setAttribute("aria-expanded","false"),t.click()}),t.addEventListener("change",c=>{var p;const i=(p=c.target.files)==null?void 0:p[0];if(!i)return;const f=new FileReader;f.onload=async y=>{try{const h=JSON.parse(y.target.result);await Ee(h,!0)}catch(h){q("ไฟล์ JSON ไม่ถูกต้อง","error"),console.error("JSON Parse Error:",h)}},f.readAsText(i),c.target.value=null}),document.querySelector(v.exportBtn).addEventListener("click",c=>{var i;c.preventDefault(),o.classList.remove("show"),(i=document.querySelector(v.menuBtn))==null||i.setAttribute("aria-expanded","false");try{const f=O(),p=JSON.stringify(f,null,4),y=new Blob([p],{type:"application/json"}),h=URL.createObjectURL(y),d=document.createElement("a"),m=new Date,_=`${m.getFullYear()}${(m.getMonth()+1).toString().padStart(2,"0")}${m.getDate().toString().padStart(2,"0")}`,b=`${m.getHours().toString().padStart(2,"0")}${m.getMinutes().toString().padStart(2,"0")}`,w=We(f.customer_name||"data");d.href=h,d.download=`MTR-${_}${b}-${w}.json`,d.click(),URL.revokeObjectURL(h),q("Export ข้อมูลสำเร็จ","success")}catch{q("Export ข้อมูลล้มเหลว","error")}}),document.querySelector("#importFavsBtn").addEventListener("click",c=>{var i;c.preventDefault(),o.classList.remove("show"),(i=document.querySelector(v.menuBtn))==null||i.setAttribute("aria-expanded","false"),r.click()}),r.addEventListener("change",c=>{var p;const i=(p=c.target.files)==null?void 0:p[0];if(!i)return;const f=new FileReader;f.onload=y=>{try{const h=JSON.parse(y.target.result),d=Ue(h);d>0?q(`เพิ่มรายการโปรดใหม่ ${d} รายการ`,"success"):q("ไม่พบรายการโปรดใหม่ที่จะเพิ่ม","default"),I()}catch(h){q("ไฟล์ JSON ไม่ถูกต้อง","error"),console.error("Favorites JSON Parse Error:",h)}},f.readAsText(i),c.target.value=null}),document.querySelector("#exportFavsBtn").addEventListener("click",c=>{var i;c.preventDefault(),o.classList.remove("show"),(i=document.querySelector(v.menuBtn))==null||i.setAttribute("aria-expanded","false");try{const f=Q(),p=JSON.stringify(f,null,4),y=new Blob([p],{type:"application/json"}),h=URL.createObjectURL(y),d=document.createElement("a"),m=new Date,_=`${m.getFullYear()}${(m.getMonth()+1).toString().padStart(2,"0")}${m.getDate().toString().padStart(2,"0")}`;d.href=h,d.download=`MTR-Favorites-${_}.json`,d.click(),URL.revokeObjectURL(h),q("Export รายการโปรดสำเร็จ","success")}catch{q("Export รายการโปรดล้มเหลว","error")}}),document.querySelector(v.submitBtn).addEventListener("click",async c=>{var i;if(c.preventDefault(),o.classList.remove("show"),(i=document.querySelector(v.menuBtn))==null||i.setAttribute("aria-expanded","false"),await le("ส่งข้อมูล","ยืนยันการส่งข้อมูลการประเมินราคา?")){const f=O();if(!f.customer_name&&!f.customer_phone){q("กรุณาระบุชื่อหรือเบอร์โทรลูกค้า","warning");return}q("กำลังส่งข้อมูล...","default");try{const p=await fetch(ze,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(f)});p.ok?q("ส่งข้อมูลสำเร็จ!","success"):q(`ส่งข้อมูลล้มเหลว: ${p.status}`,"error")}catch{q("เกิดข้อผิดพลาดในการเชื่อมต่อ","error")}}}),document.querySelector(v.copyTextBtn).addEventListener("click",async c=>{var p;c.preventDefault(),o.classList.remove("show"),(p=document.querySelector(v.menuBtn))==null||p.setAttribute("aria-expanded","false");const i=document.querySelector(v.copyOptionsModal);i.querySelector('input[name="copy_option"][value="customer"]').checked=!0;const f=await W(v.copyOptionsModal);if(f&&!f.cancelled){const y=i.querySelector('input[name="copy_option"]:checked').value,h=it(O(),y);try{await navigator.clipboard.writeText(h),q("คัดลอกสรุปสำเร็จ!","success")}catch{q("คัดลอกล้มเหลว","error")}}}),document.querySelector(v.clearItemsBtn).addEventListener("click",async c=>{var i;c.preventDefault(),o.classList.remove("show"),(i=document.querySelector(v.menuBtn))==null||i.setAttribute("aria-expanded","false"),await le("ล้างทุกรายการ","คุณแน่ใจหรือไม่ว่าต้องการลบรายการสินค้าทั้งหมด (ข้อมูลลูกค้าและห้องจะยังคงอยู่)?")&&(Z(O()),K(),document.querySelectorAll(v.room).forEach(f=>{const p=f.querySelector(v.allItemsContainer);p&&(p.innerHTML="")}),G(),I(),q("ล้างทุกรายการแล้ว","success"))}),document.querySelector(v.clearAllBtn).addEventListener("click",async c=>{var i;if(c.preventDefault(),o.classList.remove("show"),(i=document.querySelector(v.menuBtn))==null||i.setAttribute("aria-expanded","false"),await le("ลบข้อมูลทั้งหมด",'คำเตือน! การกระทำนี้จะลบข้อมูลลูกค้า, ทุกรายการ, และ "รายการโปรด" ทั้งหมดอย่างถาวร ยืนยันหรือไม่?')){Z(O()),K(),localStorage.removeItem(fe),st();const f=document.querySelector("#customer_name"),p=document.querySelector("#customer_phone"),y=document.querySelector("#customer_address");f&&(f.value=""),p&&(p.value=""),y&&(y.value="");const h=document.querySelector("#discount_type"),d=document.querySelector("#discount_value");h&&(h.value="amount"),d&&(d.value="0");const m=document.querySelector(v.roomsContainer);m&&(m.innerHTML=""),G(),ie(),J(),ne();const _=document.querySelector("#customerDetailsCard");_&&(_.open=!0),q("ลบข้อมูลทั้งหมดแล้ว เริ่มต้นใหม่","success")}}),window.addEventListener("click",c=>{var i,f;c.target.closest(".modal-wrapper")||(c.target.closest(".menu-container")||(o.classList.contains("show")&&(o.classList.remove("show"),(i=document.querySelector(v.menuBtn))==null||i.setAttribute("aria-expanded","false")),a.classList.contains("show")&&(a.classList.remove("show"),(f=document.querySelector(v.quickNavBtn))==null||f.setAttribute("aria-expanded","false"))),c.target.closest(".room-options-container")||(document.querySelectorAll(".room-options-menu.show").forEach(p=>p.classList.remove("show")),document.querySelectorAll(".card.overflow-visible").forEach(p=>p.classList.remove("overflow-visible"))),c.target.closest(".form-group-with-favorites")||be())}),window.addEventListener("beforeunload",I);try{const c=localStorage.getItem(fe);if(c&&c.length>2&&c!=="null")Ee(JSON.parse(c),!1);else{ne();const i=document.querySelector("#customerDetailsCard");i&&(i.open=!0)}}catch(c){console.error("Failed to load data from localStorage:",c),localStorage.removeItem(fe),ne()}G(),Je(),J(),ue(),K()}document.addEventListener("DOMContentLoaded",Dt);
