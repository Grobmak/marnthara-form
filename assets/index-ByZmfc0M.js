(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))t(r);new MutationObserver(r=>{for(const l of r)if(l.type==="childList")for(const n of l.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&t(n)}).observe(document,{childList:!0,subtree:!0});function s(r){const l={};return r.integrity&&(l.integrity=r.integrity),r.referrerPolicy&&(l.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?l.credentials="include":r.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function t(r){if(r.ep)return;r.ep=!0;const l=s(r);fetch(r.href,l)}})();const ct="vite-refactor/6.0.0",it="https://your-make-webhook-url.com/your-unique-path",de="marnthara.input.v6",dt=500,P={name:"ม่านธารา ผ้าม่านและของตกแต่ง",address:"65/8 หมู่ 2 ต.ท่าศาลา อ.เมือง จ.ลพบุรี 15000",phone:"092-985-9395, 082-552-5595",taxId:"1600668000020",logoUrl:"./assets/logo.png",baseVatRate:.07,pdf:{paymentTerms:"ชำระมัดจำ 50%",priceValidity:"30 วัน",notes:["ราคานี้รวมค่าติดตั้งแล้ว","ชำระมัดจำ 50% เพื่อยืนยันการสั่งผลิตสินค้า","ใบเสนอราคานี้มีอายุ 30 วัน นับจากวันที่เสนอราคา"]}},ut=1.19599,Le={ROLL_WIDTH_M:.53,ROLL_LENGTH_M:10,STRIPS_PER_ROLL_UNDER_2_5M:3},_e={fabric:[1e3,1100,1200,1300,1400,1500,1600,1700,1800,1900,2e3,2100,2200],sheer:[1e3,1100,1200,1300,1400,1500],style_surcharge:{ลอน:200,ตาไก่:0,จีบ:0,ม่านพับ:0},height:[{threshold:3.2,add_per_m:300},{threshold:2.8,add_per_m:200},{threshold:2.5,add_per_m:100}]},F={set:{templateId:"#setTpl",name:"ผ้าม่าน"},wallpaper:{templateId:"#wallpaperTpl",name:"วอลล์เปเปอร์"},wooden_blind:{templateId:"#areaBasedTpl",name:"มู่ลี่ไม้"},roller_blind:{templateId:"#areaBasedTpl",name:"ม่านม้วน"},vertical_blind:{templateId:"#areaBasedTpl",name:"ม่านปรับแสง"},partition:{templateId:"#areaBasedTpl",name:"ฉากกั้นห้อง"},pleated_screen:{templateId:"#areaBasedTpl",name:"มุ้งจีบ"},aluminum_blind:{templateId:"#areaBasedTpl",name:"มู่ลี่อลูมิเนียม"}},w={orderForm:"#orderForm",roomsContainer:"#rooms",roomTpl:"#roomTpl",setTpl:"#setTpl",areaBasedTpl:"#areaBasedTpl",wallpaperTpl:"#wallpaperTpl",wallTpl:"#wallTpl",clearAllBtn:"#clearAllBtn",lockBtn:"#lockBtn",grandTotal:"#grandTotal",modal:"#confirmationModal",modalTitle:"#modalTitle",modalBody:"#modalBody",room:".room-card",allItemsContainer:"[data-all-items]",roomNameInput:'input[name="room_name"]',toastContainer:"#toast-container",copyOptionsModal:"#copyOptionsModal",menuBtn:"#menuBtn",menuDropdown:"#menuDropdown",importBtn:"#importBtn",exportBtn:"#exportBtn",fileImporter:"#fileImporter",submitBtn:"#submitBtn",clearItemsBtn:"#clearItemsBtn",exportPdfBtn:"#exportPdfBtn",exportOptionsModal:"#exportOptionsModal",printableContent:"#printable-content",quickNavBtn:"#quickNavBtn",quickNavDropdown:"#quickNavDropdown",quickNavRoomList:"#quickNavRoomList",toggleAllRoomsBtn:"#toggleAllRoomsBtn"},v=e=>{typeof e=="string"&&(e=e.replace(/,/g,""));const o=parseFloat(e);return Number.isFinite(o)?o:0},te=e=>{const o=v(e);return o>0?o.toFixed(2):""},U=(e,o=2,s=!1)=>Number.isFinite(e)?e.toLocaleString("en-US",{minimumFractionDigits:s?2:o,maximumFractionDigits:s?2:o}):"0",M=(e,o=0)=>Number.isFinite(e)?e.toLocaleString("th-TH",{minimumFractionDigits:o,maximumFractionDigits:o}):"0",pe=(e,o=150)=>{let s;return(...t)=>{clearTimeout(s),s=setTimeout(()=>e(...t),o)}},mt=(e,o=700)=>{let s=!1;return(...t)=>{if(!s){s=!0;try{return e(...t)}finally{setTimeout(()=>{s=!1},o)}}}},T=e=>typeof e!="string"?"":e.replace(/[&<>"']/g,function(o){switch(o){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";default:return"&#039;"}}),Je=e=>typeof e!="string"?"":e.replace(/[\\/?%*:|"<>\x00-\x1f]/g,"").trim()||"file";function pt(e){let o=v(e);if(isNaN(o))return"ข้อมูลตัวเลขไม่ถูกต้อง";if(o===0)return"ศูนย์บาทถ้วน";const s=["","หนึ่ง","สอง","สาม","สี่","ห้า","หก","เจ็ด","แปด","เก้า"],t=["","สิบ","ร้อย","พัน","หมื่น","แสน","ล้าน"];let r=Math.floor(o),l=Math.round((o-r)*100);const n=d=>{if(d===0)return"";let i="";const p=String(d);for(let u=0;u<p.length;u++){const f=p[u],g=p.length-u-1;f!=="0"&&(g===1&&f==="1"?i+=t[g]:g===1&&f==="2"?i+="ยี่"+t[g]:g===0&&f==="1"&&p.length>1?i+="เอ็ด":i+=s[parseInt(f)]+t[g])}return i};let a="";if(r>0){const d=Math.floor(r/1e6),i=r%1e6;d>0&&(a+=n(d)+"ล้าน"),a+=n(i),a+="บาท"}let c="";return l>0?c=n(l)+"สตางค์":r>0&&(a+="ถ้วน"),(a+c).trim()}const Fe="marnthara.favorites.v4",ue={fabric:[],sheer:[],wallpaper:[],wooden_blind:[],roller_blind:[],vertical_blind:[],partition:[],pleated_screen:[],aluminum_blind:[]};function Z(){try{const e=localStorage.getItem(Fe);return e?{...ue,...JSON.parse(e)}:ue}catch(e){return console.error("Failed to parse favorites from localStorage",e),ue}}function Se(e){try{localStorage.setItem(Fe,JSON.stringify(e))}catch(o){console.error("Failed to save favorites to localStorage",o)}}function je(e){if(!e||typeof e!="object")return console.error("Invalid favorites data for import."),!1;const o={...ue,...e};return Se(o),!0}function Ce(e){if(!e||typeof e!="object")return console.error("Invalid favorites data for merge."),0;const o=Z();let s=0;for(const t in e)Object.hasOwnProperty.call(e,t)&&Array.isArray(e[t])&&(o[t]||(o[t]=[]),e[t].forEach(r=>{!o[t].some(n=>n.code===r.code)&&r.code&&(o[t].push(r),s++)}),o[t].sort((r,l)=>r.code.localeCompare(l.code)));return s>0&&Se(o),s}function ft(e,o,s){const t=Z();if(!t[e]){if(!Object.hasOwnProperty.call(ue,e))return console.error(`Attempted to add favorite to an invalid type: ${e}`),!1;t[e]=[]}const r=t[e],l=r.find(n=>n.code===o);return l?l.price=s:r.push({code:o,price:s}),r.sort((n,a)=>n.code.localeCompare(a.code)),Se(t),!0}function Ae(e,o){const s=Z();if(!s[e])return!1;const t=s[e].findIndex(r=>r.code===o);return t>-1?(s[e].splice(t,1),Se(s),!0):!1}function Ke(e,o){if(!e||!o)return;const s=Z(),t=o.trim();return(s[e]||[]).find(l=>l.code===t)}function Qe(e,o){return!!Ke(e,o)}function ye(e,o,s){return Qe(e,o)?(Ae(e,o),!1):(ft(e,o,s),!0)}function ht(){localStorage.removeItem(Fe),console.log("All favorites have been cleared.")}function V(){const e=Z(),o={app_version:ct,customer_name:document.querySelector('[name="customer_name"]')?.value||"",customer_phone:document.querySelector('[name="customer_phone"]')?.value||"",customer_address:document.querySelector('[name="customer_address"]')?.value||"",customer_card_open:document.querySelector("#customerDetailsCard")?.open,discount:{type:document.querySelector("#discount_type")?.value||"amount",value:v(document.querySelector("#discount_value")?.value)},rooms:[],favorites:e};return document.querySelectorAll(w.room).forEach(s=>{const t={id:s.id,room_name:s.querySelector(w.roomNameInput)?.value||"",is_suspended:s.classList.contains("is-suspended"),is_open:s.open,items:[]};s.querySelector(w.allItemsContainer)?.childNodes.forEach(r=>{if(r.nodeType!==1||!r.matches(".item-card"))return;const l=r.dataset.type;if(!l)return;let n={type:l,is_suspended:r.classList.contains("is-suspended")};l==="set"?Object.assign(n,{width_m:v(r.querySelector('input[name="width_m"]')?.value),height_m:v(r.querySelector('input[name="height_m"]')?.value),style:r.querySelector('select[name="set_style"]')?.value||"",fabric_variant:r.querySelector('select[name="fabric_variant"]')?.value||"",price_per_m_raw:v(r.querySelector('select[name="set_price_per_m"]')?.value),sheer_price_per_m:v(r.querySelector('select[name="sheer_price_per_m"]')?.value),fabric_code:r.querySelector('input[name="fabric_code"]')?.value||"",sheer_fabric_code:r.querySelector('input[name="sheer_fabric_code"]')?.value||"",opening_style:r.querySelector('select[name="opening_style"]')?.value||"",adjustment_side:r.querySelector('select[name="adjustment_side"]')?.value||"ปรับขวา",track_color:r.querySelector('input[name="track_color"]')?.value||"ขาว",bracket_color:r.querySelector('input[name="bracket_color"]')?.value||"ขาว",finial_color:r.querySelector('input[name="finial_color"]')?.value||"ขาว",grommet_color:r.querySelector('input[name="grommet_color"]')?.value||"เงิน",notes:r.querySelector('input[name="notes"]')?.value||""}):l==="wallpaper"?Object.assign(n,{height_m:v(r.querySelector('[name="wallpaper_height_m"]')?.value),wallpaper_code:r.querySelector('[name="wallpaper_code"]')?.value||"",price_per_roll:v(r.querySelector('[name="wallpaper_price_roll"]')?.value),install_cost_per_roll:v(r.querySelector('[name="wallpaper_install_cost"]')?.value),notes:r.querySelector('[name="wallpaper_notes"]')?.value||"",widths:Array.from(r.querySelectorAll('[name="wall_width_m"]')).map(a=>v(a.value))}):r.matches(".area-based-item")&&(Object.assign(n,{width_m:v(r.querySelector('[name="area_width_m"]')?.value),height_m:v(r.querySelector('[name="area_height_m"]')?.value),price_sqyd:v(r.querySelector('[name="area_price_sqyd"]')?.value),code:r.querySelector('[name="area_code"]')?.value||"",notes:r.querySelector('[name="area_notes"]')?.value||""}),(l==="partition"||l==="pleated_screen")&&(n.opening_style=r.querySelector('select[name="opening_style"]')?.value||"แยกกลาง"),["wooden_blind","roller_blind","vertical_blind","aluminum_blind"].includes(l)&&(n.adjustment_side=r.querySelector('select[name="adjustment_side"]')?.value||"ปรับขวา")),t.items.push(n)}),o.rooms.push(t)}),o}function j(){try{const e=V();localStorage.setItem(de,JSON.stringify(e))}catch(e){console.error("Failed to save data to localStorage:",e)}}const se=[],vt=10;function le(e){if(!e){console.warn("Attempted to push invalid state to undo stack.");return}try{const o=JSON.parse(JSON.stringify(e));se.push(o),se.length>vt&&se.shift()}catch(o){console.error("Failed to clone state for undo history:",o)}}function yt(){if(se.length!==0)return se.pop()}function gt(){return se.length>0}const A={stylePlus:e=>_e.style_surcharge[e]??0,heightPlus:e=>{const o=[..._e.height].sort((s,t)=>t.threshold-s.threshold);for(const s of o)if(e>s.threshold)return s.add_per_m;return 0},fabricYardage:(e,o)=>{const s=v(o);return s<=0||!e?0:e==="ตาไก่"||e==="จีบ"?(s*2+.6)/.9:e==="ลอน"?(s*2.6+.6)/.9:e==="ม่านพับ"?(s+.3)/.9:0},calculateGrommets:function(e){if(!e||e.style!=="ตาไก่"||v(e.width_m)<=0)return 0;const o=v(e.width_m),s=2,t=.05,r=.16;let l;e.opening_style==="แยกกลาง"?l=o/2:l=o;const n=l*s+2*t;let a=Math.round(n/r);return a%2!==0&&(a+=1),a<4&&(a=4),e.opening_style==="แยกกลาง"?a*2:a},wallpaperRolls:(e,o)=>{const s=v(e),t=v(o);if(s<=0||t<=0)return 0;const r=t>2.5?Math.floor(Le.ROLL_LENGTH_M/t):Le.STRIPS_PER_ROLL_UNDER_2_5M;if(r<=0)return 0;const l=Math.ceil(s/Le.ROLL_WIDTH_M);return Math.ceil(l/r)},calculateSetPrice:function(e){if(!e||e.is_suspended||v(e.width_m)<=0)return{total:0,opaque:0,sheer:0};const o=this.stylePlus(e.style),s=this.heightPlus(v(e.height_m)),t=v(e.width_m),r=e.fabric_variant?.includes("ทึบ")&&v(e.price_per_m_raw)>0?(v(e.price_per_m_raw)+o+s)*t:0,l=e.fabric_variant?.includes("โปร่ง")&&v(e.sheer_price_per_m)>0?(v(e.sheer_price_per_m)+o+s)*t:0;return{total:Math.round(r+l),opaque:Math.round(r),sheer:Math.round(l)}},calculateAreaBasedPrice:function(e){if(!e||e.is_suspended||v(e.width_m)<=0||v(e.height_m)<=0)return{total:0,sqm:0,sqyd:0};const o=v(e.width_m)*v(e.height_m),s=o*ut,t=s*v(e.price_sqyd);return{total:Math.round(t),sqm:o,sqyd:s}},calculateWallpaperPrice:function(e){if(!e||e.is_suspended)return{total:0,material:0,install:0,rolls:0,sqm:0};const o=e.widths?.reduce((a,c)=>a+v(c),0)||0;if(o<=0)return{total:0,material:0,install:0,rolls:0,sqm:0};const s=v(e.height_m),t=this.wallpaperRolls(o,s),r=t*v(e.price_per_roll),l=v(e.install_cost_per_roll)>0?v(e.install_cost_per_roll):300,n=t*l;return{total:Math.round(r+n),material:Math.round(r),install:Math.round(n),rolls:t,sqm:o*s}}},oe=Object.entries(F).reduce((e,[o,s])=>(e[o]=s.name,e),{});function re(e){const{width:o=0,height:s=0}=e,t=15,r=100-t*2,l=100-t*2,n=o>0&&s>0?Math.min(r/o,l/s):1,a=o*n,c=s*n,d=(100-a)/2,i=(100-c)/2,p=`
        <line x1="${d}" y1="${i+c+5}" x2="${d+a}" y2="${i+c+5}" class="dimension-line" />
        <line x1="${d}" y1="${i+c+3}" x2="${d}" y2="${i+c+7}" class="dimension-tick" />
        <line x1="${d+a}" y1="${i+c+3}" x2="${d+a}" y2="${i+c+7}" class="dimension-tick" />
        <text x="50" y="${i+c+14}" class="dimension-text">${o.toFixed(2)} ม.</text>

        <line x1="${d-5}" y1="${i}" x2="${d-5}" y2="${i+c}" class="dimension-line" />
        <line x1="${d-7}" y1="${i}" x2="${d-3}" y2="${i}" class="dimension-tick" />
        <line x1="${d-7}" y1="${i+c}" x2="${d-3}" y2="${i+c}" class="dimension-tick" />
        <text x="${d-9}" y="50" class="dimension-text" transform="rotate(-90, ${d-9}, 50)">${s.toFixed(2)} ม.</text>
    `;return{x:d,y:i,svgWidth:a,svgHeight:c,lines:p}}function Xe(e,{y:o,svgHeight:s}){if(!e.opening_style||e.opening_style==="สไลด์เดี่ยว")return"";const t=e.opening_style==="แยกกลาง"?"< >":"→";return`
        <rect x="40" y="${o+s/2-8}" width="20" height="16" rx="3" class="opening-text-bg" />
        <text x="50" y="${o+s/2+1}" class="opening-text">${t}</text>
    `}function we(e,{x:o,y:s,svgWidth:t}){if(!e.adjustment_side)return"";const l=e.adjustment_side==="ปรับซ้าย"?o+8:o+t-8;return`
        <g class="adjustment-cord">
            <circle cx="${l}" cy="${s+3}" r="2"/>
            <line x1="${l}" y1="${s+5}" x2="${l}" y2="${s+15}"/>
        </g>
    `}function _t(e){const o=v(e.width_m),s=v(e.height_m);if(o<=0||s<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:t,y:r,svgWidth:l,svgHeight:n,lines:a}=re({width:o,height:s});let c="";const d=e.fabric_variant.includes("โปร่ง"),i=e.fabric_variant.includes("ทึบ"),p=(g,L)=>(e.opening_style||"แยกกลาง")==="แยกกลาง"?`
                <rect x="${t}" y="${r+L}" width="${l/2-1}" height="${n}" class="${g}" />
                <rect x="${t+l/2+1}" y="${r+L}" width="${l/2-1}" height="${n}" class="${g}" />
            `:`<rect x="${t}" y="${r+L}" width="${l}" height="${n}" class="${g}" />`;d&&(c+=p("curtain-panel-sheer",0)),i&&(c+=p("curtain-panel-opaque",d?-2:0));let u="";if(e.style==="ตาไก่"){const g=A.calculateGrommets(e)/(e.opening_style==="แยกกลาง"?2:1),L=Math.min(Math.floor(g),Math.max(8,Math.floor(l/8)));for(let y=0;y<L;y++){const m=t+l/(L>1?L-1:1)*y;u+=`<circle cx="${m}" cy="${r+2}" r="2" class="style-grommet" />`}}else if(e.style==="ลอน"){const g=Math.max(4,Math.floor(l/10));let L=`M ${t},${r}`;for(let y=0;y<g;y++)L+=" q 5,-4 10,0";u=`<path d="${L}" class="style-ripplefold-path" />`}else e.style==="จีบ"&&(u=`<text x="${t+2}" y="${r+5}" class="style-pleat-text">||| ||| ||| ||| |||</text>`);const f=Xe(e,{y:r,svgHeight:n});return`<svg viewBox="0 0 100 100">${c}${u}${f}${a}</svg>`}function bt(e){const o=v(e.width_m),s=v(e.height_m);if(o<=0||s<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:t,y:r,svgWidth:l,svgHeight:n,lines:a}=re({width:o,height:s});let c=`<rect x="${t}" y="${r}" width="${l}" height="${n}" class="blind-frame" />`;const d=5,i=n/d;for(let u=0;u<d;u++)c+=`<rect x="${t+1}" y="${r+u*i}" width="${l-2}" height="${i-1.5}" class="blind-slat" />`;const p=we(e,{x:t,y:r,svgWidth:l});return`<svg viewBox="0 0 100 100">${c}${a}${p}</svg>`}function We(e,o=!1){const s=v(e.width_m),t=v(e.height_m);if(s<=0||t<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:r,y:l,svgWidth:n,svgHeight:a,lines:c}=re({width:s,height:t});let d=`<rect x="${r}" y="${l}" width="${n}" height="${a}" class="blind-frame" />`;if(o){const p=Math.max(4,Math.floor(n/8)),u=n/p;for(let f=0;f<p;f++)d+=`<rect x="${r+f*u+1}" y="${l}" width="${u-2}" height="${a}" class="blind-slat" />`}else{const p=Math.max(3,Math.floor(a/6)),u=a/p;for(let f=0;f<p;f++)d+=`<rect x="${r+1}" y="${l+f*u+.5}" width="${n-2}" height="${u-1}" class="blind-slat" />`}const i=we(e,{x:r,y:l,svgWidth:n});return`<svg viewBox="0 0 100 100">${d}${c}${i}</svg>`}function St(e){const o=v(e.width_m),s=v(e.height_m);if(o<=0||s<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:t,y:r,svgWidth:l,svgHeight:n,lines:a}=re({width:o,height:s});let c=`<rect x="${t}" y="${r}" width="${l}" height="${n}" class="blind-frame" />`;const d=Math.max(3,Math.floor(n/8)),i=n/d;for(let y=0;y<d;y++)c+=`<rect x="${t+1}" y="${r+y*i}" width="${l-2}" height="${i-1.5}" rx="0.5" class="wooden-blind-slat" />`;const p=Math.max(2,l*.05),u=t+l*.25-p/2,f=t+l*.75-p/2,g=`
        <rect x="${u}" y="${r}" width="${p}" height="${n}" class="wooden-blind-strip" />
        <rect x="${f}" y="${r}" width="${p}" height="${n}" class="wooden-blind-strip" />
    `,L=we(e,{x:t,y:r,svgWidth:l});return`<svg viewBox="0 0 100 100">${c}${g}${a}${L}</svg>`}function wt(e){const o=v(e.width_m),s=v(e.height_m);if(o<=0||s<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:t,y:r,svgWidth:l,svgHeight:n,lines:a}=re({width:o,height:s}),c=`
        <rect x="${t}" y="${r}" width="${l}" height="${n}" class="roller-fabric" />
        <rect x="${t-1}" y="${r-4}" width="${l+2}" height="5" rx="2" class="roller-roll" />
        <line x1="${t}" y1="${r+n}" x2="${t+l}" y2="${r+n}" class="roller-bar" />
    `,d=we(e,{x:t,y:r-2,svgWidth:l});return`<svg viewBox="0 0 100 100">${c}${a}${d}</svg>`}function Ve(e,o=!1){const s=v(e.width_m),t=v(e.height_m);if(s<=0||t<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:r,y:l,svgWidth:n,svgHeight:a,lines:c}=re({width:s,height:t});let d="";if(o)d=`
            <defs>
                <pattern id="pleated-mesh" width="6" height="6" patternUnits="userSpaceOnUse">
                    <path d="M -1 1 L 1 -1 M 0 6 L 6 0" class="pleated-screen-mesh" />
                </pattern>
            </defs>
            <rect x="${r}" y="${l}" width="${n}" height="${a}" class="blind-frame" />
            <rect x="${r}" y="${l}" width="${n}" height="${a}" fill="url(#pleated-mesh)" />
        `;else{const p=Math.max(4,Math.floor(n/10)),u=n/p;for(let f=0;f<p;f++)d+=`<rect x="${r+f*u}" y="${l}" width="${u}" height="${a}" class="partition-panel" />`,f>0&&(d+=`<line x1="${r+f*u}" y1="${l}" x2="${r+f*u}" y2="${l+a}" class="partition-hinge" />`)}const i=Xe(e,{y:l,svgHeight:a});return`<svg viewBox="0 0 100 100">${d}${i}${c}</svg>`}function $t(e){const o=(e.widths||[]).reduce((u,f)=>u+v(f),0),s=v(e.height_m);if(o<=0||s<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:t,y:r,svgWidth:l,svgHeight:n,lines:a}=re({width:o,height:s});let c="";const d=Math.floor(l/10),i=Math.floor(n/10);for(let u=0;u<i;u++)for(let f=0;f<d;f++)c+=`<circle cx="${t+f*10+5}" cy="${r+u*10+5}" r="1.5" class="wallpaper-pattern" />`;return`<svg viewBox="0 0 100 100">${`<rect x="${t}" y="${r}" width="${l}" height="${n}" class="blind-frame" /> ${c}`}${a}</svg>`}function qt(e,o,s){let t="";switch(e.type){case"set":e.style==="ม่านพับ"?t=bt(e):t=_t(e);break;case"wooden_blind":t=St(e);break;case"aluminum_blind":t=We(e,!1);break;case"vertical_blind":t=We(e,!0);break;case"roller_blind":t=wt(e);break;case"partition":t=Ve(e,!1);break;case"pleated_screen":t=Ve(e,!0);break;case"wallpaper":t=$t(e);break;default:const r=oe[e.type]||"ของตกแต่ง";t=`<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">${T(r)}</text></svg>`;break}return`<div class="visual-placeholder is-clickable"
                 data-act="jump-to-item"
                 data-room-id="${o}"
                 data-item-index="${s}"
                 title="คลิกเพื่อไปยังรายการนี้">${t}</div>`}function Ue(e){let o=`
📃 *สรุปรายการสินค้า*
`,s=!1;return e.rooms.forEach(t=>{if(t.is_suspended||!t.items)return;const r=t.items.filter(n=>n.is_suspended?!1:n.type==="wallpaper"?(n.widths||[]).reduce((a,c)=>a+v(c),0)>0:n.type==="set"||F[n.type]?.templateId==="#areaBasedTpl"?v(n.width_m)>0:!0);if(r.length===0)return;s=!0,o+=`
*🚪 ห้อง: ${t.room_name||"ไม่ระบุ"}*
`;let l=0;r.forEach(n=>{l++;const a=oe[n.type]||"สินค้าตกแต่ง";n.type==="set"?o+=` ${l}) ${a} ${n.style||""} (${n.fabric_variant||""})
`:o+=` ${l}) ${a}
`})}),s?o+`------------------------------
`:""}function ze(e){return e.rooms.reduce((o,s)=>{if(s.is_suspended)return o;const t=s.items?.reduce((r,l)=>{if(l.is_suspended)return r;switch(l.type){case"set":return r+A.calculateSetPrice(l).total;case"wallpaper":return r+A.calculateWallpaperPrice(l).total;default:return F[l.type]?.templateId==="#areaBasedTpl"?r+A.calculateAreaBasedPrice(l).total:r}},0)||0;return o+t},0)}function xt(e,o){const s=ze(e);let t=0,r="";e.discount&&e.discount.value>0&&(e.discount.type==="percent"?(t=s*(e.discount.value/100),r=`🏷️ ส่วนลด (${e.discount.value}%): -${M(t)} บาท
`):(t=e.discount.value,r=`🏷️ ส่วนลด: -${M(t)} บาท
`));const l=s-t;let n=`🗓️ สรุปข้อมูล (${new Date().toLocaleDateString("th-TH",{day:"numeric",month:"short",year:"2-digit"})})
`;if(n+=`👤 ลูกค้า: ${e.customer_name||"-"}
`,(o==="customer"||o==="owner")&&(n+=`📞 โทร: ${e.customer_phone||"-"}
`,n+=`🏠 ที่อยู่: ${e.customer_address||"-"}
`),n+=`------------------------------
`,o==="customer")return n+=Ue(e),t>0&&(n+=`
ยอดรวม: ${M(s)} บาท
`,n+=r),n+=`
💰 *ยอดสุทธิ: ${M(l)} บาท*
`,n+=`
ขอบคุณที่ใช้บริการค่ะ
${P.name}
โทร: ${P.phone}`,n;if(o==="purchase_order"||o==="owner"){o==="owner"&&(n+=Ue(e));const a={opaqueFabrics:[],sheerFabrics:[],wallpapers:[],allSets:[]};e.rooms.forEach(m=>{m.is_suspended||!m.items||m.items.forEach(h=>{let x=!h.is_suspended;if(h.type==="set"||F[h.type]?.templateId==="#areaBasedTpl")x=x&&v(h.width_m)>0&&v(h.height_m)>0;else if(h.type==="wallpaper"){const _=(h.widths||[]).reduce((b,k)=>b+v(k),0);x=x&&_>0&&v(h.height_m)>0}if(x)switch(h.type){case"set":a.allSets.push(h),h.fabric_variant.includes("ทึบ")&&a.opaqueFabrics.push({code:h.fabric_code||"??",yards:A.fabricYardage(h.style,h.width_m)}),h.fabric_variant.includes("โปร่ง")&&a.sheerFabrics.push({code:h.sheer_fabric_code||"??",yards:A.fabricYardage(h.style,h.width_m)});break;case"wallpaper":const _=(h.widths||[]).reduce((k,S)=>k+v(S),0),b=A.wallpaperRolls(_,h.height_m);b>0&&a.wallpapers.push({code:h.wallpaper_code||"xxx",rolls:b});break;default:if(F[h.type]?.templateId==="#areaBasedTpl"){const k=h.type;a[k]||(a[k]=[]),a[k].push({code:h.code||"xxx",width:v(h.width_m),height:v(h.height_m),opening_style:h.opening_style,adjustment_side:h.adjustment_side})}break}})});const c={};if([...a.opaqueFabrics,...a.sheerFabrics].forEach(m=>{m.yards>0&&(c[m.code]=(c[m.code]||0)+m.yards)}),Object.keys(c).length>0){n+=`✂️ *รายการสั่งซื้อ (ผ้า)*
`,n+=`------------------------------
`,a.opaqueFabrics.filter(m=>m.yards>0).forEach(m=>{n+=`- ผ้าทึบ (Curtain)
`,n+=`  รหัส: #${m.code||"??"}
`,n+=`  จำนวน: ${m.yards.toFixed(2)} หลา

`}),a.sheerFabrics.filter(m=>m.yards>0).forEach(m=>{n+=`- ผ้าโปร่ง (Sheer)
`,n+=`  รหัส: #${m.code||"??"}
`,n+=`  จำนวน: ${m.yards.toFixed(2)} หลา

`}),n+=`------------------------------
`,n+=`📊 *สรุปยอดรวมผ้า (ตามรหัส)*
`,n+=`------------------------------
`;for(const[m,h]of Object.entries(c))n+=`  - รหัส #${m}: ${h.toFixed(2)} หลา
`;n+=`
`}const d=a.allSets.filter(m=>m.style==="ม่านพับ"),i=a.allSets.filter(m=>m.style==="ตาไก่"),p=a.allSets.filter(m=>m.style!=="ตาไก่"&&m.style!=="ม่านพับ");if(d.length>0){n+=`------------------------------
`,n+=`📏 *รายการสั่งซื้อ รางม่านพับ*
`,n+=`------------------------------

`;let m=1;d.forEach(_=>{n+=`(${m++}) รางม่านพับ
`,n+=`  - ขนาด: ${Number(_.width_m).toFixed(2)} ม.
`,n+=`  - สีราง: ${_.track_color||"ขาว"}
`,n+=`  - เชือกปรับ: ${_.adjustment_side||"ปรับขวา"}
`,_.notes&&o==="owner"&&(n+=`  📝 หมายเหตุ: ${_.notes}
`),n+=`
`});const h=d.reduce((_,b)=>{const k=Number(b.width_m).toFixed(2);return _[k]=(_[k]||0)+1,_},{}),x=Object.entries(h).sort((_,b)=>parseFloat(b[0])-parseFloat(_[0]));if(x.length>0){n+=`--- สรุปยอดรวมรางม่านพับ ---
`,n+=`*จำนวนรางที่ต้องตัด:*
`;for(const[_,b]of x)n+=`  - ขนาด ${_} ม. = ${b} เส้น
`;n+=`
`}}if(p.length>0){n+=`------------------------------
`,n+=`📏 *รายการสั่งซื้อ ราง (ลอน/จีบ)*
`,n+=`------------------------------

`;let m=1;p.forEach(b=>{n+=`(${m++}) ราง ${b.style}, สี: ${b.track_color||"ขาว"}
`,b.fabric_variant.includes("ทึบ")&&(n+=`  - รางทึบ: ${Number(b.width_m).toFixed(2)} ม.
`),b.fabric_variant.includes("โปร่ง")&&(n+=`  - รางโปร่ง: ${Number(b.width_m).toFixed(2)} ม.
`),b.notes&&o==="owner"&&(n+=`  📝 หมายเหตุ: ${b.notes}
`),n+=`
`});const h=[];p.forEach(b=>{b.fabric_variant.includes("ทึบ")&&h.push(Number(b.width_m)),b.fabric_variant.includes("โปร่ง")&&h.push(Number(b.width_m))});const x=h.reduce((b,k)=>{const S=k.toFixed(2);return b[S]=(b[S]||0)+1,b},{}),_=Object.entries(x).sort((b,k)=>parseFloat(k[0])-parseFloat(b[0]));if(_.length>0){n+=`--- สรุปยอดรวมรางลอน/จีบ ---
`,n+=`*จำนวนรางที่ต้องตัด:*
`;for(const[b,k]of _)n+=`  - ขนาด ${b} ม. = ${k} เส้น
`;n+=`
`}}if(i.length>0){n+=`------------------------------
`,n+=`📏 *รายการสั่งซื้อ ราง (ตาไก่)*
`,n+=`------------------------------

`;let m=1;i.forEach(S=>{n+=`(${m++}) ราง ${S.style}, สี: ${S.track_color||"ขาว"}
`,S.fabric_variant.includes("ทึบ")&&(n+=`  - รางทึบ: ${Number(S.width_m).toFixed(2)} ม.
`),S.fabric_variant.includes("โปร่ง")&&(n+=`  - รางโปร่ง: ${Number(S.width_m).toFixed(2)} ม.
`),S.notes&&o==="owner"&&(n+=`  📝 หมายเหตุ: ${S.notes}
`),n+=`
`}),n+=`--- สรุปยอดรวมรางตาไก่ ---
`;const h=[];i.forEach(S=>{S.fabric_variant.includes("ทึบ")&&h.push(Number(S.width_m)),S.fabric_variant.includes("โปร่ง")&&h.push(Number(S.width_m))});const x=6;h.sort((S,q)=>q-S);const _=[];for(const S of h){let q=!1;for(let I=0;I<_.length;I++)if(_[I]>=S-.001){_[I]-=S,q=!0;break}q||_.push(x-S)}n+=`ใช้รางเต็ม (6 ม.) ทั้งหมด: *${_.length} เส้น*

`;const b=h.reduce((S,q)=>{const I=q.toFixed(2);return S[I]=(S[I]||0)+1,S},{}),k=Object.entries(b).sort((S,q)=>parseFloat(q[0])-parseFloat(S[0]));if(k.length>0){n+=`*สรุปจำนวนรางที่ต้องตัด:*
`;for(const[S,q]of k)n+=`  - ขนาด ${S} ม. = ${q} เส้น
`;n+=`
`}}const u={};a.allSets.forEach(m=>{const h=m.track_color||"ขาว",x=m.style,_=m.fabric_variant==="ทึบ&โปร่ง",b=v(m.width_m)>=1.6?3:2;if(u[h]||(u[h]={brackets:{},finials:0,grommets:{}}),u[h].brackets[x]||(u[h].brackets[x]={single:0,double:0}),x!=="ม่านพับ"&&(_?u[h].brackets[x].double+=b:u[h].brackets[x].single+=b),x==="ตาไก่"){const k=_?4:2;u[h].finials+=k}if(x==="ตาไก่"){const k=m.grommet_color||"เงิน",S=A.calculateGrommets(m);u[h].grommets[k]||(u[h].grommets[k]=0),u[h].grommets[k]+=S}});const f=a.allSets.filter(m=>m.style!=="ม่านพับ").length*2;if(Object.values(u).some(m=>Object.values(m.brackets).some(h=>h.single>0||h.double>0)||m.finials>0||Object.values(m.grommets).some(h=>h>0))||f>0){n+=`------------------------------
`,n+=`🔩 *รายการสั่งซื้อ อุปกรณ์ (Hardware)*
`,n+=`------------------------------

`;for(const[m,h]of Object.entries(u)){let x=!1,_=`**สี${m}**
`;const b=Object.keys(h.brackets);if(b.length>0){let S="";b.forEach(q=>{q!=="ม่านพับ"&&(h.brackets[q].single>0||h.brackets[q].double>0)&&(S+=`    - ${q} (ชั้นเดียว): ${h.brackets[q].single} ตัว
`,S+=`    - ${q} (2ชั้น): ${h.brackets[q].double} ตัว
`)}),S&&(x=!0,_+=`  - ขาจับ:
${S}`)}h.finials>0&&(x=!0,_+=`  - หัวราง (ตาไก่): ${h.finials} ตัว
`);const k=Object.keys(h.grommets);if(k.length>0){let S="";k.forEach(q=>{const I=h.grommets[q];I>0&&(S+=`    - สี${q}: ${I} ตัว
`)}),S&&(x=!0,_+=`  - ตาไก่:
${S}`)}x&&(n+=_+`
`)}f>0&&(n+=`**อุปกรณ์รวม**
`,n+=`  - ตะขอรวบม่าน: ${f} ตัว

`)}const L=Object.keys(a).filter(m=>!["opaqueFabrics","sheerFabrics","wallpapers","allSets"].includes(m));L.length>0&&L.sort().forEach(m=>{const h=a[m],x=oe[m]||m;n+=`------------------------------
`,n+=`📦 *รายการสั่งซื้อ ${x}*
`,n+=`------------------------------

`,h.forEach(_=>{n+=`- รหัส: #${_.code||"xxx"}
  ขนาด: ${_.width.toFixed(2)} x ${_.height.toFixed(2)} ม.
`,_.opening_style&&(n+=`  รูปแบบเปิด: ${_.opening_style}
`),_.adjustment_side&&(n+=`  เชือกปรับ: ${_.adjustment_side}
`),n+=`
`})});const y={};if(a.wallpapers.forEach(m=>{y[m.code]=(y[m.code]||0)+m.rolls}),Object.keys(y).length>0){n+=`------------------------------
`,n+=`🎨 *รายการสั่งซื้อ (Wallpaper)*
`,n+=`------------------------------

`;for(const[m,h]of Object.entries(y))n+=`  - รหัส #${m}: ${h} ม้วน
`;n+=`
`}if(o==="purchase_order")return n+=`------------------------------
`,n}if(o==="seamstress"||o==="owner"){n+=`
🧵 *รายละเอียดสำหรับช่างเย็บผ้า*
`;let a=0;if(e.rooms.forEach(c=>{if(c.is_suspended||!c.items)return;const d=c.items.filter(i=>i.type==="set"&&!i.is_suspended&&v(i.width_m)>0&&v(i.height_m)>0);d.length!==0&&(a>0&&(n+=`==============================
`),n+=`
*🚪 ห้อง: ${c.room_name||"ไม่ระบุ"}*

`,d.forEach((i,p)=>{p>0&&(n+=`--------------------
`),n+=`*ชุดที่ ${p+1}/${d.length}: ${i.style} ${i.fabric_variant}*
`,i.style==="ม่านพับ"?n+=`  - เชือกปรับ: ${i.adjustment_side||"ปรับขวา"}
`:n+=`  - รูปแบบเปิด: ${i.opening_style||"แยกกลาง"}
`,i.fabric_variant.includes("ทึบ")&&(n+=`  - ผ้าทึบ: #${i.fabric_code||"-"}
`),i.fabric_variant.includes("โปร่ง")&&(n+=`  - ผ้าโปร่ง: #${i.sheer_fabric_code||"-"}
`),n+=`  - ขนาด: กว้าง ${Number(i.width_m).toFixed(2)} x สูง ${Number(i.height_m).toFixed(2)} ม.
`,i.notes&&o==="owner"&&(n+=`  📝 หมายเหตุ: ${i.notes}
`)}),n+=`
`,a++)}),a>0?n+=`==============================
`:n+=`ไม่มีรายการสำหรับช่าง
------------------------------
`,o==="seamstress")return n}return o==="owner"&&(n+=`
💰 *สรุปยอดรวม: ${M(l)} บาท*
`,t>0&&(n+=`   (ยอดก่อนลด: ${M(s)} บาท ${r.trim()})
`)),n}function kt(e){if(!e.rooms||e.rooms.length===0)return'<p class="empty-summary">ไม่มีข้อมูลสำหรับแสดงผล</p>';let o="";const s={};let t=0;if(e.rooms.forEach(n=>{n.is_suspended||!n.items||n.items.forEach(a=>{if(a.is_suspended)return;let c=null,d=0;switch(a.type){case"set":d=A.calculateSetPrice(a).total,d>0&&(c=a.type);break;case"wallpaper":d=A.calculateWallpaperPrice(a).total,d>0&&(c=a.type);break;default:F[a.type]?.templateId==="#areaBasedTpl"&&(d=A.calculateAreaBasedPrice(a).total,d>0&&(c=a.type));break}c&&(s[c]=(s[c]||0)+1,t++)})}),t>0){const n=Object.entries(s).map(([a,c])=>{const d=oe[a]||"ของตกแต่ง";return`
                <span class="summary-tag" data-filter-type="${T(a)}" title="คลิกเพื่อกรองเฉพาะรายการนี้">
                    ${T(d)} <strong>${c}</strong>
                </span>`}).join("");n&&(o+=`
                <div class="overview-summary-group">
                    <h4><i class="ph ph-stack"></i> สรุปประเภทรายการ</h4>
                    <div class="summary-tags-container">
                        ${n}
                    </div>
                </div>`)}let r="",l=0;return e.rooms.forEach(n=>{if(n.is_suspended||!n.items)return;const a={};let c=0;if(n.items.forEach(d=>{if(d.is_suspended)return;let i=null,p=0;switch(d.type){case"set":p=A.calculateSetPrice(d).total,p>0&&(i=d.type);break;case"wallpaper":p=A.calculateWallpaperPrice(d).total,p>0&&(i=d.type);break;default:F[d.type]?.templateId==="#areaBasedTpl"&&(p=A.calculateAreaBasedPrice(d).total,p>0&&(i=d.type));break}i&&(a[i]=(a[i]||0)+1,c++)}),c>0){l+=c;const d=Object.entries(a).map(([i,p])=>`
                    <div class="overview-item">
                        <span>${T(oe[i]||"ของตกแต่ง")}</span>
                        <span>${p}</span>
                    </div>`).join("");r+=`
                <details class="overview-room-card">
                    <summary class="overview-room-summary">
                        <span class="room-name">${T(n.room_name)||"ไม่ระบุชื่อห้อง"}</span>
                        <div class="summary-tags">
                            <span class="room-item-count">${c} รายการ</span>
                            <i class="ph ph-caret-down expand-icon"></i>
                        </div>
                    </summary>
                    <div class="overview-room-items">${d}</div>
                </details>`}}),r&&(o+=`
            <div class="overview-breakdown-group">
                <h4><i class="ph ph-map-pin-line"></i> แจกแจงตามห้อง</h4>
                ${r}
            </div>`),t===0&&l===0?'<p class="empty-summary">ไม่มีรายการที่มีราคาสำหรับแสดงผล</p>':o}function Lt(e,o){const{vatRate:s=P.baseVatRate,pageBreakBuffer:t=3}=o,r=[];e.rooms.forEach(q=>{if(q.is_suspended||!q.items)return;const I=[];q.items.forEach(E=>{if(E.is_suspended)return;let B="",C=0,N=0,R=0,ee=1;const ne=oe[E.type]||"สินค้าตกแต่ง";switch(E.type){case"set":C=A.calculateSetPrice(E).total,C>0&&(N=v(E.width_m),R=v(E.height_m),B=`${ne} ${T(E.style||"")} (${T(E.fabric_variant||"")}) <br><small>ขนาด ${N.toFixed(2)} x ${R.toFixed(2)} ม.${E.notes?` - ${T(E.notes)}`:""}</small>`,ee=1.5);break;case"wallpaper":if(C=A.calculateWallpaperPrice(E).total,C>0){const ke=(E.widths||[]).reduce((at,lt)=>at+v(lt),0),J=A.wallpaperRolls(ke,E.height_m);R=v(E.height_m),B=`${ne} <br><small>รหัส: ${T(E.wallpaper_code)||"-"}, สูง ${R.toFixed(2)} ม. (ใช้ ${J} ม้วน)</small>`,ee=1.5}break;default:F[E.type]?.templateId==="#areaBasedTpl"&&(C=A.calculateAreaBasedPrice(E).total,C>0&&(N=v(E.width_m),R=v(E.height_m),B=`${ne} <br><small>รหัส: ${T(E.code)||"-"}, ขนาด ${N.toFixed(2)} x ${R.toFixed(2)} ม.</small>`,ee=1.5));break}C>0&&B&&I.push({description:B,total:C,units:ee})}),I.length>0&&(r.push({isRoomHeader:!0,roomName:T(q.room_name)||"ไม่ระบุชื่อห้อง",units:1.2}),r.push(...I))});const l=r.reduce((q,I)=>q+(I.total||0),0);if(l===0)return null;let n=0,a="",c=l;e.discount&&e.discount.value>0&&(e.discount.type==="percent"?(n=l*(e.discount.value/100),a=`<tr><td class="pdf-label">ส่วนลด (${e.discount.value}%)</td><td class="pdf-amount">-${U(n,2,!0)}</td></tr>`):(n=e.discount.value,a=`<tr><td class="pdf-label">ส่วนลด</td><td class="pdf-amount">-${U(n,2,!0)}</td></tr>`),c=l-n);const d=c*s,i=c+d,p=17,u=23,f=[];let g=[],L=0;r.forEach((q,I)=>{const E=f.length===0?p:u,B=L+q.units>E;let C=!1;if(!B&&I<r.length-1){const N=E-(L+q.units),R=r[I+1].units||1;N>0&&N<t&&N<R&&(q.isRoomHeader&&N<1.5||(C=!0))}(B||C)&&g.length>0&&(f.push(g),g=[],L=0),g.push(q),L+=q.units}),g.length>0&&f.push(g);const y=new Date,m=y.toLocaleDateString("th-TH",{year:"numeric",month:"long",day:"numeric"}),h=`QT-${y.getFullYear()}${(y.getMonth()+1).toString().padStart(2,"0")}${y.getDate().toString().padStart(2,"0")}`;let x="",_=0,b=1;f.forEach((q,I)=>{const E=I===0,B=I===f.length-1,C=`
            <div class="pdf-page-header">
                <div class="pdf-header">
                    <div class="pdf-shop-info">
                        ${`<img src="${P.logoUrl}" alt="Logo" class="pdf-logo">`}
                        <div class="pdf-shop-address">
                            <strong><i class="ph ph-github-logo"></i> ${T(P.name)}</strong><br>
                            ${T(P.address).replace(/\n/g,"<br>")}<br>
                            โทร: ${T(P.phone)} | เลขประจำตัวผู้เสียภาษี: ${T(P.taxId)}
                        </div>
                    </div>
                    <div class="pdf-quote-details">
                        <div class="pdf-title-box"><h1>ใบเสนอราคา ${f.length>1?E?"":"(ต่อ)":""}</h1></div>
                        <table class="pdf-quote-meta">
                            <tr><td>เลขที่:</td><td>${h}</td></tr>
                            <tr><td>วันที่:</td><td>${m}</td></tr>
                        </table>
                    </div>
                </div>
                ${E?`
                <section class="pdf-customer-details">
                    <div class="pdf-customer-info">
                        <strong>ลูกค้า:</strong> ${T(e.customer_name)||"-"}<br>
                        <strong>ที่อยู่:</strong> ${T(e.customer_address||"-").replace(/\n/g,"<br>")}<br>
                        <strong>โทร:</strong> ${T(e.customer_phone)||"-"}
                    </div>
                    <div class="pdf-customer-meta">
                        <strong>เงื่อนไขชำระเงิน:</strong> ${T(P.pdf.paymentTerms)}<br>
                        <strong>ยืนราคา:</strong> ${T(P.pdf.priceValidity)}
                    </div>
                </section>`:""}
            </div>`,N=`
            <div class="pdf-page-footer">
                <div class="pdf-footer-info">
                    <span><i class="ph ph-github-logo"></i> ${T(P.name)} | โทร: ${T(P.phone)}</span>
                    <span>หน้า ${I+1} / ${f.length}</span>
                </div>
            </div>`;let R="";E||(R+=`<tr class="pdf-subtotal-row"><td colspan="4">ยอดยกมา (Brought Forward)</td><td class="pdf-text-right">${U(_,2,!0)}</td></tr>`),q.forEach(J=>{J.isRoomHeader?R+=`<tr class="pdf-room-header"><td colspan="5">ห้อง: ${J.roomName}</td></tr>`:(R+=`<tr><td class="pdf-text-center">${b++}</td><td>${J.description}</td><td class="pdf-text-center">1</td><td class="pdf-text-right">${U(J.total,2,!0)}</td><td class="pdf-text-right">${U(J.total,2,!0)}</td></tr>`,_+=J.total)});let ee="";B||(ee=`<tfoot><tr class="pdf-subtotal-row"><td colspan="4">ยอดยกไป (Carried Forward)</td><td class="pdf-text-right">${U(_,2,!0)}</td></tr></tfoot>`);let ne="";P.pdf.notes&&P.pdf.notes.length>0&&(ne=`
                <strong>หมายเหตุ:</strong>
                <ul>${P.pdf.notes.map(J=>`<li>${T(J)}</li>`).join("")}</ul>
            `);const ke=B?`
            <div class="pdf-summary-wrapper">
                <section class="pdf-summary-section">
                    <div class="pdf-amount-in-words">
                        ${ne}
                        <div class="pdf-amount-text">( ${pt(i)} )</div>
                    </div>
                    <div class="pdf-totals-block">
                        <table>
                            <tr><td class="pdf-label">รวมเป็นเงิน</td><td class="pdf-amount">${U(l,2,!0)}</td></tr>
                            ${a}
                            ${s>0?`<tr><td class="pdf-label">ภาษีมูลค่าเพิ่ม ${(s*100).toFixed(0)}%</td><td class="pdf-amount">${U(d,2,!0)}</td></tr>`:""}
                            <tr class="pdf-grand-total"><td class="pdf-label">ยอดรวมสุทธิ</td><td class="pdf-amount">${U(i,2,!0)}</td></tr>
                        </table>
                    </div>
                </section>
                <footer class="pdf-footer-section">
                    <div class="pdf-signature-box"><p>.................................................</p><p>ผู้เสนอราคา</p><p>(<i class="ph ph-github-logo"></i> ${T(P.name)})</p><p>วันที่: ${m}</p></div>
                    <div class="pdf-signature-box"><p>.................................................</p><p>ลูกค้า / ผู้มีอำนาจลงนาม</p><p>&nbsp;</p><p>วันที่: ......./......./............</p></div>
                </footer>
            </div>
        `:"";x+=`
            <div class="pdf-page">
                <div class="pdf-page-content">
                    ${C}
                    <div class="pdf-page-body">
                        <table class="pdf-items-table">
                            <thead><tr><th style="width:5%;">ลำดับ</th><th style="width:50%;">รายการ</th><th style="width:10%;">จำนวน</th><th style="width:17.5%;">ราคา/หน่วย</th><th style="width:17.5%;">รวม (บาท)</th></tr></thead>
                            <tbody>${R}</tbody>
                            ${ee}
                        </table>
                        ${ke}
                    </div>
                    ${N}
                </div>
            </div>`});const k=e.customer_name||"quote",S=Je(k);return{html:`<div id="quotation-template">${x}</div>`,fileName:`${h}_${S}`}}function Tt(e){const o=ze(e);let s=0;e.discount?.value>0&&(s=e.discount.type==="percent"?o*(e.discount.value/100):e.discount.value);const t=o-s;let r=!1,l=e.rooms.map(a=>{if(a.is_suspended)return"";const c=a.items.filter(i=>i.is_suspended?!1:i.type==="set"||F[i.type]?.templateId==="#areaBasedTpl"?v(i.width_m)>0&&v(i.height_m)>0:i.type==="wallpaper"?(i.widths||[]).reduce((u,f)=>u+v(f),0)>0&&v(i.height_m)>0:!1);if(c.length===0)return"";const d=c.map((i,p)=>{let u="",f="",g="";if(i.type!=="set"){const L=oe[i.type]||"ของตกแต่ง";f=`<h5 class="lookbook-item-title">${T(L)}</h5>`}switch(i.type){case"set":g=`<tr><td>ขนาด</td><td>${v(i.width_m).toFixed(2)} x ${v(i.height_m).toFixed(2)} ม.</td></tr>`,u=`
                        <tr><td>แบบ</td><td>${T(i.style||"")} (${T(i.fabric_variant||"")})</td></tr>
                        ${i.fabric_variant.includes("ทึบ")?`<tr><td>ทึบ</td><td>#${T(i.fabric_code)||"-"}</td></tr>`:""}
                        ${i.fabric_variant.includes("โปร่ง")?`<tr><td>โปร่ง</td><td>#${T(i.sheer_fabric_code)||"-"}</td></tr>`:""}
                    `,i.style==="ม่านพับ"?u+=`<tr><td>เชือก</td><td>${T(i.adjustment_side||"ปรับขวา")}</td></tr>`:u+=`<tr><td>เปิด</td><td>${T(i.opening_style||"แยกกลาง")}</td></tr>`;break;case"wallpaper":const L=(i.widths||[]).reduce((m,h)=>m+v(h),0),y=A.wallpaperRolls(L,i.height_m);g=`<tr><td>ขนาด</td><td>รวม ${L.toFixed(2)} ม., สูง ${v(i.height_m).toFixed(2)} ม.</td></tr>`,u=`
                        <tr><td>รหัส</td><td>#${T(i.wallpaper_code)||"-"}</td></tr>
                        <tr><td>ใช้</td><td>${y} ม้วน</td></tr>
                    `;break;default:F[i.type]?.templateId==="#areaBasedTpl"&&(g=`<tr><td>ขนาด</td><td>${v(i.width_m).toFixed(2)} x ${v(i.height_m).toFixed(2)} ม.</td></tr>`,u=`<tr><td>รหัส</td><td>#${T(i.code)||"-"}</td></tr>`,i.opening_style&&(u+=`<tr><td>เปิด</td><td>${T(i.opening_style)}</td></tr>`),i.adjustment_side&&(u+=`<tr><td>เชือก</td><td>${T(i.adjustment_side)}</td></tr>`));break}return u&&(r=!0),`
                 <div class="lookbook-details">
                    ${qt(i,a.id,p)}
                    <div class="spec-table-wrapper">
                        ${f}
                        <table class="spec-table">
                            ${u}
                            ${g}
                            ${i.notes?`<tr><td>โน้ต</td><td>${T(i.notes)}</td></tr>`:""}
                        </table>
                    </div>
                </div>
            `}).join('<hr class="lookbook-hr">');return d.trim()?`
            <div class="lookbook-room">
                <h4><i class="ph ph-map-pin"></i> ${T(a.room_name)||"ไม่ระบุชื่อห้อง"}</h4>
                ${d}
            </div>
        `:""}).join("");return r?`
        <div class="lookbook-summary">
            <div class="lookbook-customer-info">
                <strong>ลูกค้า:</strong> ${T(e.customer_name)||"-"}<br/>
                <strong>ที่อยู่:</strong> ${T(e.customer_address||"-").replace(/\n/g,"<br/>")}
            </div>
            <div class="lookbook-totals">
                <span>ยอดรวม (ก่อนส่วนลด): ${M(o)} บาท</span>
                ${s>0?`<span>ส่วนลด: -${M(s)} บาท</span>`:""}
                <span class="grand-total">ยอดสุทธิ: ${M(t)} บาท</span>
            </div>
        </div>
    `+l:'<p class="empty-summary">ไม่มีรายการสำหรับสร้างรายงาน</p>'}function Ze(e={}){const o=document.querySelector(w.roomTpl);if(!o)return console.error("Room template not found"),null;const t=o.content.cloneNode(!0).firstElementChild;t.id=e.id||`room-${Date.now()}`,t.open=e.is_open!==!1;const r=t.querySelector(w.roomNameInput),l=t.querySelector("[data-room-name-display]"),n=t.querySelector("[data-room-brief]"),a=t.querySelector(w.allItemsContainer),c=()=>{const p=r.value||"ห้อง (ไม่มีชื่อ)";l&&(l.textContent=p)};r&&r.addEventListener("input",c);const d=t.querySelector("summary");d&&d.addEventListener("click",()=>{});const i=e.room_name||`ห้อง ${document.querySelectorAll(w.room).length+1}`;if(r){r.value=i;const p=`room_name_${t.id}`;r.id=p;const u=r.closest(".form-group")?.querySelector("label");u&&u.setAttribute("for",p)}return l&&(l.textContent=i),e.is_suspended&&t.classList.add("is-suspended"),t.getItemsContainer=()=>a,t.updateBrief=p=>{n&&(n.innerHTML=p)},t}function Pe(e={}){const o=document.querySelector(w.setTpl);if(!o)return console.error("Set template not found"),null;const t=o.content.cloneNode(!0).firstElementChild;t.dataset.type="set";const r=t.querySelector('input[name="width_m"]'),l=t.querySelector('input[name="height_m"]'),n=t.querySelector('select[name="set_style"]'),a=t.querySelector('select[name="fabric_variant"]'),c=t.querySelector('select[name="set_price_per_m"]'),d=t.querySelector('select[name="sheer_price_per_m"]'),i=t.querySelector('input[name="fabric_code"]'),p=t.querySelector('input[name="sheer_fabric_code"]'),u=t.querySelector('select[name="opening_style"]'),f=t.querySelector('select[name="adjustment_side"]'),g=t.querySelector('input[name="notes"]'),L=t.querySelector('[data-set-control="opening_style_wrap"]'),y=t.querySelector('[data-set-control="adjustment_side_wrap"]'),m=t.querySelector("[data-sheer-wrap]"),h=t.querySelector("[data-sheer-code-wrap]"),x=t.querySelector("[data-set-summary]"),_=t.querySelector(".item-details-more"),b=t.querySelector('[data-act="toggle-more-details"]')?.parentElement,k=()=>({width_m:r.value,height_m:l.value,style:n.value,fabric_variant:a.value,price_per_m_raw:c.value,sheer_price_per_m:d.value,is_suspended:t.classList.contains("is-suspended")}),S=()=>{const B=k(),C=A.calculateSetPrice(B);t.dataset.totalPrice=C.total;let N=`ราคา: <b>${M(C.total)}</b> บ.`;if(C.opaque>0&&C.sheer>0&&(N+=` <small>(ทึบ: ${M(C.opaque)}, โปร่ง: ${M(C.sheer)})</small>`),B.style==="ม่านพับ"){const R=A.fabricYardage(B.style,B.width_m);R>0&&(N+=` &bull; ใช้ผ้า: ${R.toFixed(2)} หลา`)}x&&(x.innerHTML=N)},q=pe(()=>{S(),t.dispatchEvent(new CustomEvent("item-update",{bubbles:!0}))},200),I=()=>{const B=a.value,C=B.includes("โปร่ง"),N=B==="โปร่ง",R=B==="ทึบ";m?.classList.toggle("hidden",!C),h?.classList.toggle("hidden",!C),c.disabled=N,i.disabled=N,N&&(c.value="",i.value=""),d.disabled=R,p.disabled=R,R&&(d.value="",p.value="")},E=()=>{const C=n.value==="ม่านพับ";L&&L.classList.toggle("hidden",C),y&&y.classList.toggle("hidden",!C)};if(t.addEventListener("input",B=>{B.target===a&&I(),B.target===n&&E(),q()}),_&&b){const B=t.querySelector(".item-grid");B&&B.appendChild(b)}return r.value=te(e.width_m),l.value=te(e.height_m),n.value=e.style||"ลอน",a.value=e.fabric_variant||"ทึบ",c.value=e.price_per_m_raw||"",d.value=e.sheer_price_per_m||"",i.value=e.fabric_code||"",p.value=e.sheer_fabric_code||"",u.value=e.opening_style||"แยกกลาง",f.value=e.adjustment_side||"ปรับขวา",g.value=e.notes||"",t.querySelector('input[name="track_color"]').value=e.track_color||"ขาว",t.querySelector('input[name="bracket_color"]').value=e.bracket_color||"ขาว",t.querySelector('input[name="finial_color"]').value=e.finial_color||"ขาว",t.querySelector('input[name="grommet_color"]').value=e.grommet_color||"เงิน",e.is_suspended&&t.classList.add("is-suspended"),I(),E(),S(),t}function Re(e={}){const o=document.querySelector(w.wallTpl);if(!o)return null;const t=o.content.cloneNode(!0).firstElementChild,r=t.querySelector('input[name="wall_width_m"]');r.value=te(e.width);const l=`wall_width_${Date.now()}_${Math.random().toString(36).substring(2,7)}`;r.id=l;const n=t.querySelector("label");return n&&n.setAttribute("for",l),t}function Oe(e={}){const o=document.querySelector(w.wallpaperTpl);if(!o)return console.error("Wallpaper template not found"),null;const t=o.content.cloneNode(!0).firstElementChild;t.dataset.type="wallpaper";const r=t.querySelector('[name="wallpaper_height_m"]'),l=t.querySelector('[name="wallpaper_price_roll"]'),n=t.querySelector('[name="wallpaper_install_cost"]'),a=t.querySelector('[name="wallpaper_code"]'),c=t.querySelector('[name="wallpaper_notes"]'),d=t.querySelector("[data-walls-container]"),i=t.querySelector("[data-wallpaper-summary]"),p=t.querySelector(".item-details-more"),u=t.querySelector('[data-act="toggle-more-details"]')?.parentElement,f=()=>({height_m:r.value,price_per_roll:l.value,install_cost_per_roll:n.value,widths:Array.from(d.querySelectorAll('input[name="wall_width_m"]')).map(y=>y.value),is_suspended:t.classList.contains("is-suspended")}),g=()=>{const y=f(),m=A.calculateWallpaperPrice(y);t.dataset.totalPrice=m.total;let h=`รวม: <b>${M(m.total)}</b> บ. `;(m.material>0||m.install>0)&&(h+=`<small>(วอลล์: ${M(m.material)}, ค่าช่าง: ${M(m.install)})</small>`),m.rolls>0&&(h+=` &bull; พื้นที่: ${U(m.sqm,2)} ตร.ม. &bull; ใช้: ${m.rolls} ม้วน`),i&&(i.innerHTML=h)},L=pe(()=>{g(),t.dispatchEvent(new CustomEvent("item-update",{bubbles:!0}))},200);if(t.addEventListener("input",L),p&&u){const y=t.querySelector(".item-grid");y&&y.appendChild(u)}if(e.widths&&e.widths.length>0)e.widths.forEach(y=>{const m=Re({width:y});m&&d.appendChild(m)});else{const y=Re();y&&d.appendChild(y)}return r.value=te(e.height_m),l.value=e.price_per_roll>0?M(e.price_per_roll):"",n.value=e.hasOwnProperty("install_cost_per_roll")&&v(e.install_cost_per_roll)>0?M(e.install_cost_per_roll):"300",a.value=e.wallpaper_code||"",c.value=e.notes||"",e.is_suspended&&t.classList.add("is-suspended"),g(),t}function He(e,o={}){const s=document.querySelector(w.areaBasedTpl);if(!s)return console.error("AreaBased template not found"),null;const r=s.content.cloneNode(!0).firstElementChild;r.dataset.type=e;const l=F[e]||{name:"ของตกแต่ง"};r.classList.add(`${e.replace(/_/g,"-")}-item`);const n=r.querySelector(".item-type-display"),a=r.querySelector('[name="area_width_m"]'),c=r.querySelector('[name="area_height_m"]'),d=r.querySelector('[name="area_price_sqyd"]'),i=r.querySelector('[name="area_code"]'),p=r.querySelector('[name="area_notes"]'),u=r.querySelector(".btn-favorite"),f=r.querySelector(".btn-show-favs"),g=r.querySelector("[data-area-summary]"),L=r.querySelector(".item-details-more"),y=r.querySelector('[data-act="toggle-more-details"]')?.parentElement,m=L?.querySelector(".item-grid"),h=m?.querySelector('[name="area_price_sqyd"]')?.closest(".form-group");let x,_;if(m&&h){if(e==="partition"||e==="pleated_screen"){const q=document.createElement("div");q.className="form-group",q.innerHTML=`
                <label>รูปแบบเปิด
                    <select name="opening_style">
                        <option value="แยกกลาง">แยกกลาง</option>
                        <option value="เก็บข้างเดียว">เก็บข้างเดียว</option>
                    </select>
                </label>
            `,m.insertBefore(q,h),x=q.querySelector("select")}else if(["wooden_blind","roller_blind","vertical_blind","aluminum_blind"].includes(e)){const q=document.createElement("div");q.className="form-group",q.innerHTML=`
                <label>เชือกปรับ
                    <select name="adjustment_side">
                        <option value="ปรับขวา">ปรับขวา</option>
                        <option value="ปรับซ้าย">ปรับซ้าย</option>
                    </select>
                </label>
            `,m.insertBefore(q,h),_=q.querySelector("select")}if(x||_){const q=m.querySelector('[name="area_code"]')?.closest(".form-group-with-favorites");h&&h.classList.remove("full-width-item"),q&&q.classList.remove("full-width-item")}}const b=()=>({width_m:a.value,height_m:c.value,price_sqyd:d.value,is_suspended:r.classList.contains("is-suspended")}),k=()=>{const q=b(),I=A.calculateAreaBasedPrice(q);r.dataset.totalPrice=I.total;const E=I.sqyd>0?` &bull; พื้นที่: ${U(I.sqyd,2)} ตร.หลา`:"";g&&(g.innerHTML=`ราคา: <b>${M(I.total)}</b> บ.${E}`)},S=pe(()=>{k(),r.dispatchEvent(new CustomEvent("item-update",{bubbles:!0}))},200);if(r.addEventListener("input",S),L&&y){const q=r.querySelector(".item-grid");q&&q.appendChild(y)}return n&&(n.textContent=l.name),i&&(i.dataset.favoriteType=e),u&&(u.dataset.type=e),f&&(f.dataset.type=e),a.value=te(o.width_m),c.value=te(o.height_m),d.value=o.price_sqyd>0?M(o.price_sqyd):"",i.value=o.code||"",p.value=o.notes||"",x&&(x.value=o.opening_style||"แยกกลาง"),_&&(_.value=o.adjustment_side||"ปรับขวา"),o.is_suspended&&r.classList.add("is-suspended"),k(),r}let G=!1,he=null,H=null,ce=null,me=!1,O=null,Te=!1,z=null,Ge;const Ye=document.querySelector("#undoBtn"),Ne="marnthara.theme",ve={};function Et(e){if(ve[e])return ve[e];const o=new Promise((s,t)=>{const r=document.createElement("script");r.src=e,r.onload=()=>s(),r.onerror=()=>{console.error(`Script load error for ${e}`),delete ve[e],t(new Error(`Script load error for ${e}`))},document.head.appendChild(r)});return ve[e]=o,o}function et(){const e=localStorage.getItem(Ne),o=document.querySelector("#themeToggleBtn");if(!o)return;const s=o.querySelector("i"),t=o.querySelector("span");switch(document.body.classList.remove("dark-theme","neutral-theme"),e){case"dark":document.body.classList.add("dark-theme"),s&&(s.className="ph-fill ph-sun"),t&&(t.textContent=" สว่าง");break;case"neutral":document.body.classList.add("neutral-theme"),s&&(s.className="ph-fill ph-moon"),t&&(t.textContent=" มืด");break;default:s&&(s.className="ph-fill ph-palette"),t&&(t.textContent=" กลาง");break}}function It(){const e=localStorage.getItem(Ne);let o="neutral";!e||e==="light"?o="neutral":e==="neutral"?o="dark":o="light",localStorage.setItem(Ne,o),et()}function Q(){Ye&&(Ye.disabled=!gt())}function Mt(){const e=yt();e&&(De(e,!1),$("ยกเลิกการกระทำล่าสุดแล้ว","success")),Q()}function $e(){clearTimeout(Ge),document.documentElement.classList.add("scrolling-programmatically"),Ge=setTimeout(()=>{document.documentElement.classList.remove("scrolling-programmatically")},1e3)}function ie(){const e=document.getElementById("suspendedItemsBtn");if(!e)return;if(ce){e.classList.remove("is-visible");return}const o=document.getElementById("suspendedCountBadge"),s=document.querySelectorAll(".item-card.is-suspended").length,t=document.querySelectorAll(".room-card.is-suspended");let r=0;t.forEach(n=>{r+=n.querySelectorAll(".item-card:not(.is-suspended)").length});const l=s+r;o&&(o.textContent=l),e.classList.toggle("is-visible",l>0)}function Ee(){ce="suspended";const e=document.getElementById("filterStatusBar");let o=0;if(document.querySelectorAll(".room-card").forEach(s=>{let t=!1;const r=s.classList.contains("is-suspended");s.querySelectorAll(".item-card").forEach(n=>{const c=n.classList.contains("is-suspended")||r;n.classList.toggle("item-hidden",!c),c&&(t=!0,o++)});const l=r||t;s.classList.toggle("item-hidden",!l)}),o===0){tt(),$("ไม่มีรายการที่ถูกระงับแล้ว","success");return}e&&(e.innerHTML=`
            <span><i class="ph ph-warning"></i> รายการที่ถูกระงับ (${o} รายการ)</span>
            <button type="button" class="btn-chip" data-act="clear-filter" title="ยกเลิกการกรอง">
                <i class="ph ph-x"></i>&nbsp;ปิด
            </button>
        `,e.classList.add("is-visible"),e.dataset.filterType="suspended"),X(),Y(),ie()}function Bt(e,o){if(!e)return;ce=e;const s=document.getElementById("filterStatusBar");let t=0;document.querySelectorAll(w.room).forEach(r=>{let l=0;r.querySelectorAll(".item-card").forEach(n=>{const a=n.dataset.type===e;n.classList.toggle("item-hidden",!a),a&&l++}),r.classList.toggle("item-hidden",l===0),l>0&&(t+=l)}),s&&(s.innerHTML=`
            <span>เฉพาะ: <strong>${T(o)}</strong> (${t} รายการ)</span>
            <button type="button" class="btn-chip" data-act="clear-filter" title="ยกเลิกการกรอง">
                <i class="ph ph-x"></i>&nbsp;ปิด
            </button>
        `,s.classList.add("is-visible"),s.dataset.filterType=e),X(),Y(),ie()}function tt(){ce=null;const e=document.getElementById("filterStatusBar");e&&(e.classList.remove("is-visible"),e.innerHTML="",e.removeAttribute("data-filter-type")),document.querySelectorAll(".item-hidden").forEach(o=>o.classList.remove("item-hidden")),X(),Y(),ie()}function $(e,o="default"){const s=document.querySelector(w.toastContainer);if(!s)return;const t={success:"ph-bold ph-check-circle",warning:"ph-bold ph-warning",error:"ph-bold ph-x-circle",default:"ph-bold ph-info"},r=document.createElement("div");r.className=`toast toast-${o}`,r.innerHTML=`<i class="${t[o]||t.default}"></i> ${T(e)}`,s.appendChild(r),setTimeout(()=>r.classList.add("show"),10),setTimeout(()=>{r.classList.remove("show"),r.addEventListener("transitionend",()=>r.remove())},3e3)}function W(e,o){return new Promise(s=>{const t=document.querySelector(e);if(!t){s(null);return}const r=document.querySelector(".modal-wrapper.visible:not(.is-underlay)");r&&r!==t&&r.classList.add("is-underlay"),t.classList.add("visible");const l=t.querySelector('[id$="Confirm"]'),n=t.querySelector('[id$="Cancel"], [data-act="close-modal"]'),a=Array.from(t.querySelectorAll('button, [href], input:not([type="hidden"]), select, textarea, [tabindex]:not([tabindex="-1"])')).filter(f=>!f.disabled&&f.offsetParent!==null),c=a[0],d=a[a.length-1];setTimeout(()=>c?.focus(),50);const i=f=>{t.classList.remove("visible"),document.removeEventListener("keydown",p),t.removeEventListener("click",u),l&&(l.onclick=null),n&&(n.onclick=null);const g=document.querySelector(".modal-wrapper.visible:not(.is-underlay)");g?g.classList.remove("is-underlay"):r&&r!==t&&r.classList.remove("is-underlay"),f?.cancelled&&typeof o=="function"&&o(),s(f)},p=f=>{f.key==="Escape"&&!t.classList.contains("is-underlay")&&i({cancelled:!0}),f.key==="Tab"&&a.length>1&&(f.shiftKey?document.activeElement===c&&(d.focus(),f.preventDefault()):document.activeElement===d&&(c.focus(),f.preventDefault()))},u=f=>{f.target===t&&!t.classList.contains("is-underlay")&&(f.stopPropagation(),i({cancelled:!0}))};l&&(l.onclick=()=>i(!0)),n&&(n.onclick=()=>{t.classList.contains("is-underlay")||i({cancelled:!0})}),document.addEventListener("keydown",p),t.addEventListener("click",u)})}async function K(e,o){const s=document.querySelector(w.modal);return s?(s.querySelector(w.modalTitle).textContent=e,s.querySelector(w.modalBody).textContent=o,await W(w.modal)===!0):!0}async function Ct(){const e=document.querySelector(w.exportOptionsModal);if(!e)return null;const o=e.querySelector("#pageBreakBuffer"),s=e.querySelector("#pageBreakBufferValue");o&&s&&(s.textContent=o.value,o.oninput=()=>{s.textContent=o.value});const t=await W(w.exportOptionsModal);return o&&(o.oninput=null),!t||t.cancelled?null:{vatOption:e.querySelector('input[name="vat_option"]:checked')?.value||"include",exportMethod:e.querySelector("#exportMethod")?.value||"direct",pageBreakBuffer:parseInt(o?.value,10)||3}}async function At(){const e=document.querySelector("#discountModal");if(!e)return;const o=e.querySelector("#discountSubtotal"),s=e.querySelector("#discountPercent"),t=e.querySelector("#discountAmount"),r=e.querySelector("#discountFinalTotal"),l=document.querySelector("#discount_type"),n=document.querySelector("#discount_value"),a=v(document.querySelector("#originalTotal").dataset.rawTotal||document.querySelector("#grandTotal").textContent);o&&(o.textContent=M(a));const c=y=>{if(Te)return;Te=!0;let m=0;if(y==="percent"){const h=v(s.value);m=a*(Math.max(0,h)/100),t.value=m>0?M(Math.round(m)):""}else m=v(t.value);if(m=Math.max(0,Math.min(m,a)),y!=="percent"){const h=a>0?m/a*100:0;s.value=h>0&&isFinite(h)?U(h,2):""}r&&(r.textContent=M(a-m)),setTimeout(()=>{Te=!1},50)},d=()=>c("percent"),i=()=>c("amount"),p=y=>{v(y.target.value)>0&&(y.target.value=v(y.target.value))},u=y=>{const m=v(y.target.value);y.target.value=m>0?M(m):"",c("amount")};s.addEventListener("input",d),t.addEventListener("input",i),t.addEventListener("focus",p),t.addEventListener("blur",u);const f=l.value,g=v(n.value);s.value="",t.value="",g>0?f==="percent"?(s.value=g,c("percent")):(t.value=g,t.value=M(g),c("amount")):c();const L=await W("#discountModal");if(s.removeEventListener("input",d),t.removeEventListener("input",i),t.removeEventListener("focus",p),t.removeEventListener("blur",u),L&&!L.cancelled){const y=v(s.value),m=v(t.value),h=document.activeElement;y>0&&h===s?(l.value="percent",n.value=y):m>0?(l.value="amount",n.value=m):y>0?(l.value="percent",n.value=y):(l.value="amount",n.value=0),D()}}async function Rt(){if(!H)return;const e=document.querySelector("#hardwareModal");if(!e)return;const o=H.querySelector('[name="set_style"]'),s=o?o.value:null,t=s==="ตาไก่",r=s==="ม่านพับ";e.querySelector('[name="modal_track_color"]').value=H.querySelector('[name="track_color"]')?.value||"ขาว",e.querySelector('[name="modal_bracket_color"]').value=H.querySelector('[name="bracket_color"]')?.value||"ขาว",e.querySelector('[name="modal_finial_color"]').value=H.querySelector('[name="finial_color"]')?.value||"ขาว",e.querySelector('[name="modal_grommet_color"]').value=H.querySelector('[name="grommet_color"]')?.value||"เงิน";const l=e.querySelector("#finialColorGroup"),n=e.querySelector("#grommetColorGroup"),a=e.querySelector("#hardwareApplyToRoom");l&&(l.style.display=t?"":"none"),n&&(n.style.display=t?"":"none"),a&&(a.disabled=r);const c=await W("#hardwareModal");c&&!c.cancelled&&(H.querySelector('[name="track_color"]').value=e.querySelector('[name="modal_track_color"]').value,H.querySelector('[name="bracket_color"]').value=e.querySelector('[name="modal_bracket_color"]').value,t&&(H.querySelector('[name="finial_color"]').value=e.querySelector('[name="modal_finial_color"]').value,H.querySelector('[name="grommet_color"]').value=e.querySelector('[name="modal_grommet_color"]').value),j(),$("บันทึกการตั้งค่าอุปกรณ์แล้ว","success")),H=null}function Ie(e,o){e&&(le(V()),Q(),e.classList.add("item-removing"),e.addEventListener("animationend",()=>{e.remove(),$(o),xe(),X(),D(),fe()},{once:!0}))}function Nt(e){if(!e)return;const o=document.querySelector(".main-header");if(!o){e.scrollIntoView({behavior:"smooth",block:"center"});return}$e();const s=o.offsetHeight,t=16,l=(e.querySelector(".item-header")||e).getBoundingClientRect(),n=s+t,a=l.top-n;Math.abs(a)>5&&window.scrollBy({top:a,behavior:"smooth"})}function qe(e){if(!e)return;$e();const o=document.querySelector(".main-header"),s=document.querySelector(".summary-footer"),t=o?o.offsetHeight+16:80,r=s?s.offsetHeight+16:100;requestAnimationFrame(()=>{const l=e.getBoundingClientRect(),n=window.innerHeight;if(!(l.top>=t&&l.bottom<=n-r)){const c=n-t-r,d=l.height>c?"start":"center";e.scrollIntoView({behavior:"smooth",block:d})}})}function X(){document.querySelectorAll(w.room).forEach(e=>{const o=e.querySelectorAll(".item-card:not(.item-hidden)");let s=0;const t=Array.from(o).filter(r=>!r.classList.contains("is-suspended")).length;o.forEach(r=>{const l=r.querySelector("[data-item-title]");l&&(r.classList.contains("is-suspended")?l.textContent="-":(s++,l.textContent=`${s}/${t}`))}),e.querySelectorAll(".item-card.item-hidden").forEach(r=>{const l=r.querySelector("[data-item-title]");l&&(l.textContent="-")})})}function ot(){const e=document.querySelector(w.orderForm),o=document.querySelector(w.lockBtn);!e||!o||(e.classList.toggle("is-locked",G),o.classList.toggle("is-locked",G),o.querySelector("i").className=G?"ph-bold ph-lock-key":"ph ph-paw-print",e.querySelectorAll('input:not([type="hidden"]), select, textarea, button:not(.unlockable):not([data-act="toggle-more-details"]):not([data-act="collapse-room"])').forEach(s=>{!s.closest(".main-header")&&!s.closest(".summary-footer")&&!s.closest(".modal-wrapper")&&(s.disabled=G)}),document.querySelectorAll(".unlockable").forEach(s=>s.disabled=!1))}function Ft(){G=!G,ot(),$(G?"ฟอร์มถูกล็อค":"ปลดล็อคฟอร์มแล้ว",G?"warning":"success")}function Y(){const e=document.querySelectorAll(w.room+":not(.item-hidden)");if(e.length===0){const t=document.querySelector(w.toggleAllRoomsBtn);t&&(t.querySelector("i").className="ph ph-caret-down",t.querySelector("span").textContent="ขยายทั้งหมด");return}const o=[...e].some(t=>t.open),s=document.querySelector(w.toggleAllRoomsBtn);s&&(s.querySelector("i").className=o?"ph ph-caret-up":"ph ph-caret-down",s.querySelector("span").textContent=o?"ย่อทั้งหมด":"ขยายทั้งหมด")}function Pt(){const e=document.querySelectorAll(w.room+":not(.item-hidden)");if(e.length===0)return;const o=[...e].some(t=>t.open);e.forEach(t=>{t.open=!o});const s=document.querySelector(w.quickNavDropdown);s&&s.classList.contains("show")&&(s.classList.remove("show"),document.querySelector(w.quickNavBtn)?.setAttribute("aria-expanded","false")),setTimeout(()=>{Y(),j()},50)}function xe(){const e=document.querySelector(w.quickNavRoomList);e&&(e.innerHTML="",document.querySelectorAll(w.room).forEach(o=>{const s=o.querySelector(w.roomNameInput)?.value||"ห้อง",t=document.createElement("a");t.href=`#${o.id}`,t.dataset.jumpTo=o.id,t.innerHTML=`<i class="ph ph-share-fat"></i> ${T(s)||"ห้อง (ไม่มีชื่อ)"}`,e.appendChild(t)}))}function Me(e){const o=document.getElementById("quickNavBtnText");o&&(e?o.textContent=e.querySelector('input[name="room_name"]')?.value||"...":o.textContent="ไปยังห้อง")}function fe(){if(he&&he.disconnect(),!document.getElementById("quickNavBtnText"))return;const o={root:null,rootMargin:"-60px 0px -150px 0px",threshold:0},s=r=>{const l=r.filter(n=>n.isIntersecting).sort((n,a)=>n.target.getBoundingClientRect().top-a.target.getBoundingClientRect().top);l.length>0&&Me(l[0].target)};he=new IntersectionObserver(s,o),document.querySelectorAll(w.room).forEach(r=>he.observe(r));const t=Array.from(document.querySelectorAll(w.room));if(t.length>0){t.sort((l,n)=>l.getBoundingClientRect().top-n.getBoundingClientRect().top);const r=t.find(l=>l.getBoundingClientRect().bottom>60);Me(r||t[0])}else Me(null)}function be(e){if(!e)return;const o=e.closest(".form-group-with-favorites")?.querySelector(".btn-favorite");if(!o)return;const s=e.dataset.favoriteType,t=e.value;o.classList.toggle("is-favorite",Qe(s,t))}function Be(e,o=null){if(!e)return;const s=e.querySelector(".item-details-more"),t=e.querySelector('[data-act="toggle-more-details"]'),r=t?.parentElement;if(!s||!t||!r)return;const l=s.classList.contains("show"),n=o!==null?o:!l;if(l===n)return;s.classList.toggle("show",n),t.classList.toggle("expanded",n);const a=t.querySelector("i");a&&(a.className=n?"ph ph-caret-up":"ph ph-caret-down");const c=t.querySelector("span");if(c&&(c.textContent=n?"ย่อน้อยลง":"เพิ่มเติม"),n)s.appendChild(r),setTimeout(()=>Nt(e),100);else{const d=e.querySelector(".item-grid");d&&d.appendChild(r)}}function ae(e={}){const o=document.querySelector(w.roomsContainer);if(!o)return null;Object.keys(e).length===0&&(le(V()),Q());const s=Ze(e);return s?(o.appendChild(s),Object.keys(e).length===0&&(s.classList.add("item-created"),qe(s),s.querySelector('input[name="room_name"]')?.focus()),xe(),Y(),fe(),Object.keys(e).length===0&&j(),s):null}async function rt(e,o=null){const s=document.querySelector("#itemTypeModal");if(!s)return null;s.querySelector("#itemTypeModalTitle").textContent=e;let t=o||"set";o&&!F[o]&&(t="set");const r=s.querySelector(`input[name="item_type_option"][value="${t}"]`);if(r)r.checked=!0;else{const a=s.querySelector('input[name="item_type_option"][value="set"]');a&&(a.checked=!0)}const l=await W("#itemTypeModal");if(!l||l.cancelled)return null;const n=s.querySelector('input[name="item_type_option"]:checked');return n?n.value:null}async function Ot(e,o){if(!o||!e||!F[e])return;const s=o.getItemsContainer();if(!s)return;le(V()),Q();let t;if(e==="set")t=Pe();else if(e==="wallpaper")t=Oe();else if(F[e].templateId==="#areaBasedTpl")t=He(e);else return;t&&(s.appendChild(t),t.classList.add("item-created"),qe(t),t.querySelector('input:not([type="hidden"]), select, textarea')?.focus(),X(),D())}async function Ht(e){if(!e)return;const o=e.dataset.type,s=await rt("เปลี่ยนประเภทรายการ",o);if(!s||s===o||!await K("ยืนยันการเปลี่ยนแปลง","ข้อมูลทั้งหมดในรายการนี้จะถูกลบและสร้างใหม่ คุณแน่ใจหรือไม่?"))return;le(V()),Q();let t;if(s==="set")t=Pe();else if(s==="wallpaper")t=Oe();else if(F[s]?.templateId==="#areaBasedTpl")t=He(s);else return;t&&(e.replaceWith(t),t.classList.add("item-created"),qe(t),t.querySelector('input:not([type="hidden"]), select, textarea')?.focus(),X(),D(),$("เปลี่ยนประเภทรายการแล้ว","success"))}const D=pe(()=>{let e=0;document.querySelectorAll(w.room).forEach(d=>{let i=0,p=0;const u=d.classList.contains("is-suspended");u||(d.querySelectorAll(".item-card:not(.is-suspended)").forEach(f=>{const g=v(f.dataset.totalPrice);g>0&&(i+=g,p++)}),e+=i),typeof d.updateBrief=="function"&&(u?d.updateBrief("(ระงับชั่วคราว)"):p>0?d.updateBrief(`<span>${p}</span> &bull; ${M(i)} บาท`):d.updateBrief("<span>0</span> รายการ"))});const o=document.querySelector("#discount_type"),s=document.querySelector("#discount_value"),t=o?o.value:"amount",r=s?v(s.value):0;let l=0;r>0&&(l=t==="percent"?e*(r/100):r,l=Math.min(e,l));const n=e-l,a=document.querySelector("#grandTotal"),c=document.querySelector("#originalTotal");a&&(a.textContent=M(n)),c&&(l>0?(c.textContent=M(e),c.dataset.rawTotal=e,c.style.display="block"):(c.style.display="none",c.dataset.rawTotal="")),ie(),j()},200);async function De(e,o=!1){if(!e){$("ข้อมูลสำหรับโหลดไม่ถูกต้อง","error");return}if(e.favorites)if(o){const d=document.querySelector("#favoritesConflictModal");if(d){const i=d.querySelector('input[name="fav_conflict_option"][value="merge"]');i&&(i.checked=!0);const p=await W("#favoritesConflictModal");if(!p||p.cancelled){$("ยกเลิกการนำเข้า","warning");return}const u=d.querySelector('input[name="fav_conflict_option"]:checked').value;let f=0;switch(u){case"overwrite":je(e.favorites)&&$("เขียนทับรายการโปรดสำเร็จ","success");break;case"merge":f=Ce(e.favorites),$(`รวมข้อมูลสำเร็จ (เพิ่ม ${f} รายการใหม่)`,"success");break;case"skip":$("ข้ามการนำเข้ารายการโปรด","default");break}}else Ce(e.favorites)}else je(e.favorites);const s=document.querySelector(w.roomsContainer);if(!s)return;s.innerHTML="";const t=document.querySelector("#customer_name"),r=document.querySelector("#customer_phone"),l=document.querySelector("#customer_address"),n=document.querySelector("#customerDetailsCard");t&&(t.value=e.customer_name||""),r&&(r.value=e.customer_phone||""),l&&(l.value=e.customer_address||""),n&&(n.open=e.customer_card_open??!0);const a=document.querySelector("#discount_type"),c=document.querySelector("#discount_value");if(e.discount&&a&&c?(a.value=e.discount.type||"amount",c.value=e.discount.value||0):a&&c&&(a.value="amount",c.value=0),!Array.isArray(e.rooms)){$("ไม่พบข้อมูลห้องในไฟล์","warning"),s.children.length===0&&ae();return}for(const d of e.rooms){const i=Ze(d);if(!i)continue;s.appendChild(i);const p=i.getItemsContainer();if(p&&Array.isArray(d.items))for(const u of d.items){u.type==="deco"&&u.deco_type&&(u.code=u.deco_code,u.width_m=u.deco_width_m,u.height_m=u.deco_height_m,u.price_sqyd=u.deco_price_sqyd,u.notes=u.deco_notes,delete u.deco_type,delete u.deco_code,delete u.deco_width_m,delete u.deco_height_m,delete u.deco_price_sqyd,delete u.deco_notes);let f;if(u.type==="set")f=Pe(u);else if(u.type==="wallpaper")f=Oe(u);else if(F[u.type]?.templateId==="#areaBasedTpl")f=He(u.type,u);else continue;f&&p.appendChild(f)}}document.querySelectorAll("input[data-favorite-type]").forEach(be),X(),xe(),Y(),fe(),Q(),D(),o&&$("นำเข้าข้อมูลฟอร์มสำเร็จ","success")}async function Dt(e,o){const s=document.querySelector(w.printableContent);if(!s||!e){$("ไม่พบข้อมูลสำหรับสร้างเอกสาร","error");return}const t=document.title;if(o==="direct"){$("กำลังสร้าง PDF...","default");let r;try{typeof window.html2pdf>"u"&&($("กำลังโหลดไลบรารี PDF...","default"),await Et("https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js")),r=document.createElement("div"),r.style.position="fixed",r.style.left="-300mm",r.style.top="0",r.style.width="210mm",r.style.background="#fff",r.innerHTML=e,document.body.appendChild(r),await new Promise(n=>setTimeout(n,300));const l={margin:0,filename:`${t}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0,logging:!1,width:r.querySelector(".pdf-page")?.scrollWidth||794,windowWidth:r.querySelector(".pdf-page")?.scrollWidth||794},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}};await window.html2pdf().from(r).set(l).save(),$("ดาวน์โหลด PDF สำเร็จ","success")}catch(l){console.error("PDF Generation Error:",l),$("สร้าง PDF ล้มเหลว, โปรดลองวิธีที่ 2 (พิมพ์)","error")}finally{r&&document.body.contains(r)&&document.body.removeChild(r)}}else o==="print"&&(s.innerHTML=e,setTimeout(()=>{window.print(),setTimeout(()=>{s.innerHTML=""},1e3)},dt))}function jt(e){if(!e||!e.html){$("ไม่พบข้อมูลสำหรับสร้างไฟล์ HTML","error");return}try{const o=`<!DOCTYPE html><html lang="th"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>${e.fileName}</title><link rel="stylesheet" href="./src/styles/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/bold/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/fill/style.css"><style>body { background-color: #eee; } #printable-content { display: block !important; max-width: 210mm; margin: 10mm auto; } .pdf-page { border: 1px solid #ccc; box-shadow: 0 0 10px rgba(0,0,0,0.1); margin-bottom: 10mm; background: #fff; page-break-inside: avoid; } .pdf-page-content { padding: 12mm; } @media print { body { background-color: #fff; } #printable-content { max-width: 100%; margin: 0; } .pdf-page { border: none; box-shadow: none; margin-bottom: 0; page-break-after: always; } .pdf-page:last-child { page-break-after: avoid; } } i.ph { vertical-align: middle; }</style></head><body><div id="printable-content">${e.html}</div></body></html>`,s=new Blob([o],{type:"text/html;charset=utf-8"}),t=URL.createObjectURL(s),r=document.createElement("a");r.href=t,r.download=`${e.fileName}.html`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(t),$("ดาวน์โหลดไฟล์ HTML สำเร็จ","success")}catch(o){console.error("HTML Export Error:",o),$("สร้างไฟล์ HTML ล้มเหลว","error")}}function Wt(e){const o=e.closest(".item-card");if(!o)return;const s=v(e.value);let t;const r=e.getAttribute("name");if(r==="set_price_per_m")t=o.querySelector('input[name="fabric_code"]');else if(r==="sheer_price_per_m")t=o.querySelector('input[name="sheer_fabric_code"]');else if(r==="wallpaper_price_roll")t=o.querySelector('input[name="wallpaper_code"]');else if(r==="area_price_sqyd")t=o.querySelector('input[name="area_code"]');else return;if(t&&t.value.trim()){const l=t.dataset.favoriteType,n=t.value.trim(),a=Ke(l,n);if(a&&a.price!==s){const c=t.closest(".form-group-with-favorites")?.querySelector(".btn-favorite");c?.classList.contains("is-favorite")&&(ye(l,n,a.price),c.classList.remove("is-favorite"),$(`ยกเลิก Favorite '${n}' เนื่องจากราคาไม่ตรงกัน`,"warning"),j())}}}function Vt(e){const{roomId:o,itemIndex:s}=e.dataset;if(!o||s===void 0)return;const t=document.getElementById("lookbookModal");t&&t.classList.remove("visible");const r=document.getElementById(o);if(!r){$("ไม่พบห้องที่ต้องการ","error");return}const n=Array.from(r.querySelectorAll(".item-card:not(.item-hidden)"))[parseInt(s,10)];if(!n){$("ไม่พบรายการที่ต้องการ","error");return}r.open=!0,Y(),setTimeout(()=>{$e(),n.scrollIntoView({behavior:"smooth",block:"center"}),n.classList.add("scrolling-jump"),setTimeout(()=>n.classList.remove("scrolling-jump"),2500)},150)}function nt(e){if(!z)return;const o=z.closest(".item-card");if(!o)return;const s=e.dataset.code,t=v(e.dataset.price);z.value=s,z.classList.add("input-highlight"),setTimeout(()=>z.classList.remove("input-highlight"),1200);const r=z.dataset.favoriteType;let l;r==="fabric"?l="set_price_per_m":r==="sheer"?l="sheer_price_per_m":r==="wallpaper"?l="wallpaper_price_roll":l="area_price_sqyd";const n=o.querySelector(`[name="${l}"]`);n&&t>0&&(n.tagName==="SELECT"?n.value=t:n.value=M(t),n.classList.add("input-highlight"),setTimeout(()=>n.classList.remove("input-highlight"),1200)),be(z),D(),j(),document.querySelector("#favoritesModal").classList.remove("visible")}async function st(e){z=e;const o=e.dataset.favoriteType;if(!o)return;const s=document.querySelector("#favoritesModal"),t=s.querySelector("#favoritesModalTitle"),r=s.querySelector("#favoritesModalBody"),l=s.querySelector("#favSearchInput"),n=s.querySelector("#favoritesModalManageBtn"),a=document.querySelector("#favSelectorItemTpl"),c=F[o]?.name||o;t.textContent=`เลือก '${T(c)}'`;const i=Z()[o]||[];i.length>0?r.innerHTML=i.map(f=>a.innerHTML.replace(/{CODE}/g,T(f.code)).replace(/{PRICE}/g,f.price>0?M(f.price):"-").replace(/{RAW_PRICE}/g,f.price)).join(""):r.innerHTML='<p class="empty-state">ไม่มีรายการโปรดที่บันทึกไว้</p>',l.value="";const p=()=>{const f=l.value.toLowerCase();r.querySelectorAll(".fav-selector-item").forEach(g=>{const L=g.dataset.code.toLowerCase();g.classList.toggle("is-hidden",!L.includes(f))})};l.addEventListener("input",p);const u=f=>{const g=f.target.closest(".fav-selector-item");g&&(nt(g),r.removeEventListener("click",u),l.removeEventListener("input",p))};r.addEventListener("click",u),n.onclick=async()=>{s.classList.remove("visible"),await Ut(o),me&&await st(e)},await W("#favoritesModal",()=>{l.removeEventListener("input",p),r.removeEventListener("click",u)})}function ge(e){const o=document.querySelector("#favManagerBody"),s=document.querySelector("#favManagerItemTpl"),r=Z()[e]||[];if(!o||!s)return;r.length===0?o.innerHTML='<p class="empty-state">ไม่มีรายการโปรดที่บันทึกไว้</p>':o.innerHTML=r.map(a=>s.innerHTML.replace(/{CODE}/g,T(a.code)).replace(/{PRICE}/g,M(a.price)).replace(/{RAW_PRICE}/g,a.price)).join(""),O=null;const l=document.querySelector('#favManagerModal [data-act="edit-selected-fav"]'),n=document.querySelector('#favManagerModal [data-act="del-selected-fav"]');l&&(l.disabled=!0),n&&(n.disabled=!0)}async function Ut(e){const o=document.querySelector("#favManagerModal");if(!o||!e)return;const s=F[e]?.name||e;o.dataset.currentType=e,me=!1,O=null,document.querySelector("#favManagerTitle").textContent=`จัดการ '${T(s)}'`,ge(e),await W("#favManagerModal")}function Gt(){const e=document.querySelector(w.orderForm),o=document.querySelector(w.fileImporter),s=document.querySelector("#favImporter"),t=document.querySelector(w.menuDropdown),r=document.querySelector(w.quickNavDropdown),l=document.querySelector(w.menuBtn),n=document.querySelector(w.quickNavBtn);if(e.addEventListener("item-update",D),e.addEventListener("input",a=>{if(G){a.preventDefault();return}a.target.closest("#customerInfo")&&j();const c=a.target.closest("input[data-favorite-type]");if(c&&be(c),a.target.matches(w.roomNameInput)){const i=a.target.closest(".room-card")?.querySelector("[data-room-name-display]");i&&(i.textContent=a.target.value||"ห้อง"),xe(),fe(),pe(j,300)()}a.target.matches('input[name$="_m"], input[name$="price_sqyd"], input[name$="price_roll"], input[name$="install_cost"]')&&D()}),e.addEventListener("change",a=>{if(G){a.preventDefault();return}a.target.matches("select")&&D()}),e.addEventListener("blur",a=>{const c=a.target;c.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_install_cost"]')?(Wt(c),c.value=v(c.value)>0?M(v(c.value)):""):c.matches('input[name$="_m"], input[name^="wall_width_m"]')&&(c.value=te(c.value)),c.matches('input:not([type="hidden"]), select, textarea')&&j()},!0),e.addEventListener("focusin",a=>{const c=a.target;c.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_install_cost"]')&&v(c.value)>0&&(c.value=v(c.value));const d=c.closest(".item-card, .room-card");d&&qe(d)},!0),e.addEventListener("keydown",a=>{if(G){a.preventDefault();return}const c=a.target;a.key==="Enter"&&c.matches("input, select")&&!c.closest(".modal-wrapper")&&a.preventDefault()}),document.addEventListener("click",async a=>{a.target.closest(".menu-container")||(t?.classList.remove("show"),l?.setAttribute("aria-expanded","false"),r?.classList.remove("show"),n?.setAttribute("aria-expanded","false")),a.target.closest(".room-options-container")||document.querySelectorAll(".room-options-menu.show").forEach(u=>u.classList.remove("show"));const c=a.target.closest(".summary-tag[data-filter-type]");if(c&&c.closest("#overviewModal")){const u=c.dataset.filterType,f=c.textContent.trim().replace(/\s*\d+\s*$/,""),g=document.querySelector("#overviewModal");g&&g.classList.remove("visible"),Bt(u,f);return}const d=a.target.closest(".fav-manager-item");if(d){const u=d.closest("#favManagerModal"),f=u?.querySelector(".fav-manager-item.is-selected");f&&f.classList.remove("is-selected"),f!==d?(d.classList.add("is-selected"),O={code:d.dataset.code,price:v(d.dataset.price)}):O=null,u&&(u.querySelector('[data-act="edit-selected-fav"]').disabled=!O,u.querySelector('[data-act="del-selected-fav"]').disabled=!O);return}const i=a.target.closest(".fav-selector-item");if(i){nt(i);return}const p=a.target.closest("[data-act]");if(p){const u=p.dataset.act,f=p.closest(".item-card"),g=p.closest(".room-card"),L=["toggle-more-details","collapse-room","show-discount-modal","show-suspended-items","clear-filter","close-modal","jump-to-item"];if(G&&!p.closest(".unlockable")&&!L.includes(u)){$("ฟอร์มถูกล็อคอยู่","warning");return}switch(["toggle-more-details","close-modal","collapse-room"].includes(u)||a.preventDefault(),a.stopPropagation(),u){case"show-discount-modal":At();break;case"show-suspended-items":Ee();break;case"clear-filter":tt();break;case"add-room":ae();break;case"add-item":if(g){const y=await rt("เพิ่มรายการใหม่");y&&Ot(y,g)}break;case"collapse-room":setTimeout(()=>{Y(),j()},50);break;case"toggle-room-menu":p.nextElementSibling?.classList.toggle("show");break;case"toggle-suspend-room":g&&(g.classList.toggle("is-suspended"),p.closest(".room-options-menu")?.classList.remove("show"),D(),ce==="suspended"?Ee():ie());break;case"clear-room":g&&await K("ล้างข้อมูลในห้อง","?")&&(le(V()),Q(),g.getItemsContainer().innerHTML="",X(),D(),$("ล้างแล้ว","success"));break;case"del-room":g&&await K("ลบห้อง","?")&&Ie(g,"ลบแล้ว");break;case"del-item":f&&await K("ลบรายการ","?")&&Ie(f,"ลบแล้ว");break;case"toggle-suspend":f&&(f.classList.toggle("is-suspended"),D(),ce==="suspended"?Ee():ie());break;case"change-type":f&&Ht(f);break;case"toggle-more-details":f&&!f.querySelector(".item-details-more")?.classList.contains("show")&&document.querySelectorAll(".item-details-more.show").forEach(y=>{y.closest(".item-card")!==f&&Be(y.closest(".item-card"),!1)}),Be(f);break;case"open-hardware-modal":H=f,H&&Rt();break;case"apply-hardware-to-room":{const y=p.closest("#hardwareModal"),m=H?.closest(w.room);if(!y||!m||!H)break;if(H.querySelector('[name="set_style"]')?.value==="ม่านพับ"){$("ไม่สามารถใช้กับม่านพับได้","warning");break}const x=y.querySelector('[name="modal_track_color"]').value,_=y.querySelector('[name="modal_bracket_color"]').value,b=y.querySelector('[name="modal_finial_color"]').value,k=y.querySelector('[name="modal_grommet_color"]').value;m.querySelectorAll('.set-item:not(:has(select[name="set_style"][value="ม่านพับ"]))').forEach(S=>{S.querySelector('[name="track_color"]').value=x,S.querySelector('[name="bracket_color"]').value=_,S.querySelector('select[name="set_style"]')?.value==="ตาไก่"&&(S.querySelector('[name="finial_color"]').value=b,S.querySelector('[name="grommet_color"]').value=k)}),j(),$("ใช้กับรายการที่เข้ากันได้ในห้องแล้ว","success");break}case"add-wall":{const y=p.closest(".walls-section")?.querySelector("[data-walls-container]");if(y){const m=Re();m&&(y.appendChild(m),m.querySelector("input")?.focus(),D())}break}case"del-wall":{const y=p.closest(".wall-input-row");y&&await K("ลบผนัง","?")&&Ie(y,"ลบแล้ว");break}case"show-favorites":{const y=p.closest(".form-group-with-favorites")?.querySelector("input[data-favorite-type]");y&&st(y);break}case"toggle-favorite":{const m=p.closest(".form-group-with-favorites")?.querySelector("input[data-favorite-type]");if(!m||!f)break;const h=m.dataset.favoriteType,x=m.value;let _=0,b;if(m.name==="fabric_code"?b=f.querySelector('[name="set_price_per_m"]'):m.name==="sheer_fabric_code"?b=f.querySelector('[name="sheer_price_per_m"]'):m.name==="wallpaper_code"?b=f.querySelector('[name="wallpaper_price_roll"]'):m.name==="area_code"&&(b=f.querySelector('[name="area_price_sqyd"]')),_=v(b?.value),!x.trim()){$("โปรดระบุรหัส","warning");break}if(!["fabric","sheer"].includes(h)&&_<=0){$("โปรดระบุราคา","warning");break}const k=ye(h,x,_);k!==null&&(p.classList.toggle("is-favorite",k),$(k?"เพิ่มแล้ว":"ลบแล้ว","success"),j());break}case"add-new-fav-form":{const m=p.closest("#favManagerModal")?.dataset.currentType;if(!m)break;const h=document.querySelector("#favAddModal");if(!h)break;h.querySelector("h3").textContent=`เพิ่ม '${F[m]?.name||m}'`;const x=h.querySelector('[name="fav_code_add"]'),_=h.querySelector('[name="fav_price_add"]');x.value="",_.value="";const b=await W("#favAddModal");if(b&&!b.cancelled){const k=x.value.trim(),S=v(_.value);k?ye(m,k,S)!==null?(me=!0,ge(m),$("เพิ่มแล้ว","success")):$("ล้มเหลว","error"):$("ต้องระบุรหัส","warning")}break}case"edit-selected-fav":{if(!O)break;const m=p.closest("#favManagerModal")?.dataset.currentType;if(!m)break;const h=document.querySelector("#favEditModal");if(!h)break;h.querySelector("h3").textContent=`แก้ไข '${O.code}'`;const x=h.querySelector('[name="fav_code_edit"]'),_=h.querySelector('[name="fav_price_edit"]');x.value=O.code,_.value=O.price>0?O.price:"";const b=await W("#favEditModal");if(b&&!b.cancelled){const k=x.value.trim(),S=v(_.value);k?(k!==O.code&&Ae(m,O.code),ye(m,k,S),me=!0,ge(m),$("แก้ไขรายการโปรดแล้ว","success")):$("ต้องระบุรหัส","warning")}break}case"del-selected-fav":{if(!O)break;const m=p.closest("#favManagerModal")?.dataset.currentType;if(!m)break;await K("ลบรายการโปรด",`"${O.code}"?`)&&(Ae(m,O.code)?(me=!0,ge(m),$("ลบแล้ว","success")):$("ล้มเหลว","error"));break}case"jump-to-item":Vt(p);break}}else{const u=a.target.closest("summary");u&&u.closest("details.card")&&setTimeout(()=>{Y(),j()},50)}}),document.querySelector("#undoBtn")?.addEventListener("click",a=>{a.preventDefault(),Mt()}),document.querySelector(w.lockBtn)?.addEventListener("click",a=>{a.preventDefault(),Ft()}),document.querySelector(w.toggleAllRoomsBtn)?.addEventListener("click",a=>{a.preventDefault(),Pt()}),n&&r){n.addEventListener("click",c=>{c.stopPropagation(),t?.classList.remove("show");const d=!r.classList.contains("show");r.classList.toggle("show",d),n.setAttribute("aria-expanded",d),d&&l?.setAttribute("aria-expanded","false")}),document.querySelector(w.quickNavRoomList)?.addEventListener("click",c=>{const d=c.target.closest("a[data-jump-to]");if(d){c.preventDefault();const i=d.dataset.jumpTo,p=document.getElementById(i);p&&(p.open=!0,$e(),p.scrollIntoView({behavior:"smooth",block:"center"}),p.classList.add("scrolling-jump"),setTimeout(()=>p.classList.remove("scrolling-jump"),2500),setTimeout(Y,100)),r.classList.remove("show"),n.setAttribute("aria-expanded","false")}});const a=document.querySelector("#addRoomQuickNavBtn");if(a){const c=mt(ae,700);a.addEventListener("click",d=>{d.stopPropagation(),c(),r.classList.remove("show"),n.setAttribute("aria-expanded","false")})}}l&&t&&l.addEventListener("click",a=>{a.stopPropagation(),r?.classList.remove("show");const c=!t.classList.contains("show");t.classList.toggle("show",c),l.setAttribute("aria-expanded",c),c&&n?.setAttribute("aria-expanded","false")}),document.querySelector("#themeToggleBtn")?.addEventListener("click",a=>{a.preventDefault(),It(),t?.classList.remove("show"),l?.setAttribute("aria-expanded","false")}),document.querySelector("#overviewBtn")?.addEventListener("click",async a=>{a.preventDefault(),t?.classList.remove("show"),l?.setAttribute("aria-expanded","false");const c=V(),d=document.querySelector("#overviewModalHeader"),i=document.querySelector("#overviewModalBody");if(d&&i){const p=c.rooms.reduce((g,L)=>g+(L.is_suspended?0:(L.items||[]).filter(y=>!y.is_suspended&&(A.calculateSetPrice(y)?.total>0||A.calculateWallpaperPrice(y)?.total>0||A.calculateAreaBasedPrice(y)?.total>0)).length),0),u=document.querySelector(w.grandTotal)?.textContent||"0",f=c.rooms.filter(g=>!g.is_suspended&&g.items?.some(L=>!L.is_suspended)).length;d.innerHTML=`<div class="overview-stats-grid"><div class="overview-stat-card"><i class="ph-bold ph-map-pin-line"></i><div class="stat-value">${f}</div><div class="stat-label">ห้อง</div></div><div class="overview-stat-card"><i class="ph-bold ph-stack"></i><div class="stat-value">${p}</div><div class="stat-label">รายการ</div></div><div class="overview-stat-card"><i class="ph-bold ph-coins"></i><div class="stat-value">${u}</div><div class="stat-label">ยอดรวม</div></div></div>`,i.innerHTML=kt(c),W("#overviewModal")}}),document.querySelector("#copyTextBtn")?.addEventListener("click",async a=>{a.preventDefault(),t?.classList.remove("show"),l?.setAttribute("aria-expanded","false");const c=document.querySelector(w.copyOptionsModal);if(!c)return;c.querySelector('input[name="copy_option"][value="customer"]').checked=!0;const d=await W(w.copyOptionsModal);if(d&&!d.cancelled){const i=c.querySelector('input[name="copy_option"]:checked').value,p=xt(V(),i);try{await navigator.clipboard.writeText(p),$("คัดลอกสำเร็จ!","success")}catch{$("คัดลอกล้มเหลว","error")}}}),document.querySelector("#visualReportsBtn")?.addEventListener("click",async a=>{a.preventDefault(),t?.classList.remove("show"),l?.setAttribute("aria-expanded","false");const c=document.querySelector("#visualReportsModal");if(!c)return;c.querySelector('input[name="report_type_option"][value="lookbook"]').checked=!0;const d=await W("#visualReportsModal");if(d&&!d.cancelled){const i=c.querySelector('input[name="report_type_option"]:checked').value;if(i==="lookbook"){const p=V(),u=Tt(p),f=document.querySelector("#lookbookModalBody");u&&f?(f.innerHTML=u,W("#lookbookModal")):$("ไม่มีข้อมูล","warning")}else $(`'${i}' ยังไม่พร้อม`,"default")}}),document.querySelector(w.exportPdfBtn)?.addEventListener("click",async a=>{a.preventDefault(),t?.classList.remove("show"),l?.setAttribute("aria-expanded","false");const c=await Ct();if(!c)return;const d=V(),i=Lt(d,{vatRate:c.vatOption==="include"?P.baseVatRate:0,pageBreakBuffer:c.pageBreakBuffer});if(!i){$("ไม่มีรายการ","warning");return}c.exportMethod==="html"?jt(i):Dt(i.html,c.exportMethod)}),document.querySelector(w.submitBtn)?.addEventListener("click",async a=>{if(a.preventDefault(),t?.classList.remove("show"),l?.setAttribute("aria-expanded","false"),await K("ส่งข้อมูล","?")){const c=V();if(!c.customer_name&&!c.customer_phone){$("ใส่ชื่อ/เบอร์","warning");return}$("กำลังส่ง...","default");try{const d=await fetch(it,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});d.ok?$("ส่งแล้ว!","success"):$(`ล้มเหลว: ${d.status}`,"error")}catch{$("เชื่อมต่อผิดพลาด","error")}}}),document.querySelector(w.importBtn)?.addEventListener("click",a=>{a.preventDefault(),t?.classList.remove("show"),l?.setAttribute("aria-expanded","false"),o?.click()}),o?.addEventListener("change",a=>{const c=a.target.files?.[0];if(!c)return;const d=new FileReader;d.onload=async i=>{try{const p=JSON.parse(i.target.result);if(p&&typeof p=="object")await De(p,!0);else throw new Error("Invalid JSON")}catch(p){$("ไฟล์ JSON ไม่ถูก","error"),console.error(p)}},d.readAsText(c),a.target.value=null}),document.querySelector(w.exportBtn)?.addEventListener("click",a=>{a.preventDefault(),t?.classList.remove("show"),l?.setAttribute("aria-expanded","false");try{const c=V(),d=JSON.stringify(c,null,4),i=new Blob([d],{type:"application/json"}),p=URL.createObjectURL(i),u=document.createElement("a"),f=new Date,g=`${f.getFullYear()}${(f.getMonth()+1).toString().padStart(2,"0")}${f.getDate().toString().padStart(2,"0")}`,L=`${f.getHours().toString().padStart(2,"0")}${f.getMinutes().toString().padStart(2,"0")}`,y=Je(c.customer_name||"data");u.href=p,u.download=`MTR-${g}${L}-${y}.json`,u.click(),URL.revokeObjectURL(p),$("Export สำเร็จ","success")}catch{$("Export ล้มเหลว","error")}}),document.querySelector("#importFavsBtn")?.addEventListener("click",a=>{a.preventDefault(),t?.classList.remove("show"),l?.setAttribute("aria-expanded","false"),s?.click()}),s?.addEventListener("change",a=>{const c=a.target.files?.[0];if(!c)return;const d=new FileReader;d.onload=i=>{try{const p=JSON.parse(i.target.result),u=Ce(p);u>0?$(`เพิ่ม ${u} รายการ`,"success"):$("ไม่พบรายการใหม่","default"),document.querySelectorAll("input[data-favorite-type]").forEach(be)}catch{$("ไฟล์ JSON ไม่ถูก","error")}},d.readAsText(c),a.target.value=null}),document.querySelector("#exportFavsBtn")?.addEventListener("click",a=>{a.preventDefault(),t?.classList.remove("show"),l?.setAttribute("aria-expanded","false");try{const c=Z();if(Object.values(c).every(g=>g.length===0)){$("ไม่มีรายการ","warning");return}const d=JSON.stringify(c,null,4),i=new Blob([d],{type:"application/json"}),p=URL.createObjectURL(i),u=document.createElement("a"),f=new Date().toISOString().slice(0,10).replace(/-/g,"");u.href=p,u.download=`MTR-Favorites-${f}.json`,u.click(),URL.revokeObjectURL(p),$("Export สำเร็จ","success")}catch{$("Export ล้มเหลว","error")}}),document.querySelector(w.clearItemsBtn)?.addEventListener("click",async a=>{if(a.preventDefault(),t?.classList.remove("show"),l?.setAttribute("aria-expanded","false"),await K("ล้างทุกรายการ","?")){le(V()),Q(),document.querySelectorAll(w.room).forEach(i=>{i.getItemsContainer().innerHTML=""});const c=document.querySelector("#discount_type"),d=document.querySelector("#discount_value");c&&(c.value="amount"),d&&(d.value="0"),X(),D(),$("ล้างแล้ว","success")}}),document.querySelector(w.clearAllBtn)?.addEventListener("click",async a=>{a.preventDefault(),t?.classList.remove("show"),l?.setAttribute("aria-expanded","false"),await K("ลบข้อมูลทั้งหมด","คำเตือน! ลบถาวร?")&&(localStorage.removeItem(de),ht(),window.location.reload())}),window.addEventListener("click",a=>{a.target.closest(".menu-container")||(t?.classList.remove("show"),r?.classList.remove("show"),l?.setAttribute("aria-expanded","false"),n?.setAttribute("aria-expanded","false")),a.target.closest(".room-options-container")||document.querySelectorAll(".room-options-menu.show").forEach(d=>d.classList.remove("show"));const c=a.target.closest(".item-card");document.querySelectorAll(".item-details-more.show").forEach(d=>{const i=d.closest(".item-card");i!==c&&Be(i,!1)})}),window.addEventListener("beforeunload",j)}function Yt(){const e=document.querySelector(w.setTpl);if(!e)return;const o=e.content.querySelector('select[name="set_price_per_m"]'),s=e.content.querySelector('select[name="sheer_price_per_m"]'),t=r=>{let l='<option value="" hidden>เลือกราคา</option>';return Array.isArray(r)?(r.forEach(n=>{l+=`<option value="${n}">${n.toLocaleString("th-TH")}</option>`}),l):(console.error("Price data for dropdown is not available or not an array.",r),l)};o&&(o.innerHTML=t(_e.fabric)),s&&(s.innerHTML=t(_e.sheer))}function Jt(){Yt(),et(),Gt();try{const e=localStorage.getItem(de);if(e&&e!=="null"&&e!=="{}"){const o=JSON.parse(e);if(o&&Array.isArray(o.rooms))De(o,!1);else{console.warn("Stored data structure seems invalid, starting fresh."),localStorage.removeItem(de),ae();const s=document.querySelector("#customerDetailsCard");s&&(s.open=!0)}}else{ae();const o=document.querySelector("#customerDetailsCard");o&&(o.open=!0)}}catch(e){console.error("Failed to load or parse data from localStorage:",e),localStorage.removeItem(de),ae();const o=document.querySelector("#customerDetailsCard");o&&(o.open=!0)}D(),ot(),Y(),fe(),Q(),console.log("Marnthara App Initialized (Vite Refactor)")}document.addEventListener("DOMContentLoaded",Jt);
