(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))r(a);new MutationObserver(a=>{for(const s of a)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&r(o)}).observe(document,{childList:!0,subtree:!0});function n(a){const s={};return a.integrity&&(s.integrity=a.integrity),a.referrerPolicy&&(s.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?s.credentials="include":a.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(a){if(a.ep)return;a.ep=!0;const s=n(a);fetch(a.href,s)}})();const st="input-ui/5.7.0",lt="https://your-make-webhook-url.com/your-unique-path",ve="marnthara.input.v5",ct=500,N={name:"ม่านธารา ผ้าม่านและของตกแต่ง",address:"65/8 หมู่ 2 ต.ท่าศาลา อ.เมือง จ.ลพบุรี 15000",phone:"092-985-9395, 082-552-5595",taxId:"1234567890123",logoUrl:"./assets/logo.png",baseVatRate:.07,pdf:{paymentTerms:"ชำระมัดจำ 50%",priceValidity:"30 วัน",notes:["ราคานี้รวมค่าติดตั้งแล้ว","ชำระมัดจำ 50% เพื่อยืนยันการสั่งผลิตสินค้า","ใบเสนอราคานี้มีอายุ 30 วัน นับจากวันที่เสนอราคา"]}},it=1.19599,$e={ROLL_WIDTH_M:.53,ROLL_LENGTH_M:10,STRIPS_PER_ROLL_UNDER_2_5M:3},_e={fabric:[1e3,1100,1200,1300,1400,1500,1600,1700,1800,1900,2e3,2100,2200],sheer:[1e3,1100,1200,1300,1400,1500],style_surcharge:{ลอน:200,ตาไก่:0,จีบ:0},height:[{threshold:3.2,add_per_m:300},{threshold:2.8,add_per_m:200},{threshold:2.5,add_per_m:100}]},y={orderForm:"#orderForm",roomsContainer:"#rooms",setTpl:"#setTpl",wallTpl:"#wallTpl",clearAllBtn:"#clearAllBtn",lockBtn:"#lockBtn",grandTotal:"#grandTotal",modal:"#confirmationModal",modalTitle:"#modalTitle",modalBody:"#modalBody",room:"[data-room]",allItemsContainer:"[data-all-items]",wallsContainer:"[data-walls-container]",sheerWrap:"[data-sheer-wrap]",sheerCodeWrap:"[data-sheer-code-wrap]",roomNameInput:'input[name="room_name"]',toastContainer:"#toast-container",copyTextBtn:"#copyTextBtn",copyOptionsModal:"#copyOptionsModal",menuBtn:"#menuBtn",menuDropdown:"#menuDropdown",importBtn:"#importBtn",exportBtn:"#exportBtn",fileImporter:"#fileImporter",submitBtn:"#submitBtn",clearItemsBtn:"#clearItemsBtn",exportPdfBtn:"#exportPdfBtn",exportOptionsModal:"#exportOptionsModal",printableContent:"#printable-content",quickNavBtn:"#quickNavBtn",quickNavDropdown:"#quickNavDropdown",quickNavRoomList:"#quickNavRoomList",toggleAllRoomsBtn:"#toggleAllRoomsBtn"},v=e=>{typeof e=="string"&&(e=e.replace(/,/g,""));const t=parseFloat(e);return Number.isFinite(t)?t:0},Z=e=>{const t=v(e);return t>0?t.toFixed(2):""},W=(e,t=2,n=!1)=>Number.isFinite(e)?e.toLocaleString("en-US",{minimumFractionDigits:n?2:t,maximumFractionDigits:n?2:t}):"0",k=(e,t=0)=>Number.isFinite(e)?e.toLocaleString("th-TH",{minimumFractionDigits:t,maximumFractionDigits:t}):"0",dt=(e,t=150)=>{let n;return(...r)=>{clearTimeout(n),n=setTimeout(()=>e(...r),t)}},ut=(e,t=700)=>{let n=!1;return(...r)=>{if(!n){n=!0;try{return e(...r)}finally{setTimeout(()=>{n=!1},t)}}}},q=e=>typeof e!="string"?"":e.replace(/[&<>"']/g,function(t){switch(t){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";default:return"&#039;"}}),Qe=e=>typeof e!="string"?"":e.replace(/[\\/?%*:|"<>\x00-\x1f]/g,"").trim()||"file";function mt(e){let t=v(e);if(isNaN(t))return"ข้อมูลตัวเลขไม่ถูกต้อง";if(t===0)return"ศูนย์บาทถ้วน";const n=["","หนึ่ง","สอง","สาม","สี่","ห้า","หก","เจ็ด","แปด","เก้า"],r=["","สิบ","ร้อย","พัน","หมื่น","แสน","ล้าน"];let a=Math.floor(t),s=Math.round((t-a)*100);const o=c=>{if(c===0)return"";let d="";const p=String(c);for(let m=0;m<p.length;m++){const h=p[m];p.length-1;const g=p.length-m-1;h!=="0"&&(g===1&&h==="1"?d+=r[g]:g===1&&h==="2"?d+="ยี่"+r[g]:g===0&&h==="1"&&p.length>1?d+="เอ็ด":d+=n[parseInt(h)]+r[g])}return d};let l="";if(a>0){const c=Math.floor(a/1e6),d=a%1e6;c>0&&(l+=o(c)+"ล้าน"),l+=o(d),l+="บาท"}let u="";return s>0?u=o(s)+"สตางค์":l+="ถ้วน",(l+u).trim()}const Ae="marnthara.favorites.v4",ye={fabric:[],sheer:[],wallpaper:[],wooden_blind:[],roller_blind:[],vertical_blind:[],partition:[],pleated_screen:[],aluminum_blind:[]};function Q(){try{const e=localStorage.getItem(Ae);return e?{...ye,...JSON.parse(e)}:ye}catch(e){return console.error("Failed to parse favorites from localStorage",e),ye}}function Se(e){try{localStorage.setItem(Ae,JSON.stringify(e))}catch(t){console.error("Failed to save favorites to localStorage",t)}}function De(e){if(!e||typeof e!="object")return console.error("Invalid favorites data for import."),!1;const t={...ye,...e};return Se(t),!0}function Xe(e){if(!e||typeof e!="object")return console.error("Invalid favorites data for merge."),0;const t=Q();let n=0;for(const r in e)Object.hasOwnProperty.call(e,r)&&Array.isArray(e[r])&&(t[r]||(t[r]=[]),e[r].forEach(a=>{!t[r].some(o=>o.code===a.code)&&a.code&&(t[r].push(a),n++)}),t[r].sort((a,s)=>a.code.localeCompare(s.code)));return n>0&&Se(t),n}function pt(e,t,n){const r=Q();r[e]||(r[e]=[]);const a=r[e],s=a.find(o=>o.code===t);return s?s.price=n:a.push({code:t,price:n}),a.sort((o,l)=>o.code.localeCompare(l.code)),Se(r),!0}function Be(e,t){const n=Q();if(!n[e])return!1;const r=n[e].findIndex(a=>a.code===t);return r>-1?(n[e].splice(r,1),Se(n),!0):!1}function Ne(e,t){if(!e||!t)return;const n=Q(),r=t.trim();return(n[e]||[]).find(s=>s.code===r)}function ft(e,t){return!!Ne(e,t)}function xe(e,t,n){const r=Ne(e,t);return r&&r.price===n?(Be(e,t),!1):(pt(e,t,n),!0)}function ht(){localStorage.removeItem(Ae),console.log("All favorites have been cleared.")}function O(){var n,r,a,s,o,l;const e=Q(),t={app_version:st,customer_name:((n=document.querySelector('[name="customer_name"]'))==null?void 0:n.value)||"",customer_phone:((r=document.querySelector('[name="customer_phone"]'))==null?void 0:r.value)||"",customer_address:((a=document.querySelector('[name="customer_address"]'))==null?void 0:a.value)||"",customer_card_open:(s=document.querySelector("#customerDetailsCard"))==null?void 0:s.open,discount:{type:((o=document.querySelector("#discount_type"))==null?void 0:o.value)||"amount",value:v((l=document.querySelector("#discount_value"))==null?void 0:l.value)},rooms:[],favorites:e};return document.querySelectorAll(y.room).forEach(u=>{var d,p;const c={id:u.id,room_name:((d=u.querySelector(y.roomNameInput))==null?void 0:d.value)||"",is_suspended:u.classList.contains("is-suspended"),is_open:u.open,items:[]};(p=u.querySelector(y.allItemsContainer))==null||p.childNodes.forEach(m=>{var i,f,b,S,x,$,_,T,F,I,A,L,B,C,U,R,J,z,re,H,pe,Oe,He,We;if(m.nodeType!==1||!m.matches(".item-card"))return;const h=m.dataset.type;if(!h)return;let g={type:h,is_suspended:m.classList.contains("is-suspended")};h==="set"?Object.assign(g,{width_m:v((i=m.querySelector('input[name="width_m"]'))==null?void 0:i.value),height_m:v((f=m.querySelector('input[name="height_m"]'))==null?void 0:f.value),style:((b=m.querySelector('select[name="set_style"]'))==null?void 0:b.value)||"",fabric_variant:((S=m.querySelector('select[name="fabric_variant"]'))==null?void 0:S.value)||"",price_per_m_raw:v((x=m.querySelector('select[name="set_price_per_m"]'))==null?void 0:x.value),sheer_price_per_m:v(($=m.querySelector('select[name="sheer_price_per_m"]'))==null?void 0:$.value),fabric_code:((_=m.querySelector('input[name="fabric_code"]'))==null?void 0:_.value)||"",sheer_fabric_code:((T=m.querySelector('input[name="sheer_fabric_code"]'))==null?void 0:T.value)||"",opening_style:((F=m.querySelector('select[name="opening_style"]'))==null?void 0:F.value)||"",track_color:((I=m.querySelector('input[name="track_color"]'))==null?void 0:I.value)||"ขาว",bracket_color:((A=m.querySelector('input[name="bracket_color"]'))==null?void 0:A.value)||"ขาว",finial_color:((L=m.querySelector('input[name="finial_color"]'))==null?void 0:L.value)||"ขาว",grommet_color:((B=m.querySelector('input[name="grommet_color"]'))==null?void 0:B.value)||"เงิน",notes:((C=m.querySelector('input[name="notes"]'))==null?void 0:C.value)||""}):h==="wallpaper"?Object.assign(g,{height_m:v((U=m.querySelector('[name="wallpaper_height_m"]'))==null?void 0:U.value),wallpaper_code:((R=m.querySelector('[name="wallpaper_code"]'))==null?void 0:R.value)||"",price_per_roll:v((J=m.querySelector('[name="wallpaper_price_roll"]'))==null?void 0:J.value),install_cost_per_roll:v((z=m.querySelector('[name="wallpaper_install_cost"]'))==null?void 0:z.value),notes:((re=m.querySelector('[name="wallpaper_notes"]'))==null?void 0:re.value)||"",widths:Array.from(m.querySelectorAll('[name="wall_width_m"]')).map(at=>v(at.value))}):m.matches(".area-based-item")&&Object.assign(g,{width_m:v((H=m.querySelector('[name="area_width_m"]'))==null?void 0:H.value),height_m:v((pe=m.querySelector('[name="area_height_m"]'))==null?void 0:pe.value),price_sqyd:v((Oe=m.querySelector('[name="area_price_sqyd"]'))==null?void 0:Oe.value),code:((He=m.querySelector('[name="area_code"]'))==null?void 0:He.value)||"",notes:((We=m.querySelector('[name="area_notes"]'))==null?void 0:We.value)||""}),c.items.push(g)}),t.rooms.push(c)}),t}function E(){try{localStorage.setItem(ve,JSON.stringify(O()))}catch(e){console.error("Failed to save data to localStorage:",e)}}const M={stylePlus:e=>_e.style_surcharge[e]??0,heightPlus:e=>{const t=[..._e.height].sort((n,r)=>r.threshold-n.threshold);for(const n of t)if(e>n.threshold)return n.add_per_m;return 0},fabricYardage:(e,t)=>{const n=v(t);return n<=0||!e?0:e==="ตาไก่"||e==="จีบ"?(n*2+.6)/.9:e==="ลอน"?(n*2.6+.6)/.9:0},calculateGrommets:function(e){if(!e||e.style!=="ตาไก่"||v(e.width_m)<=0)return 0;const t=v(e.width_m),n=2,r=.05,a=.16;let s;e.opening_style==="แยกกลาง"?s=t/2:s=t;const o=s*n+2*r;let l=Math.round(o/a);return l%2!==0&&(l+=1),l<4&&(l=4),e.opening_style==="แยกกลาง"?l*2:l},wallpaperRolls:(e,t)=>{const n=v(e),r=v(t);if(n<=0||r<=0)return 0;const a=r>2.5?Math.floor($e.ROLL_LENGTH_M/r):$e.STRIPS_PER_ROLL_UNDER_2_5M;if(a<=0)return 0;const s=Math.ceil(n/$e.ROLL_WIDTH_M);return Math.ceil(s/a)},calculateSetPrice:function(e){var o,l;if(!e||e.is_suspended||v(e.width_m)<=0)return{total:0,opaque:0,sheer:0};const t=this.stylePlus(e.style),n=this.heightPlus(v(e.height_m)),r=v(e.width_m),a=(o=e.fabric_variant)!=null&&o.includes("ทึบ")&&v(e.price_per_m_raw)>0?(v(e.price_per_m_raw)+t+n)*r:0,s=(l=e.fabric_variant)!=null&&l.includes("โปร่ง")&&v(e.sheer_price_per_m)>0?(v(e.sheer_price_per_m)+t+n)*r:0;return{total:Math.round(a+s),opaque:Math.round(a),sheer:Math.round(s)}},calculateDecoPrice:function(e){if(!e||e.is_suspended||v(e.width_m)<=0||v(e.height_m)<=0)return{total:0,sqm:0,sqyd:0};const t=v(e.width_m)*v(e.height_m),n=t*it,r=n*v(e.price_sqyd);return{total:Math.round(r),sqm:t,sqyd:n}},calculateWallpaperPrice:function(e){var o;if(!e||e.is_suspended)return{total:0,material:0,install:0,rolls:0,sqm:0};const t=((o=e.widths)==null?void 0:o.reduce((l,u)=>l+v(u),0))||0;if(t<=0)return{total:0,material:0,install:0,rolls:0,sqm:0};const n=v(e.height_m),r=this.wallpaperRolls(t,n),a=r*v(e.price_per_roll),s=r*v(e.install_cost_per_roll??300);return{total:Math.round(a+s),material:Math.round(a),install:Math.round(s),rolls:r,sqm:t*n}}},ee={set:"ผ้าม่าน",wallpaper:"วอลล์เปเปอร์",wooden_blind:"มู่ลี่ไม้",roller_blind:"ม่านม้วน",vertical_blind:"ม่านปรับแสง",partition:"ฉากกั้นห้อง",pleated_screen:"มุ้งจีบ",aluminum_blind:"มู่ลี่อลูมิเนียม"};function ne(e){const{width:t=0,height:n=0}=e,r=15,a=100-r*2,s=100-r*2,o=t>0&&n>0?Math.min(a/t,s/n):1,l=t*o,u=n*o,c=(100-l)/2,d=(100-u)/2,p=`
        <line x1="${c}" y1="${d+u+5}" x2="${c+l}" y2="${d+u+5}" class="dimension-line" />
        <line x1="${c}" y1="${d+u+3}" x2="${c}" y2="${d+u+7}" class="dimension-tick" />
        <line x1="${c+l}" y1="${d+u+3}" x2="${c+l}" y2="${d+u+7}" class="dimension-tick" />
        <text x="50" y="${d+u+14}" class="dimension-text">${t.toFixed(2)} ม.</text>

        <line x1="${c-5}" y1="${d}" x2="${c-5}" y2="${d+u}" class="dimension-line" />
        <line x1="${c-7}" y1="${d}" x2="${c-3}" y2="${d}" class="dimension-tick" />
        <line x1="${c-7}" y1="${d+u}" x2="${c-3}" y2="${d+u}" class="dimension-tick" />
        <text x="${c-9}" y="50" class="dimension-text" transform="rotate(-90, ${c-9}, 50)">${n.toFixed(2)} ม.</text>
    `;return{x:c,y:d,svgWidth:l,svgHeight:u,lines:p}}function vt(e){const t=v(e.width_m),n=v(e.height_m);if(t<=0||n<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:r,y:a,svgWidth:s,svgHeight:o,lines:l}=ne({width:t,height:n});let u="";const c=e.fabric_variant.includes("โปร่ง"),d=e.fabric_variant.includes("ทึบ"),p=(i,f)=>e.opening_style==="แยกกลาง"?`
                <rect x="${r}" y="${a+f}" width="${s/2-1}" height="${o}" class="${i}" />
                <rect x="${r+s/2+1}" y="${a+f}" width="${s/2-1}" height="${o}" class="${i}" />
            `:`<rect x="${r}" y="${a+f}" width="${s}" height="${o}" class="${i}" />`;c&&(u+=p("curtain-panel-sheer",0)),d&&(u+=p("curtain-panel-opaque",c?-2:0));let m="";if(e.style==="ตาไก่"){const i=Math.max(8,Math.floor(s/8));for(let f=0;f<i;f++){const b=r+s/(i-1)*f;m+=`<circle cx="${b}" cy="${a}" r="2" class="style-grommet" />`}}else if(e.style==="ลอน"){const i=Math.max(4,Math.floor(s/10));let f=`M ${r},${a}`;for(let b=0;b<i;b++)f+=" q 5,-4 10,0";m=`<path d="${f}" class="style-ripplefold-path" />`}else e.style==="จีบ"&&(m=`<text x="${r+2}" y="${a+5}" class="style-pleat-text">||| ||| ||| ||| |||</text>`);const h=e.opening_style==="แยกกลาง"?"แยกกลาง":t>n?"→":"↓",g=`<text x="50" y="${a+o/2}" class="opening-text">${h}</text>`;return`<svg viewBox="0 0 100 100">${u}${m}${g}${l}</svg>`}function je(e,t=!1){const n=v(e.width_m),r=v(e.height_m);if(n<=0||r<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:a,y:s,svgWidth:o,svgHeight:l,lines:u}=ne({width:n,height:r});let c=`<rect x="${a}" y="${s}" width="${o}" height="${l}" class="blind-frame" />`;if(t){const d=Math.max(4,Math.floor(o/8)),p=o/d;for(let m=0;m<d;m++)c+=`<rect x="${a+m*p+1}" y="${s}" width="${p-2}" height="${l}" class="blind-slat" />`}else{const d=Math.max(3,Math.floor(l/10)),p=l/d;for(let m=0;m<d;m++)c+=`<rect x="${a}" y="${s+m*p+.5}" width="${o}" height="${p-1}" class="blind-slat" />`}return`<svg viewBox="0 0 100 100">${c}${u}</svg>`}function yt(e){const t=v(e.width_m),n=v(e.height_m);if(t<=0||n<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:r,y:a,svgWidth:s,svgHeight:o,lines:l}=ne({width:t,height:n});let u=`<rect x="${r}" y="${a}" width="${s}" height="${o}" class="blind-frame" />`;const c=Math.max(3,Math.floor(o/8)),d=o/c;for(let i=0;i<c;i++)u+=`<rect x="${r+1}" y="${a+i*d}" width="${s-2}" height="${d-1.5}" rx="0.5" class="wooden-blind-slat" />`;const p=Math.max(2,s*.05),m=r+s*.25-p/2,h=r+s*.75-p/2,g=`
        <rect x="${m}" y="${a}" width="${p}" height="${o}" class="wooden-blind-strip" />
        <rect x="${h}" y="${a}" width="${p}" height="${o}" class="wooden-blind-strip" />
    `;return`<svg viewBox="0 0 100 100">${u}${g}${l}</svg>`}function gt(e){const t=v(e.width_m),n=v(e.height_m);if(t<=0||n<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:r,y:a,svgWidth:s,svgHeight:o,lines:l}=ne({width:t,height:n});return`<svg viewBox="0 0 100 100">${`
        <rect x="${r}" y="${a}" width="${s}" height="${o}" class="roller-fabric" />
        <rect x="${r-1}" y="${a-4}" width="${s+2}" height="5" rx="2" class="roller-roll" />
        <line x1="${r}" y1="${a+o}" x2="${r+s}" y2="${a+o}" class="roller-bar" />
    `}${l}</svg>`}function Ue(e,t=!1){const n=v(e.width_m),r=v(e.height_m);if(n<=0||r<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:a,y:s,svgWidth:o,svgHeight:l,lines:u}=ne({width:n,height:r});let c="";if(t)c=`
            <defs>
                <pattern id="pleated-mesh" width="6" height="6" patternUnits="userSpaceOnUse">
                    <path d="M -1 1 L 1 -1 M 0 6 L 6 0" class="pleated-screen-mesh" />
                </pattern>
            </defs>
            <rect x="${a}" y="${s}" width="${o}" height="${l}" class="blind-frame" />
            <rect x="${a}" y="${s}" width="${o}" height="${l}" fill="url(#pleated-mesh)" />
        `;else{const p=o/4;for(let m=0;m<4;m++)c+=`<rect x="${a+m*p}" y="${s}" width="${p}" height="${l}" class="partition-panel" />`,m>0&&(c+=`<line x1="${a+m*p}" y1="${s}" x2="${a+m*p}" y2="${s+l}" class="partition-hinge" />`)}return`<svg viewBox="0 0 100 100">${c}${u}</svg>`}function _t(e){const t=(e.widths||[]).reduce((m,h)=>m+v(h),0),n=v(e.height_m);if(t<=0||n<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:r,y:a,svgWidth:s,svgHeight:o,lines:l}=ne({width:t,height:n});let u="";const c=Math.floor(s/10),d=Math.floor(o/10);for(let m=0;m<d;m++)for(let h=0;h<c;h++)u+=`<circle cx="${r+h*10+5}" cy="${a+m*10+5}" r="1.5" class="wallpaper-pattern" />`;return`<svg viewBox="0 0 100 100">${`<rect x="${r}" y="${a}" width="${s}" height="${o}" class="blind-frame" /> ${u}`}${l}</svg>`}function bt(e){switch(e.type){case"set":return vt(e);case"wooden_blind":return yt(e);case"aluminum_blind":return je(e,!1);case"vertical_blind":return je(e,!0);case"roller_blind":return gt(e);case"partition":return Ue(e,!1);case"pleated_screen":return Ue(e,!0);case"wallpaper":return _t(e);default:const t=ee[e.type]||"ของตกแต่ง";return`<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">${q(t)}</text></svg>`}}function Ve(e){let t=`
📃 *สรุปรายการสินค้า*
`,n=!1;return e.rooms.forEach(r=>{if(r.is_suspended||!r.items)return;const a=r.items.filter(o=>o.is_suspended?!1:o.type==="wallpaper"?(o.widths||[]).reduce((l,u)=>l+v(u),0)>0:v(o.width_m)>0);if(a.length===0)return;n=!0,t+=`
*🚪 ห้อง: ${r.room_name||"ไม่ระบุ"}*
`;let s=0;a.forEach(o=>{s++;const l=ee[o.type]||"สินค้าตกแต่ง";o.type==="set"?t+=` ${s}) ${l} ${o.style} (${o.fabric_variant})
`:t+=` ${s}) ${l}
`})}),n?t+`------------------------------
`:""}function ze(e){return e.rooms.reduce((t,n)=>{var a;if(n.is_suspended)return t;const r=((a=n.items)==null?void 0:a.reduce((s,o)=>{if(o.is_suspended)return s;switch(o.type){case"set":return s+M.calculateSetPrice(o).total;case"wallpaper":return s+M.calculateWallpaperPrice(o).total;default:return s+M.calculateDecoPrice(o).total}},0))||0;return t+r},0)}function St(e,t){const n=ze(e);let r=0,a="";e.discount&&e.discount.value>0&&(e.discount.type==="percent"?(r=n*(e.discount.value/100),a=`🏷️ ส่วนลด (${e.discount.value}%): -${k(r)} บาท
`):(r=e.discount.value,a=`🏷️ ส่วนลด: -${k(r)} บาท
`));const s=n-r;let o=`🗓️ สรุปข้อมูล (${new Date().toLocaleDateString("th-TH",{day:"numeric",month:"short",year:"2-digit"})})
`;if(o+=`👤 ลูกค้า: ${e.customer_name||"-"}
`,(t==="customer"||t==="owner")&&(o+=`📞 โทร: ${e.customer_phone||"-"}
`,o+=`🏠 ที่อยู่: ${e.customer_address||"-"}
`),o+=`------------------------------
`,t==="customer")return o+=Ve(e),r>0&&(o+=`
ยอดรวม: ${k(n)} บาท
`,o+=a),o+=`
💰 *ยอดสุทธิ: ${k(s)} บาท*
`,o+=`
ขอบคุณที่ใช้บริการค่ะ
${N.name}
โทร: ${N.phone}`,o;if(t==="purchase_order"||t==="owner"){t==="owner"&&(o+=Ve(e));const l={opaqueFabrics:[],sheerFabrics:[],decorations:{},wallpapers:[],allSets:[]};e.rooms.forEach(i=>{i.is_suspended||!i.items||i.items.forEach(f=>{const b=f.type==="set"||f.type.includes("_blind")||f.type==="partition"||f.type==="pleated_screen";if(!(f.is_suspended||b&&v(f.width_m)<=0))switch(f.type){case"set":l.allSets.push(f),f.fabric_variant.includes("ทึบ")&&l.opaqueFabrics.push({code:f.fabric_code||"??",yards:M.fabricYardage(f.style,f.width_m)}),f.fabric_variant.includes("โปร่ง")&&l.sheerFabrics.push({code:f.sheer_fabric_code||"??",yards:M.fabricYardage(f.style,f.width_m)});break;case"wallpaper":const S=(f.widths||[]).reduce(($,_)=>$+v(_),0);if(S>0){const $=M.wallpaperRolls(S,f.height_m);$>0&&l.wallpapers.push({code:f.wallpaper_code||"xxx",rolls:$})}break;default:const x=ee[f.type]||f.type;l.decorations[x]||(l.decorations[x]=[]),l.decorations[x].push({code:f.code||"xxx",width:f.width_m,height:f.height_m});break}})});const u={};if([...l.opaqueFabrics,...l.sheerFabrics].forEach(i=>{u[i.code]=(u[i.code]||0)+i.yards}),Object.keys(u).length>0){o+=`✂️ *รายการสั่งซื้อ (ผ้า)*
`,o+=`------------------------------
`,l.opaqueFabrics.length>0&&l.opaqueFabrics.forEach(i=>{o+=`- ผ้าทึบ (Curtain)
`,o+=`  รหัส: #${i.code||"??"}
`,o+=`  จำนวน: ${i.yards.toFixed(2)} หลา

`}),l.sheerFabrics.length>0&&l.sheerFabrics.forEach(i=>{o+=`- ผ้าโปร่ง (Sheer)
`,o+=`  รหัส: #${i.code||"??"}
`,o+=`  จำนวน: ${i.yards.toFixed(2)} หลา

`}),o+=`------------------------------
`,o+=`📊 *สรุปยอดรวมผ้า (ตามรหัส)*
`,o+=`------------------------------
`;for(const[i,f]of Object.entries(u))o+=`  - รหัส #${i}: ${f.toFixed(2)} หลา
`;o+=`
`}const c=l.allSets.filter(i=>i.style==="ตาไก่"),d=l.allSets.filter(i=>i.style!=="ตาไก่");if(d.length>0){o+=`------------------------------
`,o+=`📏 *รายการสั่งซื้อ ราง (ลอน/จีบ)*
`,o+=`------------------------------

`;let i=1;d.forEach(f=>{o+=`(${i++}) ราง ${f.style}, สี: ${f.track_color}
`,f.fabric_variant.includes("ทึบ")&&(o+=`  - รางทึบ: ${Number(f.width_m).toFixed(2)} ม.
`),f.fabric_variant.includes("โปร่ง")&&(o+=`  - รางโปร่ง: ${Number(f.width_m).toFixed(2)} ม.
`),f.fabric_variant==="ทึบ&โปร่ง"?o+=`  - ขาจับ: ขา2ชั้น
`:o+=`  - ขาจับ: ขาชั้นเดียว
`,f.notes&&t==="owner"&&(o+=`  📝 หมายเหตุ: ${f.notes}
`),o+=`
`})}if(c.length>0){o+=`------------------------------
`,o+=`📏 *รายการสั่งซื้อ ราง (ตาไก่)*
`,o+=`------------------------------

`;let i=1;c.forEach(_=>{o+=`(${i++}) ราง ${_.style}, สี: ${_.track_color}
`,_.fabric_variant.includes("ทึบ")&&(o+=`  - รางทึบ: ${Number(_.width_m).toFixed(2)} ม.
`),_.fabric_variant.includes("โปร่ง")&&(o+=`  - รางโปร่ง: ${Number(_.width_m).toFixed(2)} ม.
`),_.fabric_variant==="ทึบ&โปร่ง"?o+=`  - ขาจับ: ขา2ชั้น
`:o+=`  - ขาจับ: ขาชั้นเดียว
`,_.notes&&t==="owner"&&(o+=`  📝 หมายเหตุ: ${_.notes}
`),o+=`
`}),o+=`--- สรุปยอดรวมรางตาไก่ ---
`;const f=[];c.forEach(_=>{_.fabric_variant.includes("ทึบ")&&f.push(Number(_.width_m)),_.fabric_variant.includes("โปร่ง")&&f.push(Number(_.width_m))});const b=6;f.sort((_,T)=>T-_);const S=[];for(const _ of f){let T=!1;for(let F=0;F<S.length;F++)if(S[F]>=_-.001){S[F]-=_,T=!0;break}T||S.push(b-_)}o+=`ต้องใช้รางเต็ม (6 ม.) ทั้งหมด: *${S.length} เส้น*

`;const x=f.reduce((_,T)=>{const F=T.toFixed(2);return _[F]=(_[F]||0)+1,_},{}),$=Object.entries(x).sort((_,T)=>parseFloat(T[0])-parseFloat(_[0]));if($.length>0){o+=`*สรุปจำนวนรางที่ต้องตัด:*
`;for(const[_,T]of $)o+=`  - ขนาด ${_} ม. = ${T} เส้น
`;o+=`
`}}const p={};c.forEach(i=>{const f=i.track_color||"ไม่ระบุ",b=i.grommet_color||"เงิน",S=`${f}|${b}`;p[S]||(p[S]={trackColor:f,grommetColor:b,grommets:0,brackets:0,finials:0}),p[S].grommets+=M.calculateGrommets(i),p[S].brackets+=v(i.width_m)>=1.6?3:2,p[S].finials+=i.fabric_variant==="ทึบ&โปร่ง"?4:2});const m=l.allSets.length*2;(Object.keys(p).length>0||m>0)&&(o+=`------------------------------
`,o+=`🔩 *รายการสั่งซื้อ อุปกรณ์ (Hardware)*
`,o+=`------------------------------

`,Object.values(p).forEach(i=>{i.grommets>0&&(o+=`  - ตาไก่ (สี${i.grommetColor}): ${i.grommets} ตัว
`),i.brackets>0&&(o+=`  - ขาจับ (สี${i.trackColor}): ${i.brackets} ตัว
`),i.finials>0&&(o+=`  - หัวราง (สี${i.trackColor}): ${i.finials} ตัว
`)}),m>0&&(o+=`  - ตะขอรวบม่าน: ${m} ตัว
`),o+=`
`);const h=l.decorations;Object.keys(h).length>0&&Object.entries(h).forEach(([i,f])=>{o+=`------------------------------
`,o+=`📦 *รายการสั่งซื้อ ${i}*
`,o+=`------------------------------

`,f.forEach(b=>{o+=`- รหัส: #${b.code||"xxx"}
  ขนาด: ${b.width.toFixed(2)} x ${b.height.toFixed(2)} m.

`})});const g={};if(l.wallpapers.forEach(i=>{g[i.code]=(g[i.code]||0)+i.rolls}),Object.keys(g).length>0){o+=`------------------------------
`,o+=`🎨 *รายการสั่งซื้อ (Wallpaper)*
`,o+=`------------------------------

`;for(const[i,f]of Object.entries(g))o+=`  - รหัส #${i}: ${f} ม้วน
`;o+=`
`}if(t==="purchase_order")return o+=`------------------------------
`,o}if(t==="seamstress"||t==="owner"){o+=`
🧵 *รายละเอียดสำหรับช่างเย็บผ้า*
`;let l=0;if(e.rooms.forEach(u=>{if(u.is_suspended||!u.items)return;const c=u.items.filter(d=>d.type==="set"&&!d.is_suspended&&v(d.width_m)>0);c.length!==0&&(l>0&&(o+=`==============================
`),o+=`
*🚪 ห้อง: ${u.room_name||"ไม่ระบุ"}*

`,c.forEach((d,p)=>{p>0&&(o+=`--------------------
`),o+=`*ชุดที่ ${p+1}/${c.length}: ${d.style} ${d.fabric_variant}*
`,o+=`  - ขนาด: กว้าง ${Number(d.width_m).toFixed(2)} x สูง ${Number(d.height_m).toFixed(2)} ม.
`,o+=`  - รูปแบบเปิด: ${d.opening_style}
`,d.fabric_variant.includes("ทึบ")&&(o+=`  - ผ้าทึบ: #${d.fabric_code||"-"}
`),d.fabric_variant.includes("โปร่ง")&&(o+=`  - ผ้าโปร่ง: #${d.sheer_fabric_code||"-"}
`)}),o+=`
`,l++)}),l>0?o+=`==============================
`:o+=`ไม่มีรายการสำหรับช่าง
------------------------------
`,t==="seamstress")return o}return t==="owner"&&(o+=`
💰 *สรุปยอดรวม: ${k(s)} บาท*
`),o}function wt(e){if(!e.rooms||e.rooms.length===0)return'<p class="empty-summary">ไม่มีข้อมูลสำหรับแสดงผล</p>';let t="";const n={};e.rooms.forEach(o=>{o.is_suspended||!o.items||o.items.forEach(l=>{if(l.is_suspended)return;let u=null,c=0;switch(l.type){case"set":c=M.calculateSetPrice(l).total,c>0&&(u=l.type);break;case"wallpaper":c=M.calculateWallpaperPrice(l).total,c>0&&(u=l.type);break;default:c=M.calculateDecoPrice(l).total,c>0&&(u=l.type);break}u&&(n[u]=(n[u]||0)+1)})});const r=Object.entries(n).map(([o,l])=>{const u=ee[o]||"ของตกแต่ง";return`
            <span class="summary-tag" data-filter-type="${q(o)}" title="คลิกเพื่อกรองเฉพาะรายการนี้">
                ${q(u)} <strong>${l}</strong>
            </span>`}).join("");r&&(t+=`
            <div class="overview-summary-group">
                <h4><i class="ph ph-stack"></i> สรุปประเภทรายการ</h4>
                <div class="summary-tags-container">
                    ${r}
                </div>
            </div>`);let a="",s=0;return e.rooms.forEach(o=>{if(o.is_suspended||!o.items)return;const l={};let u=0;if(o.items.forEach(c=>{if(c.is_suspended)return;let d=null,p=0;switch(c.type){case"set":p=M.calculateSetPrice(c).total,p>0&&(d=c.type);break;case"wallpaper":p=M.calculateWallpaperPrice(c).total,p>0&&(d=c.type);break;default:p=M.calculateDecoPrice(c).total,p>0&&(d=c.type);break}d&&(l[d]=(l[d]||0)+1,u++)}),u>0){s+=u;const c=Object.entries(l).map(([d,p])=>`
                    <div class="overview-item">
                        <span>${q(ee[d]||"ของตกแต่ง")}</span>
                        <span>${p}</span>
                    </div>`).join("");a+=`
                <details class="overview-room-card">
                    <summary class="overview-room-summary">
                        <span class="room-name">${q(o.room_name)||"ไม่ระบุชื่อห้อง"}</span>
                        <div class="summary-tags">
                            <span class="room-item-count">${u} รายการ</span>
                            <i class="ph ph-caret-down expand-icon"></i>
                        </div>
                    </summary>
                    <div class="overview-room-items">${c}</div>
                </details>`}}),a&&(t+=`
            <div class="overview-breakdown-group">
                <h4><i class="ph ph-map-pin-line"></i> แจกแจงตามห้อง</h4>
                ${a}
            </div>`),s===0?'<p class="empty-summary">ไม่มีข้อมูลสำหรับแสดงผล</p>':t}function qt(e,t){const{vatRate:n,pageBreakBuffer:r=3}=t,a=[];e.rooms.forEach(I=>{if(I.is_suspended||!I.items)return;const A=[];I.items.forEach(L=>{if(L.is_suspended)return;let B,C,U,R;const J=ee[L.type]||"สินค้าตกแต่ง";switch(L.type){case"set":C=M.calculateSetPrice(L).total,C>0&&(U=v(L.width_m),R=v(L.height_m),B=`${J} ${q(L.style)} (${q(L.fabric_variant)}) <br><small>ขนาด ${U.toFixed(2)} x ${R.toFixed(2)} ม.${L.notes?` - ${q(L.notes)}`:""}</small>`,A.push({description:B,total:C,units:B.includes("<br>")?1.5:1}));break;case"wallpaper":if(C=M.calculateWallpaperPrice(L).total,C>0){const z=(L.widths||[]).reduce((H,pe)=>H+v(pe),0),re=M.wallpaperRolls(z,L.height_m);R=v(L.height_m),B=`${J} <br><small>รหัส: ${q(L.wallpaper_code)||"-"}, สูง ${R.toFixed(2)} ม. (ใช้ ${re} ม้วน)</small>`,A.push({description:B,total:C,units:B.includes("<br>")?1.5:1})}break;default:C=M.calculateDecoPrice(L).total,C>0&&(U=v(L.width_m),R=v(L.height_m),B=`${J} <br><small>รหัส: ${q(L.code)||"-"}, ขนาด ${U.toFixed(2)} x ${R.toFixed(2)} ม.</small>`,A.push({description:B,total:C,units:B.includes("<br>")?1.5:1}));break}}),A.length>0&&(a.push({isRoomHeader:!0,roomName:q(I.room_name)||"ไม่ระบุชื่อห้อง",units:1.2}),a.push(...A))});const s=a.reduce((I,A)=>I+(A.total||0),0);if(s===0)return null;let o=0,l="",u=s;e.discount&&e.discount.value>0&&(e.discount.type==="percent"?(o=s*(e.discount.value/100),l=`<tr><td class="pdf-label">ส่วนลด (${e.discount.value}%)</td><td class="pdf-amount">-${W(o,2,!0)}</td></tr>`):(o=e.discount.value,l=`<tr><td class="pdf-label">ส่วนลด</td><td class="pdf-amount">-${W(o,2,!0)}</td></tr>`),u=s-o,l+=`<tr><td class="pdf-label">ยอดหลังหักส่วนลด</td><td class="pdf-amount">${W(u,2,!0)}</td></tr>`);const c=u*n,d=u+c,p=17,m=23,h=[];let g=[],i=0;a.forEach((I,A)=>{const L=h.length===0?p:m,B=i+I.units>L;let C=!1;if(!B&&A<a.length-1){const U=L-(i+I.units);U>0&&U<r&&(C=!0)}(B||C)&&g.length>0&&(h.push(g),g=[],i=0),g.push(I),i+=I.units}),g.length>0&&h.push(g);const f=new Date,b=f.toLocaleDateString("th-TH",{year:"numeric",month:"long",day:"numeric"}),S=`QT-${f.getFullYear()}${(f.getMonth()+1).toString().padStart(2,"0")}${f.getDate().toString().padStart(2,"0")}`;let x="",$=0,_=1;h.forEach((I,A)=>{const L=A===0,B=A===h.length-1,C=`
            <div class="pdf-page-header">
                <div class="pdf-header">
                    <div class="pdf-shop-info">
                        ${`<img src="${N.logoUrl}" alt="Logo" class="pdf-logo">`}
                        <div class="pdf-shop-address">
                            <strong><i class="ph ph-github-logo"></i> ${q(N.name)}</strong><br>
                            ${q(N.address).replace(/\n/g,"<br>")}<br>
                            โทร: ${q(N.phone)} | เลขประจำตัวผู้เสียภาษี: ${q(N.taxId)}
                        </div>
                    </div>
                    <div class="pdf-quote-details">
                        <div class="pdf-title-box"><h1>ใบเสนอราคา ${h.length>1?L?"":"(ต่อ)":""}</h1></div>
                        <table class="pdf-quote-meta">
                            <tr><td>เลขที่:</td><td>${S}</td></tr>
                            <tr><td>วันที่:</td><td>${b}</td></tr>
                        </table>
                    </div>
                </div>
                ${L?`
                <section class="pdf-customer-details">
                    <div class="pdf-customer-info">
                        <strong>ลูกค้า:</strong> ${q(e.customer_name)||""}<br>
                        <strong>ที่อยู่:</strong> ${q(e.customer_address).replace(/\n/g,"<br>")||""}<br>
                        <strong>โทร:</strong> ${q(e.customer_phone)||""}
                    </div>
                    <div class="pdf-customer-meta">
                        <strong>เงื่อนไขชำระเงิน:</strong> ${q(N.pdf.paymentTerms)}<br>
                        <strong>ยืนราคา:</strong> ${q(N.pdf.priceValidity)}
                    </div>
                </section>`:""}
            </div>`,U=`
            <div class="pdf-page-footer">
                <div class="pdf-footer-info">
                    <span><i class="ph ph-github-logo"></i> ${q(N.name)} | โทร: ${q(N.phone)}</span>
                    <span>หน้า ${A+1} / ${h.length}</span>
                </div>
            </div>`;let R="";L||(R+=`<tr class="pdf-subtotal-row"><td colspan="4">ยอดยกมา (Brought Forward)</td><td class="pdf-text-right">${W($,2,!0)}</td></tr>`),I.forEach(H=>{H.isRoomHeader?R+=`<tr class="pdf-room-header"><td colspan="5">ห้อง: ${H.roomName}</td></tr>`:(R+=`<tr><td class="pdf-text-center">${_++}</td><td>${H.description}</td><td class="pdf-text-center">1</td><td class="pdf-text-right">${W(H.total,2,!0)}</td><td class="pdf-text-right">${W(H.total,2,!0)}</td></tr>`,$+=H.total)});let J="";B||(J=`<tfoot><tr class="pdf-subtotal-row"><td colspan="4">ยอดยกไป (Carried Forward)</td><td class="pdf-text-right">${W($,2,!0)}</td></tr></tfoot>`);let z="";N.pdf.notes&&N.pdf.notes.length>0&&(z=`
                <strong>หมายเหตุ:</strong>
                <ul>${N.pdf.notes.map(H=>`<li>${q(H)}</li>`).join("")}</ul>
            `);const re=B?`
            <div class="pdf-summary-wrapper">
                <section class="pdf-summary-section">
                    <div class="pdf-amount-in-words">
                        ${z}
                        <div class="pdf-amount-text">( ${mt(d)} )</div>
                    </div>
                    <div class="pdf-totals-block">
                        <table>
                            <tr><td class="pdf-label">รวมเป็นเงิน</td><td class="pdf-amount">${W(s,2,!0)}</td></tr>
                            ${l}
                            ${n>0?`<tr><td class="pdf-label">ภาษีมูลค่าเพิ่ม ${(n*100).toFixed(0)}%</td><td class="pdf-amount">${W(c,2,!0)}</td></tr>`:""}
                            <tr class="pdf-grand-total"><td class="pdf-label">ยอดรวมสุทธิ</td><td class="pdf-amount">${W(d,2,!0)}</td></tr>
                        </table>
                    </div>
                </section>
                <footer class="pdf-footer-section">
                    <div class="pdf-signature-box"><p>.................................................</p><p>ผู้เสนอราคา</p><p>(<i class="ph ph-github-logo"></i> ${q(N.name)})</p><p>วันที่: ${b}</p></div>
                    <div class="pdf-signature-box"><p>.................................................</p><p>ลูกค้า / ผู้มีอำนาจลงนาม</p><p>&nbsp;</p><p>วันที่: ......./......./............</p></div>
                </footer>
            </div>
        `:"";x+=`
            <div class="pdf-page">
                <div class="pdf-page-content">
                    ${C}
                    <div class="pdf-page-body">
                        <table class="pdf-items-table">
                            <thead><tr><th style="width:5%;">ลำดับ</th><th style="width:50%;">รายการ</th><th style="width:10%;">จำนวน</th><th style="width:17.5%;">ราคา/หน่วย</th><th style="width:17.5%;">รวม (บาท)</th></tr></thead>
                            <tbody>${R}</tbody>
                            ${J}
                        </table>
                        ${re}
                    </div>
                    ${U}
                </div>
            </div>`});const T=e.customer_name||"quote",F=Qe(T);return{html:`<div id="quotation-template">${x}</div>`,fileName:`${S}_${F}`}}function $t(e){var l;const t=ze(e);let n=0;((l=e.discount)==null?void 0:l.value)>0&&(n=e.discount.type==="percent"?t*(e.discount.value/100):e.discount.value);const r=t-n;let a=!1,s=e.rooms.map(u=>{if(u.is_suspended)return"";const c=u.items.filter(p=>!p.is_suspended&&(v(p.width_m)>0||p.type==="wallpaper"&&(p.widths||[]).reduce((m,h)=>m+v(h),0)>0));if(c.length===0)return"";const d=c.map(p=>{let m="",h="";if(p.type!=="set"){const g=ee[p.type]||"ของตกแต่ง";h=`<h5 class="lookbook-item-title">${q(g)}</h5>`}switch(p.type){case"set":m=`
                        <tr><td>แบบ</td><td>${q(p.style)} (${q(p.fabric_variant)})</td></tr>
                        ${p.fabric_variant.includes("ทึบ")?`<tr><td>ทึบ</td><td>#${q(p.fabric_code)||"-"}</td></tr>`:""}
                        ${p.fabric_variant.includes("โปร่ง")?`<tr><td>โปร่ง</td><td>#${q(p.sheer_fabric_code)||"-"}</td></tr>`:""}
                        <tr><td>ขนาด</td><td>${v(p.width_m).toFixed(2)} x ${v(p.height_m).toFixed(2)} ม.</td></tr>
                    `;break;case"wallpaper":const g=(p.widths||[]).reduce((f,b)=>f+v(b),0),i=M.wallpaperRolls(g,p.height_m);m=`
                        <tr><td>รหัส</td><td>#${q(p.wallpaper_code)||"-"}</td></tr>
                        <tr><td>จำนวน</td><td>${i} ม้วน</td></tr>
                        <tr><td>กว้างรวม</td><td>${g.toFixed(2)} ม.</td></tr>
                        <tr><td>สูง</td><td>${v(p.height_m).toFixed(2)} ม.</td></tr>
                    `;break;default:m=`
                        <tr><td>รหัส</td><td>#${q(p.code)||"-"}</td></tr>
                        <tr><td>ขนาด</td><td>${v(p.width_m).toFixed(2)} x ${v(p.height_m).toFixed(2)} ม.</td></tr>
                    `;break}return m&&(a=!0),`
                 <div class="lookbook-details">
                    <div class="visual-placeholder">
                        ${bt(p)}
                    </div>
                    <div class="spec-table-wrapper">
                        ${h}
                        <table class="spec-table">
                            ${m}
                        </table>
                    </div>
                </div>
            `}).join('<hr class="lookbook-hr">');return d.trim()?`
            <div class="lookbook-room">
                <h4><i class="ph ph-map-pin"></i> ${q(u.room_name)}</h4>
                ${d}
            </div>
        `:""}).join("");return a?`
        <div class="lookbook-summary">
            <div class="lookbook-customer-info">
                <strong>ลูกค้า:</strong> ${q(e.customer_name)||"-"}<br/>
                <strong>ที่อยู่:</strong> ${q(e.customer_address)||"-"}
            </div>
            <div class="lookbook-totals">
                <span>ยอดรวม (ก่อนส่วนลด): ${k(t)} บาท</span>
                ${n>0?`<span>ส่วนลด: -${k(n)} บาท</span>`:""}
                <span class="grand-total">ยอดสุทธิ: ${k(r)} บาท</span>
            </div>
        </div>
    `+s:'<p class="empty-summary">ไม่มีรายการสำหรับสร้างรายงาน</p>'}const se=[],xt=10;function te(e){se.push(e),se.length>xt&&se.shift()}function kt(){return se.pop()}function Lt(){return se.length>0}let G=!1,be=null,P=null,fe=null,le=!1,D=null,ke=null,Le=!1,ie=null;const Ge=document.querySelector("#undoBtn"),he={};function Tt(e){if(he[e])return he[e];const t=new Promise((n,r)=>{const a=document.createElement("script");a.src=e,a.onload=()=>{console.log(`${e} loaded successfully.`),n()},a.onerror=()=>{console.error(`Script load error for ${e}`),delete he[e],r(new Error(`Script load error for ${e}`))},document.head.appendChild(a)});return he[e]=t,t}const de={set:{templateId:"#setTpl",name:"ผ้าม่าน"},wallpaper:{templateId:"#wallpaperTpl",name:"วอลล์เปเปอร์"},wooden_blind:{templateId:"#areaBasedTpl",name:"มู่ลี่ไม้"},roller_blind:{templateId:"#areaBasedTpl",name:"ม่านม้วน"},vertical_blind:{templateId:"#areaBasedTpl",name:"ม่านปรับแสง"},partition:{templateId:"#areaBasedTpl",name:"ฉากกั้นห้อง"},pleated_screen:{templateId:"#areaBasedTpl",name:"มุ้งจีบ"},aluminum_blind:{templateId:"#areaBasedTpl",name:"มู่ลี่อลูมิเนียม"}},Mt={มู่ลี่ไม้:"wooden_blind",ม่านม้วน:"roller_blind",ม่านปรับแสง:"vertical_blind",ฉากกั้นห้อง:"partition",มุ้งจีบ:"pleated_screen",มู่ลี่อลูมิเนียม:"aluminum_blind"},Ee="marnthara.theme";function Ze(){const e=localStorage.getItem(Ee),t=document.querySelector("#themeToggleBtn");if(!t)return;const n=t.querySelector("i"),r=t.querySelector("span");switch(document.body.classList.remove("dark-theme","neutral-theme"),e){case"dark":document.body.classList.add("dark-theme"),n&&(n.className="ph-fill ph-sun"),r&&(r.textContent=" สว่าง");break;case"neutral":document.body.classList.add("neutral-theme"),n&&(n.className="ph-fill ph-moon"),r&&(r.textContent=" มืด");break;default:n&&(n.className="ph-fill ph-palette"),r&&(r.textContent=" กลาง");break}}function Bt(){const e=localStorage.getItem(Ee);let t;!e||e==="light"?t="neutral":e==="neutral"?t="dark":t="light",localStorage.setItem(Ee,t),Ze()}function K(){Ge&&(Ge.disabled=!Lt())}function Et(){const e=kt();e&&(Ie(e,!1),w("ยกเลิกการกระทำล่าสุดแล้ว","success")),K()}function Te(){var n;ie="suspended",(n=document.getElementById("filterStatusBar"))==null||n.classList.remove("is-visible");const e=document.getElementById("suspendedWarningBar");let t=0;if(document.querySelectorAll(".room-card").forEach(r=>{let a=!1;r.querySelectorAll(".item-card").forEach(s=>{const o=s.classList.contains("is-suspended")||r.classList.contains("is-suspended");s.classList.toggle("item-hidden",!o),o&&(a=!0,t++)}),r.classList.toggle("item-hidden",!a)}),t===0){et(),w("ไม่มีรายการที่ถูกระงับแล้ว","success");return}e&&(e.innerHTML=`
            <span><i class="ph-bold ph-eye"></i> กำลังแสดงรายการที่ถูกระงับ (${t} รายการ)</span>
            <button type="button" class="btn-chip" data-act="clear-filter" title="ยกเลิกการกรอง">
                <i class="ph ph-x"></i>&nbsp;ปิด
            </button>
        `,e.classList.add("is-visible"),e.dataset.filterType="suspended"),X(),Y()}function Ct(e,t){var a;if(!e)return;(a=document.getElementById("suspendedWarningBar"))==null||a.classList.remove("is-visible"),ie=e;const n=document.getElementById("filterStatusBar");let r=0;document.querySelectorAll(y.room).forEach(s=>{let o=0;s.querySelectorAll(".item-card").forEach(l=>{const u=l.dataset.type===e;l.classList.toggle("item-hidden",!u),u&&o++}),s.classList.toggle("item-hidden",o===0),r+=o}),n&&(n.innerHTML=`
            <span>เฉพาะ: <strong>${q(t)}</strong> (${r} รายการ)</span>
            <button type="button" class="btn-chip" data-act="clear-filter" title="ยกเลิกการกรอง">
                <i class="ph ph-x"></i>&nbsp;ปิด
            </button>
        `,n.classList.add("is-visible"),n.dataset.filterType=e),X(),Y()}function et(){ie=null;const e=document.getElementById("filterStatusBar");e&&(e.classList.remove("is-visible"),e.innerHTML="",e.removeAttribute("data-filter-type"));const t=document.getElementById("suspendedWarningBar");t&&t.removeAttribute("data-filter-type"),document.querySelectorAll(".item-hidden").forEach(n=>n.classList.remove("item-hidden")),X(),Y(),nt()}function It(e){const t=e.target.closest(".item-card");document.querySelectorAll(".item-details-more.show").forEach(n=>{const r=n.closest(".item-card");r!==t&&Fe(r,!1)})}function Ye(e){if(!e)return;const t=document.querySelector(".main-header"),n=t?t.offsetHeight+16:80,r=e.getBoundingClientRect();r.top>=n&&r.bottom<=window.innerHeight||e.scrollIntoView({behavior:"smooth",block:"center"})}function we(){document.querySelectorAll(".favorite-chips-container.show").forEach(e=>{e.classList.remove("show")}),document.querySelectorAll(".item-card.overflow-visible").forEach(e=>{e.classList.remove("overflow-visible")})}function tt(e){var u;const t=e.dataset.favoriteType,n=(u=e.closest(".form-group-with-favorites"))==null?void 0:u.querySelector(".favorite-chips-container");if(!t||!n)return;we();const r=e.closest(".item-card"),s=Q()[t]||[];let l=Array.from(s.reduce((c,d)=>{const p=d.code.trim();return p&&!c.has(p.toLowerCase())&&c.set(p.toLowerCase(),d),c},new Map).values()).map(c=>`<button type="button" class="btn-chip" data-code="${q(c.code)}" data-price="${c.price}">${q(c.code)}</button>`).join("");l+=`<button type="button" class="btn-manage-favorites" data-act="manage-favorites" data-type="${t}"><i class="ph ph-pencil-simple"></i> จัดการรายการโปรด</button>`,n.innerHTML=l,n.classList.add("show"),r&&r.classList.add("overflow-visible")}function At(e){const t=e.closest(".form-group-with-favorites"),n=e.closest(".item-card");if(!t||!n)return;const r=e.dataset.code,a=v(e.dataset.price),s=t.querySelector("input[data-favorite-type]");s&&(s.value=r,s.classList.add("input-highlight"),setTimeout(()=>s.classList.remove("input-highlight"),1200));const o=s.dataset.favoriteType;let l;o==="fabric"?l="set_price_per_m":o==="sheer"?l="sheer_price_per_m":o==="wallpaper"?l="wallpaper_price_roll":l="area_price_sqyd";const u=n.querySelector(`[name="${l}"]`);u&&a>0&&(u.tagName==="SELECT"?u.value=a:u.value=k(a),u.classList.add("input-highlight"),setTimeout(()=>u.classList.remove("input-highlight"),1200)),qe(s),oe(n),E(),we()}function ge(e){const t=document.querySelector("#favManagerBody"),n=document.querySelector("#favManagerItemTpl"),a=Q()[e]||[];!t||!n||(a.length===0?t.innerHTML='<p class="empty-state">ไม่มีรายการโปรดที่บันทึกไว้</p>':t.innerHTML=a.map(s=>n.innerHTML.replace(/{CODE}/g,q(s.code)).replace(/{PRICE}/g,k(s.price)).replace(/{RAW_PRICE}/g,s.price)).join(""),Ce(null))}function Ce(e){const t=document.querySelector('[data-act="edit-selected-fav"]'),n=document.querySelector('[data-act="del-selected-fav"]');!t||!n||(e?(t.disabled=!1,n.disabled=!1,D={code:e.dataset.code,price:v(e.dataset.price)}):(t.disabled=!0,n.disabled=!0,D=null))}async function Nt(e){const t=document.querySelector("#favManagerModal");if(!t||!e)return;const n={fabric:"ผ้าทึบ",sheer:"ผ้าโปร่ง",wallpaper:"วอลล์เปเปอร์",wooden_blind:"มู่ลี่ไม้",roller_blind:"ม่านม้วน",vertical_blind:"ม่านปรับแสง",partition:"ฉากกั้นห้อง",pleated_screen:"มุ้งจีบ",aluminum_blind:"มู่ลี่อลูมิเนียม",deco:"ของตกแต่ง"};t.dataset.currentType=e,le=!1,D=null,document.querySelector("#favManagerTitle").textContent=`จัดการ '${n[e]||e}'`,ge(e),await j("#favManagerModal",()=>{le&&be&&tt(be)})}function w(e,t="default"){const n=document.querySelector(y.toastContainer);if(!n)return;const r={success:"ph-bold ph-check-circle",warning:"ph-bold ph-warning",error:"ph-bold ph-x-circle",default:"ph-bold ph-info"},a=document.createElement("div");a.className=`toast toast-${t}`,a.innerHTML=`<i class="${r[t]||r.default}"></i> ${e}`,n.appendChild(a),setTimeout(()=>a.classList.add("show"),10),setTimeout(()=>{a.classList.remove("show"),a.addEventListener("transitionend",()=>a.remove())},3e3)}function j(e,t){return new Promise(n=>{const r=document.querySelector(e);if(!r){n(null);return}const a=document.querySelector(".modal-wrapper.visible");a&&a.classList.add("is-underlay"),r.classList.add("visible");const s=r.querySelector('[id$="Confirm"]'),o=r.querySelector('[id$="Cancel"], [data-act="close-modal"]'),l=Array.from(r.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])')).filter(m=>!m.disabled&&m.offsetParent!==null),u=l[0],c=l[l.length-1];setTimeout(()=>u==null?void 0:u.focus(),50);const d=m=>{if(m.key==="Escape"&&!r.classList.contains("is-underlay")){p({cancelled:!0});return}if(m.key==="Tab"){if(l.length<=1){m.preventDefault();return}m.shiftKey?document.activeElement===u&&(c.focus(),m.preventDefault()):document.activeElement===c&&(u.focus(),m.preventDefault())}},p=m=>{r.classList.remove("visible"),document.removeEventListener("keydown",d),s&&(s.onclick=null),o&&(o.onclick=null),a&&a.classList.remove("is-underlay"),typeof m=="object"&&m.cancelled&&t&&t(),n(m)};s&&(s.onclick=()=>p(!0)),o&&(o.onclick=()=>{r.classList.contains("is-underlay")||p({cancelled:!0})}),document.addEventListener("keydown",d)})}async function ce(e,t){const n=document.querySelector(y.modal);return n?(n.querySelector(y.modalTitle).textContent=e,n.querySelector(y.modalBody).textContent=t,await j(y.modal)===!0):!0}async function Ft(){var n,r,a;const e=document.querySelector(y.exportOptionsModal);if(!e)return null;const t=await j(y.exportOptionsModal);return!t||t.cancelled?null:{vatOption:((n=e.querySelector('input[name="vat_option"]:checked'))==null?void 0:n.value)||"include",exportMethod:((r=e.querySelector("#exportMethod"))==null?void 0:r.value)||"direct",pageBreakBuffer:parseInt((a=e.querySelector("#pageBreakBuffer"))==null?void 0:a.value,10)||3}}async function Pt(){const e=document.querySelector("#discountModal");if(!e)return;const t=e.querySelector("#discountSubtotal"),n=e.querySelector("#discountPercent"),r=e.querySelector("#discountAmount"),a=e.querySelector("#discountFinalTotal"),s=document.querySelector("#discount_type"),o=document.querySelector("#discount_value"),l=v(document.querySelector("#originalTotal").dataset.rawTotal||document.querySelector("#grandTotal").textContent);t.textContent=k(l);const u=m=>{if(Le)return;Le=!0;let h=0;if(m==="percent"){const g=v(n.value);h=l*((g>=0?g:0)/100),r.value=h>0?k(Math.round(h)):""}else h=v(r.value);if(h=h>=0?Math.min(h,l):0,m!=="percent"){const g=l>0?h/l*100:0;n.value=g>0&&isFinite(g)?W(g,2):""}a.textContent=k(l-h),setTimeout(()=>{Le=!1},20)};n.addEventListener("input",()=>u("percent")),r.addEventListener("input",()=>u("amount")),r.addEventListener("focus",m=>{v(m.target.value)>0&&(m.target.value=v(m.target.value))}),r.addEventListener("blur",m=>{v(m.target.value)>0&&(m.target.value=k(v(m.target.value))),u("amount")});const c=s.value,d=v(o.value);n.value="",r.value="",d>0?c==="percent"?(n.value=d,u("percent")):(r.value=k(d),u("amount")):u();const p=await j("#discountModal");if(p&&!p.cancelled){const m=v(n.value),h=v(r.value);document.activeElement===n&&m>0?(s.value="percent",o.value=m):h>0?(s.value="amount",o.value=h):(s.value="amount",o.value=0),V(),E()}}async function Rt(){var r,a,s,o,l;if(!P)return;const e=document.querySelector("#hardwareModal"),t=((r=P.querySelector('[name="set_style"]'))==null?void 0:r.value)==="ตาไก่";e.querySelector('[name="modal_track_color"]').value=((a=P.querySelector('[name="track_color"]'))==null?void 0:a.value)||"ขาว",e.querySelector('[name="modal_bracket_color"]').value=((s=P.querySelector('[name="bracket_color"]'))==null?void 0:s.value)||"ขาว",e.querySelector('[name="modal_finial_color"]').value=((o=P.querySelector('[name="finial_color"]'))==null?void 0:o.value)||"ขาว",e.querySelector('[name="modal_grommet_color"]').value=((l=P.querySelector('[name="grommet_color"]'))==null?void 0:l.value)||"เงิน",e.querySelector("#grommetColorGroup").style.display=t?"":"none";const n=await j("#hardwareModal");n&&!n.cancelled&&(P.querySelector('[name="track_color"]').value=e.querySelector('[name="modal_track_color"]').value,P.querySelector('[name="bracket_color"]').value=e.querySelector('[name="modal_bracket_color"]').value,P.querySelector('[name="finial_color"]').value=e.querySelector('[name="modal_finial_color"]').value,t&&(P.querySelector('[name="grommet_color"]').value=e.querySelector('[name="modal_grommet_color"]').value),E(),w("บันทึกการตั้งค่าอุปกรณ์แล้ว","success")),P=null}function Me(e,t,n){e&&(te(O()),K(),e.classList.add("item-removing"),e.addEventListener("animationend",()=>{e.remove(),t&&w(t),n&&n(),ue(),X(),V(),E(),me()},{once:!0}))}function X(){document.querySelectorAll(y.room).forEach(e=>{const t=e.querySelectorAll(".item-card:not(.is-suspended):not(.item-hidden)"),n=t.length;t.forEach((a,s)=>{const o=a.querySelector("[data-item-title]");o&&(o.textContent=`${s+1}/${n}`)}),e.querySelectorAll(".item-card.is-suspended, .item-card.item-hidden").forEach(a=>{const s=a.querySelector("[data-item-title]");s&&(s.textContent="-")})})}function rt(){const e=document.querySelector(y.orderForm),t=document.querySelector(y.lockBtn);!e||!t||(e.classList.toggle("is-locked",G),t.classList.toggle("is-locked",G),t.querySelector("i").className=G?"ph-bold ph-lock-key":"ph ph-paw-print",e.querySelectorAll("input, select, textarea, button").forEach(n=>{n.closest(".summary-footer")||n.closest(".main-header")||n.closest(".modal-wrapper")||n.dataset.act==="toggle-more-details"||n.dataset.act==="collapse-room"||(n.disabled=G)}),w(G?"ฟอร์มถูกล็อค":"ปลดล็อคฟอร์มแล้ว",G?"warning":"success"))}function Y(){const e=document.querySelectorAll(y.room);if(e.length===0)return;const t=[...e].some(r=>r.open),n=document.querySelector(y.toggleAllRoomsBtn);n&&(n.querySelector("i").className="ph ph-rows",n.querySelector("span").textContent=t?"ย่อทั้งหมด":"ขยายทั้งหมด")}function Ot(){const e=document.querySelectorAll(y.room),t=[...e].some(n=>n.open);e.forEach(n=>{n.open=!t}),setTimeout(()=>{Y(),E()},50)}function ue(){const e=document.querySelector(y.quickNavRoomList);e&&(e.innerHTML="",document.querySelectorAll(y.room).forEach(t=>{var a;const n=((a=t.querySelector(y.roomNameInput))==null?void 0:a.value)||"ห้อง",r=document.createElement("a");r.href=`#${t.id}`,r.dataset.jumpTo=t.id,r.innerHTML=`<i class="ph ph-share-fat"></i> ${n}`,e.appendChild(r)}))}function ot(e){var n;const t=document.getElementById("quickNavBtnText");t&&(e?t.textContent=((n=e.querySelector('input[name="room_name"]'))==null?void 0:n.value)||"...":t.textContent="ไปยังห้อง")}function me(){if(fe&&fe.disconnect(),!document.getElementById("quickNavBtnText"))return;const e={root:null,rootMargin:"-60px 0px -150px 0px",threshold:0},t=n=>{const r=n.filter(a=>a.isIntersecting).sort((a,s)=>a.target.getBoundingClientRect().top-s.target.getBoundingClientRect().top);r.length>0&&ot(r[0].target)};fe=new IntersectionObserver(t,e),document.querySelectorAll(y.room).forEach(n=>fe.observe(n))}function qe(e){if(!e)return;const t=e.closest(".form-group-with-favorites").querySelector(".btn-favorite");if(!t)return;const n=e.dataset.favoriteType,r=e.value;t.classList.toggle("is-favorite",ft(n,r))}function Fe(e,t=null){if(!e)return;const n=e.querySelector(".item-details-more"),r=e.querySelector('[data-act="toggle-more-details"]'),a=r==null?void 0:r.parentElement;if(!n||!r||!a)return;const s=n.classList.contains("show"),o=t!==null?t:!s;if(s===o)return;n.classList.toggle("show",o),r.classList.toggle("expanded",o);const l=r.querySelector("i");l&&(l.className=o?"ph ph-caret-up":"ph ph-caret-down");const u=r.querySelector("span");if(u&&(u.textContent=o?"ย่อน้อยลง":"เพิ่มเติม"),o)n.appendChild(a);else{const c=e.querySelector(".item-grid");c&&c.appendChild(a)}}function Pe(e,t){const n=de[e];if(!n)return null;const r=document.querySelector(n.templateId);if(!r||!t)return null;const a=r.content.cloneNode(!0),s=a.firstElementChild;s.dataset.type=e,s.classList.add(`${e.replace(/_/g,"-")}-item`);const o=s.querySelector(".item-type-display");if(o&&(o.textContent=n.name),n.templateId==="#areaBasedTpl"){const l=s.querySelector("input[data-favorite-type]"),u=s.querySelector(".btn-favorite");l&&(l.dataset.favoriteType=e),u&&(u.dataset.type=e)}return t.appendChild(a),s}function Ht(e,t){var a;if(!t)return;const n=t.querySelector(y.allItemsContainer);if(!n)return;te(O()),K(),we();const r=Pe(e,n);if(r){if(e==="wallpaper"){const s=Re(r.querySelector('[data-act="add-wall"]'));s&&((a=s.querySelector("input"))==null||a.focus())}else{const s=r.querySelector('input:not([type="hidden"]), select, textarea');s&&s.focus()}r.classList.add("item-created"),r.scrollIntoView({behavior:"smooth",block:"center"}),X(),V(),E()}}async function Je(e,t=null){const n=document.querySelector("#itemTypeModal");if(!n)return null;n.querySelector("#itemTypeModalTitle").textContent=e;let r=t;t&&!de[t]&&(r="wooden_blind");const a=n.querySelector(`input[name="item_type_option"][value="${r||"set"}"]`);a&&(a.checked=!0);const s=await j("#itemTypeModal");if(!s||s.cancelled)return null;const o=n.querySelector('input[name="item_type_option"]:checked');return o?o.value:null}function Wt(e,t){if(!de[t])return;const r=e.parentElement;r&&(te(O()),K(),e.classList.add("item-removing"),e.addEventListener("animationend",()=>{var s;const a=Pe(t,r);a&&(e.replaceWith(a),a.classList.add("item-created"),a.scrollIntoView({behavior:"smooth",block:"center"}),(s=a.querySelector('input:not([type="hidden"]), select, textarea'))==null||s.focus(),X(),V(),E(),w("เปลี่ยนประเภทรายการแล้ว","success"))},{once:!0}))}function ae(){te(O()),K();const e=document.querySelector(y.roomsContainer);if(!e)return;const t=document.querySelector("#roomTpl");if(!t)return;const n=Array.from(document.querySelectorAll(y.roomNameInput)).map(u=>parseInt(u.value.replace(/[^0-9]/g,""),10)).filter(u=>!isNaN(u)),s=`ห้อง ${(n.length>0?Math.max(...n):0)+1}`,l=t.content.cloneNode(!0).firstElementChild;if(l){l.id=`room-${Date.now()}`;const u=l.querySelector('input[name="room_name"]'),c=l.querySelector(".room-header-controls .form-group > label");if(u&&c){const p=`room_name_${l.id}`;u.id=p,c.setAttribute("for",p)}u&&(u.value=s);const d=l.querySelector("[data-room-name-display]");d&&(d.textContent=s),l.open=!0,e.appendChild(l),l.classList.add("item-created"),l.scrollIntoView({behavior:"smooth",block:"center"})}ue(),Y(),me(),E()}function Re(e){var n;const t=(n=e==null?void 0:e.closest(".walls-section"))==null?void 0:n.querySelector(y.wallsContainer);if(t){const r=document.querySelector(y.wallTpl);if(!r)return null;const a=r.content.cloneNode(!0),s=a.querySelector(".wall-input-row");if(!s)return null;const o=s.querySelector("input"),l=s.querySelector("label");if(o&&l){const u=`wall-input-${Date.now()}-${Math.random().toString(36).substring(2,7)}`;o.id=u,l.setAttribute("for",u)}return t.appendChild(a),requestAnimationFrame(()=>{s.classList.add("item-created")}),oe(e),s}return null}function oe(e){var o,l,u,c,d,p,m,h,g,i,f,b;if(!e)return;const t=e.closest(".item-card");if(!t){V();return}const n=t.dataset.type;let r,a,s;switch(n){case"set":r=t.querySelector("[data-set-summary]"),a={width_m:(o=t.querySelector('input[name="width_m"]'))==null?void 0:o.value,height_m:(l=t.querySelector('input[name="height_m"]'))==null?void 0:l.value,style:(u=t.querySelector('select[name="set_style"]'))==null?void 0:u.value,fabric_variant:(c=t.querySelector('select[name="fabric_variant"]'))==null?void 0:c.value,price_per_m_raw:(d=t.querySelector('select[name="set_price_per_m"]'))==null?void 0:d.value,sheer_price_per_m:(p=t.querySelector('select[name="sheer_price_per_m"]'))==null?void 0:p.value},s=M.calculateSetPrice(a),t.dataset.totalPrice=s.total;let S=`ราคา: <b>${k(s.total)}</b> บ.`;s.opaque>0&&s.sheer>0&&(S+=` <small>(ทึบ: ${k(s.opaque)}, โปร่ง: ${k(s.sheer)})</small>`),r&&(r.innerHTML=S);break;case"wallpaper":r=t.querySelector("[data-wallpaper-summary]"),a={height_m:(m=t.querySelector('input[name="wallpaper_height_m"]'))==null?void 0:m.value,price_per_roll:(h=t.querySelector('input[name="wallpaper_price_roll"]'))==null?void 0:h.value,install_cost_per_roll:(g=t.querySelector('input[name="wallpaper_install_cost"]'))==null?void 0:g.value,widths:Array.from(t.querySelectorAll('input[name="wall_width_m"]')).map(_=>_.value)},s=M.calculateWallpaperPrice(a),t.dataset.totalPrice=s.total;let x=`รวม: <b>${k(s.total)}</b> บ. `;(s.material>0||s.install>0)&&(x+=`<small>(วอลล์: ${k(s.material)}, ค่าช่าง: ${k(s.install)})</small>`),s.rolls>0&&(x+=` &bull; พื้นที่: ${W(s.sqm,2)} ตร.ม. &bull; ใช้: ${s.rolls} ม้วน`),r&&(r.innerHTML=x);break;default:r=t.querySelector("[data-area-summary]"),a={width_m:(i=t.querySelector('input[name="area_width_m"]'))==null?void 0:i.value,height_m:(f=t.querySelector('input[name="area_height_m"]'))==null?void 0:f.value,price_sqyd:(b=t.querySelector('input[name="area_price_sqyd"]'))==null?void 0:b.value},s=M.calculateDecoPrice(a),t.dataset.totalPrice=s.total;let $="";s.sqyd>0&&($=` &bull; พื้นที่: ${W(s.sqyd,2)} ตร.หลา`),r&&(r.innerHTML=`ราคา: <b>${k(s.total)}</b> บ.${$}`);break}V()}function nt(){const e=document.getElementById("suspendedWarningBar");if(!e||e.dataset.filterType==="suspended")return;const t=document.querySelectorAll(".item-card.is-suspended").length,n=document.querySelectorAll(".room-card.is-suspended");let r=0;n.forEach(s=>{r+=s.querySelectorAll(".item-card:not(.is-suspended)").length});const a=t+r;a>0?(e.innerHTML=`<button type="button" data-act="show-suspended-items" class="suspended-warning-button">
                                    <i class="ph-bold ph-warning"></i> 
                                    มี ${a} รายการที่ถูกระงับ (คลิกเพื่อดู)
                                </button>`,e.classList.add("is-visible")):(e.classList.remove("is-visible"),e.innerHTML="")}function V(){let e=0;document.querySelectorAll(y.room).forEach(o=>{let l=0,u=0;const c=o.classList.contains("is-suspended");o.querySelectorAll(".item-card").forEach(p=>{const m=v(p.dataset.totalPrice),h=p.classList.contains("is-suspended");!c&&!h&&(l+=m,m>0&&u++)});const d=o.querySelector("[data-room-brief]");d&&(c?d.textContent="(ระงับชั่วคราว)":u>0?d.innerHTML=`<span>${u}</span> &bull; ${k(l)} บาท`:d.innerHTML="<span>0</span> รายการ"),c||(e+=l)});const t=document.querySelector("#discount_type").value,n=v(document.querySelector("#discount_value").value);let r=0;n>0&&(r=t==="percent"?e*(n/100):n);const a=e-r;document.querySelector("#grandTotal").textContent=k(a);const s=document.querySelector("#originalTotal");r>0?(s.textContent=k(e),s.dataset.rawTotal=e,s.style.display="block"):(s.style.display="none",s.dataset.rawTotal=""),nt()}async function Ie(e,t=!1){if(e!=null&&e.favorites)if(t){const s=document.querySelector("#favoritesConflictModal");if(s){const o=await j("#favoritesConflictModal");if(!o||o.cancelled){w("ยกเลิกการนำเข้า","warning");return}switch(s.querySelector('input[name="fav_conflict_option"]:checked').value){case"overwrite":De(e.favorites)&&w("เขียนทับรายการโปรดสำเร็จ","success");break;case"merge":const u=Xe(e.favorites);w(`รวมข้อมูลสำเร็จ (เพิ่ม ${u} รายการใหม่)`,"success");break}}}else De(e.favorites);if(!(e!=null&&e.rooms)||!Array.isArray(e.rooms)){e.favorites||w("ไม่พบข้อมูลสำหรับนำเข้าในไฟล์","error");return}const n=document.querySelector(y.roomsContainer);if(!n)return;n.innerHTML="",document.querySelector("#customer_name").value=e.customer_name||"",document.querySelector("#customer_phone").value=e.customer_phone||"",document.querySelector("#customer_address").value=e.customer_address||"",e.discount&&(document.querySelector("#discount_type").value=e.discount.type||"amount",document.querySelector("#discount_value").value=e.discount.value||0),document.querySelector("#customerDetailsCard").open=e.customer_card_open??!0;let r=0;const a=()=>{if(r>=e.rooms.length){document.querySelectorAll("input[data-favorite-type]").forEach(qe),V(),X(),ue(),Y(),me(),t&&w("นำเข้าข้อมูลฟอร์มสำเร็จ","success");return}const s=e.rooms[r],o=document.querySelector("#roomTpl");if(!o){console.error("Room template not found.");return}const u=o.content.cloneNode(!0).firstElementChild;if(n.appendChild(u),u){u.id=s.id||`room-${Date.now()}`,s.is_suspended&&u.classList.add("is-suspended"),u.open=s.is_open===!0;const c=s.room_name||"ห้อง (ไม่มีชื่อ)",d=u.querySelector('input[name="room_name"]'),p=u.querySelector(".room-header-controls .form-group > label");if(d&&p){const g=`room_name_${u.id}`;d.id=g,p.setAttribute("for",g)}d&&(d.value=c);const m=u.querySelector("[data-room-name-display]");m&&(m.textContent=c);const h=u.querySelector(y.allItemsContainer);if(h&&s.items){const g=document.createDocumentFragment();s.items.forEach(i=>{var b,S,x;i.type==="deco"&&i.deco_type?(i.type=Mt[i.deco_type]||"wooden_blind",i.code=i.deco_code,i.width_m=i.deco_width_m,i.height_m=i.deco_height_m,i.price_sqyd=i.deco_price_sqyd,i.notes=i.deco_notes):i.type==="deco"&&(i.type="wooden_blind",i.code=i.deco_code);const f=Pe(i.type,g);if(f){switch(i.is_suspended&&f.classList.add("is-suspended"),i.type){case"set":f.querySelector('input[name="width_m"]').value=Z(i.width_m),f.querySelector('input[name="height_m"]').value=Z(i.height_m),f.querySelector('select[name="set_style"]').value=i.style||i.set_style||"ลอน",f.querySelector('select[name="fabric_variant"]').value=i.fabric_variant||"ทึบ",f.querySelector('select[name="set_price_per_m"]').value=i.price_per_m_raw||i.set_price_per_m||"",f.querySelector('select[name="sheer_price_per_m"]').value=i.sheer_price_per_m||"",f.querySelector('select[name="opening_style"]').value=i.opening_style||"แยกกลาง",f.querySelector('input[name="track_color"]').value=i.track_color||"ขาว",f.querySelector('input[name="bracket_color"]').value=i.bracket_color||"ขาว",f.querySelector('input[name="finial_color"]').value=i.finial_color||"ขาว",f.querySelector('input[name="grommet_color"]').value=i.grommet_color||"เงิน",f.querySelector('input[name="fabric_code"]').value=i.fabric_code||"",f.querySelector('input[name="sheer_fabric_code"]').value=i.sheer_fabric_code||"",f.querySelector('input[name="notes"]').value=i.notes||"";const $=(i.fabric_variant||"").includes("โปร่ง");(b=f.querySelector(y.sheerWrap))==null||b.classList.toggle("hidden",!$),(S=f.querySelector(y.sheerCodeWrap))==null||S.classList.toggle("hidden",!$);break;case"wallpaper":f.querySelector('input[name="wallpaper_height_m"]').value=Z(i.height_m||i.wallpaper_height_m),f.querySelector('input[name="wallpaper_code"]').value=i.wallpaper_code||"";const _=v(i.price_per_roll||i.wallpaper_price_roll);f.querySelector('input[name="wallpaper_price_roll"]').value=_>0?k(_):"",f.querySelector('input[name="wallpaper_install_cost"]').value=i.hasOwnProperty("install_cost_per_roll")?k(i.install_cost_per_roll):i.wallpaper_install_cost?k(i.wallpaper_install_cost):"300",f.querySelector('input[name="wallpaper_notes"]').value=i.notes||i.wallpaper_notes||"",i.widths&&i.widths.forEach(T=>{const F=Re(f.querySelector('[data-act="add-wall"]'));F&&(F.querySelector('input[name="wall_width_m"]').value=Z(T))});break;default:if(((x=de[i.type])==null?void 0:x.templateId)==="#areaBasedTpl"){f.querySelector('input[name="area_width_m"]').value=Z(i.width_m),f.querySelector('input[name="area_height_m"]').value=Z(i.height_m);const T=v(i.price_sqyd);f.querySelector('input[name="area_price_sqyd"]').value=T>0?k(T):"",f.querySelector('input[name="area_code"]').value=i.code||"",f.querySelector('input[name="area_notes"]').value=i.notes||""}break}oe(f)}}),h.appendChild(g)}}r++,requestAnimationFrame(a)};requestAnimationFrame(a)}function Dt(e){if(document.getElementById("loading-overlay"))return;const t=document.createElement("div");t.id="loading-overlay",t.innerHTML=`<div class="loading-spinner"></div><p>${e}</p>`,document.body.appendChild(t),document.body.style.overflow="hidden"}function jt(){const e=document.getElementById("loading-overlay");e&&e.remove(),document.body.style.overflow=""}async function Ut(e,t){var r,a;const n=document.querySelector(y.printableContent);if(!n||!e||!e.html){w("ไม่พบข้อมูลสำหรับสร้างเอกสาร","error");return}if(t==="direct"){Dt("กำลังสร้าง PDF...");let s;try{typeof html2pdf>"u"&&(w("กำลังโหลดไลบรารี PDF...","default"),await Tt("https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js")),s=document.createElement("div"),s.style.position="fixed",s.style.left="-300mm",s.style.top="0",s.style.width="210mm",s.style.background="#fff",s.innerHTML=e.html,document.body.appendChild(s),await new Promise(l=>setTimeout(l,500));const o={margin:0,filename:`${e.fileName}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0,logging:!1,width:((r=s.querySelector(".pdf-page"))==null?void 0:r.scrollWidth)||210*3.77,windowWidth:((a=s.querySelector(".pdf-page"))==null?void 0:a.scrollWidth)||210*3.77},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}};await window.html2pdf().from(s).set(o).save(),w("ดาวน์โหลด PDF สำเร็จ","success")}catch(o){console.error("PDF Generation Error:",o),w("สร้าง PDF ล้มเหลว, โปรดลองวิธีที่ 2 (พิมพ์)","error")}finally{jt(),s&&document.body.contains(s)&&document.body.removeChild(s)}}t==="print"&&(n.innerHTML=e.html,setTimeout(()=>{window.print(),setTimeout(()=>{n.innerHTML=""},1e3)},ct))}function Vt(e){if(!e||!e.html){w("ไม่พบข้อมูลสำหรับสร้างไฟล์ HTML","error");return}try{const t=`
            <!DOCTYPE html><html lang="th"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>${e.fileName}</title>
                <link rel="stylesheet" href="https://grobmak.github.io/marnthara-form/src/style.css">
                <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/bold/style.css">
                <style>#printable-content { display: block !important; } .pdf-page { border: 1px solid #eee; box-shadow: 0 0 10px rgba(0,0,0,0.1); margin: 10mm auto; } i.ph { vertical-align: middle; }</style>
            </head>
            <body>${e.html}</body></html>`,n=new Blob([t],{type:"text/html;charset=utf-8"}),r=URL.createObjectURL(n),a=document.createElement("a");a.href=r,a.download=`${e.fileName}.html`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(r),w("ดาวน์โหลดไฟล์ HTML สำเร็จ","success")}catch(t){console.error("HTML Export Error:",t),w("สร้างไฟล์ HTML ล้มเหลว","error")}}function Gt(e){if(!e)return;const t=e.closest(".item-card");if(!t)return;const n=v(e.value);let r,a;const s=e.getAttribute("name");if(s==="set_price_per_m"?(r=t.querySelector('input[name="fabric_code"]'),a="fabric"):s==="sheer_price_per_m"?(r=t.querySelector('input[name="sheer_fabric_code"]'),a="sheer"):s==="wallpaper_price_roll"?(r=t.querySelector('input[name="wallpaper_code"]'),a="wallpaper"):s==="area_price_sqyd"&&(r=t.querySelector('input[name="area_code"]'),r&&(a=r.dataset.favoriteType)),r&&a&&r.value.trim()){const o=Ne(a,r.value);o&&o.price!==n&&(r.value="",qe(r))}}const Yt=dt(e=>{e.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_price_per_m"]')&&Gt(e),oe(e),E()},200);function Ke(e){var n,r,a;if(G){e.preventDefault();return}const t=e.target;if(t.matches('select[name="fabric_variant"]')){const s=t.closest(".set-item");if(s){const o=(n=t.value)==null?void 0:n.includes("โปร่ง");(r=s.querySelector(y.sheerWrap))==null||r.classList.toggle("hidden",!o),(a=s.querySelector(y.sheerCodeWrap))==null||a.classList.toggle("hidden",!o)}}if(t.matches(y.roomNameInput)){const s=t.closest(".room-card");if(s){const o=s.querySelector("[data-room-name-display]");o&&(o.textContent=t.value||"ห้อง")}ue(),me()}t.matches("input[data-favorite-type]")&&qe(t),Yt(t)}function Jt(e){const t=e.target;t.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_install_cost"]')?t.value=v(t.value)>0?k(v(t.value)):"":t.matches('input[name$="_m"], input[name$="width_m"]')&&(t.value=Z(t.value))}function Kt(e){const t=e.target;t.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_install_cost"]')&&v(t.value)>0&&(t.value=v(t.value)),t.matches("input[data-favorite-type]")&&(be=t,tt(t))}const Qt=async e=>{var d,p,m;const t=e.target.closest(".summary-tag[data-filter-type]");if(t){const h=t.dataset.filterType,g=t.textContent.trim().replace(/\s*\d+\s*$/,""),i=document.querySelector("#overviewModal");i&&i.classList.remove("visible"),Ct(h,g);return}const n=e.target.closest(".favorite-chips-container .btn-chip");if(n){At(n);return}const r=e.target.closest(".fav-manager-item");if(r){const h=r.parentElement.querySelector(".is-selected");h&&h.classList.remove("is-selected"),h!==r?(r.classList.add("is-selected"),Ce(r)):Ce(null);return}const a=e.target.closest("[data-act]");if(!a)return;const s=["toggle-more-details","show-discount-modal","collapse-room","show-suspended-items","clear-filter"];if(G&&!a.closest(".unlockable")&&!s.includes(a.dataset.act))return;const o=a.dataset.act,l=a.closest(y.room),u=a.closest(".item-card"),c=(h,g,i)=>ce(h,g).then(f=>f&&i());switch(o){case"add-room":ae();break;case"add-item":{if(ke=a.closest(y.room),ke){const i=await Je("เพิ่มรายการใหม่");i&&Ht(i,ke)}break}case"collapse-room":l&&(e.preventDefault(),l.open=!1);break;case"clear-filter":e.stopPropagation(),et();break;case"show-suspended-items":Te();break;case"change-type":{const i=u==null?void 0:u.dataset.type;if(u&&i){const f=await Je("เปลี่ยนประเภทรายการ",i);f&&f!==i&&c("ยืนยันการเปลี่ยนแปลง","ข้อมูลทั้งหมดในรายการนี้จะถูกลบและสร้างใหม่ คุณแน่ใจหรือไม่?",()=>Wt(u,f))}break}case"add-wall":{const i=Re(a);i&&((d=i.querySelector('input[name="wall_width_m"]'))==null||d.focus());break}case"show-discount-modal":Pt();break;case"open-hardware-modal":{P=u,Rt();break}case"apply-hardware-to-room":{const i=a.closest("#hardwareModal"),f=P==null?void 0:P.closest(y.room);if(!i||!f)break;const b=i.querySelector('[name="modal_track_color"]').value,S=i.querySelector('[name="modal_bracket_color"]').value,x=i.querySelector('[name="modal_finial_color"]').value,$=i.querySelector('[name="modal_grommet_color"]').value;f.querySelectorAll(".set-item").forEach(_=>{_.querySelector('[name="track_color"]').value=b,_.querySelector('[name="bracket_color"]').value=S,_.querySelector('[name="finial_color"]').value=x,_.querySelector('[name="grommet_color"]').value=$}),E(),w("ใช้การตั้งค่ากับทุกรายการในห้องแล้ว","success");break}case"toggle-more-details":{It(e),Fe(u);break}case"toggle-favorite":{const i=a.closest(".form-group-with-favorites").querySelector("input[data-favorite-type]");if(!i||!u)break;const f=i.dataset.favoriteType,b=i.value;let S;f==="fabric"?S="set_price_per_m":f==="sheer"?S="sheer_price_per_m":f==="wallpaper"?S="wallpaper_price_roll":S="area_price_sqyd";const x=u.querySelector(`[name="${S}"]`),$=v(x==null?void 0:x.value);if(!b.trim()){w("โปรดระบุรหัสก่อนบันทึก","warning");break}if($<=0&&f!=="fabric"&&f!=="sheer"){w("โปรดระบุราคาก่อนบันทึก","warning");break}const _=xe(f,b,$);a.classList.toggle("is-favorite",_),w(_?"เพิ่มในรายการโปรดแล้ว":"ลบออกจากรายการโปรด","success"),E();break}case"manage-favorites":{const i=a.dataset.type;be=a.closest(".form-group-with-favorites").querySelector("input[data-favorite-type]"),Nt(i);break}case"add-new-fav-form":{const f=a.closest("#favManagerModal").dataset.currentType;if(!f)break;const b=document.querySelector("#favAddModal");b.querySelector("h3").textContent=`เพิ่ม '${((p=de[f])==null?void 0:p.name)||f}'`;const S=b.querySelector('[name="fav_code_add"]'),x=b.querySelector('[name="fav_price_add"]');S.value="",x.value="";const $=await j("#favAddModal");if($&&!$.cancelled){const _=S.value.trim(),T=v(x.value);_&&(xe(f,_,T),le=!0,ge(f),w("เพิ่มรายการโปรดแล้ว","success"))}break}case"edit-selected-fav":{if(!D)break;const f=a.closest("#favManagerModal").dataset.currentType;if(!f)break;const b=document.querySelector("#favEditModal");b.querySelector("h3").textContent=`แก้ไข '${D.code}'`;const S=b.querySelector('[name="fav_code_edit"]'),x=b.querySelector('[name="fav_price_edit"]');S.value=D.code,x.value=D.price>0?D.price:"";const $=await j("#favEditModal");if($&&!$.cancelled){const _=S.value.trim(),T=v(x.value);_&&(_!==D.code&&Be(f,D.code),xe(f,_,T),le=!0,ge(f),w("แก้ไขรายการโปรดแล้ว","success"))}break}case"del-selected-fav":{if(!D)break;const f=a.closest("#favManagerModal").dataset.currentType;if(!f)break;await ce("ลบรายการโปรด",`ยืนยันการลบรหัส "${D.code}"?`)&&(Be(f,D.code),le=!0,ge(f),w("ลบรายการโปรดแล้ว","success"));break}case"del-room":c("ลบห้อง","ยืนยันการลบห้องนี้?",()=>Me(l,"ลบห้องแล้ว"));break;case"del-item":c("ลบรายการ","ยืนยันการลบรายการนี้?",()=>Me(u,"ลบรายการแล้ว"));break;case"del-wall":c("ลบผนัง","ยืนยันการลบผนังนี้?",()=>Me(a.closest(".wall-input-row"),"ลบผนังแล้ว",()=>oe(u)));break;case"clear-room":c("ล้างข้อมูลในห้อง","ยืนยันลบทุกรายการในห้องนี้?",()=>{te(O()),K(),l.querySelector(y.allItemsContainer).innerHTML="",X(),V(),E(),w("ล้างข้อมูลในห้องแล้ว","success")});break;case"toggle-room-menu":e.preventDefault();const h=a.nextElementSibling;if(!h||!l)return;const g=!h.classList.contains("show");document.querySelectorAll(".room-options-menu.show").forEach(i=>i.classList.remove("show")),document.querySelectorAll(".card.overflow-visible").forEach(i=>i.classList.remove("overflow-visible")),g&&(h.classList.add("show"),l.classList.add("overflow-visible"));break;case"toggle-suspend-room":e.preventDefault(),l==null||l.classList.toggle("is-suspended"),(m=a.closest(".room-options-menu"))==null||m.classList.remove("show"),l==null||l.classList.remove("overflow-visible"),V(),E(),ie==="suspended"&&Te();break;case"toggle-suspend":e.preventDefault(),u==null||u.classList.toggle("is-suspended"),oe(a),E(),ie==="suspended"&&Te();break}};function Xt(){G=!G,rt()}function zt(e){if(!e||e.closest(".modal-wrapper"))return;const t=e.getAttribute("name"),n=e.closest(".item-card"),s=(o=>{const l=o[t];if(!l)return null;const u=n||document;let c=null;return typeof l=="string"?c=u.querySelector(`[name="${l}"]:not(:disabled)`):typeof l=="function"&&(c=l(e)),!c&&n&&typeof l=="string"&&(c=document.querySelector(`[name="${l}"]:not(:disabled)`)),c})({customer_name:"customer_phone",customer_phone:"customer_address",customer_address:()=>document.querySelector(".room-name-input"),room_name:o=>{var l;return(l=o.closest(".room-card"))==null?void 0:l.querySelector('[data-act="add-item"]')},width_m:"height_m",height_m:"set_price_per_m",set_price_per_m:o=>{var c;const l=o.closest(".set-item"),u=(c=l==null?void 0:l.querySelector('[name="fabric_variant"]'))==null?void 0:c.value;return u!=null&&u.includes("โปร่ง")?l==null?void 0:l.querySelector('[name="sheer_price_per_m"]'):l==null?void 0:l.querySelector('[data-act="toggle-more-details"]')},sheer_price_per_m:o=>{var l;return(l=o.closest(".item-card"))==null?void 0:l.querySelector('[data-act="toggle-more-details"]')},area_width_m:"area_height_m",area_height_m:"area_price_sqyd",area_price_sqyd:"area_code",wall_width_m:o=>{var u,c;const l=(u=o.closest(".wall-input-row"))==null?void 0:u.nextElementSibling;return l!=null&&l.matches(".wall-input-row")?l.querySelector("input"):(c=o.closest(".item-card"))==null?void 0:c.querySelector('[name="wallpaper_price_roll"]')},wallpaper_price_roll:"wallpaper_height_m",wallpaper_height_m:"wallpaper_code"});s&&(s.focus(),typeof s.select=="function"&&s.select())}function Zt(){const e=document.querySelector(y.setTpl);if(!e)return;const t=e.content.querySelector('select[name="set_price_per_m"]'),n=e.content.querySelector('select[name="sheer_price_per_m"]'),r=a=>{let s='<option value="" hidden>เลือกราคา</option>';return Array.isArray(a)?(a.forEach(o=>{s+=`<option value="${o}">${o.toLocaleString("th-TH")}</option>`}),s):(console.error("Price data for dropdown is not available or not an array.",a),s)};t&&(t.innerHTML=r(_e.fabric)),n&&(n.innerHTML=r(_e.sheer))}function er(){Zt(),Ze();const e=document.querySelector(y.orderForm),t=document.querySelector(y.fileImporter),n=document.querySelector("#favImporter"),r=document.querySelector(y.menuDropdown),a=document.querySelector(y.quickNavDropdown),s=document.querySelector("#pageBreakBuffer"),o=document.querySelector("#pageBreakBufferValue");s&&o&&s.addEventListener("input",()=>{o.textContent=s.value}),e.addEventListener("input",Ke),e.addEventListener("change",Ke),document.addEventListener("click",Qt),e.addEventListener("blur",Jt,!0),e.addEventListener("focusin",Kt,!0),e.addEventListener("focusin",c=>{const d=c.target.closest(".item-card");d&&Ye(d)},!0),e.addEventListener("keydown",c=>{const d=c.target;c.key==="Enter"&&!d.matches("textarea, button, [data-act]")&&(c.preventDefault(),zt(d))});const l=c=>{const d=c.target.closest(y.room);d&&ot(d)};e.addEventListener("click",l),e.addEventListener("focusin",l),document.body.addEventListener("click",c=>{const d=c.target.closest("summary");if(d){const p=d.closest("details.card");setTimeout(()=>{Y(),E(),p&&p.open&&Ye(p)},50)}}),document.querySelector("#undoBtn").addEventListener("click",c=>{c.preventDefault(),Et()}),document.querySelector(y.lockBtn).addEventListener("click",Xt),document.querySelector(y.toggleAllRoomsBtn).addEventListener("click",Ot),document.querySelector(y.quickNavBtn).addEventListener("click",c=>{var p;c.stopPropagation(),r.classList.remove("show");const d=!a.classList.contains("show");a.classList.toggle("show"),c.currentTarget.setAttribute("aria-expanded",d),d&&((p=document.querySelector(y.menuBtn))==null||p.setAttribute("aria-expanded","false"))}),document.querySelector(y.quickNavRoomList).addEventListener("click",c=>{var p;const d=c.target.closest("a[data-jump-to]");if(d){c.preventDefault();const m=d.dataset.jumpTo,h=document.getElementById(m);h&&(document.body.classList.add("disable-animations"),h.open=!0,h.scrollIntoView({behavior:"auto",block:"start"}),h.classList.add("scrolling-jump"),setTimeout(()=>{h.classList.remove("scrolling-jump"),document.body.classList.remove("disable-animations"),Y()},1e3)),a.classList.remove("show"),(p=document.querySelector(y.quickNavBtn))==null||p.setAttribute("aria-expanded","false")}});const u=document.querySelector("#addRoomQuickNavBtn");if(u){const c=ut(ae,700);u.addEventListener("click",d=>{var p;d.stopPropagation(),c(),a.classList.remove("show"),(p=document.querySelector(y.quickNavBtn))==null||p.setAttribute("aria-expanded","false")})}document.querySelector(y.menuBtn).addEventListener("click",c=>{var p;c.stopPropagation(),a.classList.remove("show");const d=!r.classList.contains("show");r.classList.toggle("show"),c.currentTarget.setAttribute("aria-expanded",d),d&&((p=document.querySelector(y.quickNavBtn))==null||p.setAttribute("aria-expanded","false"))}),document.querySelector("#themeToggleBtn").addEventListener("click",c=>{c.preventDefault(),Bt()}),document.querySelector("#overviewBtn").addEventListener("click",async c=>{var h;c.preventDefault(),r.classList.remove("show"),(h=document.querySelector(y.menuBtn))==null||h.setAttribute("aria-expanded","false");const d=O(),p=document.querySelector("#overviewModalHeader"),m=document.querySelector("#overviewModalBody");if(p&&m){const g=d.rooms.reduce((b,S)=>{if(S.is_suspended)return b;const x=(S.items||[]).filter($=>{if($.is_suspended)return!1;let _=0;switch($.type){case"set":_=M.calculateSetPrice($).total;break;case"wallpaper":_=M.calculateWallpaperPrice($).total;break;default:_=M.calculateDecoPrice($).total;break}return _>0}).length;return b+x},0),i=document.querySelector(y.grandTotal).textContent||"0",f=d.rooms.filter(b=>!b.is_suspended&&b.items&&b.items.some(S=>!S.is_suspended)).length;p.innerHTML=`
                <div class="overview-stats-grid">
                    <div class="overview-stat-card">
                        <i class="ph-bold ph-map-pin-line"></i>
                        <div class="stat-value">${f}</div>
                        <div class="stat-label">ห้อง</div>
                    </div>
                    <div class="overview-stat-card">
                        <i class="ph-bold ph-stack"></i>
                        <div class="stat-value">${g}</div>
                        <div class="stat-label">รายการ</div>
                    </div>
                    <div class="overview-stat-card">
                        <i class="ph-bold ph-coins"></i>
                        <div class="stat-value">${i}</div>
                        <div class="stat-label">ยอดรวม</div>
                    </div>
                </div>
            `,m.innerHTML=wt(d),j("#overviewModal")}}),document.querySelector(y.exportPdfBtn).addEventListener("click",async c=>{var h;c.preventDefault(),r.classList.remove("show"),(h=document.querySelector(y.menuBtn))==null||h.setAttribute("aria-expanded","false");const d=await Ft();if(!d)return;const p=O(),m=qt(p,{vatRate:d.vatOption==="include"?N.baseVatRate:0,pageBreakBuffer:d.pageBreakBuffer});if(!m){w("ไม่มีรายการที่มีราคาสำหรับสร้างเอกสาร","warning");return}d.exportMethod==="html"?Vt(m):Ut(m,d.exportMethod)}),document.querySelector("#visualReportsBtn").addEventListener("click",async c=>{var d;c.preventDefault(),r.classList.remove("show"),(d=document.querySelector(y.menuBtn))==null||d.setAttribute("aria-expanded","false"),j("#visualReportsModal")}),document.querySelector("#visualReportsConfirm").addEventListener("click",async c=>{var m;c.preventDefault();const d=document.querySelector("#visualReportsModal"),p=(m=d.querySelector('input[name="report_type_option"]:checked'))==null?void 0:m.value;if(!p){w("โปรดเลือกประเภทรายงาน","warning");return}if(d.classList.remove("visible"),p==="lookbook"){const h=O(),g=$t(h),i=document.querySelector("#lookbookModalBody");g&&i?(i.innerHTML=g,j("#lookbookModal")):w("ไม่มีข้อมูลสำหรับสร้างรายงาน","warning")}else w(`รายงานประเภท '${p}' ยังไม่พร้อมใช้งาน`,"default")}),document.querySelector(y.importBtn).addEventListener("click",c=>{var d;c.preventDefault(),r.classList.remove("show"),(d=document.querySelector(y.menuBtn))==null||d.setAttribute("aria-expanded","false"),t.click()}),t.addEventListener("change",c=>{var m;const d=(m=c.target.files)==null?void 0:m[0];if(!d)return;const p=new FileReader;p.onload=async h=>{try{const g=JSON.parse(h.target.result);await Ie(g,!0)}catch(g){w("ไฟล์ JSON ไม่ถูกต้อง","error"),console.error("JSON Parse Error:",g)}},p.readAsText(d),c.target.value=null}),document.querySelector(y.exportBtn).addEventListener("click",c=>{var d;c.preventDefault(),r.classList.remove("show"),(d=document.querySelector(y.menuBtn))==null||d.setAttribute("aria-expanded","false");try{const p=O(),m=JSON.stringify(p,null,4),h=new Blob([m],{type:"application/json"}),g=URL.createObjectURL(h),i=document.createElement("a"),f=new Date,b=`${f.getFullYear()}${(f.getMonth()+1).toString().padStart(2,"0")}${f.getDate().toString().padStart(2,"0")}`,S=`${f.getHours().toString().padStart(2,"0")}${f.getMinutes().toString().padStart(2,"0")}`,x=Qe(p.customer_name||"data");i.href=g,i.download=`MTR-${b}${S}-${x}.json`,i.click(),URL.revokeObjectURL(g),w("Export ข้อมูลสำเร็จ","success")}catch{w("Export ข้อมูลล้มเหลว","error")}}),document.querySelector("#importFavsBtn").addEventListener("click",c=>{var d;c.preventDefault(),r.classList.remove("show"),(d=document.querySelector(y.menuBtn))==null||d.setAttribute("aria-expanded","false"),n.click()}),n.addEventListener("change",c=>{var m;const d=(m=c.target.files)==null?void 0:m[0];if(!d)return;const p=new FileReader;p.onload=h=>{try{const g=JSON.parse(h.target.result),i=Xe(g);i>0?w(`เพิ่มรายการโปรดใหม่ ${i} รายการ`,"success"):w("ไม่พบรายการโปรดใหม่ที่จะเพิ่ม","default"),E()}catch(g){w("ไฟล์ JSON ไม่ถูกต้อง","error"),console.error("Favorites JSON Parse Error:",g)}},p.readAsText(d),c.target.value=null}),document.querySelector("#exportFavsBtn").addEventListener("click",c=>{var d;c.preventDefault(),r.classList.remove("show"),(d=document.querySelector(y.menuBtn))==null||d.setAttribute("aria-expanded","false");try{const p=Q(),m=JSON.stringify(p,null,4),h=new Blob([m],{type:"application/json"}),g=URL.createObjectURL(h),i=document.createElement("a"),f=new Date,b=`${f.getFullYear()}${(f.getMonth()+1).toString().padStart(2,"0")}${f.getDate().toString().padStart(2,"0")}`;i.href=g,i.download=`MTR-Favorites-${b}.json`,i.click(),URL.revokeObjectURL(g),w("Export รายการโปรดสำเร็จ","success")}catch{w("Export รายการโปรดล้มเหลว","error")}}),document.querySelector(y.submitBtn).addEventListener("click",async c=>{var d;if(c.preventDefault(),r.classList.remove("show"),(d=document.querySelector(y.menuBtn))==null||d.setAttribute("aria-expanded","false"),await ce("ส่งข้อมูล","ยืนยันการส่งข้อมูลการประเมินราคา?")){const p=O();if(!p.customer_name&&!p.customer_phone){w("กรุณาระบุชื่อหรือเบอร์โทรลูกค้า","warning");return}w("กำลังส่งข้อมูล...","default");try{const m=await fetch(lt,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(p)});m.ok?w("ส่งข้อมูลสำเร็จ!","success"):w(`ส่งข้อมูลล้มเหลว: ${m.status}`,"error")}catch{w("เกิดข้อผิดพลาดในการเชื่อมต่อ","error")}}}),document.querySelector(y.copyTextBtn).addEventListener("click",async c=>{var m;c.preventDefault(),r.classList.remove("show"),(m=document.querySelector(y.menuBtn))==null||m.setAttribute("aria-expanded","false");const d=document.querySelector(y.copyOptionsModal);d.querySelector('input[name="copy_option"][value="customer"]').checked=!0;const p=await j(y.copyOptionsModal);if(p&&!p.cancelled){const h=d.querySelector('input[name="copy_option"]:checked').value,g=St(O(),h);try{await navigator.clipboard.writeText(g),w("คัดลอกสรุปสำเร็จ!","success")}catch{w("คัดลอกล้มเหลว","error")}}}),document.querySelector(y.clearItemsBtn).addEventListener("click",async c=>{var d;c.preventDefault(),r.classList.remove("show"),(d=document.querySelector(y.menuBtn))==null||d.setAttribute("aria-expanded","false"),await ce("ล้างทุกรายการ","คุณแน่ใจหรือไม่ว่าต้องการลบรายการสินค้าทั้งหมด (ข้อมูลลูกค้าและห้องจะยังคงอยู่)?")&&(te(O()),K(),document.querySelectorAll(y.room).forEach(p=>{const m=p.querySelector(y.allItemsContainer);m&&(m.innerHTML="")}),V(),E(),w("ล้างทุกรายการแล้ว","success"))}),document.querySelector(y.clearAllBtn).addEventListener("click",async c=>{var d;if(c.preventDefault(),r.classList.remove("show"),(d=document.querySelector(y.menuBtn))==null||d.setAttribute("aria-expanded","false"),await ce("ลบข้อมูลทั้งหมด",'คำเตือน! การกระทำนี้จะลบข้อมูลลูกค้า, ทุกรายการ, และ "รายการโปรด" ทั้งหมดอย่างถาวร ยืนยันหรือไม่?')){te(O()),K(),localStorage.removeItem(ve),ht();const p=document.querySelector("#customer_name"),m=document.querySelector("#customer_phone"),h=document.querySelector("#customer_address");p&&(p.value=""),m&&(m.value=""),h&&(h.value="");const g=document.querySelector("#discount_type"),i=document.querySelector("#discount_value");g&&(g.value="amount"),i&&(i.value="0");const f=document.querySelector(y.roomsContainer);f&&(f.innerHTML=""),V(),ue(),Y(),ae();const b=document.querySelector("#customerDetailsCard");b&&(b.open=!0),w("ลบข้อมูลทั้งหมดแล้ว เริ่มต้นใหม่","success")}}),window.addEventListener("click",c=>{var d,p;c.target.closest(".modal-wrapper")||(c.target.closest(".menu-container")||(r.classList.contains("show")&&(r.classList.remove("show"),(d=document.querySelector(y.menuBtn))==null||d.setAttribute("aria-expanded","false")),a.classList.contains("show")&&(a.classList.remove("show"),(p=document.querySelector(y.quickNavBtn))==null||p.setAttribute("aria-expanded","false"))),c.target.closest(".room-options-container")||(document.querySelectorAll(".room-options-menu.show").forEach(m=>m.classList.remove("show")),document.querySelectorAll(".card.overflow-visible").forEach(m=>m.classList.remove("overflow-visible"))),c.target.closest('[data-act="toggle-more-details"]')||document.querySelectorAll(".item-details-more.show").forEach(m=>{const h=m.closest(".item-card");h&&!h.contains(c.target)&&Fe(h,!1)}),c.target.closest(".form-group-with-favorites")||we())}),window.addEventListener("beforeunload",E);try{const c=localStorage.getItem(ve);if(c&&c.length>2&&c!=="null")Ie(JSON.parse(c),!1);else{ae();const d=document.querySelector("#customerDetailsCard");d&&(d.open=!0)}}catch(c){console.error("Failed to load data from localStorage:",c),localStorage.removeItem(ve),ae()}V(),rt(),Y(),me(),K()}document.addEventListener("DOMContentLoaded",er);
