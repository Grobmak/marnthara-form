(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))t(r);new MutationObserver(r=>{for(const l of r)if(l.type==="childList")for(const n of l.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&t(n)}).observe(document,{childList:!0,subtree:!0});function a(r){const l={};return r.integrity&&(l.integrity=r.integrity),r.referrerPolicy&&(l.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?l.credentials="include":r.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function t(r){if(r.ep)return;r.ep=!0;const l=a(r);fetch(r.href,l)}})();const ct="vite-refactor/6.0.0",it="https://your-make-webhook-url.com/your-unique-path",de="marnthara.input.v6",dt=500,N={name:"ม่านธารา ผ้าม่านและของตกแต่ง",address:"65/8 หมู่ 2 ต.ท่าศาลา อ.เมือง จ.ลพบุรี 15000",phone:"092-985-9395, 082-552-5595",taxId:"1600668000020",logoUrl:"./assets/logo.png",baseVatRate:.07,pdf:{paymentTerms:"ชำระมัดจำ 50%",priceValidity:"30 วัน",notes:["ราคานี้รวมค่าติดตั้งแล้ว","ชำระมัดจำ 50% เพื่อยืนยันการสั่งผลิตสินค้า","ใบเสนอราคานี้มีอายุ 30 วัน นับจากวันที่เสนอราคา"]}},ut=1.19599,Be={ROLL_WIDTH_M:.53,ROLL_LENGTH_M:10,STRIPS_PER_ROLL_UNDER_2_5M:3},be={fabric:[1e3,1100,1200,1300,1400,1500,1600,1700,1800,1900,2e3,2100,2200],sheer:[1e3,1100,1200,1300,1400,1500],style_surcharge:{ลอน:200,ตาไก่:0,จีบ:0,ม่านพับ:0},height:[{threshold:3.2,add_per_m:300},{threshold:2.8,add_per_m:200},{threshold:2.5,add_per_m:100}]},R={set:{templateId:"#setTpl",name:"ผ้าม่าน"},wallpaper:{templateId:"#wallpaperTpl",name:"วอลล์เปเปอร์"},wooden_blind:{templateId:"#areaBasedTpl",name:"มู่ลี่ไม้"},roller_blind:{templateId:"#areaBasedTpl",name:"ม่านม้วน"},vertical_blind:{templateId:"#areaBasedTpl",name:"ม่านปรับแสง"},partition:{templateId:"#areaBasedTpl",name:"ฉากกั้นห้อง"},pleated_screen:{templateId:"#areaBasedTpl",name:"มุ้งจีบ"},aluminum_blind:{templateId:"#areaBasedTpl",name:"มู่ลี่อลูมิเนียม"}},f={orderForm:"#orderForm",roomsContainer:"#rooms",toastContainer:"#toast-container",printableContent:"#printable-content",filterStatusBar:"#filterStatusBar",menuBtn:"#menuBtn",menuDropdown:"#menuDropdown",undoBtn:"#undoBtn",themeToggleBtn:"#themeToggleBtn",overviewBtn:"#overviewBtn",copyTextBtn:"#copyTextBtn",visualReportsBtn:"#visualReportsBtn",exportPdfBtn:"#exportPdfBtn",submitBtn:"#submitBtn",importBtn:"#importBtn",exportBtn:"#exportBtn",importFavsBtn:"#importFavsBtn",exportFavsBtn:"#exportFavsBtn",clearItemsBtn:"#clearItemsBtn",clearAllBtn:"#clearAllBtn",lockBtn:"#lockBtn",quickNavBtn:"#quickNavBtn",quickNavDropdown:"#quickNavDropdown",quickNavRoomList:"#quickNavRoomList",quickNavBtnText:"#quickNavBtnText",toggleAllRoomsBtn:"#toggleAllRoomsBtn",suspendedItemsBtn:"#suspendedItemsBtn",suspendedCountBadge:"#suspendedCountBadge",originalTotal:"#originalTotal",grandTotal:"#grandTotal",fileImporter:"#fileImporter",favImporter:"#favImporter",customerCard:"#customerDetailsCard",customerNameInput:"#customer_name",customerPhoneInput:"#customer_phone",customerAddressInput:"#customer_address",room:".room-card",roomTpl:"#roomTpl",roomNameInput:'input[name="room_name"]',roomNameDisplay:"[data-room-name-display]",roomBrief:"[data-room-brief]",allItemsContainer:"[data-all-items]",itemCard:".item-card",itemDetailsMore:".item-details-more",itemGrid:".item-grid",itemTitle:"[data-item-title]",toggleDetailsBtn:'[data-act="toggle-more-details"]',setTpl:"#setTpl",setWidthInput:'input[name="width_m"]',setHeightInput:'input[name="height_m"]',setStyleSelect:'select[name="set_style"]',setFabricVariantSelect:'select[name="fabric_variant"]',setPricePerMSelect:'select[name="set_price_per_m"]',setSheerPricePerMSelect:'select[name="sheer_price_per_m"]',setFabricCodeInput:'input[name="fabric_code"]',setSheerCodeInput:'input[name="sheer_fabric_code"]',setOpeningStyleSelect:'select[name="opening_style"]',setAdjustmentSideSelect:'select[name="adjustment_side"]',setTrackColorInput:'input[name="track_color"]',setBracketColorInput:'input[name="bracket_color"]',setFinialColorInput:'input[name="finial_color"]',setGrommetColorInput:'input[name="grommet_color"]',setNotesInput:'input[name="notes"]',wallpaperTpl:"#wallpaperTpl",wallTpl:"#wallTpl",wallHeightInput:'[name="wallpaper_height_m"]',wallCodeInput:'[name="wallpaper_code"]',wallPriceRollInput:'[name="wallpaper_price_roll"]',wallInstallCostInput:'[name="wallpaper_install_cost"]',wallNotesInput:'[name="wallpaper_notes"]',wallWidthInput:'[name="wall_width_m"]',areaBasedTpl:"#areaBasedTpl",areaBasedItem:".area-based-item",areaWidthInput:'[name="area_width_m"]',areaHeightInput:'[name="area_height_m"]',areaPriceSqydInput:'[name="area_price_sqyd"]',areaCodeInput:'[name="area_code"]',areaNotesInput:'[name="area_notes"]',modal:"#confirmationModal",modalTitle:"#modalTitle",modalBody:"#modalBody",discountModal:"#discountModal",discountSubtotal:"#discountSubtotal",discountPercent:"#discountPercent",discountAmount:"#discountAmount",discountFinalTotal:"#discountFinalTotal",discountTypeInput:"#discount_type",discountValueInput:"#discount_value",copyOptionsModal:"#copyOptionsModal",visualReportsModal:"#visualReportsModal",lookbookModal:"#lookbookModal",lookbookModalBody:"#lookbookModalBody",exportOptionsModal:"#exportOptionsModal",itemTypeModal:"#itemTypeModal",itemTypeModalTitle:"#itemTypeModalTitle",hardwareModal:"#hardwareModal",modalTrackColor:'[name="modal_track_color"]',modalBracketColor:'[name="modal_bracket_color"]',modalFinialColor:'[name="modal_finial_color"]',modalGrommetColor:'[name="modal_grommet_color"]',finialColorGroup:"#finialColorGroup",grommetColorGroup:"#grommetColorGroup",hardwareApplyToRoomBtn:"#hardwareApplyToRoom",favoritesConflictModal:"#favoritesConflictModal",favoritesModal:"#favoritesModal",favoritesModalTitle:"#favoritesModalTitle",favoritesModalBody:"#favoritesModalBody",favSearchInput:"#favSearchInput",favoritesModalManageBtn:"#favoritesModalManageBtn",favSelectorItemTpl:"#favSelectorItemTpl",favInput:"input[data-favorite-type]",favManagerModal:"#favManagerModal",favManagerTitle:"#favManagerTitle",favManagerBody:"#favManagerBody",favManagerItemTpl:"#favManagerItemTpl",favManagerEditBtn:'#favManagerModal [data-act="edit-selected-fav"]',favManagerDelBtn:'#favManagerModal [data-act="del-selected-fav"]',favAddModal:"#favAddModal",favAddCodeInput:'[name="fav_code_add"]',favAddPriceInput:'[name="fav_price_add"]',favEditModal:"#favEditModal",favEditCodeInput:'[name="fav_code_edit"]',favEditPriceInput:'[name="fav_price_edit"]',overviewModal:"#overviewModal",overviewModalHeader:"#overviewModalHeader",overviewModalBody:"#overviewModalBody"},y=e=>{typeof e=="string"&&(e=e.replace(/,/g,""));const o=parseFloat(e);return Number.isFinite(o)?o:0},te=e=>{const o=y(e);return o>0?o.toFixed(2):""},U=(e,o=2,a=!1)=>Number.isFinite(e)?e.toLocaleString("en-US",{minimumFractionDigits:a?2:o,maximumFractionDigits:a?2:o}):"0",B=(e,o=0)=>Number.isFinite(e)?e.toLocaleString("th-TH",{minimumFractionDigits:o,maximumFractionDigits:o}):"0",me=(e,o=150)=>{let a;return(...t)=>{clearTimeout(a),a=setTimeout(()=>e(...t),o)}},pt=(e,o=700)=>{let a=!1;return(...t)=>{if(!a){a=!0;try{return e(...t)}finally{setTimeout(()=>{a=!1},o)}}}},T=e=>typeof e!="string"?"":e.replace(/[&<>"']/g,function(o){switch(o){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";default:return"&#039;"}}),Je=e=>typeof e!="string"?"":e.replace(/[\\/?%*:|"<>\x00-\x1f]/g,"").trim()||"file";function mt(e){let o=y(e);if(isNaN(o))return"ข้อมูลตัวเลขไม่ถูกต้อง";if(o===0)return"ศูนย์บาทถ้วน";const a=["","หนึ่ง","สอง","สาม","สี่","ห้า","หก","เจ็ด","แปด","เก้า"],t=["","สิบ","ร้อย","พัน","หมื่น","แสน","ล้าน"];let r=Math.floor(o),l=Math.round((o-r)*100);const n=d=>{if(d===0)return"";let i="";const h=String(d);for(let u=0;u<h.length;u++){const m=h[u],_=h.length-u-1;m!=="0"&&(_===1&&m==="1"?i+=t[_]:_===1&&m==="2"?i+="ยี่"+t[_]:_===0&&m==="1"&&h.length>1?i+="เอ็ด":i+=a[parseInt(m)]+t[_])}return i};let s="";if(r>0){const d=Math.floor(r/1e6),i=r%1e6;d>0&&(s+=n(d)+"ล้าน"),s+=n(i),s+="บาท"}let c="";return l>0?c=n(l)+"สตางค์":r>0&&(s+="ถ้วน"),(s+c).trim()}const Oe="marnthara.favorites.v4",ue={fabric:[],sheer:[],wallpaper:[],wooden_blind:[],roller_blind:[],vertical_blind:[],partition:[],pleated_screen:[],aluminum_blind:[]};function Z(){try{const e=localStorage.getItem(Oe);return e?{...ue,...JSON.parse(e)}:ue}catch(e){return console.error("Failed to parse favorites from localStorage",e),ue}}function qe(e){try{localStorage.setItem(Oe,JSON.stringify(e))}catch(o){console.error("Failed to save favorites to localStorage",o)}}function je(e){if(!e||typeof e!="object")return console.error("Invalid favorites data for import."),!1;const o={...ue,...e};return qe(o),!0}function Re(e){if(!e||typeof e!="object")return console.error("Invalid favorites data for merge."),0;const o=Z();let a=0;for(const t in e)Object.hasOwnProperty.call(e,t)&&Array.isArray(e[t])&&(o[t]||(o[t]=[]),e[t].forEach(r=>{!o[t].some(n=>n.code===r.code)&&r.code&&(o[t].push(r),a++)}),o[t].sort((r,l)=>r.code.localeCompare(l.code)));return a>0&&qe(o),a}function ft(e,o,a){const t=Z();if(!t[e]){if(!Object.hasOwnProperty.call(ue,e))return console.error(`Attempted to add favorite to an invalid type: ${e}`),!1;t[e]=[]}const r=t[e],l=r.find(n=>n.code===o);return l?l.price=a:r.push({code:o,price:a}),r.sort((n,s)=>n.code.localeCompare(s.code)),qe(t),!0}function Fe(e,o){const a=Z();if(!a[e])return!1;const t=a[e].findIndex(r=>r.code===o);return t>-1?(a[e].splice(t,1),qe(a),!0):!1}function Ke(e,o){if(!e||!o)return;const a=Z(),t=o.trim();return(a[e]||[]).find(l=>l.code===t)}function Qe(e,o){return!!Ke(e,o)}function ge(e,o,a){return Qe(e,o)?(Fe(e,o),!1):(ft(e,o,a),!0)}function ht(){localStorage.removeItem(Oe),console.log("All favorites have been cleared.")}function j(){const e=Z(),o={app_version:ct,customer_name:document.querySelector(f.customerNameInput)?.value||"",customer_phone:document.querySelector(f.customerPhoneInput)?.value||"",customer_address:document.querySelector(f.customerAddressInput)?.value||"",customer_card_open:document.querySelector(f.customerCard)?.open,discount:{type:document.querySelector(f.discountTypeInput)?.value||"amount",value:y(document.querySelector(f.discountValueInput)?.value)},rooms:[],favorites:e};return document.querySelectorAll(f.room).forEach(a=>{const t={id:a.id,room_name:a.querySelector(f.roomNameInput)?.value||"",is_suspended:a.classList.contains("is-suspended"),is_open:a.open,items:[]};a.querySelector(f.allItemsContainer)?.childNodes.forEach(r=>{if(r.nodeType!==1||!r.matches(f.itemCard))return;const l=r.dataset.type;if(!l)return;let n={type:l,is_suspended:r.classList.contains("is-suspended")};l==="set"?Object.assign(n,{width_m:y(r.querySelector(f.setWidthInput)?.value),height_m:y(r.querySelector(f.setHeightInput)?.value),style:r.querySelector(f.setStyleSelect)?.value||"",fabric_variant:r.querySelector(f.setFabricVariantSelect)?.value||"",price_per_m_raw:y(r.querySelector(f.setPricePerMSelect)?.value),sheer_price_per_m:y(r.querySelector(f.setSheerPricePerMSelect)?.value),fabric_code:r.querySelector(f.setFabricCodeInput)?.value||"",sheer_fabric_code:r.querySelector(f.setSheerCodeInput)?.value||"",opening_style:r.querySelector(f.setOpeningStyleSelect)?.value||"",adjustment_side:r.querySelector(f.setAdjustmentSideSelect)?.value||"ปรับขวา",track_color:r.querySelector(f.setTrackColorInput)?.value||"ขาว",bracket_color:r.querySelector(f.setBracketColorInput)?.value||"ขาว",finial_color:r.querySelector(f.setFinialColorInput)?.value||"ขาว",grommet_color:r.querySelector(f.setGrommetColorInput)?.value||"เงิน",notes:r.querySelector(f.setNotesInput)?.value||""}):l==="wallpaper"?Object.assign(n,{height_m:y(r.querySelector(f.wallHeightInput)?.value),wallpaper_code:r.querySelector(f.wallCodeInput)?.value||"",price_per_roll:y(r.querySelector(f.wallPriceRollInput)?.value),install_cost_per_roll:y(r.querySelector(f.wallInstallCostInput)?.value),notes:r.querySelector(f.wallNotesInput)?.value||"",widths:Array.from(r.querySelectorAll(f.wallWidthInput)).map(s=>y(s.value))}):r.matches(f.areaBasedItem)&&(Object.assign(n,{width_m:y(r.querySelector(f.areaWidthInput)?.value),height_m:y(r.querySelector(f.areaHeightInput)?.value),price_sqyd:y(r.querySelector(f.areaPriceSqydInput)?.value),code:r.querySelector(f.areaCodeInput)?.value||"",notes:r.querySelector(f.areaNotesInput)?.value||""}),(l==="partition"||l==="pleated_screen")&&(n.opening_style=r.querySelector(f.setOpeningStyleSelect)?.value||"แยกกลาง"),["wooden_blind","roller_blind","vertical_blind","aluminum_blind"].includes(l)&&(n.adjustment_side=r.querySelector(f.setAdjustmentSideSelect)?.value||"ปรับขวา")),t.items.push(n)}),o.rooms.push(t)}),o}function V(){try{const e=j();localStorage.setItem(de,JSON.stringify(e))}catch(e){console.error("Failed to save data to localStorage:",e)}}const se=[],vt=10;function oe(e){if(!e){console.warn("Attempted to push invalid state to undo stack.");return}try{const o=JSON.parse(JSON.stringify(e));se.push(o),se.length>vt&&se.shift()}catch(o){console.error("Failed to clone state for undo history:",o)}}function yt(){if(se.length!==0)return se.pop()}function gt(){return se.length>0}const E={stylePlus:e=>be.style_surcharge[e]??0,heightPlus:e=>{const o=[...be.height].sort((a,t)=>t.threshold-a.threshold);for(const a of o)if(e>a.threshold)return a.add_per_m;return 0},fabricYardage:(e,o)=>{const a=y(o);return a<=0||!e?0:e==="ตาไก่"||e==="จีบ"?(a*2+.6)/.9:e==="ลอน"?(a*2.6+.6)/.9:e==="ม่านพับ"?(a+.3)/.9:0},calculateGrommets:function(e){if(!e||e.style!=="ตาไก่"||y(e.width_m)<=0)return 0;const o=y(e.width_m),a=2,t=.05,r=.16;let l;e.opening_style==="แยกกลาง"?l=o/2:l=o;const n=l*a+2*t;let s=Math.round(n/r);return s%2!==0&&(s+=1),s<4&&(s=4),e.opening_style==="แยกกลาง"?s*2:s},wallpaperRolls:(e,o)=>{const a=y(e),t=y(o);if(a<=0||t<=0)return 0;const r=t>2.5?Math.floor(Be.ROLL_LENGTH_M/t):Be.STRIPS_PER_ROLL_UNDER_2_5M;if(r<=0)return 0;const l=Math.ceil(a/Be.ROLL_WIDTH_M);return Math.ceil(l/r)},calculateSetPrice:function(e){if(!e||e.is_suspended||y(e.width_m)<=0)return{total:0,opaque:0,sheer:0};const o=this.stylePlus(e.style),a=this.heightPlus(y(e.height_m)),t=y(e.width_m),r=y(e.price_per_m_raw),l=y(e.sheer_price_per_m),n=e.fabric_variant?.includes("ทึบ")&&r>0?(r+o+a)*t:0,s=e.fabric_variant?.includes("โปร่ง")&&l>0?(l+o+a)*t:0;return{total:Math.round(n+s),opaque:Math.round(n),sheer:Math.round(s)}},calculateAreaBasedPrice:function(e){if(!e||e.is_suspended||y(e.width_m)<=0||y(e.height_m)<=0)return{total:0,sqm:0,sqyd:0};const o=y(e.width_m)*y(e.height_m),a=o*ut,t=a*y(e.price_sqyd);return{total:Math.round(t),sqm:o,sqyd:a}},calculateWallpaperPrice:function(e){if(!e||e.is_suspended)return{total:0,material:0,install:0,rolls:0,sqm:0};const o=e.widths?.reduce((s,c)=>s+y(c),0)||0;if(o<=0)return{total:0,material:0,install:0,rolls:0,sqm:0};const a=y(e.height_m),t=this.wallpaperRolls(o,a),r=t*y(e.price_per_roll),l=e.install_cost_per_roll===""||e.install_cost_per_roll===null||e.install_cost_per_roll===void 0?300:y(e.install_cost_per_roll),n=t*l;return{total:Math.round(r+n),material:Math.round(r),install:Math.round(n),rolls:t,sqm:o*a}}},re=Object.entries(R).reduce((e,[o,a])=>(e[o]=a.name,e),{});function ne(e){const{width:o=0,height:a=0}=e,t=15,r=100-t*2,l=100-t*2,n=o>0&&a>0?Math.min(r/o,l/a):1,s=o*n,c=a*n,d=(100-s)/2,i=(100-c)/2,h=`
        <line x1="${d}" y1="${i+c+5}" x2="${d+s}" y2="${i+c+5}" class="dimension-line" />
        <line x1="${d}" y1="${i+c+3}" x2="${d}" y2="${i+c+7}" class="dimension-tick" />
        <line x1="${d+s}" y1="${i+c+3}" x2="${d+s}" y2="${i+c+7}" class="dimension-tick" />
        <text x="50" y="${i+c+14}" class="dimension-text">${o.toFixed(2)} ม.</text>

        <line x1="${d-5}" y1="${i}" x2="${d-5}" y2="${i+c}" class="dimension-line" />
        <line x1="${d-7}" y1="${i}" x2="${d-3}" y2="${i}" class="dimension-tick" />
        <line x1="${d-7}" y1="${i+c}" x2="${d-3}" y2="${i+c}" class="dimension-tick" />
        <text x="${d-9}" y="50" class="dimension-text" transform="rotate(-90, ${d-9}, 50)">${a.toFixed(2)} ม.</text>
    `;return{x:d,y:i,svgWidth:s,svgHeight:c,lines:h}}function Xe(e,{y:o,svgHeight:a}){if(!e.opening_style||e.opening_style==="สไลด์เดี่ยว")return"";const t=e.opening_style==="แยกกลาง"?"< >":"→";return`
        <rect x="40" y="${o+a/2-8}" width="20" height="16" rx="3" class="opening-text-bg" />
        <text x="50" y="${o+a/2+1}" class="opening-text">${t}</text>
    `}function $e(e,{x:o,y:a,svgWidth:t}){if(!e.adjustment_side)return"";const l=e.adjustment_side==="ปรับซ้าย"?o+8:o+t-8;return`
        <g class="adjustment-cord">
            <circle cx="${l}" cy="${a+3}" r="2"/>
            <line x1="${l}" y1="${a+5}" x2="${l}" y2="${a+15}"/>
        </g>
    `}function _t(e){const o=y(e.width_m),a=y(e.height_m);if(o<=0||a<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:t,y:r,svgWidth:l,svgHeight:n,lines:s}=ne({width:o,height:a});let c="";const d=e.fabric_variant.includes("โปร่ง"),i=e.fabric_variant.includes("ทึบ"),h=(_,x)=>(e.opening_style||"แยกกลาง")==="แยกกลาง"?`
                <rect x="${t}" y="${r+x}" width="${l/2-1}" height="${n}" class="${_}" />
                <rect x="${t+l/2+1}" y="${r+x}" width="${l/2-1}" height="${n}" class="${_}" />
            `:`<rect x="${t}" y="${r+x}" width="${l}" height="${n}" class="${_}" />`;d&&(c+=h("curtain-panel-sheer",0)),i&&(c+=h("curtain-panel-opaque",d?-2:0));let u="";if(e.style==="ตาไก่"){const _=E.calculateGrommets(e)/(e.opening_style==="แยกกลาง"?2:1),x=Math.min(Math.floor(_),Math.max(8,Math.floor(l/8)));for(let g=0;g<x;g++){const p=t+l/(x>1?x-1:1)*g;u+=`<circle cx="${p}" cy="${r+2}" r="2" class="style-grommet" />`}}else if(e.style==="ลอน"){const _=Math.max(4,Math.floor(l/10));let x=`M ${t},${r}`;for(let g=0;g<_;g++)x+=" q 5,-4 10,0";u=`<path d="${x}" class="style-ripplefold-path" />`}else e.style==="จีบ"&&(u=`<text x="${t+2}" y="${r+5}" class="style-pleat-text">||| ||| ||| ||| |||</text>`);const m=Xe(e,{y:r,svgHeight:n});return`<svg viewBox="0 0 100 100">${c}${u}${m}${s}</svg>`}function St(e){const o=y(e.width_m),a=y(e.height_m);if(o<=0||a<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:t,y:r,svgWidth:l,svgHeight:n,lines:s}=ne({width:o,height:a});let c=`<rect x="${t}" y="${r}" width="${l}" height="${n}" class="blind-frame" />`;const d=5,i=n/d;for(let u=0;u<d;u++)c+=`<rect x="${t+1}" y="${r+u*i}" width="${l-2}" height="${i-1.5}" class="blind-slat" />`;const h=$e(e,{x:t,y:r,svgWidth:l});return`<svg viewBox="0 0 100 100">${c}${s}${h}</svg>`}function We(e,o=!1){const a=y(e.width_m),t=y(e.height_m);if(a<=0||t<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:r,y:l,svgWidth:n,svgHeight:s,lines:c}=ne({width:a,height:t});let d=`<rect x="${r}" y="${l}" width="${n}" height="${s}" class="blind-frame" />`;if(o){const h=Math.max(4,Math.floor(n/8)),u=n/h;for(let m=0;m<h;m++)d+=`<rect x="${r+m*u+1}" y="${l}" width="${u-2}" height="${s}" class="blind-slat" />`}else{const h=Math.max(3,Math.floor(s/6)),u=s/h;for(let m=0;m<h;m++)d+=`<rect x="${r+1}" y="${l+m*u+.5}" width="${n-2}" height="${u-1}" class="blind-slat" />`}const i=$e(e,{x:r,y:l,svgWidth:n});return`<svg viewBox="0 0 100 100">${d}${c}${i}</svg>`}function bt(e){const o=y(e.width_m),a=y(e.height_m);if(o<=0||a<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:t,y:r,svgWidth:l,svgHeight:n,lines:s}=ne({width:o,height:a});let c=`<rect x="${t}" y="${r}" width="${l}" height="${n}" class="blind-frame" />`;const d=Math.max(3,Math.floor(n/8)),i=n/d;for(let g=0;g<d;g++)c+=`<rect x="${t+1}" y="${r+g*i}" width="${l-2}" height="${i-1.5}" rx="0.5" class="wooden-blind-slat" />`;const h=Math.max(2,l*.05),u=t+l*.25-h/2,m=t+l*.75-h/2,_=`
        <rect x="${u}" y="${r}" width="${h}" height="${n}" class="wooden-blind-strip" />
        <rect x="${m}" y="${r}" width="${h}" height="${n}" class="wooden-blind-strip" />
    `,x=$e(e,{x:t,y:r,svgWidth:l});return`<svg viewBox="0 0 100 100">${c}${_}${s}${x}</svg>`}function wt(e){const o=y(e.width_m),a=y(e.height_m);if(o<=0||a<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:t,y:r,svgWidth:l,svgHeight:n,lines:s}=ne({width:o,height:a}),c=`
        <rect x="${t}" y="${r}" width="${l}" height="${n}" class="roller-fabric" />
        <rect x="${t-1}" y="${r-4}" width="${l+2}" height="5" rx="2" class="roller-roll" />
        <line x1="${t}" y1="${r+n}" x2="${t+l}" y2="${r+n}" class="roller-bar" />
    `,d=$e(e,{x:t,y:r-2,svgWidth:l});return`<svg viewBox="0 0 100 100">${c}${s}${d}</svg>`}function Ve(e,o=!1){const a=y(e.width_m),t=y(e.height_m);if(a<=0||t<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:r,y:l,svgWidth:n,svgHeight:s,lines:c}=ne({width:a,height:t});let d="";if(o)d=`
            <defs>
                <pattern id="pleated-mesh" width="6" height="6" patternUnits="userSpaceOnUse">
                    <path d="M -1 1 L 1 -1 M 0 6 L 6 0" class="pleated-screen-mesh" />
                </pattern>
            </defs>
            <rect x="${r}" y="${l}" width="${n}" height="${s}" class="blind-frame" />
            <rect x="${r}" y="${l}" width="${n}" height="${s}" fill="url(#pleated-mesh)" />
        `;else{const h=Math.max(4,Math.floor(n/10)),u=n/h;for(let m=0;m<h;m++)d+=`<rect x="${r+m*u}" y="${l}" width="${u}" height="${s}" class="partition-panel" />`,m>0&&(d+=`<line x1="${r+m*u}" y1="${l}" x2="${r+m*u}" y2="${l+s}" class="partition-hinge" />`)}const i=Xe(e,{y:l,svgHeight:s});return`<svg viewBox="0 0 100 100">${d}${i}${c}</svg>`}function qt(e){const o=(e.widths||[]).reduce((u,m)=>u+y(m),0),a=y(e.height_m);if(o<=0||a<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:t,y:r,svgWidth:l,svgHeight:n,lines:s}=ne({width:o,height:a});let c="";const d=Math.floor(l/10),i=Math.floor(n/10);for(let u=0;u<i;u++)for(let m=0;m<d;m++)c+=`<circle cx="${t+m*10+5}" cy="${r+u*10+5}" r="1.5" class="wallpaper-pattern" />`;return`<svg viewBox="0 0 100 100">${`<rect x="${t}" y="${r}" width="${l}" height="${n}" class="blind-frame" /> ${c}`}${s}</svg>`}function $t(e,o,a){let t="";switch(e.type){case"set":e.style==="ม่านพับ"?t=St(e):t=_t(e);break;case"wooden_blind":t=bt(e);break;case"aluminum_blind":t=We(e,!1);break;case"vertical_blind":t=We(e,!0);break;case"roller_blind":t=wt(e);break;case"partition":t=Ve(e,!1);break;case"pleated_screen":t=Ve(e,!0);break;case"wallpaper":t=qt(e);break;default:const r=re[e.type]||"ของตกแต่ง";t=`<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">${T(r)}</text></svg>`;break}return`<div class="visual-placeholder is-clickable"
                 data-act="jump-to-item"
                 data-room-id="${o}"
                 data-item-index="${a}"
                 title="คลิกเพื่อไปยังรายการนี้">${t}</div>`}function Ue(e){let o=`
📃 *สรุปรายการสินค้า*
`,a=!1;return e.rooms.forEach(t=>{if(t.is_suspended||!t.items)return;const r=t.items.filter(n=>n.is_suspended?!1:n.type==="wallpaper"?(n.widths||[]).reduce((s,c)=>s+y(c),0)>0:n.type==="set"||R[n.type]?.templateId==="#areaBasedTpl"?y(n.width_m)>0:!0);if(r.length===0)return;a=!0,o+=`
*🚪 ห้อง: ${t.room_name||"ไม่ระบุ"}*
`;let l=0;r.forEach(n=>{l++;const s=re[n.type]||"สินค้าตกแต่ง";n.type==="set"?o+=` ${l}) ${s} ${n.style||""} (${n.fabric_variant||""})
`:o+=` ${l}) ${s}
`})}),a?o+`------------------------------
`:""}function ze(e){return e.rooms.reduce((o,a)=>{if(a.is_suspended)return o;const t=a.items?.reduce((r,l)=>{if(l.is_suspended)return r;switch(l.type){case"set":return r+E.calculateSetPrice(l).total;case"wallpaper":return r+E.calculateWallpaperPrice(l).total;default:return R[l.type]?.templateId==="#areaBasedTpl"?r+E.calculateAreaBasedPrice(l).total:r}},0)||0;return o+t},0)}function kt(e,o){const a=ze(e);let t=0,r="";e.discount&&e.discount.value>0&&(e.discount.type==="percent"?(t=a*(e.discount.value/100),r=`🏷️ ส่วนลด (${e.discount.value}%): -${B(t)} บาท
`):(t=e.discount.value,r=`🏷️ ส่วนลด: -${B(t)} บาท
`));const l=a-t;let n=`🗓️ สรุปข้อมูล (${new Date().toLocaleDateString("th-TH",{day:"numeric",month:"short",year:"2-digit"})})
`;if(n+=`👤 ลูกค้า: ${e.customer_name||"-"}
`,(o==="customer"||o==="owner")&&(n+=`📞 โทร: ${e.customer_phone||"-"}
`,n+=`🏠 ที่อยู่: ${e.customer_address||"-"}
`),n+=`------------------------------
`,o==="customer")return n+=Ue(e),t>0&&(n+=`
ยอดรวม: ${B(a)} บาท
`,n+=r),n+=`
💰 *ยอดสุทธิ: ${B(l)} บาท*
`,n+=`
ขอบคุณที่ใช้บริการค่ะ
${N.name}
โทร: ${N.phone}`,n;if(o==="purchase_order"||o==="owner"){o==="owner"&&(n+=Ue(e));const s={opaqueFabrics:[],sheerFabrics:[],wallpapers:[],allSets:[]};e.rooms.forEach(p=>{p.is_suspended||!p.items||p.items.forEach(v=>{let k=!v.is_suspended;if(v.type==="set"||R[v.type]?.templateId==="#areaBasedTpl")k=k&&y(v.width_m)>0&&y(v.height_m)>0;else if(v.type==="wallpaper"){const S=(v.widths||[]).reduce((b,I)=>b+y(I),0);k=k&&S>0&&y(v.height_m)>0}if(k)switch(v.type){case"set":s.allSets.push(v),v.fabric_variant.includes("ทึบ")&&s.opaqueFabrics.push({code:v.fabric_code||"??",yards:E.fabricYardage(v.style,v.width_m)}),v.fabric_variant.includes("โปร่ง")&&s.sheerFabrics.push({code:v.sheer_fabric_code||"??",yards:E.fabricYardage(v.style,v.width_m)});break;case"wallpaper":const S=(v.widths||[]).reduce((I,q)=>I+y(q),0),b=E.wallpaperRolls(S,v.height_m);b>0&&s.wallpapers.push({code:v.wallpaper_code||"xxx",rolls:b});break;default:if(R[v.type]?.templateId==="#areaBasedTpl"){const I=v.type;s[I]||(s[I]=[]),s[I].push({code:v.code||"xxx",width:y(v.width_m),height:y(v.height_m),opening_style:v.opening_style,adjustment_side:v.adjustment_side})}break}})});const c={};if([...s.opaqueFabrics,...s.sheerFabrics].forEach(p=>{p.yards>0&&(c[p.code]=(c[p.code]||0)+p.yards)}),Object.keys(c).length>0){n+=`✂️ *รายการสั่งซื้อ (ผ้า)*
`,n+=`------------------------------
`,s.opaqueFabrics.filter(p=>p.yards>0).forEach(p=>{n+=`- ผ้าทึบ (Curtain)
`,n+=`  รหัส: #${p.code||"??"}
`,n+=`  จำนวน: ${p.yards.toFixed(2)} หลา

`}),s.sheerFabrics.filter(p=>p.yards>0).forEach(p=>{n+=`- ผ้าโปร่ง (Sheer)
`,n+=`  รหัส: #${p.code||"??"}
`,n+=`  จำนวน: ${p.yards.toFixed(2)} หลา

`}),n+=`------------------------------
`,n+=`📊 *สรุปยอดรวมผ้า (ตามรหัส)*
`,n+=`------------------------------
`;for(const[p,v]of Object.entries(c))n+=`  - รหัส #${p}: ${v.toFixed(2)} หลา
`;n+=`
`}const d=s.allSets.filter(p=>p.style==="ม่านพับ"),i=s.allSets.filter(p=>p.style==="ตาไก่"),h=s.allSets.filter(p=>p.style!=="ตาไก่"&&p.style!=="ม่านพับ");if(d.length>0){n+=`------------------------------
`,n+=`📏 *รายการสั่งซื้อ รางม่านพับ*
`,n+=`------------------------------

`;let p=1;d.forEach(S=>{n+=`(${p++}) รางม่านพับ
`,n+=`  - ขนาด: ${Number(S.width_m).toFixed(2)} ม.
`,n+=`  - สีราง: ${S.track_color||"ขาว"}
`,n+=`  - เชือกปรับ: ${S.adjustment_side||"ปรับขวา"}
`,S.notes&&o==="owner"&&(n+=`  📝 หมายเหตุ: ${S.notes}
`),n+=`
`});const v=d.reduce((S,b)=>{const I=Number(b.width_m).toFixed(2);return S[I]=(S[I]||0)+1,S},{}),k=Object.entries(v).sort((S,b)=>parseFloat(b[0])-parseFloat(S[0]));if(k.length>0){n+=`--- สรุปยอดรวมรางม่านพับ ---
`,n+=`*จำนวนรางที่ต้องตัด:*
`;for(const[S,b]of k)n+=`  - ขนาด ${S} ม. = ${b} เส้น
`;n+=`
`}}if(h.length>0){n+=`------------------------------
`,n+=`📏 *รายการสั่งซื้อ ราง (ลอน/จีบ)*
`,n+=`------------------------------

`;let p=1;h.forEach(b=>{n+=`(${p++}) ราง ${b.style}, สี: ${b.track_color||"ขาว"}
`,b.fabric_variant.includes("ทึบ")&&(n+=`  - รางทึบ: ${Number(b.width_m).toFixed(2)} ม.
`),b.fabric_variant.includes("โปร่ง")&&(n+=`  - รางโปร่ง: ${Number(b.width_m).toFixed(2)} ม.
`),b.notes&&o==="owner"&&(n+=`  📝 หมายเหตุ: ${b.notes}
`),n+=`
`});const v=[];h.forEach(b=>{b.fabric_variant.includes("ทึบ")&&v.push(Number(b.width_m)),b.fabric_variant.includes("โปร่ง")&&v.push(Number(b.width_m))});const k=v.reduce((b,I)=>{const q=I.toFixed(2);return b[q]=(b[q]||0)+1,b},{}),S=Object.entries(k).sort((b,I)=>parseFloat(I[0])-parseFloat(b[0]));if(S.length>0){n+=`--- สรุปยอดรวมรางลอน/จีบ ---
`,n+=`*จำนวนรางที่ต้องตัด:*
`;for(const[b,I]of S)n+=`  - ขนาด ${b} ม. = ${I} เส้น
`;n+=`
`}}if(i.length>0){n+=`------------------------------
`,n+=`📏 *รายการสั่งซื้อ ราง (ตาไก่)*
`,n+=`------------------------------

`;let p=1;i.forEach(q=>{n+=`(${p++}) ราง ${q.style}, สี: ${q.track_color||"ขาว"}
`,q.fabric_variant.includes("ทึบ")&&(n+=`  - รางทึบ: ${Number(q.width_m).toFixed(2)} ม.
`),q.fabric_variant.includes("โปร่ง")&&(n+=`  - รางโปร่ง: ${Number(q.width_m).toFixed(2)} ม.
`),q.notes&&o==="owner"&&(n+=`  📝 หมายเหตุ: ${q.notes}
`),n+=`
`}),n+=`--- สรุปยอดรวมรางตาไก่ ---
`;const v=[];i.forEach(q=>{q.fabric_variant.includes("ทึบ")&&v.push(Number(q.width_m)),q.fabric_variant.includes("โปร่ง")&&v.push(Number(q.width_m))});const k=6;v.sort((q,$)=>$-q);const S=[];for(const q of v){let $=!1;for(let M=0;M<S.length;M++)if(S[M]>=q-.001){S[M]-=q,$=!0;break}$||S.push(k-q)}n+=`ใช้รางเต็ม (6 ม.) ทั้งหมด: *${S.length} เส้น*

`;const b=v.reduce((q,$)=>{const M=$.toFixed(2);return q[M]=(q[M]||0)+1,q},{}),I=Object.entries(b).sort((q,$)=>parseFloat($[0])-parseFloat(q[0]));if(I.length>0){n+=`*สรุปจำนวนรางที่ต้องตัด:*
`;for(const[q,$]of I)n+=`  - ขนาด ${q} ม. = ${$} เส้น
`;n+=`
`}}const u={};s.allSets.forEach(p=>{const v=p.track_color||"ขาว",k=p.style,S=p.fabric_variant==="ทึบ&โปร่ง",b=y(p.width_m)>=1.6?3:2;if(u[v]||(u[v]={brackets:{},finials:0,grommets:{}}),u[v].brackets[k]||(u[v].brackets[k]={single:0,double:0}),k!=="ม่านพับ"&&(S?u[v].brackets[k].double+=b:u[v].brackets[k].single+=b),k==="ตาไก่"){const I=S?4:2;u[v].finials+=I}if(k==="ตาไก่"){const I=p.grommet_color||"เงิน",q=E.calculateGrommets(p);u[v].grommets[I]||(u[v].grommets[I]=0),u[v].grommets[I]+=q}});const m=s.allSets.filter(p=>p.style!=="ม่านพับ").length*2;if(Object.values(u).some(p=>Object.values(p.brackets).some(v=>v.single>0||v.double>0)||p.finials>0||Object.values(p.grommets).some(v=>v>0))||m>0){n+=`------------------------------
`,n+=`🔩 *รายการสั่งซื้อ อุปกรณ์ (Hardware)*
`,n+=`------------------------------

`;for(const[p,v]of Object.entries(u)){let k=!1,S=`**สี${p}**
`;const b=Object.keys(v.brackets);if(b.length>0){let q="";b.forEach($=>{$!=="ม่านพับ"&&(v.brackets[$].single>0||v.brackets[$].double>0)&&(q+=`    - ${$} (ชั้นเดียว): ${v.brackets[$].single} ตัว
`,q+=`    - ${$} (2ชั้น): ${v.brackets[$].double} ตัว
`)}),q&&(k=!0,S+=`  - ขาจับ:
${q}`)}v.finials>0&&(k=!0,S+=`  - หัวราง (ตาไก่): ${v.finials} ตัว
`);const I=Object.keys(v.grommets);if(I.length>0){let q="";I.forEach($=>{const M=v.grommets[$];M>0&&(q+=`    - สี${$}: ${M} ตัว
`)}),q&&(k=!0,S+=`  - ตาไก่:
${q}`)}k&&(n+=S+`
`)}m>0&&(n+=`**อุปกรณ์รวม**
`,n+=`  - ตะขอรวบม่าน: ${m} ตัว

`)}const x=Object.keys(s).filter(p=>!["opaqueFabrics","sheerFabrics","wallpapers","allSets"].includes(p));x.length>0&&x.sort().forEach(p=>{const v=s[p],k=re[p]||p;n+=`------------------------------
`,n+=`📦 *รายการสั่งซื้อ ${k}*
`,n+=`------------------------------

`,v.forEach(S=>{n+=`- รหัส: #${S.code||"xxx"}
  ขนาด: ${S.width.toFixed(2)} x ${S.height.toFixed(2)} ม.
`,S.opening_style&&(n+=`  รูปแบบเปิด: ${S.opening_style}
`),S.adjustment_side&&(n+=`  เชือกปรับ: ${S.adjustment_side}
`),n+=`
`})});const g={};if(s.wallpapers.forEach(p=>{g[p.code]=(g[p.code]||0)+p.rolls}),Object.keys(g).length>0){n+=`------------------------------
`,n+=`🎨 *รายการสั่งซื้อ (Wallpaper)*
`,n+=`------------------------------

`;for(const[p,v]of Object.entries(g))n+=`  - รหัส #${p}: ${v} ม้วน
`;n+=`
`}if(o==="purchase_order")return n+=`------------------------------
`,n}if(o==="seamstress"||o==="owner"){n+=`
🧵 *รายละเอียดสำหรับช่างเย็บผ้า*
`;let s=0;if(e.rooms.forEach(c=>{if(c.is_suspended||!c.items)return;const d=c.items.filter(i=>i.type==="set"&&!i.is_suspended&&y(i.width_m)>0&&y(i.height_m)>0);d.length!==0&&(s>0&&(n+=`==============================
`),n+=`
*🚪 ห้อง: ${c.room_name||"ไม่ระบุ"}*

`,d.forEach((i,h)=>{h>0&&(n+=`--------------------
`),n+=`*ชุดที่ ${h+1}/${d.length}: ${i.style} ${i.fabric_variant}*
`,i.style==="ม่านพับ"?n+=`  - เชือกปรับ: ${i.adjustment_side||"ปรับขวา"}
`:n+=`  - รูปแบบเปิด: ${i.opening_style||"แยกกลาง"}
`,i.fabric_variant.includes("ทึบ")&&(n+=`  - ผ้าทึบ: #${i.fabric_code||"-"}
`),i.fabric_variant.includes("โปร่ง")&&(n+=`  - ผ้าโปร่ง: #${i.sheer_fabric_code||"-"}
`),n+=`  - ขนาด: กว้าง ${Number(i.width_m).toFixed(2)} x สูง ${Number(i.height_m).toFixed(2)} ม.
`,i.notes&&o==="owner"&&(n+=`  📝 หมายเหตุ: ${i.notes}
`)}),n+=`
`,s++)}),s>0?n+=`==============================
`:n+=`ไม่มีรายการสำหรับช่าง
------------------------------
`,o==="seamstress")return n}return o==="owner"&&(n+=`
💰 *สรุปยอดรวม: ${B(l)} บาท*
`,t>0&&(n+=`   (ยอดก่อนลด: ${B(a)} บาท ${r.trim()})
`)),n}function xt(e){if(!e.rooms||e.rooms.length===0)return'<p class="empty-summary">ไม่มีข้อมูลสำหรับแสดงผล</p>';let o="";const a={};let t=0;if(e.rooms.forEach(n=>{n.is_suspended||!n.items||n.items.forEach(s=>{if(s.is_suspended)return;let c=null,d=0;switch(s.type){case"set":d=E.calculateSetPrice(s).total,d>0&&(c=s.type);break;case"wallpaper":d=E.calculateWallpaperPrice(s).total,d>0&&(c=s.type);break;default:R[s.type]?.templateId==="#areaBasedTpl"&&(d=E.calculateAreaBasedPrice(s).total,d>0&&(c=s.type));break}c&&(a[c]=(a[c]||0)+1,t++)})}),t>0){const n=Object.entries(a).map(([s,c])=>{const d=re[s]||"ของตกแต่ง";return`
                <span class="summary-tag" data-filter-type="${T(s)}" title="คลิกเพื่อกรองเฉพาะรายการนี้">
                    ${T(d)} <strong>${c}</strong>
                </span>`}).join("");n&&(o+=`
                <div class="overview-summary-group">
                    <h4><i class="ph ph-stack"></i> สรุปประเภทรายการ</h4>
                    <div class="summary-tags-container">
                        ${n}
                    </div>
                </div>`)}let r="",l=0;return e.rooms.forEach(n=>{if(n.is_suspended||!n.items)return;const s={};let c=0;if(n.items.forEach(d=>{if(d.is_suspended)return;let i=null,h=0;switch(d.type){case"set":h=E.calculateSetPrice(d).total,h>0&&(i=d.type);break;case"wallpaper":h=E.calculateWallpaperPrice(d).total,h>0&&(i=d.type);break;default:R[d.type]?.templateId==="#areaBasedTpl"&&(h=E.calculateAreaBasedPrice(d).total,h>0&&(i=d.type));break}i&&(s[i]=(s[i]||0)+1,c++)}),c>0){l+=c;const d=Object.entries(s).map(([i,h])=>`
                    <div class="overview-item">
                        <span>${T(re[i]||"ของตกแต่ง")}</span>
                        <span>${h}</span>
                    </div>`).join("");r+=`
                <details class="overview-room-card">
                    <summary class="overview-room-summary">
                        <span class="room-name">${T(n.room_name)||"ไม่ระบุชื่อห้อง"}</span>
                        <div class="summary-tags">
                            <span class="room-item-count">${c} รายการ</span>
                            <i class="ph ph-caret-down expand-icon"></i>
                        </div>
                    </summary>
                    <div class="overview-room-items">${d}</div>
                </details>`}}),r&&(o+=`
            <div class="overview-breakdown-group">
                <h4><i class="ph ph-map-pin-line"></i> แจกแจงตามห้อง</h4>
                ${r}
            </div>`),t===0&&l===0?'<p class="empty-summary">ไม่มีรายการที่มีราคาสำหรับแสดงผล</p>':o}function It(e,o){const{vatRate:a=N.baseVatRate,pageBreakBuffer:t=3}=o,r=[];e.rooms.forEach($=>{if($.is_suspended||!$.items)return;const M=[];$.items.forEach(L=>{if(L.is_suspended)return;let C="",A=0,F=0,P=0,ee=1;const ae=re[L.type]||"สินค้าตกแต่ง";switch(L.type){case"set":A=E.calculateSetPrice(L).total,A>0&&(F=y(L.width_m),P=y(L.height_m),C=`${ae} ${T(L.style||"")} (${T(L.fabric_variant||"")}) <br><small>ขนาด ${F.toFixed(2)} x ${P.toFixed(2)} ม.${L.notes?` - ${T(L.notes)}`:""}</small>`,ee=1.5);break;case"wallpaper":if(A=E.calculateWallpaperPrice(L).total,A>0){const Me=(L.widths||[]).reduce((st,lt)=>st+y(lt),0),J=E.wallpaperRolls(Me,L.height_m);P=y(L.height_m),C=`${ae} <br><small>รหัส: ${T(L.wallpaper_code)||"-"}, สูง ${P.toFixed(2)} ม. (ใช้ ${J} ม้วน)</small>`,ee=1.5}break;default:R[L.type]?.templateId==="#areaBasedTpl"&&(A=E.calculateAreaBasedPrice(L).total,A>0&&(F=y(L.width_m),P=y(L.height_m),C=`${ae} <br><small>รหัส: ${T(L.code)||"-"}, ขนาด ${F.toFixed(2)} x ${P.toFixed(2)} ม.</small>`,ee=1.5));break}A>0&&C&&M.push({description:C,total:A,units:ee})}),M.length>0&&(r.push({isRoomHeader:!0,roomName:T($.room_name)||"ไม่ระบุชื่อห้อง",units:1.2}),r.push(...M))});const l=r.reduce(($,M)=>$+(M.total||0),0);if(l===0)return null;let n=0,s="",c=l;e.discount&&e.discount.value>0&&(e.discount.type==="percent"?(n=l*(e.discount.value/100),s=`<tr><td class="pdf-label">ส่วนลด (${e.discount.value}%)</td><td class="pdf-amount">-${U(n,2,!0)}</td></tr>`):(n=e.discount.value,s=`<tr><td class="pdf-label">ส่วนลด</td><td class="pdf-amount">-${U(n,2,!0)}</td></tr>`),c=l-n);const d=c*a,i=c+d,h=17,u=23,m=[];let _=[],x=0;r.forEach(($,M)=>{const L=m.length===0?h:u,C=x+$.units>L;let A=!1;if(!C&&M<r.length-1){const F=L-(x+$.units),P=r[M+1].units||1;F>0&&F<t&&F<P&&($.isRoomHeader&&F<1.5||(A=!0))}(C||A)&&_.length>0&&(m.push(_),_=[],x=0),_.push($),x+=$.units}),_.length>0&&m.push(_);const g=new Date,p=g.toLocaleDateString("th-TH",{year:"numeric",month:"long",day:"numeric"}),v=`QT-${g.getFullYear()}${(g.getMonth()+1).toString().padStart(2,"0")}${g.getDate().toString().padStart(2,"0")}`;let k="",S=0,b=1;m.forEach(($,M)=>{const L=M===0,C=M===m.length-1,A=`
            <div class="pdf-page-header">
                <div class="pdf-header">
                    <div class="pdf-shop-info">
                        ${`<img src="${N.logoUrl}" alt="Logo" class="pdf-logo">`}
                        <div class="pdf-shop-address">
                            <strong><i class="ph ph-github-logo"></i> ${T(N.name)}</strong><br>
                            ${T(N.address).replace(/\n/g,"<br>")}<br>
                            โทร: ${T(N.phone)} | เลขประจำตัวผู้เสียภาษี: ${T(N.taxId)}
                        </div>
                    </div>
                    <div class="pdf-quote-details">
                        <div class="pdf-title-box"><h1>ใบเสนอราคา ${m.length>1?L?"":"(ต่อ)":""}</h1></div>
                        <table class="pdf-quote-meta">
                            <tr><td>เลขที่:</td><td>${v}</td></tr>
                            <tr><td>วันที่:</td><td>${p}</td></tr>
                        </table>
                    </div>
                </div>
                ${L?`
                <section class="pdf-customer-details">
                    <div class="pdf-customer-info">
                        <strong>ลูกค้า:</strong> ${T(e.customer_name)||"-"}<br>
                        <strong>ที่อยู่:</strong> ${T(e.customer_address||"-").replace(/\n/g,"<br>")}<br>
                        <strong>โทร:</strong> ${T(e.customer_phone)||"-"}
                    </div>
                    <div class="pdf-customer-meta">
                        <strong>เงื่อนไขชำระเงิน:</strong> ${T(N.pdf.paymentTerms)}<br>
                        <strong>ยืนราคา:</strong> ${T(N.pdf.priceValidity)}
                    </div>
                </section>`:""}
            </div>`,F=`
            <div class="pdf-page-footer">
                <div class="pdf-footer-info">
                    <span><i class="ph ph-github-logo"></i> ${T(N.name)} | โทร: ${T(N.phone)}</span>
                    <span>หน้า ${M+1} / ${m.length}</span>
                </div>
            </div>`;let P="";L||(P+=`<tr class="pdf-subtotal-row"><td colspan="4">ยอดยกมา (Brought Forward)</td><td class="pdf-text-right">${U(S,2,!0)}</td></tr>`),$.forEach(J=>{J.isRoomHeader?P+=`<tr class="pdf-room-header"><td colspan="5">ห้อง: ${J.roomName}</td></tr>`:(P+=`<tr><td class="pdf-text-center">${b++}</td><td>${J.description}</td><td class="pdf-text-center">1</td><td class="pdf-text-right">${U(J.total,2,!0)}</td><td class="pdf-text-right">${U(J.total,2,!0)}</td></tr>`,S+=J.total)});let ee="";C||(ee=`<tfoot><tr class="pdf-subtotal-row"><td colspan="4">ยอดยกไป (Carried Forward)</td><td class="pdf-text-right">${U(S,2,!0)}</td></tr></tfoot>`);let ae="";N.pdf.notes&&N.pdf.notes.length>0&&(ae=`
                <strong>หมายเหตุ:</strong>
                <ul>${N.pdf.notes.map(J=>`<li>${T(J)}</li>`).join("")}</ul>
            `);const Me=C?`
            <div class="pdf-summary-wrapper">
                <section class="pdf-summary-section">
                    <div class="pdf-amount-in-words">
                        ${ae}
                        <div class="pdf-amount-text">( ${mt(i)} )</div>
                    </div>
                    <div class="pdf-totals-block">
                        <table>
                            <tr><td class="pdf-label">รวมเป็นเงิน</td><td class="pdf-amount">${U(l,2,!0)}</td></tr>
                            ${s}
                            ${a>0?`<tr><td class="pdf-label">ภาษีมูลค่าเพิ่ม ${(a*100).toFixed(0)}%</td><td class="pdf-amount">${U(d,2,!0)}</td></tr>`:""}
                            <tr class="pdf-grand-total"><td class="pdf-label">ยอดรวมสุทธิ</td><td class="pdf-amount">${U(i,2,!0)}</td></tr>
                        </table>
                    </div>
                </section>
                <footer class="pdf-footer-section">
                    <div class="pdf-signature-box"><p>.................................................</p><p>ผู้เสนอราคา</p><p>(<i class="ph ph-github-logo"></i> ${T(N.name)})</p><p>วันที่: ${p}</p></div>
                    <div class="pdf-signature-box"><p>.................................................</p><p>ลูกค้า / ผู้มีอำนาจลงนาม</p><p>&nbsp;</p><p>วันที่: ......./......./............</p></div>
                </footer>
            </div>
        `:"";k+=`
            <div class="pdf-page">
                <div class="pdf-page-content">
                    ${A}
                    <div class="pdf-page-body">
                        <table class="pdf-items-table">
                            <thead><tr><th style="width:5%;">ลำดับ</th><th style="width:50%;">รายการ</th><th style="width:10%;">จำนวน</th><th style="width:17.5%;">ราคา/หน่วย</th><th style="width:17.5%;">รวม (บาท)</th></tr></thead>
                            <tbody>${P}</tbody>
                            ${ee}
                        </table>
                        ${Me}
                    </div>
                    ${F}
                </div>
            </div>`});const I=e.customer_name||"quote",q=Je(I);return{html:`<div id="quotation-template">${k}</div>`,fileName:`${v}_${q}`}}function Tt(e){const o=ze(e);let a=0;e.discount?.value>0&&(a=e.discount.type==="percent"?o*(e.discount.value/100):e.discount.value);const t=o-a;let r=!1,l=e.rooms.map(s=>{if(s.is_suspended)return"";const c=s.items.filter(i=>i.is_suspended?!1:i.type==="set"||R[i.type]?.templateId==="#areaBasedTpl"?y(i.width_m)>0&&y(i.height_m)>0:i.type==="wallpaper"?(i.widths||[]).reduce((u,m)=>u+y(m),0)>0&&y(i.height_m)>0:!1);if(c.length===0)return"";const d=c.map((i,h)=>{let u="",m="",_="";if(i.type!=="set"){const x=re[i.type]||"ของตกแต่ง";m=`<h5 class="lookbook-item-title">${T(x)}</h5>`}switch(i.type){case"set":_=`<tr><td>ขนาด</td><td>${y(i.width_m).toFixed(2)} x ${y(i.height_m).toFixed(2)} ม.</td></tr>`,u=`
                        <tr><td>แบบ</td><td>${T(i.style||"")} (${T(i.fabric_variant||"")})</td></tr>
                        ${i.fabric_variant.includes("ทึบ")?`<tr><td>ทึบ</td><td>#${T(i.fabric_code)||"-"}</td></tr>`:""}
                        ${i.fabric_variant.includes("โปร่ง")?`<tr><td>โปร่ง</td><td>#${T(i.sheer_fabric_code)||"-"}</td></tr>`:""}
                    `,i.style==="ม่านพับ"?u+=`<tr><td>เชือก</td><td>${T(i.adjustment_side||"ปรับขวา")}</td></tr>`:u+=`<tr><td>เปิด</td><td>${T(i.opening_style||"แยกกลาง")}</td></tr>`;break;case"wallpaper":const x=(i.widths||[]).reduce((p,v)=>p+y(v),0),g=E.wallpaperRolls(x,i.height_m);_=`<tr><td>ขนาด</td><td>รวม ${x.toFixed(2)} ม., สูง ${y(i.height_m).toFixed(2)} ม.</td></tr>`,u=`
                        <tr><td>รหัส</td><td>#${T(i.wallpaper_code)||"-"}</td></tr>
                        <tr><td>ใช้</td><td>${g} ม้วน</td></tr>
                    `;break;default:R[i.type]?.templateId==="#areaBasedTpl"&&(_=`<tr><td>ขนาด</td><td>${y(i.width_m).toFixed(2)} x ${y(i.height_m).toFixed(2)} ม.</td></tr>`,u=`<tr><td>รหัส</td><td>#${T(i.code)||"-"}</td></tr>`,i.opening_style&&(u+=`<tr><td>เปิด</td><td>${T(i.opening_style)}</td></tr>`),i.adjustment_side&&(u+=`<tr><td>เชือก</td><td>${T(i.adjustment_side)}</td></tr>`));break}return u&&(r=!0),`
                 <div class="lookbook-details">
                    ${$t(i,s.id,h)}
                    <div class="spec-table-wrapper">
                        ${m}
                        <table class="spec-table">
                            ${u}
                            ${_}
                            ${i.notes?`<tr><td>โน้ต</td><td>${T(i.notes)}</td></tr>`:""}
                        </table>
                    </div>
                </div>
            `}).join('<hr class="lookbook-hr">');return d.trim()?`
            <div class="lookbook-room">
                <h4><i class="ph ph-map-pin"></i> ${T(s.room_name)||"ไม่ระบุชื่อห้อง"}</h4>
                ${d}
            </div>
        `:""}).join("");return r?`
        <div class="lookbook-summary">
            <div class="lookbook-customer-info">
                <strong>ลูกค้า:</strong> ${T(e.customer_name)||"-"}<br/>
                <strong>ที่อยู่:</strong> ${T(e.customer_address||"-").replace(/\n/g,"<br/>")}
            </div>
            <div class="lookbook-totals">
                <span>ยอดรวม (ก่อนส่วนลด): ${B(o)} บาท</span>
                ${a>0?`<span>ส่วนลด: -${B(a)} บาท</span>`:""}
                <span class="grand-total">ยอดสุทธิ: ${B(t)} บาท</span>
            </div>
        </div>
    `+l:'<p class="empty-summary">ไม่มีรายการสำหรับสร้างรายงาน</p>'}function Ze(e={}){const o=document.querySelector(f.roomTpl);if(!o)return console.error("Room template not found"),null;const t=o.content.cloneNode(!0).firstElementChild;t.id=e.id||`room-${Date.now()}`,t.open=e.is_open!==!1;const r=t.querySelector(f.roomNameInput),l=t.querySelector("[data-room-name-display]"),n=t.querySelector("[data-room-brief]"),s=t.querySelector(f.allItemsContainer),c=()=>{const h=r.value||"ห้อง (ไม่มีชื่อ)";l&&(l.textContent=h)};r&&r.addEventListener("input",c);const d=t.querySelector("summary");d&&d.addEventListener("click",()=>{});const i=e.room_name||`ห้อง ${document.querySelectorAll(f.room).length+1}`;if(r){r.value=i;const h=`room_name_${t.id}`;r.id=h;const u=r.closest(".form-group")?.querySelector("label");u&&u.setAttribute("for",h)}return l&&(l.textContent=i),e.is_suspended&&t.classList.add("is-suspended"),t.getItemsContainer=()=>s,t.updateBrief=h=>{n&&(n.innerHTML=h)},t}function ke(e={}){const o=document.querySelector(f.setTpl);if(!o)return console.error("Set template not found"),null;const t=o.content.cloneNode(!0).firstElementChild;t.dataset.type="set";const r=t.querySelector('input[name="width_m"]'),l=t.querySelector('input[name="height_m"]'),n=t.querySelector('select[name="set_style"]'),s=t.querySelector('select[name="fabric_variant"]'),c=t.querySelector('select[name="set_price_per_m"]'),d=t.querySelector('select[name="sheer_price_per_m"]'),i=t.querySelector('input[name="fabric_code"]'),h=t.querySelector('input[name="sheer_fabric_code"]'),u=t.querySelector('select[name="opening_style"]'),m=t.querySelector('select[name="adjustment_side"]'),_=t.querySelector('input[name="notes"]'),x=t.querySelector('[data-set-control="opening_style_wrap"]'),g=t.querySelector('[data-set-control="adjustment_side_wrap"]'),p=t.querySelector("[data-sheer-wrap]"),v=t.querySelector("[data-sheer-code-wrap]"),k=t.querySelector("[data-set-summary]"),S=t.querySelector(".item-details-more"),b=t.querySelector('[data-act="toggle-more-details"]')?.parentElement,I=()=>({width_m:r.value,height_m:l.value,style:n.value,fabric_variant:s.value,price_per_m_raw:c.value,sheer_price_per_m:d.value,is_suspended:t.classList.contains("is-suspended")}),q=()=>{const C=I(),A=E.calculateSetPrice(C);t.dataset.totalPrice=A.total;let F=`ราคา: <b>${B(A.total)}</b> บ.`;A.opaque>0&&A.sheer>0&&(F+=` <small>(ทึบ: ${B(A.opaque)}, โปร่ง: ${B(A.sheer)})</small>`);const P=E.fabricYardage(C.style,C.width_m);P>0&&(F+=` &bull; ใช้ผ้า: ${P.toFixed(2)} หลา`),k?k.innerHTML=F:console.warn("Summary element not found for set item.")},$=me(()=>{q(),t.dispatchEvent(new CustomEvent("item-update",{bubbles:!0}))},200),M=()=>{const C=s.value,A=C.includes("โปร่ง"),F=C==="โปร่ง",P=C==="ทึบ";p?.classList.toggle("hidden",!A),v?.classList.toggle("hidden",!A),c.disabled=F,i.disabled=F,F&&(c.value="",i.value=""),d.disabled=P,h.disabled=P,P&&(d.value="",h.value="")},L=()=>{const A=n.value==="ม่านพับ";x&&x.classList.toggle("hidden",A),g&&g.classList.toggle("hidden",!A)};if(t.addEventListener("input",C=>{C.target===s&&M(),C.target===n&&L(),$()}),S&&b){const C=t.querySelector(".item-grid");C&&C.appendChild(b)}return r.value=te(e.width_m),l.value=te(e.height_m),n.value=e.style||"ลอน",s.value=e.fabric_variant||"ทึบ",c.value=e.price_per_m_raw||"",d.value=e.sheer_price_per_m||"",i.value=e.fabric_code||"",h.value=e.sheer_fabric_code||"",u.value=e.opening_style||"แยกกลาง",m.value=e.adjustment_side||"ปรับขวา",_.value=e.notes||"",t.querySelector('input[name="track_color"]').value=e.track_color||"ขาว",t.querySelector('input[name="bracket_color"]').value=e.bracket_color||"ขาว",t.querySelector('input[name="finial_color"]').value=e.finial_color||"ขาว",t.querySelector('input[name="grommet_color"]').value=e.grommet_color||"เงิน",e.is_suspended&&t.classList.add("is-suspended"),M(),L(),q(),t}function Ne(e={}){const o=document.querySelector(f.wallTpl);if(!o)return null;const t=o.content.cloneNode(!0).firstElementChild,r=t.querySelector('input[name="wall_width_m"]');r.value=te(e.width);const l=`wall_width_${Date.now()}_${Math.random().toString(36).substring(2,7)}`;r.id=l;const n=t.querySelector("label");return n&&n.setAttribute("for",l),t}function xe(e={}){const o=document.querySelector(f.wallpaperTpl);if(!o)return console.error("Wallpaper template not found"),null;const t=o.content.cloneNode(!0).firstElementChild;t.dataset.type="wallpaper";const r=t.querySelector('[name="wallpaper_height_m"]'),l=t.querySelector('[name="wallpaper_price_roll"]'),n=t.querySelector('[name="wallpaper_install_cost"]'),s=t.querySelector('[name="wallpaper_code"]'),c=t.querySelector('[name="wallpaper_notes"]'),d=t.querySelector("[data-walls-container]"),i=t.querySelector("[data-wallpaper-summary]"),h=t.querySelector(".item-details-more"),u=t.querySelector('[data-act="toggle-more-details"]')?.parentElement,m=()=>({height_m:r.value,price_per_roll:l.value,install_cost_per_roll:n.value,widths:Array.from(d.querySelectorAll('input[name="wall_width_m"]')).map(g=>g.value),is_suspended:t.classList.contains("is-suspended")}),_=()=>{const g=m(),p=E.calculateWallpaperPrice(g);t.dataset.totalPrice=p.total;let v=`รวม: <b>${B(p.total)}</b> บ. `;(p.material>0||p.install>0)&&(v+=`<small>(วอลล์: ${B(p.material)}, ค่าช่าง: ${B(p.install)})</small>`),p.rolls>0&&(v+=` &bull; พื้นที่: ${U(p.sqm,2)} ตร.ม. &bull; ใช้: ${p.rolls} ม้วน`),i&&(i.innerHTML=v)},x=me(()=>{_(),t.dispatchEvent(new CustomEvent("item-update",{bubbles:!0}))},200);if(t.addEventListener("input",x),h&&u){const g=t.querySelector(".item-grid");g&&g.appendChild(u)}if(e.widths&&e.widths.length>0)e.widths.forEach(g=>{const p=Ne({width:g});p&&d.appendChild(p)});else{const g=Ne();g&&d.appendChild(g)}return r.value=te(e.height_m),l.value=e.price_per_roll>0?B(e.price_per_roll):"",n.value=e.hasOwnProperty("install_cost_per_roll")?e.install_cost_per_roll>0?B(e.install_cost_per_roll):e.install_cost_per_roll===0?"0":"":n.value,s.value=e.wallpaper_code||"",c.value=e.notes||"",e.is_suspended&&t.classList.add("is-suspended"),_(),t}function Ie(e,o={}){const a=document.querySelector(f.areaBasedTpl);if(!a)return console.error("AreaBased template not found"),null;const r=a.content.cloneNode(!0).firstElementChild;r.dataset.type=e;const l=R[e]||{name:"ของตกแต่ง"};r.classList.add(`${e.replace(/_/g,"-")}-item`);const n=r.querySelector(".item-type-display"),s=r.querySelector('[name="area_width_m"]'),c=r.querySelector('[name="area_height_m"]'),d=r.querySelector('[name="area_price_sqyd"]'),i=r.querySelector('[name="area_code"]'),h=r.querySelector('[name="area_notes"]'),u=r.querySelector(".btn-favorite"),m=r.querySelector(".btn-show-favs"),_=r.querySelector("[data-area-summary]"),x=r.querySelector(".item-details-more"),g=r.querySelector('[data-act="toggle-more-details"]')?.parentElement,p=x?.querySelector(".item-grid"),v=p?.querySelector('[name="area_price_sqyd"]')?.closest(".form-group");let k,S;if(p&&v){if(e==="partition"||e==="pleated_screen"){const $=document.createElement("div");$.className="form-group",$.innerHTML=`
                <label>รูปแบบเปิด
                    <select name="opening_style">
                        <option value="แยกกลาง">แยกกลาง</option>
                        <option value="เก็บข้างเดียว">เก็บข้างเดียว</option>
                    </select>
                </label>
            `,p.insertBefore($,v),k=$.querySelector("select")}else if(["wooden_blind","roller_blind","vertical_blind","aluminum_blind"].includes(e)){const $=document.createElement("div");$.className="form-group",$.innerHTML=`
                <label>เชือกปรับ
                    <select name="adjustment_side">
                        <option value="ปรับขวา">ปรับขวา</option>
                        <option value="ปรับซ้าย">ปรับซ้าย</option>
                    </select>
                </label>
            `,p.insertBefore($,v),S=$.querySelector("select")}(k||S)&&v&&v.classList.remove("full-width-item")}const b=()=>({width_m:s.value,height_m:c.value,price_sqyd:d.value,is_suspended:r.classList.contains("is-suspended")}),I=()=>{const $=b(),M=E.calculateAreaBasedPrice($);r.dataset.totalPrice=M.total;const L=M.sqyd>0?` &bull; พื้นที่: ${U(M.sqyd,2)} ตร.หลา`:"";_&&(_.innerHTML=`ราคา: <b>${B(M.total)}</b> บ.${L}`)},q=me(()=>{I(),r.dispatchEvent(new CustomEvent("item-update",{bubbles:!0}))},200);if(r.addEventListener("input",q),x&&g){const $=r.querySelector(".item-grid");$&&$.appendChild(g)}return n&&(n.textContent=l.name),i&&(i.dataset.favoriteType=e),u&&(u.dataset.type=e),m&&(m.dataset.type=e),s.value=te(o.width_m),c.value=te(o.height_m),d.value=o.price_sqyd>0?B(o.price_sqyd):"",i.value=o.code||"",h.value=o.notes||"",k&&(k.value=o.opening_style||"แยกกลาง"),S&&(S.value=o.adjustment_side||"ปรับขวา"),o.is_suspended&&r.classList.add("is-suspended"),I(),r}let G=!1,ve=null,O=null,ce=null,pe=!1,H=null,Ce=!1,X=null,Ge;const Ye=document.querySelector("#undoBtn"),He="marnthara.theme",ye={};function Lt(e){if(ye[e])return ye[e];const o=new Promise((a,t)=>{const r=document.createElement("script");r.src=e,r.onload=()=>a(),r.onerror=()=>{console.error(`Script load error for ${e}`),delete ye[e],t(new Error(`Script load error for ${e}`))},document.head.appendChild(r)});return ye[e]=o,o}function et(){const e=localStorage.getItem(He),o=document.querySelector("#themeToggleBtn");if(!o)return;const a=o.querySelector("i"),t=o.querySelector("span");switch(document.body.classList.remove("dark-theme","neutral-theme"),e){case"dark":document.body.classList.add("dark-theme"),a&&(a.className="ph-fill ph-sun"),t&&(t.textContent=" สว่าง");break;case"neutral":document.body.classList.add("neutral-theme"),a&&(a.className="ph-fill ph-moon"),t&&(t.textContent=" มืด");break;default:a&&(a.className="ph-fill ph-palette"),t&&(t.textContent=" กลาง");break}}function Mt(){const e=localStorage.getItem(He);let o="neutral";!e||e==="light"?o="neutral":e==="neutral"?o="dark":o="light",localStorage.setItem(He,o),et()}function K(){Ye&&(Ye.disabled=!gt())}function Bt(){const e=yt();e&&(De(e,!1),w("ยกเลิกการกระทำล่าสุดแล้ว","success")),K()}function Te(){clearTimeout(Ge),document.documentElement.classList.add("scrolling-programmatically"),Ge=setTimeout(()=>{document.documentElement.classList.remove("scrolling-programmatically")},1e3)}function ie(){const e=document.getElementById("suspendedItemsBtn");if(!e)return;if(ce){e.classList.remove("is-visible");return}const o=document.getElementById("suspendedCountBadge"),a=document.querySelectorAll(".item-card.is-suspended").length,t=document.querySelectorAll(".room-card.is-suspended");let r=0;t.forEach(n=>{r+=n.querySelectorAll(".item-card:not(.is-suspended)").length});const l=a+r;o&&(o.textContent=l),e.classList.toggle("is-visible",l>0)}function Ae(){ce="suspended";const e=document.getElementById("filterStatusBar");let o=0;if(document.querySelectorAll(".room-card").forEach(a=>{let t=!1;const r=a.classList.contains("is-suspended");a.querySelectorAll(".item-card").forEach(n=>{const c=n.classList.contains("is-suspended")||r;n.classList.toggle("item-hidden",!c),c&&(t=!0,o++)});const l=r||t;a.classList.toggle("item-hidden",!l)}),o===0){tt(),w("ไม่มีรายการที่ถูกระงับแล้ว","success");return}e&&(e.innerHTML=`
            <span><i class="ph ph-warning"></i> รายการที่ถูกระงับ (${o} รายการ)</span>
            <button type="button" class="btn-chip" data-act="clear-filter" title="ยกเลิกการกรอง">
                <i class="ph ph-x"></i>&nbsp;ปิด
            </button>
        `,e.classList.add("is-visible"),e.dataset.filterType="suspended"),Q(),Y(),ie()}function Ct(e,o){if(!e)return;ce=e;const a=document.getElementById("filterStatusBar");let t=0;document.querySelectorAll(f.room).forEach(r=>{let l=0;r.querySelectorAll(".item-card").forEach(n=>{const s=n.dataset.type===e;n.classList.toggle("item-hidden",!s),s&&l++}),r.classList.toggle("item-hidden",l===0),l>0&&(t+=l)}),a&&(a.innerHTML=`
            <span>เฉพาะ: <strong>${T(o)}</strong> (${t} รายการ)</span>
            <button type="button" class="btn-chip" data-act="clear-filter" title="ยกเลิกการกรอง">
                <i class="ph ph-x"></i>&nbsp;ปิด
            </button>
        `,a.classList.add("is-visible"),a.dataset.filterType=e),Q(),Y(),ie()}function tt(){ce=null;const e=document.getElementById("filterStatusBar");e&&(e.classList.remove("is-visible"),e.innerHTML="",e.removeAttribute("data-filter-type")),document.querySelectorAll(".item-hidden").forEach(o=>o.classList.remove("item-hidden")),Q(),Y(),ie()}function w(e,o="default"){const a=document.querySelector(f.toastContainer);if(!a)return;const t={success:"ph-bold ph-check-circle",warning:"ph-bold ph-warning",error:"ph-bold ph-x-circle",default:"ph-bold ph-info"},r=document.createElement("div");r.className=`toast toast-${o}`,r.innerHTML=`<i class="${t[o]||t.default}"></i> ${T(e)}`,a.appendChild(r),setTimeout(()=>r.classList.add("show"),10),setTimeout(()=>{r.classList.remove("show"),r.addEventListener("transitionend",()=>r.remove())},3e3)}function W(e,o){return new Promise(a=>{const t=document.querySelector(e);if(!t){a(null);return}const r=document.querySelector(".modal-wrapper.visible:not(.is-underlay)");r&&r!==t&&r.classList.add("is-underlay"),t.classList.add("visible");const l=t.querySelector('[id$="Confirm"]'),n=t.querySelector('[id$="Cancel"], [data-act="close-modal"]'),s=Array.from(t.querySelectorAll('button, [href], input:not([type="hidden"]), select, textarea, [tabindex]:not([tabindex="-1"])')).filter(m=>!m.disabled&&m.offsetParent!==null),c=s[0],d=s[s.length-1];setTimeout(()=>c?.focus(),50);const i=m=>{t.classList.remove("visible"),document.removeEventListener("keydown",h),t.removeEventListener("click",u),l&&(l.onclick=null),n&&(n.onclick=null);const _=document.querySelector(".modal-wrapper.visible:not(.is-underlay)");_?_.classList.remove("is-underlay"):r&&r!==t&&r.classList.remove("is-underlay"),m?.cancelled&&typeof o=="function"&&o(),a(m)},h=m=>{m.key==="Escape"&&!t.classList.contains("is-underlay")&&i({cancelled:!0}),m.key==="Tab"&&s.length>1&&(m.shiftKey?document.activeElement===c&&(d.focus(),m.preventDefault()):document.activeElement===d&&(c.focus(),m.preventDefault()))},u=m=>{m.target===t&&!t.classList.contains("is-underlay")&&(m.stopPropagation(),i({cancelled:!0}))};l&&(l.onclick=()=>i(!0)),n&&(n.onclick=()=>{t.classList.contains("is-underlay")||i({cancelled:!0})}),document.addEventListener("keydown",h),t.addEventListener("click",u)})}async function z(e,o){const a=document.querySelector(f.modal);return a?(a.querySelector(f.modalTitle).textContent=e,a.querySelector(f.modalBody).textContent=o,await W(f.modal)===!0):!0}async function At(){const e=document.querySelector(f.exportOptionsModal);if(!e)return null;const o=e.querySelector("#pageBreakBuffer"),a=e.querySelector("#pageBreakBufferValue");o&&a&&(a.textContent=o.value,o.oninput=()=>{a.textContent=o.value});const t=await W(f.exportOptionsModal);return o&&(o.oninput=null),!t||t.cancelled?null:{vatOption:e.querySelector('input[name="vat_option"]:checked')?.value||"include",exportMethod:e.querySelector("#exportMethod")?.value||"direct",pageBreakBuffer:parseInt(o?.value,10)||3}}async function Et(){const e=document.querySelector("#discountModal");if(!e)return;const o=e.querySelector("#discountSubtotal"),a=e.querySelector("#discountPercent"),t=e.querySelector("#discountAmount"),r=e.querySelector("#discountFinalTotal"),l=document.querySelector("#discount_type"),n=document.querySelector("#discount_value"),s=y(document.querySelector("#originalTotal").dataset.rawTotal||document.querySelector("#grandTotal").textContent);o&&(o.textContent=B(s));const c=g=>{if(Ce)return;Ce=!0;let p=0;if(g==="percent"){const v=y(a.value);p=s*(Math.max(0,v)/100),t.value=p>0?B(Math.round(p)):""}else p=y(t.value);if(p=Math.max(0,Math.min(p,s)),g!=="percent"){const v=s>0?p/s*100:0;a.value=v>0&&isFinite(v)?U(v,2):""}r&&(r.textContent=B(s-p)),setTimeout(()=>{Ce=!1},50)},d=()=>c("percent"),i=()=>c("amount"),h=g=>{y(g.target.value)>0&&(g.target.value=y(g.target.value))},u=g=>{const p=y(g.target.value);g.target.value=p>0?B(p):"",c("amount")};a.addEventListener("input",d),t.addEventListener("input",i),t.addEventListener("focus",h),t.addEventListener("blur",u);const m=l.value,_=y(n.value);a.value="",t.value="",_>0?m==="percent"?(a.value=_,c("percent")):(t.value=_,t.value=B(_),c("amount")):c();const x=await W("#discountModal");if(a.removeEventListener("input",d),t.removeEventListener("input",i),t.removeEventListener("focus",h),t.removeEventListener("blur",u),x&&!x.cancelled){const g=y(a.value),p=y(t.value),v=document.activeElement;g>0&&v===a?(l.value="percent",n.value=g):p>0?(l.value="amount",n.value=p):g>0?(l.value="percent",n.value=g):(l.value="amount",n.value=0),D()}}async function Pt(){if(!O)return;const e=document.querySelector("#hardwareModal");if(!e)return;const o=O.querySelector('[name="set_style"]'),a=o?o.value:null,t=a==="ตาไก่",r=a==="ม่านพับ";e.querySelector('[name="modal_track_color"]').value=O.querySelector('[name="track_color"]')?.value||"ขาว",e.querySelector('[name="modal_bracket_color"]').value=O.querySelector('[name="bracket_color"]')?.value||"ขาว",e.querySelector('[name="modal_finial_color"]').value=O.querySelector('[name="finial_color"]')?.value||"ขาว",e.querySelector('[name="modal_grommet_color"]').value=O.querySelector('[name="grommet_color"]')?.value||"เงิน";const l=e.querySelector("#finialColorGroup"),n=e.querySelector("#grommetColorGroup"),s=e.querySelector("#hardwareApplyToRoom");l&&(l.style.display=t?"":"none"),n&&(n.style.display=t?"":"none"),s&&(s.disabled=r);const c=await W("#hardwareModal");c&&!c.cancelled&&(O.querySelector('[name="track_color"]').value=e.querySelector('[name="modal_track_color"]').value,O.querySelector('[name="bracket_color"]').value=e.querySelector('[name="modal_bracket_color"]').value,t&&(O.querySelector('[name="finial_color"]').value=e.querySelector('[name="modal_finial_color"]').value,O.querySelector('[name="grommet_color"]').value=e.querySelector('[name="modal_grommet_color"]').value),V(),w("บันทึกการตั้งค่าอุปกรณ์แล้ว","success")),O=null}function Ee(e,o){e&&(oe(j()),K(),e.classList.add("item-removing"),e.addEventListener("animationend",()=>{e.remove(),w(o),Le(),Q(),D(),he()},{once:!0}))}function Rt(e){if(!e)return;const o=document.querySelector(".main-header");if(!o){e.scrollIntoView({behavior:"smooth",block:"center"});return}Te();const a=o.offsetHeight,t=16,l=(e.querySelector(".item-header")||e).getBoundingClientRect(),n=a+t,s=l.top-n;Math.abs(s)>5&&window.scrollBy({top:s,behavior:"smooth"})}function fe(e){if(!e)return;Te();const o=document.querySelector(".main-header"),a=document.querySelector(".summary-footer"),t=o?o.offsetHeight+16:80,r=a?a.offsetHeight+16:100;requestAnimationFrame(()=>{const l=e.getBoundingClientRect(),n=window.innerHeight;if(!(l.top>=t&&l.bottom<=n-r)){const c=n-t-r,d=l.height>c?"start":"center";e.scrollIntoView({behavior:"smooth",block:d})}})}function Q(){document.querySelectorAll(f.room).forEach(e=>{const o=e.querySelectorAll(".item-card:not(.item-hidden)");let a=0;const t=Array.from(o).filter(r=>!r.classList.contains("is-suspended")).length;o.forEach(r=>{const l=r.querySelector("[data-item-title]");l&&(r.classList.contains("is-suspended")?l.textContent="-":(a++,l.textContent=`${a}/${t}`))}),e.querySelectorAll(".item-card.item-hidden").forEach(r=>{const l=r.querySelector("[data-item-title]");l&&(l.textContent="-")})})}function ot(){const e=document.querySelector(f.orderForm),o=document.querySelector(f.lockBtn);!e||!o||(e.classList.toggle("is-locked",G),o.classList.toggle("is-locked",G),o.querySelector("i").className=G?"ph-bold ph-lock-key":"ph ph-paw-print",e.querySelectorAll('input:not([type="hidden"]), select, textarea, button:not(.unlockable):not([data-act="toggle-more-details"]):not([data-act="collapse-room"])').forEach(a=>{!a.closest(".main-header")&&!a.closest(".summary-footer")&&!a.closest(".modal-wrapper")&&(a.disabled=G)}),document.querySelectorAll(".unlockable").forEach(a=>a.disabled=!1))}function Ft(){G=!G,ot(),w(G?"ฟอร์มถูกล็อค":"ปลดล็อคฟอร์มแล้ว",G?"warning":"success")}function Y(){const e=document.querySelectorAll(f.room+":not(.item-hidden)");if(e.length===0){const t=document.querySelector(f.toggleAllRoomsBtn);t&&(t.querySelector("i").className="ph ph-caret-down",t.querySelector("span").textContent="ขยายทั้งหมด");return}const o=[...e].some(t=>t.open),a=document.querySelector(f.toggleAllRoomsBtn);a&&(a.querySelector("i").className=o?"ph ph-caret-up":"ph ph-caret-down",a.querySelector("span").textContent=o?"ย่อทั้งหมด":"ขยายทั้งหมด")}function Nt(){const e=document.querySelectorAll(f.room+":not(.item-hidden)");if(e.length===0)return;const o=[...e].some(t=>t.open);e.forEach(t=>{t.open=!o});const a=document.querySelector(f.quickNavDropdown);a&&a.classList.contains("show")&&(a.classList.remove("show"),document.querySelector(f.quickNavBtn)?.setAttribute("aria-expanded","false")),setTimeout(()=>{Y(),V()},50)}function Le(){const e=document.querySelector(f.quickNavRoomList);e&&(e.innerHTML="",document.querySelectorAll(f.room).forEach(o=>{const a=o.querySelector(f.roomNameInput)?.value||"ห้อง",t=document.createElement("a");t.href=`#${o.id}`,t.dataset.jumpTo=o.id,t.innerHTML=`<i class="ph ph-share-fat"></i> ${T(a)||"ห้อง (ไม่มีชื่อ)"}`,e.appendChild(t)}))}function Pe(e){const o=document.getElementById("quickNavBtnText");o&&(e?o.textContent=e.querySelector('input[name="room_name"]')?.value||"...":o.textContent="ไปยังห้อง")}function he(){if(ve&&ve.disconnect(),!document.getElementById("quickNavBtnText"))return;const o={root:null,rootMargin:"-60px 0px -150px 0px",threshold:0},a=r=>{const l=r.filter(n=>n.isIntersecting).sort((n,s)=>n.target.getBoundingClientRect().top-s.target.getBoundingClientRect().top);l.length>0&&Pe(l[0].target)};ve=new IntersectionObserver(a,o),document.querySelectorAll(f.room).forEach(r=>ve.observe(r));const t=Array.from(document.querySelectorAll(f.room));if(t.length>0){t.sort((l,n)=>l.getBoundingClientRect().top-n.getBoundingClientRect().top);const r=t.find(l=>l.getBoundingClientRect().bottom>60);Pe(r||t[0])}else Pe(null)}function we(e){if(!e)return;const o=e.closest(".form-group-with-favorites")?.querySelector(".btn-favorite");if(!o)return;const a=e.dataset.favoriteType,t=e.value;o.classList.toggle("is-favorite",Qe(a,t))}function _e(e,o=null){if(!e)return;const a=e.querySelector(".item-details-more"),t=e.querySelector('[data-act="toggle-more-details"]'),r=t?.parentElement;if(!a||!t||!r)return;const l=a.classList.contains("show"),n=o!==null?o:!l;if(l===n)return;a.classList.toggle("show",n),t.classList.toggle("expanded",n);const s=t.querySelector("i");s&&(s.className=n?"ph ph-caret-up":"ph ph-caret-down");const c=t.querySelector("span");if(c&&(c.textContent=n?"ย่อน้อยลง":"เพิ่มเติม"),n)a.appendChild(r),setTimeout(()=>Rt(e),100);else{const d=e.querySelector(".item-grid");d&&d.appendChild(r)}}function le(e={}){const o=document.querySelector(f.roomsContainer);if(!o)return null;Object.keys(e).length===0&&(oe(j()),K());const a=Ze(e);return a?(o.appendChild(a),Object.keys(e).length===0&&(a.classList.add("item-created"),fe(a),a.querySelector('input[name="room_name"]')?.focus()),Le(),Y(),he(),Object.keys(e).length===0&&V(),a):null}async function rt(e,o=null){const a=document.querySelector("#itemTypeModal");if(!a)return null;a.querySelector("#itemTypeModalTitle").textContent=e;let t=o||"set";o&&!R[o]&&(t="set");const r=a.querySelector(`input[name="item_type_option"][value="${t}"]`);if(r)r.checked=!0;else{const s=a.querySelector('input[name="item_type_option"][value="set"]');s&&(s.checked=!0)}const l=await W("#itemTypeModal");if(!l||l.cancelled)return null;const n=a.querySelector('input[name="item_type_option"]:checked');return n?n.value:null}async function Ht(e,o){if(!o||!e||!R[e])return;const a=o.getItemsContainer();if(!a)return;oe(j()),K();let t;if(e==="set")t=ke();else if(e==="wallpaper")t=xe();else if(R[e].templateId==="#areaBasedTpl")t=Ie(e);else return;t&&(a.appendChild(t),t.classList.add("item-created"),fe(t),t.querySelector('input:not([type="hidden"]), select, textarea')?.focus(),Q(),D())}async function Ot(e){if(!e)return;const o=e.dataset.type,a=await rt("เปลี่ยนประเภทรายการ",o);if(!a||a===o||!await z("ยืนยันการเปลี่ยนแปลง","ข้อมูลทั้งหมดในรายการนี้จะถูกลบและสร้างใหม่ คุณแน่ใจหรือไม่?"))return;oe(j()),K();let t;if(a==="set")t=ke();else if(a==="wallpaper")t=xe();else if(R[a]?.templateId==="#areaBasedTpl")t=Ie(a);else return;t&&(e.replaceWith(t),t.classList.add("item-created"),fe(t),t.querySelector('input:not([type="hidden"]), select, textarea')?.focus(),Q(),D(),w("เปลี่ยนประเภทรายการแล้ว","success"))}const D=me(()=>{let e=0;document.querySelectorAll(f.room).forEach(d=>{let i=0,h=0;const u=d.classList.contains("is-suspended");u||(d.querySelectorAll(".item-card:not(.is-suspended)").forEach(m=>{const _=y(m.dataset.totalPrice);_>0&&(i+=_,h++)}),e+=i),typeof d.updateBrief=="function"&&(u?d.updateBrief("(ระงับชั่วคราว)"):h>0?d.updateBrief(`<span>${h}</span> &bull; ${B(i)} บาท`):d.updateBrief("<span>0</span> รายการ"))});const o=document.querySelector("#discount_type"),a=document.querySelector("#discount_value"),t=o?o.value:"amount",r=a?y(a.value):0;let l=0;r>0&&(l=t==="percent"?e*(r/100):r,l=Math.min(e,l));const n=e-l,s=document.querySelector("#grandTotal"),c=document.querySelector("#originalTotal");s&&(s.textContent=B(n)),c&&(l>0?(c.textContent=B(e),c.dataset.rawTotal=e,c.style.display="block"):(c.style.display="none",c.dataset.rawTotal="")),ie(),V()},200);async function De(e,o=!1){if(!e){w("ข้อมูลสำหรับโหลดไม่ถูกต้อง","error");return}if(e.favorites)if(o){const d=document.querySelector("#favoritesConflictModal");if(d){const i=d.querySelector('input[name="fav_conflict_option"][value="merge"]');i&&(i.checked=!0);const h=await W("#favoritesConflictModal");if(!h||h.cancelled){w("ยกเลิกการนำเข้า","warning");return}const u=d.querySelector('input[name="fav_conflict_option"]:checked').value;let m=0;switch(u){case"overwrite":je(e.favorites)&&w("เขียนทับรายการโปรดสำเร็จ","success");break;case"merge":m=Re(e.favorites),w(`รวมข้อมูลสำเร็จ (เพิ่ม ${m} รายการใหม่)`,"success");break;case"skip":w("ข้ามการนำเข้ารายการโปรด","default");break}}else Re(e.favorites)}else je(e.favorites);const a=document.querySelector(f.roomsContainer);if(!a)return;a.innerHTML="";const t=document.querySelector("#customer_name"),r=document.querySelector("#customer_phone"),l=document.querySelector("#customer_address"),n=document.querySelector("#customerDetailsCard");t&&(t.value=e.customer_name||""),r&&(r.value=e.customer_phone||""),l&&(l.value=e.customer_address||""),n&&(n.open=e.customer_card_open??!0);const s=document.querySelector("#discount_type"),c=document.querySelector("#discount_value");if(e.discount&&s&&c?(s.value=e.discount.type||"amount",c.value=e.discount.value||0):s&&c&&(s.value="amount",c.value=0),!Array.isArray(e.rooms)){w("ไม่พบข้อมูลห้องในไฟล์","warning"),a.children.length===0&&le();return}for(const d of e.rooms){const i=Ze(d);if(!i)continue;a.appendChild(i);const h=i.getItemsContainer();if(h&&Array.isArray(d.items))for(const u of d.items){u.type==="deco"&&u.deco_type&&(u.code=u.deco_code,u.width_m=u.deco_width_m,u.height_m=u.deco_height_m,u.price_sqyd=u.deco_price_sqyd,u.notes=u.deco_notes,delete u.deco_type,delete u.deco_code,delete u.deco_width_m,delete u.deco_height_m,delete u.deco_price_sqyd,delete u.deco_notes);let m;if(u.type==="set")m=ke(u);else if(u.type==="wallpaper")m=xe(u);else if(R[u.type]?.templateId==="#areaBasedTpl")m=Ie(u.type,u);else continue;m&&h.appendChild(m)}}document.querySelectorAll("input[data-favorite-type]").forEach(we),Q(),Le(),Y(),he(),K(),D(),o&&w("นำเข้าข้อมูลฟอร์มสำเร็จ","success")}async function Dt(e,o){const a=document.querySelector(f.printableContent);if(!a||!e){w("ไม่พบข้อมูลสำหรับสร้างเอกสาร","error");return}const t=document.title;if(o==="direct"){w("กำลังสร้าง PDF...","default");let r;try{typeof window.html2pdf>"u"&&(w("กำลังโหลดไลบรารี PDF...","default"),await Lt("https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js")),r=document.createElement("div"),r.style.position="fixed",r.style.left="-300mm",r.style.top="0",r.style.width="210mm",r.style.background="#fff",r.innerHTML=e,document.body.appendChild(r),await new Promise(n=>setTimeout(n,300));const l={margin:0,filename:`${t}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0,logging:!1,width:r.querySelector(".pdf-page")?.scrollWidth||794,windowWidth:r.querySelector(".pdf-page")?.scrollWidth||794},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}};await window.html2pdf().from(r).set(l).save(),w("ดาวน์โหลด PDF สำเร็จ","success")}catch(l){console.error("PDF Generation Error:",l),w("สร้าง PDF ล้มเหลว, โปรดลองวิธีที่ 2 (พิมพ์)","error")}finally{r&&document.body.contains(r)&&document.body.removeChild(r)}}else o==="print"&&(a.innerHTML=e,setTimeout(()=>{window.print(),setTimeout(()=>{a.innerHTML=""},1e3)},dt))}function jt(e){if(!e||!e.html){w("ไม่พบข้อมูลสำหรับสร้างไฟล์ HTML","error");return}try{const o=`<!DOCTYPE html><html lang="th"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>${e.fileName}</title><link rel="stylesheet" href="./src/styles/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/bold/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/fill/style.css"><style>body { background-color: #eee; } #printable-content { display: block !important; max-width: 210mm; margin: 10mm auto; } .pdf-page { border: 1px solid #ccc; box-shadow: 0 0 10px rgba(0,0,0,0.1); margin-bottom: 10mm; background: #fff; page-break-inside: avoid; } .pdf-page-content { padding: 12mm; } @media print { body { background-color: #fff; } #printable-content { max-width: 100%; margin: 0; } .pdf-page { border: none; box-shadow: none; margin-bottom: 0; page-break-after: always; } .pdf-page:last-child { page-break-after: avoid; } } i.ph { vertical-align: middle; }</style></head><body><div id="printable-content">${e.html}</div></body></html>`,a=new Blob([o],{type:"text/html;charset=utf-8"}),t=URL.createObjectURL(a),r=document.createElement("a");r.href=t,r.download=`${e.fileName}.html`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(t),w("ดาวน์โหลดไฟล์ HTML สำเร็จ","success")}catch(o){console.error("HTML Export Error:",o),w("สร้างไฟล์ HTML ล้มเหลว","error")}}function Wt(e){const o=e.closest(".item-card");if(!o)return;const a=y(e.value);let t;const r=e.getAttribute("name");if(r==="set_price_per_m")t=o.querySelector('input[name="fabric_code"]');else if(r==="sheer_price_per_m")t=o.querySelector('input[name="sheer_fabric_code"]');else if(r==="wallpaper_price_roll")t=o.querySelector('input[name="wallpaper_code"]');else if(r==="area_price_sqyd")t=o.querySelector('input[name="area_code"]');else return;if(t&&t.value.trim()){const l=t.dataset.favoriteType,n=t.value.trim(),s=Ke(l,n);if(s&&s.price!==a){const c=t.closest(".form-group-with-favorites")?.querySelector(".btn-favorite");c?.classList.contains("is-favorite")&&(ge(l,n,s.price),c.classList.remove("is-favorite"),w(`ยกเลิก Favorite '${n}' เนื่องจากราคาไม่ตรงกัน`,"warning"),V())}}}function Vt(e){const{roomId:o,itemIndex:a}=e.dataset;if(!o||a===void 0)return;const t=document.getElementById("lookbookModal");t&&t.classList.remove("visible");const r=document.getElementById(o);if(!r){w("ไม่พบห้องที่ต้องการ","error");return}const n=Array.from(r.querySelectorAll(".item-card:not(.item-hidden)"))[parseInt(a,10)];if(!n){w("ไม่พบรายการที่ต้องการ","error");return}r.open=!0,Y(),setTimeout(()=>{Te(),n.scrollIntoView({behavior:"smooth",block:"center"}),n.classList.add("scrolling-jump"),setTimeout(()=>n.classList.remove("scrolling-jump"),2500)},150)}function nt(e){if(!X)return;const o=X.closest(".item-card");if(!o)return;const a=e.dataset.code,t=y(e.dataset.price);X.value=a,X.classList.add("input-highlight"),setTimeout(()=>X.classList.remove("input-highlight"),1200);const r=X.dataset.favoriteType;let l;r==="fabric"?l="set_price_per_m":r==="sheer"?l="sheer_price_per_m":r==="wallpaper"?l="wallpaper_price_roll":l="area_price_sqyd";const n=o.querySelector(`[name="${l}"]`);n&&t>0&&(n.tagName==="SELECT"?n.value=t:n.value=B(t),n.classList.add("input-highlight"),setTimeout(()=>n.classList.remove("input-highlight"),1200)),we(X),(n||X).dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0})),document.querySelector("#favoritesModal").classList.remove("visible")}async function at(e){X=e;const o=e.dataset.favoriteType;if(!o)return;const a=document.querySelector("#favoritesModal"),t=a.querySelector("#favoritesModalTitle"),r=a.querySelector("#favoritesModalBody"),l=a.querySelector("#favSearchInput"),n=a.querySelector("#favoritesModalManageBtn"),s=document.querySelector("#favSelectorItemTpl"),c=R[o]?.name||o;t.textContent=`เลือก '${T(c)}'`;const i=Z()[o]||[];i.length>0?r.innerHTML=i.map(m=>s.innerHTML.replace(/{CODE}/g,T(m.code)).replace(/{PRICE}/g,m.price>0?B(m.price):"-").replace(/{RAW_PRICE}/g,m.price)).join(""):r.innerHTML='<p class="empty-state">ไม่มีรายการโปรดที่บันทึกไว้</p>',l.value="";const h=()=>{const m=l.value.toLowerCase();r.querySelectorAll(".fav-selector-item").forEach(_=>{const x=_.dataset.code.toLowerCase();_.classList.toggle("is-hidden",!x.includes(m))})};l.addEventListener("input",h);const u=m=>{const _=m.target.closest(".fav-selector-item");_&&(nt(_),r.removeEventListener("click",u),l.removeEventListener("input",h))};r.addEventListener("click",u),n.onclick=async()=>{a.classList.remove("visible"),await Ut(o),pe&&await at(e)},await W("#favoritesModal",()=>{l.removeEventListener("input",h),r.removeEventListener("click",u)})}function Se(e){const o=document.querySelector("#favManagerBody"),a=document.querySelector("#favManagerItemTpl"),r=Z()[e]||[];if(!o||!a)return;r.length===0?o.innerHTML='<p class="empty-state">ไม่มีรายการโปรดที่บันทึกไว้</p>':o.innerHTML=r.map(s=>a.innerHTML.replace(/{CODE}/g,T(s.code)).replace(/{PRICE}/g,B(s.price)).replace(/{RAW_PRICE}/g,s.price)).join(""),H=null;const l=document.querySelector('#favManagerModal [data-act="edit-selected-fav"]'),n=document.querySelector('#favManagerModal [data-act="del-selected-fav"]');l&&(l.disabled=!0),n&&(n.disabled=!0)}async function Ut(e){const o=document.querySelector("#favManagerModal");if(!o||!e)return;const a=R[e]?.name||e;o.dataset.currentType=e,pe=!1,H=null,document.querySelector("#favManagerTitle").textContent=`จัดการ '${T(a)}'`,Se(e),await W("#favManagerModal")}function Gt(e){if(!e||!e.matches(f.itemCard))return null;const o=e.dataset.type;if(!o)return null;let a={type:o,is_suspended:e.classList.contains("is-suspended")};try{return o==="set"?Object.assign(a,{width_m:y(e.querySelector(f.setWidthInput)?.value),height_m:y(e.querySelector(f.setHeightInput)?.value),style:e.querySelector(f.setStyleSelect)?.value||"",fabric_variant:e.querySelector(f.setFabricVariantSelect)?.value||"",price_per_m_raw:y(e.querySelector(f.setPricePerMSelect)?.value),sheer_price_per_m:y(e.querySelector(f.setSheerPricePerMSelect)?.value),fabric_code:e.querySelector(f.setFabricCodeInput)?.value||"",sheer_fabric_code:e.querySelector(f.setSheerCodeInput)?.value||"",opening_style:e.querySelector(f.setOpeningStyleSelect)?.value||"",adjustment_side:e.querySelector(f.setAdjustmentSideSelect)?.value||"ปรับขวา",track_color:e.querySelector(f.setTrackColorInput)?.value||"ขาว",bracket_color:e.querySelector(f.setBracketColorInput)?.value||"ขาว",finial_color:e.querySelector(f.setFinialColorInput)?.value||"ขาว",grommet_color:e.querySelector(f.setGrommetColorInput)?.value||"เงิน",notes:e.querySelector(f.setNotesInput)?.value||""}):o==="wallpaper"?Object.assign(a,{height_m:y(e.querySelector(f.wallHeightInput)?.value),wallpaper_code:e.querySelector(f.wallCodeInput)?.value||"",price_per_roll:y(e.querySelector(f.wallPriceRollInput)?.value),install_cost_per_roll:y(e.querySelector(f.wallInstallCostInput)?.value),notes:e.querySelector(f.wallNotesInput)?.value||"",widths:Array.from(e.querySelectorAll(f.wallWidthInput)).map(t=>y(t.value))}):e.matches(f.areaBasedItem)&&(Object.assign(a,{width_m:y(e.querySelector(f.areaWidthInput)?.value),height_m:y(e.querySelector(f.areaHeightInput)?.value),price_sqyd:y(e.querySelector(f.areaPriceSqydInput)?.value),code:e.querySelector(f.areaCodeInput)?.value||"",notes:e.querySelector(f.areaNotesInput)?.value||""}),(o==="partition"||o==="pleated_screen")&&(a.opening_style=e.querySelector('select[name="opening_style"]')?.value||"แยกกลาง"),["wooden_blind","roller_blind","vertical_blind","aluminum_blind"].includes(o)&&(a.adjustment_side=e.querySelector('select[name="adjustment_side"]')?.value||"ปรับขวา")),a}catch(t){return console.error("Failed to extract item data:",t,e),null}}function Yt(e){if(!e)return;const o=Gt(e);if(!o){w("ไม่สามารถคัดลอกรายการได้","error");return}const a=e.closest(f.room);if(!a||!a.getItemsContainer())return;oe(j()),K();let r;if(o.type==="set")r=ke(o);else if(o.type==="wallpaper")r=xe(o);else if(R[o.type]?.templateId==="#areaBasedTpl")r=Ie(o.type,o);else{w("ไม่รู้จักประเภทรายการ","error");return}if(r){e.after(r),r.classList.add("item-created");const l=e.querySelector(f.itemDetailsMore);l&&l.classList.contains("show")&&_e(r,!0),fe(r),Q(),D(),w("คัดลอกรายการแล้ว","success")}}function Jt(){const e=document.querySelector(f.orderForm),o=document.querySelector(f.fileImporter),a=document.querySelector("#favImporter"),t=document.querySelector(f.menuDropdown),r=document.querySelector(f.quickNavDropdown),l=document.querySelector(f.menuBtn),n=document.querySelector(f.quickNavBtn);if(e.addEventListener("item-update",D),e.addEventListener("input",s=>{if(G){s.preventDefault();return}s.target.closest("#customerInfo")&&V();const c=s.target.closest("input[data-favorite-type]");if(c&&we(c),s.target.matches(f.roomNameInput)){const i=s.target.closest(".room-card")?.querySelector("[data-room-name-display]");i&&(i.textContent=s.target.value||"ห้อง"),Le(),he(),me(V,300)()}s.target.matches('input[name$="_m"], input[name$="price_sqyd"], input[name$="price_roll"], input[name$="install_cost"]')&&D()}),e.addEventListener("change",s=>{if(G){s.preventDefault();return}s.target.matches("select")&&D()}),e.addEventListener("blur",s=>{const c=s.target;c.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_install_cost"]')?(Wt(c),c.value=y(c.value)>0?B(y(c.value)):""):c.matches('input[name$="_m"], input[name^="wall_width_m"]')&&(c.value=te(c.value)),c.matches('input:not([type="hidden"]), select, textarea')&&V()},!0),e.addEventListener("focusin",s=>{const c=s.target;if(c.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_install_cost"]')&&y(c.value)>0&&(c.value=y(c.value)),c.matches('input:not([type="hidden"]), select, textarea')){const d=document.querySelector(".main-header"),i=document.querySelector(".summary-footer"),h=d?d.offsetHeight+16:80,u=i?i.offsetHeight+16:100,m=window.innerHeight,_=c.getBoundingClientRect();if(_.top<h||_.bottom>m-u){const g=c.closest(".item-card, .room-card");g&&fe(g)}}},!0),e.addEventListener("keydown",s=>{if(G){s.preventDefault();return}const c=s.target;s.key==="Enter"&&c.matches("input, select")&&!c.closest(".modal-wrapper")&&s.preventDefault()}),document.addEventListener("click",async s=>{s.target.closest(".menu-container")||(t?.classList.remove("show"),l?.setAttribute("aria-expanded","false"),r?.classList.remove("show"),n?.setAttribute("aria-expanded","false")),s.target.closest(".room-options-container")||document.querySelectorAll(".room-options-menu.show").forEach(u=>u.classList.remove("show"));const c=s.target.closest(".summary-tag[data-filter-type]");if(c&&c.closest("#overviewModal")){const u=c.dataset.filterType,m=c.textContent.trim().replace(/\s*\d+\s*$/,""),_=document.querySelector("#overviewModal");_&&_.classList.remove("visible"),Ct(u,m);return}const d=s.target.closest(".fav-manager-item");if(d){const u=d.closest("#favManagerModal"),m=u?.querySelector(".fav-manager-item.is-selected");m&&m.classList.remove("is-selected"),m!==d?(d.classList.add("is-selected"),H={code:d.dataset.code,price:y(d.dataset.price)}):H=null,u&&(u.querySelector('[data-act="edit-selected-fav"]').disabled=!H,u.querySelector('[data-act="del-selected-fav"]').disabled=!H);return}const i=s.target.closest(".fav-selector-item");if(i){nt(i);return}const h=s.target.closest("[data-act]");if(h){const u=h.dataset.act,m=h.closest(".item-card"),_=h.closest(".room-card"),x=["toggle-more-details","collapse-room","show-discount-modal","show-suspended-items","clear-filter","close-modal","jump-to-item"];if(G&&!h.closest(".unlockable")&&!x.includes(u)){w("ฟอร์มถูกล็อคอยู่","warning");return}switch(["toggle-more-details","close-modal","collapse-room"].includes(u)||s.preventDefault(),s.stopPropagation(),u){case"show-discount-modal":Et();break;case"show-suspended-items":Ae();break;case"clear-filter":tt();break;case"add-room":le();break;case"add-item":if(_){const g=await rt("เพิ่มรายการใหม่");g&&Ht(g,_)}break;case"collapse-room":_&&(_.open=!1,setTimeout(()=>{Y(),V()},50));break;case"toggle-room-menu":h.nextElementSibling?.classList.toggle("show");break;case"toggle-suspend-room":_&&(_.classList.toggle("is-suspended"),h.closest(".room-options-menu")?.classList.remove("show"),D(),ce==="suspended"?Ae():ie());break;case"clear-room":_&&await z("ล้างข้อมูลในห้อง","?")&&(oe(j()),K(),_.getItemsContainer().innerHTML="",Q(),D(),w("ล้างแล้ว","success"));break;case"del-room":_&&await z("ลบห้อง","?")&&Ee(_,"ลบแล้ว");break;case"del-item":m&&await z("ลบรายการ","?")&&Ee(m,"ลบแล้ว");break;case"duplicate-item":m&&Yt(m);break;case"toggle-suspend":m&&(m.classList.toggle("is-suspended"),D(),ce==="suspended"?Ae():ie());break;case"change-type":m&&Ot(m);break;case"toggle-more-details":m&&!m.querySelector(".item-details-more")?.classList.contains("show")&&document.querySelectorAll(".item-details-more.show").forEach(g=>{g.closest(".item-card")!==m&&_e(g.closest(".item-card"),!1)}),_e(m);break;case"open-hardware-modal":O=m,O&&Pt();break;case"apply-hardware-to-room":{const g=h.closest("#hardwareModal"),p=O?.closest(f.room);if(!g||!p||!O)break;if(O.querySelector('[name="set_style"]')?.value==="ม่านพับ"){w("ไม่สามารถใช้กับม่านพับได้","warning");break}const k=g.querySelector('[name="modal_track_color"]').value,S=g.querySelector('[name="modal_bracket_color"]').value,b=g.querySelector('[name="modal_finial_color"]').value,I=g.querySelector('[name="modal_grommet_color"]').value;p.querySelectorAll('.set-item:not(:has(select[name="set_style"][value="ม่านพับ"]))').forEach(q=>{q.querySelector('[name="track_color"]').value=k,q.querySelector('[name="bracket_color"]').value=S,q.querySelector('select[name="set_style"]')?.value==="ตาไก่"&&(q.querySelector('[name="finial_color"]').value=b,q.querySelector('[name="grommet_color"]').value=I)}),V(),w("ใช้กับรายการที่เข้ากันได้ในห้องแล้ว","success");break}case"add-wall":{const g=h.closest(".walls-section")?.querySelector("[data-walls-container]");if(g){const p=Ne();p&&(g.appendChild(p),p.querySelector("input")?.focus(),D())}break}case"del-wall":{const g=h.closest(".wall-input-row");g&&await z("ลบผนัง","?")&&Ee(g,"ลบแล้ว");break}case"show-favorites":{const g=h.closest(".form-group-with-favorites")?.querySelector("input[data-favorite-type]");g&&at(g);break}case"toggle-favorite":{const p=h.closest(".form-group-with-favorites")?.querySelector("input[data-favorite-type]");if(!p||!m)break;const v=p.dataset.favoriteType,k=p.value;let S=0,b;if(p.name==="fabric_code"?b=m.querySelector('[name="set_price_per_m"]'):p.name==="sheer_fabric_code"?b=m.querySelector('[name="sheer_price_per_m"]'):p.name==="wallpaper_code"?b=m.querySelector('[name="wallpaper_price_roll"]'):p.name==="area_code"&&(b=m.querySelector('[name="area_price_sqyd"]')),S=y(b?.value),!k.trim()){w("โปรดระบุรหัส","warning");break}if(!["fabric","sheer"].includes(v)&&S<=0){w("โปรดระบุราคา","warning");break}const I=ge(v,k,S);I!==null&&(h.classList.toggle("is-favorite",I),w(I?"เพิ่มแล้ว":"ลบแล้ว","success"),V());break}case"add-new-fav-form":{const p=h.closest("#favManagerModal")?.dataset.currentType;if(!p)break;const v=document.querySelector("#favAddModal");if(!v)break;v.querySelector("h3").textContent=`เพิ่ม '${R[p]?.name||p}'`;const k=v.querySelector('[name="fav_code_add"]'),S=v.querySelector('[name="fav_price_add"]');k.value="",S.value="";const b=await W("#favAddModal");if(b&&!b.cancelled){const I=k.value.trim(),q=y(S.value);I?ge(p,I,q)!==null?(pe=!0,Se(p),w("เพิ่มแล้ว","success")):w("ล้มเหลว","error"):w("ต้องระบุรหัส","warning")}break}case"edit-selected-fav":{if(!H)break;const p=h.closest("#favManagerModal")?.dataset.currentType;if(!p)break;const v=document.querySelector("#favEditModal");if(!v)break;v.querySelector("h3").textContent=`แก้ไข '${H.code}'`;const k=v.querySelector('[name="fav_code_edit"]'),S=v.querySelector('[name="fav_price_edit"]');k.value=H.code,S.value=H.price>0?H.price:"";const b=await W("#favEditModal");if(b&&!b.cancelled){const I=k.value.trim(),q=y(S.value);I?(I!==H.code&&Fe(p,H.code),ge(p,I,q),pe=!0,Se(p),w("แก้ไขรายการโปรดแล้ว","success")):w("ต้องระบุรหัส","warning")}break}case"del-selected-fav":{if(!H)break;const p=h.closest("#favManagerModal")?.dataset.currentType;if(!p)break;await z("ลบรายการโปรด",`"${H.code}"?`)&&(Fe(p,H.code)?(pe=!0,Se(p),w("ลบแล้ว","success")):w("ล้มเหลว","error"));break}case"jump-to-item":Vt(h);break}}else{const u=s.target.closest("summary");u&&u.closest("details.card")&&setTimeout(()=>{Y(),V()},50)}}),document.querySelector("#undoBtn")?.addEventListener("click",s=>{s.preventDefault(),Bt()}),document.querySelector(f.lockBtn)?.addEventListener("click",s=>{s.preventDefault(),Ft()}),document.querySelector(f.toggleAllRoomsBtn)?.addEventListener("click",s=>{s.preventDefault(),Nt()}),n&&r){n.addEventListener("click",c=>{c.stopPropagation(),t?.classList.remove("show");const d=!r.classList.contains("show");r.classList.toggle("show",d),n.setAttribute("aria-expanded",d),d&&l?.setAttribute("aria-expanded","false")}),document.querySelector(f.quickNavRoomList)?.addEventListener("click",c=>{const d=c.target.closest("a[data-jump-to]");if(d){c.preventDefault();const i=d.dataset.jumpTo,h=document.getElementById(i);h&&(h.open=!0,Te(),h.scrollIntoView({behavior:"smooth",block:"center"}),h.classList.add("scrolling-jump"),setTimeout(()=>h.classList.remove("scrolling-jump"),2500),setTimeout(Y,100)),r.classList.remove("show"),n.setAttribute("aria-expanded","false")}});const s=document.querySelector("#addRoomQuickNavBtn");if(s){const c=pt(le,700);s.addEventListener("click",d=>{d.stopPropagation(),c(),r.classList.remove("show"),n.setAttribute("aria-expanded","false")})}}l&&t&&l.addEventListener("click",s=>{s.stopPropagation(),r?.classList.remove("show");const c=!t.classList.contains("show");t.classList.toggle("show",c),l.setAttribute("aria-expanded",c),c&&n?.setAttribute("aria-expanded","false")}),document.querySelector("#themeToggleBtn")?.addEventListener("click",s=>{s.preventDefault(),Mt(),t?.classList.remove("show"),l?.setAttribute("aria-expanded","false")}),document.querySelector("#overviewBtn")?.addEventListener("click",async s=>{s.preventDefault(),t?.classList.remove("show"),l?.setAttribute("aria-expanded","false");const c=j(),d=document.querySelector("#overviewModalHeader"),i=document.querySelector("#overviewModalBody");if(d&&i){const h=c.rooms.reduce((_,x)=>_+(x.is_suspended?0:(x.items||[]).filter(g=>!g.is_suspended&&(E.calculateSetPrice(g)?.total>0||E.calculateWallpaperPrice(g)?.total>0||E.calculateAreaBasedPrice(g)?.total>0)).length),0),u=document.querySelector(f.grandTotal)?.textContent||"0",m=c.rooms.filter(_=>!_.is_suspended&&_.items?.some(x=>!x.is_suspended)).length;d.innerHTML=`<div class="overview-stats-grid"><div class="overview-stat-card"><i class="ph-bold ph-map-pin-line"></i><div class="stat-value">${m}</div><div class="stat-label">ห้อง</div></div><div class="overview-stat-card"><i class="ph-bold ph-stack"></i><div class="stat-value">${h}</div><div class="stat-label">รายการ</div></div><div class="overview-stat-card"><i class="ph-bold ph-coins"></i><div class="stat-value">${u}</div><div class="stat-label">ยอดรวม</div></div></div>`,i.innerHTML=xt(c),W("#overviewModal")}}),document.querySelector("#copyTextBtn")?.addEventListener("click",async s=>{s.preventDefault(),t?.classList.remove("show"),l?.setAttribute("aria-expanded","false");const c=document.querySelector(f.copyOptionsModal);if(!c)return;c.querySelector('input[name="copy_option"][value="customer"]').checked=!0;const d=await W(f.copyOptionsModal);if(d&&!d.cancelled){const i=c.querySelector('input[name="copy_option"]:checked').value,h=kt(j(),i);try{await navigator.clipboard.writeText(h),w("คัดลอกสำเร็จ!","success")}catch{w("คัดลอกล้มเหลว","error")}}}),document.querySelector("#visualReportsBtn")?.addEventListener("click",async s=>{s.preventDefault(),t?.classList.remove("show"),l?.setAttribute("aria-expanded","false");const c=document.querySelector("#visualReportsModal");if(!c)return;c.querySelector('input[name="report_type_option"][value="lookbook"]').checked=!0;const d=await W("#visualReportsModal");if(d&&!d.cancelled){const i=c.querySelector('input[name="report_type_option"]:checked').value;if(i==="lookbook"){const h=j(),u=Tt(h),m=document.querySelector("#lookbookModalBody");u&&m?(m.innerHTML=u,W("#lookbookModal")):w("ไม่มีข้อมูล","warning")}else w(`'${i}' ยังไม่พร้อม`,"default")}}),document.querySelector(f.exportPdfBtn)?.addEventListener("click",async s=>{s.preventDefault(),t?.classList.remove("show"),l?.setAttribute("aria-expanded","false");const c=await At();if(!c)return;const d=j(),i=It(d,{vatRate:c.vatOption==="include"?N.baseVatRate:0,pageBreakBuffer:c.pageBreakBuffer});if(!i){w("ไม่มีรายการ","warning");return}c.exportMethod==="html"?jt(i):Dt(i.html,c.exportMethod)}),document.querySelector(f.submitBtn)?.addEventListener("click",async s=>{if(s.preventDefault(),t?.classList.remove("show"),l?.setAttribute("aria-expanded","false"),await z("ส่งข้อมูล","?")){const c=j();if(!c.customer_name&&!c.customer_phone){w("ใส่ชื่อ/เบอร์","warning");return}w("กำลังส่ง...","default");try{const d=await fetch(it,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});d.ok?w("ส่งแล้ว!","success"):w(`ล้มเหลว: ${d.status}`,"error")}catch{w("เชื่อมต่อผิดพลาด","error")}}}),document.querySelector(f.importBtn)?.addEventListener("click",s=>{s.preventDefault(),t?.classList.remove("show"),l?.setAttribute("aria-expanded","false"),o?.click()}),o?.addEventListener("change",s=>{const c=s.target.files?.[0];if(!c)return;const d=new FileReader;d.onload=async i=>{try{const h=JSON.parse(i.target.result);if(h&&typeof h=="object")await De(h,!0);else throw new Error("Invalid JSON")}catch(h){w("ไฟล์ JSON ไม่ถูก","error"),console.error(h)}},d.readAsText(c),s.target.value=null}),document.querySelector(f.exportBtn)?.addEventListener("click",s=>{s.preventDefault(),t?.classList.remove("show"),l?.setAttribute("aria-expanded","false");try{const c=j(),d=JSON.stringify(c,null,4),i=new Blob([d],{type:"application/json"}),h=URL.createObjectURL(i),u=document.createElement("a"),m=new Date,_=`${m.getFullYear()}${(m.getMonth()+1).toString().padStart(2,"0")}${m.getDate().toString().padStart(2,"0")}`,x=`${m.getHours().toString().padStart(2,"0")}${m.getMinutes().toString().padStart(2,"0")}`,g=Je(c.customer_name||"data");u.href=h,u.download=`MTR-${_}${x}-${g}.json`,u.click(),URL.revokeObjectURL(h),w("Export สำเร็จ","success")}catch{w("Export ล้มเหลว","error")}}),document.querySelector("#importFavsBtn")?.addEventListener("click",s=>{s.preventDefault(),t?.classList.remove("show"),l?.setAttribute("aria-expanded","false"),a?.click()}),a?.addEventListener("change",s=>{const c=s.target.files?.[0];if(!c)return;const d=new FileReader;d.onload=i=>{try{const h=JSON.parse(i.target.result),u=Re(h);u>0?w(`เพิ่ม ${u} รายการ`,"success"):w("ไม่พบรายการใหม่","default"),document.querySelectorAll("input[data-favorite-type]").forEach(we)}catch{w("ไฟล์ JSON ไม่ถูก","error")}},d.readAsText(c),s.target.value=null}),document.querySelector("#exportFavsBtn")?.addEventListener("click",s=>{s.preventDefault(),t?.classList.remove("show"),l?.setAttribute("aria-expanded","false");try{const c=Z();if(Object.values(c).every(_=>_.length===0)){w("ไม่มีรายการ","warning");return}const d=JSON.stringify(c,null,4),i=new Blob([d],{type:"application/json"}),h=URL.createObjectURL(i),u=document.createElement("a"),m=new Date().toISOString().slice(0,10).replace(/-/g,"");u.href=h,u.download=`MTR-Favorites-${m}.json`,u.click(),URL.revokeObjectURL(h),w("Export สำเร็จ","success")}catch{w("Export ล้มเหลว","error")}}),document.querySelector(f.clearItemsBtn)?.addEventListener("click",async s=>{if(s.preventDefault(),t?.classList.remove("show"),l?.setAttribute("aria-expanded","false"),await z("ล้างทุกรายการ","?")){oe(j()),K(),document.querySelectorAll(f.room).forEach(i=>{i.getItemsContainer().innerHTML=""});const c=document.querySelector("#discount_type"),d=document.querySelector("#discount_value");c&&(c.value="amount"),d&&(d.value="0"),Q(),D(),w("ล้างแล้ว","success")}}),document.querySelector(f.clearAllBtn)?.addEventListener("click",async s=>{s.preventDefault(),t?.classList.remove("show"),l?.setAttribute("aria-expanded","false"),await z("ลบข้อมูลทั้งหมด","คำเตือน! ลบถาวร?")&&(localStorage.removeItem(de),ht(),window.location.reload())}),window.addEventListener("click",s=>{s.target.closest(".menu-container")||(t?.classList.remove("show"),r?.classList.remove("show"),l?.setAttribute("aria-expanded","false"),n?.setAttribute("aria-expanded","false")),s.target.closest(".room-options-container")||document.querySelectorAll(".room-options-menu.show").forEach(d=>d.classList.remove("show"));const c=s.target.closest(".item-card");document.querySelectorAll(".item-details-more.show").forEach(d=>{const i=d.closest(".item-card");i!==c&&_e(i,!1)})}),window.addEventListener("beforeunload",V)}function Kt(){const e=document.querySelector(f.setTpl);if(!e)return;const o=e.content.querySelector(f.setPricePerMSelect),a=e.content.querySelector(f.setSheerPricePerMSelect),t=r=>{let l='<option value="" hidden>เลือกราคา</option>';return Array.isArray(r)?(r.forEach(n=>{l+=`<option value="${n}">${n.toLocaleString("th-TH")}</option>`}),l):(console.error("Price data for dropdown is not available or not an array.",r),l)};o&&(o.innerHTML=t(be.fabric)),a&&(a.innerHTML=t(be.sheer))}function Qt(){Kt(),et(),Jt();try{const e=localStorage.getItem(de);if(e&&e!=="null"&&e!=="{}"){const o=JSON.parse(e);if(o&&Array.isArray(o.rooms))De(o,!1);else{console.warn("Stored data structure seems invalid, starting fresh."),localStorage.removeItem(de),le();const a=document.querySelector(f.customerCard);a&&(a.open=!0)}}else{le();const o=document.querySelector(f.customerCard);o&&(o.open=!0)}}catch(e){console.error("Failed to load or parse data from localStorage:",e),localStorage.removeItem(de),le();const o=document.querySelector(f.customerCard);o&&(o.open=!0)}D(),ot(),Y(),he(),K(),console.log("Marnthara App Initialized (Vite Refactor)")}document.addEventListener("DOMContentLoaded",Qt);
