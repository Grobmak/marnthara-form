(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))t(o);new MutationObserver(o=>{for(const n of o)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&t(r)}).observe(document,{childList:!0,subtree:!0});function s(o){const n={};return o.integrity&&(n.integrity=o.integrity),o.referrerPolicy&&(n.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?n.credentials="include":o.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function t(o){if(o.ep)return;o.ep=!0;const n=s(o);fetch(o.href,n)}})();const ut="vite-refactor/6.1.0",pt="https://your-make-webhook-url.com/your-unique-path",ge="marnthara.input.v6.1",ft=500,V={name:"ม่านธารา ผ้าม่านและของตกแต่ง",address:"65/8 หมู่ 2 ต.ท่าศาลา อ.เมือง จ.ลพบุรี 15000",phone:"092-985-9395, 082-552-5595",taxId:"1600668000020",logoUrl:"./assets/logo.png",baseVatRate:.07,pdf:{paymentTerms:"ชำระมัดจำ 50%",priceValidity:"30 วัน",notes:["ราคานี้รวมค่าติดตั้งแล้ว","ชำระมัดจำ 50% เพื่อยืนยืนการสั่งผลิตสินค้า","ใบเสนอราคานี้มีอายุ 30 วัน นับจากวันที่เสนอราคา"]}},mt=1.19599,ht={ROLL_WIDTH_M:.53,STRIPS_PER_ROLL_UNDER_2_5M:3},be={fabric:[1e3,1100,1200,1300,1400,1500,1600,1700,1800,1900,2e3,2100,2200,2300,2400,2500,2600,2700,2800,2900,3e3],sheer:[1e3,1100,1200,1300,1400,1500],louis:[2200,2300,2400,2500,2600,2700,2800,2900,3e3,3100,3200,3300,3400,3500],style_surcharge:{ลอน:200,ตาไก่:0,จีบ:0,ม่านพับ:0,ม่านแป๊บ:0,หลุยส์:0},height:[{threshold:3.2,add_per_m:300},{threshold:2.8,add_per_m:200},{threshold:2.5,add_per_m:100}]},O={set:{templateId:"#setTpl",name:"ผ้าม่าน"},wallpaper:{templateId:"#wallpaperTpl",name:"วอลล์เปเปอร์"},wooden_blind:{templateId:"#areaBasedTpl",name:"มู่ลี่ไม้"},roller_blind:{templateId:"#areaBasedTpl",name:"ม่านม้วน"},vertical_blind:{templateId:"#areaBasedTpl",name:"ม่านปรับแสง"},partition:{templateId:"#areaBasedTpl",name:"ฉากกั้นห้อง"},pleated_screen:{templateId:"#areaBasedTpl",name:"มุ้งจีบ"},aluminum_blind:{templateId:"#areaBasedTpl",name:"มู่ลี่อลูมิเนียม"}},m={orderForm:"#orderForm",roomsContainer:"#rooms",toastContainer:"#toast-container",printableContent:"#printable-content",filterStatusBar:"#filterStatusBar",menuBtn:"#menuBtn",menuDropdown:"#menuDropdown",undoBtn:"#undoBtn",themeToggleBtn:"#themeToggleBtn",overviewBtn:"#overviewBtn",copyTextBtn:"#copyTextBtn",visualReportsBtn:"#visualReportsBtn",exportPdfBtn:"#exportPdfBtn",submitBtn:"#submitBtn",importBtn:"#importBtn",exportBtn:"#exportBtn",importFavsBtn:"#importFavsBtn",exportFavsBtn:"#exportFavsBtn",clearItemsBtn:"#clearItemsBtn",clearAllBtn:"#clearAllBtn",lockBtn:"#lockBtn",quickNavBtn:"#quickNavBtn",quickNavDropdown:"#quickNavDropdown",quickNavRoomList:"#quickNavRoomList",quickNavBtnText:"#quickNavBtnText",toggleAllRoomsBtn:"#toggleAllRoomsBtn",suspendedItemsBtn:"#suspendedItemsBtn",suspendedCountBadge:"#suspendedCountBadge",originalTotal:"#originalTotal",grandTotal:"#grandTotal",fileImporter:"#fileImporter",favImporter:"#favImporter",customerCard:"#customerDetailsCard",customerNameInput:"#customer_name",customerPhoneInput:"#customer_phone",customerAddressInput:"#customer_address",room:".room-card",roomTpl:"#roomTpl",roomNameInput:'input[name="room_name"]',roomNameDisplay:"[data-room-name-display]",roomBrief:"[data-room-brief]",allItemsContainer:"[data-all-items]",roomDefaultsBtn:'[data-act="open-room-defaults"]',itemCard:".item-card",itemDetailsMore:".item-details-more",itemGrid:".item-grid",itemTitle:"[data-item-title]",toggleDetailsBtn:'[data-act="toggle-more-details"]',setTpl:"#setTpl",setWidthInput:'input[name="width_m"]',setHeightInput:'input[name="height_m"]',setStyleSelect:'select[name="set_style"]',setFabricVariantSelect:'select[name="fabric_variant"]',setPricePerMSelect:'select[name="set_price_per_m"]',setSheerPricePerMSelect:'select[name="sheer_price_per_m"]',setLouisPricePerMSelect:'select[name="louis_price_per_m"]',setFabricCodeInput:'input[name="fabric_code"]',setSheerCodeInput:'input[name="sheer_fabric_code"]',setOpeningStyleSelect:'select[name="opening_style"]',setAdjustmentSideSelect:'select[name="adjustment_side"]',setTrackColorInput:'input[name="track_color"]',setBracketColorInput:'input[name="bracket_color"]',setFinialColorInput:'input[name="finial_color"]',setGrommetColorInput:'input[name="grommet_color"]',setLouisValanceInput:'input[name="louis_valance"]',setLouisTasselsInput:'input[name="louis_tassels"]',setNotesInput:'input[name="notes"]',wallpaperTpl:"#wallpaperTpl",wallTpl:"#wallTpl",wallHeightInput:'[name="wallpaper_height_m"]',wallCodeInput:'[name="wallpaper_code"]',wallPriceRollInput:'[name="wallpaper_price_roll"]',wallInstallCostInput:'[name="wallpaper_install_cost"]',wallNotesInput:'[name="wallpaper_notes"]',wallWidthInput:'[name="wall_width_m"]',areaBasedTpl:"#areaBasedTpl",areaBasedItem:".area-based-item",areaWidthInput:'[name="area_width_m"]',areaHeightInput:'[name="area_height_m"]',areaPriceSqydInput:'[name="area_price_sqyd"]',areaCodeInput:'[name="area_code"]',areaNotesInput:'[name="area_notes"]',modal:"#confirmationModal",modalTitle:"#modalTitle",modalBody:"#modalBody",discountModal:"#discountModal",discountSubtotal:"#discountSubtotal",discountPercent:"#discountPercent",discountAmount:"#discountAmount",discountFinalTotal:"#discountFinalTotal",discountTypeInput:"#discount_type",discountValueInput:"#discount_value",copyOptionsModal:"#copyOptionsModal",visualReportsModal:"#visualReportsModal",lookbookModal:"#lookbookModal",lookbookModalBody:"#lookbookModalBody",exportOptionsModal:"#exportOptionsModal",pdfOptionsModal:"#pdfOptionsModal",exportPdfWithDetailsBtn:"#exportPdfWithDetailsBtn",exportPdfWithoutDetailsBtn:"#exportPdfWithoutDetailsBtn",itemTypeModal:"#itemTypeModal",itemTypeModalTitle:"#itemTypeModalTitle",hardwareModal:"#hardwareModal",modalTrackColor:'[name="modal_track_color"]',modalBracketColor:'[name="modal_bracket_color"]',modalFinialColor:'[name="modal_finial_color"]',modalGrommetColor:'[name="modal_grommet_color"]',modalLouisValance:'[name="modal_louis_valance"]',modalLouisTassels:'[name="modal_louis_tassels"]',trackColorGroup:"#trackColorGroup",bracketColorGroup:"#bracketColorGroup",finialColorGroup:"#finialColorGroup",grommetColorGroup:"#grommetColorGroup",louisValanceGroup:"#louisValanceGroup",louisTasselGroup:"#louisTasselGroup",hardwareApplyToRoomBtn:"#hardwareApplyToRoom",favoritesConflictModal:"#favoritesConflictModal",favoritesModal:"#favoritesModal",favoritesModalTitle:"#favoritesModalTitle",favoritesModalBody:"#favoritesModalBody",favSearchInput:"#favSearchInput",favSelectorItemTpl:"#favSelectorItemTpl",favInput:"input[data-favorite-type]",favManagerModal:"#favManagerModal",favManagerTitle:"#favManagerTitle",favManagerBody:"#favManagerBody",favManagerItemTpl:"#favManagerItemTpl",favManagerEditBtn:'#favManagerModal [data-act="edit-selected-fav"]',favManagerDelBtn:'#favManagerModal [data-act="del-selected-fav"]',favAddModal:"#favAddModal",favAddCodeInput:'[name="fav_code_add"]',favAddPriceInput:'[name="fav_price_add"]',favEditModal:"#favEditModal",favEditCodeInput:'[name="fav_code_edit"]',favEditPriceInput:'[name="fav_price_edit"]',roomDefaultsModal:"#roomDefaultsModal",roomDefaultsForm:"#roomDefaultsForm",roomDefaultsApplyBtn:"#roomDefaultsApplyBtn",roomDefaultsConfirmBtn:"#roomDefaultsConfirmBtn",roomDefaultsCancelBtn:"#roomDefaultsCancelBtn",overviewModal:"#overviewModal",overviewModalHeader:"#overviewModalHeader",overviewModalBody:"#overviewModalBody"},_=e=>{typeof e=="string"&&(e=e.replace(/,/g,""));const a=parseFloat(e);return Number.isFinite(a)?a:0},K=e=>{const a=_(e);return a>0?a.toFixed(2):""},We=e=>{const a=e.target,s=a.value.trim();if(s===""){a.value="";return}let t=_(s);if(t<=0){a.value="";return}s.includes(".")||(t=t/100),a.value=K(t)},oe=(e,a=2,s=!1)=>Number.isFinite(e)?e.toLocaleString("en-US",{minimumFractionDigits:s?2:a,maximumFractionDigits:s?2:a}):"0",B=(e,a=0)=>Number.isFinite(e)?e.toLocaleString("th-TH",{minimumFractionDigits:a,maximumFractionDigits:a}):"0",qe=(e,a=150)=>{let s;return(...t)=>{clearTimeout(s),s=setTimeout(()=>e(...t),a)}},yt=(e,a=200)=>{let s=0,t;return(...o)=>{const n=new Date().getTime();t&&(clearTimeout(t),t=null),n-s>=a?(s=n,e(...o)):t=setTimeout(()=>{s=new Date().getTime(),e(...o),t=null},a-(n-s))}},M=e=>e?e.replace(/[<>"'&]/g,a=>{switch(a){case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";case"'":return"&#39;";case"&":return"&amp;";default:return a}}):"",ot=e=>e?e.replace(/[<>:"/\\|?*]/g,"").replace(/[\s\n\t]+/g,"_").substring(0,100):"file";function _t(e){if(e=_(e),e===0)return"ศูนย์บาทถ้วน";if(e<0||e>99999999999999e-2)return"N/A";const a=["ศูนย์","หนึ่ง","สอง","สาม","สี่","ห้า","หก","เจ็ด","แปด","เก้า","สิบ"],s=["","สิบ","ร้อย","พัน","หมื่น","แสน","ล้าน"];e=parseFloat(e.toFixed(2));let t=Math.floor(e),o=Math.round((e-t)*100);const n=i=>{if(i===0)return"";let l="";const d=String(i);for(let c=0;c<d.length;c++){const p=d[c],u=d.length-c-1;p!=="0"&&(u===1&&p==="1"?l+=s[u]:u===1&&p==="2"?l+="ยี่"+s[u]:u===0&&p==="1"&&d.length>1?l+="เอ็ด":l+=a[parseInt(p)]+s[u])}return l};let r="";if(t>0){const i=Math.floor(t/1e6),l=t%1e6;i>0&&(r+=n(i)+"ล้าน"),r+=n(l),r+="บาท"}else r="ศูนย์บาท";return o===0?r+="ถ้วน":r+=n(o)+"สตางค์",r}const Ve="marnthara.favorites.v4",Se={fabric:[],sheer:[],wallpaper:[],wooden_blind:[],roller_blind:[],vertical_blind:[],partition:[],pleated_screen:[],aluminum_blind:[]};function de(){try{const e=localStorage.getItem(Ve);return e?{...Se,...JSON.parse(e)}:Se}catch(e){return console.error("Failed to parse favorites from localStorage",e),Se}}function Ie(e){try{localStorage.setItem(Ve,JSON.stringify(e))}catch(a){console.error("Failed to save favorites to localStorage",a)}}function Ue(e){if(!e||typeof e!="object")return console.error("Invalid favorites data for import."),!1;const a={...Se,...e};return Ie(a),!0}function Oe(e){if(!e||typeof e!="object")return console.error("Invalid favorites data for merge."),0;const a=de();let s=0;for(const t in e)Object.hasOwnProperty.call(e,t)&&Array.isArray(e[t])&&(a[t]||(a[t]=[]),e[t].forEach(o=>{o&&o.code&&o.hasOwnProperty("price")?a[t].some(r=>r.code===o.code)||(a[t].push({code:o.code,price:o.price}),s++):console.warn(`Skipping invalid favorite item during merge for type ${t}:`,o)}),a[t].sort((o,n)=>o.code.localeCompare(n.code)));return s>0&&Ie(a),s}function Je(e,a,s){const t=de(),o=a?.trim();if(!o)return console.error(`Attempted to add favorite with empty code for type: ${e}`),!1;if(typeof s!="number"||isNaN(s)||s<0)return console.error(`Attempted to add favorite with invalid price (${s}) for code ${o}`),!1;if(!Object.hasOwnProperty.call(Se,e))return console.error(`Attempted to add favorite to an invalid type: ${e}`),!1;t[e]||(t[e]=[]);const n=t[e],r=n.find(i=>i.code===o);return r?r.price=s:n.push({code:o,price:s}),n.sort((i,l)=>i.code.localeCompare(l.code)),Ie(t),!0}function Ye(e,a){const s=de(),t=a?.trim();if(!s[e]||!t)return!1;const o=s[e].findIndex(n=>n.code===t);return o>-1?(s[e].splice(o,1),Ie(s),!0):!1}function vt(){localStorage.removeItem(Ve),console.log("All favorites have been cleared.")}function U(){const e=de(),a={app_version:ut,customer_name:document.querySelector(m.customerNameInput)?.value||"",customer_phone:document.querySelector(m.customerPhoneInput)?.value||"",customer_address:document.querySelector(m.customerAddressInput)?.value||"",customer_card_open:document.querySelector(m.customerCard)?.open,discount:{type:document.querySelector(m.discountTypeInput)?.value||"amount",value:_(document.querySelector(m.discountValueInput)?.value)},rooms:[],favorites:e};return document.querySelectorAll(m.room).forEach(s=>{const t={id:s.id,room_name:s.querySelector(m.roomNameInput)?.value||"",is_suspended:s.classList.contains("is-suspended"),is_open:s.open,room_defaults:JSON.parse(s.dataset.roomDefaults||"{}"),items:[]};s.querySelector(m.allItemsContainer)?.childNodes.forEach(o=>{if(o.nodeType!==1||!o.matches(m.itemCard))return;if(o.classList.contains("placeholder-item")){const i={type:"placeholder",is_suspended:o.classList.contains("is-suspended"),width_m:_(o.dataset.widthM),height_m:_(o.dataset.heightM)};t.items.push(i);return}const n=o.dataset.type;if(!n)return;let r={type:n,is_suspended:o.classList.contains("is-suspended")};if(n==="set")Object.assign(r,{width_m:_(o.querySelector(m.setWidthInput)?.value),height_m:_(o.querySelector(m.setHeightInput)?.value),style:o.querySelector(m.setStyleSelect)?.value||"",fabric_variant:o.querySelector(m.setFabricVariantSelect)?.value||"",price_per_m_raw:_(o.querySelector(m.setPricePerMSelect)?.value),sheer_price_per_m:_(o.querySelector(m.setSheerPricePerMSelect)?.value),louis_price_per_m:_(o.querySelector('select[name="louis_price_per_m"]')?.value),fabric_code:o.querySelector(m.setFabricCodeInput)?.value||"",sheer_fabric_code:o.querySelector(m.setSheerCodeInput)?.value||"",opening_style:o.querySelector(m.setOpeningStyleSelect)?.value||"",adjustment_side:o.querySelector(m.setAdjustmentSideSelect)?.value||"ปรับขวา",track_color:o.querySelector(m.setTrackColorInput)?.value||"ขาว",bracket_color:o.querySelector(m.setBracketColorInput)?.value||"ขาว",finial_color:o.querySelector(m.setFinialColorInput)?.value||"ขาว",grommet_color:o.querySelector(m.setGrommetColorInput)?.value||"เงิน",louis_valance:o.querySelector('input[name="louis_valance"]')?.value||"กล่องหลุยส์",louis_tassels:o.querySelector('input[name="louis_tassels"]')?.value||"สีเข้ากับผ้า",notes:o.querySelector(m.setNotesInput)?.value||""});else if(n==="wallpaper"){const i=o.querySelector(m.wallInstallCostInput),l=i?i.value:"";let d;l==="0"?d=0:_(l)>0?d=_(l):d=void 0,Object.assign(r,{height_m:_(o.querySelector(m.wallHeightInput)?.value),wallpaper_code:o.querySelector(m.wallCodeInput)?.value||"",price_per_roll:_(o.querySelector(m.wallPriceRollInput)?.value),install_cost_per_roll:d,notes:o.querySelector(m.wallNotesInput)?.value||"",widths:Array.from(o.querySelectorAll(m.wallWidthInput)).map(c=>_(c.value))})}else o.matches(m.areaBasedItem)&&(Object.assign(r,{width_m:_(o.querySelector(m.areaWidthInput)?.value),height_m:_(o.querySelector(m.areaHeightInput)?.value),price_sqyd:_(o.querySelector(m.areaPriceSqydInput)?.value),code:o.querySelector(m.areaCodeInput)?.value||"",notes:o.querySelector(m.areaNotesInput)?.value||""}),(n==="partition"||n==="pleated_screen")&&(r.opening_style=o.querySelector('select[name="opening_style"]')?.value||"แยกกลาง"),["wooden_blind","roller_blind","vertical_blind","aluminum_blind"].includes(n)&&(r.adjustment_side=o.querySelector('select[name="adjustment_side"]')?.value||"ปรับขวา"));t.items.push(r)}),a.rooms.push(t)}),a}function Z(){try{const e=U();localStorage.setItem(ge,JSON.stringify(e))}catch(e){console.error("Failed to save data to localStorage:",e)}}const me=[],gt=10;function se(e){if(!e){console.warn("Attempted to push invalid state to undo stack.");return}try{const a=JSON.parse(JSON.stringify(e));me.push(a),me.length>gt&&me.shift()}catch(a){console.error("Failed to clone state for undo history:",a)}}function bt(){if(me.length!==0)return me.pop()}function St(){return me.length>0}const A={stylePlus:e=>be.style_surcharge[e]??0,heightPlus:e=>{const a=[...be.height].sort((s,t)=>t.threshold-s.threshold);for(const s of a)if(e>s.threshold)return s.add_per_m;return 0},fabricYardage:(e,a)=>{const s=_(a);if(s<=0)return 0;let t=0;switch(e){case"ลอน":case"ตาไก่":case"จีบ":t=2.5;break;case"ม่านพับ":t=1.2;break;case"หลุยส์":t=2.5;break;case"ม่านแป๊บ":t=0;break}return t>0?s*t*1.09361:0},calculateGrommets:e=>{const a=_(e.width_m);if(a<=0||e.style!=="ตาไก่")return 0;const s=a*2.5;let o=Math.ceil(s*100/12);return o%2!==0&&o++,o=Math.max(o,Math.ceil(a*4)*2),o},_calculateComponentPrice:e=>{const a=_(e.width),s=_(e.height),t=_(e.price_per_m);if(a<=0||s<=0||t<=0)return 0;if(e.style==="ม่านแป๊บ"){const c=a*t;return Math.round(c/10)*10}const o=A.stylePlus(e.style),n=A.heightPlus(s);let r=0;switch(e.style){case"ลอน":case"ตาไก่":case"จีบ":r=2.5;break;case"ม่านพับ":r=1.2;break;case"หลุยส์":r=2.5;break}if(r===0)return 0;const i=t,l=o+n,d=(i+l)*a*r;return Math.round(d/10)*10},calculateSetPrice:function(e){if(!e||e.is_suspended)return{total:0,opaque:0,sheer:0,louis:0};const s=e.fabric_variant||"ทึบ",t=e.style||"ลอน",o=_(e.width_m),n=_(e.height_m);let r=0,i=0,l=0;if(t==="หลุยส์"){const p=_(e.louis_price_per_m);o>0&&p>0&&(l=p*o,l=Math.round(l/10)*10),s.includes("ทึบ")&&(r=this._calculateComponentPrice({style:t,width:o,height:n,price_per_m:e.price_per_m_raw})),s.includes("โปร่ง")&&(i=this._calculateComponentPrice({style:t,width:o,height:n,price_per_m:e.sheer_price_per_m}))}else s.includes("ทึบ")&&(r=this._calculateComponentPrice({style:t,width:o,height:n,price_per_m:e.price_per_m_raw})),s.includes("โปร่ง")&&(i=this._calculateComponentPrice({style:t,width:o,height:n,price_per_m:e.sheer_price_per_m}));const d=r+i+l;let c=d;return d>0&&d<1e3&&(c=1e3),{total:c,opaque:r,sheer:i,louis:l}},wallpaperRolls:(e,a)=>{if(e<=0||a<=0)return 0;const{ROLL_WIDTH_M:s,STRIPS_PER_ROLL_UNDER_2_5M:t}=ht,o=Math.ceil(e/s);let n;return a<=2.5?n=t:a<=3.3?n=2:n=1,Math.ceil(o/n)},calculateAreaBasedPrice:function(e){if(!e||e.is_suspended)return{total:0,sqm:0,sqyd:0};const a=_(e.width_m),s=_(e.height_m),t=_(e.price_sqyd);if(a<=0||s<=0||t<=0)return{total:0,sqm:0,sqyd:0};const o=a*s;let n=o*mt;n<1?n=1:n=Math.ceil(n*2)/2;const r=n*t;return{total:Math.round(r),sqm:o,sqyd:n}},calculateWallpaperPrice:function(e){if(!e||e.is_suspended)return{total:0,material:0,install:0,rolls:0,sqm:0};const a=e.widths?.reduce((l,d)=>l+_(d),0)||0;if(a<=0)return{total:0,material:0,install:0,rolls:0,sqm:0};const s=_(e.height_m),t=this.wallpaperRolls(a,s),o=t*_(e.price_per_roll);let n=300;const r=e.install_cost_per_roll;r===0?n=0:typeof r=="number"&&r>0?n=r:_(r)>0&&(n=_(r));const i=t*n;return{total:Math.round(o+i),material:Math.round(o),install:Math.round(i),rolls:t,sqm:a*s}}},Y=Object.entries(O).reduce((e,[a,s])=>(e[a]=s.name,e),{});Y.set_louis="ม่านหลุยส์";function le(e){const{width:a=0,height:s=0}=e,t=15,o=100-t*2,n=100-t*2,r=a>0&&s>0?Math.min(o/a,n/s):1,i=a*r,l=s*r,d=(100-i)/2,c=(100-l)/2,p=`
        <line x1="${d}" y1="${c+l+5}" x2="${d+i}" y2="${c+l+5}" class="dimension-line" />
        <line x1="${d}" y1="${c+l+3}" x2="${d}" y2="${c+l+7}" class="dimension-tick" />
        <line x1="${d+i}" y1="${c+l+3}" x2="${d+i}" y2="${c+l+7}" class="dimension-tick" />
        <text x="50" y="${c+l+14}" class="dimension-text">${a.toFixed(2)} ม.</text>

        <line x1="${d-5}" y1="${c}" x2="${d-5}" y2="${c+l}" class="dimension-line" />
        <line x1="${d-7}" y1="${c}" x2="${d-3}" y2="${c}" class="dimension-tick" />
        <line x1="${d-7}" y1="${c+l}" x2="${d-3}" y2="${c+l}" class="dimension-tick" />
        <text x="${d-9}" y="50" class="dimension-text" transform="rotate(-90, ${d-9}, 50)">${s.toFixed(2)} ม.</text>
    `;return{x:d,y:c,svgWidth:i,svgHeight:l,lines:p}}function rt(e,{y:a,svgHeight:s}){if(!e.opening_style||e.opening_style==="สไลด์เดี่ยว"||e.type==="set"&&e.style==="ม่านแป๊บ")return"";const t=e.opening_style==="แยกกลาง"?"< >":"→";return`
        <rect x="40" y="${a+s/2-8}" width="20" height="16" rx="3" class="opening-text-bg" />
        <text x="50" y="${a+s/2+1}" class="opening-text">${t}</text>
    `}function Le(e,{x:a,y:s,svgWidth:t}){if(!e.adjustment_side)return"";const n=e.adjustment_side==="ปรับซ้าย"?a+8:a+t-8;return`
        <g class="adjustment-cord">
            <circle cx="${n}" cy="${s+3}" r="2"/>
            <line x1="${n}" y1="${s+5}" x2="${n}" y2="${s+15}"/>
        </g>
    `}function wt(e){const a=_(e.width_m),s=_(e.height_m);if(a<=0||s<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:t,y:o,svgWidth:n,svgHeight:r,lines:i}=le({width:a,height:s});let l="";const d=e.fabric_variant.includes("โปร่ง"),c=e.fabric_variant.includes("ทึบ"),p=(v,y)=>(e.opening_style||"แยกกลาง")==="แยกกลาง"?`
                <rect x="${t}" y="${o+y}" width="${n/2-1}" height="${r}" class="${v}" />
                <rect x="${t+n/2+1}" y="${o+y}" width="${n/2-1}" height="${r}" class="${v}" />
            `:`<rect x="${t}" y="${o+y}" width="${n}" height="${r}" class="${v}" />`;d&&(l+=p("curtain-panel-sheer",0)),c&&(l+=p("curtain-panel-opaque",d?-2:0));let u="";if(e.style==="ตาไก่"){const v=A.calculateGrommets(e)/((e.opening_style||"แยกกลาง")==="แยกกลาง"?2:1),y=Math.min(Math.floor(v),Math.max(8,Math.floor(n/8)));for(let h=0;h<y;h++){const w=t+n/(y>1?y-1:1)*h;u+=`<circle cx="${w}" cy="${o+2}" r="2" class="style-grommet" />`}}else if(e.style==="ลอน"){const v=Math.max(4,Math.floor(n/10));let y=`M ${t},${o}`;for(let h=0;h<v;h++)y+=" q 5,-4 10,0";u=`<path d="${y}" class="style-ripplefold-path" />`}else e.style==="จีบ"&&(u=`<text x="${t+2}" y="${o+5}" class="style-pleat-text">||| ||| ||| ||| |||</text>`);const f=rt(e,{y:o,svgHeight:r});return`<svg viewBox="0 0 100 100">${l}${u}${f}${i}</svg>`}function qt(e){const a=_(e.width_m),s=_(e.height_m);if(a<=0||s<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:t,y:o,svgWidth:n,svgHeight:r,lines:i}=le({width:a,height:s});let l="";const d=e.fabric_variant.includes("โปร่ง"),c=e.fabric_variant.includes("ทึบ"),p=(h,w)=>`
        <rect x="${t}" y="${o+w}" width="${n/2-1}" height="${r}" class="${h}" />
        <rect x="${t+n/2+1}" y="${o+w}" width="${n/2-1}" height="${r}" class="${h}" />
    `;d&&(l+=p("curtain-panel-sheer",0)),c&&(l+=p("curtain-panel-opaque",d?-2:0));const u=Math.max(3,Math.floor(n/15)),f=n/u;let v="";for(let h=0;h<u;h++){const w=t+h*f;v+=`<path d="M ${w},${o} Q ${w+f/2},${o+10} ${w+f},${o}" class="louis-swag" />`}v+=`
        <polygon points="${t},${o} ${t+8},${o} ${t},${o+15}" class="louis-tail" />
        <polygon points="${t+n},${o} ${t+n-8},${o} ${t+n},${o+15}" class="louis-tail" />
    `;let y="";if(e.louis_tassels&&e.louis_tassels!=="ไม่มี"){y+=`<circle cx="${t+5}" cy="${o+18}" r="2" class="louis-tassel" />`,y+=`<circle cx="${t+n-5}" cy="${o+18}" r="2" class="louis-tassel" />`;for(let h=1;h<u;h++)y+=`<circle cx="${t+h*f}" cy="${o+8}" r="2" class="louis-tassel" />`}return`<svg viewBox="0 0 100 100">${l}${v}${y}${i}</svg>`}function $t(e){const a=_(e.width_m),s=_(e.height_m);if(a<=0||s<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:t,y:o,svgWidth:n,svgHeight:r,lines:i}=le({width:a,height:s});let l=`<rect x="${t}" y="${o}" width="${n}" height="${r}" class="blind-frame" />`;const d=5,c=r/d;for(let u=0;u<d;u++)l+=`<rect x="${t+1}" y="${o+u*c}" width="${n-2}" height="${c-1.5}" class="blind-slat" />`;const p=Le(e,{x:t,y:o,svgWidth:n});return`<svg viewBox="0 0 100 100">${l}${i}${p}</svg>`}function kt(e){const a=_(e.width_m),s=_(e.height_m);if(a<=0||s<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:t,y:o,svgWidth:n,svgHeight:r,lines:i}=le({width:a,height:s});let l="";const d=e.fabric_variant.includes("โปร่ง"),p=e.fabric_variant.includes("ทึบ")?"curtain-panel-opaque":d?"curtain-panel-sheer":"blind-slat";l+=`<rect x="${t}" y="${o}" width="${n}" height="${r}" class="${p}" />`;const u=3;l+=`<line x1="${t}" y1="${o+u/2}" x2="${t+n}" y2="${o+u/2}" class="style-pleat-line" stroke-width="0.8"/>`,l+=`<line x1="${t}" y1="${o+u}" x2="${t+n}" y2="${o+u}" class="style-pleat-line"/>`,l+=`<line x1="${t}" y1="${o+r-u}" x2="${t+n}" y2="${o+r-u}" class="style-pleat-line"/>`,l+=`<line x1="${t}" y1="${o+r-u/2}" x2="${t+n}" y2="${o+r-u/2}" class="style-pleat-line" stroke-width="0.8"/>`;const f=Math.max(8,Math.floor(n/4));for(let h=1;h<f;h++){const w=t+n/f*h;l+=`<line x1="${w}" y1="${o+u}" x2="${w}" y2="${o+r-u}" class="style-pleat-line" opacity="0.5"/>`}const v=o+r*.5,y=8;return l+=`<rect x="${t+n*.1}" y="${v-y/2}" width="${n*.8}" height="${y}" rx="2" class="blind-slat" filter="brightness(0.95)" />`,l+=`<rect x="${t+n*.12}" y="${v-y/2+1.5}" width="${n*.76}" height="${y-3}" rx="1" class="blind-frame" opacity="0.3" />`,`<svg viewBox="0 0 100 100">${l}${i}</svg>`}function Qe(e,a=!1){const s=_(e.width_m),t=_(e.height_m);if(s<=0||t<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:o,y:n,svgWidth:r,svgHeight:i,lines:l}=le({width:s,height:t});let d=`<rect x="${o}" y="${n}" width="${r}" height="${i}" class="blind-frame" />`;if(a){const p=Math.max(4,Math.floor(r/8)),u=r/p;for(let f=0;f<p;f++)d+=`<rect x="${o+f*u+1}" y="${n}" width="${u-2}" height="${i}" class="blind-slat" />`}else{const p=Math.max(3,Math.floor(i/6)),u=i/p;for(let f=0;f<p;f++)d+=`<rect x="${o+1}" y="${n+f*u+.5}" width="${r-2}" height="${u-1}" class="blind-slat" />`}const c=Le(e,{x:o,y:n,svgWidth:r});return`<svg viewBox="0 0 100 100">${d}${l}${c}</svg>`}function xt(e){const a=_(e.width_m),s=_(e.height_m);if(a<=0||s<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:t,y:o,svgWidth:n,svgHeight:r,lines:i}=le({width:a,height:s});let l=`<rect x="${t}" y="${o}" width="${n}" height="${r}" class="blind-frame" />`;const d=Math.max(3,Math.floor(r/8)),c=r/d;for(let h=0;h<d;h++)l+=`<rect x="${t+1}" y="${o+h*c}" width="${n-2}" height="${c-1.5}" rx="0.5" class="wooden-blind-slat" />`;const p=Math.max(2,n*.05),u=t+n*.25-p/2,f=t+n*.75-p/2,v=`
        <rect x="${u}" y="${o}" width="${p}" height="${r}" class="wooden-blind-strip" />
        <rect x="${f}" y="${o}" width="${p}" height="${r}" class="wooden-blind-strip" />
    `,y=Le(e,{x:t,y:o,svgWidth:n});return`<svg viewBox="0 0 100 100">${l}${v}${i}${y}</svg>`}function Mt(e){const a=_(e.width_m),s=_(e.height_m);if(a<=0||s<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:t,y:o,svgWidth:n,svgHeight:r,lines:i}=le({width:a,height:s}),l=`
        <rect x="${t}" y="${o}" width="${n}" height="${r}" class="roller-fabric" />
        <rect x="${t-1}" y="${o-4}" width="${n+2}" height="5" rx="2" class="roller-roll" />
        <line x1="${t}" y1="${o+r}" x2="${t+n}" y2="${o+r}" class="roller-bar" />
    `,d=Le(e,{x:t,y:o-2,svgWidth:n});return`<svg viewBox="0 0 100 100">${l}${i}${d}</svg>`}function Ke(e,a=!1){const s=_(e.width_m),t=_(e.height_m);if(s<=0||t<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:o,y:n,svgWidth:r,svgHeight:i,lines:l}=le({width:s,height:t});let d="";if(a)d=`
            <defs>
                <pattern id="pleated-mesh" width="6" height="6" patternUnits="userSpaceOnUse">
                    <path d="M -1 1 L 1 -1 M 0 6 L 6 0" class="pleated-screen-mesh" />
                </pattern>
            </defs>
            <rect x="${o}" y="${n}" width="${r}" height="${i}" class="blind-frame" />
            <rect x="${o}" y="${n}" width="${r}" height="${i}" fill="url(#pleated-mesh)" />
        `;else{const p=Math.max(4,Math.floor(r/10)),u=r/p;for(let f=0;f<p;f++)d+=`<rect x="${o+f*u}" y="${n}" width="${u}" height="${i}" class="partition-panel" />`,f>0&&(d+=`<line x1="${o+f*u}" y1="${n}" x2="${o+f*u}" y2="${n+i}" class="partition-hinge" />`)}const c=rt(e,{y:n,svgHeight:i});return`<svg viewBox="0 0 100 100">${d}${c}${l}</svg>`}function Tt(e){const a=(e.widths||[]).reduce((u,f)=>u+_(f),0),s=_(e.height_m);if(a<=0||s<=0)return'<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">ไม่มีขนาด</text></svg>';const{x:t,y:o,svgWidth:n,svgHeight:r,lines:i}=le({width:a,height:s});let l="";const d=Math.floor(n/10),c=Math.floor(r/10);for(let u=0;u<c;u++)for(let f=0;f<d;f++)l+=`<circle cx="${t+f*10+5}" cy="${o+u*10+5}" r="1.5" class="wallpaper-pattern" />`;return`<svg viewBox="0 0 100 100">${`<rect x="${t}" y="${o}" width="${n}" height="${r}" class="blind-frame" /> ${l}`}${i}</svg>`}function It(e,a,s){let t="",o=Y[e.type]||"ของตกแต่ง";switch(e.type){case"set":e.style==="ม่านพับ"?t=$t(e):e.style==="หลุยส์"?(t=qt(e),o=Y.set_louis||"ม่านหลุยส์"):e.style==="ม่านแป๊บ"?t=kt(e):t=wt(e);break;case"wooden_blind":t=xt(e);break;case"aluminum_blind":t=Qe(e,!1);break;case"vertical_blind":t=Qe(e,!0);break;case"roller_blind":t=Mt(e);break;case"partition":t=Ke(e,!1);break;case"pleated_screen":t=Ke(e,!0);break;case"wallpaper":t=Tt(e);break;default:t=`<svg viewBox="0 0 100 100"><text x="50" y="50" class="fallback-text">${M(o)}</text></svg>`;break}return`<div class="visual-placeholder is-clickable"
                 data-act="jump-to-item"
                 data-room-id="${a}"
                 data-item-index="${s}"
                 title="คลิกเพื่อไปยังรายการนี้">${t}</div>`}function Xe(e){let a=`
📃 *สรุปรายการสินค้า*
`,s=!1;return e.rooms.forEach(t=>{if(t.is_suspended||!t.items)return;const o=t.items.filter(r=>r.is_suspended?!1:r.type==="wallpaper"?(r.widths||[]).reduce((i,l)=>i+_(l),0)>0:r.type==="set"||O[r.type]?.templateId==="#areaBasedTpl"?_(r.width_m)>0:!0);if(o.length===0)return;s=!0,a+=`
*🚪 ห้อง: ${t.room_name||"ไม่ระบุ"}*
`;let n=0;o.forEach(r=>{n++;let i=Y[r.type]||"สินค้าตกแต่ง";r.type==="set"?r.style==="หลุยส์"?(i=Y.set_louis||"ม่านหลุยส์",a+=` ${n}) ${i} (${r.fabric_variant||""})
`):a+=` ${n}) ${i} ${r.style||""} (${r.fabric_variant||""})
`:a+=` ${n}) ${i}
`})}),s?a+`------------------------------
`:""}function at(e){return e.rooms.reduce((a,s)=>{if(s.is_suspended)return a;const t=s.items?.reduce((o,n)=>{if(n.is_suspended)return o;switch(n.type){case"set":return o+A.calculateSetPrice(n).total;case"wallpaper":return o+A.calculateWallpaperPrice(n).total;default:return O[n.type]?.templateId==="#areaBasedTpl"?o+A.calculateAreaBasedPrice(n).total:o}},0)||0;return a+t},0)}function Lt(e,a){const s=at(e);let t=0,o="";e.discount&&e.discount.value>0&&(e.discount.type==="percent"?(t=s*(e.discount.value/100),o=`🏷️ ส่วนลด (${e.discount.value}%): -${B(t)} บาท
`):(t=e.discount.value,o=`🏷️ ส่วนลด: -${B(t)} บาท
`));const n=s-t;let r=`🗓️ สรุปข้อมูล (${new Date().toLocaleDateString("th-TH",{day:"numeric",month:"short",year:"2-digit"})})
`;if(r+=`👤 ลูกค้า: ${e.customer_name||"-"}
`,(a==="customer"||a==="owner")&&(r+=`📞 โทร: ${e.customer_phone||"-"}
`,r+=`🏠 ที่อยู่: ${e.customer_address||"-"}
`),r+=`------------------------------
`,a==="customer")return r+=Xe(e),t>0&&(r+=`
ยอดรวม: ${B(s)} บาท
`,r+=o),r+=`
💰 *ยอดสุทธิ: ${B(n)} บาท*
`,r+=`
ขอบคุณที่ใช้บริการค่ะ
${V.name}
โทร: ${V.phone}`,r;if(a==="purchase_order"||a==="owner"){a==="owner"&&(r+=Xe(e));const i={opaqueFabrics:[],sheerFabrics:[],wallpapers:[],allSets:[]};e.rooms.forEach(S=>{S.is_suspended||!S.items||S.items.forEach(b=>{let x=!b.is_suspended;if(b.type==="set"||O[b.type]?.templateId==="#areaBasedTpl")x=x&&_(b.width_m)>0&&_(b.height_m)>0;else if(b.type==="wallpaper"){const q=(b.widths||[]).reduce((g,k)=>g+_(k),0);x=x&&q>0&&_(b.height_m)>0}if(x)switch(b.type){case"set":i.allSets.push(b),b.style!=="ม่านแป๊บ"&&(b.fabric_variant.includes("ทึบ")&&i.opaqueFabrics.push({code:b.fabric_code||"??",yards:A.fabricYardage(b.style,b.width_m)}),b.fabric_variant.includes("โปร่ง")&&i.sheerFabrics.push({code:b.sheer_fabric_code||"??",yards:A.fabricYardage(b.style,b.width_m)}));break;case"wallpaper":const q=(b.widths||[]).reduce((k,I)=>k+_(I),0),g=A.wallpaperRolls(q,b.height_m);g>0&&i.wallpapers.push({code:b.wallpaper_code||"xxx",rolls:g});break;default:if(O[b.type]?.templateId==="#areaBasedTpl"){const k=b.type;i[k]||(i[k]=[]),i[k].push({code:b.code||"xxx",width:_(b.width_m),height:_(b.height_m),opening_style:b.opening_style,adjustment_side:b.adjustment_side})}break}})});const l={};if([...i.opaqueFabrics,...i.sheerFabrics].forEach(S=>{S.yards>0&&(l[S.code]=(l[S.code]||0)+S.yards)}),Object.keys(l).length>0){r+=`✂️ *รายการสั่งซื้อ (ผ้า)*
`,r+=`------------------------------
`,i.opaqueFabrics.filter(S=>S.yards>0).forEach(S=>{r+=`- ผ้าทึบ (Curtain)
`,r+=`  รหัส: #${S.code||"??"}
`,r+=`  จำนวน: ${S.yards.toFixed(2)} หลา

`}),i.sheerFabrics.filter(S=>S.yards>0).forEach(S=>{r+=`- ผ้าโปร่ง (Sheer)
`,r+=`  รหัส: #${S.code||"??"}
`,r+=`  จำนวน: ${S.yards.toFixed(2)} หลา

`}),r+=`------------------------------
`,r+=`📊 *สรุปยอดรวมผ้า (ตามรหัส)*
`,r+=`------------------------------
`;for(const[S,b]of Object.entries(l))r+=`  - รหัส #${S}: ${b.toFixed(2)} หลา
`;r+=`
`}const d=i.allSets.filter(S=>S.style==="หลุยส์"),c=i.allSets.filter(S=>S.style==="ม่านพับ"),p=i.allSets.filter(S=>S.style==="ตาไก่"),u=i.allSets.filter(S=>S.style==="ม่านแป๊บ"),f=i.allSets.filter(S=>!["ม่านพับ","ตาไก่","หลุยส์","ม่านแป๊บ"].includes(S.style));if(d.length>0){r+=`------------------------------
`,r+=`👑 *รายการสั่งซื้อ ราง (หลุยส์)*
`,r+=`------------------------------

`;let S=1;d.forEach(g=>{r+=`(${S++}) ราง ${g.style}, สี: ${g.track_color||"ขาว"}
`,r+=`  - รางหลัก (ทึบ/โปร่ง): ${Number(g.width_m).toFixed(2)} ม.
`,r+=`  - หัวหลุยส์: ${g.louis_valance||"กล่องหลุยส์"}
`,r+=`  - พู่: ${g.louis_tassels||"สีเข้ากับผ้า"}
`,g.notes&&a==="owner"&&(r+=`  📝 หมายเหตุ: ${g.notes}
`),r+=`
`});const b=[];d.forEach(g=>{b.push(Number(g.width_m)),g.fabric_variant==="ทึบ&โปร่ง"&&b.push(Number(g.width_m))});const x=b.reduce((g,k)=>{const I=k.toFixed(2);return g[I]=(g[I]||0)+1,g},{}),q=Object.entries(x).sort((g,k)=>parseFloat(k[0])-parseFloat(g[0]));if(q.length>0){r+=`--- สรุปยอดรวมรางหลุยส์ ---
`,r+=`*จำนวนรางที่ต้องตัด (โดยประมาณ):*
`;for(const[g,k]of q)r+=`  - ขนาด ${g} ม. = ${k} เส้น
`;r+=`
`}}if(c.length>0){r+=`------------------------------
`,r+=`📏 *รายการสั่งซื้อ รางม่านพับ*
`,r+=`------------------------------

`;let S=1;c.forEach(q=>{r+=`(${S++}) รางม่านพับ
`,r+=`  - ขนาด: ${Number(q.width_m).toFixed(2)} ม.
`,r+=`  - สีราง: ${q.track_color||"ขาว"}
`,r+=`  - เชือกปรับ: ${q.adjustment_side||"ปรับขวา"}
`,q.notes&&a==="owner"&&(r+=`  📝 หมายเหตุ: ${q.notes}
`),r+=`
`});const b=c.reduce((q,g)=>{const k=Number(g.width_m).toFixed(2);return q[k]=(q[k]||0)+1,q},{}),x=Object.entries(b).sort((q,g)=>parseFloat(g[0])-parseFloat(q[0]));if(x.length>0){r+=`--- สรุปยอดรวมรางม่านพับ ---
`,r+=`*จำนวนรางที่ต้องตัด:*
`;for(const[q,g]of x)r+=`  - ขนาด ${q} ม. = ${g} เส้น
`;r+=`
`}}if(f.length>0){r+=`------------------------------
`,r+=`📏 *รายการสั่งซื้อ ราง (ลอน/จีบ)*
`,r+=`------------------------------

`;let S=1;f.forEach(g=>{r+=`(${S++}) ราง ${g.style}, สี: ${g.track_color||"ขาว"}
`,g.fabric_variant.includes("ทึบ")&&(r+=`  - รางทึบ: ${Number(g.width_m).toFixed(2)} ม.
`),g.fabric_variant.includes("โปร่ง")&&(r+=`  - รางโปร่ง: ${Number(g.width_m).toFixed(2)} ม.
`),g.notes&&a==="owner"&&(r+=`  📝 หมายเหตุ: ${g.notes}
`),r+=`
`});const b=[];f.forEach(g=>{g.fabric_variant.includes("ทึบ")&&b.push(Number(g.width_m)),g.fabric_variant.includes("โปร่ง")&&b.push(Number(g.width_m))});const x=b.reduce((g,k)=>{const I=k.toFixed(2);return g[I]=(g[I]||0)+1,g},{}),q=Object.entries(x).sort((g,k)=>parseFloat(k[0])-parseFloat(g[0]));if(q.length>0){r+=`--- สรุปยอดรวมรางลอน/จีบ ---
`,r+=`*จำนวนรางที่ต้องตัด:*
`;for(const[g,k]of q)r+=`  - ขนาด ${g} ม. = ${k} เส้น
`;r+=`
`}}if(p.length>0){r+=`------------------------------
`,r+=`📏 *รายการสั่งซื้อ ราง (ตาไก่)*
`,r+=`------------------------------

`;let S=1;p.forEach(I=>{r+=`(${S++}) ราง ${I.style}, สี: ${I.track_color||"ขาว"}
`,I.fabric_variant.includes("ทึบ")&&(r+=`  - รางทึบ: ${Number(I.width_m).toFixed(2)} ม.
`),I.fabric_variant.includes("โปร่ง")&&(r+=`  - รางโปร่ง: ${Number(I.width_m).toFixed(2)} ม.
`),I.notes&&a==="owner"&&(r+=`  📝 หมายเหตุ: ${I.notes}
`),r+=`
`}),r+=`--- สรุปยอดรวมรางตาไก่ ---
`;const b=[];p.forEach(I=>{I.fabric_variant.includes("ทึบ")&&b.push(Number(I.width_m)),I.fabric_variant.includes("โปร่ง")&&b.push(Number(I.width_m))});const x=6;b.sort((I,L)=>L-I);const q=[];for(const I of b){let L=!1;for(let C=0;C<q.length;C++)if(q[C]>=I-.001){q[C]-=I,L=!0;break}L||q.push(x-I)}r+=`ใช้รางเต็ม (6 ม.) ทั้งหมด: *${q.length} เส้น*

`;const g=b.reduce((I,L)=>{const C=L.toFixed(2);return I[C]=(I[C]||0)+1,I},{}),k=Object.entries(g).sort((I,L)=>parseFloat(L[0])-parseFloat(I[0]));if(k.length>0){r+=`*สรุปจำนวนรางที่ต้องตัด:*
`;for(const[I,L]of k)r+=`  - ขนาด ${I} ม. = ${L} เส้น
`;r+=`
`}}if(u.length>0){r+=`------------------------------
`,r+=`📏 *รายการสั่งซื้อ ราง (ม่านแป๊บ)*
`,r+=`------------------------------

`;let S=1;u.forEach(g=>{r+=`(${S++}) ราง ${g.style}, สี: ${g.track_color||"ขาว"}
`,r+=`  - ราง: ${Number(g.width_m).toFixed(2)} ม.
`,g.notes&&a==="owner"&&(r+=`  📝 หมายเหตุ: ${g.notes}
`),r+=`
`});const x=u.map(g=>Number(g.width_m)).reduce((g,k)=>{const I=k.toFixed(2);return g[I]=(g[I]||0)+1,g},{}),q=Object.entries(x).sort((g,k)=>parseFloat(k[0])-parseFloat(g[0]));if(q.length>0){r+=`--- สรุปยอดรวมรางม่านแป๊บ ---
`,r+=`*จำนวนรางที่ต้องตัด:*
`;for(const[g,k]of q)r+=`  - ขนาด ${g} ม. = ${k} เส้น
`;r+=`
`}}const v={};let y={};i.allSets.forEach(S=>{const b=S.track_color||"ขาว",x=S.style,q=S.fabric_variant==="ทึบ&โปร่ง",g=_(S.width_m)>=1.6?3:2;if(v[b]||(v[b]={brackets:{},finials:0,grommets:{},rodPocketBrackets:0}),v[b].brackets[x]||(v[b].brackets[x]={single:0,double:0}),x!=="ม่านพับ"&&x!=="หลุยส์"&&x!=="ม่านแป๊บ"?q?v[b].brackets[x].double+=g:v[b].brackets[x].single+=g:x==="ม่านแป๊บ"&&(v[b].rodPocketBrackets+=4),x==="ตาไก่"){const k=q?4:2;v[b].finials+=k}if(x==="ตาไก่"){const k=S.grommet_color||"เงิน",I=A.calculateGrommets(S);v[b].grommets[k]||(v[b].grommets[k]=0),v[b].grommets[k]+=I}if(x==="หลุยส์"){const k=S.louis_tassels||"สีเข้ากับผ้า";k!=="ไม่มี"&&(y[k]=(y[k]||0)+2)}});const h=i.allSets.filter(S=>!["ม่านพับ","หลุยส์","ม่านแป๊บ"].includes(S.style)).length*2,w=Object.values(v).some(S=>Object.values(S.brackets).some(b=>b.single>0||b.double>0)),T=Object.values(v).some(S=>S.rodPocketBrackets>0),E=Object.values(v).some(S=>S.finials>0),P=Object.values(v).some(S=>Object.values(S.grommets).some(b=>b>0)),F=Object.keys(y).length>0;if(w||T||E||P||h>0||F){r+=`------------------------------
`,r+=`🔩 *รายการสั่งซื้อ อุปกรณ์ (Hardware)*
`,r+=`------------------------------

`;for(const[b,x]of Object.entries(v)){let q=!1,g=`**สี${b}**
`;const k=Object.keys(x.brackets);if(k.length>0){let L="";k.forEach(C=>{!["ม่านพับ","หลุยส์","ม่านแป๊บ"].includes(C)&&(x.brackets[C].single>0||x.brackets[C].double>0)&&(L+=`    - ${C} (ชั้นเดียว): ${x.brackets[C].single} ตัว
`,L+=`    - ${C} (2ชั้น): ${x.brackets[C].double} ตัว
`)}),L&&(q=!0,g+=`  - ขาจับ (มาตรฐาน):
${L}`)}x.rodPocketBrackets>0&&(q=!0,g+=`  - ขาจับ (ม่านแป๊บ): ${x.rodPocketBrackets} ตัว
`),x.finials>0&&(q=!0,g+=`  - หัวราง (ตาไก่): ${x.finials} ตัว
`);const I=Object.keys(x.grommets);if(I.length>0){let L="";I.forEach(C=>{const N=x.grommets[C];N>0&&(L+=`    - สี${C}: ${N} ตัว
`)}),L&&(q=!0,g+=`  - ตาไก่:
${L}`)}q&&(r+=g+`
`)}let S="";if(h>0&&(S+=`  - ตะขอรวบม่าน (มาตรฐาน): ${h} ตัว
`),F){S+=`  - พู่/สายรวบ (หลุยส์):
`;for(const[b,x]of Object.entries(y))S+=`    - ${b}: ${x} ชุด
`}S&&(r+=`**อุปกรณ์รวม**
`+S+`
`)}const Q=Object.keys(i).filter(S=>!["opaqueFabrics","sheerFabrics","wallpapers","allSets"].includes(S));Q.length>0&&Q.sort().forEach(S=>{const b=i[S],x=Y[S]||S;r+=`------------------------------
`,r+=`📦 *รายการสั่งซื้อ ${x}*
`,r+=`------------------------------

`,b.forEach(q=>{r+=`- รหัส: #${q.code||"xxx"}
  ขนาด: ${q.width.toFixed(2)} x ${q.height.toFixed(2)} ม.
`,q.opening_style&&(r+=`  รูปแบบเปิด: ${q.opening_style}
`),q.adjustment_side&&(r+=`  เชือกปรับ: ${q.adjustment_side}
`),r+=`
`})});const X={};if(i.wallpapers.forEach(S=>{X[S.code]=(X[S.code]||0)+S.rolls}),Object.keys(X).length>0){r+=`------------------------------
`,r+=`🎨 *รายการสั่งซื้อ (Wallpaper)*
`,r+=`------------------------------

`;for(const[S,b]of Object.entries(X))r+=`  - รหัส #${S}: ${b} ม้วน
`;r+=`
`}if(a==="purchase_order")return r+=`------------------------------
`,r}if(a==="seamstress"||a==="owner"){r+=`
🧵 *รายละเอียดสำหรับช่างเย็บผ้า*
`;let i=0;if(e.rooms.forEach(l=>{if(l.is_suspended||!l.items)return;const d=l.items.filter(c=>c.type==="set"&&!c.is_suspended&&_(c.width_m)>0&&_(c.height_m)>0);d.length!==0&&(i>0&&(r+=`==============================
`),r+=`
*🚪 ห้อง: ${l.room_name||"ไม่ระบุ"}*

`,d.forEach((c,p)=>{p>0&&(r+=`--------------------
`);const u=c.style==="หลุยส์"?Y.set_louis||"ม่านหลุยส์":c.style;r+=`*ชุดที่ ${p+1}/${d.length}: ${u} ${c.fabric_variant}*
`,c.style==="ม่านพับ"?r+=`  - เชือกปรับ: ${c.adjustment_side||"ปรับขวา"}
`:c.style==="หลุยส์"?(r+=`  - หัวหลุยส์: ${c.louis_valance||"กล่องหลุยส์"}
`,r+=`  - พู่: ${c.louis_tassels||"สีเข้ากับผ้า"}
`):c.style!=="ม่านแป๊บ"&&(r+=`  - รูปแบบเปิด: ${c.opening_style||"แยกกลาง"}
`),c.style==="หลุยส์"?(c.fabric_variant.includes("ทึบ")&&(r+=`  - ผ้าฐาน (ทึบ): #${c.fabric_code||"-"}
`),c.fabric_variant.includes("โปร่ง")&&(r+=`  - ผ้าฐาน (โปร่ง): #${c.sheer_fabric_code||"-"}
`)):(c.fabric_variant.includes("ทึบ")&&(r+=`  - ผ้าทึบ: #${c.fabric_code||"-"}
`),c.fabric_variant.includes("โปร่ง")&&(r+=`  - ผ้าโปร่ง: #${c.sheer_fabric_code||"-"}
`)),r+=`  - ขนาด: กว้าง ${Number(c.width_m).toFixed(2)} x สูง ${Number(c.height_m).toFixed(2)} ม.
`,c.notes&&a==="owner"&&(r+=`  📝 หมายเหตุ: ${c.notes}
`)}),r+=`
`,i++)}),i>0?r+=`==============================
`:r+=`ไม่มีรายการสำหรับช่าง
------------------------------
`,a==="seamstress")return r}return a==="owner"&&(r+=`
💰 *สรุปยอดรวม: ${B(n)} บาท*
`,t>0&&(r+=`   (ยอดก่อนลด: ${B(s)} บาท ${o.trim()})
`)),r}function Ct(e){if(!e.rooms||e.rooms.length===0)return'<p class="empty-summary">ไม่มีข้อมูลสำหรับแสดงผล</p>';let a="";const s={};let t=0;if(e.rooms.forEach(r=>{r.is_suspended||!r.items||r.items.forEach(i=>{if(i.is_suspended)return;let l=null,d=0;switch(i.type){case"set":d=A.calculateSetPrice(i).total,d>0&&(l=i.style==="หลุยส์"?"set_louis":"set");break;case"wallpaper":d=A.calculateWallpaperPrice(i).total,d>0&&(l=i.type);break;default:O[i.type]?.templateId==="#areaBasedTpl"&&(d=A.calculateAreaBasedPrice(i).total,d>0&&(l=i.type));break}l&&(s[l]=(s[l]||0)+1,t++)})}),t>0){const r=Object.entries(s).map(([i,l])=>{const d=Y[i]||Y[i.split("_")[0]]||"ของตกแต่ง";return`
                <span class="summary-tag" data-filter-type="${M(i)}" title="คลิกเพื่อกรองเฉพาะรายการนี้">
                    ${M(d)} <strong>${l}</strong>
                </span>`}).join("");r&&(a+=`
                <div class="overview-summary-group">
                    <h4><i class="ph ph-stack"></i> สรุปประเภทรายการ</h4>
                    <div class="summary-tags-container">
                        ${r}
                    </div>
                </div>`)}let o="",n=0;return e.rooms.forEach(r=>{if(r.is_suspended||!r.items)return;const i={};let l=0;if(r.items.forEach(d=>{if(d.is_suspended)return;let c=null,p=0;switch(d.type){case"set":p=A.calculateSetPrice(d).total,p>0&&(c=d.style==="หลุยส์"?"set_louis":"set");break;case"wallpaper":p=A.calculateWallpaperPrice(d).total,p>0&&(c=d.type);break;default:O[d.type]?.templateId==="#areaBasedTpl"&&(p=A.calculateAreaBasedPrice(d).total,p>0&&(c=d.type));break}c&&(i[c]=(i[c]||0)+1,l++)}),l>0){n+=l;const d=Object.entries(i).map(([c,p])=>{const u=Y[c]||Y[c.split("_")[0]]||"ของตกแต่ง";return`
                    <div class="overview-item">
                        <span>${M(u)}</span>
                        <span>${p}</span>
                    </div>`}).join("");o+=`
                <details class="overview-room-card">
                    <summary class="overview-room-summary">
                        <span class="room-name">${M(r.room_name)||"ไม่ระบุชื่อห้อง"}</span>
                        <div class="summary-tags">
                            <span class="room-item-count">${l} รายการ</span>
                            <i class="ph ph-caret-down expand-icon"></i>
                        </div>
                    </summary>
                    <div class="overview-room-items">${d}</div>
                </details>`}}),o&&(a+=`
            <div class="overview-breakdown-group">
                <h4><i class="ph ph-map-pin-line"></i> แจกแจงตามห้อง</h4>
                ${o}
            </div>`),t===0&&n===0?'<p class="empty-summary">ไม่มีรายการที่มีราคาสำหรับแสดงผล</p>':a}function Bt(e,a){const{vatRate:s=V.baseVatRate,pageBreakBuffer:t=3,showDetails:o=!0}=a,n=[];e.rooms.forEach(b=>{if(b.is_suspended||!b.items)return;const x=[];if(b.items.forEach(q=>{if(q.is_suspended)return;let g="",k=0,I=0,L=0,C=1,N=q.type==="set"&&q.style==="หลุยส์"?Y.set_louis||"ม่านหลุยส์":Y[q.type]||"สินค้าตกแต่ง",z="";switch(q.type){case"set":if(k=A.calculateSetPrice(q).total,k>0){I=_(q.width_m),L=_(q.height_m);const R=q.style==="หลุยส์"?"":` ${M(q.style||"")}`;g=`${N}${R} (${M(q.fabric_variant||"")})`,o&&(z=`<br><small>ขนาด ${I.toFixed(2)} x ${L.toFixed(2)} ม.${q.notes?` - ${M(q.notes)}`:""}</small>`),C=o?1.5:1}break;case"wallpaper":if(k=A.calculateWallpaperPrice(q).total,k>0){const R=(q.widths||[]).reduce((pe,fe)=>pe+_(fe),0),Ae=A.wallpaperRolls(R,q.height_m);L=_(q.height_m),g=`${N}`,o&&(z=`<br><small>รหัส: ${M(q.wallpaper_code)||"-"}, สูง ${L.toFixed(2)} ม. (ใช้ ${Ae} ม้วน)</small>`),C=o?1.5:1}break;default:O[q.type]?.templateId==="#areaBasedTpl"&&(k=A.calculateAreaBasedPrice(q).total,k>0&&(I=_(q.width_m),L=_(q.height_m),g=`${N}`,o&&(z=`<br><small>รหัส: ${M(q.code)||"-"}, ขนาด ${I.toFixed(2)} x ${L.toFixed(2)} ม.</small>`),C=o?1.5:1));break}k>0&&g&&x.push({description:g+z,unitPrice:k,units:C})}),x.length>0){n.push({isRoomHeader:!0,roomName:M(b.room_name)||"ไม่ระบุชื่อห้อง",units:1.2});const q=new Map;x.forEach(g=>{const k=`${g.description}::${g.unitPrice}`;q.has(k)?q.get(k).quantity+=1:q.set(k,{...g,quantity:1})}),q.forEach(g=>{n.push({...g,total:g.quantity*g.unitPrice})})}});const r=n.reduce((b,x)=>b+(x.total||0),0);if(r===0)return null;let i=0,l="",d=r;e.discount&&e.discount.value>0&&(e.discount.type==="percent"?(i=r*(e.discount.value/100),l=`<tr><td class="pdf-label">ส่วนลด (${e.discount.value}%)</td><td class="pdf-amount">-${oe(i,2,!0)}</td></tr>`):(i=e.discount.value,l=`<tr><td class="pdf-label">ส่วนลด</td><td class="pdf-amount">-${oe(i,2,!0)}</td></tr>`),d=r-i);const c=d*s,p=d+c,u=o?17:20,f=o?23:28,v=[];let y=[],h=0;n.forEach((b,x)=>{const q=v.length===0?u:f,g=h+b.units>q;let k=!1;if(b.isRoomHeader&&x<n.length-1){const L=n[x+1].units||(o?1.5:1);h+b.units+L>q&&h+b.units<=q&&(k=!0)}let I=!1;if(!g&&!k&&x<n.length-1){const L=q-(h+b.units),C=n[x+1].units||(o?1.5:1);L>0&&L<t&&L<C&&!b.isRoomHeader&&(I=!0)}(g||k||I)&&y.length>0&&(v.push(y),y=[],h=0),y.push(b),h+=b.units}),y.length>0&&v.push(y);const w=new Date,T=w.toLocaleDateString("th-TH",{year:"numeric",month:"long",day:"numeric"}),E=`QT-${w.getFullYear()}${(w.getMonth()+1).toString().padStart(2,"0")}${w.getDate().toString().padStart(2,"0")}`;let P="";try{P=new URL(V.logoUrl,document.baseURI).href}catch{P=V.logoUrl}let F="",D=0,Q=1;v.forEach((b,x)=>{const q=x===0,g=x===v.length-1,k=`
            <div class="pdf-page-header">
                <div class="pdf-header">
                     <div class="pdf-shop-info">
                        ${P?`<img src="${P}" alt="Logo" class="pdf-logo">`:""}
                        <div class="pdf-shop-address">
                            <strong><i class="ph ph-github-logo"></i> ${M(V.name)}</strong><br>
                            ${M(V.address).replace(/\n/g,"<br>")}<br>
                            โทร: ${M(V.phone)} | เลขประจำตัวผู้เสียภาษี: ${M(V.taxId)}
                        </div>
                    </div>
                     <div class="pdf-quote-details">
                        <div class="pdf-title-box"><h1>ใบเสนอราคา ${v.length>1?q?"":"(ต่อ)":""}</h1></div>
                        <table class="pdf-quote-meta">
                            <tr><td>เลขที่:</td><td>${E}</td></tr>
                            <tr><td>วันที่:</td><td>${T}</td></tr>
                        </table>
                    </div>
                </div>
                ${q?`
                <section class="pdf-customer-details">
                     <div class="pdf-customer-info">
                        <strong>ลูกค้า:</strong> ${M(e.customer_name)||"-"}<br>
                        <strong>ที่อยู่:</strong> ${M(e.customer_address||"-").replace(/\n/g,"<br>")}<br>
                        <strong>โทร:</strong> ${M(e.customer_phone)||"-"}
                    </div>
                    <div class="pdf-customer-meta">
                        <strong>เงื่อนไขชำระเงิน:</strong> ${M(V.pdf.paymentTerms)}<br>
                        <strong>ยืนราคา:</strong> ${M(V.pdf.priceValidity)}
                    </div>
                </section>`:""}
            </div>`,I=`
            <div class="pdf-page-footer">
                <div class="pdf-footer-info">
                    <span><i class="ph ph-github-logo"></i> ${M(V.name)} | โทร: ${M(V.phone)}</span>
                    <span>หน้า ${x+1} / ${v.length}</span>
                </div>
            </div>`;let L="";q||(L+=`<tr class="pdf-subtotal-row"><td colspan="4">ยอดยกมา (Brought Forward)</td><td class="pdf-text-right">${oe(D,2,!0)}</td></tr>`),b.forEach(R=>{R.isRoomHeader?L+=`<tr class="pdf-room-header"><td colspan="5">ห้อง: ${R.roomName}</td></tr>`:(L+=`<tr>
                    <td class="pdf-text-center">${Q++}</td>
                    <td>${R.description}</td>
                    <td class="pdf-text-center">${R.quantity}</td>
                    <td class="pdf-text-right">${oe(R.unitPrice,2,!0)}</td>
                    <td class="pdf-text-right">${oe(R.total,2,!0)}</td>
                </tr>`,D+=R.total)});let C="";g||(C=`<tfoot><tr class="pdf-subtotal-row"><td colspan="4">ยอดยกไป (Carried Forward)</td><td class="pdf-text-right">${oe(D,2,!0)}</td></tr></tfoot>`);let N="";o&&V.pdf.notes&&V.pdf.notes.length>0&&(N=`
                <strong>หมายเหตุ:</strong>
                <ul>${V.pdf.notes.map(R=>`<li>${M(R)}</li>`).join("")}</ul>
            `);const z=g?`
            <div class="pdf-summary-wrapper">
                <section class="pdf-summary-section">
                    <div class="pdf-amount-in-words">
                        ${N}
                        <div class="pdf-amount-text">( ${_t(p)} )</div>
                    </div>
                    <div class="pdf-totals-block">
                        <table>
                            <tr><td class="pdf-label">รวมเป็นเงิน</td><td class="pdf-amount">${oe(r,2,!0)}</td></tr>
                            ${l}
                            ${s>0?`<tr><td class="pdf-label">ภาษีมูลค่าเพิ่ม ${(s*100).toFixed(0)}%</td><td class="pdf-amount">${oe(c,2,!0)}</td></tr>`:""}
                            <tr class="pdf-grand-total"><td class="pdf-label">ยอดรวมสุทธิ</td><td class="pdf-amount">${oe(p,2,!0)}</td></tr>
                        </table>
                    </div>
                </section>
                <footer class="pdf-footer-section">
                    <div class="pdf-signature-box"><p>.................................................</p><p>ผู้เสนอราคา</p><p>(<i class="ph ph-github-logo"></i> ${M(V.name)})</p><p>วันที่: ${T}</p></div>
                    <div class="pdf-signature-box"><p>.................................................</p><p>ลูกค้า / ผู้มีอำนาจลงนาม</p><p>&nbsp;</p><p>วันที่: ......./......./............</p></div>
                </footer>
            </div>
        `:"";F+=`
            <div class="pdf-page">
                <div class="pdf-page-content">
                    ${k}
                    <div class="pdf-page-body">
                        <table class="pdf-items-table">
                             {/* [MODIFIED] Updated Table Header */}
                            <thead><tr><th style="width:5%;">ลำดับ</th><th style="width:45%;">รายการ</th><th style="width:10%;">จำนวน</th><th style="width:17.5%;">ราคา/หน่วย</th><th style="width:17.5%;">รวม (บาท)</th></tr></thead>
                            <tbody>${L}</tbody>
                            ${C}
                        </table>
                        ${z}
                    </div>
                    ${I}
                </div>
            </div>`});const X=e.customer_name||"quote",S=ot(X);return{html:`<div id="quotation-template">${F}</div>`,fileName:`${E}_${S}`}}function Et(e){const a=at(e);let s=0;e.discount?.value>0&&(s=e.discount.type==="percent"?a*(e.discount.value/100):e.discount.value);const t=a-s;let o=!1,n=e.rooms.map(i=>{if(i.is_suspended)return"";const l=i.items.filter(c=>c.is_suspended?!1:c.type==="set"||O[c.type]?.templateId==="#areaBasedTpl"?_(c.width_m)>0&&_(c.height_m)>0:c.type==="wallpaper"?(c.widths||[]).reduce((u,f)=>u+_(f),0)>0&&_(c.height_m)>0:!1);if(l.length===0)return"";const d=l.map((c,p)=>{let u="",f="",v="",y="";switch(c.type==="set"?c.style==="หลุยส์"?(y=Y.set_louis||"ม่านหลุยส์",f=`<h5 class="lookbook-item-title">${M(y)}</h5>`):c.style==="ม่านแป๊บ"?(y=Y.set||"ผ้าม่าน",f=`<h5 class="lookbook-item-title">${M(y)} ${M(c.style)}</h5>`):y=Y.set||"ผ้าม่าน":(y=Y[c.type]||"ของตกแต่ง",f=`<h5 class="lookbook-item-title">${M(y)}</h5>`),c.type){case"set":v=`<tr><td>ขนาด</td><td>${_(c.width_m).toFixed(2)} x ${_(c.height_m).toFixed(2)} ม.</td></tr>`,c.style==="หลุยส์"?u=`
                            <tr><td>แบบ</td><td>${y} (${M(c.fabric_variant||"")})</td></tr>
                            ${c.fabric_variant.includes("ทึบ")?`<tr><td>ผ้าฐาน</td><td>#${M(c.fabric_code)||"-"}</td></tr>`:""}
                            ${c.fabric_variant.includes("โปร่ง")?`<tr><td>ผ้าโปร่ง</td><td>#${M(c.sheer_fabric_code)||"-"}</td></tr>`:""}
                            <tr><td>หัวหลุยส์</td><td>${M(c.louis_valance||"กล่องหลุยส์")}</td></tr>
                            <tr><td>พู่</td><td>${M(c.louis_tassels||"สีเข้ากับผ้า")}</td></tr>
                         `:c.style==="ม่านแป๊บ"?u=`
                             <tr><td>แบบ</td><td>${M(c.style)} (${M(c.fabric_variant||"")})</td></tr>
                             ${c.fabric_variant.includes("ทึบ")?`<tr><td>ผ้า</td><td>#${M(c.fabric_code)||"-"}</td></tr>`:""}
                             ${c.fabric_variant.includes("โปร่ง")?`<tr><td>ผ้า</td><td>#${M(c.sheer_fabric_code)||"-"}</td></tr>`:""}
                         `:(u=`
                            <tr><td>แบบ</td><td>${M(c.style||"")} (${M(c.fabric_variant||"")})</td></tr>
                            ${c.fabric_variant.includes("ทึบ")?`<tr><td>ทึบ</td><td>#${M(c.fabric_code)||"-"}</td></tr>`:""}
                            ${c.fabric_variant.includes("โปร่ง")?`<tr><td>โปร่ง</td><td>#${M(c.sheer_fabric_code)||"-"}</td></tr>`:""}
                        `,c.style==="ม่านพับ"?u+=`<tr><td>เชือก</td><td>${M(c.adjustment_side||"ปรับขวา")}</td></tr>`:u+=`<tr><td>เปิด</td><td>${M(c.opening_style||"แยกกลาง")}</td></tr>`);break;case"wallpaper":const h=(c.widths||[]).reduce((T,E)=>T+_(E),0),w=A.wallpaperRolls(h,c.height_m);v=`<tr><td>ขนาด</td><td>รวม ${h.toFixed(2)} ม., สูง ${_(c.height_m).toFixed(2)} ม.</td></tr>`,u=`
                        <tr><td>รหัส</td><td>#${M(c.wallpaper_code)||"-"}</td></tr>
                        <tr><td>ใช้</td><td>${w} ม้วน</td></tr>
                    `;break;default:O[c.type]?.templateId==="#areaBasedTpl"&&(v=`<tr><td>ขนาด</td><td>${_(c.width_m).toFixed(2)} x ${_(c.height_m).toFixed(2)} ม.</td></tr>`,u=`<tr><td>รหัส</td><td>#${M(c.code)||"-"}</td></tr>`,c.opening_style&&(u+=`<tr><td>เปิด</td><td>${M(c.opening_style)}</td></tr>`),c.adjustment_side&&(u+=`<tr><td>เชือก</td><td>${M(c.adjustment_side)}</td></tr>`));break}return u&&(o=!0),`
                 <div class="lookbook-details">
                    ${It(c,i.id,p)}
                    <div class="spec-table-wrapper">
                        ${f}
                        <table class="spec-table">
                            ${u}
                            ${v}
                            ${c.notes?`<tr><td>โน้ต</td><td>${M(c.notes)}</td></tr>`:""}
                        </table>
                    </div>
                </div>
            `}).join('<hr class="lookbook-hr">');return d.trim()?`
            <div class="lookbook-room">
                <h4><i class="ph ph-map-pin"></i> ${M(i.room_name)||"ไม่ระบุชื่อห้อง"}</h4>
                ${d}
            </div>
        `:""}).join("");return o?`
        <div class="lookbook-summary">
            <div class="lookbook-customer-info">
                <strong>ลูกค้า:</strong> ${M(e.customer_name)||"-"}<br/>
                <strong>ที่อยู่:</strong> ${M(e.customer_address||"-").replace(/\n/g,"<br/>")}
            </div>
            <div class="lookbook-totals">
                <span>ยอดรวม (ก่อนส่วนลด): ${B(a)} บาท</span>
                ${s>0?`<span>ส่วนลด: -${B(s)} บาท</span>`:""}
                <span class="grand-total">ยอดสุทธิ: ${B(t)} บาท</span>
            </div>
        </div>
    `+n:'<p class="empty-summary">ไม่มีรายการสำหรับสร้างรายงาน</p>'}function nt(e={}){const a=document.querySelector(m.roomTpl);if(!a)return console.error("Room template not found"),null;const t=a.content.cloneNode(!0).firstElementChild;t.id=e.id||`room-${Date.now()}`,t.open=e.is_open!==!1,t.dataset.roomDefaults=JSON.stringify(e.room_defaults||{});const o=t.querySelector(m.roomNameInput),n=t.querySelector("[data-room-name-display]"),r=t.querySelector("[data-room-brief]"),i=t.querySelector(m.allItemsContainer),l=()=>{const p=o.value||"ห้อง (ไม่มีชื่อ)";n&&(n.textContent=p)};o&&o.addEventListener("input",l);const d=t.querySelector("summary");d&&d.addEventListener("click",()=>{});const c=e.room_name||`ห้อง ${document.querySelectorAll(m.room).length+1}`;if(o){o.value=c;const p=`room_name_${t.id}`;o.id=p;const u=o.closest(".form-group")?.querySelector("label");u&&u.setAttribute("for",p)}return n&&(n.textContent=c),e.is_suspended&&t.classList.add("is-suspended"),t.getItemsContainer=()=>i,t.updateBrief=p=>{r&&(r.innerHTML=p)},t}function Ce(e={}){const a=document.querySelector(m.setTpl);if(!a)return console.error("Set template not found"),null;const t=a.content.cloneNode(!0).firstElementChild;t.dataset.type="set";const o=t.querySelector('input[name="width_m"]'),n=t.querySelector('input[name="height_m"]'),r=t.querySelector('select[name="set_style"]'),i=t.querySelector('select[name="fabric_variant"]'),l=t.querySelector('select[name="set_price_per_m"]'),d=t.querySelector('select[name="sheer_price_per_m"]'),c=t.querySelector('select[name="louis_price_per_m"]'),p=t.querySelector('input[name="fabric_code"]'),u=t.querySelector('input[name="sheer_fabric_code"]'),f=t.querySelector('select[name="opening_style"]'),v=t.querySelector('select[name="adjustment_side"]'),y=t.querySelector('input[name="notes"]'),h=t.querySelector('[data-set-control="opening_style_wrap"]'),w=t.querySelector('[data-set-control="adjustment_side_wrap"]'),T=t.querySelector('[data-set-control="louis_price_wrap"]'),E=t.querySelector('[data-set-control="fabric_price_wrap"]'),P=t.querySelector('[data-set-control="fabric_code_wrap"]'),F=t.querySelector("[data-sheer-wrap]"),D=t.querySelector("[data-sheer-code-wrap]"),Q=t.querySelector("[data-set-summary]"),X=t.querySelector(".item-details-more"),S=t.querySelector('[data-act="toggle-more-details"]')?.parentElement,b=()=>({width_m:o.value,height_m:n.value,style:r.value,fabric_variant:i.value,price_per_m_raw:l.value,sheer_price_per_m:d.value,louis_price_per_m:c.value,is_suspended:t.classList.contains("is-suspended")}),x=()=>{const L=b(),C=A.calculateSetPrice(L);t.dataset.totalPrice=C.total;let N=`ราคา: <b>${B(C.total)}</b> บ.`;if(L.style==="หลุยส์"){const R=[];C.opaque>0&&R.push(`ทึบ: ${B(C.opaque)}`),C.sheer>0&&R.push(`โปร่ง: ${B(C.sheer)}`),C.louis>0&&R.push(`หลุยส์: ${B(C.louis)}`),R.length>0&&(N+=` <small>(${R.join(", ")})</small>`)}else C.opaque>0&&C.sheer>0&&(N+=` <small>(ทึบ: ${B(C.opaque)}, โปร่ง: ${B(C.sheer)})</small>`);const z=A.fabricYardage(L.style,L.width_m);z>0&&(N+=` &bull; ใช้ผ้า: ${z.toFixed(2)} หลา`),Q?Q.innerHTML=N:console.warn("Summary element not found for set item.")},q=qe(()=>{x(),t.dispatchEvent(new CustomEvent("item-update",{bubbles:!0}))},200),g=()=>{const L=r.value,C=i.value,N=L==="หลุยส์",z=C.includes("โปร่ง"),R=C==="โปร่ง"&&!N,Ae=C==="ทึบ"&&!N;F?.classList.toggle("hidden",!z||N),D?.classList.toggle("hidden",!z||N);const pe=R||N;l&&(l.disabled=pe,pe&&(l.value="")),p&&(p.disabled=pe,pe&&(p.value=""));const fe=Ae||N;d&&(d.disabled=fe,fe&&(d.value="")),u&&(u.disabled=fe,fe&&(u.value=""))},k=()=>{const L=r.value,C=L==="ม่านพับ",N=L==="หลุยส์",z=C||N||L==="ม่านแป๊บ";h&&h.classList.toggle("hidden",z),w&&w.classList.toggle("hidden",!C),T&&T.classList.toggle("hidden",!N),E&&E.classList.toggle("hidden",N),P&&P.classList.toggle("hidden",N),g()};t.addEventListener("input",L=>{L.target===i&&g(),L.target===r&&k(),q()});const I=L=>{We(L),q()};if(o.addEventListener("blur",I),n.addEventListener("blur",I),X&&S){const L=t.querySelector(".item-grid");L&&L.appendChild(S)}return o.value=K(e.width_m),n.value=K(e.height_m),r.value=e.style||"ลอน",i.value=e.fabric_variant||"ทึบ",l.value=e.price_per_m_raw||"",d.value=e.sheer_price_per_m||"",c.value=e.louis_price_per_m||"",p.value=e.fabric_code||"",u.value=e.sheer_fabric_code||"",f.value=e.opening_style||"แยกกลาง",v.value=e.adjustment_side||"ปรับขวา",y.value=e.notes||"",t.querySelector('input[name="track_color"]').value=e.track_color||"ขาว",t.querySelector('input[name="bracket_color"]').value=e.bracket_color||"ขาว",t.querySelector('input[name="finial_color"]').value=e.finial_color||"ขาว",t.querySelector('input[name="grommet_color"]').value=e.grommet_color||"เงิน",t.querySelector('input[name="louis_valance"]').value=e.louis_valance||"กล่องหลุยส์",t.querySelector('input[name="louis_tassels"]').value=e.louis_tassels||"สีเข้ากับผ้า",e.is_suspended&&t.classList.add("is-suspended"),k(),x(),t}function He(e={}){const a=document.querySelector(m.wallTpl);if(!a)return null;const t=a.content.cloneNode(!0).firstElementChild,o=t.querySelector('input[name="wall_width_m"]');o.value=K(e.width);const n=`wall_width_${Date.now()}_${Math.random().toString(36).substring(2,7)}`;o.id=n;const r=t.querySelector("label");return r&&r.setAttribute("for",n),t}function Be(e={}){const a=document.querySelector(m.wallpaperTpl);if(!a)return console.error("Wallpaper template not found"),null;const t=a.content.cloneNode(!0).firstElementChild;t.dataset.type="wallpaper";const o=t.querySelector('[name="wallpaper_height_m"]'),n=t.querySelector('[name="wallpaper_price_roll"]'),r=t.querySelector('[name="wallpaper_install_cost"]'),i=t.querySelector('[name="wallpaper_code"]'),l=t.querySelector('[name="wallpaper_notes"]'),d=t.querySelector("[data-walls-container]"),c=t.querySelector("[data-wallpaper-summary]"),p=t.querySelector(".item-details-more"),u=t.querySelector('[data-act="toggle-more-details"]')?.parentElement,f=()=>({height_m:o.value,price_per_roll:n.value,install_cost_per_roll:r.value,widths:Array.from(d.querySelectorAll('input[name="wall_width_m"]')).map(w=>w.value),is_suspended:t.classList.contains("is-suspended")}),v=()=>{const w=f(),T=A.calculateWallpaperPrice(w);t.dataset.totalPrice=T.total;let E=`รวม: <b>${B(T.total)}</b> บ. `;(T.material>0||T.install>0)&&(E+=`<small>(วอลล์: ${B(T.material)}, ค่าช่าง: ${B(T.install)})</small>`),T.rolls>0&&(E+=` &bull; พื้นที่: ${oe(T.sqm,2)} ตร.ม. &bull; ใช้: ${T.rolls} ม้วน`),c&&(c.innerHTML=E)},y=qe(()=>{v(),t.dispatchEvent(new CustomEvent("item-update",{bubbles:!0}))},200);t.addEventListener("input",y);const h=w=>{We(w),y()};if(o.addEventListener("blur",h),t.addEventListener("blur",w=>{w.target.name==="wall_width_m"&&h(w)},!0),p&&u){const w=t.querySelector(".item-grid");w&&w.appendChild(u)}if(e.widths&&e.widths.length>0)e.widths.forEach(w=>{const T=He({width:w});T&&d.appendChild(T)});else{const w=He();w&&d.appendChild(w)}return o.value=K(e.height_m),n.value=e.price_per_roll>0?B(e.price_per_roll):"",e.hasOwnProperty("install_cost_per_roll")?r.value=e.install_cost_per_roll===0?"0":e.install_cost_per_roll>0?B(e.install_cost_per_roll):"":r.value=r.value,i.value=e.wallpaper_code||"",l.value=e.notes||"",e.is_suspended&&t.classList.add("is-suspended"),v(),t}function Ee(e,a={}){const s=document.querySelector(m.areaBasedTpl);if(!s)return console.error("AreaBased template not found"),null;const o=s.content.cloneNode(!0).firstElementChild;o.dataset.type=e;const n=O[e]||{name:"ของตกแต่ง"};o.classList.add(`${e.replace(/_/g,"-")}-item`);const r=o.querySelector(".item-type-display"),i=o.querySelector('[name="area_width_m"]'),l=o.querySelector('[name="area_height_m"]'),d=o.querySelector('[name="area_price_sqyd"]'),c=o.querySelector('[name="area_code"]'),p=o.querySelector('[name="area_notes"]'),u=o.querySelector(".btn-favorite"),f=o.querySelector(".btn-show-favs"),v=o.querySelector("[data-area-summary]"),y=o.querySelector(".item-details-more"),h=o.querySelector('[data-act="toggle-more-details"]')?.parentElement,w=y?.querySelector(".item-grid"),T=w?.querySelector('[name="area_price_sqyd"]')?.closest(".form-group");let E,P;if(w&&T){if(e==="partition"||e==="pleated_screen"){const S=document.createElement("div");S.className="form-group",S.innerHTML=`
                <label>รูปแบบเปิด
                    <select name="opening_style">
                        <option value="แยกกลาง">แยกกลาง</option>
                        <option value="เก็บข้างเดียว">เก็บข้างเดียว</option>
                    </select>
                </label>
            `,w.insertBefore(S,T),E=S.querySelector("select")}else if(["wooden_blind","roller_blind","vertical_blind","aluminum_blind"].includes(e)){const S=document.createElement("div");S.className="form-group",S.innerHTML=`
                <label>เชือกปรับ
                    <select name="adjustment_side">
                        <option value="ปรับขวา">ปรับขวา</option>
                        <option value="ปรับซ้าย">ปรับซ้าย</option>
                    </select>
                </label>
            `,w.insertBefore(S,T),P=S.querySelector("select")}(E||P)&&T&&T.classList.remove("full-width-item")}const F=()=>({width_m:i.value,height_m:l.value,price_sqyd:d.value,is_suspended:o.classList.contains("is-suspended")}),D=()=>{const S=F(),b=A.calculateAreaBasedPrice(S);o.dataset.totalPrice=b.total;const x=b.sqyd>0?` &bull; พื้นที่: ${oe(b.sqyd,2)} ตร.หลา`:"";v&&(v.innerHTML=`ราคา: <b>${B(b.total)}</b> บ.${x}`)},Q=qe(()=>{D(),o.dispatchEvent(new CustomEvent("item-update",{bubbles:!0}))},200);o.addEventListener("input",Q);const X=S=>{We(S),Q()};if(i.addEventListener("blur",X),l.addEventListener("blur",X),y&&h){const S=o.querySelector(".item-grid");S&&S.appendChild(h)}return r&&(r.textContent=n.name),c&&(c.dataset.favoriteType=e),u&&(u.dataset.type=e),f&&(f.dataset.type=e),i.value=K(a.width_m),l.value=K(a.height_m),d.value=a.price_sqyd>0?B(a.price_sqyd):"",c.value=a.code||"",p.value=a.notes||"",E&&(E.value=a.opening_style||"แยกกลาง"),P&&(P.value=a.adjustment_side||"ปรับขวา"),a.is_suspended&&o.classList.add("is-suspended"),D(),o}const W=[];let ee=!1,ke=null,H=null,ye=null,we=!1,G=null,De=!1,ce=null,ue=null,ie=[];const ze=document.querySelector("#undoBtn"),je="marnthara.theme",xe={};function Pt(e){if(xe[e])return xe[e];const a=new Promise((s,t)=>{const o=document.createElement("script");o.src=e,o.onload=()=>s(),o.onerror=()=>{console.error(`Script load error for ${e}`),delete xe[e],t(new Error(`Script load error for ${e}`))},document.head.appendChild(o)});return xe[e]=a,a}function st(){const e=localStorage.getItem(je),a=document.querySelector("#themeToggleBtn");if(!a)return;const s=a.querySelector("i"),t=a.querySelector("span");switch(document.body.classList.remove("dark-theme","neutral-theme"),e){case"dark":document.body.classList.add("dark-theme"),s&&(s.className="ph-fill ph-sun"),t&&(t.textContent=" สว่าง");break;case"neutral":document.body.classList.add("neutral-theme"),s&&(s.className="ph-fill ph-moon"),t&&(t.textContent=" มืด");break;default:s&&(s.className="ph-fill ph-palette"),t&&(t.textContent=" กลาง");break}}function At(){const e=localStorage.getItem(je);let a="neutral";!e||e==="light"?a="neutral":e==="neutral"?a="dark":a="light",localStorage.setItem(je,a),st()}function te(){ze&&(ze.disabled=!St())}function Dt(){const e=bt();e&&(Ge(e,!1),$("ยกเลิกการกระทำล่าสุดแล้ว","success")),te()}function _e(){const e=document.getElementById("suspendedItemsBtn");if(!e)return;if(ye){e.classList.remove("is-visible");return}const a=document.getElementById("suspendedCountBadge"),s=document.querySelectorAll(".item-card.is-suspended:not(.placeholder-item)").length,t=document.querySelectorAll(".room-card.is-suspended");let o=0;t.forEach(r=>{o+=r.querySelectorAll(".item-card:not(.is-suspended):not(.placeholder-item)").length});const n=s+o;a&&(a.textContent=n),e.classList.toggle("is-visible",n>0)}function Ne(){ye="suspended";const e=document.getElementById("filterStatusBar");let a=0;if(document.querySelectorAll(".room-card").forEach(t=>{let o=!1;const n=t.classList.contains("is-suspended");t.querySelectorAll(".item-card").forEach(i=>{const d=i.classList.contains("is-suspended")||n;i.classList.toggle("item-hidden",!d),d&&(o=!0,i.classList.contains("placeholder-item")||a++)});const r=n||o;t.classList.toggle("item-hidden",!r)}),document.querySelectorAll(".item-card.is-suspended:not(.placeholder-item)").length+Array.from(document.querySelectorAll(".room-card.is-suspended .item-card:not(.is-suspended):not(.placeholder-item)")).length===0){lt(),$("ไม่มีรายการที่ถูกระงับแล้ว","success");return}e&&(e.innerHTML=`
            <span><i class="ph ph-warning"></i> รายการที่ถูกระงับ (${a} รายการ)</span>
            <button type="button" class="btn-chip" data-act="clear-filter" title="ยกเลิกการกรอง">
                <i class="ph ph-x"></i>&nbsp;ปิด
            </button>
        `,e.classList.add("is-visible"),e.dataset.filterType="suspended"),ae(),ne(),_e()}function Nt(e,a){if(!e)return;ye=e;const s=document.getElementById("filterStatusBar");let t=0;document.querySelectorAll(m.room).forEach(o=>{let n=0;o.querySelectorAll(".item-card").forEach(r=>{const i=r.dataset.type===e&&!r.classList.contains("placeholder-item");r.classList.toggle("item-hidden",!i),i&&n++}),o.querySelectorAll(".placeholder-item").forEach(r=>r.classList.toggle("item-hidden",n===0)),o.classList.toggle("item-hidden",n===0),n>0&&(t+=n)}),s&&(s.innerHTML=`
            <span>เฉพาะ: <strong>${M(a)}</strong> (${t} รายการ)</span>
            <button type="button" class="btn-chip" data-act="clear-filter" title="ยกเลิกการกรอง">
                <i class="ph ph-x"></i>&nbsp;ปิด
            </button>
        `,s.classList.add("is-visible"),s.dataset.filterType=e),ae(),ne(),_e()}function lt(){ye=null;const e=document.getElementById("filterStatusBar");e&&(e.classList.remove("is-visible"),e.innerHTML="",e.removeAttribute("data-filter-type")),document.querySelectorAll(".item-hidden").forEach(a=>a.classList.remove("item-hidden")),ae(),ne(),_e()}function $(e,a="default"){const s=document.querySelector(m.toastContainer);if(!s)return;const t={success:"ph-bold ph-check-circle",warning:"ph-bold ph-warning",error:"ph-bold ph-x-circle",default:"ph-bold ph-info"},o=document.createElement("div");o.className=`toast toast-${a}`,o.innerHTML=`<i class="${t[a]||t.default}"></i> ${M(e)}`,s.appendChild(o),setTimeout(()=>o.classList.add("show"),10),setTimeout(()=>{o.classList.remove("show"),o.addEventListener("transitionend",()=>o.remove())},3e3)}function j(e,a){return new Promise(s=>{const t=document.querySelector(e);if(!t){console.error("Modal not found:",e),s(null);return}if(W.length>0){const u=W[W.length-1];u&&u.classList.contains("visible")&&u.classList.add("is-underlay")}W.push(t),t.classList.add("visible");const o=t.querySelector('[id$="Confirm"]'),n=t.querySelector('[id$="Cancel"], [data-act="close-modal"], #roomDefaultsCancelBtn, #manageFavsTypeCancel, #forceApplyCancel, #forceApplyTypeCancel, #dimensionEntryCancel'),r=Array.from(t.querySelectorAll('button, [href], input:not([type="hidden"]), select, textarea, [tabindex]:not([tabindex="-1"])')).filter(u=>!u.disabled&&u.offsetParent!==null),i=r[0],l=r[r.length-1];setTimeout(()=>i?.focus(),50);const d=u=>{t.classList.remove("visible"),document.removeEventListener("keydown",c),t.removeEventListener("click",p),o&&(o.onclick=null),n&&(n.onclick=null),t.closeModal===d&&(t.closeModal=null);const f=W.pop();f!==t&&(console.error(`[cleanup] Modal stack mismatch! Expected #${t.id}, but popped #${f?.id}. Resetting stack.`),W.length=0);const v=W.length>0?W[W.length-1]:null;v&&v.classList.contains("visible")&&v.classList.remove("is-underlay"),e==="#roomDefaultsModal"&&(ie.forEach(({element:y,event:h,handler:w})=>{y.removeEventListener(h,w)}),ie=[],ue=null),e==="#favoritesModal"&&(ce=null),u?.cancelled&&typeof a=="function"&&a(),s(u)};t.closeModal=d;const c=u=>{const f=W.length>0&&W[W.length-1]===t;u.key==="Escape"&&f&&d({cancelled:!0}),u.key==="Tab"&&r.length>1&&(u.shiftKey?document.activeElement===i&&(l.focus(),u.preventDefault()):document.activeElement===l&&(i.focus(),u.preventDefault()))},p=u=>{const f=W.length>0&&W[W.length-1]===t;u.target===t&&f&&(u.stopPropagation(),d({cancelled:!0}))};o&&(o.onclick=()=>d(!0)),n&&(n.onclick=()=>{W.length>0&&W[W.length-1]===t&&d({cancelled:!0})}),document.addEventListener("keydown",c),t.addEventListener("click",p)})}async function re(e,a){const s=document.querySelector(m.modal);return s?(s.querySelector(m.modalTitle).textContent=e,s.querySelector(m.modalBody).textContent=a,await j(m.modal)===!0):!0}async function Ft(){const e=document.querySelector(m.exportOptionsModal);if(!e)return null;const a=e.querySelector("#pageBreakBuffer"),s=e.querySelector("#pageBreakBufferValue");a&&s&&(s.textContent=a.value,a.oninput=()=>{s.textContent=a.value});const t=await j(m.exportOptionsModal);return a&&(a.oninput=null),!t||t.cancelled?null:{vatOption:e.querySelector('input[name="vat_option"]:checked')?.value||"include",showDetails:(e.querySelector('input[name="item_details_option"]:checked')?.value||"show_details")==="show_details",exportMethod:e.querySelector("#exportMethod")?.value||"direct",pageBreakBuffer:parseInt(a?.value,10)||3}}async function Rt(){const e=document.querySelector("#discountModal");if(!e)return Promise.resolve({cancelled:!0});const a=e.querySelector("#discountSubtotal"),s=e.querySelector("#discountPercent"),t=e.querySelector("#discountAmount"),o=e.querySelector("#discountFinalTotal"),n=document.querySelector("#discount_type"),r=document.querySelector("#discount_value"),i=_(document.querySelector("#originalTotal").dataset.rawTotal||document.querySelector("#grandTotal").textContent);a&&(a.textContent=B(i));const l=h=>{if(De)return;De=!0;let w=0;if(h==="percent"){const T=_(s.value);w=i*(Math.max(0,T)/100),t.value=w>0?B(Math.round(w)):""}else w=_(t.value);if(w=Math.max(0,Math.min(w,i)),h!=="percent"){const T=i>0?w/i*100:0;s.value=T>0&&isFinite(T)?oe(T,2):""}o&&(o.textContent=B(i-w)),setTimeout(()=>{De=!1},50)},d=()=>l("percent"),c=()=>l("amount"),p=h=>{_(h.target.value)>0&&(h.target.value=_(h.target.value))},u=h=>{const w=_(h.target.value);h.target.value=w>0?B(w):"",l("amount")};s.addEventListener("input",d),t.addEventListener("input",c),t.addEventListener("focus",p),t.addEventListener("blur",u);const f=n.value,v=_(r.value);s.value="",t.value="",v>0?f==="percent"?(s.value=v,l("percent")):(t.value=v,t.value=B(v),l("amount")):l();const y=await j("#discountModal");if(s.removeEventListener("input",d),t.removeEventListener("input",c),t.removeEventListener("focus",p),t.removeEventListener("blur",u),y&&!y.cancelled){const h=_(s.value),w=_(t.value),T=document.activeElement;h>0&&T===s?(n.value="percent",r.value=h):w>0?(n.value="amount",r.value=w):h>0?(n.value="percent",r.value=h):(n.value="amount",r.value=0),J()}}async function Ot(){if(!H)return;const e=document.querySelector("#hardwareModal");if(!e)return;const a=H.querySelector('[name="set_style"]'),s=a?a.value:null,t=s==="ตาไก่",o=s==="ม่านพับ",n=s==="หลุยส์",r=e.querySelector("#trackColorGroup"),i=e.querySelector("#bracketColorGroup"),l=e.querySelector("#finialColorGroup"),d=e.querySelector("#grommetColorGroup"),c=e.querySelector("#louisValanceGroup"),p=e.querySelector("#louisTasselGroup"),u=e.querySelector("#hardwareApplyToRoom");e.querySelector('[name="modal_track_color"]').value=H.querySelector('[name="track_color"]')?.value||"ขาว",e.querySelector('[name="modal_bracket_color"]').value=H.querySelector('[name="bracket_color"]')?.value||"ขาว",e.querySelector('[name="modal_finial_color"]').value=H.querySelector('[name="finial_color"]')?.value||"ขาว",e.querySelector('[name="modal_grommet_color"]').value=H.querySelector('[name="grommet_color"]')?.value||"เงิน",e.querySelector('[name="modal_louis_valance"]').value=H.querySelector('[name="louis_valance"]')?.value||"กล่องหลุยส์",e.querySelector('[name="modal_louis_tassels"]').value=H.querySelector('[name="louis_tassels"]')?.value||"สีเข้ากับผ้า",r&&(r.style.display=""),i&&(i.style.display=""),l&&(l.style.display=t?"":"none"),d&&(d.style.display=t?"":"none"),c&&(c.style.display=n?"":"none"),p&&(p.style.display=n?"":"none"),u&&(u.disabled=o||n);const f=await j("#hardwareModal");f&&!f.cancelled&&(H.querySelector('[name="track_color"]').value=e.querySelector('[name="modal_track_color"]').value,H.querySelector('[name="bracket_color"]').value=e.querySelector('[name="modal_bracket_color"]').value,t?(H.querySelector('[name="finial_color"]').value=e.querySelector('[name="modal_finial_color"]').value,H.querySelector('[name="grommet_color"]').value=e.querySelector('[name="modal_grommet_color"]').value):n&&(H.querySelector('[name="louis_valance"]').value=e.querySelector('[name="modal_louis_valance"]').value,H.querySelector('[name="louis_tassels"]').value=e.querySelector('[name="modal_louis_tassels"]').value),Z(),$("บันทึกการตั้งค่าอุปกรณ์แล้ว","success")),H=null}async function Ht(e){if(!e)return;ue=e;const a=document.querySelector(m.roomDefaultsModal),s=document.querySelector(m.roomDefaultsForm);if(!a||!s)return;ie.forEach(({element:l,event:d,handler:c})=>{l.removeEventListener(d,c)}),ie=[];const t=JSON.parse(ue.dataset.roomDefaults||"{}"),o=a.querySelectorAll(".defaults-tab"),n=a.querySelectorAll(".defaults-content"),r=l=>{const d=l.currentTarget,c=d.dataset.target;if(!c)return;o.forEach(u=>u.classList.remove("is-active")),n.forEach(u=>u.classList.remove("is-active")),d.classList.add("is-active");const p=a.querySelector(`.defaults-content[data-type="${c}"]`);p&&p.classList.add("is-active")};o.forEach(l=>{l.addEventListener("click",r),ie.push({element:l,event:"click",handler:r})}),o[0]&&o[0].classList.add("is-active"),n[0]&&n[0].classList.add("is-active");const i=l=>{const d=l.target,c=d.closest(".defaults-content");if(!c)return;const p=d.checked,u=c.querySelector(".defaults-inputs-grid");c.classList.toggle("is-enabled-content",p),u&&u.querySelectorAll('input[type="text"], input[type="number"], select, .btn-show-favs').forEach(f=>{f.disabled=!p,f.matches(".btn-show-favs")&&(f.style.opacity=p?"1":"0.5",f.style.pointerEvents=p?"auto":"none")})};n.forEach(l=>{const d=l.querySelector('.defaults-enable-toggle input[type="checkbox"]');if(!d)return;const c=d.name,p=t[c]===!0||t[c]==="1";d.checked=p,i({target:d}),d.addEventListener("change",i),ie.push({element:d,event:"change",handler:i});const u=l.querySelector(".defaults-inputs-grid");u&&u.querySelectorAll('input[type="text"], input[type="number"]').forEach(f=>{const v=f.name,y=t[v];f.type==="text"&&f.inputMode==="numeric"?(f.value=y===0?"0":y!=null&&y>0?B(y):"",f.addEventListener("focus",Ze),f.addEventListener("blur",et),ie.push({element:f,event:"focus",handler:Ze}),ie.push({element:f,event:"blur",handler:et})):f.value=y||""})}),await j(m.roomDefaultsModal)}async function jt(){const e=document.querySelector("#forceApplyModal");if(!e)return;const a=e.querySelector('[name="force_apply_type_hidden"]'),s=e.querySelector("#forceApplySelectedTypeDisplay"),t=e.querySelector('[name="force_apply_code"]'),o=e.querySelector('[name="force_apply_price"]'),n=t?.closest(".form-group-with-favorites")?.querySelector(".btn-show-favs");a&&(a.value=""),s&&(s.textContent="-- เลือกประเภท --"),t&&(t.value="",t.dataset.favoriteType=""),o&&(o.value=""),n&&(n.disabled=!0),await j("#forceApplyModal")}function Ze(e){e.target.value!=="0"&&_(e.target.value)>0&&(e.target.value=_(e.target.value))}function et(e){const a=_(e.target.value);e.target.value=a===0?"0":a!=null&&a>0?B(a):""}function Wt(){if(!ue)return;const e=document.querySelector(m.roomDefaultsForm);if(!e)return;const a={};e.querySelectorAll(".defaults-content").forEach(t=>{const o=t.querySelector('.defaults-enable-toggle input[type="checkbox"]');if(o){const n=o.name,r=o.checked;if(a[n]=r,r){const i=t.querySelector(".defaults-inputs-grid");i&&i.querySelectorAll('input[type="text"], input[type="number"]').forEach(l=>{const d=l.name,c=l.value.trim();let p;l.type==="text"&&l.inputMode==="numeric"?c===""?p=void 0:p=_(c):p=c,(typeof p=="number"&&!isNaN(p)||typeof p=="string"&&p!=="")&&(a[d]=p)})}}}),ue.dataset.roomDefaults=JSON.stringify(a),Z();const s=document.querySelector(m.roomDefaultsModal);s&&typeof s.closeModal=="function"?(s.closeModal(!0),setTimeout(()=>$("บันทึกค่าเริ่มต้นห้องแล้ว","success"),50)):console.error("Could not find room defaults modal or its closer function.")}async function Vt(){if(!ue)return;const e=document.querySelector(m.roomDefaultsModal),a=document.querySelector(m.roomDefaultsForm);if(!e||!a)return;const s={};if(a.querySelectorAll(".defaults-content").forEach(n=>{const r=n.querySelector('.defaults-enable-toggle input[type="checkbox"]');if(r&&r.checked){const i=n.querySelector(".defaults-inputs-grid");i&&i.querySelectorAll('input[type="text"], input[type="number"]').forEach(l=>{const d=l.name,c=l.type==="text"&&l.inputMode==="numeric"?_(l.value):l.value.trim();(typeof c=="number"&&!isNaN(c)||typeof c=="string"&&c!=="")&&(s[d]=c)})}}),Object.keys(s).length===0){$("ยังไม่มีการเลือกค่าเริ่มต้นที่จะใช้","warning");return}if(!await re("ใช้ค่าเริ่มต้น","ใช้ค่าเริ่มต้นที่ *เลือกไว้* กับรายการที่ยังไม่มีข้อมูลในห้องนี้?"))return;se(U()),te();let t=0;ue.getItemsContainer().querySelectorAll(".item-card").forEach(n=>{const r=n.dataset.type;let i=!1;const l=(d,c)=>{const p=s[c],u=n.querySelector(d);if(!u||p==null)return;const f=u.tagName==="SELECT",v=f?u.value:u.value.trim(),y=f?null:_(v);let h=!1;if(f?h=!v:u.matches('input[type="text"][inputmode="numeric"]')?h=!v||y===0:h=!v,h){let w=!1;f?Array.from(u.options).some(T=>T.value==p)&&(u.value=p,w=!0):u.matches('input[type="text"][inputmode="numeric"]')?typeof p=="number"&&!isNaN(p)&&(u.value=p===0?"0":B(p),w=!0):u.matches('input[type="text"]:not([inputmode])')&&(u.value=p,w=!0),w&&(i=!0,u.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0})),u.matches('input[type="text"][inputmode="numeric"]')&&u.dispatchEvent(new Event("blur",{bubbles:!0,cancelable:!0})))}};switch(r){case"set":l(m.setFabricCodeInput,"defaults_fabric_code"),l(m.setPricePerMSelect,"defaults_fabric_price"),l(m.setSheerCodeInput,"defaults_sheer_code"),l(m.setSheerPricePerMSelect,"defaults_sheer_price");break;case"wallpaper":l(m.wallCodeInput,"defaults_wallpaper_code"),l(m.wallPriceRollInput,"defaults_wallpaper_price_roll"),l(m.wallInstallCostInput,"defaults_wallpaper_install_cost");break;case"wooden_blind":l(m.areaCodeInput,"defaults_wooden_blind_code"),l(m.areaPriceSqydInput,"defaults_wooden_blind_price_sqyd");break;case"roller_blind":l(m.areaCodeInput,"defaults_roller_blind_code"),l(m.areaPriceSqydInput,"defaults_roller_blind_price_sqyd");break;case"vertical_blind":l(m.areaCodeInput,"defaults_vertical_blind_code"),l(m.areaPriceSqydInput,"defaults_vertical_blind_price_sqyd");break;case"partition":l(m.areaCodeInput,"defaults_partition_code"),l(m.areaPriceSqydInput,"defaults_partition_price_sqyd");break;case"pleated_screen":l(m.areaCodeInput,"defaults_pleated_screen_code"),l(m.areaPriceSqydInput,"defaults_pleated_screen_price_sqyd");break;case"aluminum_blind":l(m.areaCodeInput,"defaults_aluminum_blind_code"),l(m.areaPriceSqydInput,"defaults_aluminum_blind_price_sqyd");break}i&&t++}),e&&typeof e.closeModal=="function"?e.closeModal({cancelled:!0}):console.error("Could not find room defaults modal or its closer function."),setTimeout(()=>{t>0?(J(),$(`ใช้ค่าเริ่มต้นกับ ${t} รายการแล้ว`,"success")):$("ไม่มีรายการใดที่ต้องอัปเดต","default")},50)}async function Gt(){const e=document.querySelector("#forceApplyModal");if(!e)return;const a=e.querySelector('[name="force_apply_type_hidden"]'),s=e.querySelector('[name="force_apply_code"]'),t=e.querySelector('[name="force_apply_price"]'),o=a.value,n=s.value.trim(),r=_(t.value);if(!o){$("โปรดเลือกประเภทรายการที่จะบังคับใช้","warning"),e.querySelector("#forceApplySelectTypeBtn")?.focus();return}if(!n){$("โปรดกรอกรหัสที่จะบังคับใช้","warning"),s.focus();return}if(r<0||r<=0&&!["fabric","sheer","wallpaper"].includes(o)){$("โปรดกรอกราคาที่ถูกต้อง (> 0)","warning"),t.focus();return}const i=e.querySelector("#forceApplySelectedTypeDisplay");let l=i?i.textContent:o;const d="ยืนยันการบังคับใช้",c=`⚠️ ยืนยันการเปลี่ยนรหัสเป็น "${n}" และราคาเป็น ${B(r)} บาท สำหรับรายการประเภท "${l}" ***ทุกรายการ*** ในทุกห้องหรือไม่? การกระทำนี้ไม่สามารถยกเลิกได้ง่ายๆ`;if(!await re(d,c))return;se(U()),te();let p=0;document.querySelectorAll(".item-card").forEach(f=>{if(f.classList.contains("placeholder-item"))return;const v=f.dataset.type;let y=null,h=null;if(o==="fabric"&&v==="set"?(y=f.querySelector('input[name="fabric_code"]'),h=f.querySelector('select[name="set_price_per_m"]')):o==="sheer"&&v==="set"?(y=f.querySelector('input[name="sheer_fabric_code"]'),h=f.querySelector('select[name="sheer_price_per_m"]')):o==="wallpaper"&&v==="wallpaper"?(y=f.querySelector('input[name="wallpaper_code"]'),h=f.querySelector('input[name="wallpaper_price_roll"]')):v===o&&f.matches(".area-based-item")&&(y=f.querySelector('input[name="area_code"]'),h=f.querySelector('input[name="area_price_sqyd"]')),y&&h){if(y.value=n,y.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0})),h.tagName==="SELECT")if(Array.from(h.options).some(T=>T.value==r))h.value=r;else{if(console.warn(`Price ${r} not found in options for`,h,". Forcing new option."),!h.querySelector(`option[value="${r}"][data-forced="true"]`)){const E=document.createElement("option");E.value=r,E.textContent=r===0?"0 บาท":`${B(r)} บาท (บังคับ)`,E.dataset.forced="true",h.appendChild(E)}h.value=r}else{const w=r===0?"0":r!=null&&r>0?B(r):"";h.value=w}h.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0})),h.dispatchEvent(new Event("blur",{bubbles:!0,cancelable:!0})),p++,y.classList.add("input-highlight"),h.classList.add("input-highlight"),setTimeout(()=>{y.classList.remove("input-highlight"),h.classList.remove("input-highlight")},1200)}}),p>0?(J(),$(`บังคับใช้ค่าใหม่กับ ${p} รายการ (${l}) สำเร็จ`,"success"),e&&typeof e.closeModal=="function"&&e.closeModal({cancelled:!0})):$(`ไม่พบรายการประเภท "${l}" ที่ต้องอัปเดต`,"default")}async function Ut(){const e=document.querySelector("#manageFavsTypeModal"),a=document.querySelector("#manageFavsTypeBody");if(!e||!a)return;const s=Object.keys(de());let t="",o=null;const n={fabric:"ph-rows",sheer:"ph-waves",wallpaper:"ph-paint-roller",wooden_blind:"ph-table",roller_blind:"ph-scroll",vertical_blind:"ph-sidebar-simple",partition:"ph-columns",pleated_screen:"ph-squares-four",aluminum_blind:"ph-stack-simple"};if(s.includes("fabric")&&(t+=`
             <label data-item-type="fabric">
                 <input type="radio" name="manage_fav_type_option" value="fabric">
                 <span class="radio-card-content">
                     <strong><i class="ph ${n.fabric}"></i> ผ้าทึบ</strong>
                     <small>Fabric Codes</small>
                 </span>
             </label>`,o||(o="fabric")),s.includes("sheer")&&(t+=`
              <label data-item-type="sheer">
                  <input type="radio" name="manage_fav_type_option" value="sheer">
                  <span class="radio-card-content">
                      <strong><i class="ph ${n.sheer}"></i> ผ้าโปร่ง</strong>
                      <small>Sheer Codes</small>
                  </span>
              </label>`,o||(o="sheer")),s.forEach(i=>{if(i==="fabric"||i==="sheer")return;const l=O[i];if(l){const d=l.name,c=n[i]||"ph-star";t+=`
                <label data-item-type="${i}">
                    <input type="radio" name="manage_fav_type_option" value="${i}">
                    <span class="radio-card-content">
                        <strong><i class="ph ${c}"></i> ${M(d)}</strong>
                        <small>${i.replace(/_/g," ").replace(/\b\w/g,p=>p.toUpperCase())} Codes</small>
                    </span>
                </label>`,o||(o=i)}}),a.innerHTML=t,o){const i=a.querySelector(`input[value="${o}"]`);i&&(i.checked=!0)}const r=await j("#manageFavsTypeModal");if(r&&!r.cancelled){const i=a.querySelector('input[name="manage_fav_type_option"]:checked')?.value;i&&await dt(i)}}function Fe(e,a){e&&(se(U()),te(),e.classList.add("item-removing"),e.addEventListener("animationend",()=>{e.remove(),$(a),Pe(),ae(),J(),$e()},{once:!0}))}function Jt(e){if(!e)return;const a=document.querySelector(".main-header");if(!a){e.scrollIntoView({behavior:"smooth",block:"center"});return}const s=a.offsetHeight,t=16,n=(e.querySelector(".item-header")||e).getBoundingClientRect(),r=s+t,i=n.top-r;Math.abs(i)>5&&window.scrollBy({top:i,behavior:"smooth"})}function ve(e){if(!e)return;const a=document.querySelector(".main-header"),s=document.querySelector(".summary-footer"),t=a?a.offsetHeight+16:80,o=s?s.offsetHeight+16:100;requestAnimationFrame(()=>{const n=e.getBoundingClientRect(),r=window.innerHeight;if(!(n.top>=t&&n.bottom<=r-o)){const l=r-t-o,d=n.height>l?"start":"center";e.scrollIntoView({behavior:"smooth",block:d})}})}function ae(){document.querySelectorAll(m.room).forEach(e=>{const a=e.querySelectorAll(".item-card:not(.item-hidden)");let s=0;const t=Array.from(a).filter(o=>!o.classList.contains("is-suspended")&&!o.classList.contains("placeholder-item")).length;a.forEach(o=>{const n=o.querySelector("[data-item-title]");n&&(o.classList.contains("placeholder-item")?n.textContent="...":o.classList.contains("is-suspended")?n.textContent="-":(s++,n.textContent=`${s}/${t}`))}),e.querySelectorAll(".item-card.item-hidden").forEach(o=>{const n=o.querySelector("[data-item-title]");n&&(n.textContent="-")})})}function it(){const e=document.querySelector(m.orderForm),a=document.querySelector(m.lockBtn);!e||!a||(e.classList.toggle("is-locked",ee),a.classList.toggle("is-locked",ee),a.querySelector("i").className=ee?"ph-bold ph-lock-key":"ph ph-paw-print",e.querySelectorAll('input:not([type="hidden"]), select, textarea, button:not(.unlockable):not([data-act="toggle-more-details"]):not([data-act="collapse-room"])').forEach(s=>{!s.closest(".main-header")&&!s.closest(".summary-footer")&&!s.closest(".modal-wrapper")&&(s.disabled=ee)}),document.querySelectorAll(".unlockable").forEach(s=>s.disabled=!1))}function Yt(){ee=!ee,it(),$(ee?"ฟอร์มถูกล็อค":"ปลดล็อคฟอร์มแล้ว",ee?"warning":"success")}function ne(){const e=document.querySelectorAll(m.room+":not(.item-hidden)");if(e.length===0){const t=document.querySelector(m.toggleAllRoomsBtn);t&&(t.querySelector("i").className="ph ph-caret-down",t.querySelector("span").textContent="ขยายทั้งหมด");return}const a=[...e].some(t=>t.open),s=document.querySelector(m.toggleAllRoomsBtn);s&&(s.querySelector("i").className=a?"ph ph-caret-up":"ph ph-caret-down",s.querySelector("span").textContent=a?"ย่อทั้งหมด":"ขยายทั้งหมด")}function Qt(){const e=document.querySelectorAll(m.room+":not(.item-hidden)");if(e.length===0)return;const a=[...e].some(t=>t.open);e.forEach(t=>{t.open=!a});const s=document.querySelector(m.quickNavDropdown);s&&s.classList.contains("show")&&(s.classList.remove("show"),document.querySelector(m.quickNavBtn)?.setAttribute("aria-expanded","false")),setTimeout(()=>{ne(),Z()},50)}function Pe(){const e=document.querySelector(m.quickNavRoomList);e&&(e.innerHTML="",document.querySelectorAll(m.room).forEach(a=>{const s=a.querySelector(m.roomNameInput)?.value||"ห้อง",t=document.createElement("a");t.href=`#${a.id}`,t.dataset.jumpTo=a.id,t.innerHTML=`<i class="ph ph-share-fat"></i> ${M(s)||"ห้อง (ไม่มีชื่อ)"}`,e.appendChild(t)}))}function Re(e){const a=document.getElementById("quickNavBtnText");a&&(e?a.textContent=e.querySelector('input[name="room_name"]')?.value||"...":a.textContent="ไปยังห้อง")}function $e(){if(ke&&ke.disconnect(),!document.getElementById("quickNavBtnText"))return;const a={root:null,rootMargin:"-60px 0px -150px 0px",threshold:0},s=o=>{const n=o.filter(r=>r.isIntersecting).sort((r,i)=>r.target.getBoundingClientRect().top-i.target.getBoundingClientRect().top);n.length>0&&Re(n[0].target)};ke=new IntersectionObserver(s,a),document.querySelectorAll(m.room).forEach(o=>ke.observe(o));const t=Array.from(document.querySelectorAll(m.room));if(t.length>0){t.sort((n,r)=>n.getBoundingClientRect().top-r.getBoundingClientRect().top);const o=t.find(n=>n.getBoundingClientRect().bottom>60);Re(o||t[0])}else Re(null)}function Me(e,a=null){if(!e||e.classList.contains("placeholder-item"))return;const s=e.querySelector(".item-details-more"),t=e.querySelector('[data-act="toggle-more-details"]'),o=t?.parentElement;if(!s||!t||!o)return;const n=s.classList.contains("show"),r=a!==null?a:!n;if(n===r)return;s.classList.toggle("show",r),t.classList.toggle("expanded",r);const i=t.querySelector("i");i&&(i.className=r?"ph ph-caret-up":"ph ph-caret-down");const l=t.querySelector("span");if(l&&(l.textContent=r?"ย่อน้อยลง":"เพิ่มเติม"),r)s.appendChild(o),setTimeout(()=>Jt(e),100);else{const d=e.querySelector(".item-grid");d&&d.appendChild(o)}}function he(e={}){const a=document.querySelector(m.roomsContainer);if(!a)return null;Object.keys(e).length===0&&(se(U()),te());const s=nt(e);return s?(a.appendChild(s),Object.keys(e).length===0&&(s.classList.add("item-created"),ve(s),s.querySelector('input[name="room_name"]')?.focus()),Pe(),ne(),$e(),Object.keys(e).length===0&&Z(),s):null}async function ct(e,a=null){const s=document.querySelector("#itemTypeModal");if(!s)return null;s.querySelector("#itemTypeModalTitle").textContent=e;let t=a||"set";a&&!O[a]&&(t="set");const o=s.querySelector(`input[name="item_type_option"][value="${t}"]`);if(o)o.checked=!0;else{const i=s.querySelector('input[name="item_type_option"][value="set"]');i&&(i.checked=!0)}const n=await j("#itemTypeModal");if(!n||n.cancelled)return null;const r=s.querySelector('input[name="item_type_option"]:checked');return r?r.value:null}function tt(){const e=document.createElement("div");return e.className="dimension-input-row",e.innerHTML=`
        <div class="form-group">
            <label class="visually-hidden">กว้าง (ม.)</label>
            <input type="number" step="0.01" inputmode="decimal" name="modal_width_m" placeholder="กว้าง">
        </div>
        <div class="form-group">
            <label class="visually-hidden">สูง (ม.)</label>
            <input type="number" step="0.01" inputmode="decimal" name="modal_height_m" placeholder="สูง">
        </div>
        <button type="button" class="btn-icon btn-icon-small danger btn-remove-dimension-row" data-act="remove-dimension-row" title="ลบขนาด" aria-label="ลบขนาดแถวนี้"><i class="ph-bold ph-x"></i></button>
    `,e.querySelectorAll('input[type="number"]').forEach(a=>{a.addEventListener("blur",s=>{s.target.value=K(s.target.value)})}),e}function Kt(e,a){if(!a||!e||e.width_m<=0||e.height_m<=0)return;const s=a.getItemsContainer();if(!s)return;const t=document.querySelector("#placeholderItemTpl");if(!t)return console.error("Placeholder template not found"),null;const n=t.content.cloneNode(!0).firstElementChild;n.dataset.widthM=e.width_m,n.dataset.heightM=e.height_m;const r=n.querySelector("[data-placeholder-width]"),i=n.querySelector("[data-placeholder-height]");return r&&(r.textContent=K(e.width_m)),i&&(i.textContent=K(e.height_m)),s.appendChild(n),n.classList.add("item-created"),n}function Xt(e,a,s){if(!e||!a||!s)return;const t=e.closest(m.room);if(!t)return;se(U()),te();const o=JSON.parse(t.dataset.roomDefaults||"{}");let n={width_m:s.width_m,height_m:s.height_m};const r=l=>o[`enable_defaults_${l}`]===!0;switch(a){case"set":r("set")&&(n.fabric_code=o.defaults_fabric_code,n.price_per_m_raw=o.defaults_fabric_price,n.sheer_fabric_code=o.defaults_sheer_code,n.sheer_price_per_m=o.defaults_sheer_price);break;case"wallpaper":r("wallpaper")&&(n.wallpaper_code=o.defaults_wallpaper_code,n.price_per_roll=o.defaults_wallpaper_price_roll,n.install_cost_per_roll=o.defaults_wallpaper_install_cost),delete n.width_m;break;case"wooden_blind":r("wooden_blind")&&(n.code=o.defaults_wooden_blind_code,n.price_sqyd=o.defaults_wooden_blind_price_sqyd);break;case"roller_blind":r("roller_blind")&&(n.code=o.defaults_roller_blind_code,n.price_sqyd=o.defaults_roller_blind_price_sqyd);break;case"vertical_blind":r("vertical_blind")&&(n.code=o.defaults_vertical_blind_code,n.price_sqyd=o.defaults_vertical_blind_price_sqyd);break;case"partition":r("partition")&&(n.code=o.defaults_partition_code,n.price_sqyd=o.defaults_partition_price_sqyd);break;case"pleated_screen":r("pleated_screen")&&(n.code=o.defaults_pleated_screen_code,n.price_sqyd=o.defaults_pleated_screen_price_sqyd);break;case"aluminum_blind":r("aluminum_blind")&&(n.code=o.defaults_aluminum_blind_code,n.price_sqyd=o.defaults_aluminum_blind_price_sqyd);break}let i;if(a==="set")i=Ce(n);else if(a==="wallpaper")i=Be(n);else if(O[a]?.templateId==="#areaBasedTpl")i=Ee(a,n);else{$(`ไม่รู้จักประเภทรายการ: ${a}`,"error");return}i&&(e.replaceWith(i),i.classList.add("item-created"),ve(i),i.querySelector('input:not([type="hidden"]), select, textarea')?.focus(),ae(),J(),$(`เพิ่ม ${O[a]?.name||"รายการ"} แล้ว`,"success"))}async function zt(e){if(!e||e.classList.contains("placeholder-item"))return;const a=e.dataset.type,s=await ct("เปลี่ยนประเภทรายการ",a);if(!s||s===a||!await re("ยืนยันการเปลี่ยนแปลง","ข้อมูลส่วนใหญ่ในรายการนี้จะถูกล้างและใช้ค่าเริ่มต้น (ถ้ามี) คุณแน่ใจหรือไม่?"))return;se(U()),te();const t={width_m:_(e.querySelector('input[name$="_width_m"], input[name="width_m"]')?.value),height_m:_(e.querySelector('input[name$="_height_m"], input[name="height_m"]')?.value)};a==="wallpaper"&&(t.height_m=_(e.querySelector(m.wallHeightInput)?.value));const o=e.closest(m.room),n=JSON.parse(o?.dataset.roomDefaults||"{}");let r={width_m:t.width_m>0?t.width_m:void 0,height_m:t.height_m>0?t.height_m:void 0};const i=d=>n[`enable_defaults_${d}`]===!0;switch(s){case"set":i("set")&&(r.fabric_code=n.defaults_fabric_code,r.price_per_m_raw=n.defaults_fabric_price,r.sheer_fabric_code=n.defaults_sheer_code,r.sheer_price_per_m=n.defaults_sheer_price);break;case"wallpaper":i("wallpaper")&&(r.wallpaper_code=n.defaults_wallpaper_code,r.price_per_roll=n.defaults_wallpaper_price_roll,r.install_cost_per_roll=n.defaults_wallpaper_install_cost),delete r.width_m,r.height_m=t.height_m>0?t.height_m:void 0;break;case"wooden_blind":i("wooden_blind")&&(r.code=n.defaults_wooden_blind_code,r.price_sqyd=n.defaults_wooden_blind_price_sqyd);break;case"roller_blind":i("roller_blind")&&(r.code=n.defaults_roller_blind_code,r.price_sqyd=n.defaults_roller_blind_price_sqyd);break;case"vertical_blind":i("vertical_blind")&&(r.code=n.defaults_vertical_blind_code,r.price_sqyd=n.defaults_vertical_blind_price_sqyd);break;case"partition":i("partition")&&(r.code=n.defaults_partition_code,r.price_sqyd=n.defaults_partition_price_sqyd);break;case"pleated_screen":i("pleated_screen")&&(r.code=n.defaults_pleated_screen_code,r.price_sqyd=n.defaults_pleated_screen_price_sqyd);break;case"aluminum_blind":i("aluminum_blind")&&(r.code=n.defaults_aluminum_blind_code,r.price_sqyd=n.defaults_aluminum_blind_price_sqyd);break}let l;if(s==="set")l=Ce(r);else if(s==="wallpaper")l=Be(r);else if(O[s]?.templateId==="#areaBasedTpl")l=Ee(s,r);else return;l&&(e.replaceWith(l),l.classList.add("item-created"),ve(l),l.querySelector('input:not([type="hidden"]), select, textarea')?.focus(),ae(),J(),$("เปลี่ยนประเภทรายการแล้ว","success"))}const J=qe(()=>{let e=0;document.querySelectorAll(m.room).forEach(d=>{let c=0,p=0;const u=d.classList.contains("is-suspended");if(u||(d.querySelectorAll(".item-card:not(.is-suspended):not(.placeholder-item)").forEach(f=>{const v=_(f.dataset.totalPrice);v>0&&(c+=v,p++)}),e+=c),typeof d.updateBrief=="function"){const f=d.querySelectorAll(".placeholder-item:not(.is-suspended)").length;if(u)d.updateBrief("(ระงับชั่วคราว)");else if(p>0){let v=`<span>${p}</span> &bull; ${B(c)} บาท`;f>0&&(v+=` (+${f} รอเลือก)`),d.updateBrief(v)}else f>0?d.updateBrief(`<span>${f}</span> รอเลือกประเภท`):d.updateBrief("<span>0</span> รายการ")}});const a=document.querySelector("#discount_type"),s=document.querySelector("#discount_value"),t=a?a.value:"amount",o=s?_(s.value):0;let n=0;o>0&&(n=t==="percent"?e*(o/100):o,n=Math.min(e,n));const r=e-n,i=document.querySelector("#grandTotal"),l=document.querySelector("#originalTotal");i&&(i.textContent=B(r)),l&&(n>0?(l.textContent=B(e),l.dataset.rawTotal=e,l.style.display="block"):(l.style.display="none",l.dataset.rawTotal="")),_e(),Z()},200);async function Ge(e,a=!1){if(!e){$("ข้อมูลสำหรับโหลดไม่ถูกต้อง","error");return}if(e.favorites)if(a){const d=document.querySelector("#favoritesConflictModal");if(d){const c=d.querySelector('input[name="fav_conflict_option"][value="merge"]');c&&(c.checked=!0);const p=await j("#favoritesConflictModal");if(!p||p.cancelled){$("ยกเลิกการนำเข้า","warning");return}const u=d.querySelector('input[name="fav_conflict_option"]:checked').value;let f=0;switch(u){case"overwrite":Ue(e.favorites)&&$("เขียนทับรายการโปรดสำเร็จ","success");break;case"merge":f=Oe(e.favorites),$(`รวมข้อมูลสำเร็จ (เพิ่ม ${f} รายการใหม่)`,"success");break;case"skip":$("ข้ามการนำเข้ารายการโปรด","default");break}}else Oe(e.favorites)}else Ue(e.favorites);const s=document.querySelector(m.roomsContainer);if(!s)return;s.innerHTML="";const t=document.querySelector("#customer_name"),o=document.querySelector("#customer_phone"),n=document.querySelector("#customer_address"),r=document.querySelector("#customerDetailsCard");t&&(t.value=e.customer_name||""),o&&(o.value=e.customer_phone||""),n&&(n.value=e.customer_address||""),r&&(r.open=e.customer_card_open??!0);const i=document.querySelector("#discount_type"),l=document.querySelector("#discount_value");if(e.discount&&i&&l?(i.value=e.discount.type||"amount",l.value=e.discount.value||0):i&&l&&(i.value="amount",l.value=0),!Array.isArray(e.rooms)){$("ไม่พบข้อมูลห้องในไฟล์","warning"),s.children.length===0&&he();return}for(const d of e.rooms){const c=nt(d);if(!c)continue;s.appendChild(c);const p=c.getItemsContainer();if(p&&Array.isArray(d.items))for(const u of d.items){let f;if(u.type==="placeholder"){const v=document.querySelector("#placeholderItemTpl");if(v){f=v.content.cloneNode(!0).firstElementChild,f.dataset.widthM=u.width_m||0,f.dataset.heightM=u.height_m||0;const h=f.querySelector("[data-placeholder-width]"),w=f.querySelector("[data-placeholder-height]");h&&(h.textContent=K(u.width_m)),w&&(w.textContent=K(u.height_m)),u.is_suspended&&f.classList.add("is-suspended")}else{console.warn("Placeholder template not found during load.");continue}}else if(u.type==="set")f=Ce(u);else if(u.type==="wallpaper")f=Be(u);else if(O[u.type]?.templateId==="#areaBasedTpl")f=Ee(u.type,u);else continue;f&&p.appendChild(f)}}ae(),Pe(),ne(),$e(),te(),J(),a&&$("นำเข้าข้อมูลฟอร์มสำเร็จ","success")}async function Zt(e,a){const s=document.querySelector(m.printableContent);if(!s||!e){$("ไม่พบข้อมูลสำหรับสร้างเอกสาร","error");return}const t=document.title;if(a==="direct"){$("กำลังสร้าง PDF...","default");let o;try{typeof window.html2pdf>"u"&&($("กำลังโหลดไลบรารี PDF...","default"),await Pt("https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js")),o=document.createElement("div"),o.style.position="fixed",o.style.left="-300mm",o.style.top="0",o.style.width="210mm",o.style.background="#fff",o.innerHTML=e,document.body.appendChild(o),await new Promise(r=>setTimeout(r,300));const n={margin:0,filename:`${t}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0,logging:!1,width:o.querySelector(".pdf-page")?.scrollWidth||794,windowWidth:o.querySelector(".pdf-page")?.scrollWidth||794},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}};await window.html2pdf().from(o).set(n).save(),$("ดาวน์โหลด PDF สำเร็จ","success")}catch(n){console.error("PDF Generation Error:",n),$("สร้าง PDF ล้มเหลว, โปรดลองวิธีที่ 2 (พิมพ์)","error")}finally{o&&document.body.contains(o)&&document.body.removeChild(o)}}else a==="print"&&(s.innerHTML=e,setTimeout(()=>{window.print(),setTimeout(()=>{s.innerHTML=""},1e3)},ft))}function eo(e){if(!e||!e.html){$("ไม่พบข้อมูลสำหรับสร้างไฟล์ HTML","error");return}try{const a=`<!DOCTYPE html><html lang="th"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>${e.fileName}</title><link rel="stylesheet" href="./src/styles/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/bold/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/fill/style.css"><style>body { background-color: #eee; } #printable-content { display: block !important; max-width: 210mm; margin: 10mm auto; } .pdf-page { border: 1px solid #ccc; box-shadow: 0 0 10px rgba(0,0,0,0.1); margin-bottom: 10mm; background: #fff; page-break-inside: avoid; } .pdf-page-content { padding: 12mm; } @media print { body { background-color: #fff; } #printable-content { max-width: 100%; margin: 0; } .pdf-page { border: none; box-shadow: none; margin-bottom: 0; page-break-after: always; } .pdf-page:last-child { page-break-after: avoid; } } i.ph { vertical-align: middle; }</style></head><body><div id="printable-content">${e.html}</div></body></html>`,s=new Blob([a],{type:"text/html;charset=utf-8"}),t=URL.createObjectURL(s),o=document.createElement("a");o.href=t,o.download=`${e.fileName}.html`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(t),$("ดาวน์โหลดไฟล์ HTML สำเร็จ","success")}catch(a){console.error("HTML Export Error:",a),$("สร้างไฟล์ HTML ล้มเหลว","error")}}function to(e){const{roomId:a,itemIndex:s}=e.dataset;if(!a||s===void 0)return;const t=document.getElementById("lookbookModal");t&&typeof t.closeModal=="function"&&t.closeModal({cancelled:!0});const o=document.getElementById(a);if(!o){$("ไม่พบห้องที่ต้องการ","error");return}const r=Array.from(o.querySelectorAll(".item-card:not(.item-hidden)"))[parseInt(s,10)];if(!r){$("ไม่พบรายการที่ต้องการ","error");return}o.open=!0,ne(),setTimeout(()=>{r.scrollIntoView({behavior:"smooth",block:"center"}),r.classList.add("scrolling-jump"),setTimeout(()=>r.classList.remove("scrolling-jump"),2500)},150)}function oo(e){if(!ce)return;const a=ce.closest("#roomDefaultsModal"),s=ce.closest(".item-card"),t=ce.closest("#forceApplyModal");let o=ce,n=null;const r=o.dataset.favoriteType,i=e.dataset.code,l=_(e.dataset.price);if(s){let p;r==="fabric"?p="set_price_per_m":r==="sheer"?p="sheer_price_per_m":r==="wallpaper"?p="wallpaper_price_roll":p="area_price_sqyd",n=s.querySelector(`[name="${p}"]`)}else if(a){const p=o.closest(".defaults-inputs-grid");if(p){let u;r==="fabric"?u="defaults_fabric_price":r==="sheer"?u="defaults_sheer_price":r==="wallpaper"?u="defaults_wallpaper_price_roll":r==="wooden_blind"?u="defaults_wooden_blind_price_sqyd":r==="roller_blind"?u="defaults_roller_blind_price_sqyd":r==="vertical_blind"?u="defaults_vertical_blind_price_sqyd":r==="partition"?u="defaults_partition_price_sqyd":r==="pleated_screen"?u="defaults_pleated_screen_price_sqyd":r==="aluminum_blind"&&(u="defaults_aluminum_blind_price_sqyd"),u&&(n=p.querySelector(`[name="${u}"]`))}}else t&&(n=t.querySelector('[name="force_apply_price"]'));const d=n;o.value=i,o.classList.add("input-highlight"),setTimeout(()=>{o&&o.classList.remove("input-highlight")},1200),d&&l>=0&&(d.tagName==="SELECT"?Array.from(d.options).some(p=>_(p.value)===l)?d.value=l:$(`ราคา ${B(l)} ไม่มีในตัวเลือก`,"warning"):d.value=l===0?"0":l>0?B(l):"",d.classList.add("input-highlight"),setTimeout(()=>{d&&d.classList.remove("input-highlight")},1200)),s?((d||o).dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0})),d&&d.matches('input[inputmode="numeric"]')&&d.dispatchEvent(new Event("blur",{bubbles:!0,cancelable:!0}))):(a||t)&&d&&d.matches('input[inputmode="numeric"]')&&d.dispatchEvent(new Event("blur",{bubbles:!0,cancelable:!0}));const c=document.querySelector("#favoritesModal");c&&typeof c.closeModal=="function"&&c.closeModal({cancelled:!1,applied:!0})}async function ro(e){if(!e||!e.dataset.favoriteType){console.warn("showFavoritesModal called without a valid input element or favorite type.");return}ce=e;const a=e.dataset.favoriteType;if(!a){$("โปรดเลือกประเภทรายการก่อน","warning");const v=e.closest("#forceApplyModal");v&&v.querySelector("#forceApplySelectTypeBtn")?.focus(),ce=null;return}const s=document.querySelector("#favoritesModal"),t=s.querySelector("#favoritesModalTitle"),o=s.querySelector("#favoritesModalBody"),n=s.querySelector("#favSearchInput"),r=s.querySelector('[data-act="manage-favorites"]'),i=document.querySelector("#favSelectorItemTpl");if(!s||!t||!o||!n||!r||!i){console.error("Missing elements for favorites modal");return}let l=O[a]?.name||a;a==="fabric"?l="ผ้าทึบ":a==="sheer"&&(l="ผ้าโปร่ง"),t.textContent=`เลือก '${M(l)}'`;const d=()=>{const y=de()[a]||[];y.length>0?o.innerHTML=y.map(h=>{let w="-";return h.price>=0&&(w=B(h.price)),i.innerHTML.replace(/{CODE}/g,M(h.code)).replace(/{PRICE}/g,w).replace(/{RAW_PRICE}/g,h.price)}).join(""):o.innerHTML='<p class="empty-state">ไม่มีรายการโปรดที่บันทึกไว้</p>',n.value=""};d();const c=()=>{const v=n.value.toLowerCase();o.querySelectorAll(".fav-selector-item").forEach(y=>{const h=y.dataset.code.toLowerCase();y.classList.toggle("is-hidden",!h.includes(v))})},p=v=>{const y=v.target.closest(".fav-selector-item");y&&oo(y)},u=async()=>{await dt(a),we&&d()},f=()=>{n.removeEventListener("input",c),o.removeEventListener("click",p),r&&(r.onclick=null)};n.addEventListener("input",c),o.addEventListener("click",p),r.onclick=u,await j("#favoritesModal",f)}function Te(e){const a=document.querySelector("#favManagerBody"),s=document.querySelector("#favManagerItemTpl"),o=de()[e]||[];if(!a||!s)return;o.length===0?a.innerHTML='<p class="empty-state">ไม่มีรายการโปรดที่บันทึกไว้</p>':a.innerHTML=o.map(i=>{let l="-";return i.price>=0&&(l=B(i.price)),s.innerHTML.replace(/{CODE}/g,M(i.code)).replace(/{PRICE}/g,l).replace(/{RAW_PRICE}/g,i.price)}).join(""),G=null;const n=document.querySelector('#favManagerModal [data-act="edit-selected-fav"]'),r=document.querySelector('#favManagerModal [data-act="del-selected-fav"]');n&&(n.disabled=!0),r&&(r.disabled=!0)}async function dt(e){const a=document.querySelector("#favManagerModal");if(!a||!e)return;let s=O[e]?.name||e;e==="fabric"?s="ผ้าทึบ":e==="sheer"&&(s="ผ้าโปร่ง"),a.dataset.currentType=e,we=!1,G=null,document.querySelector("#favManagerTitle").textContent=`จัดการ '${M(s)}'`,Te(e),await j("#favManagerModal")}function ao(e){if(!e||!e.matches(m.itemCard)||e.classList.contains("placeholder-item"))return null;const a=e.dataset.type;if(!a)return null;let s={type:a,is_suspended:e.classList.contains("is-suspended")};try{if(a==="set")Object.assign(s,{width_m:_(e.querySelector(m.setWidthInput)?.value),height_m:_(e.querySelector(m.setHeightInput)?.value),style:e.querySelector(m.setStyleSelect)?.value||"",fabric_variant:e.querySelector(m.setFabricVariantSelect)?.value||"",price_per_m_raw:_(e.querySelector(m.setPricePerMSelect)?.value),sheer_price_per_m:_(e.querySelector(m.setSheerPricePerMSelect)?.value),louis_price_per_m:_(e.querySelector('select[name="louis_price_per_m"]')?.value),fabric_code:e.querySelector(m.setFabricCodeInput)?.value||"",sheer_fabric_code:e.querySelector(m.setSheerCodeInput)?.value||"",opening_style:e.querySelector(m.setOpeningStyleSelect)?.value||"",adjustment_side:e.querySelector(m.setAdjustmentSideSelect)?.value||"ปรับขวา",track_color:e.querySelector('input[name="track_color"]')?.value||"ขาว",bracket_color:e.querySelector('input[name="bracket_color"]')?.value||"ขาว",finial_color:e.querySelector('input[name="finial_color"]')?.value||"ขาว",grommet_color:e.querySelector('input[name="grommet_color"]')?.value||"เงิน",louis_valance:e.querySelector('input[name="louis_valance"]')?.value||"กล่องหลุยส์",louis_tassels:e.querySelector('input[name="louis_tassels"]')?.value||"สีเข้ากับผ้า",notes:e.querySelector(m.setNotesInput)?.value||""});else if(a==="wallpaper"){const t=e.querySelector(m.wallInstallCostInput),o=t?t.value:"";let n;o==="0"?n=0:_(o)>0?n=_(o):n=void 0,Object.assign(s,{height_m:_(e.querySelector(m.wallHeightInput)?.value),wallpaper_code:e.querySelector(m.wallCodeInput)?.value||"",price_per_roll:_(e.querySelector(m.wallPriceRollInput)?.value),install_cost_per_roll:n,notes:e.querySelector(m.wallNotesInput)?.value||"",widths:Array.from(e.querySelectorAll(m.wallWidthInput)).map(r=>_(r.value))})}else e.matches(m.areaBasedItem)&&(Object.assign(s,{width_m:_(e.querySelector(m.areaWidthInput)?.value),height_m:_(e.querySelector(m.areaHeightInput)?.value),price_sqyd:_(e.querySelector(m.areaPriceSqydInput)?.value),code:e.querySelector(m.areaCodeInput)?.value||"",notes:e.querySelector(m.areaNotesInput)?.value||""}),(a==="partition"||a==="pleated_screen")&&(s.opening_style=e.querySelector('select[name="opening_style"]')?.value||"แยกกลาง"),["wooden_blind","roller_blind","vertical_blind","aluminum_blind"].includes(a)&&(s.adjustment_side=e.querySelector('select[name="adjustment_side"]')?.value||"ปรับขวา"));return s}catch(t){return console.error("Failed to extract item data:",t,e),null}}function no(e){if(!e)return;const a=e.closest(m.room);if(!a||!a.getItemsContainer())return;se(U()),te();let t;if(e.classList.contains("placeholder-item")){const o=document.querySelector("#placeholderItemTpl");if(o){t=o.content.cloneNode(!0).firstElementChild,t.dataset.widthM=e.dataset.widthM,t.dataset.heightM=e.dataset.heightM;const r=t.querySelector("[data-placeholder-width]"),i=t.querySelector("[data-placeholder-height]");r&&(r.textContent=K(e.dataset.widthM)),i&&(i.textContent=K(e.dataset.heightM)),e.classList.contains("is-suspended")&&t.classList.add("is-suspended")}else{$("ไม่พบ Template สำหรับ Placeholder","error");return}}else{const o=ao(e);if(!o){$("ไม่สามารถคัดลอกรายการได้","error");return}if(o.type==="set")t=Ce(o);else if(o.type==="wallpaper")t=Be(o);else if(O[o.type]?.templateId==="#areaBasedTpl")t=Ee(o.type,o);else{$("ไม่รู้จักประเภทรายการ","error");return}}if(t){if(e.after(t),t.classList.add("item-created"),!t.classList.contains("placeholder-item")){const o=e.querySelector(m.itemDetailsMore);o&&o.classList.contains("show")&&Me(t,!0)}ve(t),ae(),J(),$("คัดลอกรายการแล้ว","success")}}function so(){const e=document.querySelector(m.orderForm),a=document.querySelector(m.fileImporter),s=document.querySelector("#favImporter"),t=document.querySelector(m.menuDropdown),o=document.querySelector(m.quickNavDropdown),n=document.querySelector(m.menuBtn),r=document.querySelector(m.quickNavBtn);if(e){if(e.addEventListener("item-update",J),e.addEventListener("input",i=>{if(ee){i.preventDefault();return}if(i.target.closest("#customerInfo")&&Z(),i.target.matches(m.roomNameInput)){const d=i.target.closest(".room-card")?.querySelector("[data-room-name-display]");d&&(d.textContent=i.target.value||"ห้อง"),Pe(),$e(),qe(Z,300)()}i.target.matches('input[name$="_m"], input[name$="price_sqyd"], input[name$="price_roll"], input[name$="install_cost"]')&&J()}),e.addEventListener("change",i=>{if(ee){i.preventDefault();return}i.target.matches("select")&&J()}),e.addEventListener("blur",i=>{const l=i.target;l.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_install_cost"]')?l.name==="wallpaper_install_cost"&&_(l.value)===0?l.value="0":l.value=_(l.value)>0?B(_(l.value)):"":l.matches('input[name$="_m"], input[name^="wall_width_m"], input[name^="modal_"]')&&(l.value=K(l.value)),!l.closest(".modal-wrapper")&&l.matches('input:not([type="hidden"]), select, textarea')&&Z()},!0),e.addEventListener("focusin",i=>{const l=i.target;if(l.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_install_cost"]')&&(l.name==="wallpaper_install_cost"&&l.value==="0"||_(l.value)>0&&(l.value=_(l.value))),l.matches('input:not([type="hidden"]), select, textarea')){const d=document.querySelector(".main-header"),c=document.querySelector(".summary-footer"),p=d?d.offsetHeight+16:80,u=c?c.offsetHeight+16:100,f=window.innerHeight,v=l.getBoundingClientRect();if((v.top<p||v.bottom>f-u)&&!l.closest(".modal-wrapper")){const h=l.closest(".item-card, .room-card");h&&ve(h)}}},!0),e.addEventListener("keydown",i=>{if(ee){i.preventDefault();return}const l=i.target;if(i.key==="Enter"&&l.matches("input, select")&&!l.closest(".modal-wrapper"))i.preventDefault();else if(i.key==="Enter"&&l.closest("#dimensionEntryModal")){const d=l.closest("#dimensionEntryModal"),c=d.querySelectorAll(".dimension-input-row"),u=c[c.length-1].querySelector('input[name="modal_height_m"]');l===u&&(i.preventDefault(),d.querySelector("#dimensionEntryConfirm")?.click())}}),document.addEventListener("click",async i=>{i.target.closest(".menu-container")||(t?.classList.remove("show"),n?.setAttribute("aria-expanded","false"),o?.classList.remove("show"),r?.setAttribute("aria-expanded","false")),i.target.closest(".room-options-container")||document.querySelectorAll(".room-options-menu.show").forEach(p=>p.classList.remove("show"));const l=i.target.closest(".summary-tag[data-filter-type]");if(l&&l.closest("#overviewModal")){const p=l.dataset.filterType,u=l.textContent.trim().replace(/\s*\d+\s*$/,""),f=document.querySelector("#overviewModal");f&&typeof f.closeModal=="function"&&f.closeModal({cancelled:!0}),Nt(p,u);return}const d=i.target.closest(".fav-manager-item");if(d){const p=d.closest("#favManagerModal"),u=p?.querySelector(".fav-manager-item.is-selected");u&&u.classList.remove("is-selected"),u!==d?(d.classList.add("is-selected"),G={code:d.dataset.code,price:_(d.dataset.price)}):G=null,p&&(p.querySelector('[data-act="edit-selected-fav"]').disabled=!G,p.querySelector('[data-act="del-selected-fav"]').disabled=!G);return}const c=i.target.closest("[data-act]");if(c){const p=c.dataset.act,u=c.closest(".item-card"),f=c.closest(".room-card"),v=["toggle-more-details","collapse-room","show-discount-modal","show-suspended-items","clear-filter","close-modal","jump-to-item","manage-favorites","show-favorites"];if(ee&&!c.closest(".unlockable")&&!v.includes(p)){$("ฟอร์มถูกล็อคอยู่","warning");return}switch(["toggle-more-details","close-modal","collapse-room","remove-dimension-row"].includes(p)||i.preventDefault(),p!=="close-modal"&&i.stopPropagation(),p){case"show-discount-modal":Rt();break;case"show-suspended-items":Ne();break;case"clear-filter":lt();break;case"add-room":he();break;case"add-item":if(f){const y=document.querySelector("#dimensionEntryModal");if(y){const h=y.querySelector("#dimensionRowsContainer");h.innerHTML="";const w=tt();h.appendChild(w),w.querySelector('input[name="modal_width_m"]')?.focus();const T=await j("#dimensionEntryModal");if(T&&!T.cancelled){const E=[];if(h.querySelectorAll(".dimension-input-row").forEach(P=>{const F=P.querySelector('input[name="modal_width_m"]'),D=P.querySelector('input[name="modal_height_m"]'),Q=_(F.value),X=_(D.value);Q>0&&X>0&&E.push({width_m:Q,height_m:X})}),E.length>0){se(U()),te();let P=null;E.forEach(F=>{const D=Kt(F,f);P||(P=D)}),P&&(ae(),Z(),ve(P),$(`เพิ่ม ${E.length} รายการ (รอเลือกประเภท)`,"success"))}else $("ไม่มีขนาดที่ถูกต้องระบุ","warning")}}}break;case"add-dimension-row":{const y=document.querySelector("#dimensionRowsContainer");if(y){const h=tt();y.appendChild(h),h.querySelector('input[name="modal_width_m"]')?.focus(),y.scrollTop=y.scrollHeight}break}case"remove-dimension-row":{const y=c.closest(".dimension-input-row"),h=y?.parentElement;y&&h&&h.children.length>1&&y.remove();break}case"select-item-type":if(u&&u.classList.contains("placeholder-item")){const y={width_m:parseFloat(u.dataset.widthM||0),height_m:parseFloat(u.dataset.heightM||0)};if(y.width_m>0&&y.height_m>0){const h=await ct("เลือกประเภทสินค้า");h&&Xt(u,h,y)}else $("ขนาดไม่ถูกต้องบน Placeholder","error")}break;case"collapse-room":f&&(f.open=!1,setTimeout(()=>{ne(),Z()},50));break;case"toggle-room-menu":c.nextElementSibling?.classList.toggle("show");break;case"open-room-defaults":f&&(Ht(f),c.closest(".room-options-menu")?.classList.remove("show"));break;case"apply-room-defaults":Vt();break;case"open-force-apply-modal":jt();break;case"force-apply-defaults":Gt();break;case"toggle-suspend-room":f&&(f.classList.toggle("is-suspended"),c.closest(".room-options-menu")?.classList.remove("show"),J(),ye==="suspended"?Ne():_e());break;case"clear-room":f&&await re("ล้างข้อมูลในห้อง","?")&&(se(U()),te(),f.getItemsContainer().innerHTML="",ae(),J(),$("ล้างแล้ว","success"));break;case"del-room":f&&await re("ลบห้อง","?")&&Fe(f,"ลบแล้ว");break;case"del-item":u&&await re("ลบรายการ","?")&&Fe(u,"ลบแล้ว");break;case"duplicate-item":u&&no(u);break;case"toggle-suspend":u&&(u.classList.toggle("is-suspended"),J(),ye==="suspended"?Ne():_e());break;case"change-type":u&&zt(u);break;case"toggle-more-details":u&&!u.querySelector(".item-details-more")?.classList.contains("show")&&document.querySelectorAll(".item-details-more.show").forEach(y=>{y.closest(".item-card")!==u&&Me(y.closest(".item-card"),!1)}),Me(u);break;case"open-hardware-modal":H=u,H&&Ot();break;case"apply-hardware-to-room":{const y=c.closest("#hardwareModal"),h=H?.closest(m.room);if(!y||!h||!H)break;const w=H.querySelector('[name="set_style"]');if(w?.value==="ม่านพับ"||w?.value==="หลุยส์"){$("ไม่สามารถใช้กับม่านพับหรือม่านหลุยส์ได้","warning");break}const T=y.querySelector('[name="modal_track_color"]').value,E=y.querySelector('[name="modal_bracket_color"]').value,P=y.querySelector('[name="modal_finial_color"]').value,F=y.querySelector('[name="modal_grommet_color"]').value;h.querySelectorAll('.set-item:not(:has(select[name="set_style"][value="ม่านพับ"])):not(:has(select[name="set_style"][value="หลุยส์"]))').forEach(D=>{D.querySelector('[name="track_color"]').value=T,D.querySelector('[name="bracket_color"]').value=E,D.querySelector('select[name="set_style"]')?.value==="ตาไก่"&&(D.querySelector('[name="finial_color"]').value=P,D.querySelector('[name="grommet_color"]').value=F)}),Z(),$("ใช้กับรายการที่เข้ากันได้ในห้องแล้ว","success");break}case"add-wall":{const y=c.closest(".walls-section")?.querySelector("[data-walls-container]");if(y){const h=He();h&&(y.appendChild(h),h.querySelector("input")?.focus(),J())}break}case"del-wall":{const y=c.closest(".wall-input-row");y&&await re("ลบผนัง","?")&&Fe(y,"ลบแล้ว");break}case"show-favorites":{const y=c.previousElementSibling?.matches("input[data-favorite-type]")?c.previousElementSibling:c.closest(".form-group-with-favorites")?.querySelector("input[data-favorite-type]");y?ro(y):console.warn("Could not find associated input for show-favorites button:",c);break}case"add-new-fav-form":{const h=c.closest("#favManagerModal")?.dataset.currentType;if(!h)break;const w=document.querySelector("#favAddModal");if(!w)break;let T=O[h]?.name||h;h==="fabric"?T="ผ้าทึบ":h==="sheer"&&(T="ผ้าโปร่ง"),w.querySelector("h3").textContent=`เพิ่ม '${T}'`;const E=w.querySelector('[name="fav_code_add"]'),P=w.querySelector('[name="fav_price_add"]');E.value="",P.value="";const F=await j("#favAddModal");if(F&&!F.cancelled){const D=E.value.trim(),Q=_(P.value);D&&Q>=0?Je(h,D,Q)?(we=!0,Te(h),$("เพิ่มแล้ว","success")):$("ล้มเหลว","error"):$(D?"ราคาต้องไม่ติดลบ":"ต้องระบุรหัส","warning")}break}case"edit-selected-fav":{if(!G)break;const h=c.closest("#favManagerModal")?.dataset.currentType;if(!h)break;const w=document.querySelector("#favEditModal");if(!w)break;w.querySelector("h3").textContent=`แก้ไข '${G.code}'`;const T=w.querySelector('[name="fav_code_edit"]'),E=w.querySelector('[name="fav_price_edit"]');T.value=G.code,E.value=G.price!==null&&G.price>=0?G.price:"";const P=await j("#favEditModal");if(P&&!P.cancelled){const F=T.value.trim(),D=_(E.value);F&&D>=0?(F!==G.code&&Ye(h,G.code),Je(h,F,D),we=!0,Te(h),$("แก้ไขรายการโปรดแล้ว","success")):$(F?"ราคาต้องไม่ติดลบ":"ต้องระบุรหัส","warning")}break}case"del-selected-fav":{if(!G)break;const h=c.closest("#favManagerModal")?.dataset.currentType;if(!h)break;await re("ลบรายการโปรด",`"${G.code}"?`)&&(Ye(h,G.code)?(we=!0,Te(h),$("ลบแล้ว","success")):$("ล้มเหลว","error"));break}case"manage-favorites-from-defaults":await Ut();break;case"jump-to-item":to(c);break}}else{const p=i.target.closest("summary");p&&p.closest("details.card")&&setTimeout(()=>{ne(),Z()},50)}}),document.querySelector("#undoBtn")?.addEventListener("click",i=>{i.preventDefault(),Dt()}),document.querySelector(m.lockBtn)?.addEventListener("click",i=>{i.preventDefault(),Yt()}),document.querySelector(m.toggleAllRoomsBtn)?.addEventListener("click",i=>{i.preventDefault(),Qt()}),r&&o){r.addEventListener("click",l=>{l.stopPropagation(),t?.classList.remove("show");const d=!o.classList.contains("show");o.classList.toggle("show",d),r.setAttribute("aria-expanded",d),d&&n?.setAttribute("aria-expanded","false")}),document.querySelector(m.quickNavRoomList)?.addEventListener("click",l=>{const d=l.target.closest("a[data-jump-to]");if(d){l.preventDefault();const c=d.dataset.jumpTo,p=document.getElementById(c);p&&(p.open=!0,p.scrollIntoView({behavior:"smooth",block:"center"}),p.classList.add("scrolling-jump"),setTimeout(()=>p.classList.remove("scrolling-jump"),2500),setTimeout(ne,100)),o.classList.remove("show"),r.setAttribute("aria-expanded","false")}});const i=document.querySelector("#addRoomQuickNavBtn");if(i){const l=yt(he,700);i.addEventListener("click",d=>{d.stopPropagation(),l(),o.classList.remove("show"),r.setAttribute("aria-expanded","false")})}}n&&t&&n.addEventListener("click",i=>{i.stopPropagation(),o?.classList.remove("show");const l=!t.classList.contains("show");t.classList.toggle("show",l),n.setAttribute("aria-expanded",l),l&&r?.setAttribute("aria-expanded","false")}),document.querySelector("#themeToggleBtn")?.addEventListener("click",i=>{i.preventDefault(),At(),t?.classList.remove("show"),n?.setAttribute("aria-expanded","false")}),document.querySelector("#overviewBtn")?.addEventListener("click",async i=>{i.preventDefault(),t?.classList.remove("show"),n?.setAttribute("aria-expanded","false");const l=U(),d=document.querySelector("#overviewModalHeader"),c=document.querySelector("#overviewModalBody");if(d&&c){const p=l.rooms.reduce((v,y)=>v+(y.is_suspended?0:(y.items||[]).filter(h=>!h.is_placeholder&&!h.is_suspended&&(A.calculateSetPrice(h)?.total>0||A.calculateWallpaperPrice(h)?.total>0||A.calculateAreaBasedPrice(h)?.total>0)).length),0),u=document.querySelector(m.grandTotal)?.textContent||"0",f=l.rooms.filter(v=>!v.is_suspended&&v.items?.some(y=>!y.is_suspended)).length;d.innerHTML=`<div class="overview-stats-grid"><div class="overview-stat-card"><i class="ph-bold ph-map-pin-line"></i><div class="stat-value">${f}</div><div class="stat-label">ห้อง</div></div><div class="overview-stat-card"><i class="ph-bold ph-stack"></i><div class="stat-value">${p}</div><div class="stat-label">รายการ</div></div><div class="overview-stat-card"><i class="ph-bold ph-coins"></i><div class="stat-value">${u}</div><div class="stat-label">ยอดรวม</div></div></div>`,c.innerHTML=Ct(l),j("#overviewModal")}}),document.querySelector("#copyTextBtn")?.addEventListener("click",async i=>{i.preventDefault(),t?.classList.remove("show"),n?.setAttribute("aria-expanded","false");const l=document.querySelector(m.copyOptionsModal);if(!l)return;l.querySelector('input[name="copy_option"][value="customer"]').checked=!0;const d=await j(m.copyOptionsModal);if(d&&!d.cancelled){const c=l.querySelector('input[name="copy_option"]:checked').value,p=Lt(U(),c);try{await navigator.clipboard.writeText(p),$("คัดลอกสำเร็จ!","success")}catch{$("คัดลอกล้มเหลว","error")}}}),document.querySelector("#visualReportsBtn")?.addEventListener("click",async i=>{i.preventDefault(),t?.classList.remove("show"),n?.setAttribute("aria-expanded","false");const l=document.querySelector("#visualReportsModal");if(!l)return;l.querySelector('input[name="report_type_option"][value="lookbook"]').checked=!0;const d=await j("#visualReportsModal");if(d&&!d.cancelled){const c=l.querySelector('input[name="report_type_option"]:checked').value;if(c==="lookbook"){const p=U(),u=Et(p),f=document.querySelector("#lookbookModalBody");u&&f?(f.innerHTML=u,j("#lookbookModal")):$("ไม่มีข้อมูล","warning")}else $(`'${c}' ยังไม่พร้อม`,"default")}}),document.querySelector(m.exportPdfBtn)?.addEventListener("click",async i=>{i.preventDefault(),t?.classList.remove("show"),n?.setAttribute("aria-expanded","false");const l=await Ft();if(!l)return;const d=U(),c=Bt(d,{vatRate:l.vatOption==="include"?V.baseVatRate:0,pageBreakBuffer:l.pageBreakBuffer,showDetails:l.showDetails});if(!c){$("ไม่มีรายการ","warning");return}l.exportMethod==="html"?eo(c):Zt(c.html,l.exportMethod)}),document.querySelector(m.submitBtn)?.addEventListener("click",async i=>{if(i.preventDefault(),t?.classList.remove("show"),n?.setAttribute("aria-expanded","false"),await re("ส่งข้อมูล","?")){const l=U();if(!l.customer_name&&!l.customer_phone){$("ใส่ชื่อ/เบอร์","warning");return}$("กำลังส่ง...","default");try{const d=await fetch(pt,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)});d.ok?$("ส่งแล้ว!","success"):$(`ล้มเหลว: ${d.status}`,"error")}catch{$("เชื่อมต่อผิดพลาด","error")}}}),document.querySelector(m.importBtn)?.addEventListener("click",i=>{i.preventDefault(),t?.classList.remove("show"),n?.setAttribute("aria-expanded","false"),a?.click()}),a?.addEventListener("change",i=>{const l=i.target.files?.[0];if(!l)return;const d=new FileReader;d.onload=async c=>{try{const p=JSON.parse(c.target.result);if(p&&typeof p=="object")await Ge(p,!0);else throw new Error("Invalid JSON")}catch(p){$("ไฟล์ JSON ไม่ถูก","error"),console.error(p)}},d.readAsText(l),i.target.value=null}),document.querySelector(m.exportBtn)?.addEventListener("click",i=>{i.preventDefault(),t?.classList.remove("show"),n?.setAttribute("aria-expanded","false");try{const l=U(),d=JSON.stringify(l,null,4),c=new Blob([d],{type:"application/json"}),p=URL.createObjectURL(c),u=document.createElement("a"),f=new Date,v=`${f.getFullYear()}${(f.getMonth()+1).toString().padStart(2,"0")}${f.getDate().toString().padStart(2,"0")}`,y=`${f.getHours().toString().padStart(2,"0")}${f.getMinutes().toString().padStart(2,"0")}`,h=ot(l.customer_name||"data");u.href=p,u.download=`MTR-${v}${y}-${h}.json`,u.click(),URL.revokeObjectURL(p),$("Export สำเร็จ","success")}catch{$("Export ล้มเหลว","error")}}),document.querySelector("#importFavsBtn")?.addEventListener("click",i=>{i.preventDefault(),t?.classList.remove("show"),n?.setAttribute("aria-expanded","false"),s?.click()}),s?.addEventListener("change",i=>{const l=i.target.files?.[0];if(!l)return;const d=new FileReader;d.onload=c=>{try{const p=JSON.parse(c.target.result),u=Oe(p);u>0?$(`เพิ่ม ${u} รายการ`,"success"):$("ไม่พบรายการใหม่","default")}catch{$("ไฟล์ JSON ไม่ถูก","error")}},d.readAsText(l),i.target.value=null}),document.querySelector("#exportFavsBtn")?.addEventListener("click",i=>{i.preventDefault(),t?.classList.remove("show"),n?.setAttribute("aria-expanded","false");try{const l=de();if(Object.values(l).every(v=>v.length===0)){$("ไม่มีรายการ","warning");return}const d=JSON.stringify(l,null,4),c=new Blob([d],{type:"application/json"}),p=URL.createObjectURL(c),u=document.createElement("a"),f=new Date().toISOString().slice(0,10).replace(/-/g,"");u.href=p,u.download=`MTR-Favorites-${f}.json`,u.click(),URL.revokeObjectURL(p),$("Export สำเร็จ","success")}catch{$("Export ล้มเหลว","error")}}),document.querySelector(m.clearItemsBtn)?.addEventListener("click",async i=>{if(i.preventDefault(),t?.classList.remove("show"),n?.setAttribute("aria-expanded","false"),await re("ล้างทุกรายการ","?")){se(U()),te(),document.querySelectorAll(m.room).forEach(c=>{c.getItemsContainer().innerHTML=""});const l=document.querySelector("#discount_type"),d=document.querySelector("#discount_value");l&&(l.value="amount"),d&&(d.value="0"),ae(),J(),$("ล้างแล้ว","success")}}),document.querySelector(m.clearAllBtn)?.addEventListener("click",async i=>{if(i.preventDefault(),t?.classList.remove("show"),n?.setAttribute("aria-expanded","false"),await re("ลบข้อมูลทั้งหมด","คำเตือน! ข้อมูลทั้งหมดรวมถึงรายการโปรดจะถูกลบถาวร ยืนยันหรือไม่?")){const l=document.querySelector(m.roomsContainer);l&&(l.innerHTML=""),localStorage.removeItem(ge),vt(),$("ลบข้อมูลทั้งหมดแล้ว กำลังรีโหลด...","success"),setTimeout(()=>window.location.reload(),500)}}),document.querySelector("#roomDefaultsConfirmBtn")?.addEventListener("click",Wt),window.addEventListener("click",i=>{i.target.closest(".menu-container")||(t?.classList.remove("show"),o?.classList.remove("show"),n?.setAttribute("aria-expanded","false"),r?.setAttribute("aria-expanded","false")),i.target.closest(".room-options-container")||document.querySelectorAll(".room-options-menu.show").forEach(d=>d.classList.remove("show"));const l=i.target.closest(".item-card");document.querySelectorAll(".item-details-more.show").forEach(d=>{const c=d.closest(".item-card");c!==l&&Me(c,!1)})}),window.addEventListener("beforeunload",Z),document.querySelector("#forceApplySelectTypeBtn")?.addEventListener("click",async i=>{if(i.preventDefault(),ee){$("ฟอร์มถูกล็อคอยู่","warning");return}const l=document.querySelector("#forceApplyTypeModal");if(!l)return;const d=document.querySelector('#forceApplyModal [name="force_apply_type_hidden"]')?.value;let c=l.querySelector(`input[name="force_apply_type_option"][value="${d}"]`);c||(c=l.querySelector('input[name="force_apply_type_option"]')),c&&(c.checked=!0);const p=await j("#forceApplyTypeModal");if(p&&!p.cancelled){const u=l.querySelector('input[name="force_apply_type_option"]:checked');if(u){const f=u.value,v=document.querySelector("#forceApplyModal"),y=v?.querySelector('[name="force_apply_type_hidden"]'),h=v?.querySelector("#forceApplySelectedTypeDisplay"),w=v?.querySelector('[name="force_apply_code"]'),T=w?.closest(".form-group-with-favorites")?.querySelector(".btn-show-favs"),E=u.closest("label")?.querySelector("strong"),P=E?E.textContent.trim():f;y&&(y.value=f),h&&(h.textContent=P),w&&(w.dataset.favoriteType=f,w.focus()),T&&(T.disabled=!1)}}})}}function lo(){const e=document.querySelector(m.setTpl);if(!e)return;const a=e.content.querySelector(m.setPricePerMSelect),s=e.content.querySelector(m.setSheerPricePerMSelect),t=e.content.querySelector(m.setLouisPricePerMSelect),o=n=>{let r='<option value="" hidden>เลือกราคา</option>';return Array.isArray(n)?(n.forEach(i=>{r+=`<option value="${i}">${i.toLocaleString("th-TH")}</option>`}),r):(console.error("Price data for dropdown is not available or not an array.",n),r)};a&&(a.innerHTML=o(be.fabric)),s&&(s.innerHTML=o(be.sheer)),t&&(t.innerHTML=o(be.louis))}function io(){lo(),st(),so();try{const e=localStorage.getItem(ge);if(e&&e!=="null"&&e!=="{}"){const a=JSON.parse(e);if(a&&Array.isArray(a.rooms))Ge(a,!1);else{console.warn("Stored data structure seems invalid, starting fresh."),localStorage.removeItem(ge),he();const s=document.querySelector(m.customerCard);s&&(s.open=!0)}}else{he();const a=document.querySelector(m.customerCard);a&&(a.open=!0)}}catch(e){console.error("Failed to load or parse data from localStorage:",e),localStorage.removeItem(ge),he();const a=document.querySelector(m.customerCard);a&&(a.open=!0)}J(),it(),ne(),$e(),te(),console.log("Marnthara App Initialized (Vite Refactor)")}document.addEventListener("DOMContentLoaded",io);
