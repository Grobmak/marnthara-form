(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function o(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(s){if(s.ep)return;s.ep=!0;const r=o(s);fetch(s.href,r)}})();const Ze="input-ui/5.7.0",et="https://your-make-webhook-url.com/your-unique-path",he="marnthara.input.v5",tt=500,M={name:"ม่านธารา ผ้าม่านและของตกแต่ง",address:"65/8 หมู่ 2 ต.ท่าศาลา อ.เมือง จ.ลพบุรี 15000",phone:"092-985-9395, 082-552-5595",taxId:"1234567890123",logoUrl:"./assets/logo.png",baseVatRate:.07,pdf:{paymentTerms:"ชำระมัดจำ 50%",priceValidity:"30 วัน",notes:["ราคานี้รวมค่าติดตั้งแล้ว","ชำระมัดจำ 50% เพื่อยืนยันการสั่งผลิตสินค้า","ใบเสนอราคานี้มีอายุ 30 วัน นับจากวันที่เสนอราคา"]}},rt=1.19599,$e={ROLL_WIDTH_M:.53,ROLL_LENGTH_M:10,STRIPS_PER_ROLL_UNDER_2_5M:3},_e={fabric:[1e3,1100,1200,1300,1400,1500,1600,1700,1800,1900,2e3,2100,2200],sheer:[1e3,1100,1200,1300,1400,1500],style_surcharge:{ลอน:200,ตาไก่:0,จีบ:0},height:[{threshold:3.2,add_per_m:300},{threshold:2.8,add_per_m:200},{threshold:2.5,add_per_m:100}]},h={orderForm:"#orderForm",roomsContainer:"#rooms",setTpl:"#setTpl",wallTpl:"#wallTpl",clearAllBtn:"#clearAllBtn",lockBtn:"#lockBtn",grandTotal:"#grandTotal",modal:"#confirmationModal",modalTitle:"#modalTitle",modalBody:"#modalBody",room:"[data-room]",allItemsContainer:"[data-all-items]",wallsContainer:"[data-walls-container]",sheerWrap:"[data-sheer-wrap]",sheerCodeWrap:"[data-sheer-code-wrap]",roomNameInput:'input[name="room_name"]',toastContainer:"#toast-container",copyTextBtn:"#copyTextBtn",copyOptionsModal:"#copyOptionsModal",menuBtn:"#menuBtn",menuDropdown:"#menuDropdown",importBtn:"#importBtn",exportBtn:"#exportBtn",fileImporter:"#fileImporter",submitBtn:"#submitBtn",clearItemsBtn:"#clearItemsBtn",exportPdfBtn:"#exportPdfBtn",exportOptionsModal:"#exportOptionsModal",printableContent:"#printable-content",quickNavBtn:"#quickNavBtn",quickNavDropdown:"#quickNavDropdown",quickNavRoomList:"#quickNavRoomList",toggleAllRoomsBtn:"#toggleAllRoomsBtn"},g=e=>{typeof e=="string"&&(e=e.replace(/,/g,""));const t=parseFloat(e);return Number.isFinite(t)?t:0},X=e=>{const t=g(e);return t>0?t.toFixed(2):""},j=(e,t=2,o=!1)=>Number.isFinite(e)?e.toLocaleString("en-US",{minimumFractionDigits:o?2:t,maximumFractionDigits:o?2:t}):"0",L=(e,t=0)=>Number.isFinite(e)?e.toLocaleString("th-TH",{minimumFractionDigits:t,maximumFractionDigits:t}):"0",ot=(e,t=150)=>{let o;return(...n)=>{clearTimeout(o),o=setTimeout(()=>e(...n),t)}},at=(e,t=700)=>{let o=!1;return(...n)=>{if(!o){o=!0;try{return e(...n)}finally{setTimeout(()=>{o=!1},t)}}}},S=e=>typeof e!="string"?"":e.replace(/[&<>"']/g,function(t){switch(t){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";default:return"&#039;"}}),ae=e=>typeof e!="string"?"":e.replace(/[\\/?%*:|"<>\x00-\x1f]/g,"").trim()||"file";function nt(e){let t=g(e);if(isNaN(t))return"ข้อมูลตัวเลขไม่ถูกต้อง";if(t===0)return"ศูนย์บาทถ้วน";const o=["","หนึ่ง","สอง","สาม","สี่","ห้า","หก","เจ็ด","แปด","เก้า"],n=["","สิบ","ร้อย","พัน","หมื่น","แสน","ล้าน"];let s=Math.floor(t),r=Math.round((t-s)*100);const a=c=>{if(c===0)return"";let i="";const f=String(c);for(let m=0;m<f.length;m++){const y=f[m];f.length-1;const v=f.length-m-1;y!=="0"&&(v===1&&y==="1"?i+=n[v]:v===1&&y==="2"?i+="ยี่"+n[v]:v===0&&y==="1"&&f.length>1?i+="เอ็ด":i+=o[parseInt(y)]+n[v])}return i};let l="";if(s>0){const c=Math.floor(s/1e6),i=s%1e6;c>0&&(l+=a(c)+"ล้าน"),l+=a(i),l+="บาท"}let u="";return r>0?u=a(r)+"สตางค์":l+="ถ้วน",(l+u).trim()}const Be="marnthara.favorites.v4",ve={fabric:[],sheer:[],wallpaper:[],wooden_blind:[],roller_blind:[],vertical_blind:[],partition:[],pleated_screen:[],aluminum_blind:[]};function K(){try{const e=localStorage.getItem(Be);return e?{...ve,...JSON.parse(e)}:ve}catch(e){return console.error("Failed to parse favorites from localStorage",e),ve}}function be(e){try{localStorage.setItem(Be,JSON.stringify(e))}catch(t){console.error("Failed to save favorites to localStorage",t)}}function je(e){if(!e||typeof e!="object")return console.error("Invalid favorites data for import."),!1;const t={...ve,...e};return be(t),!0}function Ve(e){if(!e||typeof e!="object")return console.error("Invalid favorites data for merge."),0;const t=K();let o=0;for(const n in e)Object.hasOwnProperty.call(e,n)&&Array.isArray(e[n])&&(t[n]||(t[n]=[]),e[n].forEach(s=>{!t[n].some(a=>a.code===s.code)&&s.code&&(t[n].push(s),o++)}),t[n].sort((s,r)=>s.code.localeCompare(r.code)));return o>0&&be(t),o}function st(e,t,o){const n=K();n[e]||(n[e]=[]);const s=n[e],r=s.find(a=>a.code===t);return r?r.price=o:s.push({code:t,price:o}),s.sort((a,l)=>a.code.localeCompare(l.code)),be(n),!0}function Ee(e,t){const o=K();if(!o[e])return!1;const n=o[e].findIndex(s=>s.code===t);return n>-1?(o[e].splice(n,1),be(o),!0):!1}function Ne(e,t){if(!e||!t)return;const o=K(),n=t.trim();return(o[e]||[]).find(r=>r.code===n)}function lt(e,t){return!!Ne(e,t)}function ke(e,t,o){const n=Ne(e,t);return n&&n.price===o?(Ee(e,t),!1):(st(e,t,o),!0)}function ct(){localStorage.removeItem(Be),console.log("All favorites have been cleared.")}function R(){var o,n,s,r,a,l;const e=K(),t={app_version:Ze,customer_name:((o=document.querySelector('[name="customer_name"]'))==null?void 0:o.value)||"",customer_phone:((n=document.querySelector('[name="customer_phone"]'))==null?void 0:n.value)||"",customer_address:((s=document.querySelector('[name="customer_address"]'))==null?void 0:s.value)||"",customer_card_open:(r=document.querySelector("#customerDetailsCard"))==null?void 0:r.open,discount:{type:((a=document.querySelector("#discount_type"))==null?void 0:a.value)||"amount",value:g((l=document.querySelector("#discount_value"))==null?void 0:l.value)},rooms:[],favorites:e};return document.querySelectorAll(h.room).forEach(u=>{var i,f;const c={id:u.id,room_name:((i=u.querySelector(h.roomNameInput))==null?void 0:i.value)||"",is_suspended:u.classList.contains("is-suspended"),is_open:u.open,items:[]};(f=u.querySelector(h.allItemsContainer))==null||f.childNodes.forEach(m=>{var d,p,_,w,k,$,b,x,C,A,F,T,I,N,W,O,V,Q,re,H,pe,Oe,Re,He;if(m.nodeType!==1||!m.matches(".item-card"))return;const y=m.dataset.type;if(!y)return;let v={type:y,is_suspended:m.classList.contains("is-suspended")};y==="set"?Object.assign(v,{width_m:g((d=m.querySelector('input[name="width_m"]'))==null?void 0:d.value),height_m:g((p=m.querySelector('input[name="height_m"]'))==null?void 0:p.value),style:((_=m.querySelector('select[name="set_style"]'))==null?void 0:_.value)||"",fabric_variant:((w=m.querySelector('select[name="fabric_variant"]'))==null?void 0:w.value)||"",price_per_m_raw:g((k=m.querySelector('select[name="set_price_per_m"]'))==null?void 0:k.value),sheer_price_per_m:g(($=m.querySelector('select[name="sheer_price_per_m"]'))==null?void 0:$.value),fabric_code:((b=m.querySelector('input[name="fabric_code"]'))==null?void 0:b.value)||"",sheer_fabric_code:((x=m.querySelector('input[name="sheer_fabric_code"]'))==null?void 0:x.value)||"",opening_style:((C=m.querySelector('select[name="opening_style"]'))==null?void 0:C.value)||"",track_color:((A=m.querySelector('input[name="track_color"]'))==null?void 0:A.value)||"ขาว",bracket_color:((F=m.querySelector('input[name="bracket_color"]'))==null?void 0:F.value)||"ขาว",finial_color:((T=m.querySelector('input[name="finial_color"]'))==null?void 0:T.value)||"ขาว",grommet_color:((I=m.querySelector('input[name="grommet_color"]'))==null?void 0:I.value)||"เงิน",notes:((N=m.querySelector('input[name="notes"]'))==null?void 0:N.value)||""}):y==="wallpaper"?Object.assign(v,{height_m:g((W=m.querySelector('[name="wallpaper_height_m"]'))==null?void 0:W.value),wallpaper_code:((O=m.querySelector('[name="wallpaper_code"]'))==null?void 0:O.value)||"",price_per_roll:g((V=m.querySelector('[name="wallpaper_price_roll"]'))==null?void 0:V.value),install_cost_per_roll:g((Q=m.querySelector('[name="wallpaper_install_cost"]'))==null?void 0:Q.value),notes:((re=m.querySelector('[name="wallpaper_notes"]'))==null?void 0:re.value)||"",widths:Array.from(m.querySelectorAll('[name="wall_width_m"]')).map(Xe=>g(Xe.value))}):m.matches(".area-based-item")&&Object.assign(v,{width_m:g((H=m.querySelector('[name="area_width_m"]'))==null?void 0:H.value),height_m:g((pe=m.querySelector('[name="area_height_m"]'))==null?void 0:pe.value),price_sqyd:g((Oe=m.querySelector('[name="area_price_sqyd"]'))==null?void 0:Oe.value),code:((Re=m.querySelector('[name="area_code"]'))==null?void 0:Re.value)||"",notes:((He=m.querySelector('[name="area_notes"]'))==null?void 0:He.value)||""}),c.items.push(v)}),t.rooms.push(c)}),t}function B(){try{localStorage.setItem(he,JSON.stringify(R()))}catch(e){console.error("Failed to save data to localStorage:",e)}}const E={stylePlus:e=>_e.style_surcharge[e]??0,heightPlus:e=>{const t=[..._e.height].sort((o,n)=>n.threshold-o.threshold);for(const o of t)if(e>o.threshold)return o.add_per_m;return 0},fabricYardage:(e,t)=>{const o=g(t);return o<=0||!e?0:e==="ตาไก่"||e==="จีบ"?(o*2+.6)/.9:e==="ลอน"?(o*2.6+.6)/.9:0},calculateGrommets:e=>{const t=g(e);if(t<=0)return 0;const s=Math.ceil(t/.3)*.3/.15;return Math.round(s)},wallpaperRolls:(e,t)=>{const o=g(e),n=g(t);if(o<=0||n<=0)return 0;const s=n>2.5?Math.floor($e.ROLL_LENGTH_M/n):$e.STRIPS_PER_ROLL_UNDER_2_5M;if(s<=0)return 0;const r=Math.ceil(o/$e.ROLL_WIDTH_M);return Math.ceil(r/s)},calculateSetPrice:function(e){var a,l;if(!e||e.is_suspended||g(e.width_m)<=0)return{total:0,opaque:0,sheer:0};const t=this.stylePlus(e.style),o=this.heightPlus(g(e.height_m)),n=g(e.width_m),s=(a=e.fabric_variant)!=null&&a.includes("ทึบ")&&g(e.price_per_m_raw)>0?(g(e.price_per_m_raw)+t+o)*n:0,r=(l=e.fabric_variant)!=null&&l.includes("โปร่ง")&&g(e.sheer_price_per_m)>0?(g(e.sheer_price_per_m)+t+o)*n:0;return{total:Math.round(s+r),opaque:Math.round(s),sheer:Math.round(r)}},calculateDecoPrice:function(e){if(!e||e.is_suspended||g(e.width_m)<=0||g(e.height_m)<=0)return{total:0,sqm:0,sqyd:0};const t=g(e.width_m)*g(e.height_m),o=t*rt,n=o*g(e.price_sqyd);return{total:Math.round(n),sqm:t,sqyd:o}},calculateWallpaperPrice:function(e){var a;if(!e||e.is_suspended)return{total:0,material:0,install:0,rolls:0,sqm:0};const t=((a=e.widths)==null?void 0:a.reduce((l,u)=>l+g(u),0))||0;if(t<=0)return{total:0,material:0,install:0,rolls:0,sqm:0};const o=g(e.height_m),n=this.wallpaperRolls(t,o),s=n*g(e.price_per_roll),r=n*g(e.install_cost_per_roll??300);return{total:Math.round(s+r),material:Math.round(s),install:Math.round(r),rolls:n,sqm:t*o}}},Z={set:"ผ้าม่าน",wallpaper:"วอลล์เปเปอร์",wooden_blind:"มู่ลี่ไม้",roller_blind:"ม่านม้วน",vertical_blind:"ม่านปรับแสง",partition:"ฉากกั้นห้อง",pleated_screen:"มุ้งจีบ",aluminum_blind:"มู่ลี่อลูมิเนียม"};function De(e){let t=`
📃 *สรุปรายการสินค้า*
`,o=!1;return e.rooms.forEach(n=>{if(n.is_suspended||!n.items)return;const s=n.items.filter(a=>a.is_suspended?!1:a.type==="wallpaper"?(a.widths||[]).reduce((l,u)=>l+u,0)>0:a.width_m>0);if(s.length===0)return;o=!0,t+=`
*🚪 ห้อง: ${n.room_name||"ไม่ระบุ"}*
`;let r=0;s.forEach(a=>{r++;const l=Z[a.type]||"สินค้าตกแต่ง";a.type==="set"?t+=` ${r}) ${l} ${a.style} (${a.fabric_variant})
`:t+=` ${r}) ${l}
`})}),o?t+`------------------------------
`:""}function Ae(e){return e.rooms.reduce((t,o)=>{var s;if(o.is_suspended)return t;const n=((s=o.items)==null?void 0:s.reduce((r,a)=>{if(a.is_suspended)return r;switch(a.type){case"set":return r+E.calculateSetPrice(a).total;case"wallpaper":return r+E.calculateWallpaperPrice(a).total;default:return r+E.calculateDecoPrice(a).total}},0))||0;return t+n},0)}function it(e,t){const o=Ae(e);let n=0,s="";e.discount&&e.discount.value>0&&(e.discount.type==="percent"?(n=o*(e.discount.value/100),s=`🏷️ ส่วนลด (${e.discount.value}%): -${L(n)} บาท
`):(n=e.discount.value,s=`🏷️ ส่วนลด: -${L(n)} บาท
`));const r=o-n;let a=`🗓️ สรุปข้อมูล (${new Date().toLocaleDateString("th-TH",{day:"numeric",month:"short",year:"2-digit"})})
`;if(a+=`👤 ลูกค้า: ${e.customer_name||"-"}
`,(t==="customer"||t==="owner")&&(a+=`📞 โทร: ${e.customer_phone||"-"}
`,a+=`🏠 ที่อยู่: ${e.customer_address||"-"}
`),a+=`------------------------------
`,t==="customer")return a+=De(e),n>0&&(a+=`
ยอดรวม: ${L(o)} บาท
`,a+=s),a+=`
💰 *ยอดสุทธิ: ${L(r)} บาท*
`,a+=`
ขอบคุณที่ใช้บริการค่ะ
${M.name}
โทร: ${M.phone}`,a;if(t==="purchase_order"||t==="owner"){t==="owner"&&(a+=De(e));const l={opaqueFabrics:[],sheerFabrics:[],decorations:{},wallpapers:[],allSets:[]};e.rooms.forEach(d=>{d.is_suspended||!d.items||d.items.forEach(p=>{const _=p.type==="set"||p.type.includes("_blind")||p.type==="partition"||p.type==="pleated_screen";if(!(p.is_suspended||_&&p.width_m<=0))switch(p.type){case"set":l.allSets.push(p),p.fabric_variant.includes("ทึบ")&&l.opaqueFabrics.push({code:p.fabric_code||"??",yards:E.fabricYardage(p.style,p.width_m)}),p.fabric_variant.includes("โปร่ง")&&l.sheerFabrics.push({code:p.sheer_fabric_code||"??",yards:E.fabricYardage(p.style,p.width_m)});break;case"wallpaper":const w=(p.widths||[]).reduce(($,b)=>$+b,0);if(w>0){const $=E.wallpaperRolls(w,p.height_m);$>0&&l.wallpapers.push({code:p.wallpaper_code||"xxx",rolls:$})}break;default:const k=Z[p.type]||p.type;l.decorations[k]||(l.decorations[k]=[]),l.decorations[k].push({code:p.code||"xxx",width:p.width_m,height:p.height_m});break}})});const u={};if([...l.opaqueFabrics,...l.sheerFabrics].forEach(d=>{u[d.code]=(u[d.code]||0)+d.yards}),Object.keys(u).length>0){a+=`✂️ *รายการสั่งซื้อ (ผ้า)*
`,a+=`------------------------------
`,l.opaqueFabrics.length>0&&l.opaqueFabrics.forEach(d=>{a+=`- ผ้าทึบ (Curtain)
`,a+=`  รหัส: #${d.code||"??"}
`,a+=`  จำนวน: ${d.yards.toFixed(2)} หลา

`}),l.sheerFabrics.length>0&&l.sheerFabrics.forEach(d=>{a+=`- ผ้าโปร่ง (Sheer)
`,a+=`  รหัส: #${d.code||"??"}
`,a+=`  จำนวน: ${d.yards.toFixed(2)} หลา

`}),a+=`------------------------------
`,a+=`📊 *สรุปยอดรวมผ้า (ตามรหัส)*
`,a+=`------------------------------
`;for(const[d,p]of Object.entries(u))a+=`  - รหัส #${d}: ${p.toFixed(2)} หลา
`;a+=`
`}const c=l.allSets.filter(d=>d.style==="ตาไก่"),i=l.allSets.filter(d=>d.style!=="ตาไก่");if(i.length>0){a+=`------------------------------
`,a+=`📏 *รายการสั่งซื้อ ราง (ลอน/จีบ)*
`,a+=`------------------------------

`;let d=1;i.forEach(p=>{a+=`(${d++}) ราง ${p.style}, สี: ${p.track_color}
`,p.fabric_variant.includes("ทึบ")&&(a+=`  - รางทึบ: ${Number(p.width_m).toFixed(2)} ม.
`),p.fabric_variant.includes("โปร่ง")&&(a+=`  - รางโปร่ง: ${Number(p.width_m).toFixed(2)} ม.
`),p.fabric_variant==="ทึบ&โปร่ง"&&(a+=`  (❗️ใช้ขาสองชั้น)
`),p.notes&&t==="owner"&&(a+=`  📝 หมายเหตุ: ${p.notes}
`),a+=`
`})}if(c.length>0){a+=`------------------------------
`,a+=`📏 *รายการสั่งซื้อ ราง (ตาไก่)*
`,a+=`------------------------------

`;let d=1;c.forEach(b=>{a+=`(${d++}) ราง ${b.style}, สี: ${b.track_color}
`,b.fabric_variant.includes("ทึบ")&&(a+=`  - รางทึบ: ${Number(b.width_m).toFixed(2)} ม.
`),b.fabric_variant.includes("โปร่ง")&&(a+=`  - รางโปร่ง: ${Number(b.width_m).toFixed(2)} ม.
`),b.notes&&t==="owner"&&(a+=`  📝 หมายเหตุ: ${b.notes}
`),a+=`
`}),a+=`--- สรุปยอดรวมรางตาไก่ ---
`;const p=[];c.forEach(b=>{b.fabric_variant.includes("ทึบ")&&p.push(Number(b.width_m)),b.fabric_variant.includes("โปร่ง")&&p.push(Number(b.width_m))});const _=6;p.sort((b,x)=>x-b);const w=[];for(const b of p){let x=!1;for(let C=0;C<w.length;C++)if(w[C]>=b-.001){w[C]-=b,x=!0;break}x||w.push(_-b)}a+=`ต้องใช้รางเต็ม (6 ม.) ทั้งหมด: *${w.length} เส้น*

`;const k=p.reduce((b,x)=>{const C=x.toFixed(2);return b[C]=(b[C]||0)+1,b},{}),$=Object.entries(k).sort((b,x)=>parseFloat(x[0])-parseFloat(b[0]));if($.length>0){a+=`*สรุปจำนวนรางที่ต้องตัด:*
`;for(const[b,x]of $)a+=`  - ขนาด ${b} ม. = ${x} เส้น
`;a+=`
`}}const f={};c.forEach(d=>{const p=d.track_color||"ไม่ระบุ",_=d.grommet_color||"เงิน",w=`${p}|${_}`;f[w]||(f[w]={trackColor:p,grommetColor:_,grommets:0,brackets:0,finials:0}),f[w].grommets+=E.calculateGrommets(d.width_m),f[w].brackets+=d.width_m>=1.6?3:2,f[w].finials+=d.fabric_variant==="ทึบ&โปร่ง"?4:2});const m=l.allSets.length*2;(Object.keys(f).length>0||m>0)&&(a+=`------------------------------
`,a+=`🔩 *รายการสั่งซื้อ อุปกรณ์ (Hardware)*
`,a+=`------------------------------

`,Object.values(f).forEach(d=>{d.grommets>0&&(a+=`  - ตาไก่ (สี${d.grommetColor}): ${d.grommets} ตัว
`),d.brackets>0&&(a+=`  - ขาจับ (สี${d.trackColor}): ${d.brackets} ตัว
`),d.finials>0&&(a+=`  - หัวราง (สี${d.trackColor}): ${d.finials} ตัว
`)}),m>0&&(a+=`  - ตะขอรวบม่าน: ${m} ตัว
`),a+=`
`);const y=l.decorations;Object.keys(y).length>0&&Object.entries(y).forEach(([d,p])=>{a+=`------------------------------
`,a+=`📦 *รายการสั่งซื้อ ${d}*
`,a+=`------------------------------

`,p.forEach(_=>{a+=`- รหัส: #${_.code||"xxx"}
  ขนาด: ${_.width.toFixed(2)} x ${_.height.toFixed(2)} m.

`})});const v={};if(l.wallpapers.forEach(d=>{v[d.code]=(v[d.code]||0)+d.rolls}),Object.keys(v).length>0){a+=`------------------------------
`,a+=`🎨 *รายการสั่งซื้อ (Wallpaper)*
`,a+=`------------------------------

`;for(const[d,p]of Object.entries(v))a+=`  - รหัส #${d}: ${p} ม้วน
`;a+=`
`}if(t==="purchase_order")return a+=`------------------------------
`,a}if(t==="seamstress"||t==="owner"){a+=`
🧵 *รายละเอียดสำหรับช่างเย็บผ้า*
`;let l=0;if(e.rooms.forEach(u=>{if(u.is_suspended||!u.items)return;const c=u.items.filter(i=>i.type==="set"&&!i.is_suspended&&i.width_m>0);c.length!==0&&(l>0&&(a+=`==============================
`),a+=`
*🚪 ห้อง: ${u.room_name||"ไม่ระบุ"}*

`,c.forEach((i,f)=>{f>0&&(a+=`--------------------
`),a+=`*ชุดที่ ${f+1}/${c.length}: ${i.style} ${i.fabric_variant}*
`,a+=`  - ขนาด: กว้าง ${Number(i.width_m).toFixed(2)} x สูง ${Number(i.height_m).toFixed(2)} ม.
`,a+=`  - รูปแบบเปิด: ${i.opening_style}
`,i.fabric_variant.includes("ทึบ")&&(a+=`  - ผ้าทึบ: #${i.fabric_code||"-"}
`),i.fabric_variant.includes("โปร่ง")&&(a+=`  - ผ้าโปร่ง: #${i.sheer_fabric_code||"-"}
`)}),a+=`
`,l++)}),l>0?a+=`==============================
`:a+=`ไม่มีรายการสำหรับช่าง
------------------------------
`,t==="seamstress")return a}return t==="owner"&&(a+=`
💰 *สรุปยอดรวม: ${L(r)} บาท*
`),a}function dt(e){if(!e.rooms||e.rooms.length===0)return'<p class="empty-summary">ไม่มีข้อมูลสำหรับแสดงผล</p>';let t="";const o={};e.rooms.forEach(a=>{a.is_suspended||!a.items||a.items.forEach(l=>{if(l.is_suspended)return;let u=null,c=0;switch(l.type){case"set":c=E.calculateSetPrice(l).total,c>0&&(u=l.type);break;case"wallpaper":c=E.calculateWallpaperPrice(l).total,c>0&&(u=l.type);break;default:c=E.calculateDecoPrice(l).total,c>0&&(u=l.type);break}u&&(o[u]=(o[u]||0)+1)})});const n=Object.entries(o).map(([a,l])=>{const u=Z[a]||"ของตกแต่ง";return`
            <span class="summary-tag" data-filter-type="${S(a)}" title="คลิกเพื่อกรองเฉพาะรายการนี้">
                ${S(u)} <strong>${l}</strong>
            </span>`}).join("");n&&(t+=`
            <div class="overview-summary-group">
                <h4><i class="ph ph-stack"></i> สรุปประเภทรายการ</h4>
                <div class="summary-tags-container">
                    ${n}
                </div>
            </div>`);let s="",r=0;return e.rooms.forEach(a=>{if(a.is_suspended||!a.items)return;const l={};let u=0;if(a.items.forEach(c=>{if(c.is_suspended)return;let i=null,f=0;switch(c.type){case"set":f=E.calculateSetPrice(c).total,f>0&&(i=c.type);break;case"wallpaper":f=E.calculateWallpaperPrice(c).total,f>0&&(i=c.type);break;default:f=E.calculateDecoPrice(c).total,f>0&&(i=c.type);break}i&&(l[i]=(l[i]||0)+1,u++)}),u>0){r+=u;const c=Object.entries(l).map(([i,f])=>`
                    <div class="overview-item">
                        <span>${S(Z[i]||"ของตกแต่ง")}</span>
                        <span>${f}</span>
                    </div>`).join("");s+=`
                <details class="overview-room-card">
                    <summary class="overview-room-summary">
                        <span class="room-name">${S(a.room_name)||"ไม่ระบุชื่อห้อง"}</span>
                        <div class="summary-tags">
                            <span class="room-item-count">${u} รายการ</span>
                            <i class="ph ph-caret-down expand-icon"></i>
                        </div>
                    </summary>
                    <div class="overview-room-items">${c}</div>
                </details>`}}),s&&(t+=`
            <div class="overview-breakdown-group">
                <h4><i class="ph ph-map-pin-line"></i> แจกแจงตามห้อง</h4>
                ${s}
            </div>`),r===0?'<p class="empty-summary">ไม่มีรายการสำหรับแสดงผล</p>':t}function ut(e,t){const{vatRate:o,pageBreakBuffer:n=3}=t,s=[];e.rooms.forEach(A=>{if(A.is_suspended||!A.items)return;const F=[];A.items.forEach(T=>{if(T.is_suspended)return;let I,N,W,O;const V=Z[T.type]||"สินค้าตกแต่ง";switch(T.type){case"set":N=E.calculateSetPrice(T).total,N>0&&(W=T.width_m||0,O=T.height_m||0,I=`${V} ${S(T.style)} (${S(T.fabric_variant)}) <br><small>ขนาด ${W.toFixed(2)} x ${O.toFixed(2)} ม.${T.notes?` - ${S(T.notes)}`:""}</small>`,F.push({description:I,total:N,units:I.includes("<br>")?1.5:1}));break;case"wallpaper":if(N=E.calculateWallpaperPrice(T).total,N>0){const Q=(T.widths||[]).reduce((H,pe)=>H+pe,0),re=E.wallpaperRolls(Q,T.height_m);O=T.height_m||0,I=`${V} <br><small>รหัส: ${S(T.wallpaper_code)||"-"}, สูง ${O.toFixed(2)} ม. (ใช้ ${re} ม้วน)</small>`,F.push({description:I,total:N,units:I.includes("<br>")?1.5:1})}break;default:N=E.calculateDecoPrice(T).total,N>0&&(W=T.width_m||0,O=T.height_m||0,I=`${V} <br><small>รหัส: ${S(T.code)||"-"}, ขนาด ${W.toFixed(2)} x ${O.toFixed(2)} ม.</small>`,F.push({description:I,total:N,units:I.includes("<br>")?1.5:1}));break}}),F.length>0&&(s.push({isRoomHeader:!0,roomName:S(A.room_name)||"ไม่ระบุชื่อห้อง",units:1.2}),s.push(...F))});const r=s.reduce((A,F)=>A+(F.total||0),0);if(r===0)return null;let a=0,l="",u=r;e.discount&&e.discount.value>0&&(e.discount.type==="percent"?(a=r*(e.discount.value/100),l=`<tr><td class="pdf-label">ส่วนลด (${e.discount.value}%)</td><td class="pdf-amount">-${j(a,2,!0)}</td></tr>`):(a=e.discount.value,l=`<tr><td class="pdf-label">ส่วนลด</td><td class="pdf-amount">-${j(a,2,!0)}</td></tr>`),u=r-a,l+=`<tr><td class="pdf-label">ยอดหลังหักส่วนลด</td><td class="pdf-amount">${j(u,2,!0)}</td></tr>`);const c=u*o,i=u+c,f=17,m=23,y=[];let v=[],d=0;s.forEach((A,F)=>{const T=y.length===0?f:m,I=d+A.units>T;let N=!1;if(!I&&F<s.length-1){const W=T-(d+A.units);W>0&&W<n&&(N=!0)}(I||N)&&v.length>0&&(y.push(v),v=[],d=0),v.push(A),d+=A.units}),v.length>0&&y.push(v);const p=new Date,_=p.toLocaleDateString("th-TH",{year:"numeric",month:"long",day:"numeric"}),w=`QT-${p.getFullYear()}${(p.getMonth()+1).toString().padStart(2,"0")}${p.getDate().toString().padStart(2,"0")}`;let k="",$=0,b=1;y.forEach((A,F)=>{const T=F===0,I=F===y.length-1,N=`
            <div class="pdf-page-header">
                <div class="pdf-header">
                    <div class="pdf-shop-info">
                        ${`<img src="${M.logoUrl}" alt="Logo" class="pdf-logo">`}
                        <div class="pdf-shop-address">
                            <strong><i class="ph ph-github-logo"></i> ${S(M.name)}</strong><br>
                            ${S(M.address).replace(/\n/g,"<br>")}<br>
                            โทร: ${S(M.phone)} | เลขประจำตัวผู้เสียภาษี: ${S(M.taxId)}
                        </div>
                    </div>
                    <div class="pdf-quote-details">
                        <div class="pdf-title-box"><h1>ใบเสนอราคา ${y.length>1?T?"":"(ต่อ)":""}</h1></div>
                        <table class="pdf-quote-meta">
                            <tr><td>เลขที่:</td><td>${w}</td></tr>
                            <tr><td>วันที่:</td><td>${_}</td></tr>
                        </table>
                    </div>
                </div>
                ${T?`
                <section class="pdf-customer-details">
                    <div class="pdf-customer-info">
                        <strong>ลูกค้า:</strong> ${S(e.customer_name)||""}<br>
                        <strong>ที่อยู่:</strong> ${S(e.customer_address).replace(/\n/g,"<br>")||""}<br>
                        <strong>โทร:</strong> ${S(e.customer_phone)||""}
                    </div>
                    <div class="pdf-customer-meta">
                        <strong>เงื่อนไขชำระเงิน:</strong> ${S(M.pdf.paymentTerms)}<br>
                        <strong>ยืนราคา:</strong> ${S(M.pdf.priceValidity)}
                    </div>
                </section>`:""}
            </div>`,W=`
            <div class="pdf-page-footer">
                <div class="pdf-footer-info">
                    <span><i class="ph ph-github-logo"></i> ${S(M.name)} | โทร: ${S(M.phone)}</span>
                    <span>หน้า ${F+1} / ${y.length}</span>
                </div>
            </div>`;let O="";T||(O+=`<tr class="pdf-subtotal-row"><td colspan="4">ยอดยกมา (Brought Forward)</td><td class="pdf-text-right">${j($,2,!0)}</td></tr>`),A.forEach(H=>{H.isRoomHeader?O+=`<tr class="pdf-room-header"><td colspan="5">ห้อง: ${H.roomName}</td></tr>`:(O+=`<tr><td class="pdf-text-center">${b++}</td><td>${H.description}</td><td class="pdf-text-center">1</td><td class="pdf-text-right">${j(H.total,2,!0)}</td><td class="pdf-text-right">${j(H.total,2,!0)}</td></tr>`,$+=H.total)});let V="";I||(V=`<tfoot><tr class="pdf-subtotal-row"><td colspan="4">ยอดยกไป (Carried Forward)</td><td class="pdf-text-right">${j($,2,!0)}</td></tr></tfoot>`);let Q="";M.pdf.notes&&M.pdf.notes.length>0&&(Q=`
                <strong>หมายเหตุ:</strong>
                <ul>${M.pdf.notes.map(H=>`<li>${S(H)}</li>`).join("")}</ul>
            `);const re=I?`
            <div class="pdf-summary-wrapper">
                <section class="pdf-summary-section">
                    <div class="pdf-amount-in-words">
                        ${Q}
                        <div class="pdf-amount-text">( ${nt(i)} )</div>
                    </div>
                    <div class="pdf-totals-block">
                        <table>
                            <tr><td class="pdf-label">รวมเป็นเงิน</td><td class="pdf-amount">${j(r,2,!0)}</td></tr>
                            ${l}
                            ${o>0?`<tr><td class="pdf-label">ภาษีมูลค่าเพิ่ม ${(o*100).toFixed(0)}%</td><td class="pdf-amount">${j(c,2,!0)}</td></tr>`:""}
                            <tr class="pdf-grand-total"><td class="pdf-label">ยอดรวมสุทธิ</td><td class="pdf-amount">${j(i,2,!0)}</td></tr>
                        </table>
                    </div>
                </section>
                <footer class="pdf-footer-section">
                    <div class="pdf-signature-box"><p>.................................................</p><p>ผู้เสนอราคา</p><p>(<i class="ph ph-github-logo"></i> ${S(M.name)})</p><p>วันที่: ${_}</p></div>
                    <div class="pdf-signature-box"><p>.................................................</p><p>ลูกค้า / ผู้มีอำนาจลงนาม</p><p>&nbsp;</p><p>วันที่: ......./......./............</p></div>
                </footer>
            </div>
        `:"";k+=`
            <div class="pdf-page">
                <div class="pdf-page-content">
                    ${N}
                    <div class="pdf-page-body">
                        <table class="pdf-items-table">
                            <thead><tr><th style="width:5%;">ลำดับ</th><th style="width:50%;">รายการ</th><th style="width:10%;">จำนวน</th><th style="width:17.5%;">ราคา/หน่วย</th><th style="width:17.5%;">รวม (บาท)</th></tr></thead>
                            <tbody>${O}</tbody>
                            ${V}
                        </table>
                        ${re}
                    </div>
                    ${W}
                </div>
            </div>`});const x=e.customer_name||"quote",C=ae(x);return{html:`<div id="quotation-template">${k}</div>`,fileName:`${w}_${C}`}}function Se(){return`
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;700&display=swap');
            body { 
                font-family: 'Noto Sans Thai', sans-serif; 
                background-color: #f4f4f4; 
                margin: 0;
            }
            .page {
                background: white;
                padding: 15mm;
                margin: 10mm auto;
                width: 210mm;
                min-height: 297mm;
                box-sizing: border-box;
                box-shadow: 0 0 10px rgba(0,0,0,0.1);
                page-break-after: always;
            }
            .page:last-child { page-break-after: avoid; }
            .header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                border-bottom: 2px solid #003366;
                padding-bottom: 10px;
                margin-bottom: 10px;
            }
            .shop-info { font-size: 10pt; color: #333; }
            .shop-info h1 { font-size: 18pt; color: #003366; margin: 0; }
            .report-title { text-align: right; }
            .report-title h2 { font-size: 16pt; margin: 0; }
            .report-title p { font-size: 10pt; margin: 2px 0 0; }
            .customer-info {
                background-color: #f8f9fa;
                border: 1px solid #dee2e6;
                padding: 10px;
                margin-bottom: 15px;
                font-size: 11pt;
            }
            h3 { 
                font-size: 14pt; 
                color: #003366; 
                border-bottom: 1px solid #ccc;
                padding-bottom: 5px;
                margin-top: 20px;
            }
            .lookbook-room {
                border: 1px solid #eee;
                padding: 15px;
                margin-bottom: 20px;
                page-break-inside: avoid;
            }
            .lookbook-room h4 { font-size: 13pt; margin:0 0 10px 0; }
            .lookbook-details { display: flex; gap: 15px; }
            .visual-placeholder {
                width: 120px;
                height: 120px;
                background-color: #e9ecef;
                border: 1px solid #ced4da;
                display: flex;
                align-items: center;
                justify-content: center;
                text-align: center;
                font-size: 10pt;
                color: #6c757d;
                flex-shrink: 0;
            }
            .spec-table { width: 100%; border-collapse: collapse; }
            .spec-table td { padding: 6px 0; border-bottom: 1px solid #f1f1f1; font-size: 11pt; }
            .spec-table td:first-child { font-weight: 500; color: #555; width: 80px;}
            .total-summary { text-align: right; margin-top: 20px; }
            .total-summary .grand-total { font-size: 16pt; font-weight: bold; color: #003366; }
            
            /* Job Card Styles */
            .job-card {
                border: 2px solid #333;
                padding: 10mm;
                margin-bottom: 10mm;
                page-break-inside: avoid;
                display: flex;
                flex-direction: column;
                height: 128mm; /* Approx half A4 page height minus margin */
                box-sizing: border-box;
            }
            .job-card-header { display: flex; justify-content: space-between; font-size: 14pt; font-weight: bold; }
            .job-card-diagram { text-align: center; border: 1px solid #ccc; padding: 15px; margin: 10px 0; flex-grow: 1; display:flex; flex-direction:column; justify-content: center; align-items: center; }
            .job-card-specs { font-size: 12pt; line-height: 1.8; }
            .job-card-specs strong { min-width: 90px; display: inline-block; }

            /* Purchase Order Styles */
            .po-category { margin-bottom: 20px; }
            .po-table { width: 100%; border-collapse: collapse; }
            .po-table th, .po-table td { border: 1px solid #ddd; padding: 8px; font-size: 11pt; }
            .po-table th { background-color: #f2f2f2; font-weight: bold; text-align: left; }

            /* Kanban Styles */
            .kanban-board { display: flex; justify-content: space-between; gap: 10px; }
            .kanban-column { background-color: #f8f9fa; border: 1px solid #dee2e6; width: 32%; }
            .kanban-header { background-color: #e9ecef; padding: 10px; font-size: 12pt; font-weight: bold; }
            .kanban-cards { padding: 10px; min-height: 200mm; }
            .kanban-card { background-color: #fff; border: 1px solid #ccc; padding: 10px; margin-bottom: 8px; font-size: 10pt; }
        </style>
    `}function pt(e){var a;const t=Ae(e);let o=0;((a=e.discount)==null?void 0:a.value)>0&&(o=e.discount.type==="percent"?t*(e.discount.value/100):e.discount.value);const n=t-o;let s=e.rooms.map(l=>{if(l.is_suspended)return"";const u=l.items.filter(i=>!i.is_suspended&&(i.width_m>0||i.type==="wallpaper"&&(i.widths||[]).reduce((f,m)=>f+m,0)>0));if(u.length===0)return"";const c=u.map(i=>{let f=0,m="";const y=Z[i.type]||"ของตกแต่ง";switch(i.type){case"set":f=E.calculateSetPrice(i).total,m=`
                        <tr><td>รูปแบบ</td><td>${S(i.style)} (${S(i.fabric_variant)})</td></tr>
                        ${i.fabric_variant.includes("ทึบ")?`<tr><td>ผ้าทึบ</td><td>#${S(i.fabric_code)||"-"}</td></tr>`:""}
                        ${i.fabric_variant.includes("โปร่ง")?`<tr><td>ผ้าโปร่ง</td><td>#${S(i.sheer_fabric_code)||"-"}</td></tr>`:""}
                        <tr><td>ขนาด</td><td>${i.width_m.toFixed(2)} x ${i.height_m.toFixed(2)} ม.</td></tr>
                    `;break;default:f=E.calculateDecoPrice(i).total,m=`
                        <tr><td>รหัส</td><td>#${S(i.code)||"-"}</td></tr>
                        <tr><td>ขนาด</td><td>${i.width_m.toFixed(2)} x ${i.height_m.toFixed(2)} ม.</td></tr>
                    `;break}return`
                 <div class="lookbook-details">
                    <div class="visual-placeholder">${S(y)}</div>
                    <table class="spec-table">
                        ${m}
                        <tr><td><strong>ราคา</strong></td><td><strong>${L(f)} บาท</strong></td></tr>
                    </table>
                </div>
            `}).join('<hr style="border:0; border-top:1px solid #eee; margin:15px 0;">');return`
            <div class="lookbook-room">
                <h4>🛋️ ${S(l.room_name)}</h4>
                ${c}
            </div>
        `}).join("");return{html:`
        <!DOCTYPE html><html lang="th"><head><title>Look Book</title>${Se()}</head><body>
        <div class="page">
            <div class="header">
                <div class="shop-info"><h1>${S(M.name)}</h1><p>${S(M.phone)}</p></div>
                <div class="report-title"><h2>Look Book & Quotation</h2><p>สำหรับ: ${S(e.customer_name)||"-"}</p></div>
            </div>
            <div class="customer-info">
                <strong>ลูกค้า:</strong> ${S(e.customer_name)||"-"}<br/>
                <strong>ที่อยู่:</strong> ${S(e.customer_address)||"-"}
            </div>
            <h3>✨ รายละเอียดงานออกแบบ</h3>
            ${s}
            <div class="total-summary">
                <p>รวมเป็นเงิน: ${L(t)} บาท</p>
                ${o>0?`<p>ส่วนลด: -${L(o)} บาท</p>`:""}
                <p class="grand-total">ยอดสุทธิ: ${L(n)} บาท</p>
            </div>
        </div>
        </body></html>`,fileName:`LookBook_${ae(e.customer_name)}`}}function mt(e){let t="";if(e.rooms.forEach(r=>{if(r.is_suspended)return;const a=r.items.filter(l=>l.type==="set"&&!l.is_suspended&&l.width_m>0);a.forEach((l,u)=>{t+=`
                <div class="job-card">
                    <div class="job-card-header">
                        <span>🚪 ห้อง: ${S(r.room_name)}</span>
                        <span>ชุดที่ ${u+1}/${a.length}</span>
                    </div>
                    <div class="job-card-diagram">
                        <p><strong>รูปแบบ: ${S(l.style)}</strong></p>
                        <p>ขนาดสำเร็จ: &nbsp; &harr; ${l.width_m.toFixed(2)} ม. &nbsp; &updownarrow; ${l.height_m.toFixed(2)} ม.</p>
                    </div>
                    <div class="job-card-specs">
                        <strong>ผ้าทึบ:</strong> #${S(l.fabric_code)||"ไม่มี"}<br/>
                        <strong>ผ้าโปร่ง:</strong> #${S(l.sheer_fabric_code)||"ไม่มี"}<br/>
                        <strong>รูปแบบเปิด:</strong> ${S(l.opening_style)}<br/>
                        <strong>หมายเหตุ:</strong> ${S(l.notes)||"-"}
                    </div>
                </div>
            `})}),!t)return{html:null};const o=t.match(/<div class="job-card">.*?<\/div>/gs);let n="";for(let r=0;r<o.length;r+=2)n+='<div class="page">',n+=o[r],o[r+1]&&(n+=o[r+1]),n+="</div>";return{html:`<!DOCTYPE html><html lang="th"><head><title>Job Cards</title>${Se()}</head><body>${n}</body></html>`,fileName:`JobCards_${ae(e.customer_name)}`}}function ft(e){const t={fabrics:{},tracks:{},others:{}};e.rooms.forEach(s=>{s.is_suspended||s.items.forEach(r=>{if(!r.is_suspended)if(r.type==="set"){if(r.fabric_variant.includes("ทึบ")){const l=r.fabric_code||"ไม่ระบุ";t.fabrics[l]=(t.fabrics[l]||0)+E.fabricYardage(r.style,r.width_m)}if(r.fabric_variant.includes("โปร่ง")){const l=r.sheer_fabric_code||"ไม่ระบุ";t.fabrics[l]=(t.fabrics[l]||0)+E.fabricYardage(r.style,r.width_m)}const a=`ราง ${r.style} สี${r.track_color} (${r.width_m.toFixed(2)} ม.)`;t.tracks[a]=(t.tracks[a]||0)+(r.fabric_variant==="ทึบ&โปร่ง"?2:1)}else{const l=`${Z[r.type]||r.type} #${r.code||"-"} (${r.width_m.toFixed(2)}x${r.height_m.toFixed(2)}ม.)`;t.others[l]=(t.others[l]||0)+1}})});const o=(s,r,a)=>{if(Object.keys(r).length===0)return"";let l=Object.entries(r).map(([u,c])=>`<tr><td>${S(u)}</td><td>${c.toFixed(2)} ${a}</td></tr>`).join("");return`<div class="po-category"><h3>${s}</h3><table class="po-table">
            <thead><tr><th>รายการ</th><th>จำนวน</th></tr></thead>
            <tbody>${l}</tbody>
        </table></div>`};return{html:`<!DOCTYPE html><html lang="th"><head><title>Purchase Order</title>${Se()}</head><body>
        <div class="page">
             <div class="header">
                <div class="shop-info"><h1>${S(M.name)}</h1></div>
                <div class="report-title"><h2>สรุปรายการสั่งซื้อ</h2><p>โปรเจกต์: ${S(e.customer_name)||"-"}</p></div>
            </div>
            ${o("🧵 ผ้า (Fabrics)",t.fabrics,"หลา")}
            ${o("📏 รางม่าน (Tracks)",t.tracks,"เส้น")}
            ${o("📦 รายการอื่นๆ (Others)",t.others,"ชุด")}
        </div>
    </body></html>`,fileName:`PurchaseOrder_${ae(e.customer_name)}`}}function ht(e){const t=[],o=new Set,n=new Set,s=[];e.rooms.forEach(u=>{u.is_suspended||u.items.forEach(c=>{c.is_suspended||c.type==="set"&&(c.fabric_code&&o.add(c.fabric_code),c.sheer_fabric_code&&o.add(c.sheer_fabric_code),n.add(`ราง ${c.style} (${c.width_m.toFixed(2)}ม.)`),s.push(`${u.room_name}: ${c.style} ${c.width_m.toFixed(2)}ม.`))})}),o.size>0&&t.push(`สั่งผ้า: ${Array.from(o).join(", ")}`),n.size>0&&t.push("สั่งรางและอุปกรณ์"),t.push(...s.map(u=>`เย็บผ้า: ${u}`)),t.push("นัดคิวช่างติดตั้ง"),t.push("ตรวจสอบและเก็บงาน"),t.push("รับชำระเงินส่วนที่เหลือ");const r=t.map(u=>`<div class="kanban-card">${S(u)}</div>`).join(""),a=L(Ae(e));return{html:`<!DOCTYPE html><html lang="th"><head><title>Kanban Board</title>${Se()}</head><body>
        <div class="page">
            <div class="header">
                <div class="shop-info"><h1>กระดานจัดการโปรเจกต์</h1><p>ลูกค้า: ${S(e.customer_name)}</p></div>
                <div class="report-title"><h2>มูลค่า: ${a} บาท</h2></div>
            </div>
            <div class="kanban-board">
                <div class="kanban-column">
                    <div class="kanban-header">📋 ต้องทำ (To-Do)</div>
                    <div class="kanban-cards">${r}</div>
                </div>
                <div class="kanban-column">
                    <div class="kanban-header">⏳ กำลังทำ (In Progress)</div>
                    <div class="kanban-cards"></div>
                </div>
                <div class="kanban-column">
                    <div class="kanban-header">✅ เสร็จสิ้น (Done)</div>
                    <div class="kanban-cards"></div>
                </div>
            </div>
        </div>
    </body></html>`,fileName:`Kanban_${ae(e.customer_name)}`}}const se=[],vt=10;function ee(e){se.push(e),se.length>vt&&se.shift()}function yt(){return se.pop()}function _t(){return se.length>0}let z=!1,ge=null,P=null,me=null,le=!1,D=null,xe=null,Le=!1;const We=document.querySelector("#undoBtn"),fe={};function gt(e){if(fe[e])return fe[e];const t=new Promise((o,n)=>{const s=document.createElement("script");s.src=e,s.onload=()=>{console.log(`${e} loaded successfully.`),o()},s.onerror=()=>{console.error(`Script load error for ${e}`),delete fe[e],n(new Error(`Script load error for ${e}`))},document.head.appendChild(s)});return fe[e]=t,t}const ie={set:{templateId:"#setTpl",name:"ผ้าม่าน"},wallpaper:{templateId:"#wallpaperTpl",name:"วอลล์เปเปอร์"},wooden_blind:{templateId:"#areaBasedTpl",name:"มู่ลี่ไม้"},roller_blind:{templateId:"#areaBasedTpl",name:"ม่านม้วน"},vertical_blind:{templateId:"#areaBasedTpl",name:"ม่านปรับแสง"},partition:{templateId:"#areaBasedTpl",name:"ฉากกั้นห้อง"},pleated_screen:{templateId:"#areaBasedTpl",name:"มุ้งจีบ"},aluminum_blind:{templateId:"#areaBasedTpl",name:"มู่ลี่อลูมิเนียม"}},bt={มู่ลี่ไม้:"wooden_blind",ม่านม้วน:"roller_blind",ม่านปรับแสง:"vertical_blind",ฉากกั้นห้อง:"partition",มุ้งจีบ:"pleated_screen",มู่ลี่อลูมิเนียม:"aluminum_blind"},Ce="marnthara.theme";function Ge(){const e=localStorage.getItem(Ce),t=document.querySelector("#themeToggleBtn");if(!t)return;const o=t.querySelector("i"),n=t.querySelector("span");switch(document.body.classList.remove("dark-theme","neutral-theme"),e){case"dark":document.body.classList.add("dark-theme"),o&&(o.className="ph-fill ph-sun"),n&&(n.textContent=" สว่าง");break;case"neutral":document.body.classList.add("neutral-theme"),o&&(o.className="ph-fill ph-moon"),n&&(n.textContent=" มืด");break;default:o&&(o.className="ph-fill ph-palette"),n&&(n.textContent=" กลาง");break}}function St(){const e=localStorage.getItem(Ce);let t;!e||e==="light"?t="neutral":e==="neutral"?t="dark":t="light",localStorage.setItem(Ce,t),Ge()}function J(){We&&(We.disabled=!_t())}function wt(){const e=yt();e&&(Ie(e,!1),q("ยกเลิกการกระทำล่าสุดแล้ว","success")),J()}function qt(e,t){if(!e)return;const o=document.getElementById("filterStatusBar");o&&(o.innerHTML=`
            <span>แสดงผลเฉพาะ: <strong>${S(t)}</strong></span>
            <button type="button" class="btn-chip" data-act="clear-filter" title="ยกเลิกการกรอง">
                <i class="ph ph-x"></i>&nbsp;ปิด
            </button>
        `,o.classList.add("is-visible"),o.dataset.filterType=e),document.querySelectorAll(h.room).forEach(n=>{let s=0;n.querySelectorAll(".item-card").forEach(r=>{const a=r.dataset.type===e;r.classList.toggle("item-hidden",!a),a&&s++}),n.classList.toggle("item-hidden",s===0)}),te(),G()}function $t(){const e=document.getElementById("filterStatusBar");e&&(e.classList.remove("is-visible"),e.innerHTML="",e.removeAttribute("data-filter-type")),document.querySelectorAll(".item-hidden").forEach(t=>t.classList.remove("item-hidden")),te(),G()}function we(){document.querySelectorAll(".favorite-chips-container.show").forEach(e=>{e.classList.remove("show")}),document.querySelectorAll(".item-card.overflow-visible").forEach(e=>{e.classList.remove("overflow-visible")})}function Je(e){var u;const t=e.dataset.favoriteType,o=(u=e.closest(".form-group-with-favorites"))==null?void 0:u.querySelector(".favorite-chips-container");if(!t||!o)return;we();const n=e.closest(".item-card"),r=K()[t]||[];let l=Array.from(r.reduce((c,i)=>{const f=i.code.trim();return f&&!c.has(f.toLowerCase())&&c.set(f.toLowerCase(),i),c},new Map).values()).map(c=>`<button type="button" class="btn-chip" data-code="${S(c.code)}" data-price="${c.price}">${S(c.code)}</button>`).join("");l+=`<button type="button" class="btn-manage-favorites" data-act="manage-favorites" data-type="${t}"><i class="ph ph-pencil-simple"></i> จัดการรายการโปรด</button>`,o.innerHTML=l,o.classList.add("show"),n&&n.classList.add("overflow-visible")}function kt(e){const t=e.closest(".form-group-with-favorites"),o=e.closest(".item-card");if(!t||!o)return;const n=e.dataset.code,s=g(e.dataset.price),r=t.querySelector("input[data-favorite-type]");r&&(r.value=n,r.classList.add("input-highlight"),setTimeout(()=>r.classList.remove("input-highlight"),1200));const a=r.dataset.favoriteType;let l;a==="fabric"?l="set_price_per_m":a==="sheer"?l="sheer_price_per_m":a==="wallpaper"?l="wallpaper_price_roll":l="area_price_sqyd";const u=o.querySelector(`[name="${l}"]`);u&&s>0&&(u.tagName==="SELECT"?u.value=s:u.value=L(s),u.classList.add("input-highlight"),setTimeout(()=>u.classList.remove("input-highlight"),1200)),qe(r),oe(o),B(),we()}function ye(e){const t=document.querySelector("#favManagerBody"),o=document.querySelector("#favManagerItemTpl"),s=K()[e]||[];!t||!o||(s.length===0?t.innerHTML='<p class="empty-state">ไม่มีรายการโปรดที่บันทึกไว้</p>':t.innerHTML=s.map(r=>o.innerHTML.replace(/{CODE}/g,S(r.code)).replace(/{PRICE}/g,L(r.price)).replace(/{RAW_PRICE}/g,r.price)).join(""),Me(null))}function Me(e){const t=document.querySelector('[data-act="edit-selected-fav"]'),o=document.querySelector('[data-act="del-selected-fav"]');!t||!o||(e?(t.disabled=!1,o.disabled=!1,D={code:e.dataset.code,price:g(e.dataset.price)}):(t.disabled=!0,o.disabled=!0,D=null))}async function xt(e){const t=document.querySelector("#favManagerModal");if(!t||!e)return;const o={fabric:"ผ้าทึบ",sheer:"ผ้าโปร่ง",wallpaper:"วอลล์เปเปอร์",wooden_blind:"มู่ลี่ไม้",roller_blind:"ม่านม้วน",vertical_blind:"ม่านปรับแสง",partition:"ฉากกั้นห้อง",pleated_screen:"มุ้งจีบ",aluminum_blind:"มู่ลี่อลูมิเนียม",deco:"ของตกแต่ง"};t.dataset.currentType=e,le=!1,D=null,document.querySelector("#favManagerTitle").textContent=`จัดการ '${o[e]||e}'`,ye(e),await U("#favManagerModal",()=>{le&&ge&&Je(ge)})}function q(e,t="default"){const o=document.querySelector(h.toastContainer);if(!o)return;const n={success:"ph-bold ph-check-circle",warning:"ph-bold ph-warning",error:"ph-bold ph-x-circle",default:"ph-bold ph-info"},s=document.createElement("div");s.className=`toast toast-${t}`,s.innerHTML=`<i class="${n[t]||n.default}"></i> ${e}`,o.appendChild(s),setTimeout(()=>s.classList.add("show"),10),setTimeout(()=>{s.classList.remove("show"),s.addEventListener("transitionend",()=>s.remove())},3e3)}function U(e,t){return new Promise(o=>{const n=document.querySelector(e);if(!n){o(null);return}const s=document.querySelector(".modal-wrapper.visible");s&&s.classList.add("is-underlay"),n.classList.add("visible");const r=n.querySelector('[id$="Confirm"]'),a=n.querySelector('[id$="Cancel"], [data-act="close-modal"]'),l=Array.from(n.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])')).filter(m=>!m.disabled&&m.offsetParent!==null),u=l[0],c=l[l.length-1];setTimeout(()=>u==null?void 0:u.focus(),50);const i=m=>{if(m.key==="Escape"&&!n.classList.contains("is-underlay")){f({cancelled:!0});return}if(m.key==="Tab"){if(l.length<=1){m.preventDefault();return}m.shiftKey?document.activeElement===u&&(c.focus(),m.preventDefault()):document.activeElement===c&&(u.focus(),m.preventDefault())}},f=m=>{n.classList.remove("visible"),document.removeEventListener("keydown",i),r&&(r.onclick=null),a&&(a.onclick=null),s&&s.classList.remove("is-underlay"),typeof m=="object"&&m.cancelled&&t&&t(),o(m)};r&&(r.onclick=()=>f(!0)),a&&(a.onclick=()=>{n.classList.contains("is-underlay")||f({cancelled:!0})}),document.addEventListener("keydown",i)})}async function ce(e,t){const o=document.querySelector(h.modal);return o?(o.querySelector(h.modalTitle).textContent=e,o.querySelector(h.modalBody).textContent=t,await U(h.modal)===!0):!0}async function Lt(){var o,n,s;const e=document.querySelector(h.exportOptionsModal);if(!e)return null;const t=await U(h.exportOptionsModal);return!t||t.cancelled?null:{vatOption:((o=e.querySelector('input[name="vat_option"]:checked'))==null?void 0:o.value)||"include",exportMethod:((n=e.querySelector("#exportMethod"))==null?void 0:n.value)||"direct",pageBreakBuffer:parseInt((s=e.querySelector("#pageBreakBuffer"))==null?void 0:s.value,10)||3}}async function Tt(){const e=document.querySelector("#discountModal");if(!e)return;const t=e.querySelector("#discountSubtotal"),o=e.querySelector("#discountPercent"),n=e.querySelector("#discountAmount"),s=e.querySelector("#discountFinalTotal"),r=document.querySelector("#discount_type"),a=document.querySelector("#discount_value"),l=g(document.querySelector("#originalTotal").dataset.rawTotal||document.querySelector("#grandTotal").textContent);t.textContent=L(l);const u=m=>{if(Le)return;Le=!0;let y=0;if(m==="percent"){const v=g(o.value);y=l*((v>=0?v:0)/100),n.value=y>0?L(Math.round(y)):""}else y=g(n.value);if(y=y>=0?Math.min(y,l):0,m!=="percent"){const v=l>0?y/l*100:0;o.value=v>0&&isFinite(v)?j(v,2):""}s.textContent=L(l-y),setTimeout(()=>{Le=!1},20)};o.addEventListener("input",()=>u("percent")),n.addEventListener("input",()=>u("amount")),n.addEventListener("focus",m=>{g(m.target.value)>0&&(m.target.value=g(m.target.value))}),n.addEventListener("blur",m=>{g(m.target.value)>0&&(m.target.value=L(g(m.target.value))),u("amount")});const c=r.value,i=g(a.value);o.value="",n.value="",i>0?c==="percent"?(o.value=i,u("percent")):(n.value=L(i),u("amount")):u();const f=await U("#discountModal");if(f&&!f.cancelled){const m=g(o.value),y=g(n.value);document.activeElement===o&&m>0?(r.value="percent",a.value=m):y>0?(r.value="amount",a.value=y):(r.value="amount",a.value=0),Y(),B()}}async function Et(){var n,s,r,a,l;if(!P)return;const e=document.querySelector("#hardwareModal"),t=((n=P.querySelector('[name="set_style"]'))==null?void 0:n.value)==="ตาไก่";e.querySelector('[name="modal_track_color"]').value=((s=P.querySelector('[name="track_color"]'))==null?void 0:s.value)||"ขาว",e.querySelector('[name="modal_bracket_color"]').value=((r=P.querySelector('[name="bracket_color"]'))==null?void 0:r.value)||"ขาว",e.querySelector('[name="modal_finial_color"]').value=((a=P.querySelector('[name="finial_color"]'))==null?void 0:a.value)||"ขาว",e.querySelector('[name="modal_grommet_color"]').value=((l=P.querySelector('[name="grommet_color"]'))==null?void 0:l.value)||"เงิน",e.querySelector("#grommetColorGroup").style.display=t?"":"none";const o=await U("#hardwareModal");o&&!o.cancelled&&(P.querySelector('[name="track_color"]').value=e.querySelector('[name="modal_track_color"]').value,P.querySelector('[name="bracket_color"]').value=e.querySelector('[name="modal_bracket_color"]').value,P.querySelector('[name="finial_color"]').value=e.querySelector('[name="modal_finial_color"]').value,t&&(P.querySelector('[name="grommet_color"]').value=e.querySelector('[name="modal_grommet_color"]').value),B(),q("บันทึกการตั้งค่าอุปกรณ์แล้ว","success")),P=null}function Te(e,t,o){e&&(ee(R()),J(),e.classList.add("item-removing"),e.addEventListener("animationend",()=>{e.remove(),t&&q(t),o&&o(),de(),te(),Y(),B(),ue()},{once:!0}))}function te(){document.querySelectorAll(h.room).forEach(e=>{const t=e.querySelectorAll(".item-card:not(.is-suspended):not(.item-hidden)"),o=t.length;t.forEach((s,r)=>{const a=s.querySelector("[data-item-title]");a&&(a.textContent=`${r+1}/${o}`)}),e.querySelectorAll(".item-card.is-suspended, .item-card.item-hidden").forEach(s=>{const r=s.querySelector("[data-item-title]");r&&(r.textContent="-")})})}function Ke(){const e=document.querySelector(h.orderForm),t=document.querySelector(h.lockBtn);!e||!t||(e.classList.toggle("is-locked",z),t.classList.toggle("is-locked",z),t.querySelector("i").className=z?"ph-bold ph-lock-key":"ph ph-paw-print",e.querySelectorAll("input, select, textarea, button").forEach(o=>{o.closest(".summary-footer")||o.closest(".main-header")||o.closest(".modal-wrapper")||o.dataset.act==="toggle-more-details"||o.dataset.act==="collapse-room"||(o.disabled=z)}),q(z?"ฟอร์มถูกล็อค":"ปลดล็อคฟอร์มแล้ว",z?"warning":"success"))}function G(){const e=document.querySelectorAll(h.room);if(e.length===0)return;const t=[...e].some(n=>n.open),o=document.querySelector(h.toggleAllRoomsBtn);o&&(o.querySelector("i").className="ph ph-rows",o.querySelector("span").textContent=t?"ย่อทั้งหมด":"ขยายทั้งหมด")}function Ct(){const e=document.querySelectorAll(h.room),t=[...e].some(o=>o.open);e.forEach(o=>{o.open=!t}),setTimeout(()=>{G(),B()},50)}function de(){const e=document.querySelector(h.quickNavRoomList);e&&(e.innerHTML="",document.querySelectorAll(h.room).forEach(t=>{var s;const o=((s=t.querySelector(h.roomNameInput))==null?void 0:s.value)||"ห้อง",n=document.createElement("a");n.href=`#${t.id}`,n.dataset.jumpTo=t.id,n.innerHTML=`<i class="ph ph-share-fat"></i> ${o}`,e.appendChild(n)}))}function Qe(e){var o;const t=document.getElementById("quickNavBtnText");t&&(e?t.textContent=((o=e.querySelector('input[name="room_name"]'))==null?void 0:o.value)||"...":t.textContent="ไปยังห้อง")}function ue(){if(me&&me.disconnect(),!document.getElementById("quickNavBtnText"))return;const e={root:null,rootMargin:"-60px 0px -150px 0px",threshold:0},t=o=>{const n=o.filter(s=>s.isIntersecting).sort((s,r)=>s.target.getBoundingClientRect().top-r.target.getBoundingClientRect().top);n.length>0&&Qe(n[0].target)};me=new IntersectionObserver(t,e),document.querySelectorAll(h.room).forEach(o=>me.observe(o))}function qe(e){if(!e)return;const t=e.closest(".form-group-with-favorites").querySelector(".btn-favorite");if(!t)return;const o=e.dataset.favoriteType,n=e.value;t.classList.toggle("is-favorite",lt(o,n))}function Fe(e,t){const o=ie[e];if(!o)return null;const n=document.querySelector(o.templateId);if(!n||!t)return null;const s=n.content.cloneNode(!0),r=s.firstElementChild;r.dataset.type=e,r.classList.add(`${e.replace(/_/g,"-")}-item`);const a=r.querySelector(".item-type-display");if(a&&(a.textContent=o.name),o.templateId==="#areaBasedTpl"){const l=r.querySelector("input[data-favorite-type]"),u=r.querySelector(".btn-favorite");l&&(l.dataset.favoriteType=e),u&&(u.dataset.type=e)}return t.appendChild(s),r}function Mt(e,t){var s;if(!t)return;const o=t.querySelector(h.allItemsContainer);if(!o)return;ee(R()),J(),we();const n=Fe(e,o);if(n){if(e==="wallpaper"){const r=Pe(n.querySelector('[data-act="add-wall"]'));r&&((s=r.querySelector("input"))==null||s.focus())}else{const r=n.querySelector('input:not([type="hidden"]), select, textarea');r&&r.focus()}n.classList.add("item-created"),n.scrollIntoView({behavior:"smooth",block:"center"}),te(),Y(),B()}}async function Ue(e,t=null){const o=document.querySelector("#itemTypeModal");if(!o)return null;o.querySelector("#itemTypeModalTitle").textContent=e;let n=t;t&&!ie[t]&&(n="wooden_blind");const s=o.querySelector(`input[name="item_type_option"][value="${n||"set"}"]`);s&&(s.checked=!0);const r=await U("#itemTypeModal");if(!r||r.cancelled)return null;const a=o.querySelector('input[name="item_type_option"]:checked');return a?a.value:null}function It(e,t){if(!ie[t])return;const n=e.parentElement;n&&(ee(R()),J(),e.classList.add("item-removing"),e.addEventListener("animationend",()=>{var r;const s=Fe(t,n);s&&(e.replaceWith(s),s.classList.add("item-created"),s.scrollIntoView({behavior:"smooth",block:"center"}),(r=s.querySelector('input:not([type="hidden"]), select, textarea'))==null||r.focus(),te(),Y(),B(),q("เปลี่ยนประเภทรายการแล้ว","success"))},{once:!0}))}function ne(){ee(R()),J();const e=document.querySelector(h.roomsContainer);if(!e)return;const t=document.querySelector("#roomTpl");if(!t)return;const o=Array.from(document.querySelectorAll(h.roomNameInput)).map(u=>parseInt(u.value.replace(/[^0-9]/g,""),10)).filter(u=>!isNaN(u)),r=`ห้อง ${(o.length>0?Math.max(...o):0)+1}`,l=t.content.cloneNode(!0).firstElementChild;if(l){l.id=`room-${Date.now()}`;const u=l.querySelector('input[name="room_name"]'),c=l.querySelector(".room-header-controls .form-group > label");if(u&&c){const f=`room_name_${l.id}`;u.id=f,c.setAttribute("for",f)}u&&(u.value=r);const i=l.querySelector("[data-room-name-display]");i&&(i.textContent=r),l.open=!0,e.appendChild(l),l.classList.add("item-created"),l.scrollIntoView({behavior:"smooth",block:"center"})}de(),G(),ue(),B()}function Pe(e){var o;const t=(o=e==null?void 0:e.closest(".walls-section"))==null?void 0:o.querySelector(h.wallsContainer);if(t){const n=document.querySelector(h.wallTpl);if(!n)return null;const s=n.content.cloneNode(!0),r=s.querySelector(".wall-input-row");if(!r)return null;const a=r.querySelector("input"),l=r.querySelector("label");if(a&&l){const u=`wall-input-${Date.now()}-${Math.random().toString(36).substring(2,7)}`;a.id=u,l.setAttribute("for",u)}return t.appendChild(s),requestAnimationFrame(()=>{r.classList.add("item-created")}),oe(e),r}return null}function oe(e){var a,l,u,c,i,f,m,y,v,d,p,_;if(!e)return;const t=e.closest(".item-card");if(!t){Y();return}const o=t.dataset.type;let n,s,r;switch(o){case"set":n=t.querySelector("[data-set-summary]"),s={width_m:(a=t.querySelector('input[name="width_m"]'))==null?void 0:a.value,height_m:(l=t.querySelector('input[name="height_m"]'))==null?void 0:l.value,style:(u=t.querySelector('select[name="set_style"]'))==null?void 0:u.value,fabric_variant:(c=t.querySelector('select[name="fabric_variant"]'))==null?void 0:c.value,price_per_m_raw:(i=t.querySelector('select[name="set_price_per_m"]'))==null?void 0:i.value,sheer_price_per_m:(f=t.querySelector('select[name="sheer_price_per_m"]'))==null?void 0:f.value},r=E.calculateSetPrice(s),t.dataset.totalPrice=r.total;let w=`ราคา: <b>${L(r.total)}</b> บ.`;r.opaque>0&&r.sheer>0&&(w+=` <small>(ทึบ: ${L(r.opaque)}, โปร่ง: ${L(r.sheer)})</small>`),n&&(n.innerHTML=w);break;case"wallpaper":n=t.querySelector("[data-wallpaper-summary]"),s={height_m:(m=t.querySelector('input[name="wallpaper_height_m"]'))==null?void 0:m.value,price_per_roll:(y=t.querySelector('input[name="wallpaper_price_roll"]'))==null?void 0:y.value,install_cost_per_roll:(v=t.querySelector('input[name="wallpaper_install_cost"]'))==null?void 0:v.value,widths:Array.from(t.querySelectorAll('input[name="wall_width_m"]')).map(b=>b.value)},r=E.calculateWallpaperPrice(s),t.dataset.totalPrice=r.total;let k=`รวม: <b>${L(r.total)}</b> บ. `;(r.material>0||r.install>0)&&(k+=`<small>(วอลล์: ${L(r.material)}, ค่าช่าง: ${L(r.install)})</small>`),r.rolls>0&&(k+=` &bull; พื้นที่: ${j(r.sqm,2)} ตร.ม. &bull; ใช้: ${r.rolls} ม้วน`),n&&(n.innerHTML=k);break;default:n=t.querySelector("[data-area-summary]"),s={width_m:(d=t.querySelector('input[name="area_width_m"]'))==null?void 0:d.value,height_m:(p=t.querySelector('input[name="area_height_m"]'))==null?void 0:p.value,price_sqyd:(_=t.querySelector('input[name="area_price_sqyd"]'))==null?void 0:_.value},r=E.calculateDecoPrice(s),t.dataset.totalPrice=r.total;let $="";r.sqyd>0&&($=` &bull; พื้นที่: ${j(r.sqyd,2)} ตร.หลา`),n&&(n.innerHTML=`ราคา: <b>${L(r.total)}</b> บ.${$}`);break}Y()}function Y(){let e=0;document.querySelectorAll(h.room).forEach(a=>{let l=0,u=0;const c=a.classList.contains("is-suspended");a.querySelectorAll(".item-card").forEach(f=>{const m=g(f.dataset.totalPrice),y=f.classList.contains("is-suspended");!c&&!y&&(l+=m,m>0&&u++)});const i=a.querySelector("[data-room-brief]");i&&(c?i.textContent="(ระงับชั่วคราว)":u>0?i.innerHTML=`<span>${u}</span> &bull; ${L(l)} บาท`:i.innerHTML="<span>0</span> รายการ"),c||(e+=l)});const t=document.querySelector("#discount_type").value,o=g(document.querySelector("#discount_value").value);let n=0;o>0&&(n=t==="percent"?e*(o/100):o);const s=e-n;document.querySelector("#grandTotal").textContent=L(s);const r=document.querySelector("#originalTotal");n>0?(r.textContent=L(e),r.dataset.rawTotal=e,r.style.display="block"):(r.style.display="none",r.dataset.rawTotal="")}async function Ie(e,t=!1){if(e!=null&&e.favorites)if(t){const r=document.querySelector("#favoritesConflictModal");if(r){const a=await U("#favoritesConflictModal");if(!a||a.cancelled){q("ยกเลิกการนำเข้า","warning");return}switch(r.querySelector('input[name="fav_conflict_option"]:checked').value){case"overwrite":je(e.favorites)&&q("เขียนทับรายการโปรดสำเร็จ","success");break;case"merge":const u=Ve(e.favorites);q(`รวมข้อมูลสำเร็จ (เพิ่ม ${u} รายการใหม่)`,"success");break}}}else je(e.favorites);if(!(e!=null&&e.rooms)||!Array.isArray(e.rooms)){e.favorites||q("ไม่พบข้อมูลสำหรับนำเข้าในไฟล์","error");return}const o=document.querySelector(h.roomsContainer);if(!o)return;o.innerHTML="",document.querySelector("#customer_name").value=e.customer_name||"",document.querySelector("#customer_phone").value=e.customer_phone||"",document.querySelector("#customer_address").value=e.customer_address||"",e.discount&&(document.querySelector("#discount_type").value=e.discount.type||"amount",document.querySelector("#discount_value").value=e.discount.value||0),document.querySelector("#customerDetailsCard").open=e.customer_card_open??!0;let n=0;const s=()=>{if(n>=e.rooms.length){document.querySelectorAll("input[data-favorite-type]").forEach(qe),Y(),te(),de(),G(),ue(),t&&q("นำเข้าข้อมูลฟอร์มสำเร็จ","success");return}const r=e.rooms[n],a=document.querySelector("#roomTpl");if(!a){console.error("Room template not found.");return}const u=a.content.cloneNode(!0).firstElementChild;if(o.appendChild(u),u){u.id=r.id||`room-${Date.now()}`,r.is_suspended&&u.classList.add("is-suspended"),u.open=r.is_open===!0;const c=r.room_name||"ห้อง (ไม่มีชื่อ)",i=u.querySelector('input[name="room_name"]'),f=u.querySelector(".room-header-controls .form-group > label");if(i&&f){const v=`room_name_${u.id}`;i.id=v,f.setAttribute("for",v)}i&&(i.value=c);const m=u.querySelector("[data-room-name-display]");m&&(m.textContent=c);const y=u.querySelector(h.allItemsContainer);if(y&&r.items){const v=document.createDocumentFragment();r.items.forEach(d=>{var _,w,k;d.type==="deco"&&d.deco_type?(d.type=bt[d.deco_type]||"wooden_blind",d.code=d.deco_code,d.width_m=d.deco_width_m,d.height_m=d.deco_height_m,d.price_sqyd=d.deco_price_sqyd,d.notes=d.deco_notes):d.type==="deco"&&(d.type="wooden_blind",d.code=d.deco_code);const p=Fe(d.type,v);if(p){switch(d.is_suspended&&p.classList.add("is-suspended"),d.type){case"set":p.querySelector('input[name="width_m"]').value=X(d.width_m),p.querySelector('input[name="height_m"]').value=X(d.height_m),p.querySelector('select[name="set_style"]').value=d.style||d.set_style||"ลอน",p.querySelector('select[name="fabric_variant"]').value=d.fabric_variant||"ทึบ",p.querySelector('select[name="set_price_per_m"]').value=d.price_per_m_raw||d.set_price_per_m||"",p.querySelector('select[name="sheer_price_per_m"]').value=d.sheer_price_per_m||"",p.querySelector('select[name="opening_style"]').value=d.opening_style||"แยกกลาง",p.querySelector('input[name="track_color"]').value=d.track_color||"ขาว",p.querySelector('input[name="bracket_color"]').value=d.bracket_color||"ขาว",p.querySelector('input[name="finial_color"]').value=d.finial_color||"ขาว",p.querySelector('input[name="grommet_color"]').value=d.grommet_color||"เงิน",p.querySelector('input[name="fabric_code"]').value=d.fabric_code||"",p.querySelector('input[name="sheer_fabric_code"]').value=d.sheer_fabric_code||"",p.querySelector('input[name="notes"]').value=d.notes||"";const $=(d.fabric_variant||"").includes("โปร่ง");(_=p.querySelector(h.sheerWrap))==null||_.classList.toggle("hidden",!$),(w=p.querySelector(h.sheerCodeWrap))==null||w.classList.toggle("hidden",!$);break;case"wallpaper":p.querySelector('input[name="wallpaper_height_m"]').value=X(d.height_m||d.wallpaper_height_m),p.querySelector('input[name="wallpaper_code"]').value=d.wallpaper_code||"";const b=g(d.price_per_roll||d.wallpaper_price_roll);p.querySelector('input[name="wallpaper_price_roll"]').value=b>0?L(b):"",p.querySelector('input[name="wallpaper_install_cost"]').value=d.hasOwnProperty("install_cost_per_roll")?L(d.install_cost_per_roll):d.wallpaper_install_cost?L(d.wallpaper_install_cost):"300",p.querySelector('input[name="wallpaper_notes"]').value=d.notes||d.wallpaper_notes||"",d.widths&&d.widths.forEach(x=>{const C=Pe(p.querySelector('[data-act="add-wall"]'));C&&(C.querySelector('input[name="wall_width_m"]').value=X(x))});break;default:if(((k=ie[d.type])==null?void 0:k.templateId)==="#areaBasedTpl"){p.querySelector('input[name="area_width_m"]').value=X(d.width_m),p.querySelector('input[name="area_height_m"]').value=X(d.height_m);const x=g(d.price_sqyd);p.querySelector('input[name="area_price_sqyd"]').value=x>0?L(x):"",p.querySelector('input[name="area_code"]').value=d.code||"",p.querySelector('input[name="area_notes"]').value=d.notes||""}break}oe(p)}}),y.appendChild(v)}}n++,requestAnimationFrame(s)};requestAnimationFrame(s)}function Bt(e){if(document.getElementById("loading-overlay"))return;const t=document.createElement("div");t.id="loading-overlay",t.innerHTML=`<div class="loading-spinner"></div><p>${e}</p>`,document.body.appendChild(t),document.body.style.overflow="hidden"}function Nt(){const e=document.getElementById("loading-overlay");e&&e.remove(),document.body.style.overflow=""}async function Ye(e,t){var n,s;const o=document.querySelector(h.printableContent);if(!o||!e||!e.html){q("ไม่พบข้อมูลสำหรับสร้างเอกสาร","error");return}if(t==="direct"){Bt("กำลังสร้าง PDF...");try{typeof html2pdf>"u"&&(q("กำลังโหลดไลบรารี PDF...","default"),await gt("https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"));const r=document.createElement("div");r.style.position="fixed",r.style.left="-300mm",r.style.top="0",r.style.width="210mm",r.style.background="#fff",r.innerHTML=e.html,document.body.appendChild(r),await new Promise(l=>setTimeout(l,500));const a={margin:0,filename:`${e.fileName}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0,logging:!1,width:((n=r.querySelector(".pdf-page"))==null?void 0:n.scrollWidth)||210*3.77,windowWidth:((s=r.querySelector(".pdf-page"))==null?void 0:s.scrollWidth)||210*3.77},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}};await window.html2pdf().from(r).set(a).save(),q("ดาวน์โหลด PDF สำเร็จ","success"),document.body.contains(r)&&document.body.removeChild(r)}catch(r){console.error("PDF Generation Error:",r),q("สร้าง PDF ล้มเหลว, โปรดลองวิธีที่ 2 (พิมพ์)","error")}finally{Nt()}}t==="print"&&(o.innerHTML=e.html,setTimeout(()=>{window.print(),setTimeout(()=>{o.innerHTML=""},1e3)},tt))}function At(e){if(!e||!e.html){q("ไม่พบข้อมูลสำหรับสร้างไฟล์ HTML","error");return}try{const t=`
            <!DOCTYPE html><html lang="th"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>${e.fileName}</title>
                <link rel="stylesheet" href="https://grobmak.github.io/marnthara-form/src/style.css">
                <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/bold/style.css">
                <style>#printable-content { display: block !important; } .pdf-page { border: 1px solid #eee; box-shadow: 0 0 10px rgba(0,0,0,0.1); margin: 10mm auto; } i.ph { vertical-align: middle; }</style>
            </head>
            <body>${e.html}</body></html>`,o=new Blob([t],{type:"text/html;charset=utf-8"}),n=URL.createObjectURL(o),s=document.createElement("a");s.href=n,s.download=`${e.fileName}.html`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(n),q("ดาวน์โหลดไฟล์ HTML สำเร็จ","success")}catch(t){console.error("HTML Export Error:",t),q("สร้างไฟล์ HTML ล้มเหลว","error")}}function Ft(e){if(!e)return;const t=e.closest(".item-card");if(!t)return;const o=g(e.value);let n,s;const r=e.getAttribute("name");if(r==="set_price_per_m"?(n=t.querySelector('input[name="fabric_code"]'),s="fabric"):r==="sheer_price_per_m"?(n=t.querySelector('input[name="sheer_fabric_code"]'),s="sheer"):r==="wallpaper_price_roll"?(n=t.querySelector('input[name="wallpaper_code"]'),s="wallpaper"):r==="area_price_sqyd"&&(n=t.querySelector('input[name="area_code"]'),n&&(s=n.dataset.favoriteType)),n&&s&&n.value.trim()){const a=Ne(s,n.value);a&&a.price!==o&&(n.value="",qe(n))}}const Pt=ot(e=>{e.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_price_per_m"]')&&Ft(e),oe(e),B()},200);function ze(e){var o,n,s;if(z){e.preventDefault();return}const t=e.target;if(t.matches('select[name="fabric_variant"]')){const r=t.closest(".set-item");if(r){const a=(o=t.value)==null?void 0:o.includes("โปร่ง");(n=r.querySelector(h.sheerWrap))==null||n.classList.toggle("hidden",!a),(s=r.querySelector(h.sheerCodeWrap))==null||s.classList.toggle("hidden",!a)}}if(t.matches(h.roomNameInput)){const r=t.closest(".room-card");if(r){const a=r.querySelector("[data-room-name-display]");a&&(a.textContent=t.value||"ห้อง")}de(),ue()}t.matches("input[data-favorite-type]")&&qe(t),Pt(t)}function Ot(e){const t=e.target;t.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_install_cost"]')?t.value=g(t.value)>0?L(g(t.value)):"":t.matches('input[name$="_m"], input[name$="width_m"]')&&(t.value=X(t.value))}function Rt(e){const t=e.target;t.matches('[name$="_price_sqyd"], [name$="_price_roll"], [name$="_install_cost"]')&&g(t.value)>0&&(t.value=g(t.value)),t.matches("input[data-favorite-type]")&&(ge=t,Je(t))}const Ht=async e=>{var i,f,m,y;const t=e.target.closest(".summary-tag[data-filter-type]");if(t){const v=t.dataset.filterType,d=t.textContent.trim().replace(/\s*\d+\s*$/,""),p=document.querySelector("#overviewModal");p&&p.classList.remove("visible"),qt(v,d);return}const o=e.target.closest(".favorite-chips-container .btn-chip");if(o){kt(o);return}const n=e.target.closest(".fav-manager-item");if(n){const v=n.parentElement.querySelector(".is-selected");v&&v.classList.remove("is-selected"),v!==n?(n.classList.add("is-selected"),Me(n)):Me(null);return}const s=e.target.closest("[data-act]");if(!s)return;const r=["toggle-more-details","show-discount-modal","collapse-room"];if(z&&!s.closest(".unlockable")&&!r.includes(s.dataset.act))return;const a=s.dataset.act,l=s.closest(h.room),u=s.closest(".item-card"),c=(v,d,p)=>ce(v,d).then(_=>_&&p());switch(a){case"add-room":ne();break;case"add-item":{if(xe=s.closest(h.room),xe){const p=await Ue("เพิ่มรายการใหม่");p&&Mt(p,xe)}break}case"collapse-room":l&&(e.preventDefault(),l.open=!1,(i=l.querySelector("summary"))==null||i.scrollIntoView({behavior:"smooth",block:"center"}));break;case"clear-filter":$t();break;case"change-type":{const p=u==null?void 0:u.dataset.type;if(u&&p){const _=await Ue("เปลี่ยนประเภทรายการ",p);_&&_!==p&&c("ยืนยันการเปลี่ยนแปลง","ข้อมูลทั้งหมดในรายการนี้จะถูกลบและสร้างใหม่ คุณแน่ใจหรือไม่?",()=>It(u,_))}break}case"add-wall":{const p=Pe(s);p&&((f=p.querySelector('input[name="wall_width_m"]'))==null||f.focus());break}case"show-discount-modal":Tt();break;case"open-hardware-modal":{P=u,Et();break}case"apply-hardware-to-room":{const p=s.closest("#hardwareModal"),_=P==null?void 0:P.closest(h.room);if(!p||!_)break;const w=p.querySelector('[name="modal_track_color"]').value,k=p.querySelector('[name="modal_bracket_color"]').value,$=p.querySelector('[name="modal_finial_color"]').value,b=p.querySelector('[name="modal_grommet_color"]').value;_.querySelectorAll(".set-item").forEach(x=>{x.querySelector('[name="track_color"]').value=w,x.querySelector('[name="bracket_color"]').value=k,x.querySelector('[name="finial_color"]').value=$,x.querySelector('[name="grommet_color"]').value=b}),B(),q("ใช้การตั้งค่ากับทุกรายการในห้องแล้ว","success");break}case"toggle-more-details":{const p=u==null?void 0:u.querySelector(".item-details-more");if(p){const _=p.classList.toggle("show");s.classList.toggle("expanded",_),s.querySelector("i").className=_?"ph ph-caret-up":"ph ph-caret-down",s.querySelector("span").textContent=_?"ย่อน้อยลง":"เพิ่มเติม"}break}case"toggle-favorite":{const p=s.closest(".form-group-with-favorites").querySelector("input[data-favorite-type]");if(!p||!u)break;const _=p.dataset.favoriteType,w=p.value;let k;_==="fabric"?k="set_price_per_m":_==="sheer"?k="sheer_price_per_m":_==="wallpaper"?k="wallpaper_price_roll":k="area_price_sqyd";const $=u.querySelector(`[name="${k}"]`),b=g($==null?void 0:$.value);if(!w.trim()){q("โปรดระบุรหัสก่อนบันทึก","warning");break}if(b<=0&&_!=="fabric"&&_!=="sheer"){q("โปรดระบุราคาก่อนบันทึก","warning");break}const x=ke(_,w,b);s.classList.toggle("is-favorite",x),q(x?"เพิ่มในรายการโปรดแล้ว":"ลบออกจากรายการโปรด","success"),B();break}case"manage-favorites":{const p=s.dataset.type;ge=s.closest(".form-group-with-favorites").querySelector("input[data-favorite-type]"),xt(p);break}case"add-new-fav-form":{const _=s.closest("#favManagerModal").dataset.currentType;if(!_)break;const w=document.querySelector("#favAddModal");w.querySelector("h3").textContent=`เพิ่ม '${((m=ie[_])==null?void 0:m.name)||_}'`;const k=w.querySelector('[name="fav_code_add"]'),$=w.querySelector('[name="fav_price_add"]');k.value="",$.value="";const b=await U("#favAddModal");if(b&&!b.cancelled){const x=k.value.trim(),C=g($.value);x&&(ke(_,x,C),le=!0,ye(_),q("เพิ่มรายการโปรดแล้ว","success"))}break}case"edit-selected-fav":{if(!D)break;const _=s.closest("#favManagerModal").dataset.currentType;if(!_)break;const w=document.querySelector("#favEditModal");w.querySelector("h3").textContent=`แก้ไข '${D.code}'`;const k=w.querySelector('[name="fav_code_edit"]'),$=w.querySelector('[name="fav_price_edit"]');k.value=D.code,$.value=D.price>0?D.price:"";const b=await U("#favEditModal");if(b&&!b.cancelled){const x=k.value.trim(),C=g($.value);x&&(x!==D.code&&Ee(_,D.code),ke(_,x,C),le=!0,ye(_),q("แก้ไขรายการโปรดแล้ว","success"))}break}case"del-selected-fav":{if(!D)break;const _=s.closest("#favManagerModal").dataset.currentType;if(!_)break;await ce("ลบรายการโปรด",`ยืนยันการลบรหัส "${D.code}"?`)&&(Ee(_,D.code),le=!0,ye(_),q("ลบรายการโปรดแล้ว","success"));break}case"del-room":c("ลบห้อง","ยืนยันการลบห้องนี้?",()=>Te(l,"ลบห้องแล้ว"));break;case"del-item":c("ลบรายการ","ยืนยันการลบรายการนี้?",()=>Te(u,"ลบรายการแล้ว"));break;case"del-wall":c("ลบผนัง","ยืนยันการลบผนังนี้?",()=>Te(s.closest(".wall-input-row"),"ลบผนังแล้ว",()=>oe(u)));break;case"clear-room":c("ล้างข้อมูลในห้อง","ยืนยันลบทุกรายการในห้องนี้?",()=>{ee(R()),J(),l.querySelector(h.allItemsContainer).innerHTML="",te(),Y(),B(),q("ล้างข้อมูลในห้องแล้ว","success")});break;case"toggle-room-menu":e.preventDefault();const v=s.nextElementSibling;if(!v||!l)return;const d=!v.classList.contains("show");document.querySelectorAll(".room-options-menu.show").forEach(p=>p.classList.remove("show")),document.querySelectorAll(".card.overflow-visible").forEach(p=>p.classList.remove("overflow-visible")),d&&(v.classList.add("show"),l.classList.add("overflow-visible"));break;case"toggle-suspend-room":e.preventDefault(),l==null||l.classList.toggle("is-suspended"),Y(),B(),(y=s.closest(".room-options-menu"))==null||y.classList.remove("show"),l==null||l.classList.remove("overflow-visible");break;case"toggle-suspend":e.preventDefault(),u==null||u.classList.toggle("is-suspended"),oe(s),B();break}};function jt(){z=!z,Ke()}function Dt(e){if(!e||e.closest(".modal-wrapper"))return;const t=e.getAttribute("name"),o=e.closest(".item-card"),r=(a=>{const l=a[t];if(!l)return null;const u=o||document;let c=null;return typeof l=="string"?c=u.querySelector(`[name="${l}"]:not(:disabled)`):typeof l=="function"&&(c=l(e)),!c&&o&&typeof l=="string"&&(c=document.querySelector(`[name="${l}"]:not(:disabled)`)),c})({customer_name:"customer_phone",customer_phone:"customer_address",customer_address:()=>document.querySelector(".room-name-input"),room_name:a=>{var l;return(l=a.closest(".room-card"))==null?void 0:l.querySelector('[data-act="add-item"]')},width_m:"height_m",height_m:"set_price_per_m",set_price_per_m:a=>{var c;const l=a.closest(".set-item"),u=(c=l==null?void 0:l.querySelector('[name="fabric_variant"]'))==null?void 0:c.value;return u!=null&&u.includes("โปร่ง")?l==null?void 0:l.querySelector('[name="sheer_price_per_m"]'):l==null?void 0:l.querySelector('[data-act="toggle-more-details"]')},sheer_price_per_m:a=>{var l;return(l=a.closest(".item-card"))==null?void 0:l.querySelector('[data-act="toggle-more-details"]')},area_width_m:"area_height_m",area_height_m:"area_price_sqyd",area_price_sqyd:"area_code",wall_width_m:a=>{var u,c;const l=(u=a.closest(".wall-input-row"))==null?void 0:u.nextElementSibling;return l!=null&&l.matches(".wall-input-row")?l.querySelector("input"):(c=a.closest(".item-card"))==null?void 0:c.querySelector('[name="wallpaper_price_roll"]')},wallpaper_price_roll:"wallpaper_height_m",wallpaper_height_m:"wallpaper_code"});r&&(r.focus(),typeof r.select=="function"&&r.select())}function Wt(){const e=document.querySelector(h.setTpl);if(!e)return;const t=e.content.querySelector('select[name="set_price_per_m"]'),o=e.content.querySelector('select[name="sheer_price_per_m"]'),n=s=>{let r='<option value="" hidden>เลือกราคา</option>';return Array.isArray(s)?(s.forEach(a=>{r+=`<option value="${a}">${a.toLocaleString("th-TH")}</option>`}),r):(console.error("Price data for dropdown is not available or not an array.",s),r)};t&&(t.innerHTML=n(_e.fabric)),o&&(o.innerHTML=n(_e.sheer))}function Ut(){Wt(),Ge();const e=document.querySelector(h.orderForm),t=document.querySelector(h.fileImporter),o=document.querySelector("#favImporter"),n=document.querySelector(h.menuDropdown),s=document.querySelector(h.quickNavDropdown),r=document.querySelector("#pageBreakBuffer"),a=document.querySelector("#pageBreakBufferValue");r&&a&&r.addEventListener("input",()=>{a.textContent=r.value}),e.addEventListener("input",ze),e.addEventListener("change",ze),document.addEventListener("click",Ht),e.addEventListener("blur",Ot,!0),e.addEventListener("focusin",Rt,!0),e.addEventListener("keydown",c=>{const i=c.target;c.key==="Enter"&&!i.matches("textarea, button, [data-act]")&&(c.preventDefault(),Dt(i))});const l=c=>{const i=c.target.closest(h.room);i&&Qe(i)};e.addEventListener("click",l),e.addEventListener("focusin",l),document.body.addEventListener("click",c=>{c.target.closest("summary")&&setTimeout(()=>{G(),B()},50)}),document.querySelector("#undoBtn").addEventListener("click",c=>{c.preventDefault(),wt()}),document.querySelector(h.lockBtn).addEventListener("click",jt),document.querySelector(h.toggleAllRoomsBtn).addEventListener("click",Ct),document.querySelector(h.quickNavBtn).addEventListener("click",c=>{var f;c.stopPropagation(),n.classList.remove("show");const i=!s.classList.contains("show");s.classList.toggle("show"),c.currentTarget.setAttribute("aria-expanded",i),i&&((f=document.querySelector(h.menuBtn))==null||f.setAttribute("aria-expanded","false"))}),document.querySelector(h.quickNavRoomList).addEventListener("click",c=>{var f;const i=c.target.closest("a[data-jump-to]");if(i){c.preventDefault();const m=i.dataset.jumpTo,y=document.getElementById(m);y&&(document.body.classList.add("disable-animations"),y.open=!0,y.scrollIntoView({behavior:"auto",block:"start"}),y.classList.add("scrolling-jump"),setTimeout(()=>{y.classList.remove("scrolling-jump"),document.body.classList.remove("disable-animations"),G()},1e3)),s.classList.remove("show"),(f=document.querySelector(h.quickNavBtn))==null||f.setAttribute("aria-expanded","false")}});const u=document.querySelector("#addRoomQuickNavBtn");if(u){const c=at(ne,700);u.addEventListener("click",i=>{var f;i.stopPropagation(),c(),s.classList.remove("show"),(f=document.querySelector(h.quickNavBtn))==null||f.setAttribute("aria-expanded","false")})}document.querySelector(h.menuBtn).addEventListener("click",c=>{var f;c.stopPropagation(),s.classList.remove("show");const i=!n.classList.contains("show");n.classList.toggle("show"),c.currentTarget.setAttribute("aria-expanded",i),i&&((f=document.querySelector(h.quickNavBtn))==null||f.setAttribute("aria-expanded","false"))}),document.querySelector("#themeToggleBtn").addEventListener("click",c=>{c.preventDefault(),St()}),document.querySelector("#overviewBtn").addEventListener("click",async c=>{var y;c.preventDefault(),n.classList.remove("show"),(y=document.querySelector(h.menuBtn))==null||y.setAttribute("aria-expanded","false");const i=R(),f=document.querySelector("#overviewModalHeader"),m=document.querySelector("#overviewModalBody");if(f&&m){const v=i.rooms.reduce((_,w)=>{if(w.is_suspended)return _;const k=(w.items||[]).filter($=>{if($.is_suspended)return!1;let b=0;switch($.type){case"set":b=E.calculateSetPrice($).total;break;case"wallpaper":b=E.calculateWallpaperPrice($).total;break;default:b=E.calculateDecoPrice($).total;break}return b>0}).length;return _+k},0),d=document.querySelector(h.grandTotal).textContent||"0",p=i.rooms.filter(_=>!_.is_suspended&&_.items&&_.items.some(w=>!w.is_suspended)).length;f.innerHTML=`
                <div class="overview-stats-grid">
                    <div class="overview-stat-card">
                        <i class="ph-bold ph-map-pin-line"></i>
                        <div class="stat-value">${p}</div>
                        <div class="stat-label">ห้อง</div>
                    </div>
                    <div class="overview-stat-card">
                        <i class="ph-bold ph-stack"></i>
                        <div class="stat-value">${v}</div>
                        <div class="stat-label">รายการ</div>
                    </div>
                    <div class="overview-stat-card">
                        <i class="ph-bold ph-coins"></i>
                        <div class="stat-value">${d}</div>
                        <div class="stat-label">ยอดรวม</div>
                    </div>
                </div>
            `,m.innerHTML=dt(i),U("#overviewModal")}}),document.querySelector(h.exportPdfBtn).addEventListener("click",async c=>{var y;c.preventDefault(),n.classList.remove("show"),(y=document.querySelector(h.menuBtn))==null||y.setAttribute("aria-expanded","false");const i=await Lt();if(!i)return;const f=R(),m=ut(f,{vatRate:i.vatOption==="include"?M.baseVatRate:0,pageBreakBuffer:i.pageBreakBuffer});if(!m){q("ไม่มีรายการที่มีราคาสำหรับสร้างเอกสาร","warning");return}i.exportMethod==="html"?At(m):Ye(m,i.exportMethod)}),document.querySelector("#visualReportsBtn").addEventListener("click",async c=>{var m;c.preventDefault(),n.classList.remove("show"),(m=document.querySelector(h.menuBtn))==null||m.setAttribute("aria-expanded","false");const i=document.querySelector("#visualReportsModal"),f=await U("#visualReportsModal");if(f&&!f.cancelled){const y=i.querySelector('input[name="report_type_option"]:checked').value;if(!y)return;const v=R();let d;switch(y){case"lookbook":d=pt(v);break;case"jobcards":d=mt(v);break;case"purchase_order":d=ft(v);break;case"kanban":d=ht(v);break;default:q("ยังไม่รองรับรายงานประเภทนี้","warning");return}d&&d.html?Ye(d,"direct"):q("ไม่มีข้อมูลสำหรับสร้างรายงาน","warning")}}),document.querySelector(h.importBtn).addEventListener("click",c=>{var i;c.preventDefault(),n.classList.remove("show"),(i=document.querySelector(h.menuBtn))==null||i.setAttribute("aria-expanded","false"),t.click()}),t.addEventListener("change",c=>{var m;const i=(m=c.target.files)==null?void 0:m[0];if(!i)return;const f=new FileReader;f.onload=async y=>{try{const v=JSON.parse(y.target.result);await Ie(v,!0)}catch(v){q("ไฟล์ JSON ไม่ถูกต้อง","error"),console.error("JSON Parse Error:",v)}},f.readAsText(i),c.target.value=null}),document.querySelector(h.exportBtn).addEventListener("click",c=>{var i;c.preventDefault(),n.classList.remove("show"),(i=document.querySelector(h.menuBtn))==null||i.setAttribute("aria-expanded","false");try{const f=R(),m=JSON.stringify(f,null,4),y=new Blob([m],{type:"application/json"}),v=URL.createObjectURL(y),d=document.createElement("a"),p=new Date,_=`${p.getFullYear()}${(p.getMonth()+1).toString().padStart(2,"0")}${p.getDate().toString().padStart(2,"0")}`,w=`${p.getHours().toString().padStart(2,"0")}${p.getMinutes().toString().padStart(2,"0")}`,k=ae(f.customer_name||"data");d.href=v,d.download=`MTR-${_}${w}-${k}.json`,d.click(),URL.revokeObjectURL(v),q("Export ข้อมูลสำเร็จ","success")}catch{q("Export ข้อมูลล้มเหลว","error")}}),document.querySelector("#importFavsBtn").addEventListener("click",c=>{var i;c.preventDefault(),n.classList.remove("show"),(i=document.querySelector(h.menuBtn))==null||i.setAttribute("aria-expanded","false"),o.click()}),o.addEventListener("change",c=>{var m;const i=(m=c.target.files)==null?void 0:m[0];if(!i)return;const f=new FileReader;f.onload=y=>{try{const v=JSON.parse(y.target.result),d=Ve(v);d>0?q(`เพิ่มรายการโปรดใหม่ ${d} รายการ`,"success"):q("ไม่พบรายการโปรดใหม่ที่จะเพิ่ม","default"),B()}catch(v){q("ไฟล์ JSON ไม่ถูกต้อง","error"),console.error("Favorites JSON Parse Error:",v)}},f.readAsText(i),c.target.value=null}),document.querySelector("#exportFavsBtn").addEventListener("click",c=>{var i;c.preventDefault(),n.classList.remove("show"),(i=document.querySelector(h.menuBtn))==null||i.setAttribute("aria-expanded","false");try{const f=K(),m=JSON.stringify(f,null,4),y=new Blob([m],{type:"application/json"}),v=URL.createObjectURL(y),d=document.createElement("a"),p=new Date,_=`${p.getFullYear()}${(p.getMonth()+1).toString().padStart(2,"0")}${p.getDate().toString().padStart(2,"0")}`;d.href=v,d.download=`MTR-Favorites-${_}.json`,d.click(),URL.revokeObjectURL(v),q("Export รายการโปรดสำเร็จ","success")}catch{q("Export รายการโปรดล้มเหลว","error")}}),document.querySelector(h.submitBtn).addEventListener("click",async c=>{var i;if(c.preventDefault(),n.classList.remove("show"),(i=document.querySelector(h.menuBtn))==null||i.setAttribute("aria-expanded","false"),await ce("ส่งข้อมูล","ยืนยันการส่งข้อมูลการประเมินราคา?")){const f=R();if(!f.customer_name&&!f.customer_phone){q("กรุณาระบุชื่อหรือเบอร์โทรลูกค้า","warning");return}q("กำลังส่งข้อมูล...","default");try{const m=await fetch(et,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(f)});m.ok?q("ส่งข้อมูลสำเร็จ!","success"):q(`ส่งข้อมูลล้มเหลว: ${m.status}`,"error")}catch{q("เกิดข้อผิดพลาดในการเชื่อมต่อ","error")}}}),document.querySelector(h.copyTextBtn).addEventListener("click",async c=>{var m;c.preventDefault(),n.classList.remove("show"),(m=document.querySelector(h.menuBtn))==null||m.setAttribute("aria-expanded","false");const i=document.querySelector(h.copyOptionsModal);i.querySelector('input[name="copy_option"][value="customer"]').checked=!0;const f=await U(h.copyOptionsModal);if(f&&!f.cancelled){const y=i.querySelector('input[name="copy_option"]:checked').value,v=it(R(),y);try{await navigator.clipboard.writeText(v),q("คัดลอกสรุปสำเร็จ!","success")}catch{q("คัดลอกล้มเหลว","error")}}}),document.querySelector(h.clearItemsBtn).addEventListener("click",async c=>{var i;c.preventDefault(),n.classList.remove("show"),(i=document.querySelector(h.menuBtn))==null||i.setAttribute("aria-expanded","false"),await ce("ล้างทุกรายการ","คุณแน่ใจหรือไม่ว่าต้องการลบรายการสินค้าทั้งหมด (ข้อมูลลูกค้าและห้องจะยังคงอยู่)?")&&(ee(R()),J(),document.querySelectorAll(h.room).forEach(f=>{const m=f.querySelector(h.allItemsContainer);m&&(m.innerHTML="")}),Y(),B(),q("ล้างทุกรายการแล้ว","success"))}),document.querySelector(h.clearAllBtn).addEventListener("click",async c=>{var i;if(c.preventDefault(),n.classList.remove("show"),(i=document.querySelector(h.menuBtn))==null||i.setAttribute("aria-expanded","false"),await ce("ลบข้อมูลทั้งหมด",'คำเตือน! การกระทำนี้จะลบข้อมูลลูกค้า, ทุกรายการ, และ "รายการโปรด" ทั้งหมดอย่างถาวร ยืนยันหรือไม่?')){ee(R()),J(),localStorage.removeItem(he),ct();const f=document.querySelector("#customer_name"),m=document.querySelector("#customer_phone"),y=document.querySelector("#customer_address");f&&(f.value=""),m&&(m.value=""),y&&(y.value="");const v=document.querySelector("#discount_type"),d=document.querySelector("#discount_value");v&&(v.value="amount"),d&&(d.value="0");const p=document.querySelector(h.roomsContainer);p&&(p.innerHTML=""),Y(),de(),G(),ne();const _=document.querySelector("#customerDetailsCard");_&&(_.open=!0),q("ลบข้อมูลทั้งหมดแล้ว เริ่มต้นใหม่","success")}}),window.addEventListener("click",c=>{var i,f;c.target.closest(".modal-wrapper")||(c.target.closest(".menu-container")||(n.classList.contains("show")&&(n.classList.remove("show"),(i=document.querySelector(h.menuBtn))==null||i.setAttribute("aria-expanded","false")),s.classList.contains("show")&&(s.classList.remove("show"),(f=document.querySelector(h.quickNavBtn))==null||f.setAttribute("aria-expanded","false"))),c.target.closest(".room-options-container")||(document.querySelectorAll(".room-options-menu.show").forEach(m=>m.classList.remove("show")),document.querySelectorAll(".card.overflow-visible").forEach(m=>m.classList.remove("overflow-visible"))),c.target.closest(".form-group-with-favorites")||we())}),window.addEventListener("beforeunload",B);try{const c=localStorage.getItem(he);if(c&&c.length>2&&c!=="null")Ie(JSON.parse(c),!1);else{ne();const i=document.querySelector("#customerDetailsCard");i&&(i.open=!0)}}catch(c){console.error("Failed to load data from localStorage:",c),localStorage.removeItem(he),ne()}Y(),Ke(),G(),ue(),J()}document.addEventListener("DOMContentLoaded",Ut);
